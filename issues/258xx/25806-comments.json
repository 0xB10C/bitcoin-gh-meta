[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26643](https://github.com/bitcoin/bitcoin/pull/26643) (wallet: Move fee underpayment check to after all fee has been set by achow101)\n* [#26593](https://github.com/bitcoin/bitcoin/pull/26593) (tracing: Only prepare tracepoint arguments when actually tracing by 0xB10C)\n* [#26238](https://github.com/bitcoin/bitcoin/pull/26238) (clang-tidy: fixup named argument comments by fanquake)\n* [#25982](https://github.com/bitcoin/bitcoin/pull/25982) (wallet: Guard against undefined behaviour by yancyribbens)\n* [#25729](https://github.com/bitcoin/bitcoin/pull/25729) (wallet: Check max transaction weight in CoinSelection by aureleoules)\n* [#25273](https://github.com/bitcoin/bitcoin/pull/25273) (wallet: Pass through transaction locktime and preset input sequences and scripts to CreateTransaction by achow101)\n* [#23829](https://github.com/bitcoin/bitcoin/pull/23829) (refactor: use braced init for integer literals instead of c style casts by PastaPastaPasta)\n* [#23475](https://github.com/bitcoin/bitcoin/pull/23475) (wallet: add config to prioritize a solution that doesn't create change in coin selection by brunoerg)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-08-09T05:46:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#issuecomment-1208941748",
      "id" : 1208941748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25806",
      "node_id" : "IC_kwDOABII585IDvy0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1208941748/reactions"
      },
      "updated_at" : "2022-12-06T09:17:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1208941748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-17T00:43:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#issuecomment-1217313081",
      "id" : 1217313081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25806",
      "node_id" : "IC_kwDOABII585Ijrk5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1217313081/reactions"
      },
      "updated_at" : "2022-08-17T00:43:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1217313081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024610915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024610915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`CoinSelectionParams`'s `rng_fast` member is a reference and you're using a stack object, this will create a dangling reference.",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:33:38Z",
      "diff_hunk" : "@@ -0,0 +1,230 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+\n+#include <wallet/coinselection.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace wallet {\n+BOOST_FIXTURE_TEST_SUITE(group_outputs_tests, TestingSetup)\n+\n+static int nextLockTime = 0;\n+\n+static std::shared_ptr<CWallet> NewWallet(const node::NodeContext& m_node, const ArgsManager& m_args)\n+{\n+    std::unique_ptr<CWallet> wallet = std::make_unique<CWallet>(m_node.chain.get(), \"\", m_args, CreateMockWalletDatabase());\n+    wallet->LoadWallet();\n+    LOCK(wallet->cs_wallet);\n+    wallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+    wallet->SetupDescriptorScriptPubKeyMans();\n+    return wallet;\n+}\n+\n+static void addCoin(CoinsResult& coins,\n+                     OutputType type,\n+                     CWallet& wallet,\n+                     const CScript& dest,\n+                     const CAmount& nValue,\n+                     bool is_from_me,\n+                     CFeeRate fee_rate = CFeeRate(0),\n+                     int depth = 6)\n+{\n+    CMutableTransaction tx;\n+    tx.nLockTime = nextLockTime++;        // so all transactions get different hashes\n+    tx.vout.resize(1);\n+    tx.vout[0].nValue = nValue;\n+    tx.vout[0].scriptPubKey = dest;\n+\n+    const uint256& txid = tx.GetHash();\n+    LOCK(wallet.cs_wallet);\n+    auto ret = wallet.mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(txid), std::forward_as_tuple(MakeTransactionRef(std::move(tx)), TxStateInactive{}));\n+    assert(ret.second);\n+    CWalletTx& wtx = (*ret.first).second;\n+    const auto& txout = wtx.tx->vout.at(0);\n+    coins.Add(type, {COutPoint(wtx.GetHash(), 0),\n+                       txout,\n+                       depth,\n+                       CalculateMaximumSignedInputSize(txout, &wallet, /*coin_control=*/nullptr),\n+                       /*spendable=*/ true,\n+                       /*solvable=*/ true,\n+                       /*safe=*/ true,\n+                       wtx.GetTxTime(),\n+                       is_from_me,\n+                       fee_rate});\n+}\n+\n+ CoinSelectionParams makeSelectionParams(bool avoid_partial_spends)\n+{\n+    FastRandomContext rand{};\n+    return CoinSelectionParams{\n+            rand,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024610915",
      "id" : 1024610915,
      "line" : 65,
      "node_id" : "PRRC_kwDOABII5849ElJj",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/test/group_outputs_tests.cpp",
      "position" : 65,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024610915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024610915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024611478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "prefer enum class",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:34:44Z",
      "diff_hunk" : "@@ -229,11 +235,41 @@ struct OutputGroup\n         m_subtract_fee_outputs(params.m_subtract_fee_outputs)\n     {}\n \n-    void Insert(const COutput& output, size_t ancestors, size_t descendants, bool positive_only);\n+    void Insert(const std::shared_ptr<COutput>& output, size_t ancestors, size_t descendants);\n     bool EligibleForSpending(const CoinEligibilityFilter& eligibility_filter) const;\n     CAmount GetSelectionAmount() const;\n };\n \n+struct Groups {\n+    std::vector<OutputGroup> positive_group;\n+    std::vector<OutputGroup> mixed_group;\n+};\n+\n+/**\n+* Stores several 'Groups' whose\n+* were filtered by different output type\n+*/\n+struct OutputGroups\n+{\n+    // Map filters to output groups.\n+    std::map<OutputType, Groups> groups_by_type;\n+    // All groups, no filters\n+    Groups all_groups;\n+\n+    enum InsertGroupType {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024611478",
      "id" : 1024611478,
      "line" : 259,
      "node_id" : "PRRC_kwDOABII5849ElSW",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 259,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 71,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024611786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could use structured binding",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:35:18Z",
      "diff_hunk" : "@@ -416,28 +416,35 @@ std::map<CTxDestination, std::vector<COutput>> ListCoins(const CWallet& wallet)\n     return result;\n }\n \n-std::vector<OutputGroup> GroupOutputs(const CWallet& wallet, const std::vector<COutput>& outputs, const CoinSelectionParams& coin_sel_params, const CoinEligibilityFilter& filter, bool positive_only)\n+FilteredOutputGroups GroupOutputs(const CWallet& wallet,\n+                          const CoinsResult& coins,\n+                          const CoinSelectionParams& coin_sel_params,\n+                          const std::vector<CoinEligibilityFilter>& filters)\n {\n-    std::vector<OutputGroup> groups_out;\n+    FilteredOutputGroups filtered_groups;\n \n+    // Allowing partial spends means no grouping. Each COutput gets its own OutputGroup\n     if (!coin_sel_params.m_avoid_partial_spends) {\n-        // Allowing partial spends  means no grouping. Each COutput gets its own OutputGroup.\n-        for (const COutput& output : outputs) {\n-            // Skip outputs we cannot spend\n-            if (!output.spendable) continue;\n-\n-            size_t ancestors, descendants;\n-            wallet.chain().getTransactionAncestry(output.outpoint.hash, ancestors, descendants);\n-\n-            // Make an OutputGroup containing just this output\n-            OutputGroup group{coin_sel_params};\n-            group.Insert(output, ancestors, descendants, positive_only);\n-\n-            // Check the OutputGroup's eligibility. Only add the eligible ones.\n-            if (positive_only && group.GetSelectionAmount() <= 0) continue;\n-            if (group.m_outputs.size() > 0 && group.EligibleForSpending(filter)) groups_out.push_back(group);\n+        for (const auto& coins_by_type : coins.coins) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024611786",
      "id" : 1024611786,
      "line" : 428,
      "node_id" : "PRRC_kwDOABII5849ElXK",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 428,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 30,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024611786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const auto& push_output_groups = [&](const ScriptPubKeyToOutgroup& groups_map ,bool positive_only) {\r\n```",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:36:10Z",
      "diff_hunk" : "@@ -474,39 +477,69 @@ std::vector<OutputGroup> GroupOutputs(const CWallet& wallet, const std::vector<C\n             group = &groups.back();\n         }\n \n-        // Add the output to group\n-        group->Insert(output, ancestors, descendants, positive_only);\n+        // Filter for positive only before adding the output to group\n+        if (!positive_only || (positive_only && output.GetEffectiveValue() > 0)) {\n+            group->Insert(std::make_shared<COutput>(output), ancestors, descendants);\n+        }\n+    };\n+\n+    ScriptPubKeyToOutgroup spk_to_groups_map;\n+    ScriptPubKeyToOutgroup spk_to_positive_groups_map;\n+    for (const auto& coins_by_type : coins.coins) {\n+        for (const COutput& output : coins_by_type.second) {\n+            // Skip outputs we cannot spend\n+            if (!output.spendable) continue;\n+\n+            size_t ancestors, descendants;\n+            wallet.chain().getTransactionAncestry(output.outpoint.hash, ancestors, descendants);\n+\n+            group_outputs(output, coins_by_type.first, ancestors, descendants, spk_to_groups_map, coin_sel_params, /*positive_only=*/ false);\n+            group_outputs(output, coins_by_type.first, ancestors, descendants, spk_to_positive_groups_map,\n+                          coin_sel_params, /*positive_only=*/ true);\n+        }\n     }\n \n-    // Now we go through the entire map and pull out the OutputGroups\n-    for (const auto& spk_and_groups_pair: spk_to_groups_map) {\n-        const std::vector<OutputGroup>& groups_per_spk= spk_and_groups_pair.second;\n+    // Now we go through the entire maps and pull out the OutputGroups\n+    const auto& push_output_groups = [&](ScriptPubKeyToOutgroup& groups_map ,bool positive_only) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612246",
      "id" : 1024612246,
      "line" : 503,
      "node_id" : "PRRC_kwDOABII5849EleW",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 503,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 109,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612246/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612600"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could use structured binding",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:36:52Z",
      "diff_hunk" : "@@ -474,39 +477,69 @@ std::vector<OutputGroup> GroupOutputs(const CWallet& wallet, const std::vector<C\n             group = &groups.back();\n         }\n \n-        // Add the output to group\n-        group->Insert(output, ancestors, descendants, positive_only);\n+        // Filter for positive only before adding the output to group\n+        if (!positive_only || (positive_only && output.GetEffectiveValue() > 0)) {\n+            group->Insert(std::make_shared<COutput>(output), ancestors, descendants);\n+        }\n+    };\n+\n+    ScriptPubKeyToOutgroup spk_to_groups_map;\n+    ScriptPubKeyToOutgroup spk_to_positive_groups_map;\n+    for (const auto& coins_by_type : coins.coins) {\n+        for (const COutput& output : coins_by_type.second) {\n+            // Skip outputs we cannot spend\n+            if (!output.spendable) continue;\n+\n+            size_t ancestors, descendants;\n+            wallet.chain().getTransactionAncestry(output.outpoint.hash, ancestors, descendants);\n+\n+            group_outputs(output, coins_by_type.first, ancestors, descendants, spk_to_groups_map, coin_sel_params, /*positive_only=*/ false);\n+            group_outputs(output, coins_by_type.first, ancestors, descendants, spk_to_positive_groups_map,\n+                          coin_sel_params, /*positive_only=*/ true);\n+        }\n     }\n \n-    // Now we go through the entire map and pull out the OutputGroups\n-    for (const auto& spk_and_groups_pair: spk_to_groups_map) {\n-        const std::vector<OutputGroup>& groups_per_spk= spk_and_groups_pair.second;\n+    // Now we go through the entire maps and pull out the OutputGroups\n+    const auto& push_output_groups = [&](ScriptPubKeyToOutgroup& groups_map ,bool positive_only) {\n+        for (const auto& spk_and_groups_pair: groups_map) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612600",
      "id" : 1024612600,
      "line" : 504,
      "node_id" : "PRRC_kwDOABII5849Elj4",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 504,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 110,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612600/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612600",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wallet is unused",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:37:20Z",
      "diff_hunk" : "@@ -517,40 +550,39 @@ std::optional<SelectionResult> AttemptSelection(const CWallet& wallet, const CAm\n     // If we can't fund the transaction from any individual OutputType, run coin selection one last time\n     // over all available coins, which would allow mixing\n     if (allow_mixed_output_types) {\n-        if (auto result{ChooseSelectionResult(wallet, nTargetValue, eligibility_filter, available_coins.All(), coin_selection_params)}) {\n+        if (auto result{ChooseSelectionResult(wallet, nTargetValue, groups.all_groups, coin_selection_params)}) {\n             return result;\n         }\n     }\n     // Either mixing is not allowed and we couldn't find a solution from any single OutputType, or mixing was allowed and we still couldn't\n     // find a solution using all available coins\n-    return std::nullopt;\n+    return util::Error();\n };\n \n-std::optional<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const CAmount& nTargetValue, const CoinEligibilityFilter& eligibility_filter, const std::vector<COutput>& available_coins, const CoinSelectionParams& coin_selection_params)\n+util::Result<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const CAmount& nTargetValue, Groups& groups,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024612836",
      "id" : 1024612836,
      "line" : 562,
      "node_id" : "PRRC_kwDOABII5849Elnk",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 562,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 183,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024612836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024613519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for temporary object, same around this line.\r\n```suggestion\r\n            ordered_filters.emplace_back(0, 1, 2);\r\n```",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:38:39Z",
      "diff_hunk" : "@@ -614,54 +646,54 @@ std::optional<SelectionResult> AutomaticCoinSelection(const CWallet& wallet, Coi\n     // Coin Selection attempts to select inputs from a pool of eligible UTXOs to fund the\n     // transaction at a target feerate. If an attempt fails, more attempts may be made using a more\n     // permissive CoinEligibilityFilter.\n-    std::optional<SelectionResult> res = [&] {\n-        // If possible, fund the transaction with confirmed UTXOs only. Prefer at least six\n-        // confirmations on outputs received from other wallets and only spend confirmed change.\n-        if (auto r1{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(1, 6, 0), available_coins, coin_selection_params, /*allow_mixed_output_types=*/false)}) return r1;\n-        // Allow mixing only if no solution from any single output type can be found\n-        if (auto r2{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(1, 1, 0), available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) return r2;\n-\n+    util::Result<SelectionResult> res = [&] {\n+        // Ordered filters\n+        std::vector<CoinEligibilityFilter> ordered_filters{\n+                // If possible, fund the transaction with confirmed UTXOs only. Prefer at least six\n+                // confirmations on outputs received from other wallets and only spend confirmed change.\n+                CoinEligibilityFilter(1, 6, 0),\n+                CoinEligibilityFilter(1, 1, 0),\n+        };\n+        // Only allow mixed output types on filters added prior to this point\n+        unsigned int index_for_allow_mixed_output_types = ordered_filters.size();\n         // Fall back to using zero confirmation change (but with as few ancestors in the mempool as\n         // possible) if we cannot fund the transaction otherwise.\n         if (wallet.m_spend_zero_conf_change) {\n-            if (auto r3{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, 2), available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) return r3;\n-            if (auto r4{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, std::min((size_t)4, max_ancestors/3), std::min((size_t)4, max_descendants/3)),\n-                                   available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) {\n-                return r4;\n-            }\n-            if (auto r5{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, max_ancestors/2, max_descendants/2),\n-                                   available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) {\n-                return r5;\n-            }\n+            ordered_filters.emplace_back(CoinEligibilityFilter(0, 1, 2));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024613519",
      "id" : 1024613519,
      "line" : 662,
      "node_id" : "PRRC_kwDOABII5849ElyP",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 662,
      "original_position" : 278,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 278,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024613782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could use emplace_back\r\n```suggestion\r\n        txNew.vin.emplace_back(coin->outpoint, CScript(), nSequence);\r\n```",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:39:09Z",
      "diff_hunk" : "@@ -925,7 +958,7 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n     // behavior.\"\n     const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        txNew.vin.push_back(CTxIn(coin->outpoint, CScript(), nSequence));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024613782",
      "id" : 1024613782,
      "line" : 961,
      "node_id" : "PRRC_kwDOABII5849El2W",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 961,
      "original_position" : 364,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 364,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613782/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024613782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024614454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024614454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "could use structured binding",
      "commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "created_at" : "2022-11-16T23:40:20Z",
      "diff_hunk" : "@@ -0,0 +1,230 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+\n+#include <wallet/coinselection.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace wallet {\n+BOOST_FIXTURE_TEST_SUITE(group_outputs_tests, TestingSetup)\n+\n+static int nextLockTime = 0;\n+\n+static std::shared_ptr<CWallet> NewWallet(const node::NodeContext& m_node, const ArgsManager& m_args)\n+{\n+    std::unique_ptr<CWallet> wallet = std::make_unique<CWallet>(m_node.chain.get(), \"\", m_args, CreateMockWalletDatabase());\n+    wallet->LoadWallet();\n+    LOCK(wallet->cs_wallet);\n+    wallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+    wallet->SetupDescriptorScriptPubKeyMans();\n+    return wallet;\n+}\n+\n+static void addCoin(CoinsResult& coins,\n+                     OutputType type,\n+                     CWallet& wallet,\n+                     const CScript& dest,\n+                     const CAmount& nValue,\n+                     bool is_from_me,\n+                     CFeeRate fee_rate = CFeeRate(0),\n+                     int depth = 6)\n+{\n+    CMutableTransaction tx;\n+    tx.nLockTime = nextLockTime++;        // so all transactions get different hashes\n+    tx.vout.resize(1);\n+    tx.vout[0].nValue = nValue;\n+    tx.vout[0].scriptPubKey = dest;\n+\n+    const uint256& txid = tx.GetHash();\n+    LOCK(wallet.cs_wallet);\n+    auto ret = wallet.mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(txid), std::forward_as_tuple(MakeTransactionRef(std::move(tx)), TxStateInactive{}));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1024614454",
      "id" : 1024614454,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII5849EmA2",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 45,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/wallet/test/group_outputs_tests.cpp",
      "position" : 45,
      "pull_request_review_id" : 1183479857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024614454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-16T23:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1024614454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025259484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025259484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, good catch ðð¼ ",
      "commit_id" : "fd9cfdac4b966b7b197a7d717d35c066f37ddfa2",
      "created_at" : "2022-11-17T14:22:26Z",
      "diff_hunk" : "@@ -0,0 +1,230 @@\n+// Copyright (c) 2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/setup_common.h>\n+\n+#include <wallet/coinselection.h>\n+#include <wallet/spend.h>\n+#include <wallet/wallet.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+namespace wallet {\n+BOOST_FIXTURE_TEST_SUITE(group_outputs_tests, TestingSetup)\n+\n+static int nextLockTime = 0;\n+\n+static std::shared_ptr<CWallet> NewWallet(const node::NodeContext& m_node, const ArgsManager& m_args)\n+{\n+    std::unique_ptr<CWallet> wallet = std::make_unique<CWallet>(m_node.chain.get(), \"\", m_args, CreateMockWalletDatabase());\n+    wallet->LoadWallet();\n+    LOCK(wallet->cs_wallet);\n+    wallet->SetWalletFlag(WALLET_FLAG_DESCRIPTORS);\n+    wallet->SetupDescriptorScriptPubKeyMans();\n+    return wallet;\n+}\n+\n+static void addCoin(CoinsResult& coins,\n+                     OutputType type,\n+                     CWallet& wallet,\n+                     const CScript& dest,\n+                     const CAmount& nValue,\n+                     bool is_from_me,\n+                     CFeeRate fee_rate = CFeeRate(0),\n+                     int depth = 6)\n+{\n+    CMutableTransaction tx;\n+    tx.nLockTime = nextLockTime++;        // so all transactions get different hashes\n+    tx.vout.resize(1);\n+    tx.vout[0].nValue = nValue;\n+    tx.vout[0].scriptPubKey = dest;\n+\n+    const uint256& txid = tx.GetHash();\n+    LOCK(wallet.cs_wallet);\n+    auto ret = wallet.mapWallet.emplace(std::piecewise_construct, std::forward_as_tuple(txid), std::forward_as_tuple(MakeTransactionRef(std::move(tx)), TxStateInactive{}));\n+    assert(ret.second);\n+    CWalletTx& wtx = (*ret.first).second;\n+    const auto& txout = wtx.tx->vout.at(0);\n+    coins.Add(type, {COutPoint(wtx.GetHash(), 0),\n+                       txout,\n+                       depth,\n+                       CalculateMaximumSignedInputSize(txout, &wallet, /*coin_control=*/nullptr),\n+                       /*spendable=*/ true,\n+                       /*solvable=*/ true,\n+                       /*safe=*/ true,\n+                       wtx.GetTxTime(),\n+                       is_from_me,\n+                       fee_rate});\n+}\n+\n+ CoinSelectionParams makeSelectionParams(bool avoid_partial_spends)\n+{\n+    FastRandomContext rand{};\n+    return CoinSelectionParams{\n+            rand,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025259484",
      "id" : 1025259484,
      "in_reply_to_id" : 1024610915,
      "line" : 64,
      "node_id" : "PRRC_kwDOABII5849HDfc",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 64,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/wallet/test/group_outputs_tests.cpp",
      "position" : 64,
      "pull_request_review_id" : 1184411785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025259484/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T14:22:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025259484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025260624"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025260624"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good eye, this let me remove the `AttemptSelection` wallet arg too.",
      "commit_id" : "fd9cfdac4b966b7b197a7d717d35c066f37ddfa2",
      "created_at" : "2022-11-17T14:23:21Z",
      "diff_hunk" : "@@ -517,40 +550,39 @@ std::optional<SelectionResult> AttemptSelection(const CWallet& wallet, const CAm\n     // If we can't fund the transaction from any individual OutputType, run coin selection one last time\n     // over all available coins, which would allow mixing\n     if (allow_mixed_output_types) {\n-        if (auto result{ChooseSelectionResult(wallet, nTargetValue, eligibility_filter, available_coins.All(), coin_selection_params)}) {\n+        if (auto result{ChooseSelectionResult(wallet, nTargetValue, groups.all_groups, coin_selection_params)}) {\n             return result;\n         }\n     }\n     // Either mixing is not allowed and we couldn't find a solution from any single OutputType, or mixing was allowed and we still couldn't\n     // find a solution using all available coins\n-    return std::nullopt;\n+    return util::Error();\n };\n \n-std::optional<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const CAmount& nTargetValue, const CoinEligibilityFilter& eligibility_filter, const std::vector<COutput>& available_coins, const CoinSelectionParams& coin_selection_params)\n+util::Result<SelectionResult> ChooseSelectionResult(const CWallet& wallet, const CAmount& nTargetValue, Groups& groups,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025260624",
      "id" : 1025260624,
      "in_reply_to_id" : 1024612836,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849HDxQ",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 562,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1184413529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025260624/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T14:23:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025260624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025265189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025265189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I actually didn't make this change on purpose to minimize the diff burden inside the same commit. Would prefer to do it in a different commit to make reviewers' life a bit easier (adding the args names there too).",
      "commit_id" : "fd9cfdac4b966b7b197a7d717d35c066f37ddfa2",
      "created_at" : "2022-11-17T14:26:58Z",
      "diff_hunk" : "@@ -614,54 +646,54 @@ std::optional<SelectionResult> AutomaticCoinSelection(const CWallet& wallet, Coi\n     // Coin Selection attempts to select inputs from a pool of eligible UTXOs to fund the\n     // transaction at a target feerate. If an attempt fails, more attempts may be made using a more\n     // permissive CoinEligibilityFilter.\n-    std::optional<SelectionResult> res = [&] {\n-        // If possible, fund the transaction with confirmed UTXOs only. Prefer at least six\n-        // confirmations on outputs received from other wallets and only spend confirmed change.\n-        if (auto r1{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(1, 6, 0), available_coins, coin_selection_params, /*allow_mixed_output_types=*/false)}) return r1;\n-        // Allow mixing only if no solution from any single output type can be found\n-        if (auto r2{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(1, 1, 0), available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) return r2;\n-\n+    util::Result<SelectionResult> res = [&] {\n+        // Ordered filters\n+        std::vector<CoinEligibilityFilter> ordered_filters{\n+                // If possible, fund the transaction with confirmed UTXOs only. Prefer at least six\n+                // confirmations on outputs received from other wallets and only spend confirmed change.\n+                CoinEligibilityFilter(1, 6, 0),\n+                CoinEligibilityFilter(1, 1, 0),\n+        };\n+        // Only allow mixed output types on filters added prior to this point\n+        unsigned int index_for_allow_mixed_output_types = ordered_filters.size();\n         // Fall back to using zero confirmation change (but with as few ancestors in the mempool as\n         // possible) if we cannot fund the transaction otherwise.\n         if (wallet.m_spend_zero_conf_change) {\n-            if (auto r3{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, 2), available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) return r3;\n-            if (auto r4{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, std::min((size_t)4, max_ancestors/3), std::min((size_t)4, max_descendants/3)),\n-                                   available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) {\n-                return r4;\n-            }\n-            if (auto r5{AttemptSelection(wallet, value_to_select, CoinEligibilityFilter(0, 1, max_ancestors/2, max_descendants/2),\n-                                   available_coins, coin_selection_params, /*allow_mixed_output_types=*/true)}) {\n-                return r5;\n-            }\n+            ordered_filters.emplace_back(CoinEligibilityFilter(0, 1, 2));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025265189",
      "id" : 1025265189,
      "in_reply_to_id" : 1024613519,
      "line" : 655,
      "node_id" : "PRRC_kwDOABII5849HE4l",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 655,
      "original_position" : 278,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 271,
      "pull_request_review_id" : 1184420038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025265189/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T14:26:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025265189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025266473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025266473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree but it's unrelated to the commit changes. Let's better leave it for another PR.",
      "commit_id" : "fd9cfdac4b966b7b197a7d717d35c066f37ddfa2",
      "created_at" : "2022-11-17T14:27:59Z",
      "diff_hunk" : "@@ -925,7 +958,7 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n     // behavior.\"\n     const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        txNew.vin.push_back(CTxIn(coin->outpoint, CScript(), nSequence));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#discussion_r1025266473",
      "id" : 1025266473,
      "in_reply_to_id" : 1024613782,
      "line" : 954,
      "node_id" : "PRRC_kwDOABII5849HFMp",
      "original_commit_id" : "ae41a8b0f48b7c0b523b7f3634c2b220355518be",
      "original_line" : 954,
      "original_position" : 364,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 357,
      "pull_request_review_id" : 1184421918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25806",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025266473/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-17T14:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025266473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-06T11:31:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25806#issuecomment-1339184066",
      "id" : 1339184066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25806",
      "node_id" : "IC_kwDOABII585P0lPC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339184066/reactions"
      },
      "updated_at" : "2022-12-06T11:31:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339184066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
