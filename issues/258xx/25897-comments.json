[
   {
      "author_association" : "MEMBER",
      "body" : "Can you reproduce the log with log contention logging enabled? My guess is just that cs_main is held by one thread, putting all others to sleep",
      "created_at" : "2022-08-22T06:32:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25897#issuecomment-1221907019",
      "id" : 1221907019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25897",
      "node_id" : "IC_kwDOABII585I1NJL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221907019/reactions"
      },
      "updated_at" : "2022-08-22T06:32:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1221907019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "How do I enable logging \"log contention\"? I've not seen any option about it specifically. I just see an option for leveldb itself (debug=leveldb). Do you mean \"lock contention\" (debug=lock ?)\r\n\r\nNote also that there's also UPNP, which currently does not uses the standard logs, but just uses \"perror()\", i.e. logs on the standard error (notably messages about socket's sendto(), when it cannot send the message as the target is unreachable)\r\nAllowing these logs to be redirected and assigning them a logging category would require patching some source files of its upstream library.\r\n",
      "created_at" : "2022-08-22T10:25:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25897#issuecomment-1222158077",
      "id" : 1222158077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25897",
      "node_id" : "IC_kwDOABII585I2Kb9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222158077/reactions"
      },
      "updated_at" : "2022-08-22T10:26:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222158077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1387035?v=4",
         "events_url" : "https://api.github.com/users/verdy-p/events{/privacy}",
         "followers_url" : "https://api.github.com/users/verdy-p/followers",
         "following_url" : "https://api.github.com/users/verdy-p/following{/other_user}",
         "gists_url" : "https://api.github.com/users/verdy-p/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/verdy-p",
         "id" : 1387035,
         "login" : "verdy-p",
         "node_id" : "MDQ6VXNlcjEzODcwMzU=",
         "organizations_url" : "https://api.github.com/users/verdy-p/orgs",
         "received_events_url" : "https://api.github.com/users/verdy-p/received_events",
         "repos_url" : "https://api.github.com/users/verdy-p/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/verdy-p/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/verdy-p/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/verdy-p"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From the developer notes:\r\n```\r\nDefining `DEBUG_LOCKCONTENTION` adds a \"lock\" logging category to the logging\r\nRPC that, when enabled, logs the location and duration of each lock contention\r\nto the `debug.log` file.\r\n\r\nThe `--enable-debug` configure option adds `-DDEBUG_LOCKCONTENTION` to the\r\ncompiler flags. You may also enable it manually for a non-debug build by running\r\nconfigure with `-DDEBUG_LOCKCONTENTION` added to your CPPFLAGS,\r\ni.e. `CPPFLAGS=\"-DDEBUG_LOCKCONTENTION\"`, then build and run bitcoind.\r\n\r\nYou can then use the `-debug=lock` configuration option at bitcoind startup or\r\n`bitcoin-cli logging '[\"lock\"]'` at runtime to turn on lock contention logging.\r\nIt can be toggled off again with `bitcoin-cli logging [] '[\"lock\"]'`.\r\n```\r\n",
      "created_at" : "2022-08-22T10:30:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25897#issuecomment-1222162965",
      "id" : 1222162965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25897",
      "node_id" : "IC_kwDOABII585I2LoV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222162965/reactions"
      },
      "updated_at" : "2022-08-22T10:30:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222162965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "OK so I need to use my compiled version and not the current releases that do not have it.\r\n\r\nI know already the syntax for the bitcoin-cli RPC \"logging\" command, I use it often.\r\n\r\nNote that this syntax depends on the shell used:\r\n* For Linux on bash: `bitcoin-cli logging '[\"lock\"]' '[]'` (need single quotes to surround brackets around JSON arrays and double quotes for JSON strings in them)\r\n* For Windows CMD:  `bitcoin-cli logging [\\\"lock\\\"] []` (do not use single quotes around parameters, use a backslash before double quotes surrounding JSON string, not needed for ...)\r\n\r\nThat's not ideal to use bitcoin-cli, which should support a non-RPC syntax like `bitcoin-cli -log=lock`  to enable the category \"lock\" or `bitcoin-cli -log=lock,leveldb` if we want to enable more, and `bitcoin-cli -nolog=lock` to disable it (bitcoin-cli should translate it to the RPC JSON syntax itself...) or `bitcoin-cli log=-lock`: log category names should not contain commas, spaces, minus/plus signs, the JSON array syntax is ugly. We could even make it shorter as `bitcoin-cli +lock` for enabling and `bitcoin-cli +-lock` for disabling, using jut a `+` (no change needed for the syntax in bitcoin.conf files: `debug=category` or `nodebug=category` for individual categories or for special categories \"0\" or \"none\", \"1\" or \"all\", but eventually it could support comma-separated lists).\r\n\r\nNote that with these crashes/hangs, the UPNP thread is still running as I see its logs every few minutes (apparently it does not lock indexer threads, or RPC threads or validation threads; but it locks the connection handler thread that adds/removes new connections and manages the address list; but they are not affected: I can see on bitnode.io that my \"hanged\" nodes are connected but experiment either timeouts, or extremely long response times for more than 5 minutes to incoming requests from nodes already connected, and my firewall see them connecting with success, sending requests, but getting no reply to their RPC requests)\r\n\r\nAlso I've tried both Windows (v11, Pro or Enterprise) and Linux (Debian Bullseye) on the same host (different VMs but same hypervisor, similar CPU/RAM/storage config, just a different filesystem NTFS vs. Ext4): the Windows version is MUCH faster by several factors (I bet Windows has a better I/O system, better caching strategies and a more responsive scheduler for multhreading and for handling mutexes). Debian in WSL (HyperV hypervisor on Windows) run with similar performances than native Windows but faster than native Debian (there may be tuning parameters for the Debian native kernel, but I did not invest time in it); i did not tune any guest or host OS specifically to run these tests, so did not use any root/administrator commands, except for installing required third party packages or system libraries and performing standard system updates with \"sudo apt update/upgrade\" on Debian, or Windows Update in Windows 11, and did not use any custom repositories for these packages).\r\n",
      "created_at" : "2022-08-22T10:39:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25897#issuecomment-1222172202",
      "id" : 1222172202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25897",
      "node_id" : "IC_kwDOABII585I2N4q",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222172202/reactions"
      },
      "updated_at" : "2022-08-22T11:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222172202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1387035?v=4",
         "events_url" : "https://api.github.com/users/verdy-p/events{/privacy}",
         "followers_url" : "https://api.github.com/users/verdy-p/followers",
         "following_url" : "https://api.github.com/users/verdy-p/following{/other_user}",
         "gists_url" : "https://api.github.com/users/verdy-p/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/verdy-p",
         "id" : 1387035,
         "login" : "verdy-p",
         "node_id" : "MDQ6VXNlcjEzODcwMzU=",
         "organizations_url" : "https://api.github.com/users/verdy-p/orgs",
         "received_events_url" : "https://api.github.com/users/verdy-p/received_events",
         "repos_url" : "https://api.github.com/users/verdy-p/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/verdy-p/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/verdy-p/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/verdy-p"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Also that that these hangs of the RPC service never occur if I use a RPC command immediately after startup to disable all communications (for exampIe have all the necessary blocks alerady downloaded, or just enough of them already there so that I can run indexers (including several ones: chainstate, txindex, coinsdb,...). The bugs seems to occur when the chaintips are updated by incoming new blocks or undo blocks being added to `blocks/blk*dat` and `blocks/rev*.dat`, and apparently changing the total number of chaintips, and possibly changing the active one in the main branch.\r\n",
      "created_at" : "2022-08-22T11:27:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/25897#issuecomment-1222222243",
      "id" : 1222222243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25897",
      "node_id" : "IC_kwDOABII585I2aGj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222222243/reactions"
      },
      "updated_at" : "2022-08-22T11:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1222222243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1387035?v=4",
         "events_url" : "https://api.github.com/users/verdy-p/events{/privacy}",
         "followers_url" : "https://api.github.com/users/verdy-p/followers",
         "following_url" : "https://api.github.com/users/verdy-p/following{/other_user}",
         "gists_url" : "https://api.github.com/users/verdy-p/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/verdy-p",
         "id" : 1387035,
         "login" : "verdy-p",
         "node_id" : "MDQ6VXNlcjEzODcwMzU=",
         "organizations_url" : "https://api.github.com/users/verdy-p/orgs",
         "received_events_url" : "https://api.github.com/users/verdy-p/received_events",
         "repos_url" : "https://api.github.com/users/verdy-p/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/verdy-p/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/verdy-p/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/verdy-p"
      }
   }
]
