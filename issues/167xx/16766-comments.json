[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I added a cache which works per call/across calls, but does not store the results semi-permanently.\r\n\r\nThis should reduce DoS risk of this change.\r\n\r\nThere is no risk of _untrusted_ parents causing a resource exploitation, as we immediately return once that is detected.",
      "created_at" : "2019-08-30T20:37:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#issuecomment-526741579",
      "id" : 526741579,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16766",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjc0MTU3OQ==",
      "updated_at" : "2019-08-30T20:37:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526741579",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2019-08-30T22:33:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#issuecomment-526769063",
      "id" : 526769063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16766",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjc2OTA2Mw==",
      "updated_at" : "2019-09-05T16:24:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526769063",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If a parent is not trusted, then a child should not be either.\r\n\r\nWould be nice to have a test for this or update the `wallet_balance.py` script in case it is already tested there. (`wallet_balance.py` is failing)",
      "created_at" : "2019-09-03T15:48:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#issuecomment-527518660",
      "id" : 527518660,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16766",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNzUxODY2MA==",
      "updated_at" : "2019-09-03T15:48:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527518660",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I updated the tests to pass.\r\n\r\nIn the test, we  have two nodes with a balance of 50 each and then:\r\n\r\nSend 40 from node A to node B.\r\nSend 60 from node B to node A.\r\n\r\nThen we would check the balances.\r\n\r\nPreviously, we would immediately report a balance of 30 on node B as unconfirmed and trusted.\r\n\r\nNow, we show that balance as unconfirmed.\r\n\r\nThe balance is indeed \"trusted\" and \"confirmed\" insofar as removing the mempool transactions would return *at least* that much money. But the current software marks it as unconfirmed because the 'taint' tracking of transaction trust for summing balances doesn't consider which inputs belong to a user.\r\n\r\nI think the new behavior is correct; we shouldn't be treating those funds as confirmed. If you want to *rely* on that specific UTXO existing which has given you that balance, you cannot, as a third party spending the other input would destroy that unconfirmed.\r\n\r\nOverall I think that this points to a general concept worth exploring as a revision to the categories \"unconfirmed\" and \"confirmed\", to have \"free cash\", \"locked\", and \"unconfirmed\". Free cash can be spent at will, locked funds are balances that are guaranteed to exist but we don't have a confirmed UTXO for yet, and unconfirmed are funds we may or may not receive. I think this is out of scope of this PR though, but is worth further thought.",
      "created_at" : "2019-09-03T17:42:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#issuecomment-527563982",
      "id" : 527563982,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16766",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNzU2Mzk4Mg==",
      "updated_at" : "2019-09-03T17:42:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527563982",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r320435215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320435215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            assert_equal(self.nodes[1].getbalance(), Decimal('0'))  # node 1's send had an unsafe input\r\n```",
      "commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "created_at" : "2019-09-03T19:16:39Z",
      "diff_hunk" : "@@ -112,10 +112,10 @@ def run_test(self):\n         def test_balances(*, fee_node_1=0):\n             # getbalance without any arguments includes unconfirmed transactions, but not untrusted transactions\n             assert_equal(self.nodes[0].getbalance(), Decimal('9.99'))  # change from node 0's send\n-            assert_equal(self.nodes[1].getbalance(), Decimal('30') - fee_node_1)  # change from node 1's send\n+            assert_equal(self.nodes[1].getbalance(), Decimal('0'))  # change from node 1's send",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r320435215",
      "id" : 320435215,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMDQzNTIxNQ==",
      "original_commit_id" : "bee1dc9f8a5182f03979fa066dc7937fc945bf29",
      "original_position" : 5,
      "path" : "test/functional/wallet_balance.py",
      "position" : null,
      "pull_request_review_id" : 283206185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766",
      "updated_at" : "2019-09-04T18:40:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320435215",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Test failure unrelated it seems? In assumevalid",
      "created_at" : "2019-09-05T18:47:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#issuecomment-528522217",
      "id" : 528522217,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16766",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyODUyMjIxNw==",
      "updated_at" : "2019-09-05T18:47:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/528522217",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529167"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With the overloaded `IsTrusted` this could be reverted? Same below.",
      "commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "created_at" : "2019-09-05T23:47:40Z",
      "diff_hunk" : "@@ -2407,10 +2421,11 @@ CWallet::Balance CWallet::GetBalance(const int min_depth, bool avoid_reuse) cons\n     {\n         auto locked_chain = chain().lock();\n         LOCK(cs_wallet);\n+        std::set<uint256> trustedParents;\n         for (const auto& entry : mapWallet)\n         {\n             const CWalletTx& wtx = entry.second;\n-            const bool is_trusted{wtx.IsTrusted(*locked_chain)};\n+            const bool is_trusted{wtx.IsTrusted(*locked_chain, trustedParents)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529167",
      "id" : 321529167,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTUyOTE2Nw==",
      "original_commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "original_position" : 39,
      "path" : "src/wallet/wallet.cpp",
      "position" : 39,
      "pull_request_review_id" : 284597322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766",
      "updated_at" : "2019-09-05T23:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529167",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, join with line above - to follow correct format.",
      "commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "created_at" : "2019-09-05T23:51:38Z",
      "diff_hunk" : "@@ -2320,8 +2326,16 @@ bool CWalletTx::IsTrusted(interfaces::Chain::Lock& locked_chain) const\n         if (parent == nullptr)\n             return false;\n         const CTxOut& parentOut = parent->tx->vout[txin.prevout.n];\n+        // Check that this specific input being spent is trusted\n         if (pwallet->IsMine(parentOut) != ISMINE_SPENDABLE)\n             return false;\n+        // If we've already trusted this parent, continue\n+        if (trustedParents.count(parent->GetHash()))\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529969",
      "id" : 321529969,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTUyOTk2OQ==",
      "original_commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "original_position" : 22,
      "path" : "src/wallet/wallet.cpp",
      "position" : 22,
      "pull_request_review_id" : 284597322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766",
      "updated_at" : "2019-09-05T23:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529969",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529995"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, snake case - header too.",
      "commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "created_at" : "2019-09-05T23:51:48Z",
      "diff_hunk" : "@@ -2295,6 +2295,12 @@ bool CWalletTx::InMempool() const\n }\n \n bool CWalletTx::IsTrusted(interfaces::Chain::Lock& locked_chain) const\n+{\n+    std::set<uint256> s;\n+    return IsTrusted(locked_chain, s);\n+}\n+\n+bool CWalletTx::IsTrusted(interfaces::Chain::Lock& locked_chain, std::set<uint256>& trustedParents) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16766#discussion_r321529995",
      "id" : 321529995,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTUyOTk5NQ==",
      "original_commit_id" : "07858cc41a2f3cc74f281f4ac4331e26dffc9644",
      "original_position" : 9,
      "path" : "src/wallet/wallet.cpp",
      "position" : 9,
      "pull_request_review_id" : 284597322,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16766",
      "updated_at" : "2019-09-05T23:52:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321529995",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
