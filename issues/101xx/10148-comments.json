[
   {
      "body" : "This badly needs testing, but I'm not sure how to simulate crashes in the middle of flushing (I've manually verified this patch can recover from failure by introducing an `exit(0)` in the middle of the flush code).",
      "created_at" : "2017-04-04T09:55:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291452125",
      "id" : 291452125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-04T10:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291452125",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Cool!\r\n\r\n> but I'm not sure how to simulate crashes in the middle of flushing \r\n\r\nI'll get to that :)",
      "created_at" : "2017-04-04T10:43:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291463322",
      "id" : 291463322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-04T10:43:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291463322",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Rebased, fixed a bug, and added a commit to allows simulating crashes after partial flushes.",
      "created_at" : "2017-04-05T09:38:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291808418",
      "id" : 291808418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-05T09:38:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291808418",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109871704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109871704"
         }
      },
      "body" : "This sync should be optional at least (not a realistic crash otherwise)",
      "commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "created_at" : "2017-04-05T09:41:08Z",
      "diff_hunk" : "@@ -74,6 +76,15 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\n             db.WriteBatch(batch);\n             batch.Clear();\n+            int crash_simulate = GetArg(\"-dbcrashratio\", 0);\n+            if (crash_simulate) {\n+                static FastRandomContext rng;\n+                if (rng.rand32() % crash_simulate == 0) {\n+                    LogPrintf(\"Simulating a crash. Goodbye.\");\n+                    sync();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109871704",
      "id" : 109871704,
      "original_commit_id" : "aa249d732f065826ebdd6fb376f79f863e6d9212",
      "original_position" : 20,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 31000441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-06T07:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109871704",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109901577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109901577"
         }
      },
      "body" : "I've just removed the sync. It seems not needed for testing (I've done reindexes with hundreds of crashes in between).",
      "commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "created_at" : "2017-04-05T12:29:09Z",
      "diff_hunk" : "@@ -74,6 +76,15 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\n             db.WriteBatch(batch);\n             batch.Clear();\n+            int crash_simulate = GetArg(\"-dbcrashratio\", 0);\n+            if (crash_simulate) {\n+                static FastRandomContext rng;\n+                if (rng.rand32() % crash_simulate == 0) {\n+                    LogPrintf(\"Simulating a crash. Goodbye.\");\n+                    sync();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109901577",
      "id" : 109901577,
      "original_commit_id" : "aa249d732f065826ebdd6fb376f79f863e6d9212",
      "original_position" : 20,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 31033083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-06T07:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109901577",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : " contrib/devtools/check-doc.py is unhappy that you added new arguments without asking for permission from the argument gods.",
      "created_at" : "2017-04-05T16:28:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291918026",
      "id" : 291918026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-05T16:28:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291918026",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109964790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109964790"
         }
      },
      "body" : "If we have memory usage that is some multiple of this, perhaps the argument should be in the form of the actual usage rather than the batch size?",
      "commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "created_at" : "2017-04-05T16:31:53Z",
      "diff_hunk" : "@@ -44,10 +45,21 @@ uint256 CCoinsViewDB::GetBestBlock() const {\n     return hashBestChain;\n }\n \n+uint256 CCoinsViewDB::GetUptoBlock() const {\n+    uint256 hashBestChain;\n+    if (!db.Read(DB_BEST_BLOCK_UPTO, hashBestChain))\n+        return uint256();\n+    return hashBestChain;\n+}\n+\n bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n     CDBBatch batch(db);\n     size_t count = 0;\n     size_t changed = 0;\n+    size_t batch_size = (size_t)GetArg(\"-dbbatchsize\", nDefaultDbBatchSize) << 20;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109964790",
      "id" : 109964790,
      "original_commit_id" : "7c2459d0e323c22250f527a5da6d618b69b69c07",
      "original_position" : 23,
      "path" : "src/txdb.cpp",
      "position" : 34,
      "pull_request_review_id" : 31101736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-06T07:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109964790",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110097256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110097256"
         }
      },
      "body" : "Well the relevant constraint is the memory usage peak from allocating the batch, which depends on the batch memory usage, not dbcache memory usage. Also, I don't think anyone will need to change this property (except for tests, where it's very useful to get much more frequent partial flushes).",
      "commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "created_at" : "2017-04-06T07:47:23Z",
      "diff_hunk" : "@@ -44,10 +45,21 @@ uint256 CCoinsViewDB::GetBestBlock() const {\n     return hashBestChain;\n }\n \n+uint256 CCoinsViewDB::GetUptoBlock() const {\n+    uint256 hashBestChain;\n+    if (!db.Read(DB_BEST_BLOCK_UPTO, hashBestChain))\n+        return uint256();\n+    return hashBestChain;\n+}\n+\n bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n     CDBBatch batch(db);\n     size_t count = 0;\n     size_t changed = 0;\n+    size_t batch_size = (size_t)GetArg(\"-dbbatchsize\", nDefaultDbBatchSize) << 20;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110097256",
      "id" : 110097256,
      "original_commit_id" : "7c2459d0e323c22250f527a5da6d618b69b69c07",
      "original_position" : 23,
      "path" : "src/txdb.cpp",
      "position" : 34,
      "pull_request_review_id" : 31243122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-06T07:47:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110097256",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
