[
   {
      "body" : "This badly needs testing, but I'm not sure how to simulate crashes in the middle of flushing (I've manually verified this patch can recover from failure by introducing an `exit(0)` in the middle of the flush code).",
      "created_at" : "2017-04-04T09:55:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291452125",
      "id" : 291452125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-04T10:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291452125",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Cool!\r\n\r\n> but I'm not sure how to simulate crashes in the middle of flushing \r\n\r\nI'll get to that :)",
      "created_at" : "2017-04-04T10:43:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291463322",
      "id" : 291463322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-04T10:43:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291463322",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Rebased, fixed a bug, and added a commit to allows simulating crashes after partial flushes.",
      "created_at" : "2017-04-05T09:38:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291808418",
      "id" : 291808418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-05T09:38:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291808418",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109871704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109871704"
         }
      },
      "body" : "This sync should be optional at least (not a realistic crash otherwise)",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-05T09:41:08Z",
      "diff_hunk" : "@@ -74,6 +76,15 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\n             db.WriteBatch(batch);\n             batch.Clear();\n+            int crash_simulate = GetArg(\"-dbcrashratio\", 0);\n+            if (crash_simulate) {\n+                static FastRandomContext rng;\n+                if (rng.rand32() % crash_simulate == 0) {\n+                    LogPrintf(\"Simulating a crash. Goodbye.\");\n+                    sync();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109871704",
      "id" : 109871704,
      "original_commit_id" : "aa249d732f065826ebdd6fb376f79f863e6d9212",
      "original_position" : 20,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 31000441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109871704",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109901577"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109901577"
         }
      },
      "body" : "I've just removed the sync. It seems not needed for testing (I've done reindexes with hundreds of crashes in between).",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-05T12:29:09Z",
      "diff_hunk" : "@@ -74,6 +76,15 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n             LogPrint(BCLog::COINDB, \"Writing partial batch of %.2f MiB\\n\", batch.SizeEstimate() * (1.0 / 1048576.0));\n             db.WriteBatch(batch);\n             batch.Clear();\n+            int crash_simulate = GetArg(\"-dbcrashratio\", 0);\n+            if (crash_simulate) {\n+                static FastRandomContext rng;\n+                if (rng.rand32() % crash_simulate == 0) {\n+                    LogPrintf(\"Simulating a crash. Goodbye.\");\n+                    sync();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109901577",
      "id" : 109901577,
      "original_commit_id" : "aa249d732f065826ebdd6fb376f79f863e6d9212",
      "original_position" : 20,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 31033083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109901577",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : " contrib/devtools/check-doc.py is unhappy that you added new arguments without asking for permission from the argument gods.",
      "created_at" : "2017-04-05T16:28:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#issuecomment-291918026",
      "id" : 291918026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10148",
      "updated_at" : "2017-04-05T16:28:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/291918026",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109964790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109964790"
         }
      },
      "body" : "If we have memory usage that is some multiple of this, perhaps the argument should be in the form of the actual usage rather than the batch size?",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-05T16:31:53Z",
      "diff_hunk" : "@@ -44,10 +45,21 @@ uint256 CCoinsViewDB::GetBestBlock() const {\n     return hashBestChain;\n }\n \n+uint256 CCoinsViewDB::GetUptoBlock() const {\n+    uint256 hashBestChain;\n+    if (!db.Read(DB_BEST_BLOCK_UPTO, hashBestChain))\n+        return uint256();\n+    return hashBestChain;\n+}\n+\n bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n     CDBBatch batch(db);\n     size_t count = 0;\n     size_t changed = 0;\n+    size_t batch_size = (size_t)GetArg(\"-dbbatchsize\", nDefaultDbBatchSize) << 20;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r109964790",
      "id" : 109964790,
      "original_commit_id" : "7c2459d0e323c22250f527a5da6d618b69b69c07",
      "original_position" : 23,
      "path" : "src/txdb.cpp",
      "position" : 34,
      "pull_request_review_id" : 31101736,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/109964790",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110097256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110097256"
         }
      },
      "body" : "Well the relevant constraint is the memory usage peak from allocating the batch, which depends on the batch memory usage, not dbcache memory usage. Also, I don't think anyone will need to change this property (except for tests, where it's very useful to get much more frequent partial flushes).",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-06T07:47:23Z",
      "diff_hunk" : "@@ -44,10 +45,21 @@ uint256 CCoinsViewDB::GetBestBlock() const {\n     return hashBestChain;\n }\n \n+uint256 CCoinsViewDB::GetUptoBlock() const {\n+    uint256 hashBestChain;\n+    if (!db.Read(DB_BEST_BLOCK_UPTO, hashBestChain))\n+        return uint256();\n+    return hashBestChain;\n+}\n+\n bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n     CDBBatch batch(db);\n     size_t count = 0;\n     size_t changed = 0;\n+    size_t batch_size = (size_t)GetArg(\"-dbbatchsize\", nDefaultDbBatchSize) << 20;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110097256",
      "id" : 110097256,
      "original_commit_id" : "7c2459d0e323c22250f527a5da6d618b69b69c07",
      "original_position" : 23,
      "path" : "src/txdb.cpp",
      "position" : 34,
      "pull_request_review_id" : 31243122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110097256",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110909763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110909763"
         }
      },
      "body" : "Can you add comments as to why 3 (and, below, 2) bytes are overhead here?",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T14:01:18Z",
      "diff_hunk" : "@@ -75,6 +83,7 @@ class CDBBatch\n         leveldb::Slice slValue(ssValue.data(), ssValue.size());\n \n         batch.Put(slKey, slValue);\n+        size_estimate += 3 + slKey.size() + slValue.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110909763",
      "id" : 110909763,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 25,
      "path" : "src/dbwrapper.h",
      "position" : null,
      "pull_request_review_id" : 32114181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110909763",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110974712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110974712"
         }
      },
      "body" : "Hmm, yes. Were you intending to do this after this PR? Can you just delete it and re-create it here? I feel like it may make sense to move the chainActive.Tip-setting from LoadBlockIndexDB to after this point.\r\n\r\nSpeaking of which, did you mean to add a PruneBlockIndexCandidates() to ReplayBlocks ala LoadBlockIndexDB?",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T18:10:16Z",
      "diff_hunk" : "@@ -1476,6 +1479,12 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     break;\n                 }\n \n+                if (!ReplayBlocks(chainparams, pcoinsdbview)) {\n+                    strLoadError = _(\"Unable to replay blocks. You will need to rebuild the databse using -reindex.\");\n+                    break;\n+                }\n+                pcoinsTip->SetBestBlock(pcoinsdbview->GetBestBlock()); // TODO: only initialize pcoinsTip after ReplayBlocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110974712",
      "id" : 110974712,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 18,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 32114181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110974712",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110981608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110981608"
         }
      },
      "body" : "Should we also fail here if hashBest has been written (ie is non-IsNull) but isnt in mapBlockIndex?",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T18:37:57Z",
      "diff_hunk" : "@@ -3681,6 +3694,51 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n     return true;\n }\n \n+bool ReplayBlocks(const CChainParams& params, CCoinsView* view)\n+{\n+    LOCK(cs_main);\n+\n+    CCoinsViewCache cache(view);\n+\n+    uint256 hashBest = view->GetBestBlock();\n+    uint256 hashUpto = view->GetUptoBlock();\n+\n+    if (hashUpto.IsNull() || hashBest == hashUpto) return true;\n+\n+    if (mapBlockIndex.count(hashUpto) == 0) {\n+        return error(\"ReplayBlocks(): chainstate boundaries not in block index\");\n+    }\n+    auto pindexUpto = mapBlockIndex[hashUpto];\n+\n+    int nHeight = 1; // Skip the genesis block\n+    if (mapBlockIndex.count(hashBest)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110981608",
      "id" : 110981608,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 50,
      "path" : "src/validation.cpp",
      "position" : 53,
      "pull_request_review_id" : 32114181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110981608",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110985291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110985291"
         }
      },
      "body" : "Based on the comment above ModifyNewCoins I do not believe this works, we may need something new to capture the \"maybe not fresh, but definitely fully overwrite in any case\" case.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T18:53:29Z",
      "diff_hunk" : "@@ -1296,6 +1296,19 @@ void static InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state\n     }\n }\n \n+/** Apply the effects of a block on the utxo cache, ignoring that it may already have been applied. */\n+static void ReplayBlock(const CBlock& block, CCoinsViewCache& inputs, int nHeight)\n+{\n+    for (const CTransactionRef& tx : block.vtx) {\n+        if (!tx->IsCoinBase()) {\n+            for (const CTxIn &txin : tx->vin) {\n+                inputs.ModifyCoins(txin.prevout.hash)->Spend(txin.prevout.n);\n+            }\n+        }\n+        inputs.ModifyNewCoins(tx->GetHash(), tx->IsCoinBase())->FromTx(*tx, nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110985291",
      "id" : 110985291,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 13,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 32114181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110985291",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110985717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110985717"
         }
      },
      "body" : "It seems super weird to be acting entirely on non-globals, and then suddenly set a global here.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T18:55:23Z",
      "diff_hunk" : "@@ -3681,6 +3694,51 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n     return true;\n }\n \n+bool ReplayBlocks(const CChainParams& params, CCoinsView* view)\n+{\n+    LOCK(cs_main);\n+\n+    CCoinsViewCache cache(view);\n+\n+    uint256 hashBest = view->GetBestBlock();\n+    uint256 hashUpto = view->GetUptoBlock();\n+\n+    if (hashUpto.IsNull() || hashBest == hashUpto) return true;\n+\n+    if (mapBlockIndex.count(hashUpto) == 0) {\n+        return error(\"ReplayBlocks(): chainstate boundaries not in block index\");\n+    }\n+    auto pindexUpto = mapBlockIndex[hashUpto];\n+\n+    int nHeight = 1; // Skip the genesis block\n+    if (mapBlockIndex.count(hashBest)) {\n+        auto pindexBest = mapBlockIndex[hashBest];\n+        if (pindexUpto->GetAncestor(pindexBest->nHeight) != pindexBest) {\n+            return error(\"ReplayBlocks(): chainstate tip does not derive from final boundary\");\n+        }\n+        nHeight = std::max(nHeight, pindexBest->nHeight);\n+    }\n+\n+    uiInterface.ShowProgress(_(\"Replaying blocks...\"), 0);\n+    LogPrintf(\"Replaying %i blocks\\n\", pindexUpto->nHeight - nHeight);\n+\n+    while (nHeight < pindexUpto->nHeight) {\n+        ++nHeight;\n+        auto pindex = pindexUpto->GetAncestor(nHeight);\n+        CBlock block;\n+        if (!ReadBlockFromDisk(block, pindex, params.GetConsensus())) {\n+            return error(\"ReplayBlocks(): ReadBlockFromDisk failed at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\n+        }\n+        ReplayBlock(block, cache, pindex->nHeight);\n+    }\n+    cache.SetBestBlock(hashUpto);\n+    chainActive.SetTip(pindexUpto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r110985717",
      "id" : 110985717,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 71,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 32114181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/110985717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111017596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111017596"
         }
      },
      "body" : "Done",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T21:27:04Z",
      "diff_hunk" : "@@ -75,6 +83,7 @@ class CDBBatch\n         leveldb::Slice slValue(ssValue.data(), ssValue.size());\n \n         batch.Put(slKey, slValue);\n+        size_estimate += 3 + slKey.size() + slValue.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111017596",
      "id" : 111017596,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 25,
      "path" : "src/dbwrapper.h",
      "position" : null,
      "pull_request_review_id" : 32232318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111017596",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111017968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111017968"
         }
      },
      "body" : "> Were you intending to do this after this PR?\r\n\r\nYes, I tried doing it inside the PR, but doing it properly requires a bit more shuffling around and refactoring, which I'd prefer to keep for later.\r\n\r\n> Speaking of which, did you mean to add a PruneBlockIndexCandidates() to ReplayBlocks ala LoadBlockIndexDB?\r\n\r\nReplayBlocks doesn't touch the block index, so I don't think that would have any effect.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T21:28:43Z",
      "diff_hunk" : "@@ -1476,6 +1479,12 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     break;\n                 }\n \n+                if (!ReplayBlocks(chainparams, pcoinsdbview)) {\n+                    strLoadError = _(\"Unable to replay blocks. You will need to rebuild the databse using -reindex.\");\n+                    break;\n+                }\n+                pcoinsTip->SetBestBlock(pcoinsdbview->GetBestBlock()); // TODO: only initialize pcoinsTip after ReplayBlocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111017968",
      "id" : 111017968,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 18,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 32232318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111017968",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111018536"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111018536"
         }
      },
      "body" : "Nice catch, fixed.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T21:31:36Z",
      "diff_hunk" : "@@ -1296,6 +1296,19 @@ void static InvalidBlockFound(CBlockIndex *pindex, const CValidationState &state\n     }\n }\n \n+/** Apply the effects of a block on the utxo cache, ignoring that it may already have been applied. */\n+static void ReplayBlock(const CBlock& block, CCoinsViewCache& inputs, int nHeight)\n+{\n+    for (const CTransactionRef& tx : block.vtx) {\n+        if (!tx->IsCoinBase()) {\n+            for (const CTxIn &txin : tx->vin) {\n+                inputs.ModifyCoins(txin.prevout.hash)->Spend(txin.prevout.n);\n+            }\n+        }\n+        inputs.ModifyNewCoins(tx->GetHash(), tx->IsCoinBase())->FromTx(*tx, nHeight);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111018536",
      "id" : 111018536,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 13,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 32232318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111018536",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111019092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111019092"
         }
      },
      "body" : "I think that would be caught by other code we already have, but I've added it here.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T21:34:07Z",
      "diff_hunk" : "@@ -3681,6 +3694,51 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n     return true;\n }\n \n+bool ReplayBlocks(const CChainParams& params, CCoinsView* view)\n+{\n+    LOCK(cs_main);\n+\n+    CCoinsViewCache cache(view);\n+\n+    uint256 hashBest = view->GetBestBlock();\n+    uint256 hashUpto = view->GetUptoBlock();\n+\n+    if (hashUpto.IsNull() || hashBest == hashUpto) return true;\n+\n+    if (mapBlockIndex.count(hashUpto) == 0) {\n+        return error(\"ReplayBlocks(): chainstate boundaries not in block index\");\n+    }\n+    auto pindexUpto = mapBlockIndex[hashUpto];\n+\n+    int nHeight = 1; // Skip the genesis block\n+    if (mapBlockIndex.count(hashBest)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111019092",
      "id" : 111019092,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 50,
      "path" : "src/validation.cpp",
      "position" : 53,
      "pull_request_review_id" : 32232318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111019092",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111019745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111019745"
         }
      },
      "body" : "Good point, fixed.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T21:37:20Z",
      "diff_hunk" : "@@ -3681,6 +3694,51 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n     return true;\n }\n \n+bool ReplayBlocks(const CChainParams& params, CCoinsView* view)\n+{\n+    LOCK(cs_main);\n+\n+    CCoinsViewCache cache(view);\n+\n+    uint256 hashBest = view->GetBestBlock();\n+    uint256 hashUpto = view->GetUptoBlock();\n+\n+    if (hashUpto.IsNull() || hashBest == hashUpto) return true;\n+\n+    if (mapBlockIndex.count(hashUpto) == 0) {\n+        return error(\"ReplayBlocks(): chainstate boundaries not in block index\");\n+    }\n+    auto pindexUpto = mapBlockIndex[hashUpto];\n+\n+    int nHeight = 1; // Skip the genesis block\n+    if (mapBlockIndex.count(hashBest)) {\n+        auto pindexBest = mapBlockIndex[hashBest];\n+        if (pindexUpto->GetAncestor(pindexBest->nHeight) != pindexBest) {\n+            return error(\"ReplayBlocks(): chainstate tip does not derive from final boundary\");\n+        }\n+        nHeight = std::max(nHeight, pindexBest->nHeight);\n+    }\n+\n+    uiInterface.ShowProgress(_(\"Replaying blocks...\"), 0);\n+    LogPrintf(\"Replaying %i blocks\\n\", pindexUpto->nHeight - nHeight);\n+\n+    while (nHeight < pindexUpto->nHeight) {\n+        ++nHeight;\n+        auto pindex = pindexUpto->GetAncestor(nHeight);\n+        CBlock block;\n+        if (!ReadBlockFromDisk(block, pindex, params.GetConsensus())) {\n+            return error(\"ReplayBlocks(): ReadBlockFromDisk failed at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\n+        }\n+        ReplayBlock(block, cache, pindex->nHeight);\n+    }\n+    cache.SetBestBlock(hashUpto);\n+    chainActive.SetTip(pindexUpto);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111019745",
      "id" : 111019745,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 71,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 32232318,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T21:44:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111019745",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111026186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111026186"
         }
      },
      "body" : "The PruneBlockIndexCandidates in LoadBlockIndexDB uses chainActive.Tip(), so I assumed it may need to be re-run with the new tip (though likely not a bug without it, just a should-do). I'm ok with cleaning this stuff up in a followup PR, but it seems less than ideal as-is right now.",
      "commit_id" : "22bb19a5d6f269098bf29d81add8d5b41ab8d252",
      "created_at" : "2017-04-11T22:12:10Z",
      "diff_hunk" : "@@ -1476,6 +1479,12 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     break;\n                 }\n \n+                if (!ReplayBlocks(chainparams, pcoinsdbview)) {\n+                    strLoadError = _(\"Unable to replay blocks. You will need to rebuild the databse using -reindex.\");\n+                    break;\n+                }\n+                pcoinsTip->SetBestBlock(pcoinsdbview->GetBestBlock()); // TODO: only initialize pcoinsTip after ReplayBlocks",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10148#discussion_r111026186",
      "id" : 111026186,
      "original_commit_id" : "a4ddc70da212715d4182fc6991cafc5befa4b350",
      "original_position" : 18,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 32241433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10148",
      "updated_at" : "2017-04-11T22:12:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/111026186",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
