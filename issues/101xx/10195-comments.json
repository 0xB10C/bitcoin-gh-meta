[
   {
      "body" : "This is awesome.",
      "created_at" : "2017-04-12T18:03:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-293660229",
      "id" : 293660229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-12T18:03:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/293660229",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased on top of new #10148.",
      "created_at" : "2017-04-16T17:43:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-294364323",
      "id" : 294364323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-16T17:43:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/294364323",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased without #10148 at popular request.",
      "created_at" : "2017-04-19T15:35:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-295313204",
      "id" : 295313204,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-19T15:35:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/295313204",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Few overrides needed probably:\r\n```\r\n+./coins.h:200:10: warning: 'BatchWrite' overrides a member function but is not marked 'override' [-Winconsistent-missing-override]\r\n+    bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\r\n+         ^\r\n+./coins.h:178:18: note: overridden virtual function is here\r\n+    virtual bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\r\n+                 ^\r\n+./coins.h:201:23: warning: 'Cursor' overrides a member function but is not marked 'override' [-Winconsistent-missing-override]\r\n+    CCoinsViewCursor *Cursor() const;\r\n+                      ^\r\n+./coins.h:181:31: note: overridden virtual function is here\r\n+    virtual CCoinsViewCursor *Cursor() const;\r\n+                              ^\r\n+2 warnings generated.\r\n```\r\n\r\nAnd few initializations:\r\n\r\n```\r\n+./undo.h:70:23: note: initialize the variable 'count' to silence this warning\r\n+        uint64_t count;\r\n+                      ^\r\n+                       = 0\r\n...\r\n+./coins.h:81:22: note: initialize the variable 'code' to silence this warning\r\n+        uint32_t code;\r\n+                     ^\r\n+                      = 0\r\n```",
      "created_at" : "2017-04-19T16:01:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-295323193",
      "id" : 295323193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-19T16:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/295323193",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10195#discussion_r112495450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10195"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112495450"
         }
      },
      "body" : "Why not just switch to hash_serialized_2?",
      "commit_id" : "8da478ebd71caf0acd307ce0b160f0a93cae68c2",
      "created_at" : "2017-04-20T16:12:02Z",
      "diff_hunk" : "@@ -52,7 +52,6 @@ def _test_gettxoutsetinfo(self):\n         assert_equal(res['txouts'], 200)\n         assert_equal(res['bytes_serialized'], 13924),\n         assert_equal(len(res['bestblock']), 64)\n-        assert_equal(len(res['hash_serialized']), 64)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#discussion_r112495450",
      "id" : 112495450,
      "original_commit_id" : "1aa8b8b8ba8e55ea493cb81ea892dde38c97d33b",
      "original_position" : 4,
      "path" : "test/functional/blockchain.py",
      "position" : null,
      "pull_request_review_id" : 33815611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10195",
      "updated_at" : "2017-04-25T00:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112495450",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10195#discussion_r112499717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10195"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112499717"
         }
      },
      "body" : "Shouldnt the first two be an error and not a \"done upgrading\" result?",
      "commit_id" : "8da478ebd71caf0acd307ce0b160f0a93cae68c2",
      "created_at" : "2017-04-20T16:31:24Z",
      "diff_hunk" : "@@ -242,3 +243,120 @@ bool CBlockTreeDB::LoadBlockIndexGuts(boost::function<CBlockIndex*(const uint256\n \n     return true;\n }\n+\n+namespace {\n+\n+class COldCoins\n+{\n+public:\n+    //! whether transaction is a coinbase\n+    bool fCoinBase;\n+\n+    //! unspent transaction outputs; spent outputs are .IsNull(); spent outputs at the end of the array are dropped\n+    std::vector<CTxOut> vout;\n+\n+    //! at which height this transaction was included in the active block chain\n+    int nHeight;\n+\n+    //! version of the CTransaction; accesses to this value should probably check for nHeight as well,\n+    //! as new tx version will probably only be introduced at certain heights\n+    int nVersion;\n+\n+    //! empty constructor\n+    COldCoins() : fCoinBase(false), vout(0), nHeight(0), nVersion(0) { }\n+\n+    /**\n+     * calculate number of bytes for the bitmask, and its number of non-zero bytes\n+     * each bit in the bitmask represents the availability of one output, but the\n+     * availabilities of the first two outputs are encoded separately\n+     */\n+    void CalcMaskSize(unsigned int &nBytes, unsigned int &nNonzeroBytes) const {\n+        unsigned int nLastUsedByte = 0;\n+        for (unsigned int b = 0; 2+b*8 < vout.size(); b++) {\n+            bool fZero = true;\n+            for (unsigned int i = 0; i < 8 && 2+b*8+i < vout.size(); i++) {\n+                if (!vout[2+b*8+i].IsNull()) {\n+                    fZero = false;\n+                    continue;\n+                }\n+            }\n+            if (!fZero) {\n+                nLastUsedByte = b + 1;\n+                nNonzeroBytes++;\n+            }\n+        }\n+        nBytes += nLastUsedByte;\n+    }\n+\n+    template<typename Stream>\n+    void Unserialize(Stream &s) {\n+        unsigned int nCode = 0;\n+        // version\n+        ::Unserialize(s, VARINT(this->nVersion));\n+        // header code\n+        ::Unserialize(s, VARINT(nCode));\n+        fCoinBase = nCode & 1;\n+        std::vector<bool> vAvail(2, false);\n+        vAvail[0] = (nCode & 2) != 0;\n+        vAvail[1] = (nCode & 4) != 0;\n+        unsigned int nMaskCode = (nCode / 8) + ((nCode & 6) != 0 ? 0 : 1);\n+        // spentness bitmask\n+        while (nMaskCode > 0) {\n+            unsigned char chAvail = 0;\n+            ::Unserialize(s, chAvail);\n+            for (unsigned int p = 0; p < 8; p++) {\n+                bool f = (chAvail & (1 << p)) != 0;\n+                vAvail.push_back(f);\n+            }\n+            if (chAvail != 0)\n+                nMaskCode--;\n+        }\n+        // txouts themself\n+        vout.assign(vAvail.size(), CTxOut());\n+        for (unsigned int i = 0; i < vAvail.size(); i++) {\n+            if (vAvail[i])\n+                ::Unserialize(s, REF(CTxOutCompressor(vout[i])));\n+        }\n+        // coinbase height\n+        ::Unserialize(s, VARINT(nHeight));\n+    }\n+};\n+\n+}\n+\n+void CCoinsViewDB::Upgrade() {\n+    std::unique_ptr<CDBIterator> pcursor(db.NewIterator());\n+    pcursor->Seek(std::make_pair(DB_COINS_OLD, uint256()));\n+    if (!pcursor->Valid()) {\n+        return;\n+    }\n+\n+    LogPrintf(\"Upgrading database...\\n\");\n+    size_t batch_size = 1 << 24;\n+    CDBBatch batch(db);\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        COldCoins oldcoins;\n+        std::pair<unsigned char, uint256> key;\n+        if (pcursor->GetValue(oldcoins) && pcursor->GetKey(key) && key.first == DB_COINS_OLD) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#discussion_r112499717",
      "id" : 112499717,
      "original_commit_id" : "2f28c1c1ecf737870101473f1eb422e1d4219305",
      "original_position" : 107,
      "path" : "src/txdb.cpp",
      "position" : null,
      "pull_request_review_id" : 33815611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10195",
      "updated_at" : "2017-04-25T00:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/112499717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I'm splitting the commits up more. I've pushed one update already, but I'm working splitting the big commit further.",
      "created_at" : "2017-04-22T11:43:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-296367685",
      "id" : 296367685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-22T11:43:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/296367685",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Done. There is still one commit that does many things at once (\"Switch CCoinsView and chainstate db to per-txout\"), but splitting it is nontrivial. If requested, I can try splitting the database format change into a second commit, but that would require adding a bunch of conversion logic in the first commit that just gets removed in the second one. Thoughts?",
      "created_at" : "2017-04-24T21:25:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10195#issuecomment-296826822",
      "id" : 296826822,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10195",
      "updated_at" : "2017-04-24T21:25:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/296826822",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
