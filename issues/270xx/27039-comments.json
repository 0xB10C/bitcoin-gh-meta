[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-02-03T18:50:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#issuecomment-1416266573",
      "id" : 1416266573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27039",
      "node_id" : "IC_kwDOABII585UaoNN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1416266573/reactions"
      },
      "updated_at" : "2023-02-03T18:50:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1416266573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096159709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096159709"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\r\n```",
      "commit_id" : "a8db898add1d1891b00a1e8503b93d15b24a69b9",
      "created_at" : "2023-02-03T18:54:30Z",
      "diff_hunk" : "@@ -68,12 +73,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat');",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096159709",
      "id" : 1096159709,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BVhHd",
      "original_commit_id" : "7a2e5cdc7ff6bd39f925f17b6582ad46f7e4475b",
      "original_line" : 89,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1283552030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096159709/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-03T18:54:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096159709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096165964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096165964"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks! fixed.",
      "commit_id" : "a8db898add1d1891b00a1e8503b93d15b24a69b9",
      "created_at" : "2023-02-03T18:59:31Z",
      "diff_hunk" : "@@ -68,12 +73,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat');",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096165964",
      "id" : 1096165964,
      "in_reply_to_id" : 1096159709,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BVipM",
      "original_commit_id" : "7a2e5cdc7ff6bd39f925f17b6582ad46f7e4475b",
      "original_line" : 89,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1283558671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096165964/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-03T18:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096165964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096269282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096269282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Instead of stopping the node and right after starting it again, you could use `self.restart_node`.",
      "commit_id" : "a8db898add1d1891b00a1e8503b93d15b24a69b9",
      "created_at" : "2023-02-03T20:45:47Z",
      "diff_hunk" : "@@ -19,22 +19,27 @@\n class ReindexTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = True\n-        self.num_nodes = 1\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\"]\n+        ]\n \n     def reindex(self, justchainstate=False):\n         self.generatetoaddress(self.nodes[0], 3, self.nodes[0].get_deterministic_priv_key().address)\n         blockcount = self.nodes[0].getblockcount()\n-        self.stop_nodes()\n-        extra_args = [[\"-reindex-chainstate\" if justchainstate else \"-reindex\"]]\n-        self.start_nodes(extra_args)\n+        self.stop_node(0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096269282",
      "id" : 1096269282,
      "line" : 31,
      "node_id" : "PRRC_kwDOABII585BV73i",
      "original_commit_id" : "a8db898add1d1891b00a1e8503b93d15b24a69b9",
      "original_line" : 31,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 17,
      "pull_request_review_id" : 1283698111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096269282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-03T20:45:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096269282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096290459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096290459"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ah thanks, fixed. also added an explanation of the test to the comments at the top",
      "commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "created_at" : "2023-02-03T21:15:21Z",
      "diff_hunk" : "@@ -19,22 +19,27 @@\n class ReindexTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.setup_clean_chain = True\n-        self.num_nodes = 1\n+        self.num_nodes = 2\n+        self.extra_args = [\n+            [],\n+            [\"-fastprune\"]\n+        ]\n \n     def reindex(self, justchainstate=False):\n         self.generatetoaddress(self.nodes[0], 3, self.nodes[0].get_deterministic_priv_key().address)\n         blockcount = self.nodes[0].getblockcount()\n-        self.stop_nodes()\n-        extra_args = [[\"-reindex-chainstate\" if justchainstate else \"-reindex\"]]\n-        self.start_nodes(extra_args)\n+        self.stop_node(0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096290459",
      "id" : 1096290459,
      "in_reply_to_id" : 1096269282,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BWBCb",
      "original_commit_id" : "a8db898add1d1891b00a1e8503b93d15b24a69b9",
      "original_line" : 31,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1283729146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096290459/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-03T21:15:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096290459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096394295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394295"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Verified:\r\n```\r\n$ ls -l /tmp/btest/node1/regtest/blocks/blk*.dat\r\n-rw------- 1 larry larry 65400 Feb  3 16:58 /tmp/btest/node1/regtest/blocks/blk00000.dat\r\n-rw------- 1 larry larry 16384 Feb  3 16:58 /tmp/btest/node1/regtest/blocks/blk00001.dat\r\n```",
      "commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "created_at" : "2023-02-04T00:03:24Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096394295",
      "id" : 1096394295,
      "line" : 84,
      "node_id" : "PRRC_kwDOABII585BWaY3",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 84,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 54,
      "pull_request_review_id" : 1283917779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394295/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-04T00:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096394699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394699"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Verified:\r\n```\r\n$ ls -l /tmp/btest/node1/regtest/blocks/blk*.dat\r\n-r--r--r-- 1 larry larry 65400 Feb  3 16:58 /tmp/btest/node1/regtest/blocks/blk00000.dat\r\n-rw------- 1 larry larry 16384 Feb  3 16:58 /tmp/btest/node1/regtest/blocks/blk00001.dat\r\n```",
      "commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "created_at" : "2023-02-04T00:04:17Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\n+        os.chmod(path, 0o444)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096394699",
      "id" : 1096394699,
      "line" : 89,
      "node_id" : "PRRC_kwDOABII585BWafL",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 89,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 59,
      "pull_request_review_id" : 1283917779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-04T00:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096394699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096397334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096397334"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Verified that without the PR, the node doesn't start, and we see this in `debug.log`:\r\n```\r\n2023-02-04T00:05:32.219184Z [loadblk] [node/blockstorage.cpp:865] [ThreadImport] Reindexing block file blk00001.dat...\r\n2023-02-04T00:05:32.224307Z [loadblk] [flatfile.cpp:44] [Open] Unable to open file /tmp/btest/node1/regtest/blocks/blk00000.dat\r\n2023-02-04T00:05:32.224320Z [loadblk] [util/system.h:50] [error] ERROR: Flush: failed to open file 0\r\n2023-02-04T00:05:32.224334Z [loadblk] [shutdown.cpp:26] [AbortNode] *** Flushing block file to disk failed. This is likely the result of an I/O error.\r\n```\r\nNothing the PR needs to address, but just FYI, the first message may look confusing; it mentions `blk00001.dat` just before it attempts to write the previous file, `blk00001.dat`, which is where it runs into the write failure. Notice that this write is what the PR prevents because it's unnecessary. This is a nice way to test that the write happens without the PR, and doesn't happen with the PR.",
      "commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "created_at" : "2023-02-04T00:10:39Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\n+        os.chmod(path, 0o444)\n+\n+        # restart and reindex the node with the read-only block file\n+        self.start_node(1, [\"-reindex\", \"-fastprune\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096397334",
      "id" : 1096397334,
      "line" : 92,
      "node_id" : "PRRC_kwDOABII585BWbIW",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 92,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 62,
      "pull_request_review_id" : 1283917779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096397334/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-04T00:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096397334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096403631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096403631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There are many `Flush` log lines for unrelated things (like the ChainState), so consider making that string more specific. Maybe:\r\n```\r\n2023-02-04T00:15:05.877123Z [shutoff] [logging/timer.h:57] [Log] [bench] FlushStateToDisk: write block and undo data to disk completed (6.62ms)\r\n```\r\nSimilarly, maybe \"Error\" is too general? It does work, but I'd be afraid that something unrelated might log \"Error\" in the future and break this test. Maybe look for one of the error strings in my comment above?",
      "commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "created_at" : "2023-02-04T00:24:01Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\n+        os.chmod(path, 0o444)\n+\n+        # restart and reindex the node with the read-only block file\n+        self.start_node(1, [\"-reindex\", \"-fastprune\"])\n+        assert_equal(self.nodes[1].getblockcount(), 312)\n+\n+        # shut down this node, triggering disk flushes, but not to the read-only file\n+        with self.nodes[1].assert_debug_log(expected_msgs=['Flush'], unexpected_msgs=['Error']):\n+            self.stop_node(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096403631",
      "id" : 1096403631,
      "line" : 97,
      "node_id" : "PRRC_kwDOABII585BWcqv",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 97,
      "original_position" : 67,
      "original_start_line" : 96,
      "path" : "test/functional/feature_reindex.py",
      "position" : 67,
      "pull_request_review_id" : 1283917779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096403631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 96,
      "start_side" : "RIGHT",
      "updated_at" : "2023-02-04T00:30:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096403631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096529154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096529154"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good call, I was being too general, updated. thanks!",
      "commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "created_at" : "2023-02-04T12:14:47Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\n+        self.stop_node(1)\n+\n+        # make the first block file read-only\n+        path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\n+        os.chmod(path, 0o444)\n+\n+        # restart and reindex the node with the read-only block file\n+        self.start_node(1, [\"-reindex\", \"-fastprune\"])\n+        assert_equal(self.nodes[1].getblockcount(), 312)\n+\n+        # shut down this node, triggering disk flushes, but not to the read-only file\n+        with self.nodes[1].assert_debug_log(expected_msgs=['Flush'], unexpected_msgs=['Error']):\n+            self.stop_node(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1096529154",
      "id" : 1096529154,
      "in_reply_to_id" : 1096403631,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BW7UC",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 97,
      "original_position" : 67,
      "original_start_line" : 96,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1284062599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096529154/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2023-02-04T12:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1096529154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1099741914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099741914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If you need to retouch, maybe expand this comment to explain why two nodes are needed.",
      "commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "created_at" : "2023-02-08T07:15:46Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n - Stop the node and restart it with -reindex. Verify that the node has reindexed up to block 3.\n - Stop the node and restart it with -reindex-chainstate. Verify that the node has reindexed up to block 3.\n - Verify that out-of-order blocks are correctly processed, see LoadExternalBlockFile()\n+- Start a second node, generate blocks, then restart with -reindex after setting blk files to read-only",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1099741914",
      "id" : 1099741914,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII585BjLra",
      "original_commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "original_line" : 11,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 4,
      "pull_request_review_id" : 1288594338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099741914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T07:16:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1099741914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100332583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100332583"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I added a second node to the test so I could start a clean chain using smaller `blk` files (`-fastprune`) without bugging the existing tests that switch a few options on and off throughout.",
      "commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "created_at" : "2023-02-08T15:46:40Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n - Stop the node and restart it with -reindex. Verify that the node has reindexed up to block 3.\n - Stop the node and restart it with -reindex-chainstate. Verify that the node has reindexed up to block 3.\n - Verify that out-of-order blocks are correctly processed, see LoadExternalBlockFile()\n+- Start a second node, generate blocks, then restart with -reindex after setting blk files to read-only",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100332583",
      "id" : 1100332583,
      "in_reply_to_id" : 1099741914,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII585Blb4n",
      "original_commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "original_line" : 11,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 4,
      "pull_request_review_id" : 1289470489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100332583/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T15:46:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100332583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100517673"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100517673"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "To ensure it, I think you could check if both files exist:\r\n```diff\r\ndiff --git a/test/functional/feature_reindex.py b/test/functional/feature_reindex.py\r\nindex c68773e06..a3c9562f1 100755\r\n--- a/test/functional/feature_reindex.py\r\n+++ b/test/functional/feature_reindex.py\r\n@@ -84,6 +84,9 @@ class ReindexTest(BitcoinTestFramework):\r\n         self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\r\n         self.stop_node(1)\r\n \r\n+        assert os.path.exists(self.nodes[1].chain_path / 'blocks' / 'blk00000.dat')\r\n+        assert os.path.exists(self.nodes[1].chain_path / 'blocks' / 'blk00001.dat')\r\n+\r\n         # make the first block file read-only\r\n         path = os.path.join(self.nodes[1].chain_path, 'blocks', 'blk00000.dat')\r\n         os.chmod(path, 0o444)\r\n```",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-08T18:18:07Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100517673",
      "id" : 1100517673,
      "in_reply_to_id" : 1096394295,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585BmJEp",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 84,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1289745617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100517673/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T18:18:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100517673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100606119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606119"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks, added.",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-08T19:50:04Z",
      "diff_hunk" : "@@ -68,12 +72,32 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100606119",
      "id" : 1100606119,
      "in_reply_to_id" : 1096394295,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Bmeqn",
      "original_commit_id" : "a6b05f8db63bae7eefb5330048d8b1441f1a9e5e",
      "original_line" : 84,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1289900751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T19:50:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100606588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606588"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added comment to top of the test where second node is set up",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-08T19:50:24Z",
      "diff_hunk" : "@@ -8,6 +8,7 @@\n - Stop the node and restart it with -reindex. Verify that the node has reindexed up to block 3.\n - Stop the node and restart it with -reindex-chainstate. Verify that the node has reindexed up to block 3.\n - Verify that out-of-order blocks are correctly processed, see LoadExternalBlockFile()\n+- Start a second node, generate blocks, then restart with -reindex after setting blk files to read-only",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1100606588",
      "id" : 1100606588,
      "in_reply_to_id" : 1099741914,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII585Bmex8",
      "original_commit_id" : "386faaf76ea0edb2150725c5bdb69d234a2f2607",
      "original_line" : 11,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : 4,
      "pull_request_review_id" : 1289901618,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606588/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-08T19:50:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1100606588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112320245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The new test fails on master as expected, because the block file is read-only and can't be written to.\r\n\r\nIt may be reassuring to have coverage for the other side of this change, to be sure we're still flushing when expected.  If this new line is removed and no flushing is done, all the functional and unit tests still pass (I didn't run the extended functional tests).\r\n\r\n```diff\r\n@@ -618,7 +618,6 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\r\n     if ((int)nFile != m_last_blockfile) {\r\n         if (!fKnown) {\r\n             LogPrint(BCLog::BLOCKSTORE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\r\n-            FlushBlockFile(/*fFinalize=*/true, finalize_undo);\r\n         }\r\n         m_last_blockfile = nFile;\r\n     }\r\n```\r\n",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-20T21:09:38Z",
      "diff_hunk" : "@@ -618,8 +618,8 @@ bool BlockManager::FindBlockPos(FlatFilePos& pos, unsigned int nAddSize, unsigne\n     if ((int)nFile != m_last_blockfile) {\n         if (!fKnown) {\n             LogPrint(BCLog::BLOCKSTORE, \"Leaving block file %i: %s\\n\", m_last_blockfile, m_blockfile_info[m_last_blockfile].ToString());\n+            FlushBlockFile(/*fFinalize=*/true, finalize_undo);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112320245",
      "id" : 1112320245,
      "line" : 621,
      "node_id" : "PRRC_kwDOABII585CTKj1",
      "original_commit_id" : "ed57565e36bf514fc4d063972464c9152a08fb8e",
      "original_line" : 621,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 22,
      "pull_request_review_id" : 1306329978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-20T21:32:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112320479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320479"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, fix clang-format since you touch this line\r\n```suggestion\r\n    const bool position_known{dbp != nullptr};\r\n```\r\n\r\nEdit, while touching up nits in the commit, maybe hit this one, too (feel free to ignore):\r\n\r\n```diff\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -566,7 +566,7 @@ void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune)\r\n \r\n static FlatFileSeq BlockFileSeq()\r\n {\r\n-    return FlatFileSeq(gArgs.GetBlocksDirPath(), \"blk\", gArgs.GetBoolArg(\"-fastprune\", false) ? 0x4000 /* 16kb */ : BLOCKFILE_CHUNK_SIZE);\r\n+    return FlatFileSeq(gArgs.GetBlocksDirPath(), \"blk\", gArgs.GetBoolArg(\"-fastprune\", false) ? 0x4000 /* 16KiB */ : BLOCKFILE_CHUNK_SIZE);\r\n }\r\n```\r\n",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-20T21:10:13Z",
      "diff_hunk" : "@@ -803,7 +803,7 @@ FlatFilePos BlockManager::SaveBlockToDisk(const CBlock& block, int nHeight, CCha\n {\n     unsigned int nBlockSize = ::GetSerializeSize(block, CLIENT_VERSION);\n     FlatFilePos blockPos;\n-    const auto position_known {dbp != nullptr};\n+    const bool position_known {dbp != nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112320479",
      "id" : 1112320479,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CTKnf",
      "original_commit_id" : "ed57565e36bf514fc4d063972464c9152a08fb8e",
      "original_line" : 806,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1306329978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-20T22:00:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112320479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112331348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112331348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Adding some logging shows that this `generate` call is the slowest part of the added test. Questions:\r\n\r\n- Why 300 blocks?  On my laptop the test passes reliably with 239 blocks and fails reliably with 238.  Fewer blocks = faster test runs.\r\n\r\n- Can you explain how the number of blocks used was arrived at, and document that calculation along with the other magic numbers?\r\n\r\n<details><summary>Ideas, feel free to pick and choose (maybe some of the suggested logging should be debug instead of info)</summary><p>\r\n\r\n```diff\r\n@@ -29,7 +29,7 @@ class ReindexTest(BitcoinTestFramework):\r\n     def reindex(self, justchainstate=False):\r\n         self.generatetoaddress(self.nodes[0], 3, self.nodes[0].get_deterministic_priv_key().address)\r\n         blockcount = self.nodes[0].getblockcount()\r\n-        self.restart_node(0, [\"-reindex-chainstate\" if justchainstate else \"-reindex\"])\r\n+        self.restart_node(0, extra_args=[\"-reindex-chainstate\" if justchainstate else \"-reindex\"])\r\n         self.connect_nodes(0, 1)\r\n         assert_equal(self.nodes[0].getblockcount(), blockcount)  # start_node is blocking on reindex\r\n         self.log.info(\"Success\")\r\n@@ -72,34 +72,36 @@ class ReindexTest(BitcoinTestFramework):\r\n             'LoadExternalBlockFile: Out of order block',\r\n             'LoadExternalBlockFile: Processing out of order child',\r\n         ]):\r\n-            self.start_node(0, [\"-reindex\"])\r\n+            self.start_node(0, extra_args=[\"-reindex\"])\r\n \r\n         # All blocks should be accepted and processed.\r\n         assert_equal(self.nodes[0].getblockcount(), 12)\r\n \r\n     def reindex_readonly(self):\r\n         self.connect_nodes(0, 1)\r\n-        # generate enough blocks to ensure that the -fastprune node fills up the\r\n-        # first blk00000.dat file and starts another block file\r\n-        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)\r\n+        block_count = self.nodes[1].getblockcount()\r\n+\r\n+        num_blocks_to_add = 239  # document how this is calculated...\r\n+        self.log.info(f\"Generate {num_blocks_to_add} blocks to ensure the -fastprune node fills up the first blk00000.dat file and starts another block file\")\r\n+        self.generatetoaddress(self.nodes[1], num_blocks_to_add, self.nodes[1].get_deterministic_priv_key().address)\r\n         self.stop_node(1)\r\n \r\n         assert os.path.exists(self.nodes[1].chain_path / 'blocks' / 'blk00000.dat')\r\n         assert os.path.exists(self.nodes[1].chain_path / 'blocks' / 'blk00001.dat')\r\n \r\n-        # make the first block file read-only\r\n-        path = self.nodes[1].chain_path / 'blocks' / 'blk00000.dat'\r\n-        os.chmod(path, 0o444)\r\n+        self.log.info(\"Make the first block file read-only\")\r\n+        filename = self.nodes[1].chain_path / 'blocks' / 'blk00000.dat'\r\n+        os.chmod(filename, 0o444)\r\n \r\n-        # restart and reindex the node with the read-only block file\r\n+        self.log.info(\"Restart the node and reindex with the read-only block file\")\r\n         self.start_node(1, [\"-reindex\", \"-fastprune\"])\r\n-        assert_equal(self.nodes[1].getblockcount(), 312)\r\n+        assert_equal(self.nodes[1].getblockcount(), block_count + num_blocks_to_add)\r\n \r\n-        # shut down this node, triggering disk flushes, but not to the read-only file\r\n+        self.log.info(\"Shut down this node, triggering disk flushes, but not to the read-only file\")\r\n         with self.nodes[1].assert_debug_log(expected_msgs=['FlushStateToDisk'], unexpected_msgs=['failed to open file']):\r\n             self.stop_node(1)\r\n \r\n-        self.log.info(\"Reindex read-only Success\")\r\n+        self.log.info(\"Success of reindex read-only test\")\r\n \r\n     def run_test(self):\r\n         self.reindex(False)\r\n```\r\n</p></details>\r\n\r\nEdit, I briefly tried calculating the number of blocks as follows, but it's probably incorrect (and on my system, 6 blocks fewer works).\r\n\r\n<details><summary>diff</summary><p>\r\n\r\n```diff\r\n@@ -11,7 +11,9 @@\r\n - Start a second node, generate blocks, then restart with -reindex after setting blk files to read-only\r\n \"\"\"\r\n \r\n+import math\r\n import os\r\n+\r\n from test_framework.test_framework import BitcoinTestFramework\r\n\r\n...\r\n\r\n     def reindex_readonly(self):\r\n         self.connect_nodes(0, 1)\r\n+        max_block_weight = 4_000_000  # 4 MB\r\n+        fastprune_blockfile_size = 16_384  # 16 KiB\r\n+        num_blocks_to_add = math.ceil(max_block_weight / fastprune_blockfile_size)  # 244.140625 rounded up = 245\r\n ```\r\n</p></details>\r\n",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-20T21:26:03Z",
      "diff_hunk" : "@@ -68,12 +72,35 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1112331348",
      "id" : 1112331348,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CTNRU",
      "original_commit_id" : "ed57565e36bf514fc4d063972464c9152a08fb8e",
      "original_line" : 84,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1306329978,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112331348/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-20T21:45:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1112331348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1114563559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114563559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks Jon I believe I addressed all the style nits and reduced the number of generated blocks as requested in e7a0339b8c. Adding test coverage for flush to disk is next...",
      "commit_id" : "e7a0339b8cb612088ca212c568c0499c0f02398b",
      "created_at" : "2023-02-22T16:06:20Z",
      "diff_hunk" : "@@ -68,12 +72,35 @@ def find_block(b, start):\n             'LoadExternalBlockFile: Out of order block',\n             'LoadExternalBlockFile: Processing out of order child',\n         ]):\n-            extra_args = [[\"-reindex\"]]\n-            self.start_nodes(extra_args)\n+            self.start_node(0, [\"-reindex\"])\n \n         # All blocks should be accepted and processed.\n         assert_equal(self.nodes[0].getblockcount(), 12)\n \n+    def reindex_readonly(self):\n+        self.connect_nodes(0, 1)\n+        # generate enough blocks to ensure that the -fastprune node fills up the\n+        # first blk00000.dat file and starts another block file\n+        self.generatetoaddress(self.nodes[1], 300, self.nodes[1].get_deterministic_priv_key().address)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27039#discussion_r1114563559",
      "id" : 1114563559,
      "in_reply_to_id" : 1112331348,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CbuPn",
      "original_commit_id" : "ed57565e36bf514fc4d063972464c9152a08fb8e",
      "original_line" : 84,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/feature_reindex.py",
      "position" : null,
      "pull_request_review_id" : 1309595387,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27039",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114563559/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T16:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114563559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   }
]
