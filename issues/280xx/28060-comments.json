[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-07-10T10:39:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#issuecomment-1628685701",
      "id" : 1628685701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28060",
      "node_id" : "IC_kwDOABII585hE8WF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628685701/reactions"
      },
      "updated_at" : "2023-07-10T10:39:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628685701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260227191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa2276355889ff7bcad95aa978863107c36a89f7\r\n\r\nMinor: new function is called `detail_fread` but commit and commit message mention `detail_read`.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:08:59Z",
      "diff_hunk" : "@@ -526,14 +528,16 @@ class AutoFile\n      */\n     bool IsNull() const         { return (file == nullptr); }\n \n+    /** Implementation detail, only used internally. */\n+    std::size_t detail_fread(Span<std::byte> dst);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260227191",
      "id" : 1260227191,
      "line" : 592,
      "node_id" : "PRRC_kwDOABII585LHYp3",
      "original_commit_id" : "fa2276355889ff7bcad95aa978863107c36a89f7",
      "original_line" : 532,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 144,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260249626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nShould these serialization methods have similar `if (!m_file)` guards as `AutoFile` does?",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:31:35Z",
      "diff_hunk" : "@@ -477,6 +477,66 @@ class BitStreamWriter\n     }\n };\n \n+/**\n+ * Like an AutoFile whose data is XOR'd.\n+ */\n+class XorFile\n+{\n+private:\n+    std::FILE* m_file;\n+    const int m_version;\n+    const std::vector<std::byte> m_xor;\n+\n+public:\n+    //\n+    // AutoFile subset\n+    //\n+    explicit XorFile(std::FILE* file, int ver, std::vector<std::byte> data_xor)\n+        : m_file{file},\n+          m_version{ver},\n+          m_xor{std::move(data_xor)} {}\n+    ~XorFile() { fclose(); }\n+    XorFile(const XorFile&) = delete;\n+    XorFile& operator=(const XorFile&) = delete;\n+    int GetVersion() const { return m_version; }\n+    bool feof() const { return std::feof(m_file); }\n+    int fclose()\n+    {\n+        if (std::FILE * file{release()}) return std::fclose(file);\n+        return 0;\n+    }\n+    std::FILE* release()\n+    {\n+        std::FILE* ret = m_file;\n+        m_file = nullptr;\n+        return ret;\n+    }\n+    std::FILE* Get() const { return m_file; }\n+    bool IsNull() const { return m_file == nullptr; }\n+    std::size_t detail_fread(Span<std::byte> dst);\n+\n+    //\n+    // Stream subset\n+    //\n+    void read(Span<std::byte> dst);\n+    void ignore(size_t num_bytes);\n+    void write(Span<const std::byte> src);\n+\n+    template <typename T>\n+    XorFile& operator<<(const T& obj)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260249626",
      "id" : 1260249626,
      "line" : 527,
      "node_id" : "PRRC_kwDOABII585LHeIa",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 527,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 115,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260252291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nWhy not throw a `std::ios_base::failure()` here? From what I can tell, we'd never expect to get back a negative error value.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:34:34Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260252291",
      "id" : 1260252291,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII585LHeyD",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 14,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : 14,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nMight be interesting to see how statically allocating a buffer (say, as a member of `XorFile`) and reusing it might affect performance; may avoid some reallocations. Not sure how frequently this is actually called though. I expect this probably won't make a difference though, because I guess `XorFile::write()` will be called on the order of once per block.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:43:54Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;\n+    std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+    util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+    return ret;\n+}\n+\n+void XorFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure{feof() ? \"XorFile::read: end of file\" : \"XorFile::read: failed\"};\n+    }\n+}\n+\n+void XorFile::ignore(size_t num_bytes)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::ignore: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;\n+    while (num_bytes > 0) {\n+        auto buf_now{Span{buf}.first(std::min<size_t>(num_bytes, buf.size()))};\n+        if (std::fread(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n+            throw std::ios_base::failure{feof() ? \"XorFile::ignore: end of file\" : \"XorFile::ignore: failed\"};\n+        }\n+        num_bytes -= buf_now.size();\n+    }\n+}\n+\n+void XorFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::write: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590",
      "id" : 1260260590,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585LHgzu",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 43,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : 43,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
