[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-07-10T10:39:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#issuecomment-1628685701",
      "id" : 1628685701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28060",
      "node_id" : "IC_kwDOABII585hE8WF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628685701/reactions"
      },
      "updated_at" : "2023-07-10T10:39:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1628685701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260227191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa2276355889ff7bcad95aa978863107c36a89f7\r\n\r\nMinor: new function is called `detail_fread` but commit and commit message mention `detail_read`.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:08:59Z",
      "diff_hunk" : "@@ -526,14 +528,16 @@ class AutoFile\n      */\n     bool IsNull() const         { return (file == nullptr); }\n \n+    /** Implementation detail, only used internally. */\n+    std::size_t detail_fread(Span<std::byte> dst);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260227191",
      "id" : 1260227191,
      "line" : 592,
      "node_id" : "PRRC_kwDOABII585LHYp3",
      "original_commit_id" : "fa2276355889ff7bcad95aa978863107c36a89f7",
      "original_line" : 532,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 144,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260227191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260249626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nShould these serialization methods have similar `if (!m_file)` guards as `AutoFile` does?",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:31:35Z",
      "diff_hunk" : "@@ -477,6 +477,66 @@ class BitStreamWriter\n     }\n };\n \n+/**\n+ * Like an AutoFile whose data is XOR'd.\n+ */\n+class XorFile\n+{\n+private:\n+    std::FILE* m_file;\n+    const int m_version;\n+    const std::vector<std::byte> m_xor;\n+\n+public:\n+    //\n+    // AutoFile subset\n+    //\n+    explicit XorFile(std::FILE* file, int ver, std::vector<std::byte> data_xor)\n+        : m_file{file},\n+          m_version{ver},\n+          m_xor{std::move(data_xor)} {}\n+    ~XorFile() { fclose(); }\n+    XorFile(const XorFile&) = delete;\n+    XorFile& operator=(const XorFile&) = delete;\n+    int GetVersion() const { return m_version; }\n+    bool feof() const { return std::feof(m_file); }\n+    int fclose()\n+    {\n+        if (std::FILE * file{release()}) return std::fclose(file);\n+        return 0;\n+    }\n+    std::FILE* release()\n+    {\n+        std::FILE* ret = m_file;\n+        m_file = nullptr;\n+        return ret;\n+    }\n+    std::FILE* Get() const { return m_file; }\n+    bool IsNull() const { return m_file == nullptr; }\n+    std::size_t detail_fread(Span<std::byte> dst);\n+\n+    //\n+    // Stream subset\n+    //\n+    void read(Span<std::byte> dst);\n+    void ignore(size_t num_bytes);\n+    void write(Span<const std::byte> src);\n+\n+    template <typename T>\n+    XorFile& operator<<(const T& obj)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260249626",
      "id" : 1260249626,
      "line" : 527,
      "node_id" : "PRRC_kwDOABII585LHeIa",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 527,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 115,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260249626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260252291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nWhy not throw a `std::ios_base::failure()` here? From what I can tell, we'd never expect to get back a negative error value.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:34:34Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260252291",
      "id" : 1260252291,
      "line" : 14,
      "node_id" : "PRRC_kwDOABII585LHeyD",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 14,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : 14,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260252291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d\r\n\r\nMight be interesting to see how statically allocating a buffer (say, as a member of `XorFile`) and reusing it might affect performance; may avoid some reallocations. Not sure how frequently this is actually called though. I expect this probably won't make a difference though, because I guess `XorFile::write()` will be called on the order of once per block.",
      "commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "created_at" : "2023-07-11T20:43:54Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;\n+    std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+    util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+    return ret;\n+}\n+\n+void XorFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure{feof() ? \"XorFile::read: end of file\" : \"XorFile::read: failed\"};\n+    }\n+}\n+\n+void XorFile::ignore(size_t num_bytes)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::ignore: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;\n+    while (num_bytes > 0) {\n+        auto buf_now{Span{buf}.first(std::min<size_t>(num_bytes, buf.size()))};\n+        if (std::fread(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n+            throw std::ios_base::failure{feof() ? \"XorFile::ignore: end of file\" : \"XorFile::ignore: failed\"};\n+        }\n+        num_bytes -= buf_now.size();\n+    }\n+}\n+\n+void XorFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::write: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260260590",
      "id" : 1260260590,
      "line" : 43,
      "node_id" : "PRRC_kwDOABII585LHgzu",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 43,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : 43,
      "pull_request_review_id" : 1525080853,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-11T20:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260260590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260766631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260766631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed commit message",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T08:01:30Z",
      "diff_hunk" : "@@ -526,14 +528,16 @@ class AutoFile\n      */\n     bool IsNull() const         { return (file == nullptr); }\n \n+    /** Implementation detail, only used internally. */\n+    std::size_t detail_fread(Span<std::byte> dst);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260766631",
      "id" : 1260766631,
      "in_reply_to_id" : 1260227191,
      "line" : 526,
      "node_id" : "PRRC_kwDOABII585LJcWn",
      "original_commit_id" : "fa2276355889ff7bcad95aa978863107c36a89f7",
      "original_line" : 526,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : 175,
      "pull_request_review_id" : 1525751236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260766631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T08:01:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260766631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260767429"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260767429"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd say no, so I went ahead and removed them everywhere. Refer to the commit message for rationale.",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T08:02:08Z",
      "diff_hunk" : "@@ -477,6 +477,66 @@ class BitStreamWriter\n     }\n };\n \n+/**\n+ * Like an AutoFile whose data is XOR'd.\n+ */\n+class XorFile\n+{\n+private:\n+    std::FILE* m_file;\n+    const int m_version;\n+    const std::vector<std::byte> m_xor;\n+\n+public:\n+    //\n+    // AutoFile subset\n+    //\n+    explicit XorFile(std::FILE* file, int ver, std::vector<std::byte> data_xor)\n+        : m_file{file},\n+          m_version{ver},\n+          m_xor{std::move(data_xor)} {}\n+    ~XorFile() { fclose(); }\n+    XorFile(const XorFile&) = delete;\n+    XorFile& operator=(const XorFile&) = delete;\n+    int GetVersion() const { return m_version; }\n+    bool feof() const { return std::feof(m_file); }\n+    int fclose()\n+    {\n+        if (std::FILE * file{release()}) return std::fclose(file);\n+        return 0;\n+    }\n+    std::FILE* release()\n+    {\n+        std::FILE* ret = m_file;\n+        m_file = nullptr;\n+        return ret;\n+    }\n+    std::FILE* Get() const { return m_file; }\n+    bool IsNull() const { return m_file == nullptr; }\n+    std::size_t detail_fread(Span<std::byte> dst);\n+\n+    //\n+    // Stream subset\n+    //\n+    void read(Span<std::byte> dst);\n+    void ignore(size_t num_bytes);\n+    void write(Span<const std::byte> src);\n+\n+    template <typename T>\n+    XorFile& operator<<(const T& obj)\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260767429",
      "id" : 1260767429,
      "in_reply_to_id" : 1260249626,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LJcjF",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 527,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 1525752349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260767429/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T08:02:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260767429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260770110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260770110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No idea, but my blind guess would be that calling `std::fwrite` takes longer than anything else in this function. :thinking: ",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T08:04:22Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;\n+    std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+    util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+    return ret;\n+}\n+\n+void XorFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure{feof() ? \"XorFile::read: end of file\" : \"XorFile::read: failed\"};\n+    }\n+}\n+\n+void XorFile::ignore(size_t num_bytes)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::ignore: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;\n+    while (num_bytes > 0) {\n+        auto buf_now{Span{buf}.first(std::min<size_t>(num_bytes, buf.size()))};\n+        if (std::fread(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n+            throw std::ios_base::failure{feof() ? \"XorFile::ignore: end of file\" : \"XorFile::ignore: failed\"};\n+        }\n+        num_bytes -= buf_now.size();\n+    }\n+}\n+\n+void XorFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::write: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1260770110",
      "id" : 1260770110,
      "in_reply_to_id" : 1260260590,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LJdM-",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 43,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : null,
      "pull_request_review_id" : 1525756169,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260770110/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T08:04:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1260770110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261190985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261190985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, looks like you are right. Thanks, done.",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T13:35:06Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261190985",
      "id" : 1261190985,
      "in_reply_to_id" : 1260252291,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LLD9J",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 17,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : null,
      "pull_request_review_id" : 1526380289,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261190985/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T13:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261190985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261559740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261559740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This reads to me like a multiplication between `std::FILE` and `rel`.\r\n\r\nHow about `if (auto rel{release()}) return std::fclose(rel);` ?",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T18:14:06Z",
      "diff_hunk" : "@@ -480,73 +480,74 @@ class BitStreamWriter\n class AutoFile\n {\n protected:\n-    FILE* file;\n+    std::FILE* m_file;\n \n public:\n-    explicit AutoFile(FILE* filenew) : file{filenew} {}\n+    explicit AutoFile(std::FILE* file) : m_file{file} {}\n \n-    ~AutoFile()\n-    {\n-        fclose();\n-    }\n+    ~AutoFile() { fclose(); }\n \n     // Disallow copies\n     AutoFile(const AutoFile&) = delete;\n     AutoFile& operator=(const AutoFile&) = delete;\n \n+    bool feof() const { return std::feof(m_file); }\n+\n     int fclose()\n     {\n-        int retval{0};\n-        if (file) {\n-            retval = ::fclose(file);\n-            file = nullptr;\n-        }\n-        return retval;\n+        if (std::FILE * rel{release()}) return std::fclose(rel);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261559740",
      "id" : 1261559740,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LMd-8",
      "original_commit_id" : "faa0ab757de28411a0ccf480b78f29a7639ef37c",
      "original_line" : 498,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 1526966730,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261559740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T18:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261559740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261583878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261583878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, it is a clang-format-16 bug. Someone should try to fix or report it.",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-12T18:32:41Z",
      "diff_hunk" : "@@ -480,73 +480,74 @@ class BitStreamWriter\n class AutoFile\n {\n protected:\n-    FILE* file;\n+    std::FILE* m_file;\n \n public:\n-    explicit AutoFile(FILE* filenew) : file{filenew} {}\n+    explicit AutoFile(std::FILE* file) : m_file{file} {}\n \n-    ~AutoFile()\n-    {\n-        fclose();\n-    }\n+    ~AutoFile() { fclose(); }\n \n     // Disallow copies\n     AutoFile(const AutoFile&) = delete;\n     AutoFile& operator=(const AutoFile&) = delete;\n \n+    bool feof() const { return std::feof(m_file); }\n+\n     int fclose()\n     {\n-        int retval{0};\n-        if (file) {\n-            retval = ::fclose(file);\n-            file = nullptr;\n-        }\n-        return retval;\n+        if (std::FILE * rel{release()}) return std::fclose(rel);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1261583878",
      "id" : 1261583878,
      "in_reply_to_id" : 1261559740,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LMj4G",
      "original_commit_id" : "faa0ab757de28411a0ccf480b78f29a7639ef37c",
      "original_line" : 498,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 1527017124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261583878/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-12T18:32:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1261583878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1262340617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1262340617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(See https://github.com/llvm/llvm-project/commit/104cd749f5cca609a79303c0dad22bc041b5448a )\r\n\r\nSwitched to `auto` in any case.",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-13T10:10:49Z",
      "diff_hunk" : "@@ -480,73 +480,74 @@ class BitStreamWriter\n class AutoFile\n {\n protected:\n-    FILE* file;\n+    std::FILE* m_file;\n \n public:\n-    explicit AutoFile(FILE* filenew) : file{filenew} {}\n+    explicit AutoFile(std::FILE* file) : m_file{file} {}\n \n-    ~AutoFile()\n-    {\n-        fclose();\n-    }\n+    ~AutoFile() { fclose(); }\n \n     // Disallow copies\n     AutoFile(const AutoFile&) = delete;\n     AutoFile& operator=(const AutoFile&) = delete;\n \n+    bool feof() const { return std::feof(m_file); }\n+\n     int fclose()\n     {\n-        int retval{0};\n-        if (file) {\n-            retval = ::fclose(file);\n-            file = nullptr;\n-        }\n-        return retval;\n+        if (std::FILE * rel{release()}) return std::fclose(rel);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1262340617",
      "id" : 1262340617,
      "in_reply_to_id" : 1261559740,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LPcoJ",
      "original_commit_id" : "faa0ab757de28411a0ccf480b78f29a7639ef37c",
      "original_line" : 498,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/streams.h",
      "position" : null,
      "pull_request_review_id" : 1528094689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1262340617/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-13T10:10:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1262340617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267299659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267299659"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't run benchmarks against statically allocating a buffer, but it may be useful since `AutoFile::write` is called many times per block. Basically every time the pattern `CAutoFile << x` is used which happens for every element of the block header, each transaction input, output, etc. I also ran a small unit test through `perf` where there were many writes and found that `std::ftell` dominated with `std::fwrite` close behind.",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-18T20:57:59Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;\n+    std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+    util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+    return ret;\n+}\n+\n+void XorFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure{feof() ? \"XorFile::read: end of file\" : \"XorFile::read: failed\"};\n+    }\n+}\n+\n+void XorFile::ignore(size_t num_bytes)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::ignore: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;\n+    while (num_bytes > 0) {\n+        auto buf_now{Span{buf}.first(std::min<size_t>(num_bytes, buf.size()))};\n+        if (std::fread(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n+            throw std::ios_base::failure{feof() ? \"XorFile::ignore: end of file\" : \"XorFile::ignore: failed\"};\n+        }\n+        num_bytes -= buf_now.size();\n+    }\n+}\n+\n+void XorFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::write: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267299659",
      "id" : 1267299659,
      "in_reply_to_id" : 1260260590,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LiXVL",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 43,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : null,
      "pull_request_review_id" : 1535895567,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267299659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T20:57:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267299659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267302191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267302191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It may be good to have a heat-map  (Percent of time spent in each line) for this function for IBD, or a unit test that writes a block. ",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-18T21:01:18Z",
      "diff_hunk" : "@@ -5,6 +5,54 @@\n #include <span.h>\n #include <streams.h>\n \n+#include <array>\n+\n+std::size_t XorFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::read: file handle is nullptr\");\n+    const auto init_pos{std::ftell(m_file)};\n+    if (init_pos < 0) return 0;\n+    std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+    util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+    return ret;\n+}\n+\n+void XorFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure{feof() ? \"XorFile::read: end of file\" : \"XorFile::read: failed\"};\n+    }\n+}\n+\n+void XorFile::ignore(size_t num_bytes)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::ignore: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;\n+    while (num_bytes > 0) {\n+        auto buf_now{Span{buf}.first(std::min<size_t>(num_bytes, buf.size()))};\n+        if (std::fread(buf_now.data(), 1, buf_now.size(), m_file) != buf_now.size()) {\n+            throw std::ios_base::failure{feof() ? \"XorFile::ignore: end of file\" : \"XorFile::ignore: failed\"};\n+        }\n+        num_bytes -= buf_now.size();\n+    }\n+}\n+\n+void XorFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"XorFile::write: file handle is nullptr\");\n+    std::array<std::byte, 4096> buf;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267302191",
      "id" : 1267302191,
      "in_reply_to_id" : 1260260590,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585LiX8v",
      "original_commit_id" : "fa9325a14584be1c5aa6b4cdefbdaa69b27e402d",
      "original_line" : 43,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : null,
      "pull_request_review_id" : 1535899632,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267302191/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T21:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267302191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267304093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267304093"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I _think_ you can move this `std::ftell` to right before the loop and then use the result from `std::fwrite` to increment `current_pos` each loop iteration since from https://en.cppreference.com/w/cpp/io/c/fwrite: \"The file position indicator for the stream is advanced by the number of characters written.\".  I ran some tests and it gives a performance improvement if `src.size()` is ever > 4096 bytes (though I'm not sure that is ever the case currently with block serialization hitting this function incrementally?)",
      "commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "created_at" : "2023-07-18T21:03:45Z",
      "diff_hunk" : "@@ -0,0 +1,64 @@\n+// Copyright (c) 2009-present The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or https://opensource.org/license/mit/.\n+\n+#include <span.h>\n+#include <streams.h>\n+\n+#include <array>\n+\n+std::size_t AutoFile::detail_fread(Span<std::byte> dst)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"AutoFile::read: file handle is nullptr\");\n+    if (m_xor.empty()) {\n+        return std::fread(dst.data(), 1, dst.size(), m_file);\n+    } else {\n+        const auto init_pos{std::ftell(m_file)};\n+        if (init_pos < 0) throw std::ios_base::failure(\"AutoFile::read: ftell failed\");\n+        std::size_t ret{std::fread(dst.data(), 1, dst.size(), m_file)};\n+        util::Xor(dst.subspan(0, ret), m_xor, init_pos);\n+        return ret;\n+    }\n+}\n+\n+void AutoFile::read(Span<std::byte> dst)\n+{\n+    if (detail_fread(dst) != dst.size()) {\n+        throw std::ios_base::failure(feof() ? \"AutoFile::read: end of file\" : \"AutoFile::read: fread failed\");\n+    }\n+}\n+\n+void AutoFile::ignore(size_t nSize)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"AutoFile::ignore: file handle is nullptr\");\n+    unsigned char data[4096];\n+    while (nSize > 0) {\n+        size_t nNow = std::min<size_t>(nSize, sizeof(data));\n+        if (std::fread(data, 1, nNow, m_file) != nNow) {\n+            throw std::ios_base::failure(feof() ? \"AutoFile::ignore: end of file\" : \"AutoFile::ignore: fread failed\");\n+        }\n+        nSize -= nNow;\n+    }\n+}\n+\n+void AutoFile::write(Span<const std::byte> src)\n+{\n+    if (!m_file) throw std::ios_base::failure(\"AutoFile::write: file handle is nullptr\");\n+    if (m_xor.empty()) {\n+        if (std::fwrite(src.data(), 1, src.size(), m_file) != src.size()) {\n+            throw std::ios_base::failure(\"AutoFile::write: write failed\");\n+        }\n+    } else {\n+        std::array<std::byte, 4096> buf;\n+        while (src.size() > 0) {\n+            auto buf_now{Span{buf}.first(std::min<size_t>(src.size(), buf.size()))};\n+            std::copy(src.begin(), src.begin() + buf_now.size(), buf_now.begin());\n+            const auto current_pos{std::ftell(m_file)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28060#discussion_r1267304093",
      "id" : 1267304093,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII585LiYad",
      "original_commit_id" : "faebf00dbfaa5f0660527b67463320ab625c3d41",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/streams.cpp",
      "position" : 56,
      "pull_request_review_id" : 1535902756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28060",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267304093/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-18T21:03:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1267304093",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   }
]
