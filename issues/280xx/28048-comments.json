[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [theuni](https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1625907483), [TheCharlatan](https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1626127733) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (bugfix: Make `CCheckQueue` RAII-styled by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-07-07T17:03:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1625697201",
      "id" : 1625697201,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28048",
      "node_id" : "IC_kwDOABII585g5iux",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625697201/reactions"
      },
      "updated_at" : "2023-07-07T21:12:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625697201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated 828af9ad19a702e711963f9b498f7462bde8aabb -> c2bcc339d7b8def58289d3ff01b2a905dc291ed6 ([`pr/stopafter.1`](https://github.com/ryanofsky/bitcoin/commits/pr/stopafter.1) -> [`pr/stopafter.2`](https://github.com/ryanofsky/bitcoin/commits/pr/stopafter.2), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/stopafter.1..pr/stopafter.2)) just updating comments and adding release note about `-stopatheight` behavior",
      "created_at" : "2023-07-07T18:07:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1625782988",
      "id" : 1625782988,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28048",
      "node_id" : "IC_kwDOABII585g53rM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625782988/reactions"
      },
      "updated_at" : "2023-07-07T18:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625782988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Very nice. Concept ACK and quick (very shallow) codereview ACK.\r\n\r\nI think the `-stopatheight` change is reasonable. If it turns out anyone/anything was relying on the way this worked before, we could always add functionality for that use-case (maybe `-stopatblock`?)\r\n\r\nHowever, the help string should be updated from:\r\n\r\n> Stop running after reaching the given height in the main chain\r\n\r\nIt sounds like it's not completely accurate now, and less so after this change :)",
      "created_at" : "2023-07-07T19:01:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1625907483",
      "id" : 1625907483,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28048",
      "node_id" : "IC_kwDOABII585g6WEb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625907483/reactions"
      },
      "updated_at" : "2023-07-07T19:01:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1625907483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28048#discussion_r1256350258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350258"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it possible for this to be called twice?\r\n```c++\r\nif (m_stop_at_height) {\r\n  if (index.nHeight > m_stop_at_height) {\r\n    // assert(false) or return kernel::Interrupted{} ?\r\n  } else if (index.nHeight == m_stop_at_height) {\r\n  ..\r\n  }\r\n}\r\n```\r\n\r\nNot that I imagine calling `StartShutdown()` twice would be particularly harmful anyway.",
      "commit_id" : "c2bcc339d7b8def58289d3ff01b2a905dc291ed6",
      "created_at" : "2023-07-07T19:24:18Z",
      "diff_hunk" : "@@ -57,9 +58,23 @@ static void DoWarning(const bilingual_str& warning)\n \n namespace node {\n \n-void KernelNotifications::blockTip(SynchronizationState state, CBlockIndex& index)\n+kernel::InterruptResult KernelNotifications::blocksImported()\n+{\n+    if (m_stop_after_block_import) {\n+        StartShutdown();\n+        return kernel::Interrupted{};\n+    }\n+    return {};\n+}\n+\n+kernel::InterruptResult KernelNotifications::blockTip(SynchronizationState state, CBlockIndex& index)\n {\n     uiInterface.NotifyBlockTip(state, &index);\n+    if (m_stop_at_height && index.nHeight >= m_stop_at_height) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#discussion_r1256350258",
      "id" : 1256350258,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585K4mIy",
      "original_commit_id" : "c2bcc339d7b8def58289d3ff01b2a905dc291ed6",
      "original_line" : 73,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/kernel_notifications.cpp",
      "position" : 25,
      "pull_request_review_id" : 1519644020,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28048",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350258/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T19:24:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256350258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/28048#discussion_r1256406548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28048"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256406548"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/28048#discussion_r1256350258\r\n\r\nI don't think StartShutdown() can be called twice, but it should be ok if that did happen, like you say.\r\n\r\nChecking `index.nHeight > m_stop_at_height` wouldn't be a good way to detect two shutdown calls, though, because that condition can also happen if they the node is restarted with a lower `-stopatheight` value (because the implementation only stops when new blocks are added, and doesn't make any attempt to rewind)",
      "commit_id" : "09938a41d904c05b4676b064da9baa85e53e3e6f",
      "created_at" : "2023-07-07T20:09:08Z",
      "diff_hunk" : "@@ -57,9 +58,23 @@ static void DoWarning(const bilingual_str& warning)\n \n namespace node {\n \n-void KernelNotifications::blockTip(SynchronizationState state, CBlockIndex& index)\n+kernel::InterruptResult KernelNotifications::blocksImported()\n+{\n+    if (m_stop_after_block_import) {\n+        StartShutdown();\n+        return kernel::Interrupted{};\n+    }\n+    return {};\n+}\n+\n+kernel::InterruptResult KernelNotifications::blockTip(SynchronizationState state, CBlockIndex& index)\n {\n     uiInterface.NotifyBlockTip(state, &index);\n+    if (m_stop_at_height && index.nHeight >= m_stop_at_height) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#discussion_r1256406548",
      "id" : 1256406548,
      "in_reply_to_id" : 1256350258,
      "line" : 73,
      "node_id" : "PRRC_kwDOABII585K4z4U",
      "original_commit_id" : "c2bcc339d7b8def58289d3ff01b2a905dc291ed6",
      "original_line" : 73,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/kernel_notifications.cpp",
      "position" : 25,
      "pull_request_review_id" : 1519716758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/28048",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256406548/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-07-07T21:48:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1256406548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Strong Concept ACK :)\r\n\r\nI'm glad you changed your mind on returning things from the notifications, putting the infrastructure in place to allow the code to now bubble a `-stopatheight` interrupt is a clear advantage to me.\r\n\r\nI was about to open a similar PR, albeit with a different approach for handling `-stopafterblockimport` ([patch](https://github.com/TheCharlatan/bitcoin/commit/1107a234838d7a3999dbf236c8a7e4e00d48f289)). Instead of creating a new notification for it, I thought slightly refactoring the function to instead return when the block import is done and then allow the user of the kernel (in this case the init code) to decide what to do is easier to reason with. This has the added benefit that users of the kernel can now just call `BlockImport` without having to rely on options and notification handlers to skip loading the mempool. Can you comment on this approach?\r\n\r\n",
      "created_at" : "2023-07-07T21:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28048#issuecomment-1626127733",
      "id" : 1626127733,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28048",
      "node_id" : "IC_kwDOABII585g7L11",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1626127733/reactions"
      },
      "updated_at" : "2023-07-07T21:13:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1626127733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   }
]
