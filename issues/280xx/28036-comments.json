[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/28036#pullrequestreview-1516637883), [ajtowns](https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623825136), [mzumsande](https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623848833) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-07-06T12:20:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623585357",
      "id" : 1623585357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gxfJN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623585357/reactions"
      },
      "updated_at" : "2023-07-06T15:07:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623585357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thx, edited OP",
      "created_at" : "2023-07-06T14:08:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623750494",
      "id" : 1623750494,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyHde",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623750494/reactions"
      },
      "updated_at" : "2023-07-06T14:08:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623750494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Little note: I think that the only downside here with respect to increasing the timeout to a much higher number or #28026 is that the tests could run forever if the index `m_synced` flag is never set by the thread. I'm not sure how the CI will behave in this scenario, guess that we will realize that something like this happened just by reading the last executed test name.",
      "created_at" : "2023-07-06T14:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623765081",
      "id" : 1623765081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyLBZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623765081/reactions"
      },
      "updated_at" : "2023-07-06T14:23:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623765081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We've been plagued by intermittent timeouts locally (for months/years) and now in CI (for days), but never a thread that never finished. So I think it should be evident that this or #https://github.com/bitcoin/bitcoin/pull/28026 should be preferred. After all, it is no different than any other deadlock or infinite loop anywhere else in the code. ",
      "created_at" : "2023-07-06T14:25:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623778841",
      "id" : 1623778841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyOYZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623778841/reactions"
      },
      "updated_at" : "2023-07-06T14:25:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623778841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Actually, it is not when the thread never finishes. The thread could have finished, but never set the `m_synced` flag to true. Which would make `BlockUntilSyncedToCurrentChain` never return true. Which could happen on all the index sync errors.",
      "created_at" : "2023-07-06T14:46:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623813703",
      "id" : 1623813703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyW5H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623813703/reactions"
      },
      "updated_at" : "2023-07-06T14:51:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623813703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK fabed7eb796637c02e3677ebbe183d90b258ba69\r\n\r\nCould also restore the original behaviour by doing something like:\r\n\r\n```c++\r\nvoid IndexWaitSynced(BaseIndex& index, std::chrono::microseconds timeout)\r\n{\r\n    const auto end = SteadyClock::now() + timeout;\r\n    while (!index.BlockUntilSyncedToCurrentChain()) {\r\n        Assert(timeout <= 0s || SteadyClock::now < end);\r\n        UninterruptibleSleep(100ms);\r\n    }\r\n}\r\n```\r\n\r\nand calling `IndexWaitSynced(index, 10s)` normally, but `IndexWaitSynced(index, -1s)` for coinstatsindex.",
      "created_at" : "2023-07-06T14:53:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623825136",
      "id" : 1623825136,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyZrw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623825136/reactions"
      },
      "updated_at" : "2023-07-06T14:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623825136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK fabed7eb796637c02e3677ebbe183d90b258ba69\r\n\r\nas per https://github.com/bitcoin/bitcoin/pull/28026#pullrequestreview-1514862606 I like this approach more than running the sync synchronously.\r\n\r\n> Could also restore the original behaviour by doing something like:\r\n\r\nThe problem in the first place was that that the tests for txindex and blockfilterindex would have rare intermittent timeouts. So instead of making guesses about the slowest environment the tests could be run in I think it's ok to just have no timeout.",
      "created_at" : "2023-07-06T15:07:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623848833",
      "id" : 1623848833,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyfeB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623848833/reactions"
      },
      "updated_at" : "2023-07-06T15:07:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623848833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Which could happen on all the index sync errors.\r\n\r\nGood point. Though, that seems like a bigger problem of the unit tests not handling AbortNode/FatalError/StartShutdown at all?",
      "created_at" : "2023-07-06T15:13:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623858487",
      "id" : 1623858487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gyh03",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623858487/reactions"
      },
      "updated_at" : "2023-07-06T15:13:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623858487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Which could happen on all the index sync errors.\r\n> \r\n> Good point. Though, that seems like a bigger problem of the unit tests not handling AbortNode/FatalError/StartShutdown at all?\r\n\r\nThe quickest fix would be to add a `ShutdownRequested()` call into the `IndexWaitSynced()` loop. And verify at the end of the function that the index class is synced by calling:\r\n```\r\nBOOST_CHECK(index.GetSummary().synced);\r\n```\r\n\r\nThe \"AbortNode/FatalError/StartShutdown\" treatment on the tests topic seems to be a different problem that we should aboard in the future, yeah. Here the test main thread will actively-wait for a flag to be set, and the flag could never be set. So, even if we start handling \"AbortNode/FatalError/StartShutdown\" on the base tests class, the error would need to be handled by a different thread (not sure if we already have something for it).\r\n\r\nSaid that, not really strong for now, maybe I will bother again in the future, but I still would prefer to make unit test cover the specific behavior by directly calling the sync method synchronously and not mix it with the app's threading decisions ([background](https://github.com/bitcoin/bitcoin/pull/28026#pullrequestreview-1515410110)). If there are concerns over where processes are run/initialized, we should make another test to cover them.",
      "created_at" : "2023-07-06T15:42:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/28036#issuecomment-1623901376",
      "id" : 1623901376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/28036",
      "node_id" : "IC_kwDOABII585gysTA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623901376/reactions"
      },
      "updated_at" : "2023-07-06T15:52:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1623901376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
