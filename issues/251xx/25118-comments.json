[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25005](https://github.com/bitcoin/bitcoin/pull/25005) (wallet: remove extra wtx lookup in 'AvailableCoins' + several code cleanups. by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-05-13T17:09:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25118#issuecomment-1126268609",
      "id" : 1126268609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25118",
      "node_id" : "IC_kwDOABII585DIX7B",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126268609/reactions"
      },
      "updated_at" : "2022-05-18T06:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126268609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Actually I don't think they are different behavior. They just are set and checked at different times so these two variables appear to be controlling different things.\r\n\r\nIf `m_add_inputs == false`, then we only filter for the preset inputs in `AvailableCoins`. If `fAllowOtherInputs == false`, we also only filter for the preset inputs in `AvailableCoins`. In `SelectCoins`, if `fAllowOtherInputs == false`, we have an optimization where we just select all of the preset inputs and exit early. For `m_add_inputs == false`, we don't do the optimization but instead select all of the inputs, do the coin selection algorithms, and arrive at the same selection of all of the preset inputs. So these two options fundamentally do the same thing and could actually be unified.\r\n\r\nThere is some weird interactions between then, such as when `m_add_inputs == false`, but `fAllowOtherInputs` is force set to `true` in `FundTransaction` - in this case `m_add_inputs` \"overrides\" `fAllowOtherInputs`, but it just isn't as obvious that it does. This would definitely be cleared up if they were the same variable.\r\n\r\nSo there is no need to introduce `m_use_manual_selection`.",
      "created_at" : "2022-05-16T19:21:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25118#issuecomment-1128047119",
      "id" : 1128047119,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25118",
      "node_id" : "IC_kwDOABII585DPKIP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128047119/reactions"
      },
      "updated_at" : "2022-05-16T19:23:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128047119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hey achow101, thanks for the review!\r\n\r\n> If m_add_inputs == false, then we only filter for the preset inputs in AvailableCoins. If fAllowOtherInputs == false, we also only filter for the preset inputs in AvailableCoins. In SelectCoins, if fAllowOtherInputs == false, we have an optimization where we just select all of the preset inputs and exit early. For m_add_inputs == false, we don't do the optimization but instead select all of the inputs, do the coin selection algorithms, and arrive at the same selection of all of the preset inputs. So these two options fundamentally do the same thing and could actually be unified.\r\n\r\nI came to the same conclusion but.. the reason behind the new flag are all the `AvailableCoins` checks prior appending the coins to the `vCoins` vector that are being skipped in the second part of the `SelectCoins` process (where it loops over the `CoinControl` manually selected outputs and forcibly adds them to the tx, getting them from the wallet tx map directly instead of looking them inside `vCoins`..).\r\n\r\nIn other words, the usage of `m_add_inputs=true` was telling the wallet: \"add this outputs as inputs into the tx; don't care if they are spent, locked or whatever state they are. Just add them\".\r\nWhile `HasSelected() + fAllowOtherInputs=false` is a \"add this outputs as inputs into the tx only if they are in a valid state, not locked, with enough depth, etc\".\r\n\r\nAn easy example of this is the locked coins skip that is inside `AvailableCoins` but not in the second part of `SelectCoins`:\r\n\r\nThe locked coins are, forcibly, selected inside the second part of `SelectCoins` while they were skipped inside `AvailableCoins`.. so if I change the current behavior (which I agree that is completely redundant: further notes below) and use the first part of the `SelectCoins` process: as the locked coins aren't inside `vCoins`, the process will not be able to select them, throwing an \"Insufficient funds\" error.\r\n\r\nTo try it, you can just set the new flag `m_use_manual_selection` to true at line 609 of `rpc/spend.cpp`, which without something like https://github.com/furszy/bitcoin-core/commit/1291ba7d2463c062242b82df879fba8ca29ba627 will fail at line 140 of the `rpc_psbt.py` test (which is the test line that checks that coin locks are ignored for manually selected inputs).\r\n\r\nSo.. conclusion:\r\n\r\n I agree with you and have been working on it on a local branch. Unifying and cleaning most of these redundancies (thus why found #25005). And added the manual flag here in order to not add a bulk of changes that are required to keep the same current behavior (explained above) without entering into the rabbit hole.\r\n\r\nGetting deeper, some of the rabbit hole changes, linked to this work, that I have been working on locally (WIP) are:\r\n\r\n1) The `SelectCoins` process shouldn't be searching coins in the wallet. That is exactly what `AvailableCoins` is already doing --> It only needs to be focused on the coins selection algorithm.\r\n2) The wallet shouldn't be looping across the entire wallet's tx map if the user wants to select an specific set of inputs and nothing else --> it can just select them right away (skipping all the `AvailableCoins` checks using the manual selection flag).\r\n3) The locked coins skip/add can be customizable by the user at selection time.",
      "created_at" : "2022-05-16T21:00:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25118#issuecomment-1128129869",
      "id" : 1128129869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25118",
      "node_id" : "IC_kwDOABII585DPeVN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128129869/reactions"
      },
      "updated_at" : "2022-05-16T21:01:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128129869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In other words, the usage of `m_add_inputs=true` was telling the wallet: \"add this outputs as inputs into the tx; don't care if they are spent, locked or whatever state they are. Just add them\".\r\n> While `HasSelected() + fAllowOtherInputs=false` is a \"add this outputs as inputs into the tx only if they are in a valid state, not locked, with enough depth, etc\".\r\n\r\nI don't think this is a useful distinction.\r\n\r\nThe only ways to manually set inputs are through `send`, `fundrawtransaction`, `walletcreatefundedpsbt`, and the GUI. Those 3 RPCs all use the same `FundTransaction` function which currently does `fAllowOtherInputs = true`, so they always add the specified inputs regardless of state. The GUI only allows users to preset input that are shown in a list - a list which is created by doing `AvailableCoins` (with the addition of locked coins, but the GUI does not allow selecting locked coins). So those inputs already only consists of coins that are in a valid state, and hence any additional checks for those valid states are redundant. So `HasSelected + fAllowOtherInputs=false` is not materially useful and we could just unify both parameters to what `m_add_inputs=false` does (with the optimization to skip running the selection algos) and users would not observe any difference.",
      "created_at" : "2022-05-16T21:46:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25118#issuecomment-1128169344",
      "id" : 1128169344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25118",
      "node_id" : "IC_kwDOABII585DPn-A",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128169344/reactions"
      },
      "updated_at" : "2022-05-16T21:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128169344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > In other words, the usage of `m_add_inputs=true` was telling the wallet: \"add this outputs as inputs into the tx; don't care if they are spent, locked or whatever state they are. Just add them\".\r\n> > While `HasSelected() + fAllowOtherInputs=false` is a \"add this outputs as inputs into the tx only if they are in a valid state, not locked, with enough depth, etc\".\r\n> \r\n> I don't think this is a useful distinction.\r\n> \r\n> The only ways to manually set inputs are through `send`, `fundrawtransaction`, `walletcreatefundedpsbt`, and the GUI. Those 3 RPCs all use the same `FundTransaction` function which currently does `fAllowOtherInputs = true`, so they always add the specified inputs regardless of state. The GUI only allows users to preset input that are shown in a list - a list which is created by doing `AvailableCoins` (with the addition of locked coins, but the GUI does not allow selecting locked coins). So those inputs already only consists of coins that are in a valid state, and hence any additional checks for those valid states are redundant. So `HasSelected + fAllowOtherInputs=false` is not materially useful and we could just unify both parameters to what `m_add_inputs=false` does (with the optimization to skip running the selection algos) and users would not observe any difference.\r\n\r\n\r\nI think that, with different words, we are saying the same thing and heading into the same direction.\r\n\r\nLetâs try to split the GUI from the RPC flow.\r\n\r\nThere is a small misunderstanding there; the distinction that made was merely to describe how the current process is working:\r\n\r\nYou can provide locked and already spent inputs to `walletcreatefundedpsbt` which are (1) skipped on the `AvailableCoins` process (not appended to `vCoins`), and then (2) added into the tx in the *second* part of `SelectCoins` (which basically skips all the coin checks that are performed inside `AvailableCoins`). And this is even being used/tested inside `rpc_psbt.py`.\r\n\r\nThis was happening because of the entangled `m_add_inputs=false` + `fAllowOtherInputs=true` sets.\r\n\r\nSo, essentially, in the current flow in master, if you provide inputs to `walletcreatefundedpsbt`, those inputs are not being fetched inside `AvailableCoins`, they are fetched and appended to the result inside `SelectCoins`.\r\n\r\nNow, based on that, the point that tried to make in my previous comment is that in order to unify both values into `fAllowOtherInputs` without adding the `m_use_manual_selection` flag, we need to add two more commits 5c81571 and 0561612: The reason is that locked coins and spent coins are not in `vCoins` at `SelectCoins` time (they are skipped inside `AvailableCoins`) so they cannot be selected in the first part of `SelectCoins` (which differs from the second part, as it does not search for the user selected outputs inside the wallet).\r\n\r\n------------------------------------------------------------------------------\r\n\r\n### Update Summary:\r\n\r\nPushed the `m_use_manual_selection` removal and added the two commits 5c81571 and 0561612 that are a requirement in order to keep the same functionality for `walletcreatefundedpsbt`.\r\n\r\nOtherwise the command will not support the selection of locked and spent coins (note: whether we accept or not the selection of spent coins on `walletcreatefundedpsbt` shouldnât be part of this PR discussion. Itâs what we currently have in master and this PR is focused on cleaning the weird/bad flows entanglements first without introducing any behavior change. I could tackle that one later on a follow-up PR).\r\n\r\nNow.. if we are sync up to this point we can move onto the final topic, there is still one more behavior change that I need to cover and test after the `m_use_manual_selection` flag removal :) . Because, as we arenât going to use the second part of `SelectCoins` anymore after this changes, the flow isnât adding the coin control selected external outputs to the selection result anymore (The `coin_control.GetExternalOutput` stuff inside `SelectCoins`).\r\n\r\nI was leaving that work for a follow-up PR (have a branch locally that removes/refactor all the output search functionality out from `SelectCoins`), but.. letâs see if I can add a small version of it here and prepare test coverage for it as well (we currently don't have coverage for this stuff).",
      "created_at" : "2022-05-18T13:36:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25118#issuecomment-1130028448",
      "id" : 1130028448,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25118",
      "node_id" : "IC_kwDOABII585DWt2g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1130028448/reactions"
      },
      "updated_at" : "2022-05-18T13:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1130028448",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
