[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r873846069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873846069"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems like the `MaybePunish*` calls could accept a `Peer&` (and `CNodeState&`) as well, and also not be called when the peer is already disconnected?",
      "commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "created_at" : "2022-05-16T15:09:45Z",
      "diff_hunk" : "@@ -1480,12 +1483,13 @@ bool PeerManagerImpl::MaybePunishNodeForBlock(NodeId nodeid, const BlockValidati\n \n bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationState& state, const std::string& message)\n {\n+    PeerRef peer{GetPeerRef(nodeid)};\n     switch (state.GetResult()) {\n     case TxValidationResult::TX_RESULT_UNSET:\n         break;\n     // The node is providing invalid data:\n     case TxValidationResult::TX_CONSENSUS:\n-        Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r873846069",
      "id" : 873846069,
      "line" : 1488,
      "node_id" : "PRRC_kwDOABII5840FdU1",
      "original_commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "original_line" : 1488,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 974130951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873846069/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-16T15:09:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873846069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r873885597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873885597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, but only because the `message` happens to be `empty()` in cases where the peer might be `nullptr`/disconnected. I wasn't sure if we want to enforce this correlation. ",
      "commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "created_at" : "2022-05-16T15:45:58Z",
      "diff_hunk" : "@@ -1480,12 +1483,13 @@ bool PeerManagerImpl::MaybePunishNodeForBlock(NodeId nodeid, const BlockValidati\n \n bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationState& state, const std::string& message)\n {\n+    PeerRef peer{GetPeerRef(nodeid)};\n     switch (state.GetResult()) {\n     case TxValidationResult::TX_RESULT_UNSET:\n         break;\n     // The node is providing invalid data:\n     case TxValidationResult::TX_CONSENSUS:\n-        Misbehaving(nodeid, 100, message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r873885597",
      "id" : 873885597,
      "in_reply_to_id" : 873846069,
      "line" : 1488,
      "node_id" : "PRRC_kwDOABII5840Fm-d",
      "original_commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "original_line" : 1488,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 974188949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873885597/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-16T15:45:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873885597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24571](https://github.com/bitcoin/bitcoin/pull/24571) (p2p: Prevent block index fingerprinting by sending additional getheaders messages by dergoegge)\n* [#24474](https://github.com/bitcoin/bitcoin/pull/24474) (Additional thread safety annotations for CNode/Peer by ajtowns)\n* [#22778](https://github.com/bitcoin/bitcoin/pull/22778) (net processing: Reduce resource usage for inbound block-relay-only connections by jnewbery)\n* [#21527](https://github.com/bitcoin/bitcoin/pull/21527) (net_processing: lock clean up by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-05-16T19:52:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25144#issuecomment-1128073145",
      "id" : 1128073145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25144",
      "node_id" : "IC_kwDOABII585DPQe5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128073145/reactions"
      },
      "updated_at" : "2022-05-18T05:54:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1128073145",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-19T10:19:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25144#issuecomment-1131511324",
      "id" : 1131511324,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25144",
      "node_id" : "IC_kwDOABII585DcX4c",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131511324/reactions"
      },
      "updated_at" : "2022-05-19T10:19:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1131511324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r878088254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/878088254"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n    void Misbehaving(Peer& peer, int howmuch, const std::string& message);\r\n```",
      "commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "created_at" : "2022-05-20T12:23:54Z",
      "diff_hunk" : "@@ -482,6 +482,12 @@ class PeerManagerImpl final : public PeerManager\n      *  May return an empty shared_ptr if the Peer object can't be found. */\n     PeerRef RemovePeer(NodeId id) EXCLUSIVE_LOCKS_REQUIRED(!m_peer_mutex);\n \n+    /**\n+     * Increment peer's misbehavior score. If the new value >= DISCOURAGEMENT_THRESHOLD, mark the node\n+     * to be discouraged, meaning the peer might be disconnected and added to the discouragement filter.\n+     */\n+    void Misbehaving(Peer& peer, const int howmuch, const std::string& message);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25144#discussion_r878088254",
      "id" : 878088254,
      "line" : 489,
      "node_id" : "PRRC_kwDOABII5840VpA-",
      "original_commit_id" : "fa825d1903a3d7268104df33b7dcf1a5e685302d",
      "original_line" : 489,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 980025490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25144",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/878088254/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-20T12:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/878088254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
