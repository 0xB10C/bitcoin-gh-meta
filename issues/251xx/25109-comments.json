[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "cc @vasild @w0xlt @jonatack @hebasto \r\n\r\nThis is the first two commits from #24931 so we can hopefully make some progress..",
      "created_at" : "2022-05-11T17:17:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1124036445",
      "id" : 1124036445,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585C_29d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124036445/reactions"
      },
      "updated_at" : "2022-05-11T17:17:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124036445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24970](https://github.com/bitcoin/bitcoin/pull/24970) (net processing: Move cleanSubVer, fPreferredDownload and nLocalHostNonce to Peer by jnewbery)\n* [#24474](https://github.com/bitcoin/bitcoin/pull/24474) (Additional thread safety annotations for CNode/Peer by ajtowns)\n* [#24356](https://github.com/bitcoin/bitcoin/pull/24356) (refactor: replace CConnman::SocketEvents() with mockable Sock::WaitMany() by vasild)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n* [#24170](https://github.com/bitcoin/bitcoin/pull/24170) (p2p, rpc: Manual block-relay-only connections with addnode by mzumsande)\n* [#24122](https://github.com/bitcoin/bitcoin/pull/24122) (refactor: replace RecursiveMutex `cs_vProcessMsg` with Mutex (and rename) by theStack)\n* [#21878](https://github.com/bitcoin/bitcoin/pull/21878) (Make all networking code mockable by vasild)\n* [#21527](https://github.com/bitcoin/bitcoin/pull/21527) (net_processing: lock clean up by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-05-12T07:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1124625585",
      "id" : 1124625585,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DCGyx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124625585/reactions"
      },
      "updated_at" : "2022-05-13T17:52:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1124625585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> diff ...\r\n\r\nI don't think it is meaningful or useful to annotate lambdas, as annotations are stripped as soon as they are assigned to a `std::function<...>` type.",
      "created_at" : "2022-05-13T14:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126112871",
      "id" : 1126112871,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DHx5n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126112871/reactions"
      },
      "updated_at" : "2022-05-13T14:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126112871",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> annotations are stripped\r\n\r\nHmm:\r\n\r\n```cpp\r\nvoid f()\r\n{\r\n    auto g = []() EXCLUSIVE_LOCKS_REQUIRED(!::cs_main) { AssertLockNotHeld(::cs_main); };\r\n    g(); // error: calling function 'operator()' requires negative capability '!cs_main' [-Werror,-Wthread-safety-analysis]\r\n}\r\n```\r\n\r\n (clang 15)",
      "created_at" : "2022-05-13T14:44:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126136958",
      "id" : 1126136958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DH3x-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126136958/reactions"
      },
      "updated_at" : "2022-05-13T14:44:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126136958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > diff ...\r\n\r\nI think that's large enough and independent enough that it warrants its own PR...\r\n\r\n> I don't think it is meaningful or useful to annotate lambdas, as annotations are stripped as soon as they are assigned to a `std::function<...>` type.\r\n\r\nThat means they're still useful when passed around via `auto` or templated types though. It gets pretty cumbersome anytime the lambda is passed to some generic function that wants a callback though.",
      "created_at" : "2022-05-13T15:08:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126159979",
      "id" : 1126159979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DH9Zr",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126159979/reactions"
      },
      "updated_at" : "2022-05-13T15:08:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126159979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Hmm `auto`\r\n\r\nauto in this context is not a `std::function`, so it may still have the annotations attached.\r\n\r\n> That means they're still useful when passed around via auto or templated types though.\r\n\r\nEh, isn't this what we want to avoid? For example, annotating an rpc method lambda with lock annotations will either:\r\n\r\n* get them stripped away (as they are assigned to a `std::function`)\r\n* pollute the rpc server code (if they are somehow templated) with global lock annotations\r\n* might result in a compile failure if the calling function can't be annotated (for example it is from an external library) \r\n\r\nNone of this sounds useful or like an improvement. The diff that @vasild posted above looks similar to the diff that I NACKed two years ago https://github.com/bitcoin/bitcoin/pull/20272#pullrequestreview-520824413",
      "created_at" : "2022-05-13T15:25:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126176071",
      "id" : 1126176071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DIBVH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126176071/reactions"
      },
      "updated_at" : "2022-05-13T15:25:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126176071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Well, that diff above is required if we want to avoid the two `AssertLockNotHeldInline()` introduced in this PR and use just the first one:\r\n\r\n```cpp\r\ninline void AssertLockNotHeldInline(const char* name, const char* file, int line, Mutex* cs) EXCLUSIVE_LOCKS_REQUIRED(!cs) { AssertLockNotHeldInternal(name, file, line, cs); }\r\ninline void AssertLockNotHeldInline(const char* name, const char* file, int line, RecursiveMutex* cs) LOCKS_EXCLUDED(cs) { AssertLockNotHeldInternal(name, file, line, cs); }\r\n```\r\n\r\nOr, in other words, to avoid this (from this PR description):\r\n\r\n> Note that this can't reasonably be used for globals, because clang would require every function to be annotated with EXCLUSIVE_LOCKS_REQUIRED(!g_mutex) for each global mutex.\r\n\r\nAnyway - I am ok with this PR as it is. It's an improvement from the current situation IMO, even with the two `AssertLockNotHeldInline()`s.",
      "created_at" : "2022-05-13T15:58:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126205612",
      "id" : 1126205612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DIIis",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126205612/reactions"
      },
      "updated_at" : "2022-05-13T15:59:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126205612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > That means they're still useful when passed around via `auto` or templated types though. It gets pretty cumbersome anytime the lambda is passed to some generic function that wants a callback though.\r\n>\r\n> Eh, isn't this what we want to avoid? For example, annotating an rpc method lambda with lock annotations will ...\r\n\r\nYeah, that's what I meant by cumbersome. Could be worthwhile in some cases maybe though (I know I've added annotations to some lambdas which didn't seem too bad).",
      "created_at" : "2022-05-13T17:05:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25109#issuecomment-1126265489",
      "id" : 1126265489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25109",
      "node_id" : "IC_kwDOABII585DIXKR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126265489/reactions"
      },
      "updated_at" : "2022-05-13T17:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1126265489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
