[
   {
      "body" : "This is a more invasive change than #8097, but concept ACK.\r\n\r\n> Untested.\r\n\r\nLooks like we don't have any RPC tests for `getaddednodeinfo`, nor `addnode` besides `onetry` mode.",
      "created_at" : "2016-05-30T11:26:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222472213",
      "id" : 222472213,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-05-30T11:26:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222472213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Basic testing for getaddednodeinfo/addnode should certainly be added, but the specific case being changed here would be very hard to test without beind able to mock out name resolving...",
      "created_at" : "2016-05-30T12:39:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222483981",
      "id" : 222483981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-05-30T12:39:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222483981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Yes, agreed. Maybe that's a future possibility after the net refactor. IMO the most important privacy invariant for DNS changes is that we don't ever do DNS queries when `-dns=0` is set. Would be nice to have an auto test of some kind for that.\r\n\r\nIn any case that's a tangent. I think #8097 was nice in that it was only a local change to an (apparently rarely used) RPC call. This involves some regression risk for code outside that as well. On the other hand this is a more thorough solution, and at least one person (@thebluematt) cares about the functionality it seems better to do that.\r\n\r\n@theuni can you take a look?\r\n",
      "created_at" : "2016-05-31T13:15:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222684582",
      "id" : 222684582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-05-31T13:15:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222684582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Concept ACK. Thanks, @sipa!\r\n\r\nWill review in detail.",
      "created_at" : "2016-05-31T15:39:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222728761",
      "id" : 222728761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-05-31T15:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222728761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "\r\nThis looks great. A few notes:\r\n- GetAddedNodeInfo() doesn't check for pnode->fDisconnect. I'm not sure if it needs to bother (probably not).\r\n- ConnectSocketByName() only tries 1 of the resolved results, which seems to conflict with the PR description. Unless I'm reading incorrectly, adding \"foo.com\" which resolves to 10 ips will mean 2 min between tries for its ips, with random collisions mixed in.\r\n- It looks like this will mean up to a 2min lag from addnode rpc to attempted first connection. We can introduce a condvar after https://github.com/bitcoin/bitcoin/pull/8085/commits/fc2561f7803e9b354c152bd4bd92678bd941fcb0 in lieu of the hard-coded wait.\r\n\r\nI'll work on some real testing. Yes, I have planned (for later, not initially) for functionality to spoof resolved results for easier dns testing as part of the net refactor. For now, I'll just spoof system-wide.",
      "created_at" : "2016-06-01T00:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222859601",
      "id" : 222859601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-06-01T00:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222859601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> GetAddedNodeInfo() doesn't check for pnode->fDisconnect. I'm not sure if it needs to bother (probably not).\r\n\r\nI don't think that matters. If fDisconnect is set, it tends to be processed quickly.\r\n\r\n> ConnectSocketByName() only tries 1 of the resolved results, which seems to conflict with the PR description. Unless I'm reading incorrectly, adding \"foo.com\" which resolves to 10 ips will mean 2 min between tries for its ips, with random collisions mixed in.\r\n\r\nOnly the random order changed. The old code would consecutively try all IPs from all addnodes, but with an inner loop over the -addnode arguments (with 0.5s delay), and an outer loop (with 120s delay) over the multiple lookup results.\r\n\r\n> It looks like this will mean up to a 2min lag from addnode rpc to attempted first connection. We can introduce a condvar after fc2561f in lieu of the hard-coded wait.\r\n\r\nSounds like a good idea, but that's independent of this PR, right?",
      "created_at" : "2016-06-01T13:44:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-222996363",
      "id" : 222996363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-06-01T13:44:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/222996363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Yikes, yet another misreading of this code on my part. I misunderstood the connection logic post-resolve. So nevermind the ConnectSocketByName comment.\r\n\r\nYes, the condvar can come later.",
      "created_at" : "2016-06-01T16:24:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#issuecomment-223047415",
      "id" : 223047415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8113",
      "updated_at" : "2016-06-01T16:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223047415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8113#discussion_r65795028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65795028"
         }
      },
      "body" : "What Release()s this?",
      "commit_id" : "b395c90728b47c132a176a0a4483cfff9b23b7ca",
      "created_at" : "2016-06-04T01:42:32Z",
      "diff_hunk" : "@@ -400,6 +400,26 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest)\n             return NULL;\n         }\n \n+        if (pszDest && addrConnect.IsValid()) {\n+            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+            // In that case, drop the connection that was just created, and return the existing CNode instead.\n+            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+            // name catch this early.\n+            CNode* pnode = FindNode((CService)addrConnect);\n+            if (pnode)\n+            {\n+                pnode->AddRef();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#discussion_r65795028",
      "id" : 65795028,
      "original_commit_id" : "ea5fa8038b8a2242e9b570b082bb5d2aacbb85df",
      "original_position" : 12,
      "path" : "src/net.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8113",
      "updated_at" : "2016-06-04T01:42:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65795028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8113#discussion_r65982938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8113"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65982938"
         }
      },
      "body" : "I just copied the behaviour of the \"// Look for existing connection\" logic above. I assume that ConnectNode always returns something with an incremented refcount that the caller is supposed to deal with.",
      "commit_id" : "b395c90728b47c132a176a0a4483cfff9b23b7ca",
      "created_at" : "2016-06-06T22:42:53Z",
      "diff_hunk" : "@@ -400,6 +400,26 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest)\n             return NULL;\n         }\n \n+        if (pszDest && addrConnect.IsValid()) {\n+            // It is possible that we already have a connection to the IP/port pszDest resolved to.\n+            // In that case, drop the connection that was just created, and return the existing CNode instead.\n+            // Also store the name we used to connect in that CNode, so that future FindNode() calls to that\n+            // name catch this early.\n+            CNode* pnode = FindNode((CService)addrConnect);\n+            if (pnode)\n+            {\n+                pnode->AddRef();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8113#discussion_r65982938",
      "id" : 65982938,
      "original_commit_id" : "ea5fa8038b8a2242e9b570b082bb5d2aacbb85df",
      "original_position" : 12,
      "path" : "src/net.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8113",
      "updated_at" : "2016-06-06T22:42:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65982938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
