[
   {
      "body" : "This mixed locking for mapNodeState is not particularly easy to reason about.\r\n\r\nWhat about creating a separate map (alongside mapNodeState) for storing misbehaviour information? Longer term, we'll want to see mapNodeState (and the processing-related data in CNode itself) split up into multiple modules (each with their own state) anyway.",
      "created_at" : "2016-06-05T15:42:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223820229",
      "id" : 223820229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-05T15:42:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223820229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "That does sound better. I didn't like protecting the struct with different locks but I was trying to avoid the overhead of a new map. Reimplemented with a CMisbehaviorTracker that encapsulates its lock. TODO before mergeable: add unit tests for the new class.",
      "created_at" : "2016-06-05T21:19:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223838347",
      "id" : 223838347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-05T21:19:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223838347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65904015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65904015"
         }
      },
      "body" : "Is the std::move necessary here, if nameIn is already an rvalue reference?",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T14:52:13Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65904015",
      "id" : 65904015,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65904015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65908907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65908907"
         }
      },
      "body" : "Indentation?",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T15:15:57Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}\n+    };\n+public:\n+    CMisbehaviorTracker()\n+        : cs()\n+        , map()\n+        , banscore()\n+    {}\n+\n+    // node must not already be registered\n+    void Register(NodeId node, std::string name) {\n+        lock_guard guard{cs};\n+        auto ret = map.emplace(std::piecewise_construct,\n+            std::forward_as_tuple(node),\n+            std::forward_as_tuple(std::move(name), 0, false));\n+        assert(ret.second);\n+    }\n+\n+    // node must be registered\n+    // returns the misbehavior score of the removed node\n+    int Unregister(NodeId node) {\n+        lock_guard guard{cs};\n+        auto it = map.find(node);\n+        assert(it != map.end());\n+        auto nMis = it->second.badness;\n+        map.erase(it);\n+        return nMis;\n+    }\n+\n+    // returns false if node is not registered\n+    bool Get(NodeId node, int& nMisbehaviorOut) const {\n+        lock_guard guard{cs};\n+        auto it = map.find(node);\n+        if (it == map.end())\n+            return false;\n+        nMisbehaviorOut = it->second.badness;\n+        return true;\n+    }\n+\n+    // returns false if node is not registered\n+    bool Increase(NodeId node, int delta)\n+    {\n+        std::string logentry;\n+        {\n+        lock_guard guard{cs};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65908907",
      "id" : 65908907,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 84,
      "path" : "src/main.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65908907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Nice, utACK with 2 nits, but needs rebase.",
      "created_at" : "2016-06-06T15:26:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223993572",
      "id" : 223993572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T15:26:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/223993572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65916528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65916528"
         }
      },
      "body" : "The `Info` ctor accepts an rvalue reference and binds it to `nameIn`, making it an lvalue.",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T15:54:27Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65916528",
      "id" : 65916528,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65916528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "body" : "Rebased and fixed indentation.",
      "created_at" : "2016-06-06T16:01:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224004335",
      "id" : 224004335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T16:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/224004335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1047859?v=3",
         "events_url" : "https://api.github.com/users/kazcw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kazcw/followers",
         "following_url" : "https://api.github.com/users/kazcw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kazcw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kazcw",
         "id" : 1047859,
         "login" : "kazcw",
         "organizations_url" : "https://api.github.com/users/kazcw/orgs",
         "received_events_url" : "https://api.github.com/users/kazcw/received_events",
         "repos_url" : "https://api.github.com/users/kazcw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kazcw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kazcw"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65920308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65920308"
         }
      },
      "body" : "Thanks for clearing that up, I'm still learning all the details related to rvalue reference semantics. I'm starting to understand the necessity of all the logic related to forwarding arguments...",
      "commit_id" : "ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T16:15:38Z",
      "diff_hunk" : "@@ -300,6 +296,97 @@ CNodeState *State(NodeId pnode) {\n     return &it->second;\n }\n \n+class CMisbehaviorTracker {\n+    typedef std::lock_guard<std::mutex> lock_guard;\n+    struct Info {\n+        const std::string name;\n+        int badness;\n+        bool ban;\n+        Info(std::string&& nameIn, int badnessIn, bool banIn) : name(std::move(nameIn)), badness(badnessIn), ban(banIn) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65920308",
      "id" : 65920308,
      "original_commit_id" : "291644ef7b3b9ede12572b9d03580ab82e8d4252",
      "original_position" : 40,
      "path" : "src/main.cpp",
      "position" : 40,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/8147",
      "updated_at" : "2016-06-06T16:15:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/65920308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK ae3c24040cfef500daf5c4b890d1cabe2e191d9a",
      "created_at" : "2016-06-06T16:21:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224009866",
      "id" : 224009866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8147",
      "updated_at" : "2016-06-06T16:21:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/224009866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
