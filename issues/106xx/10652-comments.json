[
   {
      "body" : "Ping @theuni.",
      "created_at" : "2017-06-22T19:56:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#issuecomment-310485429",
      "id" : 310485429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652",
      "updated_at" : "2017-06-22T19:56:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310485429",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124646951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124646951"
         }
      },
      "body" : "Wouldn't this discard the rvalue reference && (move schematic)? ",
      "commit_id" : "e272fc9dc9b68262d4bad3b899861bc20089281d",
      "created_at" : "2017-06-28T20:24:52Z",
      "diff_hunk" : "@@ -2820,12 +2820,96 @@ bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)\n     for (auto&& pnode : vNodes) {\n         if(pnode->GetId() == id) {\n             found = pnode;\n+            found->AddRef();\n             break;\n         }\n     }\n-    return found != nullptr && NodeFullyConnected(found) && func(found);\n+    bool res = found != nullptr && NodeFullyConnected(found) && func(found);\n+    found->Release();\n+    return res;\n }\n \n+void CConnman::ForEachNode(std::function<void (CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124646951",
      "id" : 124646951,
      "original_commit_id" : "f1d25b2d54779d8b96b69a38c0cf762977ed92c2",
      "original_position" : 14,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 46957076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652",
      "updated_at" : "2017-06-28T21:27:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124646951",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124656961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124656961"
         }
      },
      "body" : "I mean it does, but I'm not too worried about requiring move for a callable type (places where we std::move a lambda into this will still get the benifit of calling std::function(Callable&&)). The real concern here, of course, is that it introduces a performance penalty, but its not huge (an extra function call and few if's on top of the callback function call) and we're already calling this with lambda functions, so I dont think we were ever too worried about the performance here.",
      "commit_id" : "e272fc9dc9b68262d4bad3b899861bc20089281d",
      "created_at" : "2017-06-28T21:07:32Z",
      "diff_hunk" : "@@ -2820,12 +2820,96 @@ bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)\n     for (auto&& pnode : vNodes) {\n         if(pnode->GetId() == id) {\n             found = pnode;\n+            found->AddRef();\n             break;\n         }\n     }\n-    return found != nullptr && NodeFullyConnected(found) && func(found);\n+    bool res = found != nullptr && NodeFullyConnected(found) && func(found);\n+    found->Release();\n+    return res;\n }\n \n+void CConnman::ForEachNode(std::function<void (CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124656961",
      "id" : 124656961,
      "original_commit_id" : "f1d25b2d54779d8b96b69a38c0cf762977ed92c2",
      "original_position" : 14,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 46968313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652",
      "updated_at" : "2017-06-28T21:27:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124656961",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124659622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124659622"
         }
      },
      "body" : "Moved this commit to #10697.",
      "commit_id" : "e272fc9dc9b68262d4bad3b899861bc20089281d",
      "created_at" : "2017-06-28T21:19:30Z",
      "diff_hunk" : "@@ -2820,12 +2820,96 @@ bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)\n     for (auto&& pnode : vNodes) {\n         if(pnode->GetId() == id) {\n             found = pnode;\n+            found->AddRef();\n             break;\n         }\n     }\n-    return found != nullptr && NodeFullyConnected(found) && func(found);\n+    bool res = found != nullptr && NodeFullyConnected(found) && func(found);\n+    found->Release();\n+    return res;\n }\n \n+void CConnman::ForEachNode(std::function<void (CNode* pnode)> func)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r124659622",
      "id" : 124659622,
      "original_commit_id" : "f1d25b2d54779d8b96b69a38c0cf762977ed92c2",
      "original_position" : 14,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 46971332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652",
      "updated_at" : "2017-06-28T21:27:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124659622",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased on a rebased version of the updated #10179 and filled in more text for the \"\tMarkBlockAsReceived on NewPoWValidBlock at receive.\" commit message which helps provide a bit more context for this PR:\r\n\r\n\"Note that this also helps with future per-CNodeState locks, as those\r\nwill require no two CNodeState locks to be held at the same time\r\n(for lockorder reasons), and this prevents us from accessing\r\nanother peer's mmapBlocksInFlight entry during processing as we can\r\nmove the NewPoWValidBlock callback into the CValidationInterface\r\nbackground thread mechanics.\"",
      "created_at" : "2017-06-28T21:28:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#issuecomment-311797355",
      "id" : 311797355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10652",
      "updated_at" : "2017-06-28T21:28:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/311797355",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r126026442"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126026442"
         }
      },
      "body" : "I think this wants fInitialDownload as a param so that it's always evaluated in its receiving context rather than having subscribers potentially coming to different conclusions.",
      "commit_id" : "e272fc9dc9b68262d4bad3b899861bc20089281d",
      "created_at" : "2017-07-06T21:56:19Z",
      "diff_hunk" : "@@ -3023,9 +3023,7 @@ static bool AcceptBlock(const std::shared_ptr<const CBlock>& pblock, CValidation\n     }\n \n     // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n-    // (but if it does not build on our best tip, let the SendMessages loop relay it)\n-    if (!IsInitialBlockDownload() && chainActive.Tip() == pindex->pprev)\n-        GetMainSignals().NewPoWValidBlock(pindex, pblock);\n+    GetMainSignals().NewPoWValidBlock(pindex, pblock, chainActive.Tip() == pindex->pprev);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r126026442",
      "id" : 126026442,
      "original_commit_id" : "df3001d00a4578275e22ffb770b62a568acd8178",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 48474644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652",
      "updated_at" : "2017-07-06T21:56:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126026442",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r126026861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126026861"
         }
      },
      "body" : "Probably makes sense for MarkBlockAsNotInFlight() to return whether it removed something for the peer? I think that would take care of the TODO as well.",
      "commit_id" : "e272fc9dc9b68262d4bad3b899861bc20089281d",
      "created_at" : "2017-07-06T21:58:33Z",
      "diff_hunk" : "@@ -2431,7 +2424,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LOCK(cs_main);\n             // Also always process if we requested the block explicitly, as we may\n             // need it even though it is not a candidate for a new best tip.\n-            forceProcessing |= MarkBlockAsReceived(hash);\n+            // TODO: Only process if requested from this peer?\n+            forceProcessing |= mmapBlocksInFlight.count(hash);\n+            // Block is no longer in flight from this peer\n+            MarkBlockAsNotInFlight(hash, pfrom->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10652#discussion_r126026861",
      "id" : 126026861,
      "original_commit_id" : "35bd4b620492e9b9c12b5fca24a007fd2ac8aa44",
      "original_position" : 47,
      "path" : "src/net_processing.cpp",
      "position" : 369,
      "pull_request_review_id" : 48475117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10652",
      "updated_at" : "2017-07-06T21:58:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/126026861",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
