[
   {
      "body" : "This would make much more sense as `?wallet=WALLETID` than trying to emulate a path...",
      "created_at" : "2017-06-22T07:56:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#issuecomment-310305250",
      "id" : 310305250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10650",
      "updated_at" : "2017-06-22T07:56:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310305250",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "> This would make much more sense as ?wallet=WALLETID than trying to emulate a path...\r\n\r\nNo. Please no query string.\r\nThat doesn't make sense to me.\r\n\r\nPOST data to `/wallet/<name>` seems more reasonable to me then POST data to `/?wallet=<name>`",
      "created_at" : "2017-06-22T09:30:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#issuecomment-310328049",
      "id" : 310328049,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10650",
      "updated_at" : "2017-06-22T09:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310328049",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123475967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123475967"
         }
      },
      "body" : "In commit \"Add -wallet endpoint support to bitcoin-cli\":\r\n\r\nProbably should url encode in case filename contains spaces, reserved characters, or unicode (utf8) https://en.wikipedia.org/wiki/Percent-encoding#Percent-encoding_reserved_characters\r\n\r\nCorresponding decode would be needed in GetWalletForJSONRPCRequest.",
      "commit_id" : "6c4b1ba5d05295b68f91fda74fc1841d76ce01fc",
      "created_at" : "2017-06-22T10:38:00Z",
      "diff_hunk" : "@@ -235,7 +235,12 @@ UniValue CallRPC(const std::string& strMethod, const UniValue& params)\n     assert(output_buffer);\n     evbuffer_add(output_buffer, strRequest.data(), strRequest.size());\n \n-    int r = evhttp_make_request(evcon.get(), req.get(), EVHTTP_REQ_POST, \"/\");\n+    // check if we should use a special wallet endpoint\n+    std::string endpoint = \"/\";\n+    if (GetArg(\"-wallet\", \"\") != \"\") {\n+        endpoint = \"/wallet/\"+GetArg(\"-wallet\", \"\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123475967",
      "id" : 123475967,
      "original_commit_id" : "2753ea62b9ac1fbae8b5b96f251b0f46246253e4",
      "original_position" : 8,
      "path" : "src/bitcoin-cli.cpp",
      "position" : 8,
      "pull_request_review_id" : 45681446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650",
      "updated_at" : "2017-06-22T11:58:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123475967",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123484826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123484826"
         }
      },
      "body" : "In commit \"[QA] Add support for wallet endpoints in Authproxy\"\r\n\r\nIt seems hacky to me for AuthServiceProxy to be aware of multiwallet and to be munging urls and service name strings this way.\r\n\r\nI think it would be better if AuthServiceProxy didn't know anything about bitcoin urls and just let the caller control the request. There are many ways to allow this, but a simple one might be to define:\r\n\r\n```python\r\ndef __idiv__(self, relative_uri):\r\n    return AuthServiceProxy(\"{}/{}\".format(self.__service_url, relative_uri), self._service_name, connection=self.__conn)\r\n```\r\n\r\nThen you could call methods on individual wallets with:\r\n\r\n```python\r\nw1 = self.nodes[0] / \"wallet/w1.dat\"\r\nw1.getwalletinfo()\r\nw1.getbalance()\r\n```",
      "commit_id" : "6c4b1ba5d05295b68f91fda74fc1841d76ce01fc",
      "created_at" : "2017-06-22T11:25:51Z",
      "diff_hunk" : "@@ -139,17 +139,24 @@ def _request(self, method, path, postdata):\n             return self._get_response()\n \n     def __call__(self, *args, **argsn):\n-        AuthServiceProxy.__id_count += 1\n+        # check for a possible wallet endpoint\n+        urlAdd = \"\"\n+        method = self._service_name\n+        elements = self._service_name.split(\".\")\n+        if len(elements) > 1:\n+            urlAdd = \"/wallet/\" + '.'.join(elements[:-1])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123484826",
      "id" : 123484826,
      "original_commit_id" : "8775248d0699f433c983fb986d86186ff1cab94f",
      "original_position" : 10,
      "path" : "test/functional/test_framework/authproxy.py",
      "position" : 10,
      "pull_request_review_id" : 45681446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650",
      "updated_at" : "2017-06-22T11:58:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123484826",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123489861"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123489861"
         }
      },
      "body" : "In commit \"Add -wallet endpoint support to bitcoin-cli\":\r\n\r\nYou should update `HelpMessageCli` to mention the new argument.\r\n\r\nSince I started making a similar change (but didn't get very far) you could steal my help string:\r\n\r\n```diff\r\nstrUsage += HelpMessageOpt(\"-wallet=<file>\", _(\"Send RPC for non-default wallet on RPC server (argument is wallet filename in bitcoind directory)\"));\r\n```",
      "commit_id" : "6c4b1ba5d05295b68f91fda74fc1841d76ce01fc",
      "created_at" : "2017-06-22T11:54:51Z",
      "diff_hunk" : "@@ -235,7 +235,12 @@ UniValue CallRPC(const std::string& strMethod, const UniValue& params)\n     assert(output_buffer);\n     evbuffer_add(output_buffer, strRequest.data(), strRequest.size());\n \n-    int r = evhttp_make_request(evcon.get(), req.get(), EVHTTP_REQ_POST, \"/\");\n+    // check if we should use a special wallet endpoint\n+    std::string endpoint = \"/\";\n+    if (GetArg(\"-wallet\", \"\") != \"\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123489861",
      "id" : 123489861,
      "original_commit_id" : "2753ea62b9ac1fbae8b5b96f251b0f46246253e4",
      "original_position" : 7,
      "path" : "src/bitcoin-cli.cpp",
      "position" : 7,
      "pull_request_review_id" : 45681446,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650",
      "updated_at" : "2017-06-22T11:58:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123489861",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Concept ACK, will review.\r\n\r\n> POST data to /wallet/<name> seems more reasonable to me then POST data to /?wallet=<name>\r\n\r\nI tend to agree:\r\n- The use of query strings is usually avoided in modern APIs because they make URLs less readable, compared to path segments.\r\n- Also for POST the query data is in the payload. It is very uncommon  to have query arguments in the URL.",
      "created_at" : "2017-06-22T13:36:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#issuecomment-310382168",
      "id" : 310382168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10650",
      "updated_at" : "2017-06-22T13:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310382168",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I guess personally I don't see how `/?wallet=<name>` is \"less readable\" then `/wallet/<name>` and I think I mentioned some practical reasons above for wanting to prefer query strings, but I don't have a very strong preference.\r\n\r\nIf we want to go down the road of encoding request metadata in path segments instead of query parameters maybe we should put more thought into what the path hierarchy should be? It isn't obvious to me that you'd want to put wallet selection at the very top of the path hierarchy instead of something else like an API version version number.",
      "created_at" : "2017-06-22T15:06:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#issuecomment-310408400",
      "id" : 310408400,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10650",
      "updated_at" : "2017-06-22T15:06:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310408400",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123543935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123543935"
         }
      },
      "body" : "In commit \"Select wallet based on the given endpoint\"\r\n\r\nMaybe change error message to something like \"Wallet file does not exist or is not loaded\" to avoid implying that the wallet doesn't exist when it might just not be loaded.\r\n\r\nAlso, since this is a URI, sanitize call should be changed to allow `%` character and probably all reserved and unreserved characters from RFC3986 (`\"%-_.~!*'();:@&=+$,/?#[]\"`).",
      "commit_id" : "6c4b1ba5d05295b68f91fda74fc1841d76ce01fc",
      "created_at" : "2017-06-22T15:31:04Z",
      "diff_hunk" : "@@ -31,10 +31,30 @@\n \n #include <univalue.h>\n \n+static const std::string WALLET_ENDPOINT_BASE = \"/wallet/\";\n+\n CWallet *GetWalletForJSONRPCRequest(const JSONRPCRequest& request)\n {\n-    // TODO: Some way to access secondary wallets\n-    return vpwallets.empty() ? nullptr : vpwallets[0];\n+    LOCK(cs_main); // for now, protect vpwallets via cs_main\n+\n+    if (vpwallets.empty()) {\n+        return nullptr;\n+    }\n+    else if (request.URI.substr(0, WALLET_ENDPOINT_BASE.size()) == WALLET_ENDPOINT_BASE) {\n+        // wallet endpoint was used\n+        std::string requestedWallet = request.URI.substr(WALLET_ENDPOINT_BASE.size());\n+        for(CWallet* pwallet : vpwallets) {\n+            if (pwallet->GetWalletID() == requestedWallet) {\n+                return pwallet;\n+            }\n+        }\n+        // no wallet found with the given endpoint\n+        throw JSONRPCError(RPC_WALLET_NOT_FOUND, \"Requested wallet not found (\"+SanitizeString(requestedWallet)+\")\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#discussion_r123543935",
      "id" : 123543935,
      "original_commit_id" : "1fa7d7e26b5056c66fabd1bec12c208f4dc963c8",
      "original_position" : 24,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 33,
      "pull_request_review_id" : 45758667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10650",
      "updated_at" : "2017-06-22T15:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/123543935",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "My initial impression was \"I thought we were going to put an RPC api version in the path\" too. FWIW.  I don't know what the norms are in this kind of rpc thing.  Are there parallels in hosted wallet service APIs in the Bitcoin space already?",
      "created_at" : "2017-06-22T18:42:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10650#issuecomment-310467327",
      "id" : 310467327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10650",
      "updated_at" : "2017-06-22T18:42:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/310467327",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
