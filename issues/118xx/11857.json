{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This refactors the tx index code to be in it's own class and get built concurrently with validation code. This pull request needs a lot more testing, but I'm pushing up what I have now for some initial design review. I'd open to whatever feedback people have.\r\n\r\nThe basic idea is that the TxIndex spins up its own thread, which first syncs the txindex to the current block index, then processes new blocks with the BlockConnected ValidationInterface hook. Hopefully this is a model for other indexers that might be desired (such as the [compact filters](https://github.com/bitcoin/bips/pull/609)).\r\n\r\nHere are some design questions I have:\r\n\r\n1. The TxIndex holds a shared_ptr to the block index db (`pblocktree`) along with the validation code. I believe this is safe since [LevelDB docs say concurrent access by multiple threads to a DB object is OK](https://github.com/google/leveldb/blob/master/doc/index.md#concurrency). However, an alternative would be to split the txindex into a separate DB and do a data migration on upgrade.\r\n2. The blocks are enqueued from the ValidationInterface scheduler thread to the TxIndex background thread for processing, though it may be fine to just do the TxIndex write directly in the BlockConnected method.\r\n\r\nIn a sample size n=1 test where I synced nodes from scratch, the average time [Index writing](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L1903) was 3.36ms in master and 1.72ms in this branch. The average time between `UpdateTip` log lines for sequential blocks between 400,000 and IBD end on mainnet was 0.297204s in master and 0.286134s in this branch. Most likely this is just variance in IBD times, but I can try with some more trials if people want.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857/comments",
   "created_at" : "2017-12-08T23:12:40Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857",
   "id" : 280644530,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 11857,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/11857.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11857",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/11857.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11857"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Build tx index in parallel with validation",
   "updated_at" : "2017-12-08T23:12:57Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11857",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
      "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jimpo/followers",
      "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jimpo",
      "id" : 881253,
      "login" : "jimpo",
      "organizations_url" : "https://api.github.com/users/jimpo/orgs",
      "received_events_url" : "https://api.github.com/users/jimpo/received_events",
      "repos_url" : "https://api.github.com/users/jimpo/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jimpo"
   }
}
