[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n* [#24150](https://github.com/bitcoin/bitcoin/pull/24150) (refactor: move index class members from protected to private by jonatack)\n* [#15606](https://github.com/bitcoin/bitcoin/pull/15606) (assumeutxo by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-04-19T03:52:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-822147133",
      "id" : 822147133,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMjE0NzEzMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822147133/reactions"
      },
      "updated_at" : "2022-02-02T17:51:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822147133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function doesn't use any member of BlockManager, so could be stand-alone? Also, I think you can avoid this check by having the caller pass a `const CBlockIndex& start_block`.",
      "commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "created_at" : "2021-04-19T05:49:00Z",
      "diff_hunk" : "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639",
      "id" : 615556639,
      "line" : 1339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTU1NjYzOQ==",
      "original_commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "original_line" : 1339,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 14,
      "pull_request_review_id" : 638479069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T05:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I made the changes as suggested.",
      "commit_id" : "7cb32c39c01c95ae7dce65881707db190fe74aa4",
      "created_at" : "2021-05-13T18:55:13Z",
      "diff_hunk" : "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296",
      "id" : 632032296,
      "in_reply_to_id" : 615556639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjAzMjI5Ng==",
      "original_commit_id" : "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
      "original_line" : 1339,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 659205588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T18:55:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, I think this is an elegant approach.",
      "created_at" : "2021-05-17T18:27:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-842538559",
      "id" : 842538559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjUzODU1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-17T18:27:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842538559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994 \"Add prune blockers to BlockManager\"\r\n\r\nSince this has `EXCLUSIVE_LOCKS_REQUIRED`, I think it should also have `AssertLockHeld` in here too.",
      "commit_id" : "11f01efadf8e93f042ebd05d12f1f3bc5bce8178",
      "created_at" : "2021-05-24T19:42:35Z",
      "diff_hunk" : "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451",
      "id" : 638228451,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODIyODQ1MQ==",
      "original_commit_id" : "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
      "original_line" : 3676,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 667113687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T19:50:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, fixed!",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T22:13:42Z",
      "diff_hunk" : "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082",
      "id" : 638325082,
      "in_reply_to_id" : 638228451,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODMyNTA4Mg==",
      "original_commit_id" : "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
      "original_line" : 3672,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 667236323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T22:13:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03\r\n\r\nnit, `GetLastPrunedBlock`?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:11:22Z",
      "diff_hunk" : "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138",
      "id" : 638347138,
      "line" : 54,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzEzOA==",
      "original_commit_id" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
      "original_line" : 54,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 4,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nnit, `const std::string&`.",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:13:19Z",
      "diff_hunk" : "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828",
      "id" : 638347828,
      "line" : 455,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzgyOA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 455,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nHow can it be `nullptr`?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:15:37Z",
      "diff_hunk" : "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578",
      "id" : 638348578,
      "line" : 2041,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODU3OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 2045,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nShould check/assert it only goes forward when updating?",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:16:45Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949",
      "id" : 638348949,
      "line" : 3674,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODk0OQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3678,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 34,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "d18677006d3d48ca7654039ea6e267164a2690e0\r\n\r\nnit, use ternary? `block ? block : ::ChainActive().Genesis()`",
      "commit_id" : "b5862425806c29fc9628f5c82181658dcea722b3",
      "created_at" : "2021-05-24T23:18:33Z",
      "diff_hunk" : "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497",
      "id" : 638349497,
      "line" : 373,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0OTQ5Nw==",
      "original_commit_id" : "d18677006d3d48ca7654039ea6e267164a2690e0",
      "original_line" : 373,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 95,
      "pull_request_review_id" : 667264075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T23:22:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am not sure. The way I use it right now it can also go down with reorgs. I am undecided what the right course is. Only going up avoids a potential footgun, with going down it could react to (highly unlikely) deep reorg. If I add this I think I would do it so that setting a lower number is simply a no op:\r\n\r\n```\r\nif (m_prune_blockers[name] < block) m_prune_blockers[name] = block;\r\n```",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:05Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761",
      "id" : 640188761,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc2MQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 669625747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:10Z",
      "diff_hunk" : "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783",
      "id" : 640188783,
      "in_reply_to_id" : 638349497,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc4Mw==",
      "original_commit_id" : "d18677006d3d48ca7654039ea6e267164a2690e0",
      "original_line" : 373,
      "original_position" : 71,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 669625774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess it should never be `nullptr`. Dropped that if statement.",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:20Z",
      "diff_hunk" : "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853",
      "id" : 640188853,
      "in_reply_to_id" : 638348578,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODg1Mw==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 2045,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 669625858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:37Z",
      "diff_hunk" : "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945",
      "id" : 640188945,
      "in_reply_to_id" : 638347828,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk0NQ==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 455,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 669625968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:36:45Z",
      "diff_hunk" : "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998",
      "id" : 640188998,
      "in_reply_to_id" : 638347138,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk5OA==",
      "original_commit_id" : "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
      "original_line" : 54,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 669626026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:36:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments by @promag , thank you!\r\n\r\nI also fixed a comment I had overlooked and added a new commit at the end because I realized that we can skip the pruning stuff in `index/base` if the node is not actually pruning. With the new behavior especially this prevents locking `cs_main`. Happy to squash this but I am still checking that this is 100% safe and want to make sure it is looked at separately because it was not included in the existing concept acks.",
      "created_at" : "2021-05-26T23:41:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-849190916",
      "id" : 849190916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0OTE5MDkxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-26T23:41:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849190916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But what should happen if the block is already pruned?",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-05-26T23:41:48Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703",
      "id" : 640190703,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE5MDcwMw==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 669627925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-26T23:41:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-01T12:10:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-852072880",
      "id" : 852072880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjA3Mjg4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T12:10:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852072880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, that would mean the node would have to restart with `-reindex` anyway, right?",
      "commit_id" : "50cd98519097e11936e0efbd0bfa3b33d0317423",
      "created_at" : "2021-06-01T20:46:34Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366",
      "id" : 643467366,
      "in_reply_to_id" : 638348949,
      "line" : 3672,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MzQ2NzM2Ng==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3672,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 36,
      "pull_request_review_id" : 673564476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-01T20:46:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How about keeping some blocks before the deepest prune blocker?\r\n\r\nInteresting. That should help make it a bit more robust. I added this but set it pretty low for now (10), looking for feedback if it should be higher. I also encapsulated the logic for getting the deepest prune height into it's own function to not have more logic in `FlushStateToDisk`.\r\n\r\nAlso rebased.",
      "created_at" : "2021-06-01T23:17:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-852550603",
      "id" : 852550603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjU1MDYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T23:17:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852550603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (292d508e956bfe5b05e6ee685415063c2a0f04af)\r\n\r\nNote: Here and in the other location below there's no more CHECK_NONFATAL so there would be segfault instead of an exception if the tip was null. Doesn't seem like a problem, but if were for some reason, GetLastPrunedBlock argument could be a pointer instead of a reference and the check could be added there.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T15:46:54Z",
      "diff_hunk" : "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388",
      "id" : 644094388,
      "line" : 1072,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDA5NDM4OA==",
      "original_commit_id" : "292d508e956bfe5b05e6ee685415063c2a0f04af",
      "original_line" : 1072,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 10,
      "pull_request_review_id" : 674379812,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T15:49:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nWould be good to have a descriptive comment like:\r\n\r\n```c++\r\n//! Map from external index name to most recent block the index can tolerate being pruned.\r\n//!\r\n//! @note Internally, only blocks at height (block->nHeight + PRUNE_BLOCKER_BUFFER) and\r\n//! below will be pruned, but callers should avoid assuming any particular buffer size.\r\n```",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T16:04:50Z",
      "diff_hunk" : "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721",
      "id" : 644109721,
      "line" : 500,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDEwOTcyMQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 500,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nJust a style suggestion, so feel free to ignore, but usage of this function seems awkward to understand with last_prune being an input and an output parameter. I think FlushStateToDisk would be easier to read with the code in this function just inlined there (which is the only place where it is called).",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T16:12:07Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299",
      "id" : 644115299,
      "line" : 3798,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDExNTI5OQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3802,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 33,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366\r\n\r\n> Hm, that would mean the node would have to restart with `-reindex` anyway, right?\r\n\r\nIt would be nice to have a test for this case if there isn't one. does seem like like if there was reorg and a block needed by the index was pruned, the index should be responsible for handling the error when the rewind method is called. I guess the index could just disable itself or stop the node at that point.\r\n\r\nBut for this `UpdatePruneBlocker` method, it would seem too strict to never allow a blocker to move backwards, because moving an existing blocker backwards seems no worse of a problem than adding new blocker at a lower minimum height. Maybe it could be useful to have a sanity check here which asserts that whenever a new minimum height is set in the map, that no blocks in the (new_min_height, prev_min_height] range have been pruned. But this doesn't seem strictly necessary either if we are confident that indexes compatible with pruning are able to handle pruned block errors safely when they are syncing or handling reorgs",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T17:23:40Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288",
      "id" : 644173288,
      "in_reply_to_id" : 638348949,
      "line" : 3795,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDE3MzI4OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3795,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nWould it make sense to use a log category here `LogPrint(BCLog::PRUNE, ...)` instead of printing unconditionally? Also in the future it could be nice to unify this print with the prints in the FindFilesToPrune functions and print the full pruning status in a consistent way on just one line.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-02T18:06:23Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509",
      "id" : 644205509,
      "line" : 3803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDIwNTUwOQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3807,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 674399868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T18:11:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;\r\n```\r\nShouldn't we subtract here if we want to keep `PRUNE_BLOCKER_BUFFER` blocks **before** the deepest blocker?\r\n\r\nfrom the logs of a test run:\r\n```\r\nnode1 2021-06-19T12:10:06.022496Z [init] [validation.cpp:3803] [GetLastPruneBlockerHeight] coinstatsindex limited pruning to height 10\r\n...\r\nnode1 2021-06-19T12:10:06.044329Z [coinstatsindex] [index/base.cpp:159] [ThreadSync] Syncing coinstatsindex with block chain from height 0\r\n```\r\nnode1 limited pruning to height 10 before it started syncing from height 0.",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-19T10:15:05Z",
      "diff_hunk" : "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191",
      "id" : 654778191,
      "line" : 3800,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc3ODE5MQ==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 3800,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 35,
      "pull_request_review_id" : 687813168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-19T12:31:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wouldn't it make more sense to wait for the indexes to sync *after* pruning?\r\nOtherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nIn general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-19T12:22:15Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987",
      "id" : 654789987,
      "line" : 62,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc4OTk4Nw==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 62,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 62,
      "pull_request_review_id" : 687813168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-19T12:31:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Error building this branch at e365e87a72cc4 rebased to current master at 8cdf91735f2b, looks like it needs updating:\r\n```rake\r\nindex/base.cpp:373:9: error: use of undeclared identifier 'g_chainman'\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n        ^\r\nindex/base.cpp:373:79: error: no member named 'ChainActive' in the global namespace\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n                                                                            ~~^\r\n2 errors generated.\r\n```\r\n",
      "commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "created_at" : "2021-06-28T13:50:49Z",
      "diff_hunk" : "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048",
      "id" : 659805048,
      "line" : 374,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgwNTA0OA==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 374,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 84,
      "pull_request_review_id" : 693981880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T13:50:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Nudge to update.",
      "created_at" : "2021-07-20T10:15:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883275390",
      "id" : 883275390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5840pbZ-",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T10:15:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883275390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removed from high-prio for now due to inactivity, but can be added back",
      "created_at" : "2021-07-20T14:38:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883447438",
      "id" : 883447438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5840qFaO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-20T14:38:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883447438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-07-28T17:10:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-888476972",
      "id" : 888476972,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII58409RUs",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-28T17:10:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888476972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "right ð thanks, fixed!",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T22:58:17Z",
      "diff_hunk" : "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378",
      "id" : 702488378,
      "in_reply_to_id" : 654778191,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODM3OA==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 3800,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746690769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T22:58:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I agree, I added a log category. I am leaving unifying for a potential follow-up to not complicate this PR further.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:08Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632",
      "id" : 702488632,
      "in_reply_to_id" : 644205509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODYzMg==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3807,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746691001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:01:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added!",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:39Z",
      "diff_hunk" : "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725",
      "id" : 702488725,
      "in_reply_to_id" : 644109721,
      "line" : 497,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODcyNQ==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 497,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 746691034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:01:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:01:59Z",
      "diff_hunk" : "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743",
      "id" : 702488743,
      "in_reply_to_id" : 644115299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODc0Mw==",
      "original_commit_id" : "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
      "original_line" : 3802,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 746691065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:02:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, fixed.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:02:32Z",
      "diff_hunk" : "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827",
      "id" : 702488827,
      "in_reply_to_id" : 659805048,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODgyNw==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 374,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 746691118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Wouldn't it make more sense to wait for the indexes to sync _after_ pruning?\r\n> Otherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nYes, that would be good, but unless I am misunderstanding your comment, what we would be testing then is a race condition which would make the test flaky.\r\n\r\n> In general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)\r\n\r\nyes, I added two sanity checks for the exact prune blocker height by checking the logs\r\n",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:05:33Z",
      "diff_hunk" : "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106",
      "id" : 702489106,
      "in_reply_to_id" : 654789987,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4OTEwNg==",
      "original_commit_id" : "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
      "original_line" : 68,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 68,
      "pull_request_review_id" : 746691401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:05:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "True, I changed the function to take a pointer and added a CHECK_NONFATAL to be more consistent with the previous code.",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:30:04Z",
      "diff_hunk" : "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020",
      "id" : 702492020,
      "in_reply_to_id" : 644094388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5MjAyMA==",
      "original_commit_id" : "292d508e956bfe5b05e6ee685415063c2a0f04af",
      "original_line" : 1075,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 746693619,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I added functional tests for the -reindex case.\r\n\r\nI am looking into the sanity check assert idea don't have a clear opinion yet.\r\n\r\n",
      "commit_id" : "89f0373f998683030d545b0078dea108edd6ccbf",
      "created_at" : "2021-09-05T23:37:40Z",
      "diff_hunk" : "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978",
      "id" : 702492978,
      "in_reply_to_id" : 638348949,
      "line" : 3662,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5Mjk3OA==",
      "original_commit_id" : "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
      "original_line" : 3662,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 746694375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-05T23:37:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.",
      "created_at" : "2021-09-05T23:38:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-913247703",
      "id" : 913247703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842bw3X",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-05T23:38:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913247703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.\r\n\r\nThanks for updating this! I want to review it more soon, and it would be great to have feedback also from @jamesob because I think there is or could be some interaction between this and https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-692965905:\r\n\r\n>* More straightforward approach to pruning. Instead of having to write special case pruning logic, this could be integrated with [Improve Indices on pruned nodes via prune blockers #21726](https://github.com/bitcoin/bitcoin/pull/21726), and each chainstate could just add to a list of prune blockers (ranges of blocks not allowed to be pruned) and pruning code would not need to be aware of assumeutxo states.",
      "created_at" : "2021-09-07T14:46:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914368128",
      "id" : 914368128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842gCaA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T14:50:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914368128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> it would be great to have feedback also from @jamesob\r\n\r\nYep, will plan to review this in the next few days.",
      "created_at" : "2021-09-07T15:09:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914391121",
      "id" : 914391121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5842gIBR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-07T15:09:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914391121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/21726/commits/2c815adc881fa90f14887e2ec33ccb11ef964387\r\n\r\nNote: ensured `active_chain.Tip()` will not ever be nullptr here because `g_txindex` et al are started in init.cpp after genesis block load.",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-09T13:53:02Z",
      "diff_hunk" : "@@ -72,11 +72,7 @@ bool BaseIndex::Init()\n         if (!m_best_block_index) {\n             // index is not built yet\n             // make sure we have all block data back to the genesis\n-            const CBlockIndex* block = active_chain.Tip();\n-            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-                block = block->pprev;\n-            }\n-            prune_violation = block != active_chain.Genesis();\n+            prune_violation = GetLastPrunedBlock(active_chain.Tip()) != active_chain.Genesis();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682",
      "id" : 705355682,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM1NTY4Mg==",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 75,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 22,
      "pull_request_review_id" : 750371858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-09T15:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/21726/commits/9c70676aded6e2c9c4719fd5039f27a2c16a54fb\r\n\r\nI'm curious why the method below is marked as requiring cs_main, but this data structure isn't marked as guarded by cs_main - is that intentional?",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-09T14:13:57Z",
      "diff_hunk" : "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815",
      "id" : 705377815,
      "line" : 499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM3NzgxNQ==",
      "original_commit_id" : "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
      "original_line" : 499,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 750371858,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-09T15:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: make the code match the log statement (`pruneheight` is here still set to 248 while the indices best block is 700)\r\n```suggestion\r\n            assert_greater_than(pruneheight_new, 700)\r\n```\r\n",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-11T12:50:40Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540",
      "id" : 706609540,
      "line" : 109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYwOTU0MA==",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 109,
      "pull_request_review_id" : 751916636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-11T15:13:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I am able to put any value here besides 690 and the test still passes.\r\n\r\nThis is because [`assert_debug_log`](https://github.com/bitcoin/bitcoin/blob/5c0f46ca46e23a161649b5150baa01020dc85e48/test/functional/test_framework/test_node.py#L381) is a generator and meant to be used in combination with `with`:\r\n```python\r\nwith assert_debug_log(...):\r\n  # some other code that prints the (un)expected logs\r\n```\r\n\"At the point where the generator yields, the block nested in the [`with`](https://docs.python.org/3/reference/compound_stmts.html#with) statement is executed. The generator is then resumed after the block is exited. [...]\" from https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager\r\n\r\nSecondly i think that checking the logs to test the prune blocker height won't work here as the expected message is only printed when pruning is attempted (https://github.com/bitcoin/bitcoin/blob/983a3552f22678d4466e0faa8e784f25b145a76b/src/validation.cpp#L2027)\r\n\r\nthe following would work:\r\n```python\r\n self.log.info(\"prune some blocks\")\r\n for node in self.nodes[:2]:\r\n     with node.assert_debug_log(['limited pruning to height 690']):\r\n         pruneheight = node.pruneblockchain(400)\r\n         assert_equal(pruneheight, 248)\r\n```\r\n",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-11T15:04:47Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557",
      "id" : 706623557,
      "line" : 70,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYyMzU1Nw==",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 70,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 70,
      "pull_request_review_id" : 751916636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-11T15:13:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (2c815adc881fa90f14887e2ec33ccb11ef964387)\r\n\r\nThis doesn't seem to actually return the last block that is pruned. It seems to return the next block that has data. So maybe should be called `GetFirstNonPrunedBlock`? It also seems like `pruneblockchain` RPC documentation describes this incorrectly while `getblockchaininfo` describes it correctly.",
      "commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "created_at" : "2021-09-20T17:28:51Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589",
      "id" : 712372589,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584qdfFt",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : 51,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 758911426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : 51,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-20T17:29:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not intentional, just an oversight. Fixed!",
      "commit_id" : "2f0ad7fcc5dde3932bd6d0def98873bbe81f19e9",
      "created_at" : "2021-09-22T21:59:31Z",
      "diff_hunk" : "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113",
      "id" : 714341113,
      "in_reply_to_id" : 705377815,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qk_r5",
      "original_commit_id" : "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
      "original_line" : 499,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 761445223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T21:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense, fixed!",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T21:59:55Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348",
      "id" : 714341348,
      "in_reply_to_id" : 706609540,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qk_vk",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : null,
      "pull_request_review_id" : 761445463,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T21:59:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "True, I fixed this and went with with the name `GetFirstStoredBlock` inspired by the docs in `getblockchaininfo`. I also added an extra commit to fix the docs in `pruneblockchain`. I think fixing the docs is the right approach rather than change the behavior but I kept it in the separate commit in case there are different opinions on that.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T22:02:39Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652",
      "id" : 714342652,
      "in_reply_to_id" : 712372589,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlAD8",
      "original_commit_id" : "2c815adc881fa90f14887e2ec33ccb11ef964387",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : 51,
      "path" : "src/node/blockstorage.h",
      "position" : null,
      "pull_request_review_id" : 761447114,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-09-22T22:02:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks a lot for the detailed feedback! I fixed this using your suggested approach in the two locations where I wanted to do the check.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-22T22:09:36Z",
      "diff_hunk" : "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854",
      "id" : 714345854,
      "in_reply_to_id" : 706623557,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584qlA1-",
      "original_commit_id" : "983a3552f22678d4466e0faa8e784f25b145a76b",
      "original_line" : 70,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : null,
      "pull_request_review_id" : 761451347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-22T22:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: Introduce GetFirstStoredlock helper function\" (4ebe3a51da88589f23e243045a9e392701dfbbad)\r\n\r\nFunction name is spelled wrong in commit message",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T02:11:16Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353",
      "id" : 714427353,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584qlUvZ",
      "original_commit_id" : "4ebe3a51da88589f23e243045a9e392701dfbbad",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nCan we add an assert here:\r\n\r\n```\r\nassert(!fPruneMode || AllowPrune());\r\n```\r\n\r\nI know there is startup code that prevents the indexes which don't support AllowPrune from being enabled at the same time as the prune option, but you could imagine someone adding a new index where AllowPrune is false, and someone forgets to add the startup check. Or if the startup check just happens to be buggy, it would be good to have this check to detect the problem.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T17:52:44Z",
      "diff_hunk" : "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559",
      "id" : 715026559,
      "line" : 369,
      "node_id" : "PRRC_kwDOABII584qnnB_",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 369,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 80,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI think it would be good if the commit message noted the minor change in behavior here: Previously pruning code would keep the blockfilter index best block and later blocks, and now an extra 10 previous blocks(PRUNE_BLOCKER_BUFFER) will be kept.",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T18:33:43Z",
      "diff_hunk" : "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451",
      "id" : 715054451,
      "line" : 1948,
      "node_id" : "PRRC_kwDOABII584qnt1z",
      "original_commit_id" : "7db7f26e97665c048b3f614c092899addd658f4f",
      "original_line" : 1948,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Skip pruning checks when node is not pruning\" (70b9e4f6abda5d6dd38504d9149ddc79b33961ce)\r\n\r\nWhat is the motivation for this commit? It just seems to be disabling error checking and making the code more complicated and interdependent. Is there a real performance benefit or some other reason to do this?",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T18:40:49Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159",
      "id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584qnu_X",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI'm seeing a segfault this line starting in the \"Index: Use prune blockers\" commit and continuing up to the \"\"Index: Skip pruning checks\" commit in the `feature_blockfilterindex_prune.py` test because `blocker.second` is null. It would probably be good to not insert null prune blockers or just ignore them.\r\n\r\n```\r\n#0  0x000055555583d8a6 in CChainState::FlushStateToDisk (this=0x555555e46f10, state=..., mode=FlushStateMode::IF_NEEDED, nManualPruneHeight=0) at validation.cpp:1948\r\n#1  0x0000555555849e51 in CChainState::ConnectTip (this=0x555555e46f10, state=..., pindexNew=0x7fffac001000, pblock=..., connectTrace=..., disconnectpool=...) at validation.cpp:2288\r\n#2  0x000055555584f7f2 in CChainState::ActivateBestChainStep (this=0x555555e46f10, state=..., pindexMostWork=0x7fffac001000, pblock=std::shared_ptr<const CBlock> (empty) = {...}, fInvalidFound=@0x7fffa7ffe32f: false, connectTrace=...)\r\n    at validation.cpp:2432\r\n#3  0x000055555584fff8 in CChainState::ActivateBestChain (this=<optimized out>, state=..., pblock=std::shared_ptr<const CBlock> (empty) = {...}) at validation.cpp:2557\r\n#4  0x00005555556c77fd in ThreadImport (chainman=..., vImportFiles=std::vector of length 0, capacity 0, args=...) at node/blockstorage.cpp:555\r\n#5  0x0000555555633850 in operator() (__closure=0x7fffac000b60) at init.cpp:1656\r\n#6  std::__invoke_impl<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__f=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#7  std::__invoke_r<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__fn=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:110\r\n#8  std::_Function_handler<void(), AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> >::_M_invoke(const std::_Any_data &) (__functor=...)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:291\r\n#9  0x0000555555b0ef5f in std::function<void ()>::operator()() const (this=0x7fffa7ffeb70) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:622\r\n#10 util::TraceThread(char const*, std::function<void ()>) (thread_name=<optimized out>, thread_func=...) at util/thread.cpp:18\r\n#11 0x000055555563376b in std::__invoke_impl<void, void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (\r\n    __f=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#12 std::__invoke<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (__fn=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:95\r\n#13 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::_M_invoke<0, 1, 2> (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:264\r\n#14 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::operator() (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:271\r\n#15 std::thread::_State_impl<std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > > >::_M_run(void) (this=0x555555e7f7e0)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:215\r\n#16 0x00007ffff7eaaca0 in ?? () from /nix/store/dzaadhn5y56da24635icafv1nrawxm4n-gcc-10.3.0-lib/lib/../lib64/libstdc++.so.6\r\n#17 0x00007ffff7fb1e9e in start_thread () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libpthread.so.0\r\n#18 0x00007ffff774949f in clone () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libc.so.6\r\n```",
      "commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "created_at" : "2021-09-23T19:31:22Z",
      "diff_hunk" : "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019",
      "id" : 715093019,
      "line" : 1948,
      "node_id" : "PRRC_kwDOABII584qn3Qb",
      "original_commit_id" : "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
      "original_line" : 1952,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 21,
      "pull_request_review_id" : 761541915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-23T19:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-27T13:27:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-927875079",
      "id" : 927875079,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843TkAH",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-27T13:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927875079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:33Z",
      "diff_hunk" : "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137",
      "id" : 718948137,
      "in_reply_to_id" : 714427353,
      "line" : 52,
      "node_id" : "PRRC_kwDOABII584q2kcp",
      "original_commit_id" : "4ebe3a51da88589f23e243045a9e392701dfbbad",
      "original_line" : 52,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.h",
      "position" : 5,
      "pull_request_review_id" : 767267690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:46Z",
      "diff_hunk" : "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229",
      "id" : 718948229,
      "in_reply_to_id" : 715026559,
      "line" : 369,
      "node_id" : "PRRC_kwDOABII584q2keF",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 369,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 80,
      "pull_request_review_id" : 767267785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a note in the commit message",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:18:56Z",
      "diff_hunk" : "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310",
      "id" : 718948310,
      "in_reply_to_id" : 715054451,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII584q2kfW",
      "original_commit_id" : "7db7f26e97665c048b3f614c092899addd658f4f",
      "original_line" : 1954,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 767267863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I did not do performance tests on this change, it will probably not be huge but if we can get it, why not? But my main motivation is that I think that these checks are not necessary unless the conditions hold. I think it makes code easier to understand if sections that are not relevant are skipped explicitly. But I can see how this might be missing a comment for clarity, happy to add that if you agree.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:19:08Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387",
      "id" : 718948387,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584q2kgj",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 767267957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:19:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, TIL that `Genesis()` can return a `nullptr` and does so initially when reindexing. I never really checked and assumed this couldn't happen since the Genesis block is hardcoded. Well, good to know and this should be fixed now.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-29T23:22:40Z",
      "diff_hunk" : "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709",
      "id" : 718949709,
      "in_reply_to_id" : 715093019,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII584q2k1N",
      "original_commit_id" : "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
      "original_line" : 1954,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 21,
      "pull_request_review_id" : 767269509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-29T23:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and addressed @ryanofsky 's comments. Thanks for reviewing!",
      "created_at" : "2021-09-29T23:23:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-930617542",
      "id" : 930617542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843eBjG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-29T23:23:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930617542",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it makes code easier to understand if sections that are not relevant are skipped explicitly.\r\n\r\nI would love to visit the planet where `if (!m_synced && (fPruneMode || fHavePruned) && !fReindex)` is easier to understand than `if (!m_synced)`. In general I don't think code is easier to read with special cases, and all else equal I wouldn't think that skipping checks would be a great idea even if did make code simpler. But this isn't very important. Would suggest dropping this commit, but it seems fine to keep it or let others weigh in. Thanks at least for splitting this change up nicely so it is easy to understand in sequence.",
      "commit_id" : "f6766d436b22ac595f6e13d365d07af37dbc0ebd",
      "created_at" : "2021-09-30T16:51:01Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304",
      "id" : 719590304,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584q5BOg",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 768112450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-30T17:07:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-30T20:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-931643046",
      "id" : 931643046,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843h76m",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931643046/reactions"
      },
      "updated_at" : "2021-09-30T20:31:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931643046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r720875101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree with you that the line is harder to understand after the change but in exchange for that, it makes explicit that the code inside the block is only relevant and needs to run if this evaluates to true. Let's wait for more feedback as a tie-breaker, of course, I am happy to remove it if others agree with you :)",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-03T19:25:36Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r720875101",
      "id" : 720875101,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584q965d",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 769618940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-03T19:25:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and beefed up the wait time one last block sync that caused a CI failure previously. I think it was a normal timeout because I could not reproduce it locally and there are a lot of blocks being produced. Comparable tests in terms of number of blocks also use longer sync times.\r\n\r\nI kindly ask other reviewers to weigh in on @ryanofsky 's feedback here if you have a preference: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159",
      "created_at" : "2021-10-03T20:04:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-933016580",
      "id" : 933016580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843nLQE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933016580/reactions"
      },
      "updated_at" : "2021-10-03T20:04:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933016580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r722607995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> it makes explicit that the code inside the block is only relevant and needs to run if this evaluates to true\r\n\r\nI don't have a strong opinion but i agree with this statement and think the change should stay.",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-05T19:53:30Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r722607995",
      "id" : 722607995,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584rEh97",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 771922093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-05T19:53:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will have a look.",
      "created_at" : "2021-10-05T19:59:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-934744129",
      "id" : 934744129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5843txBB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934744129/reactions"
      },
      "updated_at" : "2021-10-05T19:59:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934744129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723316569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note to self, check if #22932 lock annotations/guards need to be updated if this pull is merged (at first look tentatively seems ok).",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:09:25Z",
      "diff_hunk" : "@@ -51,6 +51,15 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block) {\n+    CHECK_NONFATAL(start_block);\n+    const CBlockIndex* last_block = start_block;\n+    while (last_block->pprev && (last_block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723316569",
      "id" : 723316569,
      "line" : 57,
      "node_id" : "PRRC_kwDOABII584rHO9Z",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 57,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723322094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "19c360e\r\n```suggestion\r\n                    RPCResult::Type::NUM, \"\", \"The height of the first block that is still stored after pruning.\"},\r\n```",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:14:56Z",
      "diff_hunk" : "@@ -1031,7 +1031,7 @@ static RPCHelpMan pruneblockchain()\n             \"                  to prune blocks whose block time is at least 2 hours older than the provided timestamp.\"},\n                 },\n                 RPCResult{\n-                    RPCResult::Type::NUM, \"\", \"Height of the last block pruned\"},\n+                    RPCResult::Type::NUM, \"\", \"Height of the first block that is still stored after pruning\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723322094",
      "id" : 723322094,
      "line" : 1034,
      "node_id" : "PRRC_kwDOABII584rHQTu",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 1034,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 5,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723323453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453"
         }
      },
      "author_association" : "MEMBER",
      "body" : "18e768f\r\n```suggestion\r\n/** The number of blocks to keep below the deepest prune blocker. */\r\n```",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:16:06Z",
      "diff_hunk" : "@@ -88,6 +88,8 @@ static const unsigned int DEFAULT_CHECKLEVEL = 3;\n // one 128MB block file + added 15% undo data = 147MB greater for a total of 545MB\n // Setting the target to >= 550 MiB will make it likely we can respect the target.\n static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n+/** Blocks to keep below deepest prune blocker */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723323453",
      "id" : 723323453,
      "line" : 91,
      "node_id" : "PRRC_kwDOABII584rHQo9",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 91,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723329132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "18e768f Perhaps just inline this one-line function.",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:21:16Z",
      "diff_hunk" : "@@ -3594,6 +3599,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723329132",
      "id" : 723329132,
      "line" : 3604,
      "node_id" : "PRRC_kwDOABII584rHSBs",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 3604,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 37,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723340964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "18e768f missing headers for `unordered_map` and `std::min/max` in this commit\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -54,9 +54,11 @@\r\n #include <warnings.h>\r\n \r\n+#include <algorithm>\r\n #include <numeric>\r\n #include <optional>\r\n #include <string>\r\n+#include <unordered_map>\r\n\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -34,6 +34,7 @@\r\n #include <thread>\r\n+#include <unordered_map>\r\n #include <utility>\r\n```\r\n",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:33:02Z",
      "diff_hunk" : "@@ -480,6 +482,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723340964",
      "id" : 723340964,
      "line" : 491,
      "node_id" : "PRRC_kwDOABII584rHU6k",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 491,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723343409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409"
         }
      },
      "author_association" : "MEMBER",
      "body" : "18e768f style nits and missing space\r\n```diff\r\n-            for (auto const& blocker : m_blockman.m_prune_blockers) {\r\n-                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;\r\n+            for (const auto& blocker : m_blockman.m_prune_blockers) {\r\n+                const int blocker_height{blocker.second->nHeight - PRUNE_BLOCKER_BUFFER};\r\n                 if (last_prune == blocker_height) {\r\n-                    LogPrint(BCLog::PRUNE,\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);\r\n+                    LogPrint(BCLog::PRUNE, \"%s limited pruning to height %d\\n\", blocker.first, blocker_height);\r\n```\r\n",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T14:35:21Z",
      "diff_hunk" : "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723343409",
      "id" : 723343409,
      "in_reply_to_id" : 715093019,
      "line" : 1954,
      "node_id" : "PRRC_kwDOABII584rHVgx",
      "original_commit_id" : "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
      "original_line" : 1954,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 21,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723377801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "1b51e212 see #22741\r\n```suggestion\r\n            self.generate(self.nodes[0], 250)\r\n```",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T15:08:42Z",
      "diff_hunk" : "@@ -0,0 +1,132 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723377801",
      "id" : 723377801,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII584rHd6J",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 46,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-06T15:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723411364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "86121153164a05a5d not sure, but it seems there should be a demonstrated clear improvement and documentation of the intention in both places.",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T15:43:31Z",
      "diff_hunk" : "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723411364",
      "id" : 723411364,
      "in_reply_to_id" : 715059159,
      "line" : 70,
      "node_id" : "PRRC_kwDOABII584rHmGk",
      "original_commit_id" : "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
      "original_line" : 70,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 12,
      "pull_request_review_id" : 772759286,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-07T14:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723429759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This test is now time-consuming enough (16 minutes for me locally) that it might be best to place it in the extended scripts. Or at least, at the top (rather than the bottom) of the base scripts. Even better, find a way to speed it up :)\r\n```python\r\nEXTENDED_SCRIPTS = [\r\n    # These tests are not run by default.\r\n    # Longest test should go first, to favor running tests in parallel\r\n    'feature_pruning.py',\r\n    'feature_dbcrash.py',\r\n]\r\n\r\nBASE_SCRIPTS = [\r\n    # Scripts that are run by default.\r\n    # Longest test should go first, to favor running tests in parallel\r\n```\r\n```\r\n$ test/functional/feature_index_prune.py --timeout-factor=0\r\n2021-10-06T15:50:22.006000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_arh_064q\r\n2021-10-06T15:50:23.815000Z TestFramework (INFO): check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\r\n2021-10-06T15:54:06.653000Z TestFramework (INFO): prune some blocks\r\n2021-10-06T15:54:06.656000Z TestFramework (INFO): check if we can access the tips blockfilter and coinstats when we have pruned some blocks\r\n2021-10-06T15:54:06.732000Z TestFramework (INFO): check if we can access the blockfilter and coinstats of a pruned block\r\n2021-10-06T15:54:06.767000Z TestFramework (INFO): restart nodes without indices\r\n2021-10-06T15:54:09.197000Z TestFramework (INFO): make sure trying to access the indices throws errors\r\n2021-10-06T15:55:15.675000Z TestFramework (INFO): prune further than the indices best blocks while the indices are disabled\r\n2021-10-06T15:55:16.536000Z TestFramework (INFO): make sure we get an init error when starting the nodes again with the indices\r\n2021-10-06T15:55:18.413000Z TestFramework (INFO): make sure the nodes start again with the indices and an additional -reindex arg\r\n2021-10-06T16:06:34.500000Z TestFramework (INFO): Stopping nodes\r\n2021-10-06T16:06:35.271000Z TestFramework (INFO): Cleaning up /tmp/bitcoin_func_test_arh_064q on exit\r\n2021-10-06T16:06:35.271000Z TestFramework (INFO): Tests successful\r\n```\r\n",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-10-06T15:59:24Z",
      "diff_hunk" : "@@ -310,7 +310,7 @@\n     'feature_help.py',\n     'feature_shutdown.py',\n     'p2p_ibd_txrelay.py',\n-    'feature_blockfilterindex_prune.py'\n+    'feature_index_prune.py'",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723429759",
      "id" : 723429759,
      "line" : 313,
      "node_id" : "PRRC_kwDOABII584rHql_",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 313,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_runner.py",
      "position" : 5,
      "pull_request_review_id" : 772934310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-07T14:53:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "still not fixed?",
      "commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "created_at" : "2021-11-09T12:10:25Z",
      "diff_hunk" : "@@ -0,0 +1,132 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769",
      "id" : 745556769,
      "in_reply_to_id" : 723377801,
      "line" : 46,
      "node_id" : "PRRC_kwDOABII584scEsh",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : 46,
      "pull_request_review_id" : 801198814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-09T12:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Test failue: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769",
      "created_at" : "2021-11-10T17:26:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-965570260",
      "id" : 965570260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5845jW7U",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965570260/reactions"
      },
      "updated_at" : "2021-11-10T17:26:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965570260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-11-16T04:03:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-969837222",
      "id" : 969837222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5845zoqm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969837222/reactions"
      },
      "updated_at" : "2021-11-16T04:03:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969837222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, 16 minutes? There must be something off. The test takes ~40 seconds on my (5+ year old) laptop. Can you check again if there wasn't another cause and maybe share some more info?\r\n\r\n```\r\n$ test/functional/feature_index_prune.py\r\n2021-12-04T23:40:35.661000Z TestFramework (INFO): Initializing test directory /var/folders/9z/n7rz_6cj3bq__11k5kcrsvvm0000gn/T/bitcoin_func_test_t25asmxj\r\n2021-12-04T23:40:36.639000Z TestFramework (INFO): check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\r\n2021-12-04T23:40:43.562000Z TestFramework (INFO): prune some blocks\r\n2021-12-04T23:40:43.566000Z TestFramework (INFO): check if we can access the tips blockfilter and coinstats when we have pruned some blocks\r\n2021-12-04T23:40:43.595000Z TestFramework (INFO): check if we can access the blockfilter and coinstats of a pruned block\r\n2021-12-04T23:40:43.615000Z TestFramework (INFO): restart nodes without indices\r\n2021-12-04T23:40:44.986000Z TestFramework (INFO): make sure trying to access the indices throws errors\r\n2021-12-04T23:40:53.843000Z TestFramework (INFO): prune further than the indices best blocks while the indices are disabled\r\n2021-12-04T23:40:54.330000Z TestFramework (INFO): make sure we get an init error when starting the nodes again with the indices\r\n2021-12-04T23:40:55.357000Z TestFramework (INFO): make sure the nodes start again with the indices and an additional -reindex arg\r\n2021-12-04T23:41:14.996000Z TestFramework (INFO): Stopping nodes\r\n2021-12-04T23:41:15.223000Z TestFramework (INFO): Cleaning up /var/folders/9z/n7rz_6cj3bq__11k5kcrsvvm0000gn/T/bitcoin_func_test_t25asmxj on exit\r\n2021-12-04T23:41:15.223000Z TestFramework (INFO): Tests successful\r\n```",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T01:03:58Z",
      "diff_hunk" : "@@ -310,7 +310,7 @@\n     'feature_help.py',\n     'feature_shutdown.py',\n     'p2p_ibd_txrelay.py',\n-    'feature_blockfilterindex_prune.py'\n+    'feature_index_prune.py'",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496308",
      "id" : 762496308,
      "in_reply_to_id" : 723429759,
      "line" : 319,
      "node_id" : "PRRC_kwDOABII584tcsU0",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 319,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_runner.py",
      "position" : 5,
      "pull_request_review_id" : 823340263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496308/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T01:03:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496332"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T01:04:30Z",
      "diff_hunk" : "@@ -1031,7 +1031,7 @@ static RPCHelpMan pruneblockchain()\n             \"                  to prune blocks whose block time is at least 2 hours older than the provided timestamp.\"},\n                 },\n                 RPCResult{\n-                    RPCResult::Type::NUM, \"\", \"Height of the last block pruned\"},\n+                    RPCResult::Type::NUM, \"\", \"Height of the first block that is still stored after pruning\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496332",
      "id" : 762496332,
      "in_reply_to_id" : 723322094,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tcsVM",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 1034,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 823340279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496332/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T01:04:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496332",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T01:04:41Z",
      "diff_hunk" : "@@ -0,0 +1,132 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496364",
      "id" : 762496364,
      "in_reply_to_id" : 723377801,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tcsVs",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 46,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/feature_index_prune.py",
      "position" : null,
      "pull_request_review_id" : 823340291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T01:04:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T01:04:58Z",
      "diff_hunk" : "@@ -480,6 +482,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496381",
      "id" : 762496381,
      "in_reply_to_id" : 723340964,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII584tcsV9",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 490,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 27,
      "pull_request_review_id" : 823340298,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T01:04:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496386"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T01:05:15Z",
      "diff_hunk" : "@@ -88,6 +88,8 @@ static const unsigned int DEFAULT_CHECKLEVEL = 3;\n // one 128MB block file + added 15% undo data = 147MB greater for a total of 545MB\n // Setting the target to >= 550 MiB will make it likely we can respect the target.\n static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n+/** Blocks to keep below deepest prune blocker */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762496386",
      "id" : 762496386,
      "in_reply_to_id" : 723323453,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584tcsWC",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 91,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 823340305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496386/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T01:05:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762496386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762588228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762588228"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I would like to keep this setter, it feels more clean to me.",
      "commit_id" : "deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-05T16:52:18Z",
      "diff_hunk" : "@@ -3594,6 +3599,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r762588228",
      "id" : 762588228,
      "in_reply_to_id" : 723329132,
      "line" : 3679,
      "node_id" : "PRRC_kwDOABII584tdCxE",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 3679,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 49,
      "pull_request_review_id" : 823412314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762588228/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-05T16:52:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/762588228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and addressed all of @jonatack 's comments (I still can't figure out why GitHub lets me comment on and close some comments and not others).\r\n\r\nI also decided to drop the last commit that @ryanofsky [wasn't very happy with](https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304) in order to make the rest of the review process a bit easier hopefully. In general, I think the whole topic \"are we pruning? do we have to do something about that or not?\" is a bit messy and I will tackle that more holistically in a future PR.",
      "created_at" : "2021-12-05T16:58:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-986265146",
      "id" : 986265146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5846yTY6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986265146/reactions"
      },
      "updated_at" : "2021-12-05T16:58:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/986265146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK deaa5f537bf21c33c8eb8ca0c276172a6a225f67",
      "created_at" : "2021-12-08T22:51:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-989291518",
      "id" : 989291518,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII584692P-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989291518/reactions"
      },
      "updated_at" : "2021-12-08T22:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/989291518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-12-13T12:48:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-992444254",
      "id" : 992444254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847J39e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/992444254/reactions"
      },
      "updated_at" : "2021-12-13T12:48:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/992444254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Another two rebases later...\r\n\r\nUnfortunately there were some significant changes merged to the functional test, so there is a bit more to re-review this time ð¢  Also these changes have more than doubled the runtime of the test for me. I have tried some simple optimizations but wasn't successful it getting a meaningful speedup so far. I will revisit speeding up the tests in a follow-up because I don't want to block review here further.\r\n\r\nThat is, unless the test is now too slow to run on some machines now. Please test it again on your toaster, @jonatack ;)",
      "created_at" : "2021-12-17T00:07:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-996289321",
      "id" : 996289321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847Yisp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996289321/reactions"
      },
      "updated_at" : "2021-12-17T00:07:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/996289321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r771982707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771982707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic fails if a reorg happens removing deeper than the blocker's block.",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2021-12-19T18:08:13Z",
      "diff_hunk" : "@@ -2222,12 +2222,18 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n-            });\n+\n+            for (const auto& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height{blocker.second->nHeight - PRUNE_BLOCKER_BUFFER};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r771982707",
      "id" : 771982707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uA4Vz",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 2230,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 835889749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771982707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T03:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771982707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r771986890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771986890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer to use \"lock\" over \"block\", since the latter is too easily confused with blockchain blocks.",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2021-12-19T18:49:57Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r771986890",
      "id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uA5XK",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 835889749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771986890/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T03:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/771986890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r772804817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772804817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can be fixed with something like 55f04cf1dd0f36981e3d09c180da52e11c974575",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2021-12-21T03:33:01Z",
      "diff_hunk" : "@@ -2222,12 +2222,18 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n-            });\n+\n+            for (const auto& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height{blocker.second->nHeight - PRUNE_BLOCKER_BUFFER};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r772804817",
      "id" : 772804817,
      "in_reply_to_id" : 771982707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uEBDR",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 2230,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 835889749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772804817/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T03:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772804817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r772805155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772805155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Better to just use a height here, I think. See 598b0d8dbf5793c60c63dc2a181a49291fe8011b",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2021-12-21T03:34:15Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r772805155",
      "id" : 772805155,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uEBIj",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 467,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 835889749,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772805155/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-12-21T03:36:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772805155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, was just working on my own version of this when luke-jr alerted me to this PR. Thanks for doing the work so I can just cherry-pick haha :-)\r\n\r\nOne thing I'm wondering: have you considered having `CChainState` \"pull\" the `blocker_height` from blockers when necessary instead of requiring blockers to update `CChainState` every time their `blocker_height` changes?",
      "created_at" : "2021-12-23T00:32:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-999959419",
      "id" : 999959419,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847mit7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999959419/reactions"
      },
      "updated_at" : "2021-12-23T00:32:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999959419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">One thing I'm wondering: have you considered having CChainState \"pull\" the blocker_height from blockers when necessary instead of requiring blockers to update CChainState every time their blocker_height changes?\r\n\r\nThat won't work for external or offline blockers. In #19463, my primary goal is to support tools like Armory or Lightning nodes that require parsing the block data, as well as ensuring pruning doesn't invalidate wallet backups (even of offline wallets).",
      "created_at" : "2021-12-23T00:38:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-999961230",
      "id" : 999961230,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847mjKO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999961230/reactions"
      },
      "updated_at" : "2021-12-23T00:38:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999961230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > One thing I'm wondering: have you considered having CChainState \"pull\" the blocker_height from blockers when necessary instead of requiring blockers to update CChainState every time their blocker_height changes?\r\n> \r\n> That won't work for external or offline blockers. In #19463, my primary goal is to support tools like Armory or Lightning nodes that require parsing the block data, as well as ensuring pruning doesn't invalidate wallet backups (even of offline wallets).\r\n\r\nThe way I think this would work is: if `CChainState` asks `WalletBlocker` about the lowest prunable block, and the wallet is offline, `WalletBlocker` would just reply with the last one it knows about. I see in your original PR you planned on persisting blockers, so in my mind upon initialization, `WalletBlocker` would just load up the persisted file.\r\n\r\nLmk if that makes sense. In my mind, all else being equal, a \"pull\" configuration is more likely to be correct since blockers won't have to worry about forgetting to update their `blocker_height`, and avoids the need to constantly notify CChainState.",
      "created_at" : "2021-12-23T00:52:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-999965962",
      "id" : 999965962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847mkUK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999965962/reactions"
      },
      "updated_at" : "2021-12-23T00:52:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999965962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">The way I think this would work is: if CChainState asks WalletBlocker about the lowest prunable block, and the wallet is offline, WalletBlocker would just reply with the last one it knows about.\r\n\r\nNo reason it would be limited to wallets, though. It ends up back to BlockManager keeping track of them all - not sure what the issue is with this? It seems perfectly in line with its role?\r\n\r\n>In my mind, all else being equal, a \"pull\" configuration is more likely to be correct since blockers won't have to worry about forgetting to update their blocker_height, and avoids the need to constantly notify CChainState.\r\n\r\nFor each block, indexes will move their lock one height later - pull or push doesn't matter in this scenario. But other locks might not move right away, so keeping track in the BlockManager avoids unnecessary interaction between them. It also allows BlockManager to shift backward any locks that will be impacted by a reorganization, preventing pruning of those blocks before the clients even know they need an older height.",
      "created_at" : "2021-12-23T00:59:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-999968520",
      "id" : 999968520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5847mk8I",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999968520/reactions"
      },
      "updated_at" : "2021-12-23T00:59:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/999968520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-04T03:25:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1004501950",
      "id" : 1004501950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII584733u-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004501950/reactions"
      },
      "updated_at" : "2022-01-04T03:25:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1004501950",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> That is, unless the test is now too slow to run on some machines now. Please test it again on your toaster, @jonatack ;)\r\n\r\nHappy to :) ... needs rebase (again).",
      "created_at" : "2022-01-13T19:22:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1012437068",
      "id" : 1012437068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5848WJBM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012437068/reactions"
      },
      "updated_at" : "2022-01-13T19:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012437068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Conceptually i makes sense that the blockers can move backwards in reorg scenarios, so I have added this, though to be honest I have a hard time thinking of a realistic scenario where this prevents an issue on mainnet. I have also add a test for this feature.",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2022-01-16T18:34:03Z",
      "diff_hunk" : "@@ -2222,12 +2222,18 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n-            });\n+\n+            for (const auto& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height{blocker.second->nHeight - PRUNE_BLOCKER_BUFFER};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479282",
      "id" : 785479282,
      "in_reply_to_id" : 771982707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0XZy",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 2230,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 853707552,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T18:34:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479283"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I slightly prefer blocker because lock makes me think of mutex locks, which is even present on the same line. So I have kept the term blockers.",
      "commit_id" : "70bfe9d6763b858301553b451c6d9b1cfec56aad",
      "created_at" : "2022-01-16T18:34:07Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479283",
      "id" : 785479283,
      "in_reply_to_id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0XZz",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 853707555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479283/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T18:34:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479300"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added this, though simplified it a bit",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-16T18:34:18Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785479300",
      "id" : 785479300,
      "in_reply_to_id" : 772805155,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0XaE",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 467,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 853707572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479300/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T20:15:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785479300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785483623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785483623"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Mutex locks and prune locks are fundamentally the same thing...?",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-16T19:16:55Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785483623",
      "id" : 785483623,
      "in_reply_to_id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0Ydn",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 853711074,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785483623/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T19:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785483623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785487770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785487770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, to me that doesn't make it less confusing",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-16T19:59:29Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785487770",
      "id" : 785487770,
      "in_reply_to_id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0Zea",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 853715150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785487770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T19:59:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785487770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased and addressed @luke-jr comments (now co-author of the main commit introducing prune blockers).",
      "created_at" : "2022-01-16T20:01:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1013942216",
      "id" : 1013942216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5848b4fI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1013942216/reactions"
      },
      "updated_at" : "2022-01-16T20:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1013942216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The RPC interface for prune locks (not in this PR presently) could be useful for testing, so it might be a good idea to add it. If you want, you can just cherry-pick [9c9e0c0](https://github.com/bitcoin/bitcoin/commit/9c9e0c0b8c6a5a332f45896261aca5bdb3746447) + [e83ed21](https://github.com/bitcoin/bitcoin/commit/e83ed21172049ef593702c52bb840868728f47d1) + [da86f7b](https://github.com/bitcoin/bitcoin/commit/da86f7bdcfda0f5b27091b3934bc9f3e8de03157) for that.\r\n\r\nI have not done this yet because I don't want to expand the scope of this PR too much. But I am happy to open a new PR with these commits as a follow-up when this one here has been merged.",
      "created_at" : "2022-01-16T20:16:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1013944737",
      "id" : 1013944737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5848b5Gh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1013944737/reactions"
      },
      "updated_at" : "2022-01-16T20:16:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1013944737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785495749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785495749"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Using the same word (lock) for the same thing makes sense.\r\n\r\nUsing the same word (block) for completely different things, is confusing.",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-16T21:18:23Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r785495749",
      "id" : 785495749,
      "in_reply_to_id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584u0bbF",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 853767714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785495749/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-16T21:18:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/785495749",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788024692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788024692"
         }
      },
      "author_association" : "MEMBER",
      "body" : "79a080f It may be prudent to add lock annotations to `GetFirstStoredBlock()`.\r\n\r\n`CBLockIndex::nStatus` will be guarded by a mutex if #22932 is merged.\r\n\r\n<details><summary>diff</summary><p>\r\n\r\n```diff\r\ndiff --git a/src/node/blockstorage.cpp b/src/node/blockstorage.cpp\r\nindex a36cb421e3..bc37f9eaff 100644\r\n--- a/src/node/blockstorage.cpp\r\n+++ b/src/node/blockstorage.cpp\r\n@@ -438,6 +438,7 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\r\n }\r\n \r\n const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block) {\r\n+    AssertLockHeld(::cs_main);\r\n     CHECK_NONFATAL(start_block);\r\n     const CBlockIndex* last_block = start_block;\r\n     while (last_block->pprev && (last_block->pprev->nStatus & BLOCK_HAVE_DATA)) {\r\ndiff --git a/src/node/blockstorage.h b/src/node/blockstorage.h\r\nindex 749edae161..acae4bc897 100644\r\n--- a/src/node/blockstorage.h\r\n+++ b/src/node/blockstorage.h\r\n@@ -180,7 +180,8 @@ public:\r\n bool IsBlockPruned(const CBlockIndex* pblockindex);\r\n \r\n //! Find the first block that is not pruned\r\n-const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);\r\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block)\r\n+    EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n```\r\n</p></details>\r\n ",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T18:22:07Z",
      "diff_hunk" : "@@ -51,6 +51,15 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block) {\n+    CHECK_NONFATAL(start_block);\n+    const CBlockIndex* last_block = start_block;\n+    while (last_block->pprev && (last_block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788024692",
      "id" : 788024692,
      "line" : 443,
      "node_id" : "PRRC_kwDOABII584u-E10",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 443,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 19,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788024692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788024692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788050882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788050882"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2ac873b7 for your consideration, maybe disambiguate \"first\" and add a comma\r\n```suggestion\r\n                    RPCResult::Type::NUM, \"\", \"The height of the first (lowest) block that is still stored, after pruning\"},\r\n```",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T18:57:56Z",
      "diff_hunk" : "@@ -1115,7 +1115,7 @@ static RPCHelpMan pruneblockchain()\n             \"                  to prune blocks whose block time is at least 2 hours older than the provided timestamp.\"},\n                 },\n                 RPCResult{\n-                    RPCResult::Type::NUM, \"\", \"Height of the last block pruned\"},\n+                    RPCResult::Type::NUM, \"\", \"The height of the first block that is still stored after pruning\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788050882",
      "id" : 788050882,
      "line" : 1118,
      "node_id" : "PRRC_kwDOABII584u-LPC",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 1118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 5,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788050882/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788050882",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788054512"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788054512"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b44fea2c it looks like these two includes should be moved to `node/blockstorage.{h,cpp}` -- or only the header file if you inline `UpdatePruneBlocker()` in the h file -- instead of `validation.{h,cpp}`",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T19:02:51Z",
      "diff_hunk" : "@@ -35,6 +35,7 @@\n #include <stdint.h>\n #include <string>\n #include <thread>\n+#include <unordered_map>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788054512",
      "id" : 788054512,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII584u-MHw",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 38,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788054512/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:44:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788054512",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788061771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788061771"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b44fea2c This comment seems to be unfinished or missing context (\"when\"...what?), and not sure if \"when\" should be \"with\"\r\n",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T19:13:38Z",
      "diff_hunk" : "@@ -2468,6 +2474,18 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         assert(flushed);\n     }\n     LogPrint(BCLog::BENCH, \"- Disconnect block: %.2fms\\n\", (GetTimeMicros() - nStart) * MILLI);\n+\n+    {\n+        // Prune blockers that began at or after the tip should get moved backward so they get a chance to reorg\n+        const int max_height_first = pindexDelete->nHeight - 1;\n+        for (auto& prune_blocker : m_blockman.m_prune_blockers) {\n+            if (prune_blocker.second.m_height_first <= max_height_first) continue;\n+            // NOTE: Don't need to write to db here, since it will get synced when the rest of the chainstate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788061771",
      "id" : 788061771,
      "line" : 2483,
      "node_id" : "PRRC_kwDOABII584u-N5L",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 2483,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 49,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788061771/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788061771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788065922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788065922"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a879711\r\n```diff\r\n-        LOCK(::cs_main);\r\n-        m_chainstate->m_blockman.UpdatePruneBlocker(GetName(), prune_blocker);\r\n+        WITH_LOCK(::cs_main, m_chainstate->m_blockman.UpdatePruneBlocker(GetName(), prune_blocker));\r\n```\r\n",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T19:19:56Z",
      "diff_hunk" : "@@ -376,3 +372,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    assert(!node::fPruneMode || AllowPrune());\n+\n+    m_best_block_index = block;\n+    if (AllowPrune() && block) {\n+        node::PruneBlockerInfo prune_blocker;\n+        prune_blocker.m_height_first = block->nHeight;\n+        LOCK(::cs_main);\n+        m_chainstate->m_blockman.UpdatePruneBlocker(GetName(), prune_blocker);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788065922",
      "id" : 788065922,
      "line" : 384,
      "node_id" : "PRRC_kwDOABII584u-O6C",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 384,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 87,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788065922/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788065922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788071948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788071948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a879711 There doesn't seem to be any need for the four declarations of `AllowPrune()` to be protected; can they just be private?",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T19:28:44Z",
      "diff_hunk" : "@@ -103,6 +103,8 @@ class BaseIndex : public CValidationInterface\n     /// Get the name of the index for display in logs.\n     virtual const char* GetName() const = 0;\n \n+    virtual bool AllowPrune() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788071948",
      "id" : 788071948,
      "line" : 106,
      "node_id" : "PRRC_kwDOABII584u-QYM",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 106,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : 4,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788071948/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:47:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788071948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788073393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788073393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "16f6718\r\n```suggestion\r\n    argsman.AddArg(\"-prune=<n>\", strprintf(\"Reduce storage requirements by enabling pruning (deleting) of old blocks. This allows the pruneblockchain RPC to be called to delete specific blocks and enables automatic pruning of old blocks if a target size in MiB is provided. This mode is incompatible with -txindex. \"\r\n```",
      "commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "created_at" : "2022-01-19T19:30:51Z",
      "diff_hunk" : "@@ -417,7 +417,7 @@ void SetupServerArgs(ArgsManager& argsman)\n         -GetNumCores(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-persistmempool\", strprintf(\"Whether to save the mempool on shutdown and load on restart (default: %u)\", DEFAULT_PERSIST_MEMPOOL), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-pid=<file>\", strprintf(\"Specify pid file. Relative paths will be prefixed by a net-specific datadir location. (default: %s)\", BITCOIN_PID_FILENAME), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n-    argsman.AddArg(\"-prune=<n>\", strprintf(\"Reduce storage requirements by enabling pruning (deleting) of old blocks. This allows the pruneblockchain RPC to be called to delete specific blocks, and enables automatic pruning of old blocks if a target size in MiB is provided. This mode is incompatible with -txindex and -coinstatsindex. \"\n+    argsman.AddArg(\"-prune=<n>\", strprintf(\"Reduce storage requirements by enabling pruning (deleting) of old blocks. This allows the pruneblockchain RPC to be called to delete specific blocks, and enables automatic pruning of old blocks if a target size in MiB is provided. This mode is incompatible with -txindex. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r788073393",
      "id" : 788073393,
      "line" : 420,
      "node_id" : "PRRC_kwDOABII584u-Qux",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 420,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 857186248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788073393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T19:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/788073393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I still need to run `test/functional/feature_index_prune.py --timeout-factor=0` to avoid timeouts and the test still takes 15-16 minutes to run in performance mode with my cores at max frequency, so no change from [#21726 (comment)](https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723429759) and the suggestion to place the test in the extended scripts of the test runner (or at the top of the base scripts, or speed it up).\r\n\r\nThat is actually an improvement relatively speaking because for me the test became about 2.5x slower since the rebase [here](https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-996289321). For me the other extended tests are still a lot slower than this one but it's not too far off anymore so I have added the test to the list now.\r\n",
      "created_at" : "2022-01-23T23:25:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1019590830",
      "id" : 1019590830,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5848xbiu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019590830/reactions"
      },
      "updated_at" : "2022-01-23T23:25:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019590830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346119"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:27Z",
      "diff_hunk" : "@@ -417,7 +417,7 @@ void SetupServerArgs(ArgsManager& argsman)\n         -GetNumCores(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-persistmempool\", strprintf(\"Whether to save the mempool on shutdown and load on restart (default: %u)\", DEFAULT_PERSIST_MEMPOOL), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-pid=<file>\", strprintf(\"Specify pid file. Relative paths will be prefixed by a net-specific datadir location. (default: %s)\", BITCOIN_PID_FILENAME), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n-    argsman.AddArg(\"-prune=<n>\", strprintf(\"Reduce storage requirements by enabling pruning (deleting) of old blocks. This allows the pruneblockchain RPC to be called to delete specific blocks, and enables automatic pruning of old blocks if a target size in MiB is provided. This mode is incompatible with -txindex and -coinstatsindex. \"\n+    argsman.AddArg(\"-prune=<n>\", strprintf(\"Reduce storage requirements by enabling pruning (deleting) of old blocks. This allows the pruneblockchain RPC to be called to delete specific blocks, and enables automatic pruning of old blocks if a target size in MiB is provided. This mode is incompatible with -txindex. \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346119",
      "id" : 790346119,
      "in_reply_to_id" : 788073393,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7mH",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 420,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 860387098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346150"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:36Z",
      "diff_hunk" : "@@ -103,6 +103,8 @@ class BaseIndex : public CValidationInterface\n     /// Get the name of the index for display in logs.\n     virtual const char* GetName() const = 0;\n \n+    virtual bool AllowPrune() const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346150",
      "id" : 790346150,
      "in_reply_to_id" : 788071948,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7mm",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 106,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/base.h",
      "position" : null,
      "pull_request_review_id" : 860387118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346150/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346162"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:40Z",
      "diff_hunk" : "@@ -376,3 +372,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    assert(!node::fPruneMode || AllowPrune());\n+\n+    m_best_block_index = block;\n+    if (AllowPrune() && block) {\n+        node::PruneBlockerInfo prune_blocker;\n+        prune_blocker.m_height_first = block->nHeight;\n+        LOCK(::cs_main);\n+        m_chainstate->m_blockman.UpdatePruneBlocker(GetName(), prune_blocker);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346162",
      "id" : 790346162,
      "in_reply_to_id" : 788065922,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7my",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 384,
      "original_position" : 87,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : null,
      "pull_request_review_id" : 860387130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346162/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346187"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346187"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:45Z",
      "diff_hunk" : "@@ -2468,6 +2474,18 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         assert(flushed);\n     }\n     LogPrint(BCLog::BENCH, \"- Disconnect block: %.2fms\\n\", (GetTimeMicros() - nStart) * MILLI);\n+\n+    {\n+        // Prune blockers that began at or after the tip should get moved backward so they get a chance to reorg\n+        const int max_height_first = pindexDelete->nHeight - 1;\n+        for (auto& prune_blocker : m_blockman.m_prune_blockers) {\n+            if (prune_blocker.second.m_height_first <= max_height_first) continue;\n+            // NOTE: Don't need to write to db here, since it will get synced when the rest of the chainstate",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346187",
      "id" : 790346187,
      "in_reply_to_id" : 788061771,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7nL",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 2483,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 860387138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346187/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:51Z",
      "diff_hunk" : "@@ -35,6 +35,7 @@\n #include <stdint.h>\n #include <string>\n #include <thread>\n+#include <unordered_map>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346197",
      "id" : 790346197,
      "in_reply_to_id" : 788054512,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7nV",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 38,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 860387149,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346197/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346205"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346205"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:25:56Z",
      "diff_hunk" : "@@ -1115,7 +1115,7 @@ static RPCHelpMan pruneblockchain()\n             \"                  to prune blocks whose block time is at least 2 hours older than the provided timestamp.\"},\n                 },\n                 RPCResult{\n-                    RPCResult::Type::NUM, \"\", \"Height of the last block pruned\"},\n+                    RPCResult::Type::NUM, \"\", \"The height of the first block that is still stored after pruning\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346205",
      "id" : 790346205,
      "in_reply_to_id" : 788050882,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7nd",
      "original_commit_id" : "522661b92e0e424b705c673c80ba7534ba582b85",
      "original_line" : 1118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 860387162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346205/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:25:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346327"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:26:54Z",
      "diff_hunk" : "@@ -51,6 +51,15 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block) {\n+    CHECK_NONFATAL(start_block);\n+    const CBlockIndex* last_block = start_block;\n+    while (last_block->pprev && (last_block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346327",
      "id" : 790346327,
      "in_reply_to_id" : 788024692,
      "line" : 446,
      "node_id" : "PRRC_kwDOABII584vG7pX",
      "original_commit_id" : "86121153164a05a5da9812010f0bfdab434bec1f",
      "original_line" : 446,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 29,
      "pull_request_review_id" : 860387276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346327/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:26:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed comments by @jonatack and renamed from blockers to locks since I am not super passionate about naming stuff and I hope getting rid of controversies gets this closer to a merge faster.",
      "created_at" : "2022-01-23T23:29:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1019591470",
      "id" : 1019591470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5848xbsu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019591470/reactions"
      },
      "updated_at" : "2022-01-23T23:29:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1019591470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346715"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Renamed to locks.",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-23T23:30:26Z",
      "diff_hunk" : "@@ -455,6 +458,16 @@ class BlockManager\n     //! Returns last CBlockIndex* that is a checkpoint\n     CBlockIndex* GetLastCheckpoint(const CCheckpointData& data) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);\n+\n+    void UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r790346715",
      "id" : 790346715,
      "in_reply_to_id" : 771986890,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vG7vb",
      "original_commit_id" : "e9d434e03ecbe4f70ca596e534351d339940e084",
      "original_line" : 469,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 860387710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346715/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T23:30:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790346715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for updating @fjahr, re-reviewing soon.",
      "created_at" : "2022-01-25T12:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1021149978",
      "id" : 1021149978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII58483YMa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021149978/reactions"
      },
      "updated_at" : "2022-01-25T12:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021149978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r792938190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792938190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "e530e5e Is the choice of buffer value described somewhere (i.e. why 10 blocks)? Perhaps document the reasoning here and/or in the commit message.\r\n\r\nThe commit description `\"This change also introduces an aditional buffer of 10 blocks (PRUNE_LOCK_BUFFER) that will not be pruned before the best block.\"` might be in the wrong commit; it is in \"Index: Use prune locks for blockfilterindex\" but this constant is introduced in the preceding commit, \"blockstorage: Add prune locks to BlockManager\".",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-26T18:44:38Z",
      "diff_hunk" : "@@ -100,6 +100,8 @@ static const unsigned int DEFAULT_CHECKLEVEL = 3;\n // one 128MB block file + added 15% undo data = 147MB greater for a total of 545MB\n // Setting the target to >= 550 MiB will make it likely we can respect the target.\n static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n+/** The number of blocks to keep below the deepest prune lock. */\n+static constexpr int PRUNE_LOCK_BUFFER{10};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r792938190",
      "id" : 792938190,
      "line" : 104,
      "node_id" : "PRRC_kwDOABII584vQ0bO",
      "original_commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "original_line" : 104,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 5,
      "pull_request_review_id" : 863956366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792938190/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T22:06:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792938190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r794099957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794099957"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This updates the prune lock for coinstatsindex and blockfilterindex regularly, even if we don't have pruning enabled. Is that necessary?",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-28T00:04:43Z",
      "diff_hunk" : "@@ -372,3 +372,14 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    assert(!node::fPruneMode || AllowPrune());\n+\n+    m_best_block_index = block;\n+    if (AllowPrune() && block) {\n+        node::PruneLockInfo prune_lock;\n+        prune_lock.m_height_first = block->nHeight;\n+        WITH_LOCK(::cs_main, m_chainstate->m_blockman.UpdatePruneLock(GetName(), prune_lock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r794099957",
      "id" : 794099957,
      "line" : 383,
      "node_id" : "PRRC_kwDOABII584vVQD1",
      "original_commit_id" : "55e1a8109d90370f9b7eae5c3c7fa742354304a1",
      "original_line" : 383,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 73,
      "pull_request_review_id" : 865567279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794099957/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T00:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794099957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r794104592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794104592"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Couldn't this also be skipped when we are not pruning?",
      "commit_id" : "447f8c500ddd736f872199fd7b6bf493627005ec",
      "created_at" : "2022-01-28T00:16:54Z",
      "diff_hunk" : "@@ -2468,6 +2473,18 @@ bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTr\n         assert(flushed);\n     }\n     LogPrint(BCLog::BENCH, \"- Disconnect block: %.2fms\\n\", (GetTimeMicros() - nStart) * MILLI);\n+\n+    {\n+        // Prune locks that began at or after the tip should get moved backward so they get a chance to reorg\n+        const int max_height_first = pindexDelete->nHeight - 1;\n+        for (auto& prune_lock : m_blockman.m_prune_locks) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r794104592",
      "id" : 794104592,
      "line" : 2480,
      "node_id" : "PRRC_kwDOABII584vVRMQ",
      "original_commit_id" : "e530e5e76a0c61d989dec98d7443deeccf334148",
      "original_line" : 2480,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 865567279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794104592/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-28T00:20:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/794104592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We don't really have a \"never prune\" option right now, just a \"haven't pruned yet, no plans to do so\" which could be changed at any time by the user...",
      "created_at" : "2022-02-04T00:48:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1029536942",
      "id" : 1029536942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5849XXyu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029536942/reactions"
      },
      "updated_at" : "2022-02-04T00:48:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029536942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> We don't really have a \"never prune\" option right now, just a \"haven't pruned yet, no plans to do so\" which could be changed at any time by the user...\r\n\r\nRight, but we do have a `fPruneMode` flag that is only set in Init, so we can't switch to pruning without a restart afaik. And since the spot where the prune locks are read is conditional on `fPruneMode` ([code](https://github.com/bitcoin/bitcoin/pull/21726/commits/e530e5e76a0c61d989dec98d7443deeccf334148#diff-97c3a52bc5fad452d82670a7fd291800bae20c7bc35bb82686c2c0a4ea7b5b98L2227)) I was wondering whether it would make sense to do the same with the spots where the locks are written.\r\nThe init code must ensure anyway that nothing is pruned at startup before the indexes are initialized and the prune blockers are set.",
      "created_at" : "2022-02-04T01:56:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-1029568578",
      "id" : 1029568578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
      "node_id" : "IC_kwDOABII5849XfhC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029568578/reactions"
      },
      "updated_at" : "2022-02-04T01:56:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1029568578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
