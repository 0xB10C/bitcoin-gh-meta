[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21796 (index: Avoid async shutdown on init error by MarcoFalke)\n* #21526 (validation: UpdateTip/CheckBlockIndex assumeutxo support by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-04-24T01:14:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#issuecomment-826010997",
      "id" : 826010997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21767",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjAxMDk5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-01T02:24:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826010997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like this accumulated a silent merge conflict:\r\n```\r\nâ¦/bitcoin/src/test/coinstatsindex_tests.cpp:35:28: error: too few arguments to function call, single argument 'active_chainstate' was not specified\r\n    coin_stats_index.Start();\r\n    ~~~~~~~~~~~~~~~~~~~~~~ ^\r\nâ¦/bitcoin/src/index/base.h:122:10: note: 'Start' declared here\r\n    void Start(CChainState& active_chainstate);\r\n         ^\r\n1 error generated.\r\n```",
      "created_at" : "2021-05-05T12:09:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#issuecomment-832636493",
      "id" : 832636493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21767",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMjYzNjQ5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-05T12:09:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/832636493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627846989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627846989"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rest: Add GetChainman function and use it\" (a839078c20f4ac3d92e14af7b287f2f0fddbc61e)\r\n\r\nIt seems like this should say `if (!node_context || !node_context->chainman)` otherwise the http error won't be set in the null chainman case.",
      "commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "created_at" : "2021-05-07T00:28:38Z",
      "diff_hunk" : "@@ -107,6 +107,23 @@ static CTxMemPool* GetMemPool(const std::any& context, HTTPRequest* req)\n     return node_context->mempool.get();\n }\n \n+/**\n+ * Get the node context chainstatemanager.\n+ *\n+ * @param[in]  req The HTTP request, whose status code will be set if node\n+ *                 context chainstatemanager is not found.\n+ * @returns        Pointer to the chainstatemanager or nullptr if none found.\n+ */\n+static ChainstateManager* GetChainman(const std::any& context, HTTPRequest* req)\n+{\n+    auto node_context = util::AnyPtr<NodeContext>(context);\n+    if (!node_context) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627846989",
      "id" : 627846989,
      "line" : 120,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzg0Njk4OQ==",
      "original_commit_id" : "a839078c20f4ac3d92e14af7b287f2f0fddbc61e",
      "original_line" : 120,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 14,
      "pull_request_review_id" : 653992917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T00:55:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627846989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627847595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627847595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rest: Add GetChainman function and use it\" (a839078c20f4ac3d92e14af7b287f2f0fddbc61e)\r\n\r\nIf this condition is never expected, then maybe this should use `HTTP_INTERNAL_SERVER_ERROR` to flag that this is a bug in request handling, not an invalid request.",
      "commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "created_at" : "2021-05-07T00:30:39Z",
      "diff_hunk" : "@@ -107,6 +107,23 @@ static CTxMemPool* GetMemPool(const std::any& context, HTTPRequest* req)\n     return node_context->mempool.get();\n }\n \n+/**\n+ * Get the node context chainstatemanager.\n+ *\n+ * @param[in]  req The HTTP request, whose status code will be set if node\n+ *                 context chainstatemanager is not found.\n+ * @returns        Pointer to the chainstatemanager or nullptr if none found.\n+ */\n+static ChainstateManager* GetChainman(const std::any& context, HTTPRequest* req)\n+{\n+    auto node_context = util::AnyPtr<NodeContext>(context);\n+    if (!node_context) {\n+        RESTERR(req, HTTP_NOT_FOUND, \"Chainman disabled or instance not found\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627847595",
      "id" : 627847595,
      "line" : 121,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzg0NzU5NQ==",
      "original_commit_id" : "a839078c20f4ac3d92e14af7b287f2f0fddbc61e",
      "original_line" : 121,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 15,
      "pull_request_review_id" : 653992917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T00:55:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627847595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627848313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627848313"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"rest: Add GetChainman function and use it\" (a839078c20f4ac3d92e14af7b287f2f0fddbc61e)\r\n\r\nre: \"Someone can probably make this a bit prettier,\" your current version of this seems fine to me, but if you wanted to make it more minimal you could use CHECK_NONFATAL and catch the NonFatalCheckError exception in here, I think: https://github.com/bitcoin/bitcoin/blob/06d573f053c63eb6521c62d210c5924418ae2b83/src/rest.cpp#L699",
      "commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "created_at" : "2021-05-07T00:33:15Z",
      "diff_hunk" : "@@ -644,7 +667,9 @@ static bool rest_blockhash_by_height(const std::any& context, HTTPRequest* req,\n \n     CBlockIndex* pblockindex = nullptr;\n     {\n-        ChainstateManager& chainman = EnsureAnyChainman(context);\n+        ChainstateManager* maybe_chainman = GetChainman(context, req);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627848313",
      "id" : 627848313,
      "line" : 670,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzg0ODMxMw==",
      "original_commit_id" : "a839078c20f4ac3d92e14af7b287f2f0fddbc61e",
      "original_line" : 670,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 62,
      "pull_request_review_id" : 653992917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T00:55:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627848313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627852105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627852105"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"miner: Pass in chainman to RegenerateCommitments\" (f5368a525b3d5b93d06c83101497de5aaa6fe1c8)\r\n\r\nIt seems like this could take blockman reference instead of a chainman reference to be a little more limited. Doesn't matter though, all version of this function seem about the same to me.",
      "commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "created_at" : "2021-05-07T00:46:16Z",
      "diff_hunk" : "@@ -39,13 +39,21 @@ int64_t UpdateTime(CBlockHeader* pblock, const Consensus::Params& consensusParam\n     return nNewTime - nOldTime;\n }\n \n-void RegenerateCommitments(CBlock& block, CBlockIndex* prev_block)\n+void RegenerateCommitments(CBlock& block, ChainstateManager& chainman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627852105",
      "id" : 627852105,
      "line" : 42,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzg1MjEwNQ==",
      "original_commit_id" : "f5368a525b3d5b93d06c83101497de5aaa6fe1c8",
      "original_line" : 42,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 5,
      "pull_request_review_id" : 653992917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T00:55:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627852105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627853739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627853739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: Add chainstate member to BaseIndex\" (0945b4117e0209d156a6b74c407f4d32e0cf2c1a)\r\n\r\nSeems like active_chain could be used above too. Fine either way in case this was intentional, though.",
      "commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "created_at" : "2021-05-07T00:50:26Z",
      "diff_hunk" : "@@ -63,30 +63,31 @@ bool BaseIndex::Init()\n     if (locator.IsNull()) {\n         m_best_block_index = nullptr;\n     } else {\n-        m_best_block_index = g_chainman.m_blockman.FindForkInGlobalIndex(::ChainActive(), locator);\n+        m_best_block_index = m_chainstate->m_blockman.FindForkInGlobalIndex(m_chainstate->m_chain, locator);\n     }\n-    m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    CChain& active_chain = m_chainstate->m_chain;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21767#discussion_r627853739",
      "id" : 627853739,
      "line" : 68,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzg1MzczOQ==",
      "original_commit_id" : "0945b4117e0209d156a6b74c407f4d32e0cf2c1a",
      "original_line" : 68,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/index/base.cpp",
      "position" : 8,
      "pull_request_review_id" : 653992917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21767",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T00:55:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627853739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
