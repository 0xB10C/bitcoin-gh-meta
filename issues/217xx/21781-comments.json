[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK: preconditions should be checked where possible\r\n\r\nI take it you have started fuzzing Bitcoin Core again @guidovranken? That's very good news for Bitcoin :)\r\n\r\nDon't forget to any fuzzing trophies to https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Fuzz-Trophies :)",
      "created_at" : "2021-04-26T20:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21781#issuecomment-827128543",
      "id" : 827128543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21781",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNzEyODU0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-26T20:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827128543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620917589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620917589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this changed here, but the other 55 instances are left as is? Including the one in this line and another one in this file?\r\n\r\nSee also commit 592404f03\r\n\r\nAnd our developer notes:\r\n\r\n```\r\n- Watch out for out-of-bounds vector access. `&vch[vch.size()]` is illegal,\r\n  including `&vch[0]` for an empty vector. Use `vch.data()` and `vch.data() +\r\n  vch.size()` instead.\r\n\r\n",
      "commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "created_at" : "2021-04-27T06:56:20Z",
      "diff_hunk" : "@@ -53,7 +53,7 @@ class CSignatureCache\n     ComputeEntryECDSA(uint256& entry, const uint256 &hash, const std::vector<unsigned char>& vchSig, const CPubKey& pubkey) const\n     {\n         CSHA256 hasher = m_salted_hasher_ecdsa;\n-        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(&vchSig[0], vchSig.size()).Finalize(entry.begin());\n+        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(vchSig.data(), vchSig.size()).Finalize(entry.begin());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620917589",
      "id" : 620917589,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDkxNzU4OQ==",
      "original_commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "original_line" : 56,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/sigcache.cpp",
      "position" : 5,
      "pull_request_review_id" : 645498510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T06:56:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620917589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620930073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620930073"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, it could make sense to open two pull requests for the changes here, since they seem unrelated? (One of them is also failing the fuzz task, btw)",
      "commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "created_at" : "2021-04-27T07:17:01Z",
      "diff_hunk" : "@@ -53,7 +53,7 @@ class CSignatureCache\n     ComputeEntryECDSA(uint256& entry, const uint256 &hash, const std::vector<unsigned char>& vchSig, const CPubKey& pubkey) const\n     {\n         CSHA256 hasher = m_salted_hasher_ecdsa;\n-        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(&vchSig[0], vchSig.size()).Finalize(entry.begin());\n+        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(vchSig.data(), vchSig.size()).Finalize(entry.begin());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620930073",
      "id" : 620930073,
      "in_reply_to_id" : 620917589,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDkzMDA3Mw==",
      "original_commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "original_line" : 56,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/sigcache.cpp",
      "position" : 5,
      "pull_request_review_id" : 645514217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T07:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620930073",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620987297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620987297"
         }
      },
      "author_association" : "NONE",
      "body" : "> Why is this changed here, but the other 55 instances are left as is? Including the one in this line and another one in this file?\r\n\r\nI didn't change the two instances of `&pubkey[0]` in this file because the [CPubkey subscript operator](https://github.com/bitcoin/bitcoin/blob/19a56d1519fb493c3e1bd5cad55360b6b80fa52b/src/pubkey.h#L114) returns a reference to a [regular array](https://github.com/bitcoin/bitcoin/blob/19a56d1519fb493c3e1bd5cad55360b6b80fa52b/src/pubkey.h#L55) instead of a vector, so no undefined behavior rules are violated.\r\n\r\nI didn't change any other instances of `&vch[0]` because this instance specifically was the only one which came up with fuzzing (so far) with `-D_GLIBCXX_DEBUG`.\r\n\r\n> Also, it could make sense to open two pull requests for the changes here, since they seem unrelated?\r\n\r\n@laanwj suggested I create two commits in 1 PR.\r\n\r\n> (One of them is also failing the fuzz task, btw)\r\n\r\nIt fails because it [instantiates ChaCha20 with a key that is ```17..31``` bytes large](https://github.com/bitcoin/bitcoin/blob/19a56d1519fb493c3e1bd5cad55360b6b80fa52b/src/test/fuzz/crypto_chacha20.cpp#L19-L26) whereas my change requires that it is either 16 or 32 bytes.\r\n\r\nI can either relax the condition in ChaCha20 to allow keys ```16..32``` bytes large, or change the fuzzer to pick one of `(16, 32)`, let me know which you prefer.\r\n\r\n",
      "commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "created_at" : "2021-04-27T08:35:10Z",
      "diff_hunk" : "@@ -53,7 +53,7 @@ class CSignatureCache\n     ComputeEntryECDSA(uint256& entry, const uint256 &hash, const std::vector<unsigned char>& vchSig, const CPubKey& pubkey) const\n     {\n         CSHA256 hasher = m_salted_hasher_ecdsa;\n-        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(&vchSig[0], vchSig.size()).Finalize(entry.begin());\n+        hasher.Write(hash.begin(), 32).Write(&pubkey[0], pubkey.size()).Write(vchSig.data(), vchSig.size()).Finalize(entry.begin());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21781#discussion_r620987297",
      "id" : 620987297,
      "in_reply_to_id" : 620917589,
      "line" : 56,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDk4NzI5Nw==",
      "original_commit_id" : "65a3368a23cdc059fd5e6e9e58121a5b986f8091",
      "original_line" : 56,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/sigcache.cpp",
      "position" : 5,
      "pull_request_review_id" : 645586361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21781",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-27T08:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620987297",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6846644?v=4",
         "events_url" : "https://api.github.com/users/guidovranken/events{/privacy}",
         "followers_url" : "https://api.github.com/users/guidovranken/followers",
         "following_url" : "https://api.github.com/users/guidovranken/following{/other_user}",
         "gists_url" : "https://api.github.com/users/guidovranken/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/guidovranken",
         "id" : 6846644,
         "login" : "guidovranken",
         "node_id" : "MDQ6VXNlcjY4NDY2NDQ=",
         "organizations_url" : "https://api.github.com/users/guidovranken/orgs",
         "received_events_url" : "https://api.github.com/users/guidovranken/received_events",
         "repos_url" : "https://api.github.com/users/guidovranken/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/guidovranken/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/guidovranken/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/guidovranken"
      }
   }
]
