[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614262360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614262360"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0U);\r\n```\r\n\r\nLooks like you are hitting some stupid compiler error",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-15T17:28:51Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n+        // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n+            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614262360",
      "id" : 614262360,
      "line" : 274,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDI2MjM2MA==",
      "original_commit_id" : "37c255cdebfefdf84c2c38863b6d07639d24266f",
      "original_line" : 274,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : 232,
      "pull_request_review_id" : 636950420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614262360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614279839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614279839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-15T17:56:17Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n+        // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n+            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614279839",
      "id" : 614279839,
      "in_reply_to_id" : 614262360,
      "line" : 274,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDI3OTgzOQ==",
      "original_commit_id" : "37c255cdebfefdf84c2c38863b6d07639d24266f",
      "original_line" : 274,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : 232,
      "pull_request_review_id" : 636973591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614279839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~tACK 724e4948004c8127f093db90f9d78e6ed9e46541~ on Ubuntu\r\n\r\nI verified as follows:\r\n\r\n```\r\ngit checkout origin/0.21\r\ngit checkout -b speedy-trial-backport\r\ngit cherry-pick 63879f0a4760c0c0f784029849cb5d21ee088abb^..ffe33dfbd4c3b11e3475b022b6c1dd077613de79\r\ngit cherry-pick f979b3237f1cfc28f9c4ccb07beab558d5357a55\r\ngit diff 724e4948004c8127f093db90f9d78e6ed9e46541\r\nsrc/test/test_bitcoin --run_test=versionbits_tests\r\n````\r\n\r\nGit diff only shows a difference in the trailing `U` for this test (presumably related to https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614279839): `BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0U);`\r\n\r\nI had manually resolve a conflict for dd07e6da48040dc7eae46bc7941db48d98a669fd.\r\n\r\nI also managed to spin up the node and see the softfork as \"defined\" in `getblockchaininfo`.\r\n\r\n---\r\n\r\nI'm unable to reproduce the CI failure on macOS 11.2.3 with homebrew Boost 1.75.0. It doesn't happen for me with depends either. ",
      "created_at" : "2021-04-15T18:14:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#issuecomment-820633021",
      "id" : 820633021,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21701",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDYzMzAyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-15T19:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820633021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't know why CI is having a hard time building this. I am able to do a gitian build of this branch, so it should be working.",
      "created_at" : "2021-04-15T22:45:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#issuecomment-820773731",
      "id" : 820773731,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21701",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDc3MzczMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-15T22:45:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820773731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614485951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614485951"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0U);\r\n```",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:53:44Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614485951",
      "id" : 614485951,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NTk1MQ==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 271,
      "original_position" : 229,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637244766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614485951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614486021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614486021"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0);\r\n```",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:54:03Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n+        // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n+            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0U);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614486021",
      "id" : 614486021,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NjAyMQ==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 274,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637244766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614486021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614486086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614486086"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    BOOST_REQUIRE_EQUAL(min_activation_height % params.nMinerConfirmationWindow, 0U);\r\n```",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:54:14Z",
      "diff_hunk" : "@@ -242,81 +290,118 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n     }\n }\n \n-BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n+/** Check that ComputeBlockVersion will set the appropriate bit correctly */\n+static void check_computeblockversion(const Consensus::Params& params, Consensus::DeploymentPos dep)\n {\n-    // Check that ComputeBlockVersion will set the appropriate bit correctly\n-    // on mainnet.\n-    const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n-    const Consensus::Params &mainnetParams = chainParams->GetConsensus();\n+    // This implicitly uses versionbitscache, so clear it every time\n+    versionbitscache.Clear();\n+\n+    int64_t bit = params.vDeployments[dep].bit;\n+    int64_t nStartTime = params.vDeployments[dep].nStartTime;\n+    int64_t nTimeout = params.vDeployments[dep].nTimeout;\n+    int min_activation_height = params.vDeployments[dep].min_activation_height;\n+\n+    // should not be any signalling for first block\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(nullptr, params), VERSIONBITS_TOP_BITS);\n \n-    // Use the TESTDUMMY deployment for testing purposes.\n-    int64_t bit = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit;\n-    int64_t nStartTime = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime;\n-    int64_t nTimeout = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout;\n+    // always/never active deployments shouldn't need to be tested further\n+    if (nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE) return;\n+    if (nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) return;\n \n-    assert(nStartTime < nTimeout);\n+    BOOST_REQUIRE(nStartTime < nTimeout);\n+    BOOST_REQUIRE(nStartTime >= 0);\n+    BOOST_REQUIRE(nTimeout <= std::numeric_limits<uint32_t>::max() || nTimeout == Consensus::BIP9Deployment::NO_TIMEOUT);\n+    BOOST_REQUIRE(0 <= bit && bit < 32);\n+    BOOST_REQUIRE(((1 << bit) & VERSIONBITS_TOP_MASK) == 0);\n+    BOOST_REQUIRE(min_activation_height >= 0);\n+    BOOST_REQUIRE_EQUAL(min_activation_height % params.nMinerConfirmationWindow, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614486086",
      "id" : 614486086,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NjA4Ng==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 317,
      "original_position" : 276,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637244766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614486086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487587"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:59:32Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487587",
      "id" : 614487587,
      "in_reply_to_id" : 614485951,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NzU4Nw==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 271,
      "original_position" : 229,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637246507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:59:35Z",
      "diff_hunk" : "@@ -226,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n+        // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n+            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0U);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487601",
      "id" : 614487601,
      "in_reply_to_id" : 614486021,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NzYwMQ==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 274,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637246533,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487615"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T00:59:39Z",
      "diff_hunk" : "@@ -242,81 +290,118 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n     }\n }\n \n-BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n+/** Check that ComputeBlockVersion will set the appropriate bit correctly */\n+static void check_computeblockversion(const Consensus::Params& params, Consensus::DeploymentPos dep)\n {\n-    // Check that ComputeBlockVersion will set the appropriate bit correctly\n-    // on mainnet.\n-    const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n-    const Consensus::Params &mainnetParams = chainParams->GetConsensus();\n+    // This implicitly uses versionbitscache, so clear it every time\n+    versionbitscache.Clear();\n+\n+    int64_t bit = params.vDeployments[dep].bit;\n+    int64_t nStartTime = params.vDeployments[dep].nStartTime;\n+    int64_t nTimeout = params.vDeployments[dep].nTimeout;\n+    int min_activation_height = params.vDeployments[dep].min_activation_height;\n+\n+    // should not be any signalling for first block\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(nullptr, params), VERSIONBITS_TOP_BITS);\n \n-    // Use the TESTDUMMY deployment for testing purposes.\n-    int64_t bit = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit;\n-    int64_t nStartTime = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime;\n-    int64_t nTimeout = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout;\n+    // always/never active deployments shouldn't need to be tested further\n+    if (nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE) return;\n+    if (nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) return;\n \n-    assert(nStartTime < nTimeout);\n+    BOOST_REQUIRE(nStartTime < nTimeout);\n+    BOOST_REQUIRE(nStartTime >= 0);\n+    BOOST_REQUIRE(nTimeout <= std::numeric_limits<uint32_t>::max() || nTimeout == Consensus::BIP9Deployment::NO_TIMEOUT);\n+    BOOST_REQUIRE(0 <= bit && bit < 32);\n+    BOOST_REQUIRE(((1 << bit) & VERSIONBITS_TOP_MASK) == 0);\n+    BOOST_REQUIRE(min_activation_height >= 0);\n+    BOOST_REQUIRE_EQUAL(min_activation_height % params.nMinerConfirmationWindow, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#discussion_r614487615",
      "id" : 614487615,
      "in_reply_to_id" : 614486086,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNDQ4NzYxNQ==",
      "original_commit_id" : "724e4948004c8127f093db90f9d78e6ed9e46541",
      "original_line" : 317,
      "original_position" : 276,
      "original_start_line" : null,
      "path" : "src/test/versionbits_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 637246554,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21701",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-16T01:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/614487615",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cherry-pick ACK https://github.com/bitcoin/bitcoin/pull/21701/commits/cbd64c3a28a7466f421477daadc6e6e6b69b898a",
      "created_at" : "2021-04-16T02:30:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21701#issuecomment-820864428",
      "id" : 820864428,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21701",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDg2NDQyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-16T02:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820864428",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
