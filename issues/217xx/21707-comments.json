[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21707#discussion_r615841194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21707"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615841194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style nit, here and line 202\r\n```suggestion\r\n        assert full_outbound_peer.getaddr_received\r\n```",
      "commit_id" : "11c79242d2c2a093d9f06036b8b0ddfc8b1c6000",
      "created_at" : "2021-04-19T13:20:08Z",
      "diff_hunk" : "@@ -82,6 +122,96 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info('Check relay of addresses received from outbound peers')\n+        inbound_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        full_outbound_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(full_outbound_peer, msg, [inbound_peer])\n+        self.log.info('Check that the first addr message received from an outbound peer is not relayed')\n+        # Currently, there is a flag that prevents the first addr message received\n+        # from a new outbound peer to be relayed to others. Originally meant to prevent\n+        # large GETADDR responses from being relayed, it now typically affects the self-announcement\n+        # of the outbound peer which is often sent before the GETADDR response.\n+        assert_equal(inbound_peer.num_ipv4_received, 0)\n+\n+        self.log.info('Check that further addr messages sent from an outbound peer are relayed')\n+        msg2 = self.setup_addr_msg(2)\n+        self.send_addr_msg(full_outbound_peer, msg2, [inbound_peer])\n+        assert_equal(inbound_peer.num_ipv4_received, 2)\n+\n+        self.log.info('Check address relay to outbound peers')\n+        block_relay_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=1, connection_type=\"block-relay-only\")\n+        block_relay_peer.sync_with_ping()\n+        msg3 = self.setup_addr_msg(2)\n+        self.send_addr_msg(inbound_peer, msg3, [full_outbound_peer, block_relay_peer])\n+\n+        self.log.info('Check that addresses are relayed to full outbound peers')\n+        assert_equal(full_outbound_peer.num_ipv4_received, 2)\n+        self.log.info('Check that addresses are not relayed to block-relay-only outbound peers')\n+        assert_equal(block_relay_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()\n+\n+    def getaddr_tests(self):\n+        self.log.info('Test getaddr behavior')\n+        self.log.info('Check that we send a getaddr message to outbound-full-relay peers')\n+        full_outbound_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        full_outbound_peer.sync_with_ping()\n+        assert(full_outbound_peer.getaddr_received)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21707#discussion_r615841194",
      "id" : 615841194,
      "line" : 162,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTg0MTE5NA==",
      "original_commit_id" : "11c79242d2c2a093d9f06036b8b0ddfc8b1c6000",
      "original_line" : 162,
      "original_position" : 166,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 166,
      "pull_request_review_id" : 638858189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21707",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T13:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615841194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21707#discussion_r615842564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21707"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615842564"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We can now use Python f-strings for interpolation (here and e.g. line 70 above).\r\n```suggestion\r\n            a = f\"{first_octet}.{second_octet}.1.1\"\r\n```",
      "commit_id" : "11c79242d2c2a093d9f06036b8b0ddfc8b1c6000",
      "created_at" : "2021-04-19T13:21:51Z",
      "diff_hunk" : "@@ -82,6 +122,96 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info('Check relay of addresses received from outbound peers')\n+        inbound_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        full_outbound_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(full_outbound_peer, msg, [inbound_peer])\n+        self.log.info('Check that the first addr message received from an outbound peer is not relayed')\n+        # Currently, there is a flag that prevents the first addr message received\n+        # from a new outbound peer to be relayed to others. Originally meant to prevent\n+        # large GETADDR responses from being relayed, it now typically affects the self-announcement\n+        # of the outbound peer which is often sent before the GETADDR response.\n+        assert_equal(inbound_peer.num_ipv4_received, 0)\n+\n+        self.log.info('Check that further addr messages sent from an outbound peer are relayed')\n+        msg2 = self.setup_addr_msg(2)\n+        self.send_addr_msg(full_outbound_peer, msg2, [inbound_peer])\n+        assert_equal(inbound_peer.num_ipv4_received, 2)\n+\n+        self.log.info('Check address relay to outbound peers')\n+        block_relay_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=1, connection_type=\"block-relay-only\")\n+        block_relay_peer.sync_with_ping()\n+        msg3 = self.setup_addr_msg(2)\n+        self.send_addr_msg(inbound_peer, msg3, [full_outbound_peer, block_relay_peer])\n+\n+        self.log.info('Check that addresses are relayed to full outbound peers')\n+        assert_equal(full_outbound_peer.num_ipv4_received, 2)\n+        self.log.info('Check that addresses are not relayed to block-relay-only outbound peers')\n+        assert_equal(block_relay_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()\n+\n+    def getaddr_tests(self):\n+        self.log.info('Test getaddr behavior')\n+        self.log.info('Check that we send a getaddr message to outbound-full-relay peers')\n+        full_outbound_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=0, connection_type=\"outbound-full-relay\")\n+        full_outbound_peer.sync_with_ping()\n+        assert(full_outbound_peer.getaddr_received)\n+\n+        self.log.info('Check that we do not send a getaddr message to block-relay-only peers')\n+        block_relay_peer = self.nodes[0].add_outbound_p2p_connection(GetAddrStore(), p2p_idx=1, connection_type=\"block-relay-only\")\n+        block_relay_peer.sync_with_ping()\n+        assert_equal(block_relay_peer.getaddr_received, False)\n+\n+        self.log.info('Check that we answer getaddr messages only from inbound peers')\n+        inbound_peer = self.nodes[0].add_p2p_connection(GetAddrStore())\n+        inbound_peer.sync_with_ping()\n+\n+        # Add some addresses to addrman\n+        for i in range(1000):\n+            first_octet = i >> 8\n+            second_octet = i % 256\n+            a = \"{}.{}.1.1\".format(first_octet, second_octet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21707#discussion_r615842564",
      "id" : 615842564,
      "line" : 177,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTg0MjU2NA==",
      "original_commit_id" : "11c79242d2c2a093d9f06036b8b0ddfc8b1c6000",
      "original_line" : 177,
      "original_position" : 181,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 181,
      "pull_request_review_id" : 638858189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21707",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-19T13:24:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615842564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
