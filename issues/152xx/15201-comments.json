[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2019-01-19T01:51:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15201#issuecomment-455738643",
      "id" : 455738643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15201",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ1NTczODY0Mw==",
      "updated_at" : "2019-01-19T14:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/455738643",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15201#discussion_r249250254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15201"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249250254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why?",
      "commit_id" : "eea02be70ee37b845f2719b3c08e5baf4b6f51f6",
      "created_at" : "2019-01-19T16:45:44Z",
      "diff_hunk" : "@@ -2501,7 +2501,7 @@ void CConnman::Interrupt()\n     }\n }\n \n-void CConnman::Stop()\n+void CConnman::Stop() NO_THREAD_SAFETY_ANALYSIS",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15201#discussion_r249250254",
      "id" : 249250254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0OTI1MDI1NA==",
      "original_commit_id" : "e211626a6af2f21df076561876a15ee0557b23a4",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 194362251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15201",
      "updated_at" : "2019-01-19T17:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249250254",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15201#discussion_r249250873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15201"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249250873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good question! I added a clarifying comment:\r\n\r\n```\r\n// TODO: Remove NO_THREAD_SAFETY_ANALYSIS. Lock cs_vNodes before reading the variable vNodes.\r\n//\r\n// When removing NO_THREAD_SAFETY_ANALYSIS be aware of the following lock order requirements:\r\n// * CheckForStaleTipAndEvictPeers locks cs_main before indirectly calling GetExtraOutboundCount\r\n//   which locks cs_vNodes.\r\n// * ProcessMessage locks cs_main and g_cs_orphans before indirectly calling ForEachNode which\r\n//   locks cs_vNodes.\r\n//\r\n// Thus the implicit locking order requirement is: (1) cs_main, (2) g_cs_orphans, (3) cs_vNodes.\r\n```\r\n\r\nThe problem here is that `cs_vNodes` needs to be locked before reading the variable `vNodes`.\r\n\r\nAdding such a lock in `CConnman::Stop` would be trivial, but we have to take into account the implicit locking order requirements that follow from other parts of the code. Getting a matching locking order here results in surprisingly invasive changes (at least when I did it!).",
      "commit_id" : "eea02be70ee37b845f2719b3c08e5baf4b6f51f6",
      "created_at" : "2019-01-19T17:04:46Z",
      "diff_hunk" : "@@ -2501,7 +2501,7 @@ void CConnman::Interrupt()\n     }\n }\n \n-void CConnman::Stop()\n+void CConnman::Stop() NO_THREAD_SAFETY_ANALYSIS",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15201#discussion_r249250873",
      "id" : 249250873,
      "in_reply_to_id" : 249250254,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0OTI1MDg3Mw==",
      "original_commit_id" : "e211626a6af2f21df076561876a15ee0557b23a4",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 194362914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15201",
      "updated_at" : "2019-01-19T17:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/249250873",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj Feedback addressed! Please re-review :-)",
      "created_at" : "2019-02-07T21:55:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15201#issuecomment-461610126",
      "id" : 461610126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15201",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTYxMDEyNg==",
      "updated_at" : "2019-02-07T21:55:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461610126",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks! I am still somewhat skeptical about adding a lock annotation then working around it, but all in all I think the annotation has value because it still allows checking the other uses of the lock. It's also good to document the hairy situation with a comment.\r\n\r\nutACK eea02be70ee37b845f2719b3c08e5baf4b6f51f6",
      "created_at" : "2019-02-08T11:42:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15201#issuecomment-461777128",
      "id" : 461777128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15201",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2MTc3NzEyOA==",
      "updated_at" : "2019-02-08T11:42:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/461777128",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
