{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "While profiling the `loadblk` thread I noticed that a lot of time was being spent in `prevector::resize()`. I have some data here indicating that it takes up **37%** of the time in `ReadBlockFromDisk()`: https://monad.io/readblockfromdisk.svg\r\n\r\nThis branch improves things significantly. According to the prevector benchmark, the speedups are:\r\n * `prevector::clear()` for trivial types becomes 8.1x faster\r\n * `prevector::~prevector()` for trivial types becomes 7.6x faster (most of its time was spent in `resize()`)\r\n * `prevector::resize()` for trivial types becomes 17.9x faster\r\n * `prevector::resize()` for non-trivial types becomes 2.2x faster\r\n\r\nNote that in practice it looks like the prevector is only used to contain `unsigned char` types, which is a trivial type. The benchmarks are testing a bit of an extreme case, but the changes here are motivated by the profiling data for `ReadBlockFromDisk()` I linked to above.\r\n\r\nThe pull request here is two commits, the first commit adds the new benchmarks, and the second commit actually optimizes the prevector implementation. The numbers given above are based on me comparing the benchmark numbers from the first commit (which is basically benchmarking master) against the benchmark numbers in the second commit:\r\n\r\nBefore prevector optimizations:\r\n```\r\n$ ./src/bench/bench_bitcoin -filter='Prevector.*'\r\n# Benchmark, evals, iterations, total, min, max, median\r\nPrevectorClear, 5, 5600, 3.51216, 0.000124847, 0.000126195, 0.000125358\r\nPrevectorDestructor, 5, 5700, 3.32806, 0.000115869, 0.000117395, 0.00011691\r\nPrevectorResizeNontrivial, 5, 4100, 3.41065, 0.000162157, 0.000171089, 0.0001671\r\nPrevectorResizeTrivial, 5, 4900, 3.51391, 0.000137509, 0.000150316, 0.00014522\r\n```\r\n\r\nAfter my optimizations:\r\n```\r\n$ ./src/bench/bench_bitcoin -filter='Prevector.*'\r\n# Benchmark, evals, iterations, total, min, max, median\r\nPrevectorClear, 5, 45000, 3.50816, 1.52231e-05, 1.63413e-05, 1.54451e-05\r\nPrevectorDestructor, 5, 42800, 3.29708, 1.53111e-05, 1.54935e-05, 1.54058e-05\r\nPrevectorResizeNontrivial, 5, 8700, 3.32136, 7.61098e-05, 7.66597e-05, 7.6256e-05\r\nPrevectorResizeTrivial, 5, 84000, 3.45793, 7.96525e-06, 8.79618e-06, 8.11656e-06\r\n```\r\n\r\nI also updated the iteration count in the benchmarks a bit, to make them take about the same time as they currently do.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549/comments",
   "created_at" : "2018-02-27T04:16:40Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549",
   "id" : 300488229,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "number" : 12549,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/12549.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12549",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/12549.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12549"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "Make prevector::resize() and other prevector operations much faster",
   "updated_at" : "2018-02-27T04:16:40Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12549",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
      "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/eklitzke/followers",
      "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/eklitzke",
      "id" : 2734,
      "login" : "eklitzke",
      "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
      "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
      "repos_url" : "https://api.github.com/users/eklitzke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/eklitzke"
   }
}
