[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150709010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11678"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/150709010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Above on line 2347 it says `\"Note that this will shutdown the server.\\n\"` which should be removed now",
      "commit_id" : "514562548631f4b4bc3cb81fc233f5ac9eb79d4e",
      "created_at" : "2017-11-14T00:43:43Z",
      "diff_hunk" : "@@ -2386,8 +2387,10 @@ UniValue encryptwallet(const JSONRPCRequest& request)\n     // BDB seems to have a bad habit of writing old data into\n     // slack space in .dat files; that is bad if the old data is\n     // unencrypted private keys. So:\n-    StartShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150709010",
      "id" : 150709010,
      "original_commit_id" : "db7a0c966eb2368002ce9dfc9f258574f5a71a4f",
      "original_position" : 12,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 76299246,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11678",
      "updated_at" : "2017-11-14T04:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/150709010",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/MeshCollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MeshCollider/followers",
         "following_url" : "https://api.github.com/users/MeshCollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MeshCollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MeshCollider",
         "id" : 3211283,
         "login" : "MeshCollider",
         "organizations_url" : "https://api.github.com/users/MeshCollider/orgs",
         "received_events_url" : "https://api.github.com/users/MeshCollider/received_events",
         "repos_url" : "https://api.github.com/users/MeshCollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MeshCollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MeshCollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MeshCollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150735731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11678"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/150735731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "514562548631f4b4bc3cb81fc233f5ac9eb79d4e",
      "created_at" : "2017-11-14T04:36:59Z",
      "diff_hunk" : "@@ -2386,8 +2387,10 @@ UniValue encryptwallet(const JSONRPCRequest& request)\n     // BDB seems to have a bad habit of writing old data into\n     // slack space in .dat files; that is bad if the old data is\n     // unencrypted private keys. So:\n-    StartShutdown();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150735731",
      "id" : 150735731,
      "in_reply_to_id" : 150709010,
      "original_commit_id" : "db7a0c966eb2368002ce9dfc9f258574f5a71a4f",
      "original_position" : 12,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 76328655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11678",
      "updated_at" : "2017-11-14T04:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/150735731",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I resolved the hanging issue, but now there's another issue.\r\n\r\nThe hanging issue was because I forgot to set the CWallet pointers `walletmodel`, `addresstablemodel`, and `transactiontablemodel` to the new CWallet pointers that were created from reopening the wallet. So they were trying to lock on a `cs_KeyStore` that no longer existed.\r\n\r\n~~~The new issue is that the address book tables and transaction tables are not updating when they should be.~~~ Resolved that.",
      "created_at" : "2017-11-14T04:38:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344144417",
      "id" : 344144417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-14T05:15:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/344144417",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Resolved the other issue too. I forgot to also reset the signals to use the new wallets too. No longer WIP.",
      "created_at" : "2017-11-14T05:16:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344149106",
      "id" : 344149106,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-14T05:16:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/344149106",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\nI get `SIGABRT` when I call `encryptwallet` from the debug window console. Here is the stack trace:\r\n```\r\n2017-11-14 14:02:32 Encrypting Wallet with an nDeriveIterations of 188608\r\n2017-11-14 14:02:33 GUI: NotifyKeyStoreStatusChanged\r\n2017-11-14 14:02:33 GUI: NotifyKeyStoreStatusChanged\r\n2017-11-14 14:02:34 keypool added 2000 keys (1000 internal), size=2000 (1000 internal)\r\n2017-11-14 14:02:35 CWallet::NewKeyPool rewrote keypool\r\n2017-11-14 14:02:35 GUI: NotifyKeyStoreStatusChanged\r\n2017-11-14 14:02:35 CDB::Rewrite: Rewriting wallet.dat...\r\n2017-11-14 14:02:35 GUI: NotifyKeyStoreStatusChanged\r\n2017-11-14 14:02:35 CDBEnv::Flush: Flush(true)\r\n2017-11-14 14:02:35 CDBEnv::Flush: Flushing wallet.dat (refcount = 0)...\r\n2017-11-14 14:02:35 CDBEnv::Flush: wallet.dat checkpoint\r\n2017-11-14 14:02:35 CDBEnv::Flush: wallet.dat detach\r\n2017-11-14 14:02:35 CDBEnv::Flush: wallet.dat closed\r\n2017-11-14 14:02:35 CDBEnv::Flush: Flush(true) took              30ms\r\nAssertion failed: (e == 0), function ~recursive_mutex, file /BuildRoot/Library/Caches/com.apple.xbs/Sources/libcxx/libcxx-307.5/src/mutex.cpp, line 86.\r\nProcess 24964 stopped\r\n* thread #18, name = 'QThread', stop reason = signal SIGABRT\r\n    frame #0: 0x00007fffcd6ddd42 libsystem_kernel.dylib`__pthread_kill + 10\r\nlibsystem_kernel.dylib`__pthread_kill:\r\n->  0x7fffcd6ddd42 <+10>: jae    0x7fffcd6ddd4c            ; <+20>\r\n    0x7fffcd6ddd44 <+12>: movq   %rax, %rdi\r\n    0x7fffcd6ddd47 <+15>: jmp    0x7fffcd6d6caf            ; cerror_nocancel\r\n    0x7fffcd6ddd4c <+20>: retq\r\nTarget 0: (bitcoin-qt) stopped.\r\n(lldb) bt\r\n* thread #18, name = 'QThread', stop reason = signal SIGABRT\r\n  * frame #0: 0x00007fffcd6ddd42 libsystem_kernel.dylib`__pthread_kill + 10\r\n    frame #1: 0x00007fffcd7cb457 libsystem_pthread.dylib`pthread_kill + 90\r\n    frame #2: 0x00007fffcd643420 libsystem_c.dylib`abort + 129\r\n    frame #3: 0x00007fffcd60a893 libsystem_c.dylib`__assert_rtn + 320\r\n    frame #4: 0x00007fffcc17b230 libc++.1.dylib`std::__1::recursive_mutex::~recursive_mutex() + 54\r\n    frame #5: 0x00000001003e2393 bitcoin-qt`CWallet::~CWallet() [inlined] AnnotatedMixin<std::__1::recursive_mutex>::~AnnotatedMixin(this=0x000000010c050378) at sync.h:56 [opt]\r\n    frame #6: 0x00000001003e238b bitcoin-qt`CWallet::~CWallet() [inlined] CCriticalSection::~CCriticalSection(this=0x000000010c050378) at sync.h:98 [opt]\r\n    frame #7: 0x00000001003e2383 bitcoin-qt`CWallet::~CWallet() [inlined] CCriticalSection::~CCriticalSection(this=0x000000010c050378) at sync.h:96 [opt]\r\n    frame #8: 0x00000001003e2383 bitcoin-qt`CWallet::~CWallet(this=0x000000010c0501b0) at wallet.h:773 [opt]\r\n    frame #9: 0x00000001003dbc5c bitcoin-qt`CWallet::~CWallet() [inlined] CWallet::~CWallet(this=0x000000010c0501b0) at wallet.h:770 [opt]\r\n    frame #10: 0x00000001003dbc57 bitcoin-qt`CWallet::~CWallet(this=0x000000010c0501b0) at wallet.h:770 [opt]\r\n    frame #11: 0x000000010036290e bitcoin-qt`CloseWallets() at init.cpp:286 [opt]\r\n    frame #12: 0x000000010039cd8f bitcoin-qt`encryptwallet(request=<unavailable>) at rpcwallet.cpp:2390 [opt]\r\n    frame #13: 0x000000010027724a bitcoin-qt`CRPCTable::execute(this=<unavailable>, request=0x00007000105745b0) const at server.cpp:496 [opt]\r\n    frame #14: 0x000000010006da53 bitcoin-qt`RPCConsole::RPCParseCommandLine(strResult=\"\", strCommand=\"encryptwallet test\\n\", fExecute=<unavailable>, pstrFilteredOut=\"\") at rpcconsole.cpp:314 [opt]\r\n    frame #15: 0x000000010006bd5a bitcoin-qt`RPCExecutor::request(QString const&) [inlined] RPCConsole::RPCExecuteCommandLine(strResult=\"\", strCommand=\"\", pstrFilteredOut=<unavailable>) at rpcconsole.h:41 [opt]\r\n    frame #16: 0x000000010006bd4e bitcoin-qt`RPCExecutor::request(this=0x00000001134357b0, command=<unavailable>) at rpcconsole.cpp:395 [opt]\r\n    frame #17: 0x0000000101e0ade4 QtCore`QObject::event(QEvent*) + 788\r\n    frame #18: 0x0000000101168e92 QtWidgets`QApplicationPrivate::notify_helper(QObject*, QEvent*) + 306\r\n    frame #19: 0x000000010116a1af QtWidgets`QApplication::notify(QObject*, QEvent*) + 383\r\n    frame #20: 0x0000000101de1f3f QtCore`QCoreApplication::notifyInternal2(QObject*, QEvent*) + 159\r\n    frame #21: 0x0000000101de30d2 QtCore`QCoreApplicationPrivate::sendPostedEvents(QObject*, int, QThreadData*) + 850\r\n    frame #22: 0x0000000101e36419 QtCore`QEventDispatcherUNIX::processEvents(QFlags<QEventLoop::ProcessEventsFlag>) + 73\r\n    frame #23: 0x0000000101dddc92 QtCore`QEventLoop::exec(QFlags<QEventLoop::ProcessEventsFlag>) + 418\r\n    frame #24: 0x0000000101c1f3c1 QtCore`QThread::exec() + 113\r\n    frame #25: 0x0000000101c231af QtCore`___lldb_unnamed_symbol300$$QtCore + 367\r\n    frame #26: 0x00007fffcd7c893b libsystem_pthread.dylib`_pthread_body + 180\r\n    frame #27: 0x00007fffcd7c8887 libsystem_pthread.dylib`_pthread_start + 286\r\n    frame #28: 0x00007fffcd7c808d libsystem_pthread.dylib`thread_start + 13\r\n```",
      "created_at" : "2017-11-14T14:05:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344268956",
      "id" : 344268956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-14T14:05:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/344268956",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> but it doesn't seem right that every wallet should be closed and reopened when one wallet is encrypted.\r\n\r\nThis was easier to do since there are some things in the GUI that look specifically for `vpwallets[0]`, so to close and reopen a wallet would require remove the pointer from that position in `vpwallets` and then replacing it with the newly opened wallet. That seemed to be more complicated to me than just closing and reopening all wallets, especially since order is more guaranteed to be preserved doing that than modifying `vpwallets` directly.\r\n\r\n> I don't even see a reason why the wallet that is being encrypted needs have all it's in-memory state thrown away and then the same data reloaded from disk.\r\n\r\nI thought that there were still some in-memory things that needed to be discarded (e.g. unencrypted keys) to ensure security of the wallet.",
      "created_at" : "2017-11-14T20:04:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344381057",
      "id" : 344381057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-14T20:04:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/344381057",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\nMy two worries:\r\n* let's hope no keys remain unencrypted in memory (I guess our approach is okay here)\r\n* concurrency especially with reduction of cs_main and the upcoming dynamic wallet loading (haven't checked the code) ",
      "created_at" : "2017-11-14T20:19:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344385251",
      "id" : 344385251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-14T20:19:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/344385251",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase",
      "created_at" : "2017-11-29T23:23:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-348030515",
      "id" : 348030515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11678",
      "updated_at" : "2017-11-29T23:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/348030515",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
