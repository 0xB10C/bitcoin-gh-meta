[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95610292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95610292"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Explanation of this change: Calling CCoinsViewCache::AccessCoins when no cache entry exists and the base entry is pruned no longer creates a cache entry.\r\n\r\nThe changed behavior in this case is better than the current behavior because now this case is consistent with the case in line 606 above where no cache entry exists and no base entry exists. It doesn't make any sense for the cache to behave differently just because a base entry is pruned instead of nonexistent.",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2017-01-11T16:07:07Z",
      "diff_hunk" : "@@ -612,7 +612,7 @@ BOOST_AUTO_TEST_CASE(ccoins_access)\n     CheckAccessCoins(ABSENT, VALUE2, VALUE2, FRESH      , FRESH      );\n     CheckAccessCoins(ABSENT, VALUE2, VALUE2, DIRTY      , DIRTY      );\n     CheckAccessCoins(ABSENT, VALUE2, VALUE2, DIRTY|FRESH, DIRTY|FRESH);\n-    CheckAccessCoins(PRUNED, ABSENT, PRUNED, NO_ENTRY   , FRESH      );\n+    CheckAccessCoins(PRUNED, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95610292",
      "id" : 95610292,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk1NjEwMjky",
      "original_commit_id" : "c72de76bf803254454a5dc4618bde85d1d992b7d",
      "original_position" : 5,
      "path" : "src/test/coins_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 16171111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2017-12-12T21:03:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95610292",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95611169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95611169"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Explanation of this change: Overwriting a non-dirty pruned cache entry with a fresh pruned cache entry now deletes the cache entry instead of leaving behind a dirty pruned entry that will trigger an unnecessary database write later.\r\n",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2017-01-11T16:10:36Z",
      "diff_hunk" : "@@ -826,15 +826,15 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n     CheckWriteCoins(PRUNED, ABSENT, PRUNED, DIRTY      , NO_ENTRY   , DIRTY      );\n     CheckWriteCoins(PRUNED, ABSENT, PRUNED, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n     CheckWriteCoins(PRUNED, PRUNED, PRUNED, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(PRUNED, PRUNED, PRUNED, 0          , DIRTY|FRESH, DIRTY      );\n+    CheckWriteCoins(PRUNED, PRUNED, ABSENT, 0          , DIRTY|FRESH, NO_ENTRY   );",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95611169",
      "id" : 95611169,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk1NjExMTY5",
      "original_commit_id" : "c72de76bf803254454a5dc4618bde85d1d992b7d",
      "original_position" : 14,
      "path" : "src/test/coins_tests.cpp",
      "position" : 5,
      "pull_request_review_id" : 16171111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2017-12-12T21:03:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95611169",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95611376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95611376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Explanation of this change: Overwriting a dirty pruned fresh cache entry with a nonpruned entry updates the entry without dropping the fresh flag. There's no reason to drop the fresh flag in this case because the flag accurately describes the state of the base view and could prevent unnecessary database writes in the future if the utxo is spent later.\r\n",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2017-01-11T16:11:37Z",
      "diff_hunk" : "@@ -826,15 +826,15 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n     CheckWriteCoins(PRUNED, ABSENT, PRUNED, DIRTY      , NO_ENTRY   , DIRTY      );\n     CheckWriteCoins(PRUNED, ABSENT, PRUNED, DIRTY|FRESH, NO_ENTRY   , DIRTY|FRESH);\n     CheckWriteCoins(PRUNED, PRUNED, PRUNED, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(PRUNED, PRUNED, PRUNED, 0          , DIRTY|FRESH, DIRTY      );\n+    CheckWriteCoins(PRUNED, PRUNED, ABSENT, 0          , DIRTY|FRESH, NO_ENTRY   );\n     CheckWriteCoins(PRUNED, PRUNED, ABSENT, FRESH      , DIRTY      , NO_ENTRY   );\n     CheckWriteCoins(PRUNED, PRUNED, ABSENT, FRESH      , DIRTY|FRESH, NO_ENTRY   );\n     CheckWriteCoins(PRUNED, PRUNED, PRUNED, DIRTY      , DIRTY      , DIRTY      );\n     CheckWriteCoins(PRUNED, PRUNED, PRUNED, DIRTY      , DIRTY|FRESH, DIRTY      );\n     CheckWriteCoins(PRUNED, PRUNED, ABSENT, DIRTY|FRESH, DIRTY      , NO_ENTRY   );\n     CheckWriteCoins(PRUNED, PRUNED, ABSENT, DIRTY|FRESH, DIRTY|FRESH, NO_ENTRY   );\n     CheckWriteCoins(PRUNED, VALUE2, VALUE2, 0          , DIRTY      , DIRTY      );\n-    CheckWriteCoins(PRUNED, VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY      );\n+    CheckWriteCoins(PRUNED, VALUE2, VALUE2, 0          , DIRTY|FRESH, DIRTY|FRESH);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r95611376",
      "id" : 95611376,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk1NjExMzc2",
      "original_commit_id" : "c72de76bf803254454a5dc4618bde85d1d992b7d",
      "original_position" : 23,
      "path" : "src/test/coins_tests.cpp",
      "position" : 14,
      "pull_request_review_id" : 16171111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2017-12-12T21:03:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95611376",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa, this is the PR I mentioned other day. It does move code to the modifier object, but the code could be moved if the modifier object is going away.",
      "created_at" : "2017-01-11T16:26:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-271916098",
      "id" : 271916098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDI3MTkxNjA5OA==",
      "updated_at" : "2017-01-11T16:26:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271916098",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sipa, I posted a version of your [pertxoutcache](https://github.com/sipa/bitcoin/commits/pertxoutcache) branch rebased on top of this PR here: \r\nhttps://github.com/ryanofsky/bitcoin/commits/pr/pertxoutcache\r\n\r\nIt might be useful to you even if you aren't interested in this PR because it also updates coins_tests to be compatible with your change.\r\n\r\nRelevant commits:\r\n\r\n- 6b547c287e63a48d24547f48ac8108d83dcc7266 `WIP per-txout chainstate` Ã¢ÂÂ rebased version of your main commit on top of this PR.\r\n- 5853aed217e4fd7f4a02790491ef1ea01821a2d5 `Re-enable and fix coins_test.cpp` Ã¢ÂÂ coins_test fixes that you can incorporate (regardless of the code refactoring in this PR)\r\n- 1b8425fce6498be757e663d202be025730f86725 `Fix wallet CCoinsViewCache::GetCoins call` Ã¢ÂÂ fix for compile error in wallet caused by ccoins changes\r\n ",
      "created_at" : "2017-03-01T22:30:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-283492374",
      "id" : 283492374,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDI4MzQ5MjM3NA==",
      "updated_at" : "2017-03-01T22:30:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/283492374",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased c72de76bf803254454a5dc4618bde85d1d992b7d -> 2f2d3c856520da6fcdcb82b2330515136be3f028 ([pr/ccoins-cleanup.6](https://github.com/ryanofsky/bitcoin/commits/pr/ccoins-cleanup.6) -> [pr/ccoins-cleanup.7](https://github.com/ryanofsky/bitcoin/commits/pr/ccoins-cleanup.7)) after #10195 merge.",
      "created_at" : "2017-06-02T20:03:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-305895810",
      "id" : 305895810,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDMwNTg5NTgxMA==",
      "updated_at" : "2017-06-02T20:03:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/305895810",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2018-03-06T17:15:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-370856624",
      "id" : 370856624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM3MDg1NjYyNA==",
      "updated_at" : "2018-03-06T17:15:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370856624",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--5d09a71f8925f3f132321140b44b946d-->The last travis run for this pull request was 219 days ago and is thus outdated. To trigger a fresh travis build, this pull request should be closed and re-opened.",
      "created_at" : "2018-07-20T20:30:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-406718650",
      "id" : 406718650,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwNjcxODY1MA==",
      "updated_at" : "2018-07-20T20:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/406718650",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r217879025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217879025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This looks odd? :-)",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2018-09-15T08:00:57Z",
      "diff_hunk" : "@@ -66,22 +71,14 @@ bool CCoinsViewCache::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n void CCoinsViewCache::AddCoin(const COutPoint &outpoint, Coin&& coin, bool possible_overwrite) {\n     assert(!coin.IsSpent());\n     if (coin.out.scriptPubKey.IsUnspendable()) return;\n-    CCoinsMap::iterator it;\n-    bool inserted;\n-    std::tie(it, inserted) = cacheCoins.emplace(std::piecewise_construct, std::forward_as_tuple(outpoint), std::tuple<>());\n-    bool fresh = false;\n-    if (!inserted) {\n-        cachedCoinsUsage -= it->second.coin.DynamicMemoryUsage();\n-    }\n-    if (!possible_overwrite) {\n-        if (!it->second.coin.IsSpent()) {\n-            throw std::logic_error(\"Adding new coin that replaces non-pruned entry\");\n-        }\n-        fresh = !(it->second.flags & CCoinsCacheEntry::DIRTY);\n-    }\n-    it->second.coin = std::move(coin);\n-    it->second.flags |= CCoinsCacheEntry::DIRTY | (fresh ? CCoinsCacheEntry::FRESH : 0);\n-    cachedCoinsUsage += it->second.coin.DynamicMemoryUsage();\n+    CCoinsCacheEntry entry;\n+    // If we are not possibly overwriting, any coin in the base view below the\n+    // cache will be spent, so the cache entry can be marked fresh.\n+    // If we are possibly overwriting, we can't make any assumption about the\n+    // coin in the the base view below the cache, so the new cache entry which\n+    // will replace it must be marked dirty.\n+    entry.flags |= possible_overwrite ? CCoinsCacheEntry::DIRTY : CCoinsCacheEntry::FRESH;\n+    Modifier(*this, outpoint, std::move(entry)).Modify() = std::move(coin);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r217879025",
      "id" : 217879025,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzg3OTAyNQ==",
      "original_commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "original_position" : 75,
      "path" : "src/coins.cpp",
      "position" : 75,
      "pull_request_review_id" : 155707127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2018-09-15T08:00:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217879025",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r219424234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219424234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\n2018-09-20 05:26:48 clang-tidy(pr=9384): src/coins.cpp:102:5: warning: 'coin' used after it was moved [hicpp-invalid-access-moved]\r\n```",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2018-09-21T08:44:11Z",
      "diff_hunk" : "@@ -96,19 +93,14 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction &tx, int nHeight, bool\n }\n \n bool CCoinsViewCache::SpendCoin(const COutPoint &outpoint, Coin* moveout) {\n-    CCoinsMap::iterator it = FetchCoin(outpoint);\n-    if (it == cacheCoins.end()) return false;\n-    cachedCoinsUsage -= it->second.coin.DynamicMemoryUsage();\n+    Modifier modifier(*this, outpoint);\n+    Coin& coin = modifier.Modify();\n+    bool already_spent = coin.IsSpent();\n     if (moveout) {\n-        *moveout = std::move(it->second.coin);\n-    }\n-    if (it->second.flags & CCoinsCacheEntry::FRESH) {\n-        cacheCoins.erase(it);\n-    } else {\n-        it->second.flags |= CCoinsCacheEntry::DIRTY;\n-        it->second.coin.Clear();\n+        *moveout = std::move(coin);\n     }\n-    return true;\n+    coin.Clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r219424234",
      "id" : 219424234,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxOTQyNDIzNA==",
      "original_commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "original_position" : 100,
      "path" : "src/coins.cpp",
      "position" : 100,
      "pull_request_review_id" : 157596539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2018-09-21T08:44:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219424234",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r219851897"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219851897"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this change (after #10537) would have prevented the inflation bug caused by #9049 + #10195, discussed in\r\nthe [CVE-2018-17144](https://bitcoincore.org/en/2018/09/20/notice/) full disclosure.",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2018-09-24T14:15:20Z",
      "diff_hunk" : "@@ -96,19 +93,14 @@ void AddCoins(CCoinsViewCache& cache, const CTransaction &tx, int nHeight, bool\n }\n \n bool CCoinsViewCache::SpendCoin(const COutPoint &outpoint, Coin* moveout) {\n-    CCoinsMap::iterator it = FetchCoin(outpoint);\n-    if (it == cacheCoins.end()) return false;\n-    cachedCoinsUsage -= it->second.coin.DynamicMemoryUsage();\n+    Modifier modifier(*this, outpoint);\n+    Coin& coin = modifier.Modify();\n+    bool already_spent = coin.IsSpent();\n     if (moveout) {\n-        *moveout = std::move(it->second.coin);\n-    }\n-    if (it->second.flags & CCoinsCacheEntry::FRESH) {\n-        cacheCoins.erase(it);\n-    } else {\n-        it->second.flags |= CCoinsCacheEntry::DIRTY;\n-        it->second.coin.Clear();\n+        *moveout = std::move(coin);\n     }\n-    return true;\n+    coin.Clear();\n+    return !already_spent;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r219851897",
      "id" : 219851897,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxOTg1MTg5Nw==",
      "original_commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "original_position" : 101,
      "path" : "src/coins.cpp",
      "position" : 101,
      "pull_request_review_id" : 158123897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2018-09-24T14:15:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/219851897",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r240344941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/240344941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Object created but not used?",
      "commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "created_at" : "2018-12-10T19:19:15Z",
      "diff_hunk" : "@@ -148,53 +140,7 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n         if (!(it->second.flags & CCoinsCacheEntry::DIRTY)) {\n             continue;\n         }\n-        CCoinsMap::iterator itUs = cacheCoins.find(it->first);\n-        if (itUs == cacheCoins.end()) {\n-            // The parent cache does not have an entry, while the child does\n-            // We can ignore it if it's both FRESH and pruned in the child\n-            if (!(it->second.flags & CCoinsCacheEntry::FRESH && it->second.coin.IsSpent())) {\n-                // Otherwise we will need to create it in the parent\n-                // and move the data up and mark it as dirty\n-                CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n-                cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\n-                entry.flags = CCoinsCacheEntry::DIRTY;\n-                // We can mark it FRESH in the parent if it was FRESH in the child\n-                // Otherwise it might have just been flushed from the parent's cache\n-                // and already exist in the grandparent\n-                if (it->second.flags & CCoinsCacheEntry::FRESH) {\n-                    entry.flags |= CCoinsCacheEntry::FRESH;\n-                }\n-            }\n-        } else {\n-            // Assert that the child cache entry was not marked FRESH if the\n-            // parent cache entry has unspent outputs. If this ever happens,\n-            // it means the FRESH flag was misapplied and there is a logic\n-            // error in the calling code.\n-            if ((it->second.flags & CCoinsCacheEntry::FRESH) && !itUs->second.coin.IsSpent()) {\n-                throw std::logic_error(\"FRESH flag misapplied to cache entry for base transaction with spendable outputs\");\n-            }\n-\n-            // Found the entry in the parent cache\n-            if ((itUs->second.flags & CCoinsCacheEntry::FRESH) && it->second.coin.IsSpent()) {\n-                // The grandparent does not have an entry, and the child is\n-                // modified and being pruned. This means we can just delete\n-                // it from the parent.\n-                cachedCoinsUsage -= itUs->second.coin.DynamicMemoryUsage();\n-                cacheCoins.erase(itUs);\n-            } else {\n-                // A normal modification.\n-                cachedCoinsUsage -= itUs->second.coin.DynamicMemoryUsage();\n-                itUs->second.coin = std::move(it->second.coin);\n-                cachedCoinsUsage += itUs->second.coin.DynamicMemoryUsage();\n-                itUs->second.flags |= CCoinsCacheEntry::DIRTY;\n-                // NOTE: It is possible the child has a FRESH flag here in\n-                // the event the entry we found in the parent is pruned. But\n-                // we must not copy that FRESH flag to the parent as that\n-                // pruned state likely still needs to be communicated to the\n-                // grandparent.\n-            }\n-        }\n+        Modifier(*this, it->first, std::move(it->second));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#discussion_r240344941",
      "id" : 240344941,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MDM0NDk0MQ==",
      "original_commit_id" : "2279ff50b74a4fd11379f4b22a41ace453df07d7",
      "original_position" : 156,
      "path" : "src/coins.cpp",
      "position" : 156,
      "pull_request_review_id" : 183354415,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9384",
      "updated_at" : "2018-12-10T19:19:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/240344941",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-03-15T18:10:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-473390121",
      "id" : 473390121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ3MzM5MDEyMQ==",
      "updated_at" : "2019-04-23T21:50:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/473390121",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--5d09a71f8925f3f132321140b44b946d-->The last travis run for this pull request was 281 days ago and is thus outdated. To trigger a fresh travis build, this pull request should be closed and re-opened.",
      "created_at" : "2019-04-28T19:12:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9384#issuecomment-487407255",
      "id" : 487407255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9384",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NzQwNzI1NQ==",
      "updated_at" : "2019-04-28T19:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/487407255",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
