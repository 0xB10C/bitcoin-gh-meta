[
   {
      "body" : "could we have some benchmarks do demonstrate the gains from this? though I don't doubt them, this is a fair amount of code...  and benchmarks would be important for regression testing this important behavior.",
      "created_at" : "2016-12-19T07:40:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573",
      "id" : 267900573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267900573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Which part, specifically, would you like to see benchmarks on?\n\nOn December 18, 2016 11:40:22 PM PST, Gregory Maxwell <notifications@github.com> wrote:\n>could we have some benchmarks do demonstrate the gains from this?\n>though I don't doubt them, this is a fair amount of code...  and\n>benchmarks would be important for regression testing this important\n>behavior.\n>\n>-- \n>You are receiving this because you authored the thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573\n",
      "created_at" : "2016-12-19T07:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267903170",
      "id" : 267903170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267903170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "latency to relay a block across many connections would be the obvious thing?",
      "created_at" : "2016-12-19T08:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267910206",
      "id" : 267910206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T08:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267910206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Is there ever a case where we would accept a block ourselves but we wouldn't want to immediately announce it?  I looked through all the places we call AcceptBlock/ProcessNewBlock and couldn't immediately see a problem, but want to make sure we think about it carefully.  I noticed this because I found it odd you had to change the preciousblock.py test.   BTW, a better change there may just be to allow duplicate-inconclusive in the list of results..\r\n\r\n",
      "created_at" : "2016-12-21T16:50:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268573271",
      "id" : 268573271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-21T16:50:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268573271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270"
         }
      },
      "body" : "this chunk of code is duplicated elsewhere?",
      "commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "created_at" : "2016-12-21T17:26:27Z",
      "diff_hunk" : "@@ -1492,6 +1525,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactionsRequest req;\n         vRecv >> req;\n \n+        {\n+            LOCK(cs_most_recent_block);\n+            if (most_recent_block_hash == req.blockhash) {\n+                const CBlock& block = *most_recent_block;\n+                BlockTransactions resp(req);\n+                for (size_t i = 0; i < req.indexes.size(); i++) {\n+                    if (req.indexes[i] >= block.vtx.size()) {\n+                        Misbehaving(pfrom->GetId(), 100);\n+                        LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270",
      "id" : 93482270,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 152,
      "path" : "src/net_processing.cpp",
      "position" : 152,
      "pull_request_review_id" : 14011243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2016-12-21T17:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386"
         }
      },
      "body" : "maybe add ` LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d..`",
      "commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "created_at" : "2016-12-21T19:10:57Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+            connman->PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, cmpctblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386",
      "id" : 93500386,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : 113,
      "pull_request_review_id" : 14029655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2016-12-21T19:10:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865"
         }
      },
      "body" : "shouldn't this be pindex->pprev?  I don't suppose it matters much, but I think you'll be thinking segwit activated 1 block early",
      "commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "created_at" : "2016-12-21T19:35:35Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865",
      "id" : 93504865,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : 95,
      "pull_request_review_id" : 14034251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2016-12-21T19:35:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   }
]
