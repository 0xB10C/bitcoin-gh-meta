[
   {
      "body" : "could we have some benchmarks do demonstrate the gains from this? though I don't doubt them, this is a fair amount of code...  and benchmarks would be important for regression testing this important behavior.",
      "created_at" : "2016-12-19T07:40:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573",
      "id" : 267900573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267900573",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Which part, specifically, would you like to see benchmarks on?\n\nOn December 18, 2016 11:40:22 PM PST, Gregory Maxwell <notifications@github.com> wrote:\n>could we have some benchmarks do demonstrate the gains from this?\n>though I don't doubt them, this is a fair amount of code...  and\n>benchmarks would be important for regression testing this important\n>behavior.\n>\n>-- \n>You are receiving this because you authored the thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267900573\n",
      "created_at" : "2016-12-19T07:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267903170",
      "id" : 267903170,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T07:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267903170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "latency to relay a block across many connections would be the obvious thing?",
      "created_at" : "2016-12-19T08:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-267910206",
      "id" : 267910206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-19T08:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267910206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Is there ever a case where we would accept a block ourselves but we wouldn't want to immediately announce it?  I looked through all the places we call AcceptBlock/ProcessNewBlock and couldn't immediately see a problem, but want to make sure we think about it carefully.  I noticed this because I found it odd you had to change the preciousblock.py test.   BTW, a better change there may just be to allow duplicate-inconclusive in the list of results..\r\n\r\n",
      "created_at" : "2016-12-21T16:50:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268573271",
      "id" : 268573271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-21T16:50:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268573271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270"
         }
      },
      "body" : "this chunk of code is duplicated elsewhere?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-21T17:26:27Z",
      "diff_hunk" : "@@ -1492,6 +1525,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactionsRequest req;\n         vRecv >> req;\n \n+        {\n+            LOCK(cs_most_recent_block);\n+            if (most_recent_block_hash == req.blockhash) {\n+                const CBlock& block = *most_recent_block;\n+                BlockTransactions resp(req);\n+                for (size_t i = 0; i < req.indexes.size(); i++) {\n+                    if (req.indexes[i] >= block.vtx.size()) {\n+                        Misbehaving(pfrom->GetId(), 100);\n+                        LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93482270",
      "id" : 93482270,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 152,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14011243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93482270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386"
         }
      },
      "body" : "maybe add ` LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d..`",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-21T19:10:57Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+            connman->PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, cmpctblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93500386",
      "id" : 93500386,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14029655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93500386",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865"
         }
      },
      "body" : "shouldn't this be pindex->pprev?  I don't suppose it matters much, but I think you'll be thinking segwit activated 1 block early",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-21T19:35:35Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93504865",
      "id" : 93504865,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14034251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93504865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "This seems like its going to be super awesome.\r\ncode review ACK modulo nits, doing some testing...",
      "created_at" : "2016-12-21T19:54:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268622816",
      "id" : 268622816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-21T19:54:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268622816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580220"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-22T08:07:21Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+            connman->PushMessage(pnode, msgMaker.Make(NetMsgType::CMPCTBLOCK, cmpctblock));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580220",
      "id" : 93580220,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580228"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-22T08:07:25Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580228",
      "id" : 93580228,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580239"
         }
      },
      "body" : "OK, DRY'd.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-22T08:07:31Z",
      "diff_hunk" : "@@ -1492,6 +1525,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         BlockTransactionsRequest req;\n         vRecv >> req;\n \n+        {\n+            LOCK(cs_most_recent_block);\n+            if (most_recent_block_hash == req.blockhash) {\n+                const CBlock& block = *most_recent_block;\n+                BlockTransactions resp(req);\n+                for (size_t i = 0; i < req.indexes.size(); i++) {\n+                    if (req.indexes[i] >= block.vtx.size()) {\n+                        Misbehaving(pfrom->GetId(), 100);\n+                        LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93580239",
      "id" : 93580239,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 152,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14110044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93580239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Fixed comments, note that the SendBlockTransactions function seems a bit odd now, but the goal longer-term is to move messages into their own processing groups, where such functions will be really sane.",
      "created_at" : "2016-12-22T08:08:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268742659",
      "id" : 268742659,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T08:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268742659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Perhaps Newpowvalidblock should be gated on there actually being any peers that request a compact block from us?  Otherwise we'll go through the work of constructing a compact block there only to send it to no one. :)\r\n\r\nThoughts on caching the compact block like you cache the block?  You would want it for non-pref peers that request it after you announce the header... and it's reasonably small.",
      "created_at" : "2016-12-22T12:36:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268791150",
      "id" : 268791150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T12:36:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268791150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "utACK 5bc61fa",
      "created_at" : "2016-12-22T15:25:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268822139",
      "id" : 268822139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T15:25:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268822139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@gmaxwell, well those requests are somewhat contradictory, so I picked the cache-compact-representation option :p.",
      "created_at" : "2016-12-22T23:31:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-268913893",
      "id" : 268913893,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-22T23:31:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/268913893",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@TheBlueMatt not so! as it could skip processing when there are no peers requesting, and update caches any time it processes!\r\n\r\nI don't think it matters except in one case:\r\n\r\nIsolated mining node with no HB requesting peers, constructing the short block earlier will delay block validation which delays updating the create new block.  I'm guessing the delay is <10ms, so probably inconsequential. But thought I'd bring it to your attention.",
      "created_at" : "2016-12-23T18:08:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269026347",
      "id" : 269026347,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-23T18:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269026347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Yea, I'm not worried about the processing time for calling that once. Long term I'd like to run most of the CValidationInterface callbacks into background threads, but that's probably an 0.15-targeted thing.\n\nOn December 23, 2016 1:08:51 PM EST, Gregory Maxwell <notifications@github.com> wrote:\n>@TheBlueMatt not so! as it could skip processing when there are no\n>peers requesting, and update caches any time it processes!\n>\n>I don't think it matters except in one case:\n>\n>Isolated mining node with no HB requesting peers, constructing the\n>short block earlier will delay block validation which delays updating\n>the create new block.  I'm guessing the delay is <10ms, so probably\n>inconsequential. But thought I'd bring it to your attention.\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269026347\n",
      "created_at" : "2016-12-23T18:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269027470",
      "id" : 269027470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-23T18:18:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269027470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93805927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93805927"
         }
      },
      "body" : "I believe this needs a fDisconnect check.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-23T22:27:38Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93805927",
      "id" : 93805927,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14342842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93805927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93811196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93811196"
         }
      },
      "body" : "Fixed",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-24T02:05:31Z",
      "diff_hunk" : "@@ -752,6 +752,29 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93811196",
      "id" : 93811196,
      "original_commit_id" : "1fcf0cc93bd5069da37820644f020b5a7599f9b6",
      "original_position" : 13,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14347930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93811196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Squashed with no diff-tree.",
      "created_at" : "2016-12-24T16:18:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269090520",
      "id" : 269090520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-24T16:18:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269090520",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93887479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93887479"
         }
      },
      "body" : "@morcos don't you mean one block late?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-27T00:06:01Z",
      "diff_hunk" : "@@ -752,6 +752,39 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex, Params().GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r93887479",
      "id" : 93887479,
      "original_commit_id" : "0e6f73893f6e8abe916def8a34ca8a7f949960b8",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14419640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93887479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94175781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94175781"
         }
      },
      "body" : "Hmm, this is non-obvious to a caller. And it's especially bad that one of them relies on the const not actually being const :(\r\n\r\nMaybe return an updated index, or null in the case of failure? Or return a pair?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T20:15:24Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94175781",
      "id" : 94175781,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : 11,
      "pull_request_review_id" : 14706977,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94175781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177486"
         }
      },
      "body" : "Maybe teach ReadBlockFromDisk to read to a shared_ptr reference to avoid the temptation?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T20:34:44Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177486",
      "id" : 94177486,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 14708654,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177684"
         }
      },
      "body" : "Or just use a new precursiveblock here with limited scope",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T20:37:18Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94177684",
      "id" : 94177684,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 14708846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94177684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94178076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94178076"
         }
      },
      "body" : "Really? I dont see anything non-obvious here? The caller passes in a reference to a const CBlockIndex*, and the function sets that element to the new CBlockIndex*, ie it is returning a const CBlockIndex*, not editing a CBlockIndex which was passed in.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T20:41:37Z",
      "diff_hunk" : "@@ -3029,12 +3029,14 @@ static bool AcceptBlockHeader(const CBlockHeader& block, CValidationState& state\n }\n \n // Exposed wrapper for AcceptBlockHeader\n-bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex)\n+bool ProcessNewBlockHeaders(const std::vector<CBlockHeader>& headers, CValidationState& state, const CChainParams& chainparams, const CBlockIndex** ppindex)\n {\n     {\n         LOCK(cs_main);\n         for (const CBlockHeader& header : headers) {\n-            if (!AcceptBlockHeader(header, state, chainparams, ppindex)) {\n+            // cast away the ppindex-returns-const CBlockIndex - we're just assigning it to a CBlockIndex*",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94178076",
      "id" : 94178076,
      "original_commit_id" : "c3084dd684e9ecc1e0171159cfe36f580d87ba25",
      "original_position" : 11,
      "path" : "src/validation.cpp",
      "position" : 11,
      "pull_request_review_id" : 14709248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94178076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179029"
         }
      },
      "body" : "How about generating a set of to-be-sent nodes here, with cs_main scope-locked. Then pass the set into ForEachNode and send only to the matches?\r\n\r\nThat saves cs_main (or whatever lock) from being held for the duration, and opens the door to deduped sending.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T20:53:25Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179029",
      "id" : 94179029,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 14710167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179883"
         }
      },
      "body" : "Make this a member of PeerLogicValidation, then you can use a weak_ptr for the global, and I think no locks are needed",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:04:09Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94179883",
      "id" : 94179883,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14711047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94179883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180406"
         }
      },
      "body" : "AFICT the only difference is that we can skip calling connman->PushMessage....is connman->PushMessage slow enough to care?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:11:05Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180406",
      "id" : 94180406,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 14711559,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180477"
         }
      },
      "body" : "No need to stay locked for PushMessage",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:11:56Z",
      "diff_hunk" : "@@ -1082,6 +1092,23 @@ uint32_t GetFetchFlags(CNode* pfrom, const CBlockIndex* pprev, const Consensus::\n     return nFetchFlags;\n }\n \n+inline void static SendBlockTransactions(const CBlock& block, const BlockTransactionsRequest& req, CNode* pfrom, CConnman& connman) {\n+    BlockTransactions resp(req);\n+    for (size_t i = 0; i < req.indexes.size(); i++) {\n+        if (req.indexes[i] >= block.vtx.size()) {\n+            LOCK(cs_main);\n+            Misbehaving(pfrom->GetId(), 100);\n+            LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n+            return;\n+        }\n+        resp.txn[i] = block.vtx[req.indexes[i]];\n+    }\n+    LOCK(cs_main);\n+    CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+    int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94180477",
      "id" : 94180477,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : 171,
      "pull_request_review_id" : 14711623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94180477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181018"
         }
      },
      "body" : "You can avoid calling it for each node by iterating mapNodeState for the set up front.\r\n\r\nOne PushMessage is no concern, but avoiding it for the entire ForEachNode would be nice.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:18:12Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181018",
      "id" : 94181018,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 14712144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181609"
         }
      },
      "body" : "Actually, nevermind. We can improve CConnman's interface for this kind of thing later.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:25:18Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181609",
      "id" : 94181609,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 14712700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181763"
         }
      },
      "body" : "Yup, that was my (too heavily implied) point :).",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:27:14Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94181763",
      "id" : 94181763,
      "original_commit_id" : "a14126ad3ba91afeb5c8fb4b0748588d0ee1b6fc",
      "original_position" : 10,
      "path" : "src/net_processing.cpp",
      "position" : 97,
      "pull_request_review_id" : 14712844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94181763",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184557"
         }
      },
      "body" : "I'm confused as to exactly what you're suggesting here. I don't particularly want a weak_ptr because I do want to hold the latest block for responses for a while after the block is connected/broadcast.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:57:41Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184557",
      "id" : 94184557,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14715534,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184711"
         }
      },
      "body" : "Is it slow enough to matter? After #9414 (and some std::atomic usage) we need to remove the cs_main lock completely here to make getblocktxn for the current head cs_main-free.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T21:59:42Z",
      "diff_hunk" : "@@ -1082,6 +1092,23 @@ uint32_t GetFetchFlags(CNode* pfrom, const CBlockIndex* pprev, const Consensus::\n     return nFetchFlags;\n }\n \n+inline void static SendBlockTransactions(const CBlock& block, const BlockTransactionsRequest& req, CNode* pfrom, CConnman& connman) {\n+    BlockTransactions resp(req);\n+    for (size_t i = 0; i < req.indexes.size(); i++) {\n+        if (req.indexes[i] >= block.vtx.size()) {\n+            LOCK(cs_main);\n+            Misbehaving(pfrom->GetId(), 100);\n+            LogPrintf(\"Peer %d sent us a getblocktxn with out-of-bounds tx indices\", pfrom->id);\n+            return;\n+        }\n+        resp.txn[i] = block.vtx[req.indexes[i]];\n+    }\n+    LOCK(cs_main);\n+    CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+    int nSendFlags = State(pfrom->GetId())->fWantsCmpctWitness ? 0 : SERIALIZE_TRANSACTION_NO_WITNESS;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94184711",
      "id" : 94184711,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : 171,
      "pull_request_review_id" : 14715673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94184711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94186100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186100"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-29T22:16:44Z",
      "diff_hunk" : "@@ -3799,16 +3802,19 @@ bool LoadExternalBlockFile(const CChainParams& chainparams, FILE* fileIn, CDiskB\n                     std::pair<std::multimap<uint256, CDiskBlockPos>::iterator, std::multimap<uint256, CDiskBlockPos>::iterator> range = mapBlocksUnknownParent.equal_range(head);\n                     while (range.first != range.second) {\n                         std::multimap<uint256, CDiskBlockPos>::iterator it = range.first;\n-                        if (ReadBlockFromDisk(block, it->second, chainparams.GetConsensus()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94186100",
      "id" : 94186100,
      "original_commit_id" : "1af5e30d2ca2c65fd217b1fbcbcc0b4dec4d4f39",
      "original_position" : 44,
      "path" : "src/validation.cpp",
      "position" : 72,
      "pull_request_review_id" : 14717032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Fixed one of @theuni's comments and rebased. Diff is https://0bin.net/paste/lZfeK4vg0ZdebkqX#AJKsFyZ3Ai1oiaRiUt-1S0tjFK9wrZ70aP74IepwbsY",
      "created_at" : "2016-12-29T22:18:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269702309",
      "id" : 269702309,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-29T22:18:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269702309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94196147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94196147"
         }
      },
      "body" : "These are the types of changes that make me nervous about shared_ptrs, because it gets easy to start stashing things that have no obvious lifetime constraint.\r\n\r\nI was suggesting that you hold the shared_ptr in the PeerLogicValidation class. You then use a global weak_ptr which is overwritten by each new block. Then at any random time you can use std::shared_ptr\\<const CBlock\\> bestblock = shared_ptrglobal_last_block.lock().\r\n\r\nThat way you can extend the lifetime of the whatever block is current, but it's also obvious when it will be destroyed (with the PeerLogicValidation destruction).",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2016-12-30T01:17:25Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94196147",
      "id" : 94196147,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14727146,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94196147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "One behavior that should be mentioned is that caching means that if I am connected to a since node via multiple channels, it will identify itself as the same node by using the same salt across them.  The salt sharing is something the protocol was carefully designed to enable, and there are _many_ other ways that a node identifies itself as equal on different links: so I don't consider it a concern. But since we do sometimes fix 'fingerprinting' it might surprise someone.\r\n\r\n(My view is that we fix fingerprinting that happens at different times-- that the host that was at 1.2.3.4 is now at 2.3.4.5--, but verifying that two peers you are currently connected to are really the same peer, is too hard to avoid.)\r\n",
      "created_at" : "2016-12-30T02:48:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269725290",
      "id" : 269725290,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-30T02:48:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269725290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "re-ACK 8022035\r\n\r\nhuge improvement to cache the cmpctblock, reduces time to relay cmpctblock to each additional peer from 30ms to 1ms.\r\n\r\n\r\n",
      "created_at" : "2016-12-30T17:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269799728",
      "id" : 269799728,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-30T17:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269799728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Mentioned on IRC, combining this with #9400 can lead to intermittent failures of `sendheaders.py`\r\n\r\n#9400 causes the node announcing the reorg in that test to be a HB peer, and block requests generated by FindNextBlocksToDownload in response to cmpctblocks relayed by NewPoWValidBlock are in a race condition against the tip being updated in the announcing peer.",
      "created_at" : "2016-12-31T00:29:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269838990",
      "id" : 269838990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-31T00:29:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269838990",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "As @morcos points out, this needs a bit more thought - currently you might announce a compact block in HB mode, the receiving peer might then, for various reasons, request a response in the form of a full block instead of as a getblocktxn (eg #8800). At this point, you unlock cs_main prior to ActivateBestChain in ProcessNewBlock, allowing the other peer's block request the be processed, but you will not respond because you \"dont have the block\". A simple fix might be calling ActivateBestChain prior to block requests (since we cannot simply respond with the block without having validated it - this would be a protocol violation).",
      "created_at" : "2016-12-31T16:16:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269871618",
      "id" : 269871618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2016-12-31T16:16:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269871618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Pushed a new commit which appears to fix @morcos' test failures in #9447. See the BIP clarifications at https://github.com/bitcoin/bips/pull/486 for associated info.",
      "created_at" : "2017-01-01T03:32:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269891019",
      "id" : 269891019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9375",
      "updated_at" : "2017-01-01T03:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269891019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94279801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94279801"
         }
      },
      "body" : "Hmm...does this make it that much more obvious? We still have a shared_ptr which is overwritten in NewPoWValidBlock and other sites which take references to it to extend its lifetime. I can add a comment noting that users MUST NOT extend the lifetime significantly, would that be sufficient to address your concern?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2017-01-01T03:37:36Z",
      "diff_hunk" : "@@ -760,6 +764,12 @@ void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std:\n     bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n     uint256 hashBlock(pblock->GetHash());\n \n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94279801",
      "id" : 94279801,
      "original_commit_id" : "2ad1f254aa2a6d5dca6ab2338a7cea0e4dfcfb4b",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14809836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T03:37:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94279801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94282320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282320"
         }
      },
      "body" : "`__func__` can be used here?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2017-01-01T10:27:27Z",
      "diff_hunk" : "@@ -752,6 +752,45 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    {\n+        LOCK(cs_most_recent_block);\n+        most_recent_block_hash = hashBlock;\n+        most_recent_block = pblock;\n+        most_recent_compact_block = pcmpctblock;\n+    }\n+\n+    connman->ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94282320",
      "id" : 94282320,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 117,
      "path" : "src/net_processing.cpp",
      "position" : 117,
      "pull_request_review_id" : 14811940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T10:27:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94285460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94285460"
         }
      },
      "body" : "I'm not sure that it can due to the use of the inline function - do you care to test what `__FUNC__` means on different compilers in this case?",
      "commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "created_at" : "2017-01-01T15:35:17Z",
      "diff_hunk" : "@@ -752,6 +752,45 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+static CCriticalSection cs_most_recent_block;\n+static std::shared_ptr<const CBlock> most_recent_block;\n+static std::shared_ptr<CBlockHeaderAndShortTxIDs> most_recent_compact_block;\n+static uint256 most_recent_block_hash;\n+\n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    std::shared_ptr<CBlockHeaderAndShortTxIDs> pcmpctblock = std::make_shared<CBlockHeaderAndShortTxIDs> (*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    {\n+        LOCK(cs_most_recent_block);\n+        most_recent_block_hash = hashBlock;\n+        most_recent_block = pblock;\n+        most_recent_compact_block = pcmpctblock;\n+    }\n+\n+    connman->ForEachNode([this, &pcmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9375#discussion_r94285460",
      "id" : 94285460,
      "original_commit_id" : "73817e22946d0f00957b18443635656ec40914ad",
      "original_position" : 117,
      "path" : "src/net_processing.cpp",
      "position" : 117,
      "pull_request_review_id" : 14814660,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9375",
      "updated_at" : "2017-01-01T15:35:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94285460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
