[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92882079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92882079"
         }
      },
      "body" : "It's better to have a single return statement that returns a local variable over using std::move:\r\n\r\n```c++\r\n    ...\r\n    std::vector<CTransactionRef> temp;\r\n    if (trackRemovalsCount == 0) {\r\n        temp.emplace_back(std::move(removedTxs));\r\n        removedTxs.clear();\r\n    }\r\n    return temp;\r\n}\r\n```\r\n\r\nThis allows the compiler to use NVRO (named return value optimization) - the `temp` variable essentially becomes an alias for the returned object.\r\n",
      "commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "created_at" : "2016-12-16T20:38:46Z",
      "diff_hunk" : "@@ -469,11 +469,43 @@ void CTxMemPool::removeUnchecked(txiter it)\n     cachedInnerUsage -= it->DynamicMemoryUsage();\n     cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n     mapLinks.erase(it);\n+    if (!minedInBlock) {\n+        if (trackRemovalsCount) {\n+            removedTxs.emplace_back(it->GetSharedTx());\n+        }\n+        else {\n+            // If there are ever intentionally removals that are not\n+            // meant to be tracked (so they can be notified on), then\n+            // this log message can be removed.\n+            LogPrint(\"mempool\", \"MemPoolRemovalTracker not tracking removed transaction %s\\n\",hash.ToString());\n+        }\n+    }\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n     minerPolicyEstimator->removeTx(hash);\n }\n \n+void CTxMemPool::startTrackingRemovals()\n+{\n+    LOCK(cs);\n+    trackRemovalsCount++;\n+}\n+\n+std::vector<CTransactionRef>  CTxMemPool::stopTrackingRemovals() {\n+    LOCK(cs);\n+    assert(trackRemovalsCount);\n+    trackRemovalsCount--;\n+    if (trackRemovalsCount == 0) {\n+        std::vector<CTransactionRef> temp(std::move(removedTxs));\n+        removedTxs.clear();\n+        return std::move(temp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92882079",
      "id" : 92882079,
      "original_commit_id" : "64712d66f7884a42db2bc193efbdb810f5f76edd",
      "original_position" : 51,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 13407054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371",
      "updated_at" : "2016-12-16T20:38:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92882079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92887197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92887197"
         }
      },
      "body" : "Using swap in the middle could be a nice way to simplify this:\r\n\r\n```\r\n    std::vector<CTransactionRef> temp;\r\n    if (trackRemovalsCount == 0)\r\n        temp.swap(removedTxs);\r\n    return temp;\r\n```",
      "commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "created_at" : "2016-12-16T21:15:03Z",
      "diff_hunk" : "@@ -469,11 +469,43 @@ void CTxMemPool::removeUnchecked(txiter it)\n     cachedInnerUsage -= it->DynamicMemoryUsage();\n     cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n     mapLinks.erase(it);\n+    if (!minedInBlock) {\n+        if (trackRemovalsCount) {\n+            removedTxs.emplace_back(it->GetSharedTx());\n+        }\n+        else {\n+            // If there are ever intentionally removals that are not\n+            // meant to be tracked (so they can be notified on), then\n+            // this log message can be removed.\n+            LogPrint(\"mempool\", \"MemPoolRemovalTracker not tracking removed transaction %s\\n\",hash.ToString());\n+        }\n+    }\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n     minerPolicyEstimator->removeTx(hash);\n }\n \n+void CTxMemPool::startTrackingRemovals()\n+{\n+    LOCK(cs);\n+    trackRemovalsCount++;\n+}\n+\n+std::vector<CTransactionRef>  CTxMemPool::stopTrackingRemovals() {\n+    LOCK(cs);\n+    assert(trackRemovalsCount);\n+    trackRemovalsCount--;\n+    if (trackRemovalsCount == 0) {\n+        std::vector<CTransactionRef> temp(std::move(removedTxs));\n+        removedTxs.clear();\n+        return std::move(temp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92887197",
      "id" : 92887197,
      "original_commit_id" : "64712d66f7884a42db2bc193efbdb810f5f76edd",
      "original_position" : 51,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 13412400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371",
      "updated_at" : "2016-12-16T21:15:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92887197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92965473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92965473"
         }
      },
      "body" : "Is this the only notification, or is the GUI notified also?",
      "commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "created_at" : "2016-12-19T03:56:33Z",
      "diff_hunk" : "@@ -469,11 +469,43 @@ void CTxMemPool::removeUnchecked(txiter it)\n     cachedInnerUsage -= it->DynamicMemoryUsage();\n     cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n     mapLinks.erase(it);\n+    if (!minedInBlock) {\n+        if (trackRemovalsCount) {\n+            removedTxs.emplace_back(it->GetSharedTx());\n+        }\n+        else {\n+            // If there are ever intentionally removals that are not\n+            // meant to be tracked (so they can be notified on), then\n+            // this log message can be removed.\n+            LogPrint(\"mempool\", \"MemPoolRemovalTracker not tracking removed transaction %s\\n\",hash.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92965473",
      "id" : 92965473,
      "original_commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "original_position" : 30,
      "path" : "src/txmempool.cpp",
      "position" : 30,
      "pull_request_review_id" : 13486423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371",
      "updated_at" : "2016-12-19T03:56:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92965473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Is there a way to isolate these changes to the wallet code only?\r\nI understand it is to fix a problem there,  but ideally I'd rather see just a primitive mechanism in the mempool for removal events,  and the wallet then handle that with a \"mempool removal tracker\" and such.\r\n\r\nAFAIK, non-wallet users don't need this or #9240 reverted.",
      "created_at" : "2016-12-19T04:09:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#issuecomment-267878008",
      "id" : 267878008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9371",
      "updated_at" : "2016-12-19T04:09:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267878008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "> I'd rather see just a primitive mechanism in the mempool for removal events, and the wallet then handle that with a \"mempool removal tracker\" and such.\r\n\r\nIn #8549 I had added a specific signal on the mempool to be notified of removed transactions, even with a reason field.\r\nI think this was slightly more elegant than having a stateful StartTracking/StopTracking in the mempool itself and keeping a vector there (which means there can only be one client at a time). A client could easily handle the part of accumulating notifications into a vector itself, if that is desired.\r\n",
      "created_at" : "2016-12-19T07:22:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#issuecomment-267898126",
      "id" : 267898126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9371",
      "updated_at" : "2016-12-19T07:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267898126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Agree with @laanwj: the reason enum is really what we should have for mempool removal notifications: https://github.com/bitcoin/bitcoin/pull/8549/files#diff-d8e6fe13399f13c42a93ec8326c60614R150",
      "created_at" : "2016-12-19T07:35:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#issuecomment-267899860",
      "id" : 267899860,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9371",
      "updated_at" : "2016-12-19T07:35:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267899860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Agree with @laanwj,  I actually thought that was merged and was wondering why this wasn't using it.",
      "created_at" : "2016-12-19T07:44:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#issuecomment-267901192",
      "id" : 267901192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9371",
      "updated_at" : "2016-12-19T07:44:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/267901192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   }
]
