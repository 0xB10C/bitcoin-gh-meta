[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92882079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92882079"
         }
      },
      "body" : "It's better to have a single return statement that returns a local variable over using std::move:\r\n\r\n```c++\r\n    ...\r\n    std::vector<CTransactionRef> temp;\r\n    if (trackRemovalsCount == 0) {\r\n        temp.emplace_back(std::move(removedTxs));\r\n        removedTxs.clear();\r\n    }\r\n    return temp;\r\n}\r\n```\r\n\r\nThis allows the compiler to use NVRO (named return value optimization) - the `temp` variable essentially becomes an alias for the returned object.\r\n",
      "commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "created_at" : "2016-12-16T20:38:46Z",
      "diff_hunk" : "@@ -469,11 +469,43 @@ void CTxMemPool::removeUnchecked(txiter it)\n     cachedInnerUsage -= it->DynamicMemoryUsage();\n     cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n     mapLinks.erase(it);\n+    if (!minedInBlock) {\n+        if (trackRemovalsCount) {\n+            removedTxs.emplace_back(it->GetSharedTx());\n+        }\n+        else {\n+            // If there are ever intentionally removals that are not\n+            // meant to be tracked (so they can be notified on), then\n+            // this log message can be removed.\n+            LogPrint(\"mempool\", \"MemPoolRemovalTracker not tracking removed transaction %s\\n\",hash.ToString());\n+        }\n+    }\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n     minerPolicyEstimator->removeTx(hash);\n }\n \n+void CTxMemPool::startTrackingRemovals()\n+{\n+    LOCK(cs);\n+    trackRemovalsCount++;\n+}\n+\n+std::vector<CTransactionRef>  CTxMemPool::stopTrackingRemovals() {\n+    LOCK(cs);\n+    assert(trackRemovalsCount);\n+    trackRemovalsCount--;\n+    if (trackRemovalsCount == 0) {\n+        std::vector<CTransactionRef> temp(std::move(removedTxs));\n+        removedTxs.clear();\n+        return std::move(temp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92882079",
      "id" : 92882079,
      "original_commit_id" : "64712d66f7884a42db2bc193efbdb810f5f76edd",
      "original_position" : 51,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 13407054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371",
      "updated_at" : "2016-12-16T20:38:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92882079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92887197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92887197"
         }
      },
      "body" : "Using swap in the middle could be a nice way to simplify this:\r\n\r\n```\r\n    std::vector<CTransactionRef> temp;\r\n    if (trackRemovalsCount == 0)\r\n        temp.swap(removedTxs);\r\n    return temp;\r\n```",
      "commit_id" : "f3baf89e0de30d551e701c16cdba66062ab12df0",
      "created_at" : "2016-12-16T21:15:03Z",
      "diff_hunk" : "@@ -469,11 +469,43 @@ void CTxMemPool::removeUnchecked(txiter it)\n     cachedInnerUsage -= it->DynamicMemoryUsage();\n     cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n     mapLinks.erase(it);\n+    if (!minedInBlock) {\n+        if (trackRemovalsCount) {\n+            removedTxs.emplace_back(it->GetSharedTx());\n+        }\n+        else {\n+            // If there are ever intentionally removals that are not\n+            // meant to be tracked (so they can be notified on), then\n+            // this log message can be removed.\n+            LogPrint(\"mempool\", \"MemPoolRemovalTracker not tracking removed transaction %s\\n\",hash.ToString());\n+        }\n+    }\n     mapTx.erase(it);\n     nTransactionsUpdated++;\n     minerPolicyEstimator->removeTx(hash);\n }\n \n+void CTxMemPool::startTrackingRemovals()\n+{\n+    LOCK(cs);\n+    trackRemovalsCount++;\n+}\n+\n+std::vector<CTransactionRef>  CTxMemPool::stopTrackingRemovals() {\n+    LOCK(cs);\n+    assert(trackRemovalsCount);\n+    trackRemovalsCount--;\n+    if (trackRemovalsCount == 0) {\n+        std::vector<CTransactionRef> temp(std::move(removedTxs));\n+        removedTxs.clear();\n+        return std::move(temp);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9371#discussion_r92887197",
      "id" : 92887197,
      "original_commit_id" : "64712d66f7884a42db2bc193efbdb810f5f76edd",
      "original_position" : 51,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 13412400,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9371",
      "updated_at" : "2016-12-16T21:15:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/92887197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
