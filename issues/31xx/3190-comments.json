[
   {
      "body" : "I am seeing this in my log for the latest master too. The nodes eventually get banned for it.The nodes sending empty transactions are running 0.8.5 (I'm only seeing 0.8.5 nodes, and 0.8.99). Of my peers I'm seeing at least one `vin empty` ban score increase every 10 minutes. ",
      "created_at" : "2013-11-30T02:20:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29544182",
      "id" : 29544182,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-11-30T02:21:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29544182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=3",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   },
   {
      "body" : "My assumption here (has been for a while, I haven't had time to dig in) that at some point a mapWallet[hash] or wallettx.vtxPrev[hash] is accessed with an inexisting transaction hash, resulting in empty transaction that get relayed.",
      "created_at" : "2013-11-30T10:37:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29549996",
      "id" : 29549996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-11-30T10:37:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29549996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "https://blockchain.info/rejected\r\n\r\n![f](https://f.cloud.github.com/assets/5250052/1648656/32eb8474-59af-11e3-8fa5-9e524e5f16c2.png)\r\n\r\nCurious that they're seeing huge blocks of them all at the exact same second. Wouldn't it be random if it was part of the wallet transaction resending function? Almost every instance of the error in their public logs is big blocks all occurring within a second of each other. ",
      "created_at" : "2013-11-30T11:06:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29550415",
      "id" : 29550415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-11-30T11:07:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29550415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=3",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   },
   {
      "body" : "That'd make sense. These are all the places where mapWallet[...] is used:\r\n\r\n1. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/rpcwallet.cpp#L1671\">rpcwallet.cpp</a>:    <code>const CWalletTx& wtx = pwalletMain->mapWallet[hash];</code> **Ã¢ÂÂ count is checked beforehand**\r\n2. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/wallet.cpp#L762\">wallet.cpp</a>:               <code>mapWalletPrev[txWalletPrev.GetHash()] = &txWalletPrev;</code>\r\n3. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/wallet.cpp#L766\">wallet.cpp</a>:                    <code>tx = \\*mapWalletPrev[hash];</code>  **Ã¢ÂÂ count is checked beforehand**\r\n4. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/wallet.cpp#L1399\">wallet.cpp</a>:                <code>CWalletTx &coin = mapWallet[txin.prevout.hash];</code> **Ã¢ÂÂ count is NOT checked beforehand**\r\n5. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/wallet.cpp#L1749\">wallet.cpp</a>:                <code>if(!ExtractDestination(mapWallet[txin.prevout.hash].vout[txin.prevout.n].scriptPubKey, address))</code> **Ã¢ÂÂ count is NOT checked beforehand**\r\n6. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/walletdb.cpp#L360\">walletdb.cpp</a>:            <code>CWalletTx& wtx = pwallet->mapWallet[hash];</code> **Ã¢ÂÂ record is populated from BDB afterwards**\r\n7. <a href=\"https://github.com/bitcoin/bitcoin/blob/master/src/walletdb.cpp#L668\">walletdb.cpp</a>:        <code>WriteTx(hash, pwallet->mapWallet[hash]);</code> **Ã¢ÂÂ only called if hash was already in wallet**\r\n",
      "created_at" : "2013-11-30T14:47:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29553549",
      "id" : 29553549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-11-30T14:47:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29553549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Another hypothesis (from @wtogami) is that this has to do with transactions in the wallet that are double spent (or otherwise linger around in the wallet a long time without being mined), and somehow end up being broadcasted empty instead of being ignored.\r\n",
      "created_at" : "2013-12-04T11:33:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29797781",
      "id" : 29797781,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-12-04T11:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29797781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I have an old Litecoin testnet wallet.dat with stuck tx from 6 months ago from a time when I was testing fee violating tx creation.  Today this wallet.dat causes rebroadcast of the old tx with empty vin and +10 banscore seen in the peer's debug.log.  I gave a copy of this wallet.dat to @laanwj for analysis.",
      "created_at" : "2013-12-04T11:49:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29798665",
      "id" : 29798665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-12-04T11:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29798665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/93665?v=3",
         "events_url" : "https://api.github.com/users/wtogami/events{/privacy}",
         "followers_url" : "https://api.github.com/users/wtogami/followers",
         "following_url" : "https://api.github.com/users/wtogami/following{/other_user}",
         "gists_url" : "https://api.github.com/users/wtogami/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/wtogami",
         "id" : 93665,
         "login" : "wtogami",
         "organizations_url" : "https://api.github.com/users/wtogami/orgs",
         "received_events_url" : "https://api.github.com/users/wtogami/received_events",
         "repos_url" : "https://api.github.com/users/wtogami/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/wtogami/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/wtogami/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/wtogami"
      }
   },
   {
      "body" : "Some first conclusions from analysing @wtogami 's wallet using pywallet:\r\n\r\n- There is no actual transaction in the wallet with 0 vins\r\n- The transaction id that is reported on the other side causing the misbehavior ban does not actually exist in the wallet:\r\n\r\n    2013-12-04 11:41:15 **d21633ba23f70118185227be58a63527675641ad37967e2aa461559f577aec43** from /Satoshi:0.8.5.2/ was not accepted into the memory pool\r\n\r\nThis would make me think that either something goes wrong while broadcasting the transaction (which causes an empty transaction to be sent instead) or something goes wrong on the receiving end. In any case, the wallet itself does not seem to be corrupted.\r\n\r\nI've added some debug information to `CWalletTx::RelayWalletTransaction` https://github.com/litecoin-project/litecoin/blob/master-0.8/src/wallet.cpp#L846; the following transactions are retransmitted by the wallet\r\n\r\n    2013-12-04 13:29:12 ResendWalletTransactions(1)\r\n    2013-12-04 13:29:12   Relaying wtx prev 6521bde62cbe8eaf6a4fd9db02116cf592dd4fe65c598dadbde78c0118432769\r\n    2013-12-04 13:29:12   Relaying wtx prev 6521bde62cbe8eaf6a4fd9db02116cf592dd4fe65c598dadbde78c0118432769\r\n    2013-12-04 13:29:12   Relaying wtx prev 729bd6dfd9981591089fbf96c5153964bb999414ce9fac4ac45038fcc364f2fd\r\n    ...\r\n    (in RelayWalletTransaction(1ce01b9bf5776646fbff0a3d0fd0905379490e5b7b296fead5ca5e775b14f7e6) )\r\n    2013-12-04 13:29:12   Relaying wtx prev d21633ba23f70118185227be58a63527675641ad37967e2aa461559f577aec43\r\n    2013-12-04 13:29:12   Relaying wtx prev d21633ba23f70118185227be58a63527675641ad37967e2aa461559f577aec43\r\n    2013-12-04 13:29:12   Relaying wtx prev be0badd502f113001d0e05ab4f2d1790f1461a749cd88511716744c82537cf41\r\n    2013-12-04 13:29:12   Relaying wtx prev c873a065f74f37706b6196e74f5d085d55f06d29c98000fb99327f3fe3c11d8b\r\n\r\n\"wtx prev\" are dependency transactions, transmitted in the first part of the function, \"wtx\" are the transactions themselves.\r\n\r\nWhoah... our culprit, `d21633ba23f70118185227be58a63527675641ad37967e2aa461559f577aec43` is between the \"wtx prev\" transactions.\r\n\r\nIt is being transmitted for a transaction that isn't even transmitted itself: tx id `1ce01b9bf5776646fbff0a3d0fd0905379490e5b7b296fead5ca5e775b14f7e6`.\r\n\r\nGettransaction for this transaction shows:\r\n\r\n     {\r\n      \"amount\" : -0.01900000,\r\n      \"fee\" : -0.00100000,\r\n      \"confirmations\" : 383,\r\n      \"blockhash\" : \"b7efacff198713bdc84db0d4cd0a750727d7a520aca4b4eb147cbb925c9d68f2\",\r\n      \"blockindex\" : 1,\r\n      \"blocktime\" : 1385991737,\r\n      \"txid\" : \"1ce01b9bf5776646fbff0a3d0fd0905379490e5b7b296fead5ca5e775b14f7e6\",\r\n      \"time\" : 1386036379,\r\n      \"timereceived\" : 1386036379,\r\n      \"details\" : [\r\n          {\r\n              \"account\" : \"\",\r\n              \"address\" : \"mnwLq9mMv6tmARNmN6fQhDgjrofSQVkFru\",\r\n              \"category\" : \"send\",\r\n              \"amount\" : -0.01900000,\r\n              \"fee\" : -0.00100000\r\n          }\r\n      ]\r\n\r\nSo it's an old, confirmed transaction...\r\n",
      "created_at" : "2013-12-04T13:11:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29803120",
      "id" : 29803120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-12-04T13:46:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29803120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Hah... found it\r\n\r\nhttps://github.com/litecoin-project/litecoin/blob/master-0.8/src/wallet.cpp#L745  this if statement needs an `else continue;` currenly, if none of the two cases is hit, it stores an emptty transaction.\r\n\r\nThis would prevent invalid vtxPrevs from getting into the wallet, not existing ones getting broadcasted...\r\n",
      "created_at" : "2013-12-04T14:28:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29808541",
      "id" : 29808541,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-12-04T14:28:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29808541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Should be solved by #3356 and #3357",
      "created_at" : "2013-12-05T07:18:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/3190#issuecomment-29876433",
      "id" : 29876433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3190",
      "updated_at" : "2013-12-05T07:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/29876433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
