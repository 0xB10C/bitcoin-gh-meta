[
   {
      "body" : "Tested it myself. I can reproduce the failed disconnect at startup in master, but no problem appears with this patch.",
      "created_at" : "2013-10-26T20:23:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27154905",
      "id" : 27154905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-26T20:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27154905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "I can also confirm that it makes the startup problem go away.  Perhaps we should add a couple of test cases with these in a reorg in pulltester before we call it cured?  (E.g. four transactions: 1 op_return, 2 op_return, 1 op_return and one regular, in both orders. Mine them, reorg them out, put them back in later.)",
      "created_at" : "2013-10-26T20:37:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27155235",
      "id" : 27155235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-26T20:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27155235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "@gmaxwell PullTester doesn't seem to be running the comparison tool anymore.",
      "created_at" : "2013-10-26T21:35:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27156326",
      "id" : 27156326,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-26T21:35:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27156326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Odd, I tried to reproduce the problem in git master with ./bitcoind -checkblocks=10500, which is more than enough to check the failing block, but I'm not seeing the error. Tried default checklevel, and checklevel=4 as well.",
      "created_at" : "2013-10-28T04:01:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27188408",
      "id" : 27188408,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T04:01:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27188408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "@petertodd not odd at all, the reorg test is memory limited and only goes as far back as the dbcache size allows. Effectively the checklevel is lower for blocks further back than that.",
      "created_at" : "2013-10-28T04:09:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27188535",
      "id" : 27188535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T04:09:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27188535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Ah. With -dbcache set appropriately I can reproduce the bug on master, and this pull-req fixes it.\r\n\r\nI think this patch needs some comments explaining what's going on re: the immediately pruned case, but otherwise looks good. Maybe something like the following:\r\n\r\n    Check that all outputs are available and match the outputs in the block itself\r\n    exactly. Note that transactions with only provably unspendable outputs won't\r\n    have outputs available even in the block itself, so we handle that case\r\n    specially with outsEmpty.\r\n\r\nFinally it'd be ideal if GetCoins() had an assert checking that the database never had an empty CCoins structure in it, although you'd need to either do this three times: CCoinsViewCache::GetCoins(), CCoinsViewDB::GetCoins() and CCoinsViewMemPool::GetCoins() or make a wrapper function in CCoinsView()\r\n",
      "created_at" : "2013-10-28T04:31:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27188960",
      "id" : 27188960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T04:31:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27188960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "ACK... let's get this merged.\r\n\r\nThis fixes testnet for me.",
      "created_at" : "2013-10-28T13:41:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27211942",
      "id" : 27211942,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T13:47:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27211942",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "@petertodd An empty CCoins cannot even be serialized - there is no storage format that corresponds to. Enough as a guarantee that it doesn't occur in the database? :)",
      "created_at" : "2013-10-28T13:57:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27213186",
      "id" : 27213186,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T13:57:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27213186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Updated with peter's suggestions.",
      "created_at" : "2013-10-28T14:01:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27213484",
      "id" : 27213484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T14:01:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27213484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa That's a pretty good guarantee!\r\n\r\nACK",
      "created_at" : "2013-10-28T14:08:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27214065",
      "id" : 27214065,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T14:08:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27214065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Currently integrating this in a local build to also see if it helps :).",
      "created_at" : "2013-10-28T14:11:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27214294",
      "id" : 27214294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T14:11:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27214294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "retested and re-ACK w/ updated equality check\r\n",
      "created_at" : "2013-10-28T14:11:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27214315",
      "id" : 27214315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T14:11:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27214315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/170e02deaf2bb1f8f79ffafbb4ff7f62cb933c62 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2013-10-28T15:24:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27221314",
      "id" : 27221314,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T15:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27221314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "ACK",
      "created_at" : "2013-10-28T15:34:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3163#issuecomment-27222254",
      "id" : 27222254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3163",
      "updated_at" : "2013-10-28T15:34:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/27222254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
