[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#14384](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14384.html) (Resolve validationinterface circular dependencies by 251Labs)\n* [#13926](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13926.html) ([Tools] bitcoin-wallet - a tool for creating and managing wallets offline by jnewbery)\n* [#10973](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10973.html) (Refactor: separate wallet from node by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-12-13T02:03:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#issuecomment-446815213",
      "id" : 446815213,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14941",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NjgxNTIxMw==",
      "updated_at" : "2018-12-18T01:24:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446815213",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky @MarcoFalke",
      "created_at" : "2018-12-13T09:07:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#issuecomment-446893716",
      "id" : 446893716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14941",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0Njg5MzcxNg==",
      "updated_at" : "2018-12-13T09:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446893716",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - I think this can be useful outside of the tests, as well.\r\n\r\n> Also I'd like to discuss the wait default value, currently it avoid changing behavior. If wait=true is considered the correct behavior then this could be backport to 0.17.2?\r\n\r\nStrictly spoken this is a feature, not a bugfix, though if it's optional and improves testing I think a point can be made to backport it anyhow.",
      "created_at" : "2018-12-13T10:39:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#issuecomment-446922214",
      "id" : 446922214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14941",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NjkyMjIxNA==",
      "updated_at" : "2018-12-13T10:39:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446922214",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code change looks ok, but this shouldn't be an option. Making `wait=false` the default makes `unloadwallet` pointlessly difficult to use, and inconsistent with other methods, including closely related methods like `createwallet` and `loadwallet`.\r\n\r\nIf you think there is reason to support `wait=false`, I think you need to say what the use-case is, and why it wouldn't be better served by having the client make a fully asynchronous JSON-RPC request, instead of using this half-asynchronous/half-synchronous `wait` option that doesn't (I guess?) block on acquiring `cs_wallet`, but does block on the network connection and on acquiring `cs_wallets`, and on whatever the UI currently does in `NotifyUnload` (or will do in the future).\r\n\r\nAlso, if you want to keep the `async=false` option, it would be good to have a test to ensure that it doesn't acquire `cs_wallet` and `cs_main`. This would be easy to write as a c++ unit test which acquires the locks in one thread and calls `unloadwallet` in another.",
      "created_at" : "2018-12-13T14:11:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#issuecomment-446981743",
      "id" : 446981743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14941",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0Njk4MTc0Mw==",
      "updated_at" : "2018-12-13T14:11:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446981743",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Changed to synchronous unload. Locally added some sleeps to see if there were any connection timeout, but didn't manage to cause one.\r\n\r\n> doesn't (I guess?) block on acquiring `cs_wallet`\r\n\r\nno it doesn't, it waits until the weak pointer is expired.",
      "created_at" : "2018-12-13T16:09:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#issuecomment-447024884",
      "id" : 447024884,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14941",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NzAyNDg4NA==",
      "updated_at" : "2018-12-13T17:50:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/447024884",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241502828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241502828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be good to use Mutex and WAIT_LOCK from `sync.h` instead of `mutex` and `unique_lock` for thread annotations & debugging.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-13T17:59:08Z",
      "diff_hunk" : "@@ -81,13 +81,34 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    while (!weak_wallet.expired()) {\n+        g_wallet_release_cond.wait(lk);\n+    }\n+}\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lk(g_wallet_release_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241502828",
      "id" : 241502828,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTUwMjgyOA==",
      "original_commit_id" : "36d41ff90848a6135be6a27fdb17412f8382b0db",
      "original_position" : 27,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184792734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241502828",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241503869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241503869"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems more common in bitcoin code to abbreviate condition variables as `cv` instead of `cond` and name locks `lock` instead of `lk`.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-13T18:02:27Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241503869",
      "id" : 241503869,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTUwMzg2OQ==",
      "original_commit_id" : "c85d15d9d367159dbcf4ef3e2d73c0f196ca12f4",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184792734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241503869",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241506339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241506339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think we need to confirm that `!weak_wallet.expired()` in the other thread is true at the point of this call (and guaranteed by the c++ standard to be true). Otherwise there could be a lost-wakeup bug here because this would be signalling the condition variable before the condition is true.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-13T18:10:39Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+    while (!weak_wallet.expired()) {\n+        g_wallet_release_cond.wait(lk);\n+    }\n+}\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+\n+        wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n+        wallet->BlockUntilSyncedToCurrentChain();\n+        wallet->Flush();\n+        delete wallet;\n+    }\n+\n+    g_wallet_release_cond.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241506339",
      "id" : 241506339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTUwNjMzOQ==",
      "original_commit_id" : "ffa87990d16a4aad66d590313aa363ac4d6519c4",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184792734,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241506339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241515588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241515588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, I'll investigate.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-13T18:38:43Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+    while (!weak_wallet.expired()) {\n+        g_wallet_release_cond.wait(lk);\n+    }\n+}\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+\n+        wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n+        wallet->BlockUntilSyncedToCurrentChain();\n+        wallet->Flush();\n+        delete wallet;\n+    }\n+\n+    g_wallet_release_cond.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241515588",
      "id" : 241515588,
      "in_reply_to_id" : 241506339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTUxNTU4OA==",
      "original_commit_id" : "ffa87990d16a4aad66d590313aa363ac4d6519c4",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184808943,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241515588",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241533541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241533541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like this might not be sufficient if we want to guarantee that the wallet is really destroyed. From https://en.cppreference.com/w/cpp/memory/weak_ptr/expired:\r\n\r\n> The destructor for the managed object may not yet have been called, but this object's destruction is imminent (or may have already happened).\r\n\r\nA more reliable but cumbersome approach might be to add wallet members:\r\n\r\n```c++\r\nstd::promise<void> m_unload_promise;\r\nstd:shared_future<void> m_unload_future = m_unload_promise.get_future();\r\n```\r\n\r\nand call `m_unloaded_promise.set_value()` in the destructor, and then `future.wait()` here.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-13T19:33:03Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+    while (!weak_wallet.expired()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241533541",
      "id" : 241533541,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTUzMzU0MQ==",
      "original_commit_id" : "ffa87990d16a4aad66d590313aa363ac4d6519c4",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184832035,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:21:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241533541",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241627996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241627996"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will change.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-14T02:28:32Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241627996",
      "id" : 241627996,
      "in_reply_to_id" : 241503869,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTYyNzk5Ng==",
      "original_commit_id" : "c85d15d9d367159dbcf4ef3e2d73c0f196ca12f4",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184949451,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241627996",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241628011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241628011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will change.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-14T02:28:41Z",
      "diff_hunk" : "@@ -81,13 +81,34 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    while (!weak_wallet.expired()) {\n+        g_wallet_release_cond.wait(lk);\n+    }\n+}\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lk(g_wallet_release_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241628011",
      "id" : 241628011,
      "in_reply_to_id" : 241502828,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTYyODAxMQ==",
      "original_commit_id" : "36d41ff90848a6135be6a27fdb17412f8382b0db",
      "original_position" : 27,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184949475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:28:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241628011",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241628087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241628087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please see current approach.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-14T02:29:09Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+    while (!weak_wallet.expired()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241628087",
      "id" : 241628087,
      "in_reply_to_id" : 241533541,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTYyODA4Nw==",
      "original_commit_id" : "ffa87990d16a4aad66d590313aa363ac4d6519c4",
      "original_position" : 13,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 184949566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:29:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241628087",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241629703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241629703"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure about this, I think it should be called before `UnregisterValidationInterface` otherwise `SyncWithValidationInterfaceQueue` does nothing than waiting..",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-14T02:40:03Z",
      "diff_hunk" : "@@ -81,13 +81,46 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cv;\n+static std::set<CWallet*> g_unloading_wallet_set;\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lock(g_wallet_release_mutex);\n+        // Assert that there was an explict UnloadWallet call.\n+        assert(g_unloading_wallet_set.erase(wallet) == 1);\n+    }\n+    g_wallet_release_cv.notify_all();\n+}\n+\n+void UnloadWallet(std::shared_ptr<CWallet> wallet)\n+{\n+    CWallet* pwallet = wallet.get();\n+    {\n+        std::unique_lock<std::mutex> lock(g_wallet_release_mutex);\n+        assert(g_unloading_wallet_set.insert(pwallet).second);\n+    }\n+    UnregisterValidationInterface(pwallet);\n+    // The wallet can be in use so it's not possible to explicitly unload here.\n+    // Notify the unload intent so that all remaining shared pointers are\n+    // released.\n+    pwallet->NotifyUnload();\n+    // Time to ditch our shared_ptr and then wait for ReleaseWallet call.\n+    wallet.reset();\n+    {\n+        std::unique_lock<std::mutex> lock(g_wallet_release_mutex);\n+        while (g_unloading_wallet_set.count(pwallet)) {\n+            g_wallet_release_cv.wait(lock);\n+        }\n+    }\n+    // Now it's safe to close and delete the wallet.\n+    pwallet->WalletLogPrintf(\"Releasing wallet\\n\");\n+    pwallet->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241629703",
      "id" : 241629703,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTYyOTcwMw==",
      "original_commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "original_position" : 45,
      "path" : "src/wallet/wallet.cpp",
      "position" : 45,
      "pull_request_review_id" : 184951386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T02:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241629703",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241744392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241744392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This no longer applies, @ryanofsky concern was valid.",
      "commit_id" : "353659d0dd967b2619f0c28cea4b805dbff07ee4",
      "created_at" : "2018-12-14T12:50:06Z",
      "diff_hunk" : "@@ -81,13 +81,33 @@ std::shared_ptr<CWallet> GetWallet(const std::string& name)\n     return nullptr;\n }\n \n+static std::mutex g_wallet_release_mutex;\n+static std::condition_variable g_wallet_release_cond;\n+\n+void WaitForWalletRelease(std::shared_ptr<CWallet>& wallet)\n+{\n+    std::weak_ptr<CWallet> weak_wallet(wallet);\n+    wallet.reset();\n+\n+    std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+    while (!weak_wallet.expired()) {\n+        g_wallet_release_cond.wait(lk);\n+    }\n+}\n+\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();\n-    wallet->Flush();\n-    delete wallet;\n+    {\n+        std::unique_lock<std::mutex> lk(g_wallet_release_mutex);\n+\n+        wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n+        wallet->BlockUntilSyncedToCurrentChain();\n+        wallet->Flush();\n+        delete wallet;\n+    }\n+\n+    g_wallet_release_cond.notify_all();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14941#discussion_r241744392",
      "id" : 241744392,
      "in_reply_to_id" : 241506339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI0MTc0NDM5Mg==",
      "original_commit_id" : "ffa87990d16a4aad66d590313aa363ac4d6519c4",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 185094877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14941",
      "updated_at" : "2018-12-14T12:50:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/241744392",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
