[
   {
      "author_association" : "MEMBER",
      "body" : "Not sure if this is the right fix, IIRC the wallet is removed from the list first and then the actual unload happens. ",
      "created_at" : "2018-12-11T08:53:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14919#issuecomment-446121240",
      "id" : 446121240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14919",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NjEyMTI0MA==",
      "updated_at" : "2018-12-11T08:53:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446121240",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The relevant code is\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/5f23460c7e316fe7c944680f3feff07ebb867f70/src/wallet/wallet.cpp#L3879-L3883\r\n\r\nThe wallet itself has locks to prevent it from being loaded while already loaded, so it seems like an OK fix to me.",
      "created_at" : "2018-12-11T11:21:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14919#issuecomment-446168121",
      "id" : 446168121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14919",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NjE2ODEyMQ==",
      "updated_at" : "2018-12-11T11:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446168121",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@kallewoof that's what happening, it hits that error.\r\n\r\nIt's always the case that after `unloadwallet X` `listwallets` doesn't return `X` but that wallet can be unloading. This change only reduces the race to the actual duplicate condition.\r\n\r\nI see 4 solutions:\r\n 1.  add an option to `unloadwallet` to force waiting Ã°ÂÂÂ Ã°ÂÂÂ \r\n 2. use this change **but**  also change `listwallets` to actually verify if the wallet is not unloaded Ã°ÂÂÂ \r\n 3. make `loadwallet` aware the wallet is unloading and wait for it Ã°ÂÂÂ \r\n 4. change the test to repeat the `loadwallet` until it succeeds Ã°ÂÂÂ Ã°ÂÂÂ  Ã°ÂÂÂ Ã°ÂÂÂ \r\n\r\nNote that there are 2 wallet \"registries\":\r\nhttps://github.com/bitcoin/bitcoin/blob/5f23460c7e316fe7c944680f3feff07ebb867f70/src/wallet/wallet.cpp#L69-L73\r\nhttps://github.com/bitcoin/bitcoin/blob/5f23460c7e316fe7c944680f3feff07ebb867f70/src/wallet/db.cpp#L75-L84",
      "created_at" : "2018-12-11T12:04:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14919#issuecomment-446179238",
      "id" : 446179238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14919",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0NjE3OTIzOA==",
      "updated_at" : "2018-12-11T12:29:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/446179238",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
