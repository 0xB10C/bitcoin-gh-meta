[
   {
      "body" : "> We may need to check whether we don't depend on iterators CCoinsViewCache iterators remaining stable under modifications.\r\n\r\nIt doesn't seem that we depend on that. The only place where we pass around the iterators is in FetchCoins/GetCoins/HaveCoins, but there we at most return a reference to a CCoins, not the iterator itself (and the doc http://www.boost.org/doc/libs/1_55_0/doc/html/boost/unordered_map.html mentions that pointers and references to elements are never invalidated).\r\n\r\nOutside of CCoinsViewCache (like in txdb) we only ever use constant CCoinsViewMaps.\r\n",
      "created_at" : "2014-06-25T12:28:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47094101",
      "id" : 47094101,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-25T12:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47094101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Thanks for verifying. Sounds good.",
      "created_at" : "2014-06-25T12:51:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47096233",
      "id" : 47096233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-25T12:51:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47096233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4413_b1828db8465831e7d7fa842b39f14add03d7a7bd/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-06-25T21:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47160146",
      "id" : 47160146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-25T21:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47160146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "I checked re-indexing performance but it is not affected by this, at least not distinguishable within the variance. It consistently takes 4-4.5 hours.\r\nNow checking memory usage...\r\n\r\n",
      "created_at" : "2014-06-26T09:53:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47207436",
      "id" : 47207436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-26T11:48:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47207436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I've compared heap usage over time of a `-reindex` with and without the patch (using the heap profiler in gperftools):\r\n\r\n![chart_ordered_unordered](https://cloud.githubusercontent.com/assets/126646/3408539/9d62d2ba-fdcb-11e3-8d3a-30c24eb055c8.png)\r\n\r\nNot much difference in the overall trend or behavior; but a point of interest is that the memory usage with unordered map has fewer (and lower magnitude) sudden peaks.",
      "created_at" : "2014-06-27T07:24:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47314975",
      "id" : 47314975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-27T07:25:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47314975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I verified that the peak on x=33 for the ordered map is for a major part caused by memory allocation in CCoinsViewCache::BatchWrite / CCoinsViewCache::GetCoins.\r\n\r\n![snapshot_ordered_31](https://cloud.githubusercontent.com/assets/126646/3409614/1d9b7180-fddb-11e3-8188-06c4abdd42ab.png)\r\n\r\n\r\nAs we avoid these kinds of peaks with unordered_map - implying that there is less overhead - in my opinion it's worth to merge this.",
      "created_at" : "2014-06-27T09:12:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47323202",
      "id" : 47323202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-27T09:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47323202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Untested ACK.",
      "created_at" : "2014-06-27T16:51:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47373335",
      "id" : 47373335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-27T16:51:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47373335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Tested ACK.",
      "created_at" : "2014-06-29T15:44:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47458311",
      "id" : 47458311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-29T15:44:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47458311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "There's a mild exploitable performance weakness here: transaction signing\ncan be grinded to make the constructed utxo entries end up in the same\nbucket, causing O(n) behaviour in that set.\n\nI think it's low risk, but it can be easily avoided by using a more complex\nfunction uint256 -> 64bit hash that takes a secret parameter into account\n(which can be generated at random at startup).",
      "created_at" : "2014-06-29T17:21:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47461482",
      "id" : 47461482,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-29T17:21:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47461482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Ouch.\r\nMaybe use a murmurhash with a random seed parameter set at start? We already have that in the source for bloom...\r\n",
      "created_at" : "2014-06-30T05:37:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47496284",
      "id" : 47496284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-30T05:37:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47496284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Having a random uint256 in CCoinsViewCache, generated at creation, and xor'ed with the txid before computing the hash (via some simple function) should do.",
      "created_at" : "2014-06-30T12:53:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47527575",
      "id" : 47527575,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-30T12:53:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47527575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "So even murmurhash is not simple enough?",
      "created_at" : "2014-06-30T13:34:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47531671",
      "id" : 47531671,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-06-30T13:34:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47531671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I don't think the small win achieved here measures up against the extra brittleness involved in making the hashing non-deterministic between runs. In my experience this introduces problems (or at least extra work) while debugging and testing. std::map has a better worst-case performance, so it is a better fit.\r\n\r\nI'm going to pull the first commit to make it easier to experiment with alternative data structures here, but not the second.",
      "created_at" : "2014-07-01T10:11:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47639102",
      "id" : 47639102,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-07-01T10:17:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47639102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "First commit merged through dd638dd.",
      "created_at" : "2014-07-01T10:49:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/4413#issuecomment-47642081",
      "id" : 47642081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/4413",
      "updated_at" : "2014-07-01T10:49:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/47642081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
