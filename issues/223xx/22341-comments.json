[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22341#discussion_r658844504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22341"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658844504"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This fails in the current incarnation, because a freshly imported descriptor will not have access to the wallet seed. See todo in `rpcdump.cpp`",
      "commit_id" : "1ff7a25d5af28481537f146632f57a3f20f53420",
      "created_at" : "2021-06-25T15:17:29Z",
      "diff_hunk" : "@@ -0,0 +1,64 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getxpub RPC command.\"\"\"\n+\n+from test_framework.authproxy import JSONRPCException\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_raises_rpc_error,\n+)\n+from test_framework.descriptors import descsum_create\n+\n+class WalletGetxpubTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+        self.skip_if_no_sqlite()\n+\n+    def run_test(self):\n+        self.nodes[0].createwallet(wallet_name=\"w1\")\n+        w1 = self.nodes[0].get_wallet_rpc(\"w1\")\n+\n+        self.nodes[1].createwallet(wallet_name=\"w2\", descriptors=True)\n+        w2 = self.nodes[1].get_wallet_rpc(\"w2\")\n+\n+        self.log.info(\"Get xpub\")\n+        res = w2.getxpub(\"m/87'/0'/0'\")\n+        assert(res['xpub'])\n+        # assert_equal(xpub, w2.getxpub(\"m/87h/0h/0h\")['xpub'])\n+\n+        self.log.info(\"Import descriptor using the xpub and fingerprint\")\n+        desc_receive = \"tr([\" + res['masterfingerprint'] + \"/87h/0h/0h]\" + res['xpub'] + \"/0/*)\"\n+        desc_change = \"tr([\" + res['masterfingerprint'] + \"/87h/0h/0h]\" + res['xpub'] + \"/1/*)\"\n+        res = w2.importdescriptors([{\"desc\":descsum_create(desc_receive),\n+                                     \"timestamp\": \"now\",\n+                                     \"active\": True,\n+                                     \"internal\": False,\n+                                     \"range\": [0, 10]},\n+                                    {\"desc\":descsum_create(desc_change),\n+                                     \"timestamp\": \"now\",\n+                                     \"active\": True,\n+                                     \"internal\": True,\n+                                     \"range\": [0, 10]}\n+                                    ])\n+        assert(res[0]['success'] and res[1]['success'])\n+\n+        self.log.info(\"Fund xpub\")\n+        # TODO: if createwallet supports setting a seed without descriptors,\n+        #       use that here instead. This allows replacing deriveaddresses\n+        #       with getnewaddress.\n+        w2_address = self.nodes[1].deriveaddresses(descsum_create(desc_receive), 0)[0]\n+        w1.sendtoaddress(w2_address, 1)\n+        self.nodes[0].generate(1)\n+\n+        self.log.info(\"Spend from xpub\")\n+        w1_address = self.nodes[0].getnewaddress()\n+        w2.sendtoaddress(w1_address, 0.1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22341#discussion_r658844504",
      "id" : 658844504,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODg0NDUwNA==",
      "original_commit_id" : "75d09830cac750698f997f88a7c5cb728db0410c",
      "original_line" : 61,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "test/functional/wallet_getxpub.py",
      "position" : 61,
      "pull_request_review_id" : 692929780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22341",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-25T19:34:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/658844504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20205 by achow101\n* #19602 by achow101\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-06-25T23:39:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22341#issuecomment-868885052",
      "id" : 868885052,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22341",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2ODg4NTA1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-25T23:39:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/868885052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for working on this!",
      "created_at" : "2021-06-26T17:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22341#issuecomment-869032391",
      "id" : 869032391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22341",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTAzMjM5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-26T17:19:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869032391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22341#discussion_r659936603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22341"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659936603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In addition to being an ugly hack, this is also incorrect and does not actually produce the correct master key.",
      "commit_id" : "1ff7a25d5af28481537f146632f57a3f20f53420",
      "created_at" : "2021-06-28T16:26:24Z",
      "diff_hunk" : "@@ -3258,3 +3258,34 @@ ScriptPubKeyMan* CWallet::AddWalletDescriptor(WalletDescriptor& desc, const Flat\n \n     return ret;\n }\n+\n+bool CWallet::GetExtendedKey(const std::string path, CExtKey &ext_key, KeyOriginInfo &info) {\n+    if (IsCrypted()) {\n+        if (IsLocked()) {\n+            return false;\n+        }\n+        // TODO: decrypt master key if unlocked\n+        return false;\n+    }\n+\n+    // TODO: avoid needing a pre-existing ScriptPubKeyMan for obtaining the HD seed\n+    auto spk_man = GetScriptPubKeyMan(OutputType::BECH32, true);\n+    if (!spk_man) return false;\n+    auto desc_spk_man = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man);\n+    CKey seed = desc_spk_man->GetKeys().begin()->second;\n+    CExtKey master_key;\n+    master_key.SetSeed(seed.begin(), seed.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22341#discussion_r659936603",
      "id" : 659936603,
      "line" : 3277,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTkzNjYwMw==",
      "original_commit_id" : "1ff7a25d5af28481537f146632f57a3f20f53420",
      "original_line" : 3277,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 20,
      "pull_request_review_id" : 694157155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22341",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-28T16:26:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659936603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
