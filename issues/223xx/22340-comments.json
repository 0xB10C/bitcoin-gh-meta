[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Over the last 24h i ran a blocks-only node that saw 106 blocks and downloaded 3.8MB in `cmpctblock` messages. Thats an average of 12KB bytes per `cmpctblock` message received from three high-bandwidth peers. Only 26KB would have been downloaded if `headers` messages would have been used instead.\r\nAssuming an average block size of 1.38MB the `cmpctblock` messages represented **2.5%** of downloaded block data.",
      "created_at" : "2021-06-26T15:12:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-869016710",
      "id" : 869016710,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTAxNjcxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-26T15:12:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869016710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery @amitiuttarwar @sipa @ajtowns Any thoughts?",
      "created_at" : "2021-07-01T02:46:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-871869724",
      "id" : 871869724,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MTg2OTcyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T02:46:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/871869724",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems workable? Compact blocks should be seeing:\r\n\r\n * 12kB for short tx ids per cmpctblock message announcing a new block (for each high bw peer per block)\r\n * 2kB per getblocktxn message asking for the tx data (per block)\r\n * ~0 overhead for blocktxn message providing the block txns\r\n\r\nWhich should be ~38kB per block or about 5MB per day/144 blocks. Legacy block relay should just be:\r\n\r\n * ~0 overhead for headers message\r\n * ~0 overhead for GETDATA MSG_BLOCK request\r\n * ~0 ovehead for BLOCK message\r\n\r\nSo this makes sense to me.",
      "created_at" : "2021-07-02T05:20:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-872723147",
      "id" : 872723147,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjcyMzE0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T05:20:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872723147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662872834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662872834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you can just exit this function immediately if `!m_ignore_incoming_txs`:\r\n\r\n```diff\r\n void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\r\n {\r\n     AssertLockHeld(cs_main);\r\n+\r\n+    // Never request high-bandwidth mode from peers if we're blocks-only. Our\r\n+    // mempool will not contain the transactions necessary to reconstruct the\r\n+    // compact block.\r\n+    if (m_ignore_incoming_txs) return;\r\n+\r\n     CNodeState* nodestate = State(nodeid);\r\n     if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\r\n         // Never ask from peers who can't provide witnesses.\r\n@@ -859,12 +865,10 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\r\n                 lNodesAnnouncingHeaderAndIDs.pop_front();\r\n             }\r\n \r\n-            if (!m_ignore_incoming_txs) {\r\n-                m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\r\n-                // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n-                pfrom->m_bip152_highbandwidth_to = true;\r\n-                lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\r\n-            }\r\n+            m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\r\n+            // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n+            pfrom->m_bip152_highbandwidth_to = true;\r\n+            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\r\n             return true;\r\n         });\r\n     }\r\n```",
      "commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "created_at" : "2021-07-02T09:23:50Z",
      "diff_hunk" : "@@ -857,10 +858,13 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n                 });\n                 lNodesAnnouncingHeaderAndIDs.pop_front();\n             }\n-            m_connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n-            // save BIP152 bandwidth state: we select peer to be high-bandwidth\n-            pfrom->m_bip152_highbandwidth_to = true;\n-            lNodesAnnouncingHeaderAndIDs.push_back(pfrom->GetId());\n+\n+            if (!m_ignore_incoming_txs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662872834",
      "id" : 662872834,
      "line" : 862,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg3MjgzNA==",
      "original_commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "original_line" : 862,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 697997837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T09:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662872834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662873537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662873537"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can I convince you to make this conditional a bit more readable:\r\n\r\n```diff\r\n-                    if (!m_ignore_incoming_txs && nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\r\n+                    if (!m_ignore_incoming_txs\r\n+                        && nodestate->fSupportsDesiredCmpctVersion\r\n+                        && vGetData.size() == 1\r\n+                        && mapBlocksInFlight.size() == 1\r\n+                        && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\r\n```",
      "commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "created_at" : "2021-07-02T09:25:05Z",
      "diff_hunk" : "@@ -2100,7 +2104,7 @@ void PeerManagerImpl::ProcessHeadersMessage(CNode& pfrom, const Peer& peer,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n+                    if (!m_ignore_incoming_txs && nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#discussion_r662873537",
      "id" : 662873537,
      "line" : 2107,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg3MzUzNw==",
      "original_commit_id" : "e5993385d554655e4faf094826546b4f0d71dc8b",
      "original_line" : 2107,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 31,
      "pull_request_review_id" : 697997837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22340",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T09:27:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662873537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 6dfee13f650521f7542df0926aff01af9ac6a328",
      "created_at" : "2021-07-02T12:58:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22340#issuecomment-872977968",
      "id" : 872977968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22340",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3Mjk3Nzk2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T12:58:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872977968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
