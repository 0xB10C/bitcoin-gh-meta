[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is an alternative to #21603.\r\n\r\nAn advantage I see with this approach is that it addresses the [concern](https://github.com/bitcoin/bitcoin/pull/21603#issuecomment-813901411) with log messages being dropped. With this approach, log messages are never dropped; they just don't go back an infinite amount of time :).\r\n\r\nAnother advantage that could prove very useful is that debug log categories can be enabled for an indefinite amount of time (#21603 sensibly does not limit debug logging). It's quite possible that a bug occurs rarely and at an unpredictable time. By the time the bug occurs, it's too late to enable the relevant debug log category. Also, it might be nice to not have to worry so much about adding more logging in general (without even having to condition it on a category). There may be useful stuff to log that we don't currently, because of this disk space concern.\r\n\r\nSome background information: Currently, `debug.log` grows unbounded until `bitcoind` restarts. During startup, if `debug.log` is greater than 11 MB, it's truncated to 10 MB (keeping only the most recent log messages). This PR will make this unnecessary.\r\n\r\nAn easy way to manually test this without having to add artificial logging is to start `bitcoind -debug` (enable all debug categories), and observe the `debug.log` file and the rotated files:\r\n```\r\n$ cd .bitcoin\r\n$ ls -l debug*\r\n-rw------- 1 larry larry   1000076 Jun 27 09:03 debug-2021-06-27T15:03:56Z.log\r\n-rw------- 1 larry larry   1000190 Jun 27 09:05 debug-2021-06-27T15:05:28Z.log\r\n-rw------- 1 larry larry   1000002 Jun 27 09:07 debug-2021-06-27T15:07:09Z.log\r\n-rw------- 1 larry larry   1000042 Jun 27 09:07 debug-2021-06-27T15:07:56Z.log\r\n-rw------- 1 larry larry   1000045 Jun 27 09:10 debug-2021-06-27T15:10:55Z.log\r\n-rw------- 1 larry larry     87513 Jun 27 09:11 debug.log\r\n```\r\nPlease comment or review: @jnewbery @practicalswift @dergoegge \r\n\r\nSeeking concept ack for now, after that still to do:\r\n- tests\r\n- release notes",
      "created_at" : "2021-06-27T15:19:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-869180173",
      "id" : 869180173,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTE4MDE3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-27T15:20:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869180173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659337909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659337909"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We're ignoring any error from `rename`, not sure that's right.",
      "commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "created_at" : "2021-06-27T15:26:58Z",
      "diff_hunk" : "@@ -273,17 +318,45 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n     if (m_print_to_file) {\n         assert(m_fileout != nullptr);\n \n-        // reopen the log file, if requested\n-        if (m_reopen_file) {\n-            m_reopen_file = false;\n+        auto reopen_file = [&]() {\n             FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n             if (new_fileout) {\n                 setbuf(new_fileout, nullptr); // unbuffered\n                 fclose(m_fileout);\n                 m_fileout = new_fileout;\n+                m_file_size = 0;\n             }\n+        };\n+\n+        // reopen the log file, if requested\n+        if (m_reopen_file) {\n+            m_reopen_file = false;\n+            reopen_file();\n         }\n         FileWriteStr(str_prefixed, m_fileout);\n+        m_file_size += str_prefixed.size();\n+\n+        // If debug.log is large, rotate it (rename and recreate).\n+        if (m_rotate_keep > 0 && m_file_size > m_file_limit * 1e6) {\n+            // Rename debug.log to a name like debug-2021-06-25T22:57:54.log\n+            int64_t seconds = GetTimeMicros()/1e6;\n+            // Don't rotate within the same second to avoid name conflict.\n+            if (m_last_rotate_time < seconds) {\n+                m_last_rotate_time = seconds;\n+                std::string now = FormatISO8601DateTime(seconds);\n+                fs::path rotate{m_file_path};\n+                rotate.remove_filename();\n+                rotate /= \"debug-\" +  now + \".log\";\n+                try {\n+                    fs::rename(m_file_path, rotate);\n+                } catch (const fs::filesystem_error&) {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659337909",
      "id" : 659337909,
      "line" : 352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTMzNzkwOQ==",
      "original_commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "original_line" : 352,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 104,
      "pull_request_review_id" : 693428595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-27T15:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659337909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659337930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659337930"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This static_cast isn't needed, I'll remove it on the next commit.",
      "commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "created_at" : "2021-06-27T15:27:07Z",
      "diff_hunk" : "@@ -40,6 +41,38 @@ static int FileWriteStr(const std::string &str, FILE *fp)\n     return fwrite(str.data(), 1, str.size(), fp);\n }\n \n+// Remove the oldest rotated files if there are too many.\n+void BCLog::Logger::RemoveRotate()\n+{\n+    while (static_cast<int>(m_rotated_files.size()) > m_rotate_keep) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659337930",
      "id" : 659337930,
      "line" : 47,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTMzNzkzMA==",
      "original_commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 15,
      "pull_request_review_id" : 693428595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-27T15:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659337930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659338435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659338435"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure this should be a lambda. The advantage is that it's pretty small and it's declared close to its two call sites, but this is a slightly unusual practice; probably better as just a normal method in `BCLog::Logger`. Unless there are objections, I'll make that change in the next commit.",
      "commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "created_at" : "2021-06-27T15:30:37Z",
      "diff_hunk" : "@@ -273,17 +318,45 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n     if (m_print_to_file) {\n         assert(m_fileout != nullptr);\n \n-        // reopen the log file, if requested\n-        if (m_reopen_file) {\n-            m_reopen_file = false;\n+        auto reopen_file = [&]() {\n             FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n             if (new_fileout) {\n                 setbuf(new_fileout, nullptr); // unbuffered\n                 fclose(m_fileout);\n                 m_fileout = new_fileout;\n+                m_file_size = 0;\n             }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659338435",
      "id" : 659338435,
      "line" : 328,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTMzODQzNQ==",
      "original_commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "original_line" : 328,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 80,
      "pull_request_review_id" : 693428595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-27T15:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659338435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659339194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659339194"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If `logrotate` is being used, sending a `SIGHUP` will continue to cause `debug.log` to be reopened (this PR doesn't change that behavior), but if the user wants to continue using that mechanism (`logrotate(8)`), they should disable this PR's log rotation (by setting `-debuglogrotatekeep=0` in the configuration). But if they forget (definitely need release notes on this), I _think_ it will be okay, because either this PR's log rotation will always happen (since it waits only until `debug.log` reaches 1 MB by default), or the `logrotate(8)` will happen (if the file size threshold is less than 1 MB). It would be confusing if both were happening! Maybe more thought is needed here.\r\n\r\nAn alternative might be to just remove this behavior (`SIGHUP` causing `debug.log` to be reopened), but then `logrotate(8)` will no longer work, and there may be existing users that are all set up to use `logrotate(8)`.",
      "commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "created_at" : "2021-06-27T15:36:20Z",
      "diff_hunk" : "@@ -273,17 +318,45 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n     if (m_print_to_file) {\n         assert(m_fileout != nullptr);\n \n-        // reopen the log file, if requested\n-        if (m_reopen_file) {\n-            m_reopen_file = false;\n+        auto reopen_file = [&]() {\n             FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n             if (new_fileout) {\n                 setbuf(new_fileout, nullptr); // unbuffered\n                 fclose(m_fileout);\n                 m_fileout = new_fileout;\n+                m_file_size = 0;\n             }\n+        };\n+\n+        // reopen the log file, if requested\n+        if (m_reopen_file) {\n+            m_reopen_file = false;\n+            reopen_file();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r659339194",
      "id" : 659339194,
      "line" : 334,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTMzOTE5NA==",
      "original_commit_id" : "91d796a21a8c0fbb57d13fb1ca48505bb8d52845",
      "original_line" : 334,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 86,
      "pull_request_review_id" : 693428595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-27T15:45:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659339194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21603 by dergoegge\n* #16673 by LarryRuane\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-06-27T16:40:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-869191643",
      "id" : 869191643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTE5MTY0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-27T16:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869191643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is an interesting approach and i like the concept of log rotation but this is a bigger behavior change than [#21603](https://github.com/bitcoin/bitcoin/pull/21603) and i am not sure if always dropping (old) logs should be the default behavior. \r\n \r\n > An advantage I see with this approach is that it addresses the [concern](https://github.com/bitcoin/bitcoin/pull/21603#issuecomment-813901411) with log messages being dropped. With this approach, log messages are never dropped; they just don't go back an infinite amount of time :).\r\n \r\nContinuously dropping logs seems like an aggressive change to me because why drop the logs when there is no attack? I haven't had problems with logfile sizes in normal node operation. (maybe thats just me) \r\n\r\n> Some background information: Currently, `debug.log` grows unbounded until `bitcoind` restarts. During startup, if `debug.log` is greater than 11 MB, it's truncated to 10 MB (keeping only the most recent log messages). This PR will make this unnecessary.\r\n\r\nI think that the current behavior is actually quite useful because in case of an issue (e.g.: a crash) we have the entire log of the nodes lifespan.\r\n\r\nThis also seems to opens a similar attack vector as the global rate limiting did, an attacker (that knows of two bugs one of which is a disk filling bug) can execute an attack and then use the disk filling bug to rotate the logs out that had info about the attack.\r\n",
      "created_at" : "2021-06-28T10:11:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-869557601",
      "id" : 869557601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2OTU1NzYwMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-28T10:11:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/869557601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660853801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660853801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should probably error if the user has configured rotation explicitly.",
      "commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "created_at" : "2021-06-29T18:11:25Z",
      "diff_hunk" : "@@ -53,6 +86,17 @@ bool BCLog::Logger::StartLogging()\n         if (!m_fileout) {\n             return false;\n         }\n+        // Special files (e.g. device nodes) may not have a size.\n+        try {\n+            m_file_size = fs::file_size(m_file_path);\n+        } catch (const fs::filesystem_error&) {\n+            // We can't do log rotation if it's not a regular file.\n+            m_rotate_keep = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660853801",
      "id" : 660853801,
      "line" : 94,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg1MzgwMQ==",
      "original_commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "original_line" : 94,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 56,
      "pull_request_review_id" : 695354386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T18:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660853801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660854364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660854364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What if I want to rotate, but never delete?",
      "commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "created_at" : "2021-06-29T18:12:15Z",
      "diff_hunk" : "@@ -276,14 +320,43 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n         // reopen the log file, if requested\n         if (m_reopen_file) {\n             m_reopen_file = false;\n-            FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n-            if (new_fileout) {\n-                setbuf(new_fileout, nullptr); // unbuffered\n-                fclose(m_fileout);\n-                m_fileout = new_fileout;\n-            }\n+            ReopenFile();\n         }\n         FileWriteStr(str_prefixed, m_fileout);\n+        m_file_size += str_prefixed.size();\n+\n+        // If debug.log is large, rotate it (rename and recreate).\n+        if (m_rotate_keep > 0 && m_file_size > m_file_limit * 1e6) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660854364",
      "id" : 660854364,
      "line" : 329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg1NDM2NA==",
      "original_commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "original_line" : 329,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 81,
      "pull_request_review_id" : 695354386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T18:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660854364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660854968"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660854968"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, error if the user has configured both",
      "commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "created_at" : "2021-06-29T18:13:13Z",
      "diff_hunk" : "@@ -294,6 +367,9 @@ void BCLog::Logger::ShrinkDebugFile()\n \n     assert(!m_file_path.empty());\n \n+    // File rotation makes this unnecessary.\n+    if (m_rotate_keep > 0) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660854968",
      "id" : 660854968,
      "line" : 371,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MDg1NDk2OA==",
      "original_commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "original_line" : 371,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 120,
      "pull_request_review_id" : 695354386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-29T18:14:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/660854968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r664184552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664184552"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> What if I want to rotate, but never delete?\r\n\r\n`-debuglogrotatekeep=9999999` or is that ugly? Should there be a separate `-debuglogenable` boolean (default true; if set to false, behave as today), and then `-debuglogrotatekeep=0` could mean \"never delete\". Would that be preferable? Or something else? Thanks for the comments!",
      "commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "created_at" : "2021-07-06T01:50:30Z",
      "diff_hunk" : "@@ -276,14 +320,43 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n         // reopen the log file, if requested\n         if (m_reopen_file) {\n             m_reopen_file = false;\n-            FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n-            if (new_fileout) {\n-                setbuf(new_fileout, nullptr); // unbuffered\n-                fclose(m_fileout);\n-                m_fileout = new_fileout;\n-            }\n+            ReopenFile();\n         }\n         FileWriteStr(str_prefixed, m_fileout);\n+        m_file_size += str_prefixed.size();\n+\n+        // If debug.log is large, rotate it (rename and recreate).\n+        if (m_rotate_keep > 0 && m_file_size > m_file_limit * 1e6) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#discussion_r664184552",
      "id" : 664184552,
      "in_reply_to_id" : 660854364,
      "line" : 329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDE4NDU1Mg==",
      "original_commit_id" : "b526922724eba3221db84d7ba6624b14c480a74e",
      "original_line" : 329,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/logging.cpp",
      "position" : 81,
      "pull_request_review_id" : 699476453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22350",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T01:50:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664184552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Continuously dropping logs seems like an aggressive change to me because why drop the logs when there is no attack? I haven't had problems with logfile sizes in normal node operation. (maybe thats just me)\r\n\r\nI come from a storage system background, and dropping the oldest logs was standard practice. (This is why there's a `logrotate` facility on Unix and similar systems.) A general principle is that any demon process that can run for an arbitrary amount of time should not use resources in proportion to how long it's been running. Yes, resource usage can increase quickly early, and after reaching \"steady-state\" can go up and down over time. But the system shouldn't, for example, gradually use more memory or gradually require more CPU (requiring a restart to fix). The current logging design violates this principle as regards disk usage. So even without an active attack, we should be pruning the log file.\r\n\r\n> I think that the current behavior is actually quite useful because in case of an issue (e.g.: a crash) we have the entire log of the nodes lifespan.\r\n\r\nThat's true, but for reasons I already stated, that's not practical. The most useful information is likely to be in the most recent logs. The user can always increase the amount of logging (in effect, to infinity if needed). Or disable this feature (work as today). Consider another option the user has: Run some kind of small agent (even just a small shell script) that watches for new rotated debug log files, and copies them off to some other place with tons of storage. Or compresses them. Or filters out interesting stuff from them and deletes them.\r\n\r\n> This also seems to opens a similar attack vector as the global rate limiting did, an attacker (that knows of two bugs one of which is a disk filling bug) can execute an attack and then use the disk filling bug to rotate the logs out that had info about the attack.\r\n\r\nWell, this is unlikely-squared. This isn't something I'm worried about, but maybe I'm wrong.\r\n\r\nThanks for your comments!",
      "created_at" : "2021-07-06T02:15:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-874410976",
      "id" : 874410976,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NDQxMDk3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T02:15:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/874410976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added commit d885f0b3fad93b10cf400c596d57063687d05efb to address @luke-jr's review comments (aside from \"[What if I want to rotate, but never delete](https://github.com/bitcoin/bitcoin/pull/22350#discussion_r660854364)\" because I'm not sure which is the best approach). There are no tests or release notes, because still looking for approach or concept ACK.",
      "created_at" : "2021-07-06T18:12:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-874977115",
      "id" : 874977115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NDk3NzExNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T18:12:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/874977115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed to fix CI failure (missing #include directive)",
      "created_at" : "2021-07-06T19:31:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-875026591",
      "id" : 875026591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTAyNjU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T19:31:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875026591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Force-pushed to fix CI failures, also added a functional test.",
      "created_at" : "2021-07-09T02:34:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22350#issuecomment-876868239",
      "id" : 876868239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22350",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3Njg2ODIzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-09T02:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876868239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   }
]
