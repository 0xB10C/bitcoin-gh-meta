[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like an empty line needs to be added to the commit message after the subject line for the linter to pass.",
      "created_at" : "2021-07-01T14:40:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#issuecomment-872304091",
      "id" : 872304091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22383",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjMwNDA5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T14:40:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872304091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would change the behavior of `GetTransaction` in some cases. I'm not sure whether this is OK or not, but I'd think we should at least update comments here: https://github.com/bitcoin/bitcoin/blob/master/src/validation.h#L146, and docs here: https://github.com/bitcoin/bitcoin/blob/master/src/rpc/rawtransaction.cpp#L78\r\n\r\nThe case I'm thinking about, which you noted, is when an incorrect `block_index` is provided to `GetTransaction`, but `g_txindex->FindTx(hash, hashBlock, tx)` finds and returns the tx. After this PR we would return the tx although it isn't in the block the user asked for. Idk the implications of this or if it matters, but if it does, you could probably check `hashBlock` against the user provided `block_index` and get the performance win you want without changing behavior (if necessary/practical)\r\n\r\nSimilarly, I'm not sure if checking the mempool first has any unintended consequences (other than deviating from current docs). That said, I'm not sure the `if (mempool) {` branch needs to move in this PR, can probably just leave it after the `if (block_index) {` branch as is. Again, not sure how we feel about returning a tx from the mempool when the user wanted to check a specific `block_index`",
      "created_at" : "2021-07-01T16:31:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#issuecomment-872388955",
      "id" : 872388955,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22383",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjM4ODk1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T16:31:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872388955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7217256?v=4",
         "events_url" : "https://api.github.com/users/mjdietzx/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mjdietzx/followers",
         "following_url" : "https://api.github.com/users/mjdietzx/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mjdietzx/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mjdietzx",
         "id" : 7217256,
         "login" : "mjdietzx",
         "node_id" : "MDQ6VXNlcjcyMTcyNTY=",
         "organizations_url" : "https://api.github.com/users/mjdietzx/orgs",
         "received_events_url" : "https://api.github.com/users/mjdietzx/received_events",
         "repos_url" : "https://api.github.com/users/mjdietzx/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mjdietzx/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mjdietzx"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think a fundamental question is whether or not the block_index is intended to be used as a hint or as a validation parameter.\r\n\r\nGiven that the current logic of this function has various fallbacks, it seems to me that block_index is a hint and that the goal of the function is to try to return the requested transaction regardless of where it is stored. So it seems to me that reorganizing the logic for performance gains is a suitable goal.",
      "created_at" : "2021-07-01T18:37:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#issuecomment-872465440",
      "id" : 872465440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22383",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjQ2NTQ0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T18:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872465440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/288011?v=4",
         "events_url" : "https://api.github.com/users/jlopp/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jlopp/followers",
         "following_url" : "https://api.github.com/users/jlopp/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jlopp/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jlopp",
         "id" : 288011,
         "login" : "jlopp",
         "node_id" : "MDQ6VXNlcjI4ODAxMQ==",
         "organizations_url" : "https://api.github.com/users/jlopp/orgs",
         "received_events_url" : "https://api.github.com/users/jlopp/received_events",
         "repos_url" : "https://api.github.com/users/jlopp/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jlopp/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jlopp/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jlopp"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "FindTx returns the block hash, so it's very easy to check if it matches. If you do so, the question of whether the provided block is a hint or a search restriction doesn't apply.",
      "created_at" : "2021-07-01T18:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#issuecomment-872470202",
      "id" : 872470202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22383",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjQ3MDIwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-01T18:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872470202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662813217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662813217"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`g_index`? How about `If -txindex is enabled, check it next for the tx`.",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T07:52:09Z",
      "diff_hunk" : "@@ -142,15 +142,16 @@ void StartScriptCheckWorkerThreads(int threads_num);\n /** Stop all of the script checking worker threads */\n void StopScriptCheckWorkerThreads();\n /**\n- * Return transaction from the block at block_index.\n- * If block_index is not provided, fall back to mempool.\n- * If mempool is not provided or the tx couldn't be found in mempool, fall back to g_txindex.\n+ * Return transaction with a given hash.\n+ * If mempool is provided, check it first for the tx.\n+ * If g_index is available, check it next for the tx.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662813217",
      "id" : 662813217,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjgxMzIxNw==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 147,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 697919335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T08:12:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662813217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662819949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662819949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Something like the following would keep behavior?\r\n```cpp\r\nuint256 block_hash;\r\nif (g_txindex->FindTx(hash, block_hash, tx)) {\r\n    if (block_index && block_index->GetBlockHash() != block_hash) return nullptr;\r\n    hashBlock = block_hash;\r\n    return tx;\r\n}\r\n```\r\nNote the local `block_hash` to avoid changing the out-arg in case it fails.",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T08:02:33Z",
      "diff_hunk" : "@@ -1159,6 +1159,14 @@ CTransactionRef GetTransaction(const CBlockIndex* const block_index, const CTxMe\n {\n     LOCK(cs_main);\n \n+    if (mempool) {\n+        CTransactionRef ptx = mempool->get(hash);\n+        if (ptx) return ptx;\n+    }\n+    if (g_txindex) {\n+        CTransactionRef tx;\n+        if (g_txindex->FindTx(hash, hashBlock, tx)) return tx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662819949",
      "id" : 662819949,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjgxOTk0OQ==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 1168,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 697919335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T08:12:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662819949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662821224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662821224"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same, `... via -txindex or ...`",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T08:04:48Z",
      "diff_hunk" : "@@ -142,15 +142,16 @@ void StartScriptCheckWorkerThreads(int threads_num);\n /** Stop all of the script checking worker threads */\n void StopScriptCheckWorkerThreads();\n /**\n- * Return transaction from the block at block_index.\n- * If block_index is not provided, fall back to mempool.\n- * If mempool is not provided or the tx couldn't be found in mempool, fall back to g_txindex.\n+ * Return transaction with a given hash.\n+ * If mempool is provided, check it first for the tx.\n+ * If g_index is available, check it next for the tx.\n+ * Finally, if block_index is provided, check for tx by reading entire block from disk.\n  *\n  * @param[in]  block_index     The block to read from disk, or nullptr\n  * @param[in]  mempool         If block_index is not provided, look in the mempool, if provided\n  * @param[in]  hash            The txid\n  * @param[in]  consensusParams The params\n- * @param[out] hashBlock       The hash of block_index, if the tx was found via block_index\n+ * @param[out] hashBlock       The block hash, if the tx was found via g_txindex or block_index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662821224",
      "id" : 662821224,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjgyMTIyNA==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 154,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 697919335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T08:12:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662821224",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991449"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991449"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure; will update.",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T12:54:35Z",
      "diff_hunk" : "@@ -142,15 +142,16 @@ void StartScriptCheckWorkerThreads(int threads_num);\n /** Stop all of the script checking worker threads */\n void StopScriptCheckWorkerThreads();\n /**\n- * Return transaction from the block at block_index.\n- * If block_index is not provided, fall back to mempool.\n- * If mempool is not provided or the tx couldn't be found in mempool, fall back to g_txindex.\n+ * Return transaction with a given hash.\n+ * If mempool is provided, check it first for the tx.\n+ * If g_index is available, check it next for the tx.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991449",
      "id" : 662991449,
      "in_reply_to_id" : 662813217,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5MTQ0OQ==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 147,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 698156964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:54:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991449",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/288011?v=4",
         "events_url" : "https://api.github.com/users/jlopp/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jlopp/followers",
         "following_url" : "https://api.github.com/users/jlopp/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jlopp/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jlopp",
         "id" : 288011,
         "login" : "jlopp",
         "node_id" : "MDQ6VXNlcjI4ODAxMQ==",
         "organizations_url" : "https://api.github.com/users/jlopp/orgs",
         "received_events_url" : "https://api.github.com/users/jlopp/received_events",
         "repos_url" : "https://api.github.com/users/jlopp/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jlopp/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jlopp/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jlopp"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Makes sense; I can add a similar check for the mempool condition.",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T12:55:00Z",
      "diff_hunk" : "@@ -1159,6 +1159,14 @@ CTransactionRef GetTransaction(const CBlockIndex* const block_index, const CTxMe\n {\n     LOCK(cs_main);\n \n+    if (mempool) {\n+        CTransactionRef ptx = mempool->get(hash);\n+        if (ptx) return ptx;\n+    }\n+    if (g_txindex) {\n+        CTransactionRef tx;\n+        if (g_txindex->FindTx(hash, hashBlock, tx)) return tx;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991716",
      "id" : 662991716,
      "in_reply_to_id" : 662819949,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5MTcxNg==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 1168,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 698157299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:55:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/288011?v=4",
         "events_url" : "https://api.github.com/users/jlopp/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jlopp/followers",
         "following_url" : "https://api.github.com/users/jlopp/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jlopp/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jlopp",
         "id" : 288011,
         "login" : "jlopp",
         "node_id" : "MDQ6VXNlcjI4ODAxMQ==",
         "organizations_url" : "https://api.github.com/users/jlopp/orgs",
         "received_events_url" : "https://api.github.com/users/jlopp/received_events",
         "repos_url" : "https://api.github.com/users/jlopp/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jlopp/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jlopp/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jlopp"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991827"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure; will update.",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T12:55:10Z",
      "diff_hunk" : "@@ -142,15 +142,16 @@ void StartScriptCheckWorkerThreads(int threads_num);\n /** Stop all of the script checking worker threads */\n void StopScriptCheckWorkerThreads();\n /**\n- * Return transaction from the block at block_index.\n- * If block_index is not provided, fall back to mempool.\n- * If mempool is not provided or the tx couldn't be found in mempool, fall back to g_txindex.\n+ * Return transaction with a given hash.\n+ * If mempool is provided, check it first for the tx.\n+ * If g_index is available, check it next for the tx.\n+ * Finally, if block_index is provided, check for tx by reading entire block from disk.\n  *\n  * @param[in]  block_index     The block to read from disk, or nullptr\n  * @param[in]  mempool         If block_index is not provided, look in the mempool, if provided\n  * @param[in]  hash            The txid\n  * @param[in]  consensusParams The params\n- * @param[out] hashBlock       The hash of block_index, if the tx was found via block_index\n+ * @param[out] hashBlock       The block hash, if the tx was found via g_txindex or block_index",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r662991827",
      "id" : 662991827,
      "in_reply_to_id" : 662821224,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5MTgyNw==",
      "original_commit_id" : "5ab22ef9445522748393ebceb0ca41a6b13a2bc3",
      "original_line" : 154,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 698157449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:55:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662991827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/288011?v=4",
         "events_url" : "https://api.github.com/users/jlopp/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jlopp/followers",
         "following_url" : "https://api.github.com/users/jlopp/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jlopp/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jlopp",
         "id" : 288011,
         "login" : "jlopp",
         "node_id" : "MDQ6VXNlcjI4ODAxMQ==",
         "organizations_url" : "https://api.github.com/users/jlopp/orgs",
         "received_events_url" : "https://api.github.com/users/jlopp/received_events",
         "repos_url" : "https://api.github.com/users/jlopp/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jlopp/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jlopp/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jlopp"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've added additional checks that should ensure there is no behavior change, only performance improvements. Now it should return nullptr faster in certain conditions.",
      "created_at" : "2021-07-02T12:58:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#issuecomment-872977773",
      "id" : 872977773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22383",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3Mjk3Nzc3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T12:58:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872977773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/288011?v=4",
         "events_url" : "https://api.github.com/users/jlopp/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jlopp/followers",
         "following_url" : "https://api.github.com/users/jlopp/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jlopp/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jlopp",
         "id" : 288011,
         "login" : "jlopp",
         "node_id" : "MDQ6VXNlcjI4ODAxMQ==",
         "organizations_url" : "https://api.github.com/users/jlopp/orgs",
         "received_events_url" : "https://api.github.com/users/jlopp/received_events",
         "repos_url" : "https://api.github.com/users/jlopp/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jlopp/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jlopp/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jlopp"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r663000869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663000869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It could be an orphaned block and tx went back to the pool? I think previously it would return the transaction.\r\n\r\nMight be better just do `if (mempool && !block_index) {` in L1162?",
      "commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "created_at" : "2021-07-02T13:09:29Z",
      "diff_hunk" : "@@ -1159,6 +1159,24 @@ CTransactionRef GetTransaction(const CBlockIndex* const block_index, const CTxMe\n {\n     LOCK(cs_main);\n \n+    if (mempool) {\n+        CTransactionRef ptx = mempool->get(hash);\n+        if (ptx) {\n+            // Transaction was found in mempool but we were searching for it in a block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22383#discussion_r663000869",
      "id" : 663000869,
      "line" : 1165,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzAwMDg2OQ==",
      "original_commit_id" : "6dd28e76884c72681767b5a43d8960b9904ac3e0",
      "original_line" : 1165,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 7,
      "pull_request_review_id" : 698169905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22383",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T13:12:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663000869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
