[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2021-07-02T01:41:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872651861",
      "id" : 872651861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY1MTg2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T08:38:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872651861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> There are measures to limit the influence attackers can have on the addrman database (bucket restrictions based on IPs), but still - **there is no need to permit them to feed us addresses at a rate that's orders of magnitude larger than what is common on the network today**, especially as it will cause us to spam our peers too.\r\n\r\nConcept ACK",
      "created_at" : "2021-07-02T03:08:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872679319",
      "id" : 872679319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY3OTMxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T03:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872679319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-07-02T08:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872802081",
      "id" : 872802081,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjgwMjA4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T08:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872802081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for default initialization value here if this is set in the initialization list in the only ctor.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T10:45:40Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032",
      "id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjkyMTAzMg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find this line quite difficult to parse. I think the intention is that we don't cap m_addr_token_bucket to MAX_ADDR_TO_SEND (in the case where it was incremented because we sent a getaddr). Is this easier to read:\r\n\r\n```diff\r\n         // Update/increment addr rate limiting bucket.\r\n         const auto current_time = GetTime<std::chrono::microseconds>();\r\n-        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n-        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\r\n+            // Don't increment bucket if it's already full\r\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\r\n+        }\r\n         peer->m_addr_token_timestamp = current_time;\r\n-        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));\r\n \r\n         for (CAddress& addr : vAddr)\r\n         {\r\n```",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:28:36Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964",
      "id" : 662943964,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0Mzk2NA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is necessary. The `add_[outbound_]p2p_connection()` methods already do a sync_with_ping.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:29:49Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636",
      "id" : 662944636,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NDYzNg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 70,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using the `assert_equal()`/`assert_greater_than()`/`assert_greater_than_or_equal()` helper functions (they give more helpful output if the test fails).",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:31:42Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737",
      "id" : 662945737,
      "line" : 244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NTczNw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 244,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 74,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not necessarily for this PR) should the other tests be updated to use random IP addresses? I guess you're doing this and not reusing setup_addr_msg() in case the addresses returned may result in addrman bucket collisions?",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:22Z",
      "diff_hunk" : "@@ -75,6 +79,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531",
      "id" : 662949531,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTUzMQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 82,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 28,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            assert (addr_count_3 <= addr_count_2)\r\n```\r\n\r\n(or better yet, use `assert_greater_than_or_equal()`)",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:58Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_1 <= tokens\n+            assert addr_count_1 <= addr_count_0 + 600\n+            assert (addr_count_1 > addr_count_0) == (tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_2 <= tokens\n+            assert addr_count_2 <= addr_count_1 + 600\n+            assert (addr_count_2 > addr_count_1) == (tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_3 <= tokens\n+            assert addr_count_3 <= addr_count_2 + 10\n+            assert (addr_count_3 > addr_count_2) == False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805",
      "id" : 662949805,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTgwNQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 266,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 96,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\r\n```\r\n\r\nDoes this compile? If yes, the constructor can be left untouched.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T13:06:55Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155",
      "id" : 662999155,
      "in_reply_to_id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5OTE1NQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698167580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T13:06:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's not equivalent however. The current code permits the token bucket to exceed MAX_ADDR_TO_SEND (through GETADDR request), without having the automatic increment cropping it again.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T15:47:08Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105234",
      "id" : 663105234,
      "in_reply_to_id" : 662943964,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEwNTIzNA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 698314011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T15:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried to reuse it, but things fail because the existing setup_addr_message are limited to 256 addresses, and when I tried to generalize it, some of the other tests started failing.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T15:48:16Z",
      "diff_hunk" : "@@ -75,6 +79,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663105927",
      "id" : 663105927,
      "in_reply_to_id" : 662949531,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEwNTkyNw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 82,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 28,
      "pull_request_review_id" : 698314916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T15:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663105927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, it works.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:51:47Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139663",
      "id" : 663139663,
      "in_reply_to_id" : 662921032,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTY2Mw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698359194,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, much better.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:51:57Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139730",
      "id" : 663139730,
      "in_reply_to_id" : 662943964,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTczMA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698359287,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:51:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Gone.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:52:05Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139801",
      "id" : 663139801,
      "in_reply_to_id" : 662944636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTgwMQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698359381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:52:11Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663139843",
      "id" : 663139843,
      "in_reply_to_id" : 662945737,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzEzOTg0Mw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 244,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698359449,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:52:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663139843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663141174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663141174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or even better: `assert_equal(addr_count_2, addr_count_3)`. Done.",
      "commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "created_at" : "2021-07-02T16:54:48Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_1 <= tokens\n+            assert addr_count_1 <= addr_count_0 + 600\n+            assert (addr_count_1 > addr_count_0) == (tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_2 <= tokens\n+            assert addr_count_2 <= addr_count_1 + 600\n+            assert (addr_count_2 > addr_count_1) == (tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_3 <= tokens\n+            assert addr_count_3 <= addr_count_2 + 10\n+            assert (addr_count_3 > addr_count_2) == False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663141174",
      "id" : 663141174,
      "in_reply_to_id" : 662949805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzE0MTE3NA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 266,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 698361128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T16:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663141174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Compiled the branch but don't want to run [test/functional/p2p_addr_relay.py](https://github.com/sipa/bitcoin/blob/202106_rate_limit_addr/test/functional/p2p_addr_relay.py). I want to test it manually on testnet.\r\n\r\n1. Can we do `send_and_ping` used in the test with some RPC?\r\n2. How can we try this on testnet? I am assuming: Compile branch, run two nodes on testnet, use `addnode`, spam other node with random addresses (not sure how to do this?) and compare the results for `getnodeaddresses` doing same on master branch.",
      "created_at" : "2021-07-02T17:04:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873138272",
      "id" : 873138272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzEzODI3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T17:04:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873138272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@prayank23 No, it's testing a P2P aspect, you can't do that through RPC. There is the `addpeeraddress` RPC for injecting new addresses, but it doesn't have (or need) the same rate limiting.",
      "created_at" : "2021-07-02T17:13:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873143328",
      "id" : 873143328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzE0MzMyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T17:13:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873143328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK to introducing a rate limiting mechanism for addr relay, some general questions about the approach:\r\n\r\nThe approach of a constant counter increase doesn't scale with the total number of self-announcing nodes in the network, while addr traffic to a node probably does (or at least should?). Did you consider the possibility of an adaptive rate limiting approach (e.g. let the token counter increase based on recently observed addr frequency from outbound peers or something like that) that could adapt to changes in network size or in the general efficiency of gossip relay over time - or would that be too complicated/have some other downsides?\r\n\r\nChoosing the rate limit ofÂ Â 0.1 addr/sÂ based on current observations of 0.005-0.025 addr/s also kind of says that we are happy with the current efficiency of addr gossip - are we though? (#21528 would likely increase it, though I'm not sure by how much)\r\n\r\nIt would be great to have some historical references about observed addr/s rate (to see whether it has changed significantly over the years with increasing SPV nodes, introduction of block-relay-only connections etc.), but I would assume this kind of data doesn't exist anywhere...\r\n",
      "created_at" : "2021-07-02T19:11:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873208395",
      "id" : 873208395,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzIwODM5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T19:21:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873208395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande Those are reasonable points. My thinking is mostly that some limit here is necessary, and if this appears to be too restrictive as the network or other aspects of addr relay change, they can be revisited - those are unlikely to cause dramatic changes in short periods of time. I think an adaptive limit is too easily exploited.",
      "created_at" : "2021-07-02T19:26:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873214929",
      "id" : 873214929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzIxNDkyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T19:26:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873214929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So sorry for that accidental close / open ð³",
      "created_at" : "2021-07-03T19:00:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873454941",
      "id" : 873454941,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzQ1NDk0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T19:00:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873454941",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> So sorry for that accidental close / open ð³\n\nWhy do you have these privileges?",
      "created_at" : "2021-07-03T19:05:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-873455720",
      "id" : 873455720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MzQ1NTcyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-03T19:05:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/873455720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663559469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663559469"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why the condition `pfrom.addr != addr` in addition to starting with `m_addr_token_bucket{1.0}`? Shouldn't self-announcements from our peer consume a token too?",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:35:07Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (pfrom.addr != addr && !pfrom.HasPermission(NetPermissionFlags::Addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663559469",
      "id" : 663559469,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU1OTQ2OQ==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2808,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663559469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560244"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this could fail intermittently in the \"inbound\" case, where we have just 1 token. The first addr of the shuffled message consumes the token, but if `IsRoutable()` happens to be false for this random address, it won't be accepted to addrman (`CAddrMan::Add_()`), and other addrs of the message won't be either because there are no tokens left. ",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:42:35Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560244",
      "id" : 663560244,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU2MDI0NA==",
      "original_commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "original_line" : 251,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 82,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What is the reason for adding the `Shuffle` here, considering that the token counter grows deterministically and our peer could calculate anyway how many addrs of the packet we would process/discard if they cared to keep track of that?",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-04T21:50:31Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r663560937",
      "id" : 663560937,
      "line" : 2801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MzU2MDkzNw==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2801,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 698709971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-04T22:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/663560937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664232247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664232247"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a leftover from an earlier iteration where I didn't have the `m_addr_token_bucket{1.0}` initialization. I've removed it.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T04:47:18Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (pfrom.addr != addr && !pfrom.HasPermission(NetPermissionFlags::Addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664232247",
      "id" : 664232247,
      "in_reply_to_id" : 663559469,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzMjI0Nw==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2808,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 699531352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T04:47:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664232247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664237309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664237309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the test to generate only routable IPs.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T05:03:46Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664237309",
      "id" : 664237309,
      "in_reply_to_id" : 663560244,
      "line" : 251,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzNzMwOQ==",
      "original_commit_id" : "bb42151fee7714360f38882a77cbf2bba08cd514",
      "original_line" : 251,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 82,
      "pull_request_review_id" : 699537302,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T05:03:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664237309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664238361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664238361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The idea is that if we're going to be dropping some part of incoming messages because of rate-limiting, we should do it uniformly. This isn't to stop any kind of attack, but to give slightly fairer treatment to existing nodes on the network, which don't randomize on sending (there is random replacement once the outgoing buffer hits 1000, but that is rarely if ever hit under normal network conditions).",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T05:07:27Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664238361",
      "id" : 664238361,
      "in_reply_to_id" : 663560937,
      "line" : 2801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDIzODM2MQ==",
      "original_commit_id" : "2decfa58c19d9d6b5604b0931fa34cd94ccc32c8",
      "original_line" : 2801,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 699538711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T05:07:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664238361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664460746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664460746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not being intimately familiar with the `std::chrono` library, I found this line a little difficult to parse. The `std::chrono::duration<double>` is an instantiation of `duration` with the representation set to `double` and the period set to the default ratio of `1` (i.e. one second). This line therefore initializes a `duration` object that represents seconds as doubles from the `time_diff` variable (and then multiplies by the `MAX_ADDR_RATE_PER_SECOND`).",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T11:12:12Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664460746",
      "id" : 664460746,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDQ2MDc0Ng==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2796,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 699826384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:17:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664460746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664467172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664467172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It was surprising that this test needed to be updated. My understanding was that it was testing malformed p2p messages in the net layer, but it seems that various application layer errors have also been added to the test.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T11:23:03Z",
      "diff_hunk" : "@@ -58,6 +58,7 @@ class InvalidMessagesTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 1\n         self.setup_clean_chain = True\n+        self.extra_args = [[\"-whitelist=addr@127.0.0.1\"]]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664467172",
      "id" : 664467172,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDQ2NzE3Mg==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 61,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 4,
      "pull_request_review_id" : 699826384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:17:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664467172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664543727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664543727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should that not be `break;`? `peer->m_addr_token_bucket` is not going to increase inside this loop.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:14:07Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (!pfrom.HasPermission(NetPermissionFlags::Addr)) {\n+                if (peer->m_addr_token_bucket < 1.0) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664543727",
      "id" : 664543727,
      "line" : 2809,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU0MzcyNw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2809,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 54,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664543727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664547038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664547038"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: this entire snippet can be inside `if (!pfrom.HasPermission(NetPermissionFlags::Addr)) {` to avoid making calculations that are not going to be used later. That may be insignificant wrt performance (the shuffle too?) and the deeper indentation may look ugly, so feel free to ignore.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:18:15Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664547038",
      "id" : 664547038,
      "line" : 2801,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU0NzAzOA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2801,
      "original_position" : 46,
      "original_start_line" : 2791,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : 2791,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664547038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664552110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664552110"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For bucket size we use `MAX_ADDR_TO_SEND` in the code, but they are semantically different. Maybe add new constant `ADDR_RATE_BUCKET_SIZE`? Should that be a little bit higher than `MAX_ADDR_TO_SEND`? For example:\r\n\r\n1. The peer sends us some unsolicited addr\r\n2. We send getaddr and fill the bucket to the max 1000\r\n3. We receive the unsolicited addr from 1.\r\n4. We receive the getaddr response from 2. (1000 addresses)\r\n\r\n=> some address is going to be dropped unnecessary, even though the peer did not \"spam\" us.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:24:37Z",
      "diff_hunk" : "@@ -155,6 +155,9 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n /** The maximum number of address records permitted in an ADDR message. */\n static constexpr size_t MAX_ADDR_TO_SEND{1000};\n+/** The maximum rate of address records we're willing to process on average. Can be bypassed using\n+ *  the NetPermissionFlags::Addr permission. */\n+static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664552110",
      "id" : 664552110,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU1MjExMA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664552110",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664553208"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664553208"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is ok as `MAX_ADDR_TO_SEND`",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:25:54Z",
      "diff_hunk" : "@@ -2583,6 +2591,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             peer->m_getaddr_sent = true;\n+            // When requesting a getaddr, accept an additional MAX_ADDR_TO_SEND addresses in response.\n+            peer->m_addr_token_bucket += MAX_ADDR_TO_SEND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664553208",
      "id" : 664553208,
      "line" : 2595,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU1MzIwOA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2595,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664553208",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664553943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664553943"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This `MAX_ADDR_TO_SEND` is semantically the bucket size, so if a new constant is added it should be used here.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:26:48Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664553943",
      "id" : 664553943,
      "line" : 2793,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU1Mzk0Mw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2793,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664553943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664554249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664554249"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This `MAX_ADDR_TO_SEND` is semantically the bucket size, so if a new constant is added it should be used here.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:27:07Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664554249",
      "id" : 664554249,
      "line" : 2797,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU1NDI0OQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2797,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664554249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664559669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664559669"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why the second octet in [1,254] and 3rd and 4th [2,255]?\r\n\r\n`1+randrange(1,255)` is the same as `randrange(2,256)`, why the former?",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T13:33:26Z",
      "diff_hunk" : "@@ -75,6 +80,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):\n+        addrs = []\n+        for i in range(num):\n+            addr = CAddress()\n+            addr.time = self.mocktime + i\n+            addr.nServices = NODE_NETWORK | NODE_WITNESS\n+            addr.ip = f\"{random.randrange(128,169)}.{random.randrange(1,255)}.{1+random.randrange(1,255)}.{1+random.randrange(1,255)}\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664559669",
      "id" : 664559669,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDU1OTY2OQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 89,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 36,
      "pull_request_review_id" : 699937128,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T13:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664559669",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664699379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664699379"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't the `Advance the time by 100 seconds` test unnecessary given the `Advance the time by 1000 seconds` test? I think the latter is testing everything that the former does.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:16:35Z",
      "diff_hunk" : "@@ -207,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_2)\n+            assert_greater_than_or_equal(addr_count_1 + 600, addr_count_2)\n+            assert_equal(addr_count_2 > addr_count_1, tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_3)\n+            assert_equal(addr_count_2, addr_count_3)\n+\n+            # Advance the time by 100 seconds, permitting the processing of 10 more addresses. Send 200,\n+            # but verify that no more than 10 are processed.\n+            self.mocktime += 100\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 10\n+            peer.send_and_ping(self.setup_rand_addr_msg(200))\n+            addr_count_4 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_4)\n+            assert_greater_than_or_equal(addr_count_3 + 10, addr_count_4)\n+\n+            # Advance the time by 1000 seconds, permitting the processing of 100 more addresses. Send 200,\n+            # but verify that no more than 100 are processed (and at least some).\n+            self.mocktime += 1000\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 100\n+            peer.send_and_ping(self.setup_rand_addr_msg(200))\n+            addr_count_5 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_5)\n+            assert_greater_than_or_equal(addr_count_4 + 100, addr_count_5)\n+            assert_equal(addr_count_5 > addr_count_4, not no_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664699379",
      "id" : 664699379,
      "line" : 288,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY5OTM3OQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 288,
      "original_position" : 119,
      "original_start_line" : 267,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 119,
      "pull_request_review_id" : 700147680,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : 267,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-06T16:19:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664699379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664699518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664699518"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You reuse this value of 10 lower down. How about saving it as a variable to remove that repetition (and also to test that the no_relay node's addr count doesn't increase):\r\n\r\n```diff\r\n--- a/test/functional/p2p_addr_relay.py\r\n+++ b/test/functional/p2p_addr_relay.py\r\n@@ -268,23 +268,23 @@ class AddrTest(BitcoinTestFramework):\r\n             # but verify that no more than 10 are processed.\r\n             self.mocktime += 100\r\n             self.nodes[0].setmocktime(self.mocktime)\r\n-            if not no_relay:\r\n-                tokens += 10\r\n+            new_tokens = 0 if no_relay else 10\r\n+            tokens += new_tokens\r\n             peer.send_and_ping(self.setup_rand_addr_msg(200))\r\n             addr_count_4 = len(self.nodes[0].getnodeaddresses(0))\r\n             assert_greater_than_or_equal(tokens, addr_count_4)\r\n-            assert_greater_than_or_equal(addr_count_3 + 10, addr_count_4)\r\n+            assert_greater_than_or_equal(addr_count_3 + new_tokens, addr_count_4)\r\n \r\n             # Advance the time by 1000 seconds, permitting the processing of 100 more addresses. Send 200,\r\n             # but verify that no more than 100 are processed (and at least some).\r\n             self.mocktime += 1000\r\n             self.nodes[0].setmocktime(self.mocktime)\r\n-            if not no_relay:\r\n-                tokens += 100\r\n+            new_tokens = 0 if no_relay else 100\r\n+            tokens += new_tokens\r\n             peer.send_and_ping(self.setup_rand_addr_msg(200))\r\n             addr_count_5 = len(self.nodes[0].getnodeaddresses(0))\r\n             assert_greater_than_or_equal(tokens, addr_count_5)\r\n-            assert_greater_than_or_equal(addr_count_4 + 100, addr_count_5)\r\n+            assert_greater_than_or_equal(addr_count_4 + new_tokens, addr_count_5)\r\n             assert_equal(addr_count_5 > addr_count_4, not no_relay)\r\n \r\n             self.nodes[0].disconnect_p2ps()\r\n```",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:16:47Z",
      "diff_hunk" : "@@ -207,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_2)\n+            assert_greater_than_or_equal(addr_count_1 + 600, addr_count_2)\n+            assert_equal(addr_count_2 > addr_count_1, tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_3)\n+            assert_equal(addr_count_2, addr_count_3)\n+\n+            # Advance the time by 100 seconds, permitting the processing of 10 more addresses. Send 200,\n+            # but verify that no more than 10 are processed.\n+            self.mocktime += 100\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 10",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664699518",
      "id" : 664699518,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDY5OTUxOA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 272,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 103,
      "pull_request_review_id" : 699826384,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:17:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664699518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664701781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664701781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2 is incorrect. We increment the bucket by 1000, not set it to 1000.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:20:02Z",
      "diff_hunk" : "@@ -155,6 +155,9 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n /** The maximum number of address records permitted in an ADDR message. */\n static constexpr size_t MAX_ADDR_TO_SEND{1000};\n+/** The maximum rate of address records we're willing to process on average. Can be bypassed using\n+ *  the NetPermissionFlags::Addr permission. */\n+static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664701781",
      "id" : 664701781,
      "in_reply_to_id" : 664552110,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDcwMTc4MQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 700150976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:20:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664701781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664704257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664704257"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe have just one constant in the test \"bucket size = 1000\" and derive everything from it? So that if the bucket size is changed in the future in `net_processing.cpp` this test is easier to adjust.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:23:24Z",
      "diff_hunk" : "@@ -207,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_2)\n+            assert_greater_than_or_equal(addr_count_1 + 600, addr_count_2)\n+            assert_equal(addr_count_2 > addr_count_1, tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_3)\n+            assert_equal(addr_count_2, addr_count_3)\n+\n+            # Advance the time by 100 seconds, permitting the processing of 10 more addresses. Send 200,\n+            # but verify that no more than 10 are processed.\n+            self.mocktime += 100\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 10",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664704257",
      "id" : 664704257,
      "in_reply_to_id" : 664699518,
      "line" : 272,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDcwNDI1Nw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 272,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 103,
      "pull_request_review_id" : 700154088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664704257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664705551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664705551"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 87c8d2d072d52c79f092cc432f98c6157fe8e662\r\n\r\nThe commit message states that \"The token counter increases at a rate of 0.1 tokens per second, and will accrue up to a maximum of 1000 tokens\" but this seems a bit misleading. Since 1000 tokens are added upon sending a GETADDR, we could bump it past 1000 (I think the maximum is perhaps 1007, and 1001 seems likely). Perhaps something like \"The token counter increases at a rate of 0.1 tokens per second unless it has already reached 1000...\" would be more clear.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:25:15Z",
      "diff_hunk" : "@@ -2583,6 +2591,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             peer->m_getaddr_sent = true;\n+            // When requesting a getaddr, accept an additional MAX_ADDR_TO_SEND addresses in response.\n+            peer->m_addr_token_bucket += MAX_ADDR_TO_SEND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664705551",
      "id" : 664705551,
      "line" : 2595,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDcwNTU1MQ==",
      "original_commit_id" : "87c8d2d072d52c79f092cc432f98c6157fe8e662",
      "original_line" : 2595,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 27,
      "pull_request_review_id" : 700155832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T17:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664705551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664711094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664711094"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right! It is capped to `1000`, but when expecting getaddr response we just do `+= 1000` without checking. Sorry for the noise.",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T16:32:47Z",
      "diff_hunk" : "@@ -155,6 +155,9 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n /** The maximum number of address records permitted in an ADDR message. */\n static constexpr size_t MAX_ADDR_TO_SEND{1000};\n+/** The maximum rate of address records we're willing to process on average. Can be bypassed using\n+ *  the NetPermissionFlags::Addr permission. */\n+static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664711094",
      "id" : 664711094,
      "in_reply_to_id" : 664552110,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDcxMTA5NA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 700163040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T16:32:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664711094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664750999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664750999"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand why it should be `break` - am I missing something? There are other things happening in the loop as well",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T17:31:59Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (!pfrom.HasPermission(NetPermissionFlags::Addr)) {\n+                if (peer->m_addr_token_bucket < 1.0) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664750999",
      "id" : 664750999,
      "in_reply_to_id" : 664543727,
      "line" : 2809,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDc1MDk5OQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2809,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 54,
      "pull_request_review_id" : 700155832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T17:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664750999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664752631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664752631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n            const double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n```",
      "commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "created_at" : "2021-07-06T17:34:35Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664752631",
      "id" : 664752631,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDc1MjYzMQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2796,
      "original_position" : 41,
      "original_start_line" : 2795,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 700155832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : 2795,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-06T17:40:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664752631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664927787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664927787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed, a break is enough. Fixed.\r\n\r\n@glozow The loop does many things, but if if at some point the rate-limiting condition is reached, it will be reached for all further loop iterations too.",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T22:57:35Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (!pfrom.HasPermission(NetPermissionFlags::Addr)) {\n+                if (peer->m_addr_token_bucket < 1.0) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664927787",
      "id" : 664927787,
      "in_reply_to_id" : 664543727,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkyNzc4Nw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2809,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700443590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664927787",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No, if `pfrom.HasPermission(NetPermissionFlags::Addr)` is true, the loop still has to run - just the rate-limiting check is skipped.",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T22:58:31Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928077",
      "id" : 664928077,
      "in_reply_to_id" : 664547038,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkyODA3Nw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2806,
      "original_position" : 46,
      "original_start_line" : 2791,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700443993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-06T22:58:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928627"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've introduced a separate `MAX_ADDR_PROCESSING_TOKEN_BUCKET` constant, also initialized to 0. Also amended a few comments to be clearer about the fact that GETADDR can exceed this limit.",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T23:00:03Z",
      "diff_hunk" : "@@ -155,6 +155,9 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n /** The maximum number of address records permitted in an ADDR message. */\n static constexpr size_t MAX_ADDR_TO_SEND{1000};\n+/** The maximum rate of address records we're willing to process on average. Can be bypassed using\n+ *  the NetPermissionFlags::Addr permission. */\n+static constexpr double MAX_ADDR_RATE_PER_SECOND{0.1};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928627",
      "id" : 664928627,
      "in_reply_to_id" : 664552110,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkyODYyNw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 6,
      "pull_request_review_id" : 700444681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T23:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T23:00:14Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928716",
      "id" : 664928716,
      "in_reply_to_id" : 664554249,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkyODcxNg==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2797,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700444765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T23:00:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928779"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928779"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A typo, fixed.",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T23:00:24Z",
      "diff_hunk" : "@@ -75,6 +80,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):\n+        addrs = []\n+        for i in range(num):\n+            addr = CAddress()\n+            addr.time = self.mocktime + i\n+            addr.nServices = NODE_NETWORK | NODE_WITNESS\n+            addr.ip = f\"{random.randrange(128,169)}.{random.randrange(1,255)}.{1+random.randrange(1,255)}.{1+random.randrange(1,255)}\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664928779",
      "id" : 664928779,
      "in_reply_to_id" : 664559669,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkyODc3OQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 89,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 700444831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T23:00:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664928779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664930730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664930730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've replaced it with the helpful `CountSecondsDouble` we have in util/time.h.",
      "commit_id" : "c643c730afc415ad092e6d3d7fcab99701e27c96",
      "created_at" : "2021-07-06T23:06:03Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664930730",
      "id" : 664930730,
      "in_reply_to_id" : 664460746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDkzMDczMA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2796,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700447323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-06T23:06:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664930730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664967887"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664967887"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T01:04:01Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664967887",
      "id" : 664967887,
      "in_reply_to_id" : 664553943,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDk2Nzg4Nw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2793,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700489761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T01:04:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664967887",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978068"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T01:37:38Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978068",
      "id" : 664978068,
      "in_reply_to_id" : 664752631,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDk3ODA2OA==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2796,
      "original_position" : 41,
      "original_start_line" : 2795,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700502053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T01:37:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment about this to the commit message.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T01:37:59Z",
      "diff_hunk" : "@@ -2583,6 +2591,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // Get recent addresses\n             m_connman.PushMessage(&pfrom, CNetMsgMaker(greatest_common_version).Make(NetMsgType::GETADDR));\n             peer->m_getaddr_sent = true;\n+            // When requesting a getaddr, accept an additional MAX_ADDR_TO_SEND addresses in response.\n+            peer->m_addr_token_bucket += MAX_ADDR_TO_SEND;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978166",
      "id" : 664978166,
      "in_reply_to_id" : 664705551,
      "line" : 2600,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDk3ODE2Ng==",
      "original_commit_id" : "87c8d2d072d52c79f092cc432f98c6157fe8e662",
      "original_line" : 2600,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 41,
      "pull_request_review_id" : 700502167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T01:38:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps, I'm not entirely sure. The issue is that the last test is a bit weak, as a ton of entries have already been added to addrman (which fills up the relevant buckets asymptotically), so not that much is expected to be added anymore. The test before happens at a point when it's somewhat less full, so it's more appropriate a place to test that not too much is being added. The value of the last test is really only the ability to test that it incremented at all (which isn't guaranteed with 10 extra tokens).",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T01:39:59Z",
      "diff_hunk" : "@@ -207,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_2)\n+            assert_greater_than_or_equal(addr_count_1 + 600, addr_count_2)\n+            assert_equal(addr_count_2 > addr_count_1, tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_3)\n+            assert_equal(addr_count_2, addr_count_3)\n+\n+            # Advance the time by 100 seconds, permitting the processing of 10 more addresses. Send 200,\n+            # but verify that no more than 10 are processed.\n+            self.mocktime += 100\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 10\n+            peer.send_and_ping(self.setup_rand_addr_msg(200))\n+            addr_count_4 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_4)\n+            assert_greater_than_or_equal(addr_count_3 + 10, addr_count_4)\n+\n+            # Advance the time by 1000 seconds, permitting the processing of 100 more addresses. Send 200,\n+            # but verify that no more than 100 are processed (and at least some).\n+            self.mocktime += 1000\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 100\n+            peer.send_and_ping(self.setup_rand_addr_msg(200))\n+            addr_count_5 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_5)\n+            assert_greater_than_or_equal(addr_count_4 + 100, addr_count_5)\n+            assert_equal(addr_count_5 > addr_count_4, not no_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664978731",
      "id" : 664978731,
      "in_reply_to_id" : 664699379,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDk3ODczMQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 288,
      "original_position" : 119,
      "original_start_line" : 267,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 700502852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T01:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664978731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664979029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664979029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jnewbery Done.\r\n\r\n@vasild It's not entirely clear how to do that sufficiently generically (we'll probably want different test cases entirely if the rate limit changes).",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T01:40:44Z",
      "diff_hunk" : "@@ -207,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_2)\n+            assert_greater_than_or_equal(addr_count_1 + 600, addr_count_2)\n+            assert_equal(addr_count_2 > addr_count_1, tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_3)\n+            assert_equal(addr_count_2, addr_count_3)\n+\n+            # Advance the time by 100 seconds, permitting the processing of 10 more addresses. Send 200,\n+            # but verify that no more than 10 are processed.\n+            self.mocktime += 100\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if not no_relay:\n+                tokens += 10",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r664979029",
      "id" : 664979029,
      "in_reply_to_id" : 664699518,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NDk3OTAyOQ==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 272,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 700503171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T01:40:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/664979029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665141497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665141497"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> this entire snippet can be inside ...\r\n> ... the loop still has to run ...\r\n\r\nThe loop if after the snippet, it will run. Just to clarify:\r\n\r\n```diff\r\n--- i/src/net_processing.cpp\r\n+++ w/src/net_processing.cpp\r\n@@ -2790,24 +2790,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n \r\n         // Store the new addresses\r\n         std::vector<CAddress> vAddrOk;\r\n         int64_t nNow = GetAdjustedTime();\r\n         int64_t nSince = nNow - 10 * 60;\r\n \r\n-        // Update/increment addr rate limiting bucket.\r\n-        const auto current_time = GetTime<std::chrono::microseconds>();\r\n-        if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\r\n-            // Don't increment bucket if it's already full\r\n-            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n-            const double increment = CountSecondsDouble(time_diff) * MAX_ADDR_RATE_PER_SECOND;\r\n-            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\r\n-        }\r\n-        peer->m_addr_token_timestamp = current_time;\r\n-\r\n-        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\r\n         const bool rate_limited = !pfrom.HasPermission(NetPermissionFlags::Addr);\r\n+\r\n+        if (rate_limited) {\r\n+            // Update/increment addr rate limiting bucket.\r\n+            const auto current_time = GetTime<std::chrono::microseconds>();\r\n+            if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\r\n+                // Don't increment bucket if it's already full\r\n+                const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n+                const double increment = CountSecondsDouble(time_diff) * MAX_ADDR_RATE_PER_SECOND;\r\n+                peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\r\n+            }\r\n+            peer->m_addr_token_timestamp = current_time;\r\n+\r\n+            Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\r\n+        }\r\n+\r\n         for (CAddress& addr : vAddr)\r\n```\r\n\r\nDoes not change the behavior, but is slightly more performant :+1: (and deeply indented :-1:). Again, feel free to ignore. This comment is just for clarification, not an insistence :)",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T08:07:14Z",
      "diff_hunk" : "@@ -2777,11 +2787,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\n+            // Don't increment bucket if it's already full\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665141497",
      "id" : 665141497,
      "in_reply_to_id" : 664547038,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTE0MTQ5Nw==",
      "original_commit_id" : "dade562ea5479e32c6a49fc92e9646f761b8e376",
      "original_line" : 2806,
      "original_position" : 46,
      "original_start_line" : 2791,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 700701796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T08:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665141497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665145646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665145646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do you think it makes sense to log a (debug) message if this occurs? The assumption is that it will happen very rarely, if ever, so it might be of interest if it happens in order to have an idea of its frequency.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T08:13:00Z",
      "diff_hunk" : "@@ -2777,11 +2792,29 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\n+            // Don't increment bucket if it's already full\n+            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            const double increment = CountSecondsDouble(time_diff) * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n+        const bool rate_limited = !pfrom.HasPermission(NetPermissionFlags::Addr);\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (rate_limited) {\n+                if (peer->m_addr_token_bucket < 1.0) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665145646",
      "id" : 665145646,
      "line" : 2815,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTE0NTY0Ng==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 2815,
      "original_position" : 69,
      "original_start_line" : 2813,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 700707406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : 2813,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T10:29:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665145646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665146003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665146003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's no need to change this comment.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T08:13:29Z",
      "diff_hunk" : "@@ -215,7 +222,7 @@ struct Peer {\n     /** Whether a ping has been requested by the user */\n     std::atomic<bool> m_ping_queued{false};\n \n-    /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665146003",
      "id" : 665146003,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTE0NjAwMw==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 218,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 700707900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T08:19:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665146003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I have 2 conceptual questions to this PR:\r\n\r\n1. How does it work against the \"bottlenecking problem\" (something we saw in the dandelion/rate-limiting discussion too)?\r\nLet's say your reachable node has 10 outbound conns, and couple inbounds.\r\nAn attacker makes 100 connections to your node, and constantly spends all tokens by transmitting more-than-average addrs. Now, when your peers receive announcements from your node, they might very likely exclude your honest inbounds (you announced to them) from relay, and announce only those Sybil nodes instead.\r\nPreviously, they would relay everything I guess?\r\n\r\n2. Do we want to design these tokens while keeping in mind that we also wanna reuse them for other kinds of p2p dos? Or are we going to have separate tokens for other use-cases in the future? Or do you want to ignore this aspect for now?",
      "created_at" : "2021-07-07T11:46:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-875536479",
      "id" : 875536479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTUzNjQ3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T11:46:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875536479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re ACK dc8a1863f30b5944490cdbaa3271afbf8cd6da9a via `git range-diff dade562...dc8a186`\r\n\r\n- New constant `MAX_ADDR_PROCESSING_TOKEN_BUCKET` \r\n- Comments about exceeding [soft] limit when incrementing for GETADDR\r\n- const `time_diff` and `increment`\r\n- `break` out of addrs loop when tokens run out\r\n- rand ranges {1,255} + refactors in test",
      "created_at" : "2021-07-07T13:13:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-875592657",
      "id" : 875592657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTU5MjY1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T13:13:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875592657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665377495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665377495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems reasonable to print a single log in the `BCLog::NET` if an `addr` or `addrv2` p2p message has address records dropped.",
      "commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "created_at" : "2021-07-07T13:35:53Z",
      "diff_hunk" : "@@ -2777,11 +2792,29 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\n+            // Don't increment bucket if it's already full\n+            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            const double increment = CountSecondsDouble(time_diff) * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n+        const bool rate_limited = !pfrom.HasPermission(NetPermissionFlags::Addr);\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (rate_limited) {\n+                if (peer->m_addr_token_bucket < 1.0) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665377495",
      "id" : 665377495,
      "in_reply_to_id" : 665145646,
      "line" : 2815,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTM3NzQ5NQ==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 2815,
      "original_position" : 69,
      "original_start_line" : 2813,
      "path" : "src/net_processing.cpp",
      "position" : 69,
      "pull_request_review_id" : 701015174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : 2813,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T13:35:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665377495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665624211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665624211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It does happen occasionally very early in a connection's lifetime, if an address send event happens in the first 10 seconds. A few crawlers that very actively provide addresses also trigger it sometimes. I think both of these are harmless.\r\n\r\nAdded a commit to add logging.",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T18:46:28Z",
      "diff_hunk" : "@@ -2777,11 +2792,29 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        if (peer->m_addr_token_bucket < MAX_ADDR_PROCESSING_TOKEN_BUCKET) {\n+            // Don't increment bucket if it's already full\n+            const auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+            const double increment = CountSecondsDouble(time_diff) * MAX_ADDR_RATE_PER_SECOND;\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_PROCESSING_TOKEN_BUCKET);\n+        }\n+        peer->m_addr_token_timestamp = current_time;\n+\n+        Shuffle(vAddr.begin(), vAddr.end(), FastRandomContext());\n+        const bool rate_limited = !pfrom.HasPermission(NetPermissionFlags::Addr);\n         for (CAddress& addr : vAddr)\n         {\n             if (interruptMsgProc)\n                 return;\n \n+            // Apply rate limiting.\n+            if (rate_limited) {\n+                if (peer->m_addr_token_bucket < 1.0) break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665624211",
      "id" : 665624211,
      "in_reply_to_id" : 665145646,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTYyNDIxMQ==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 2815,
      "original_position" : 69,
      "original_start_line" : 2813,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 701339111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T18:46:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665624211",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665630867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665630867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couldn't this just be in the `if` where `rate_limiting_triggered` is being set and thus remove the need for the bool?",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T18:56:49Z",
      "diff_hunk" : "@@ -2837,6 +2841,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             if (fReachable)\n                 vAddrOk.push_back(addr);\n         }\n+        if (rate_limiting_triggered) {\n+            LogPrint(BCLog::NET, \"Rate limiting an address message from peer=%d\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665630867",
      "id" : 665630867,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTYzMDg2Nw==",
      "original_commit_id" : "cb0c885fbbe05e73581de429d0c1d451eb4d2696",
      "original_line" : 2845,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 701347520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T18:57:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665630867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665631239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665631239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: use f-string instead?",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T18:57:22Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665631239",
      "id" : 665631239,
      "line" : 231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTYzMTIzOQ==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 231,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 62,
      "pull_request_review_id" : 701347520,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T18:57:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665631239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665639769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665639769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T19:11:18Z",
      "diff_hunk" : "@@ -215,7 +222,7 @@ struct Peer {\n     /** Whether a ping has been requested by the user */\n     std::atomic<bool> m_ping_queued{false};\n \n-    /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665639769",
      "id" : 665639769,
      "in_reply_to_id" : 665146003,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTYzOTc2OQ==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 218,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 701359496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T19:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665639769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665640098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665640098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea, done.",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T19:11:55Z",
      "diff_hunk" : "@@ -2837,6 +2841,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             if (fReachable)\n                 vAddrOk.push_back(addr);\n         }\n+        if (rate_limiting_triggered) {\n+            LogPrint(BCLog::NET, \"Rate limiting an address message from peer=%d\\n\", pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665640098",
      "id" : 665640098,
      "in_reply_to_id" : 665630867,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY0MDA5OA==",
      "original_commit_id" : "cb0c885fbbe05e73581de429d0c1d451eb4d2696",
      "original_line" : 2845,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 701359930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T19:11:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665640098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665640237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665640237"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't find those generally more readable.",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T19:12:08Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665640237",
      "id" : 665640237,
      "in_reply_to_id" : 665631239,
      "line" : 231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY0MDIzNw==",
      "original_commit_id" : "dc8a1863f30b5944490cdbaa3271afbf8cd6da9a",
      "original_line" : 231,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 62,
      "pull_request_review_id" : 701360102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T19:12:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665640237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild\r\n\r\nI think your logging exaggerates the effect, ecause it only prints #addr/time for individual messages, ignoring that the token bucket can accumulate across multiple messages.\r\n\r\nOn my own nodes I do see occasional rate limiting, but they're all (a) very early in a connection's lifetime or (b) from very spammy nodes (with \"bitnodes\" or \"multiven\" in their user agent).\r\n\r\n@naumenkogs\r\n\r\n1. Good point, that's perhaps interesting for a future improvement to consider. I don't think this PR is making anything worse though - it stops spammy addr messages at a much earlier stage, but as is on the network, they are already stopped eventually due to the size limit of the `m_addr_to_send` buffer.\r\n2. I'm not sure yet, perhaps something to discuss when similar rate-limitings are being added for other things.\r\n\r\n",
      "created_at" : "2021-07-07T19:21:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-875868090",
      "id" : 875868090,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTg2ODA5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T19:21:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875868090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-07T19:56:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-875889604",
      "id" : 875889604,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTg4OTYwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T19:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875889604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665780690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665780690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: this comment is backwards (our node sends a GETADDR and processes the incoming addresses, not the outbound peer)",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-08T00:03:45Z",
      "diff_hunk" : "@@ -208,6 +225,69 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_equal(addr_count_0, 0)\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert_greater_than_or_equal(tokens, addr_count_1)\n+            assert_greater_than_or_equal(addr_count_0 + 600, addr_count_1)\n+            assert_equal(addr_count_1 > addr_count_0, tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665780690",
      "id" : 665780690,
      "line" : 253,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTc4MDY5MA==",
      "original_commit_id" : "f8e51a85ac0c783808fc64179fcc108aad676079",
      "original_line" : 253,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 84,
      "pull_request_review_id" : 701537117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T00:24:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665780690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-07-08T00:16:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-876018530",
      "id" : 876018530,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjAxODUzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T00:16:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876018530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665882202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665882202"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this is not about  'Number of addr messages' (because one message can contain 1000 items), but about number of addr items?",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-08T05:34:19Z",
      "diff_hunk" : "@@ -233,6 +240,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r665882202",
      "id" : 665882202,
      "line" : 243,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTg4MjIwMg==",
      "original_commit_id" : "4291de17e9de183d1433d96047bbe135fd0821ef",
      "original_line" : 243,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 701654647,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T09:09:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665882202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r666114299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666114299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It looks like the code makes sure that this number never leaves the range `0.0..MAX_ADDR_PROCESSING_TOKEN_BUCKET`, right?\r\n(I generally don't like using floating point for countable objects because of potential infinite loops when the value becomes too large or negative to be represented with a granularity of 1, but I think this issue is avoided)",
      "commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "created_at" : "2021-07-08T11:39:42Z",
      "diff_hunk" : "@@ -233,6 +240,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r666114299",
      "id" : 666114299,
      "line" : 245,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjExNDI5OQ==",
      "original_commit_id" : "8b60d6f538abbee5ea3ef6b49968f6afd2581877",
      "original_line" : 245,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 20,
      "pull_request_review_id" : 701956579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T11:39:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666114299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
