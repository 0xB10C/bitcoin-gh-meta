[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21528 by amitiuttarwar\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-02T01:41:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872651861",
      "id" : 872651861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY1MTg2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T01:41:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872651861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> There are measures to limit the influence attackers can have on the addrman database (bucket restrictions based on IPs), but still - **there is no need to permit them to feed us addresses at a rate that's orders of magnitude larger than what is common on the network today**, especially as it will cause us to spam our peers too.\r\n\r\nConcept ACK",
      "created_at" : "2021-07-02T03:08:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#issuecomment-872679319",
      "id" : 872679319,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3MjY3OTMxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-02T03:08:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/872679319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for default initialization value here if this is set in the initialization list in the only ctor.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T10:45:40Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662921032",
      "id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjkyMTAzMg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662921032",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find this line quite difficult to parse. I think the intention is that we don't cap m_addr_token_bucket to MAX_ADDR_TO_SEND (in the case where it was incremented because we sent a getaddr). Is this easier to read:\r\n\r\n```diff\r\n         // Update/increment addr rate limiting bucket.\r\n         const auto current_time = GetTime<std::chrono::microseconds>();\r\n-        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n-        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+        if (peer->m_addr_token_bucket < MAX_ADDR_TO_SEND) {\r\n+            // Don't increment bucket if it's already full\r\n+            auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\r\n+            double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\r\n+            peer->m_addr_token_bucket = std::min<double>(peer->m_addr_token_bucket + increment, MAX_ADDR_TO_SEND);\r\n+        }\r\n         peer->m_addr_token_timestamp = current_time;\r\n-        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));\r\n \r\n         for (CAddress& addr : vAddr)\r\n         {\r\n```",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:28:36Z",
      "diff_hunk" : "@@ -2776,11 +2787,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::vector<CAddress> vAddrOk;\n         int64_t nNow = GetAdjustedTime();\n         int64_t nSince = nNow - 10 * 60;\n+\n+        // Update/increment addr rate limiting bucket.\n+        const auto current_time = GetTime<std::chrono::microseconds>();\n+        auto time_diff = std::max(current_time - peer->m_addr_token_timestamp, 0us);\n+        double increment = std::chrono::duration<double>(time_diff).count() * MAX_ADDR_RATE_PER_SECOND;\n+        peer->m_addr_token_timestamp = current_time;\n+        peer->m_addr_token_bucket += std::max(0.0, std::min<double>(MAX_ADDR_TO_SEND - peer->m_addr_token_bucket, increment));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662943964",
      "id" : 662943964,
      "line" : 2796,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0Mzk2NA==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 2796,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 49,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662943964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is necessary. The `add_[outbound_]p2p_connection()` methods already do a sync_with_ping.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:29:49Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662944636",
      "id" : 662944636,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NDYzNg==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 70,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662944636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using the `assert_equal()`/`assert_greater_than()`/`assert_greater_than_or_equal()` helper functions (they give more helpful output if the test fails).",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:31:42Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662945737",
      "id" : 662945737,
      "line" : 244,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0NTczNw==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 244,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 74,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662945737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(not necessarily for this PR) should the other tests be updated to use random IP addresses? I guess you're doing this and not reusing setup_addr_msg() in case the addresses returned may result in addrman bucket collisions?",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:22Z",
      "diff_hunk" : "@@ -75,6 +79,19 @@ def setup_addr_msg(self, num):\n         msg.addrs = addrs\n         return msg\n \n+    def setup_rand_addr_msg(self, num):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949531",
      "id" : 662949531,
      "line" : 82,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTUzMQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 82,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 28,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n            assert (addr_count_3 <= addr_count_2)\r\n```\r\n\r\n(or better yet, use `assert_greater_than_or_equal()`)",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T11:39:58Z",
      "diff_hunk" : "@@ -207,6 +224,71 @@ def blocksonly_mode_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def rate_limit_tests(self):\n+\n+        for contype, tokens, no_relay in [(\"outbound-full-relay\", 1001, False), (\"block-relay-only\", 0, True), (\"inbound\", 1, False)]:\n+            self.log.info('Test rate limiting of addr processing for %s peers' % contype)\n+            self.stop_node(0)\n+            os.remove(os.path.join(self.nodes[0].datadir, \"regtest\", \"peers.dat\"))\n+            self.start_node(0, [])\n+            self.mocktime = int(time.time())\n+            self.nodes[0].setmocktime(self.mocktime)\n+            if contype == \"inbound\":\n+                peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+            else:\n+                peer = self.nodes[0].add_outbound_p2p_connection(AddrReceiver(), p2p_idx=0, connection_type=contype)\n+            peer.sync_with_ping()\n+\n+            # Check that we start off with empty addrman\n+            addr_count_0 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_0 == 0\n+\n+            # Send 600 addresses. For all but the block-relay-only peer this should result in at least 1 address.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_1 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_1 <= tokens\n+            assert addr_count_1 <= addr_count_0 + 600\n+            assert (addr_count_1 > addr_count_0) == (tokens > 0)\n+\n+            # Send 600 more addresses. For the outbound-full-relay peer (which sends a GETADDR, and thus will\n+            # process up to 1001 incoming addresses), this means more entries will appear.\n+            peer.send_and_ping(self.setup_rand_addr_msg(600))\n+            addr_count_2 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_2 <= tokens\n+            assert addr_count_2 <= addr_count_1 + 600\n+            assert (addr_count_2 > addr_count_1) == (tokens > 600)\n+\n+            # Send 10 more. As we reached the processing limit for all nodes, this should have no effect.\n+            peer.send_and_ping(self.setup_rand_addr_msg(10))\n+            addr_count_3 = len(self.nodes[0].getnodeaddresses(0))\n+            assert addr_count_3 <= tokens\n+            assert addr_count_3 <= addr_count_2 + 10\n+            assert (addr_count_3 > addr_count_2) == False",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662949805",
      "id" : 662949805,
      "line" : 266,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk0OTgwNQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 266,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 96,
      "pull_request_review_id" : 698062663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T12:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662949805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::chrono::microseconds m_addr_token_timestamp{GetTime<std::chrono::microseconds>()};\r\n```\r\n\r\nDoes this compile? If yes, the constructor can be left untouched.",
      "commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "created_at" : "2021-07-02T13:06:55Z",
      "diff_hunk" : "@@ -232,6 +235,11 @@ struct Peer {\n     std::atomic_bool m_wants_addrv2{false};\n     /** Whether this peer has already sent us a getaddr message. */\n     bool m_getaddr_recvd{false};\n+    /** Number of addr messages that can be processed from this peer. Start at 1 to\n+     *  permit self-announcement. */\n+    double m_addr_token_bucket{1.0};\n+    /** When m_addr_token_bucket was last updated */\n+    std::chrono::microseconds m_addr_token_timestamp{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22387#discussion_r662999155",
      "id" : 662999155,
      "in_reply_to_id" : 662921032,
      "line" : 242,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjk5OTE1NQ==",
      "original_commit_id" : "484d8fdd94265b1dc1c850fb2cc3f743b0fffb1c",
      "original_line" : 242,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 698167580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-02T13:06:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/662999155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
