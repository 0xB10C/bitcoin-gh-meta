[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why the change from `true` -> `false`?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:54:39Z",
      "diff_hunk" : "@@ -2565,12 +2570,12 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         }\n     }\n \n-    if (fBlocksDisconnected) {\n+    if (fBlocksDisconnected && m_mempool) {\n         // If any blocks were disconnected, disconnectpool may be non empty.  Add\n         // any disconnected transactions back to the mempool.\n-        UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\n+        mempoolHandleReorg(disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562",
      "id" : 665699562,
      "line" : 2576,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY5OTU2Mg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2576,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice try, but leaving out the `{}` won't prevent the lock from being closed in the same line.",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:55:46Z",
      "diff_hunk" : "@@ -2642,7 +2647,8 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         {\n             LOCK(cs_main);\n-            LOCK(m_mempool.cs); // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194",
      "id" : 665700194,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDE5NA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2651,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 135,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:03Z",
      "diff_hunk" : "@@ -2792,7 +2803,9 @@ bool CChainState::InvalidateBlock(BlockValidationState& state, CBlockIndex* pind\n         LimitValidationInterfaceQueue();\n \n         LOCK(cs_main);\n-        LOCK(m_mempool.cs); // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is called after DisconnectTip without unlocking in between\n+        // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is\n+        // called after DisconnectTip without unlocking in between\n+        if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380",
      "id" : 665700380,
      "line" : 2808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDM4MA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2808,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 160,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nvoid CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool)\r\n{\r\n```\r\n\r\nproperly format new code?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:41Z",
      "diff_hunk" : "@@ -4492,6 +4506,41 @@ bool CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n     return ret;\n }\n \n+void CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718",
      "id" : 665700718,
      "line" : 4509,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDcxOA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 4509,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 191,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be possible to combine the args so that *either* a mempool, or a hash can be passed, but not both? I think std::variant can do this",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:57:56Z",
      "diff_hunk" : "@@ -600,7 +601,7 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(CTxMemPool* mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402",
      "id" : 665701402,
      "line" : 604,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMTQwMg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 604,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 17,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. I think you can drop the second commit and add a `LOCK_RETURNED` helper method to be able to keep using lock annotations when m_mempool is null:\r\n\r\n```c++\r\nRecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs) { return m_mempool ? &m_mempool->cs : nullptr; }\r\n```\r\n\r\nSeems to work for me in commit 8db5953e2d666fb9c25ae8f0df5b4c5c5897cd58\r\n",
      "created_at" : "2021-07-07T23:24:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-875999127",
      "id" : 875999127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTk5OTEyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T23:24:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875999127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22371 by MarcoFalke\n* #21526 by jamesob\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-07-08T00:48:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876031066",
      "id" : 876031066,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjAzMTA2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T00:48:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876031066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hey somebody's gotta keep review fun!",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-08T01:31:20Z",
      "diff_hunk" : "@@ -2565,12 +2570,12 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         }\n     }\n \n-    if (fBlocksDisconnected) {\n+    if (fBlocksDisconnected && m_mempool) {\n         // If any blocks were disconnected, disconnectpool may be non empty.  Add\n         // any disconnected transactions back to the mempool.\n-        UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\n+        mempoolHandleReorg(disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807596",
      "id" : 665807596,
      "in_reply_to_id" : 665699562,
      "line" : 2576,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTgwNzU5Ng==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2576,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 701567478,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T01:31:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807889"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh yeah d'oh. Sure could've used those missing annotations there.",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-08T01:32:21Z",
      "diff_hunk" : "@@ -2642,7 +2647,8 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         {\n             LOCK(cs_main);\n-            LOCK(m_mempool.cs); // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665807889",
      "id" : 665807889,
      "in_reply_to_id" : 665700194,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTgwNzg4OQ==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2651,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 135,
      "pull_request_review_id" : 701567847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T01:32:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665807889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased to remove the second commit per Russ' suggestion, which also addresses most of Marco's feedback.\r\n\r\n> Seems to work for me in commit 8db5953\r\n\r\nWow, that was wizardly. Thanks @ryanofsky!\r\n\r\n> I think std::variant can do this\r\n\r\nI'll look into this tomorrow.",
      "created_at" : "2021-07-08T02:05:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876061371",
      "id" : 876061371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjA2MTM3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T02:05:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876061371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666040037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666040037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Similarly to [this comment](https://github.com/bitcoin/bitcoin/pull/22415/commits/b17bb4c37d58ca49e877983a632bfcaa493be993#r665701402), can we somehow reflect that if mempool is nullptr, the second argument doesn't make sense?",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T09:45:48Z",
      "diff_hunk" : "@@ -907,7 +913,7 @@ class ChainstateManager\n     //                                  constructor\n     //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n     //!                                 is based on a snapshot.\n-    CChainState& InitializeChainstate(CTxMemPool& mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)\n+    CChainState& InitializeChainstate(CTxMemPool* mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666040037",
      "id" : 666040037,
      "line" : 916,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjA0MDAzNw==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 916,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 58,
      "pull_request_review_id" : 701858949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T09:45:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666040037",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Light code review ACK b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T09:46:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876296570",
      "id" : 876296570,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjI5NjU3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T09:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876296570",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666144964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666144964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs)\r\n    {\r\n```\r\n\r\nclang-format?",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T12:27:09Z",
      "diff_hunk" : "@@ -798,6 +799,11 @@ class CChainState\n \n     bool LoadBlockIndexDB() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    //! Indirection necessary to make lock annotations work with an optional mempool.\n+    RecursiveMutex* MempoolMutex() const LOCK_RETURNED(m_mempool->cs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666144964",
      "id" : 666144964,
      "line" : 803,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjE0NDk2NA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 803,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 46,
      "pull_request_review_id" : 701997551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T12:27:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666144964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666249472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666249472"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nMight be a little more obviously safe to write `Assert(node.mempool.get())` instead of `Assert(node.mempool).get()` since that version looks like the Assert function might be returning a temporary `unique_ptr` that would delete the mempool.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:31:26Z",
      "diff_hunk" : "@@ -1349,7 +1349,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(*Assert(node.mempool));\n+                chainman.InitializeChainstate(Assert(node.mempool).get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666249472",
      "id" : 666249472,
      "line" : 1352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI0OTQ3Mg==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 1352,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 5,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666249472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, will review on next push.",
      "created_at" : "2021-07-08T14:52:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876506636",
      "id" : 876506636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjUwNjYzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T14:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876506636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666272104"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666272104"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nNote: It could be nice to be able to write `AssertLockHeld(MempoolMutex()` for consistency with `LOCK(MempoolMutex())` and to avoid the if statement. But it'd be beyond scope of this PR since it'd require changing `AssertLockHeld` and there are other issues with that function anyway.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:56:05Z",
      "diff_hunk" : "@@ -2254,7 +2257,7 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n bool CChainState::DisconnectTip(BlockValidationState& state, DisconnectedBlockTransactions* disconnectpool)\n {\n     AssertLockHeld(cs_main);\n-    AssertLockHeld(m_mempool.cs);\n+    if (m_mempool) AssertLockHeld(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666272104",
      "id" : 666272104,
      "line" : 2260,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI3MjEwNA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 2260,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 49,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666272104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666275700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666275700"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: make CChainState::m_mempool optional\" (b17bb4c37d58ca49e877983a632bfcaa493be993)\r\n\r\nNote: Naively I'd expect the mempool pointer for the activated snapshot to be non-null, but I guess it could be set later when the snapshot is fully initialized.",
      "commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "created_at" : "2021-07-08T14:59:59Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666275700",
      "id" : 666275700,
      "line" : 4775,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI3NTcwMA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 183,
      "pull_request_review_id" : 702140548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T15:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666275700",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased.\r\n\r\n> Note: Naively I'd expect the mempool pointer for the activated snapshot to be non-null, but I guess it could be set later when the snapshot is fully initialized.\r\n\r\nThis is a good point. I'd come up with a commit that implements the `std::variant` feedback (and am glad to have for learning about that), but @ryanofsky's point here makes that change inappropriate: with assumeutxo, we may actually want the snapshot chain to have a non-null mempool if we're in, say, init.cpp and loading a snapshot chainstate that is active but not yet at tip.\r\n\r\nI've covered all of the other feedback aside from the lock assertion for the reasons Russ mentioned; maybe we can get around to it later.",
      "created_at" : "2021-07-08T16:13:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#issuecomment-876568120",
      "id" : 876568120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22415",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NjU2ODEyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-08T16:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/876568120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340082"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340082"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not going this route for reasons mentioned in a recent comment: passing both is a valid approach if we are initializing a not-yet-to-tip snapshot chainstate in init.cpp.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:18:28Z",
      "diff_hunk" : "@@ -600,7 +601,7 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(CTxMemPool* mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340082",
      "id" : 666340082,
      "in_reply_to_id" : 665701402,
      "line" : 604,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM0MDA4Mg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 604,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 17,
      "pull_request_review_id" : 702263693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T16:18:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340082",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340418"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:18:59Z",
      "diff_hunk" : "@@ -1349,7 +1349,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n             const int64_t load_block_index_start_time = GetTimeMillis();\n             try {\n                 LOCK(cs_main);\n-                chainman.InitializeChainstate(*Assert(node.mempool));\n+                chainman.InitializeChainstate(Assert(node.mempool).get());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666340418",
      "id" : 666340418,
      "in_reply_to_id" : 666249472,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM0MDQxOA==",
      "original_commit_id" : "b17bb4c37d58ca49e877983a632bfcaa493be993",
      "original_line" : 1352,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 702264178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T16:18:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666340418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666368135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666368135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(if you retouch)\r\n```suggestion\r\n            /* mempool */ nullptr, m_blockman, base_blockhash));\r\n```",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-08T16:57:50Z",
      "diff_hunk" : "@@ -4763,7 +4772,7 @@ bool ChainstateManager::ActivateSnapshot(\n     }\n \n     auto snapshot_chainstate = WITH_LOCK(::cs_main, return std::make_unique<CChainState>(\n-            this->ActiveChainstate().m_mempool, m_blockman, base_blockhash));\n+            nullptr, m_blockman, base_blockhash));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666368135",
      "id" : 666368135,
      "line" : 4775,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjM2ODEzNQ==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 4775,
      "original_position" : 183,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 183,
      "pull_request_review_id" : 702300732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T17:10:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666368135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666708997"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666708997"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\r\n\r\nWhat do you think about making this std::optional<CTxMemPool, std::optional>?\r\n\r\nIn this case, snapshot_blockhash can't be possibly specified without mempool, and that's what I originally suggested.\r\n",
      "commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "created_at" : "2021-07-09T06:41:51Z",
      "diff_hunk" : "@@ -907,7 +914,7 @@ class ChainstateManager\n     //                                  constructor\n     //! @param[in] snapshot_blockhash   If given, signify that this chainstate\n     //!                                 is based on a snapshot.\n-    CChainState& InitializeChainstate(CTxMemPool& mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)\n+    CChainState& InitializeChainstate(CTxMemPool* mempool, const std::optional<uint256>& snapshot_blockhash = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r666708997",
      "id" : 666708997,
      "line" : 917,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjcwODk5Nw==",
      "original_commit_id" : "8511429f3bc480ddeef06c23810b3c47fa8513ee",
      "original_line" : 917,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 59,
      "pull_request_review_id" : 702727979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T06:41:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666708997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
