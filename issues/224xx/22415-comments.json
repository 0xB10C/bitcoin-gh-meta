[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why the change from `true` -> `false`?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:54:39Z",
      "diff_hunk" : "@@ -2565,12 +2570,12 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, CBlockIndex\n         }\n     }\n \n-    if (fBlocksDisconnected) {\n+    if (fBlocksDisconnected && m_mempool) {\n         // If any blocks were disconnected, disconnectpool may be non empty.  Add\n         // any disconnected transactions back to the mempool.\n-        UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\n+        mempoolHandleReorg(disconnectpool, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665699562",
      "id" : 665699562,
      "line" : 2576,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY5OTU2Mg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2576,
      "original_position" : 122,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 122,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665699562",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nice try, but leaving out the `{}` won't prevent the lock from being closed in the same line.",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:55:46Z",
      "diff_hunk" : "@@ -2642,7 +2647,8 @@ bool CChainState::ActivateBestChain(BlockValidationState& state, std::shared_ptr\n \n         {\n             LOCK(cs_main);\n-            LOCK(m_mempool.cs); // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            // Lock transaction pool for at least as long as it takes for connectTrace to be consumed\n+            if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700194",
      "id" : 665700194,
      "line" : 2651,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDE5NA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2651,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 135,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700194",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:03Z",
      "diff_hunk" : "@@ -2792,7 +2803,9 @@ bool CChainState::InvalidateBlock(BlockValidationState& state, CBlockIndex* pind\n         LimitValidationInterfaceQueue();\n \n         LOCK(cs_main);\n-        LOCK(m_mempool.cs); // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is called after DisconnectTip without unlocking in between\n+        // Lock for as long as disconnectpool is in scope to make sure UpdateMempoolForReorg is\n+        // called after DisconnectTip without unlocking in between\n+        if (m_mempool) LOCK(m_mempool->cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700380",
      "id" : 665700380,
      "line" : 2808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDM4MA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 2808,
      "original_position" : 160,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 160,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700380",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nvoid CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool)\r\n{\r\n```\r\n\r\nproperly format new code?",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:56:41Z",
      "diff_hunk" : "@@ -4492,6 +4506,41 @@ bool CChainState::ResizeCoinsCaches(size_t coinstip_size, size_t coinsdb_size)\n     return ret;\n }\n \n+void CChainState::mempoolHandleReorg(DisconnectedBlockTransactions& disconnectpool, bool add_to_mempool) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665700718",
      "id" : 665700718,
      "line" : 4509,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMDcxOA==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 4509,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 191,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665700718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it be possible to combine the args so that *either* a mempool, or a hash can be passed, but not both? I think std::variant can do this",
      "commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "created_at" : "2021-07-07T20:57:56Z",
      "diff_hunk" : "@@ -600,7 +601,7 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n-    explicit CChainState(CTxMemPool& mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);\n+    explicit CChainState(CTxMemPool* mempool, BlockManager& blockman, std::optional<uint256> from_snapshot_blockhash = std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22415#discussion_r665701402",
      "id" : 665701402,
      "line" : 604,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTcwMTQwMg==",
      "original_commit_id" : "349ab2843e7161b960a73eb216c135402cb35b73",
      "original_line" : 604,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 17,
      "pull_request_review_id" : 701438810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22415",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:58:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665701402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
