[
   {
      "author_association" : "MEMBER",
      "body" : "Another win for fuzzing, oh wow.",
      "created_at" : "2021-07-15T08:53:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880519934",
      "id" : 880519934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDUxOTkzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T08:53:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880519934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @vasild ",
      "created_at" : "2021-07-15T08:57:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880522555",
      "id" : 880522555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDUyMjU1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T08:57:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880522555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Fuzzer rulez!",
      "created_at" : "2021-07-15T10:11:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880572816",
      "id" : 880572816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDU3MjgxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T10:11:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880572816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The repositioning/rebucketing approach of `ResetI2PPorts()` introduced in #22112 seems very brittle. I think it would make much more sense just to remove any I2P addresses which don't have port 0, and then perhaps add them back through the public (and well-tested) `Add()` interface.\r\n\r\nI don't know the exact bug that leads to this internal addrman inconsistency, but this loop seems suspect to me:\r\n\r\n```\r\n    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; ++bucket) {\r\n        for (int i = 0; i < ADDRMAN_BUCKET_SIZE; ++i) {\r\n            const auto id = vvNew[bucket][i];\r\n            if (id == -1) {\r\n                continue;\r\n            }\r\n            auto it = mapInfo.find(id);\r\n            if (it == mapInfo.end()) {\r\n                return;\r\n            }\r\n            auto& addr_info = it->second;\r\n            if (!addr_info.IsI2P() || addr_info.GetPort() == I2P_SAM31_PORT) {\r\n                continue;\r\n            }\r\n\r\n            auto addr_info_newport = addr_info;\r\n            // The below changes addr_info_newport.GetKey(), which is used in finding a\r\n            // bucket and a position within that bucket. So a re-bucketing may be necessary.\r\n            addr_info_newport.port = I2P_SAM31_PORT;\r\n\r\n            // Reposition entries of vvNew within the same bucket because we don't know the source\r\n            // address which led to the decision to store the entry in vvNew[bucket] so we can't\r\n            // re-evaluate that decision, but even if we could, CAddrInfo::GetNewBucket() does not\r\n            // use CAddrInfo::GetKey() so it would end up in the same bucket as before the port\r\n            // change.\r\n            const auto i_target = addr_info_newport.GetBucketPosition(nKey, true, bucket);\r\n\r\n            if (i_target == i) { // No need to re-position.\r\n                addr_info = addr_info_newport;\r\n                continue;\r\n            }\r\n\r\n            // Reposition from i to i_target, removing the entry from i_target (if any).\r\n            ClearNew(bucket, i_target);\r\n            vvNew[bucket][i_target] = id;\r\n            vvNew[bucket][i] = -1;\r\n            addr_info = addr_info_newport;\r\n        }\r\n    }\r\n```\r\n\r\nIf the same I2P address appears in multiple new buckets, then the first time this loop finds that address, it'll update the port and reposition it in that bucket. Any subsequent times that the address is encountered, it will already have had its port updated so the inner loop will `continue` due to `addr_info.GetPort() == I2P_SAM31_PORT`, but it'll be in the wrong position in its bucket. If we later try to promote the entry from new to tried, then this loop in `MakeTried()` will fail to find the entry in those buckets:\r\n\r\n```\r\n    // remove the entry from all new buckets\r\n    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\r\n        int pos = info.GetBucketPosition(nKey, true, bucket);\r\n        if (vvNew[bucket][pos] == nId) {\r\n            vvNew[bucket][pos] = -1;\r\n            info.nRefCount--;\r\n        }\r\n    }\r\n    nNew--;\r\n```\r\n\r\nI'm not sure whether this is the exact cause of this assert, but it seems like it could at least lead to inconsistencies. That's always a risk when reaching into the internal data structures of a complex class like addrman.",
      "created_at" : "2021-07-15T11:02:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880602891",
      "id" : 880602891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDYwMjg5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T11:02:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880602891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "More crashes:\r\n\r\n```\r\n$ FUZZ=addrman_deserialize ./src/test/fuzz/fuzz ./crash-ef7d4a4f940b8fdb4999f6a92969260cf8e1405f.log \r\nINFO: Running with entropic power schedule (0xFF, 100).\r\nINFO: Seed: 2455641637\r\nINFO: Loaded 1 modules   (228950 inline 8-bit counters): 228950 [0x55bb030060f8, 0x55bb0303df4e), \r\nINFO: Loaded 1 PC tables (228950 PCs): 228950 [0x55bb0303df50,0x55bb033bc4b0), \r\n./src/test/fuzz/fuzz: Running 1 inputs 1 time(s) each.\r\nRunning: ./crash-ef7d4a4f940b8fdb4999f6a92969260cf8e1405f.log\r\nfuzz: addrman.cpp:149: void CAddrMan::SwapRandom(unsigned int, unsigned int): Assertion `nRndPos1 < vRandom.size() && nRndPos2 < vRandom.size()' failed.\r\n==412116== ERROR: libFuzzer: deadly signal\r\n...\r\n    #9 0x55bb026c65f9 in CAddrMan::SwapRandom(unsigned int, unsigned int) addrman.cpp:149:5\r\n    #10 0x55bb026c7758 in CAddrMan::Delete(int) addrman.cpp:173:5\r\n    #11 0x55bb026d1c0b in CAddrMan::ClearNew(int, int) addrman.cpp:192:13\r\n    #12 0x55bb026d1c0b in CAddrMan::ResetI2PPorts() addrman.cpp:819:17\r\n    #13 0x55bb025d122a in void CAddrMan::Unserialize<CDataStream>(CDataStream&) ./addrman.h:455:9\r\n    #14 0x55bb025b068d in void Unserialize<CDataStream, CAddrMan&>(CDataStream&, CAddrMan&) ./serialize.h:676:7\r\n    #15 0x55bb025b068d in CDataStream& CDataStream::operator>><CAddrMan&>(CAddrMan&) ./streams.h:428:9\r\n    #16 0x55bb025b068d in void (anonymous namespace)::DeserializeFromFuzzingInput<CAddrMan>(Span<unsigned char const>, CAddrMan&, std::optional<int>, int) test/fuzz/deserialize.cpp:87:12\r\n    #17 0x55bb025b068d in addrman_deserialize_fuzz_target(Span<unsigned char const>) test/fuzz/deserialize.cpp:201:1\r\n...\r\n```\r\n\r\n\r\n[crash-ef7d4a4f940b8fdb4999f6a92969260cf8e1405f.log](https://github.com/bitcoin/bitcoin/files/6822813/crash-ef7d4a4f940b8fdb4999f6a92969260cf8e1405f.log)\r\n",
      "created_at" : "2021-07-15T11:47:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880629375",
      "id" : 880629375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDYyOTM3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T11:47:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880629375",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is what the fuzzed addrman data produces at the end of `Unserialize()`, before `RemoveInvalid()` and before `ResetI2PPorts()`:\r\n\r\n```\r\nnNew=-1, nTried=5\r\nid=3, addr_info=[::]:0, in tried=1\r\nid=2, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:8192, in tried=1\r\nid=1, addr_info=[::]:229, in tried=1\r\nid=0, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:256, in tried=1\r\nid=-1, addr_info=[::]:8421, in tried=1\r\nvRandom=-1,0,1,2,3,\r\n```\r\n\r\nAfter `RemoveInvalid()`:\r\n\r\n```\r\nnNew=-1, nTried=3\r\nid=2, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:8192, in tried=1\r\nid=0, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:256, in tried=1\r\nid=-1, addr_info=[::]:8421, in tried=1\r\nvRandom=-1,0,2,\r\n```\r\n\r\nAfter `ResetI2PPorts()`:\r\n\r\n```\r\nnNew=0, nTried=2\r\nid=2, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:0, in tried=0\r\nid=0, addr_info=4ucsbzifedsqkihfauqokbja4ucsbzifedsqkihfauqokbja4ucq.b32.i2p:0, in tried=1\r\nid=-1, addr_info=[::]:8421, in tried=1\r\nvRandom=-1,0,2,\r\n```\r\n\r\nLater `Serialize()` chokes on this because there is at least one entry in `mapInfo[]` with `nRefCount > 0` and `nNew` is `0`. The problem originated from the unserialized negative `nNew`. `ResetI2PPorts()` correctly moved one entry from \"tried\" to \"new\" and incremented `nNew` (from `-1` to `0`).\r\n\r\nTODO:\r\n* Why `RemoveInvalid()` did not remove `id=-1, addr_info=[::]:8421, in tried=1`?\r\n* Resolve the problem @jnewbery highlighted above.\r\n* See what is the other crash reported by @MarcoFalke above.\r\n\r\n@jnewbery \r\n> remove any I2P addresses which don't have port 0, and then perhaps add them back through the public (and well-tested) Add() interface\r\n\r\nI considered this approach and ditched it for some reason, but I do not remember why :/ It could have been that deleting an entry has to be done again by fiddling directly with the internal structures and was about as complicated as the current code. Will look at this again.",
      "created_at" : "2021-07-15T12:11:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880643711",
      "id" : 880643711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDY0MzcxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T12:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880643711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why RemoveInvalid() did not remove id=-1, addr_info=[::]:8421, in tried=1?\r\n\r\nMaybe related: https://github.com/bitcoin/bitcoin/pull/22362",
      "created_at" : "2021-07-15T12:18:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-880647967",
      "id" : 880647967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg4MDY0Nzk2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-15T12:18:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/880647967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Just for reference, attaching the fuzzer input to reproduce the problem that is reported in the OP/description of this issue.\r\n\r\n[clusterfuzz-testcase-minimized-addrman_deserialize-5090634410098688.log](https://github.com/bitcoin/bitcoin/files/6830102/clusterfuzz-testcase-minimized-addrman_deserialize-5090634410098688.log)\r\n",
      "created_at" : "2021-07-16T10:44:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/22450#issuecomment-881354785",
      "id" : 881354785,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22450",
      "node_id" : "IC_kwDOABII5840iGgh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-16T10:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/881354785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
