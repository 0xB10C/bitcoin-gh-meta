[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nIs it possible to easily test this functionality? I would like to give it a go.",
      "created_at" : "2021-08-01T03:25:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#issuecomment-890441742",
      "id" : 890441742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22417",
      "node_id" : "IC_kwDOABII5841ExAO",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-01T03:26:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890441742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Should be possible with a long-running process, then looking at `/proc/*pid*/fd` or such.\r\n\r\nIf you want to create a problem, write a program to write to random fd numbers (likely will corrupt things, don't try on an important node). :p",
      "created_at" : "2021-08-01T05:11:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#issuecomment-890452233",
      "id" : 890452233,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22417",
      "node_id" : "IC_kwDOABII5841EzkJ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-01T05:11:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890452233",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is a bit beyond my understanding of processes. I tested (on macOS) that 3b6153ba336b929b06930d81930077f6bb519732 doesn't break HWI integration, so I have no objection.",
      "created_at" : "2021-08-06T16:41:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#issuecomment-894381571",
      "id" : 894381571,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22417",
      "node_id" : "IC_kwDOABII5841Ty4D",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T16:41:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894381571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758492164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758492164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As I understand this code is executed in the child process. What's the advantage of using `fcntl(â¦FD_CLOEXEC` instead of straight-up closing the fd here?",
      "commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "created_at" : "2021-11-29T15:48:25Z",
      "diff_hunk" : "@@ -102,6 +110,32 @@ std::string ShellEscape(const std::string& arg);\n #if HAVE_SYSTEM\n void runCommand(const std::string& strCommand);\n #endif\n+\n+#if defined(BOOST_POSIX_API) && defined(FD_CLOEXEC)\n+/**\n+ * Ensure a boost::process::child has its non-std fds all closed when exec\n+ * is called.\n+ */\n+struct bpe_close_excess_fds : boost::process::extend::handler\n+{\n+    template<typename Executor>\n+    void on_exec_setup(Executor&exec) const\n+    {\n+        try {\n+            for (auto it : fs::directory_iterator(\"/dev/fd\")) {\n+                int64_t fd;\n+                if (!ParseInt64(it.path().filename().native(), &fd)) continue;\n+                if (fd <= 2) continue;  // leave std{in,out,err} alone\n+                ::fcntl(fd, F_SETFD, ::fcntl(fd, F_GETFD) | FD_CLOEXEC);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758492164",
      "id" : 758492164,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII584tNawE",
      "original_commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "original_line" : 129,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/util/system.h",
      "position" : 42,
      "pull_request_review_id" : 817979103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758492164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-29T15:48:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758492164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758493969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758493969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "TIL `/dev/fd` is a general UNIX thing and not limited to Linux. It doesn't seem like a very nice API to iterate open file descriptors but seems portable enough.",
      "commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "created_at" : "2021-11-29T15:50:07Z",
      "diff_hunk" : "@@ -102,6 +110,32 @@ std::string ShellEscape(const std::string& arg);\n #if HAVE_SYSTEM\n void runCommand(const std::string& strCommand);\n #endif\n+\n+#if defined(BOOST_POSIX_API) && defined(FD_CLOEXEC)\n+/**\n+ * Ensure a boost::process::child has its non-std fds all closed when exec\n+ * is called.\n+ */\n+struct bpe_close_excess_fds : boost::process::extend::handler\n+{\n+    template<typename Executor>\n+    void on_exec_setup(Executor&exec) const\n+    {\n+        try {\n+            for (auto it : fs::directory_iterator(\"/dev/fd\")) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758493969",
      "id" : 758493969,
      "line" : 125,
      "node_id" : "PRRC_kwDOABII584tNbMR",
      "original_commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "original_line" : 125,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/util/system.h",
      "position" : 38,
      "pull_request_review_id" : 817981493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758493969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-29T15:50:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758493969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758565651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758565651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Instead of closing directly, we have to set the `FD_CLOEXEC` flag and let `exec` close them; otherwise, boost::process's internal pipe would be closed and we get the wrong exception thrown (not actually a problem outside of our tests, but might as well do this cleanly).",
      "commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "created_at" : "2021-11-29T17:06:26Z",
      "diff_hunk" : "@@ -102,6 +110,32 @@ std::string ShellEscape(const std::string& arg);\n #if HAVE_SYSTEM\n void runCommand(const std::string& strCommand);\n #endif\n+\n+#if defined(BOOST_POSIX_API) && defined(FD_CLOEXEC)\n+/**\n+ * Ensure a boost::process::child has its non-std fds all closed when exec\n+ * is called.\n+ */\n+struct bpe_close_excess_fds : boost::process::extend::handler\n+{\n+    template<typename Executor>\n+    void on_exec_setup(Executor&exec) const\n+    {\n+        try {\n+            for (auto it : fs::directory_iterator(\"/dev/fd\")) {\n+                int64_t fd;\n+                if (!ParseInt64(it.path().filename().native(), &fd)) continue;\n+                if (fd <= 2) continue;  // leave std{in,out,err} alone\n+                ::fcntl(fd, F_SETFD, ::fcntl(fd, F_GETFD) | FD_CLOEXEC);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22417#discussion_r758565651",
      "id" : 758565651,
      "in_reply_to_id" : 758492164,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII584tNssT",
      "original_commit_id" : "3b6153ba336b929b06930d81930077f6bb519732",
      "original_line" : 129,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/util/system.h",
      "position" : 42,
      "pull_request_review_id" : 818077943,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22417",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758565651/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-29T17:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758565651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
