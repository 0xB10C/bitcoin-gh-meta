[
   {
      "body" : "Update: no problems with wallet backup/restore, no problems running with -DDEBUG_LOCKORDER (after fixes unrelated to this pull, see #3704 ).\r\n",
      "created_at" : "2014-02-18T18:19:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-35415468",
      "id" : 35415468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-18T18:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35415468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944602"
         }
      },
      "body" : "Using a recursive IsTrusted call here could run out of stack space if there are a lot of transactions depending on each other in the wallet.\r\nI don't think this is very likely, but when they happen stack overflows are nasty and hard to debug.\r\nIt was avoided with the workqueue-based approach.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-21T13:10:49Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944602",
      "id" : 9944602,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944666"
         }
      },
      "body" : "Could move this to a local variable inside serialize() instead of a property.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-21T13:13:40Z",
      "diff_hunk" : "@@ -439,7 +446,7 @@ class CWalletTx : public CMerkleTx\n     const CWallet* pwallet;\n \n public:\n-    std::vector<CMerkleTx> vtxPrev;\n+    std::vector<CMerkleTx> vUnused;// Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944666",
      "id" : 9944666,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 51,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944931"
         }
      },
      "body" : "Long chains of unconfirmed transactions are a very bad idea; I'd vote for limiting the depth of the recursion to something reasonable.  I am very tempted to limit it to a depth of one, and eliminate the recursion all-together.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-21T13:25:16Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9944931",
      "id" : 9944931,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9944931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9947008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9947008"
         }
      },
      "body" : "Nit: I can't help but notice that all calls to pwallet->IsSpent (apart from the one in the UI) construct a COutPoint object specifically to pass to the function. Maybe IsSpent(const uint256&, int n) would be more convenient.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-21T14:38:48Z",
      "diff_hunk" : "@@ -671,7 +622,7 @@ class CWalletTx : public CMerkleTx\n         int64_t nCredit = 0;\n         for (unsigned int i = 0; i < vout.size(); i++)\n         {\n-            if (!IsSpent(i))\n+            if (!pwallet->IsSpent(COutPoint(GetHash(), i)))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9947008",
      "id" : 9947008,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 187,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9947008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9948496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9948496"
         }
      },
      "body" : "The -walletnotify and UI notification dispatch for the transaction update happens in AddToWallet. Ideally we'd want to do this invalidation before the notification is launched to prevent races.\r\nOne idea would be to move this logic here: https://github.com/bitcoin/bitcoin/blob/master/src/wallet.cpp#L566 where previously the WalletUpdateSpent happened? (execution will get there anyway through AddToWalletIfInvolvingme as fExisted will be true as well as fUpdate)",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-21T15:21:19Z",
      "diff_hunk" : "@@ -598,14 +597,27 @@ bool CWallet::AddToWalletIfInvolvingMe(const uint256 &hash, const CTransaction&\n                 wtx.SetMerkleBranch(pblock);\n             return AddToWallet(wtx);\n         }\n-        else\n-            WalletUpdateSpent(tx);\n     }\n     return false;\n }\n \n-void CWallet::SyncTransaction(const uint256 &hash, const CTransaction& tx, const CBlock* pblock) {\n+void CWallet::SyncTransaction(const uint256 &hash, const CTransaction& tx, const CBlock* pblock)\n+{\n     AddToWalletIfInvolvingMe(hash, tx, pblock, true);\n+\n+    if (mapWallet.count(hash) == 0)\n+        return; // Not one of ours\n+\n+    // Break debit/credit balance caches:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9948496",
      "id" : 9948496,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 208,
      "path" : "src/wallet.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9948496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991690"
         }
      },
      "body" : "A valid case in which long chains of unconfirmed transaction could happen is in case of a reorganize.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:08:13Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991690",
      "id" : 9991690,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991782"
         }
      },
      "body" : "I just realized that vtxPrev could be useful for re-broadcasting (others) parent transactions in the case of a reorganization. Or is this covered some other way? Right now we store only our own transactions in the wallet.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:10:53Z",
      "diff_hunk" : "@@ -439,7 +446,7 @@ class CWalletTx : public CMerkleTx\n     const CWallet* pwallet;\n \n public:\n-    std::vector<CMerkleTx> vtxPrev;\n+    std::vector<CMerkleTx> vUnused;// Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991782",
      "id" : 9991782,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 51,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991812"
         }
      },
      "body" : "Yes, but IsTrusted() is mostly irrelevant during a re-organize.  I suppose if there is a deep re-org underway and you try to spend some coins in the middle of it the spend might fail with \"insufficient funds\".  Very much an edge case not worth worrying about, though, I think.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:11:40Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991812",
      "id" : 9991812,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991964"
         }
      },
      "body" : "Agree. I do believe the C++ compiler avoids the extra copying involved, though.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:16:41Z",
      "diff_hunk" : "@@ -671,7 +622,7 @@ class CWalletTx : public CMerkleTx\n         int64_t nCredit = 0;\n         for (unsigned int i = 0; i < vout.size(); i++)\n         {\n-            if (!IsSpent(i))\n+            if (!pwallet->IsSpent(COutPoint(GetHash(), i)))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9991964",
      "id" : 9991964,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 187,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9991964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992099"
         }
      },
      "body" : "Right, that's not much of a problem.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:20:35Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992099",
      "id" : 9992099,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992382"
         }
      },
      "body" : "Even now, vtxPrev only stores our own transactions, so it is utterly pointless to keep it.\r\n\r\nThe correct solution - if we want to deal better with unconfirmed out-of-wallet dependencies - is to add these to the wallet directly instead of inside the transactions they depend on. In practice, these lead to huge duplication of transactions in large wallets.\r\n\r\n@pstratem has some more context, I believe.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:29:04Z",
      "diff_hunk" : "@@ -439,7 +446,7 @@ class CWalletTx : public CMerkleTx\n     const CWallet* pwallet;\n \n public:\n-    std::vector<CMerkleTx> vtxPrev;\n+    std::vector<CMerkleTx> vUnused;// Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992382",
      "id" : 9992382,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 51,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992440"
         }
      },
      "body" : "There is no need for this recursion at all. If a transaction is either in the blockchain or in the memory pool, all its dependencies are also in the blockchain or the memory pool.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:30:33Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992440",
      "id" : 9992440,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992782"
         }
      },
      "body" : "I'm in favor of moving this variable to inside the serialization implementations. It will save memory.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:41:02Z",
      "diff_hunk" : "@@ -439,7 +446,7 @@ class CWalletTx : public CMerkleTx\n     const CWallet* pwallet;\n \n public:\n-    std::vector<CMerkleTx> vtxPrev;\n+    std::vector<CMerkleTx> vUnused;// Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992782",
      "id" : 9992782,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 51,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992805"
         }
      },
      "body" : "OK, agreed, vtxprev is not the way to do this. Storing transactions in the wallet only on the top level (and not nested into other transactions) makes sense.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T14:41:42Z",
      "diff_hunk" : "@@ -439,7 +446,7 @@ class CWalletTx : public CMerkleTx\n     const CWallet* pwallet;\n \n public:\n-    std::vector<CMerkleTx> vtxPrev;\n+    std::vector<CMerkleTx> vUnused;// Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9992805",
      "id" : 9992805,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 51,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9992805",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9994253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9994253"
         }
      },
      "body" : "Recursion here is necessary if we want to continue allowing spending of unconfirmed change of unconfirmed change (of unconfirmed change, etc).  If there is no recursion, then you will be allowed to spend unconfirmed change once, but will then have to wait for that transaction to confirm (if you have no other inputs in your wallet) before being allowed to spend again.\r\n\r\nRE: other nits: ACK.\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T15:14:06Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9994253",
      "id" : 9994253,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9994253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9996511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9996511"
         }
      },
      "body" : "Eh no - you have to check the inputs whether they belong to you. But unconfirmed change of unconfirmed change is in the mempool, and you don't need to check whether its dependencies do - it being in the mempool guarantees that already.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T16:03:28Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r9996511",
      "id" : 9996511,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/9996511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10002197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10002197"
         }
      },
      "body" : "@sipa: ACK.  Replacing the recursion with:\r\n\r\n```\r\n-            if (parent == NULL || !parent->IsTrusted())\r\n+            if (parent == NULL || !parent->IsFromMe() || parent->GetDepthInMainChain() < 0)\r\n                return false;\r\n```\r\n",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T18:16:38Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are trusted (recursively)\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not from us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsTrusted())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10002197",
      "id" : 10002197,
      "original_commit_id" : "1fa606d93ad347def5c28bf4332da3fd3f391cd3",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10002197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Nits picked, rebased.\r\n",
      "created_at" : "2014-02-24T18:27:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-35918154",
      "id" : 35918154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-24T18:27:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35918154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10007400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10007400"
         }
      },
      "body" : "Even that < 0 test isn't necessary: if this transaction is in the mempool or blockchain, all its parents are too.\r\n\r\nWe only need to check that all inputs are from us.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T20:05:20Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are from us and are in the mempool:\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not sent by us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsFromMe() || parent->GetDepthInMainChain() < 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10007400",
      "id" : 10007400,
      "original_commit_id" : "88ee2e5e7fcb091fb176189c1d226c3b1b80914e",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10007400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10007581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10007581"
         }
      },
      "body" : "Indentation.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T20:08:31Z",
      "diff_hunk" : "@@ -534,7 +528,8 @@ class CWalletTx : public CMerkleTx\n         }\n \n         nSerSize += SerReadWrite(s, *(CMerkleTx*)this, nType, nVersion,ser_action);\n-        READWRITE(vtxPrev);\n+\tstd::vector<CMerkleTx> vUnused; // Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10007581",
      "id" : 10007581,
      "original_commit_id" : "88ee2e5e7fcb091fb176189c1d226c3b1b80914e",
      "original_position" : 99,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10007581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10008943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10008943"
         }
      },
      "body" : "Fixed (emacs settings were wrong on my new computer....)",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T20:36:17Z",
      "diff_hunk" : "@@ -534,7 +528,8 @@ class CWalletTx : public CMerkleTx\n         }\n \n         nSerSize += SerReadWrite(s, *(CMerkleTx*)this, nType, nVersion,ser_action);\n-        READWRITE(vtxPrev);\n+\tstd::vector<CMerkleTx> vUnused; // Used to be vtxPrev",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10008943",
      "id" : 10008943,
      "original_commit_id" : "88ee2e5e7fcb091fb176189c1d226c3b1b80914e",
      "original_position" : 99,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10008943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10009709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10009709"
         }
      },
      "body" : "Indeed. Maybe if reporters would stop calling me I'd stop making dumb mistakes...",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-24T20:53:55Z",
      "diff_hunk" : "@@ -719,38 +670,13 @@ class CWalletTx : public CMerkleTx\n         if (!bSpendZeroConfChange || !IsFromMe()) // using wtx's cached debit\n             return false;\n \n-        // If no confirmations but it's from us, we can still\n-        // consider it confirmed if all dependencies are confirmed\n-        std::map<uint256, const CMerkleTx*> mapPrev;\n-        std::vector<const CMerkleTx*> vWorkQueue;\n-        vWorkQueue.reserve(vtxPrev.size()+1);\n-        vWorkQueue.push_back(this);\n-        for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n+        // Trusted if all inputs are from us and are in the mempool:\n+        BOOST_FOREACH(const CTxIn& txin, vin)\n         {\n-            const CMerkleTx* ptx = vWorkQueue[i];\n-\n-            if (!IsFinalTx(*ptx))\n+            // Transactions not sent by us: not trusted\n+            const CWalletTx* parent = pwallet->GetWalletTx(txin.prevout.hash);\n+            if (parent == NULL || !parent->IsFromMe() || parent->GetDepthInMainChain() < 0)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10009709",
      "id" : 10009709,
      "original_commit_id" : "88ee2e5e7fcb091fb176189c1d226c3b1b80914e",
      "original_position" : 210,
      "path" : "src/wallet.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10009709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : ".... I'll fix the pull-tester ... just have to figure out a robust way of HOW ... \r\n(issue is bitcoind's still running from previous failed test; ideally tests would be run in a fresh VM so they cannot interfere with each other).",
      "created_at" : "2014-02-25T00:09:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-35959592",
      "id" : 35959592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-25T00:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35959592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10053931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10053931"
         }
      },
      "body" : "Can you pass this list<CTransaction> by reference into the method, and append to it everywhere, rather than copying it in every recursion step?",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-25T20:21:42Z",
      "diff_hunk" : "@@ -86,43 +86,51 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry)\n }\n \n \n-bool CTxMemPool::remove(const CTransaction &tx, bool fRecursive)\n+list<CTransaction> CTxMemPool::remove(const CTransaction &tx, bool fRecursive)\n {\n     // Remove transaction from memory pool\n+    list<CTransaction> result;\n     {\n         LOCK(cs);\n         uint256 hash = tx.GetHash();\n         if (fRecursive) {\n             for (unsigned int i = 0; i < tx.vout.size(); i++) {\n                 std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(COutPoint(hash, i));\n-                if (it != mapNextTx.end())\n-                    remove(*it->second.ptx, true);\n+                if (it == mapNextTx.end())\n+                    continue;\n+                list<CTransaction> r = remove(*it->second.ptx, true);\n+                result.insert(result.begin(), r.begin(), r.end());\n             }\n         }\n         if (mapTx.count(hash))\n         {\n+            result.push_front(tx);\n             BOOST_FOREACH(const CTxIn& txin, tx.vin)\n                 mapNextTx.erase(txin.prevout);\n             mapTx.erase(hash);\n             nTransactionsUpdated++;\n         }\n     }\n-    return true;\n+    return result;\n }\n \n-bool CTxMemPool::removeConflicts(const CTransaction &tx)\n+list<CTransaction> CTxMemPool::removeConflicts(const CTransaction &tx)\n {\n     // Remove transactions which depend on inputs of tx, recursively\n+    list<CTransaction> result;\n     LOCK(cs);\n     BOOST_FOREACH(const CTxIn &txin, tx.vin) {\n         std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(txin.prevout);\n         if (it != mapNextTx.end()) {\n             const CTransaction &txConflict = *it->second.ptx;\n             if (txConflict != tx)\n-                remove(txConflict, true);\n+            {\n+                list<CTransaction> r = remove(txConflict, true);\n+                result.insert(result.begin(), r.begin(), r.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10053931",
      "id" : 10053931,
      "original_commit_id" : "0c39205dcd42c34fffefdfb2a5aff36991033140",
      "original_position" : 50,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10053931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10083308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10083308"
         }
      },
      "body" : "ACK, I'll rewrite to pass the list by reference.",
      "commit_id" : "93a18a3650292afbb441a47d1fa1b94aeb0164e3",
      "created_at" : "2014-02-26T15:23:13Z",
      "diff_hunk" : "@@ -86,43 +86,51 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry)\n }\n \n \n-bool CTxMemPool::remove(const CTransaction &tx, bool fRecursive)\n+list<CTransaction> CTxMemPool::remove(const CTransaction &tx, bool fRecursive)\n {\n     // Remove transaction from memory pool\n+    list<CTransaction> result;\n     {\n         LOCK(cs);\n         uint256 hash = tx.GetHash();\n         if (fRecursive) {\n             for (unsigned int i = 0; i < tx.vout.size(); i++) {\n                 std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(COutPoint(hash, i));\n-                if (it != mapNextTx.end())\n-                    remove(*it->second.ptx, true);\n+                if (it == mapNextTx.end())\n+                    continue;\n+                list<CTransaction> r = remove(*it->second.ptx, true);\n+                result.insert(result.begin(), r.begin(), r.end());\n             }\n         }\n         if (mapTx.count(hash))\n         {\n+            result.push_front(tx);\n             BOOST_FOREACH(const CTxIn& txin, tx.vin)\n                 mapNextTx.erase(txin.prevout);\n             mapTx.erase(hash);\n             nTransactionsUpdated++;\n         }\n     }\n-    return true;\n+    return result;\n }\n \n-bool CTxMemPool::removeConflicts(const CTransaction &tx)\n+list<CTransaction> CTxMemPool::removeConflicts(const CTransaction &tx)\n {\n     // Remove transactions which depend on inputs of tx, recursively\n+    list<CTransaction> result;\n     LOCK(cs);\n     BOOST_FOREACH(const CTxIn &txin, tx.vin) {\n         std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(txin.prevout);\n         if (it != mapNextTx.end()) {\n             const CTransaction &txConflict = *it->second.ptx;\n             if (txConflict != tx)\n-                remove(txConflict, true);\n+            {\n+                list<CTransaction> r = remove(txConflict, true);\n+                result.insert(result.begin(), r.begin(), r.end());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#discussion_r10083308",
      "id" : 10083308,
      "original_commit_id" : "0c39205dcd42c34fffefdfb2a5aff36991033140",
      "original_position" : 50,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/3694",
      "updated_at" : "2014-02-26T16:54:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/10083308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/93a18a3650292afbb441a47d1fa1b94aeb0164e3 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-02-26T17:32:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-36152068",
      "id" : 36152068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-26T17:32:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36152068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "I have a reasonably biggish wallet (~7.5K transactions). What is a good performance test for this (what would exercise the right code paths)?\r\n\r\nThe listaccounts rpc is consistently 40ms faster on my wallet with this branch =)\r\n\r\n",
      "created_at" : "2014-02-26T20:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-36173735",
      "id" : 36173735,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-26T20:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36173735",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   },
   {
      "body" : "Merging; I think this is good enough for a release candidate release.\r\n",
      "created_at" : "2014-02-28T20:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3694#issuecomment-36390045",
      "id" : 36390045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3694",
      "updated_at" : "2014-02-28T20:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/36390045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   }
]
