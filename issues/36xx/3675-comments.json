[
   {
      "body" : "This is completely insufficient.  You must update dependencies... conditionally.  And there are several edge cases even so.  As implemented here, it works for some people and some situations, but leaves the wallet in a worse state otherwise.\r\n\r\n",
      "created_at" : "2014-02-15T05:02:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35147581",
      "id" : 35147581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-15T05:02:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35147581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Right ok, this is why \"-zapwallettxes\" only runs at startup before the wallet is loaded.\r\n\r\nBy dependencies I guess you mean the other modules that rely on the walletdb state?",
      "created_at" : "2014-02-15T05:12:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35147779",
      "id" : 35147779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-15T05:12:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35147779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   },
   {
      "body" : "@djpnewton You'd have to update vfSpent for the appropriate outputs of parent transactions, but only if there isn't another transaction spending that output. \r\n\r\nAlso if you zap a transaction that has dependents, you need to zap those as well. And zapping those transactions, in turn, may trigger vfSpent updates in other transactions.\r\n\r\nIf you want to do this at runtime there is also other cached state that will need to be updated.\r\n\r\nAlso if you do this low-level you want to keep an inactive copy of the zapped transaction around for forensic purposes.\r\n\r\nAll in all ... it's very complex. The proposal is to get rid of vfSpent which would make this (among other things) easier. But that is quite involved (and error prone) in itself. That's why we went with the sledgehammer approach for now.\r\n",
      "created_at" : "2014-02-15T07:40:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35149652",
      "id" : 35149652,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-15T07:40:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35149652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@jgarzik  @laanwj Thanks for the comments.\r\n\r\nWill a rescan update the vfSpent values if one were to zap a single transaction?\r\n\r\nIf so would it be feasible to zap a single transaction (and its dependents) at startup and rescan? ",
      "created_at" : "2014-02-15T08:17:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35150117",
      "id" : 35150117,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-15T08:17:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35150117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   },
   {
      "body" : "IIRC a rescan will not touch existing transactions at all. It just adds transactions that were missing.\r\n(Though it may update vfSpent when new transactions appear that spend old outputs. It will never do the opposite and helpfully clear vfSpent. MarkSpent is a one-way street)",
      "created_at" : "2014-02-15T09:51:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35151852",
      "id" : 35151852,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-15T09:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35151852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "OK I have a (probably still naive) implementation that kills child transactions and updates parent tx spent outputs. If the function is performed at runtime the some of the results do not show up until a restart.. some cache needs to be cleared.",
      "created_at" : "2014-02-16T12:24:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35195461",
      "id" : 35195461,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-16T12:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35195461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   },
   {
      "body" : "Rescan will not fix vfSpent. It can only find missing transactions, and if necessary update the block they were in.\r\n\r\nThe solution is getting rid of vfSpent :)",
      "created_at" : "2014-02-16T13:48:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35197057",
      "id" : 35197057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-16T13:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35197057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Even without vfSpent update it would be useful to be able to remove non-confirming transactions from others (like 1Enjoy 1Sochi spam). Though -zapwallettxes could be used for that too.",
      "created_at" : "2014-02-17T09:43:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35241718",
      "id" : 35241718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-17T11:18:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35241718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "See #3694 RE: removing vfSpent-- review/testing there would be very appreciated.\r\n\r\nA regression test or two in qa/rpc-tests (see the tests in #3694 for examples) that demonstrates zap-a-single-wallet-transaction working properly in various tricky scenarios would make me much more likely to give an ACK.\r\n",
      "created_at" : "2014-02-17T17:14:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35303782",
      "id" : 35303782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-17T17:14:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35303782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   },
   {
      "body" : "@gavinandresen I have now based it on your vfSpent work, cheers",
      "created_at" : "2014-02-19T10:32:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35485114",
      "id" : 35485114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-19T10:32:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35485114",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/5717503f0558dfb947ff985875d55e9ffbf00410 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2014-02-23T09:57:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-35827973",
      "id" : 35827973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-02-23T09:57:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/35827973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "As the list of commits looks pretty messed up now, I suggest drastic recovery steps like:\r\n\r\n    FEATURE_BRANCH='zapwallettx-single'\r\n    NEW_FEATURE_BRANCH='zapwallettx-single-rebased'\r\n    MERGE_BASE=1fa606d\r\n    PATCH_FILE=zapwallettx.diff\r\n    # Make diff file\r\n    git diff $MERGE_BASE $FEATURE_BRANCH > $PATCH_FILE\r\n    # Create a new branch from master\r\n    git checkout master\r\n    git checkout -b $NEW_FEATURE_BRANCH\r\n    # Apply diff\r\n    patch -p1 --merge < $PATCH_FILE\r\n    # Check and test and fix up if there are errors (it compiled at least)\r\n    ...\r\n    # Make one commit with all the changes\r\n    git add qa/rpc-tests/zapwallettx.sh # re-add new file\r\n    git commit -av\r\n    # Push new branch to github\r\n    git push origin $NEW_FEATURE_BRANCH\r\n\r\n",
      "created_at" : "2014-03-07T09:56:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-37010121",
      "id" : 37010121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-03-07T09:59:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/37010121",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj  thanks, I have created a new PR #3845 ",
      "created_at" : "2014-03-11T10:10:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/3675#issuecomment-37279985",
      "id" : 37279985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/3675",
      "updated_at" : "2014-03-11T10:10:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/37279985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/42459?v=3",
         "events_url" : "https://api.github.com/users/djpnewton/events{/privacy}",
         "followers_url" : "https://api.github.com/users/djpnewton/followers",
         "following_url" : "https://api.github.com/users/djpnewton/following{/other_user}",
         "gists_url" : "https://api.github.com/users/djpnewton/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/djpnewton",
         "id" : 42459,
         "login" : "djpnewton",
         "organizations_url" : "https://api.github.com/users/djpnewton/orgs",
         "received_events_url" : "https://api.github.com/users/djpnewton/received_events",
         "repos_url" : "https://api.github.com/users/djpnewton/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/djpnewton/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/djpnewton"
      }
   }
]
