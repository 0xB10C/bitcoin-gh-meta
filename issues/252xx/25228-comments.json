[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885064314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885064314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if this is me being pedantic, but I don't think we're really testing \"default mempool parameters\" if we're configuring the node to `acceptnonstdtxn`. Is there a good reason we need to set this?",
      "commit_id" : "9b825e7eab9e0e642e5014d5c2d94a119037b156",
      "created_at" : "2022-05-30T20:20:34Z",
      "diff_hunk" : "@@ -42,6 +42,10 @@ def set_test_params(self):\n                 \"-limitdescendantcount=200\",\n                 \"-limitdescendantsize=101\",\n             ],\n+            # second node has default mempool parameters\n+            [\n+                \"-acceptnonstdtxn=1\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885064314",
      "id" : 885064314,
      "line" : 47,
      "node_id" : "PRRC_kwDOABII5840wQJ6",
      "original_commit_id" : "9b825e7eab9e0e642e5014d5c2d94a119037b156",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/feature_rbf.py",
      "position" : 15,
      "pull_request_review_id" : 989663536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885064314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-30T20:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885064314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885215565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885215565"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the only reason this needs to accept nonstd txs is because there's some left over txs in node 0's mempool from earlier tests, which results in syncing mempools failing when you try to mine a block with node 1. Doing:\r\n\r\n```diff\r\n+        #clear the mempools\r\n+        self.generate(self.nodes[0], 1)\r\n+\r\n         normal_node = self.nodes[1]\r\n         wallet = MiniWallet(normal_node)\r\n         wallet.rescan_utxos()            \r\n```\r\n\r\nLooks to me like it lets you drop the `-acceptnonstdtxn=1`.",
      "commit_id" : "9b825e7eab9e0e642e5014d5c2d94a119037b156",
      "created_at" : "2022-05-31T05:29:04Z",
      "diff_hunk" : "@@ -42,6 +42,10 @@ def set_test_params(self):\n                 \"-limitdescendantcount=200\",\n                 \"-limitdescendantsize=101\",\n             ],\n+            # second node has default mempool parameters\n+            [\n+                \"-acceptnonstdtxn=1\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885215565",
      "id" : 885215565,
      "in_reply_to_id" : 885064314,
      "line" : 47,
      "node_id" : "PRRC_kwDOABII5840w1FN",
      "original_commit_id" : "9b825e7eab9e0e642e5014d5c2d94a119037b156",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/feature_rbf.py",
      "position" : 15,
      "pull_request_review_id" : 989854825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885215565/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-31T05:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885215565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2022-05-31T10:36:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#issuecomment-1141964437",
      "id" : 1141964437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25228",
      "node_id" : "IC_kwDOABII585EEP6V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1141964437/reactions"
      },
      "updated_at" : "2022-05-31T10:36:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1141964437",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885618200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885618200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good call @glozow @ajtowns, willfix.",
      "commit_id" : "fd564f3460e5c90a84ae64d64070ec3f0f15f5e2",
      "created_at" : "2022-05-31T13:10:24Z",
      "diff_hunk" : "@@ -42,6 +42,10 @@ def set_test_params(self):\n                 \"-limitdescendantcount=200\",\n                 \"-limitdescendantsize=101\",\n             ],\n+            # second node has default mempool parameters\n+            [\n+                \"-acceptnonstdtxn=1\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r885618200",
      "id" : 885618200,
      "in_reply_to_id" : 885064314,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5840yXYY",
      "original_commit_id" : "9b825e7eab9e0e642e5014d5c2d94a119037b156",
      "original_line" : 47,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/feature_rbf.py",
      "position" : null,
      "pull_request_review_id" : 990420371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885618200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-31T13:10:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/885618200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-06-01T07:06:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#issuecomment-1143197061",
      "id" : 1143197061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25228",
      "node_id" : "IC_kwDOABII585EI82F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1143197061/reactions"
      },
      "updated_at" : "2022-06-01T07:06:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1143197061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3072149?v=4",
         "events_url" : "https://api.github.com/users/dunxen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dunxen/followers",
         "following_url" : "https://api.github.com/users/dunxen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dunxen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dunxen",
         "id" : 3072149,
         "login" : "dunxen",
         "node_id" : "MDQ6VXNlcjMwNzIxNDk=",
         "organizations_url" : "https://api.github.com/users/dunxen/orgs",
         "received_events_url" : "https://api.github.com/users/dunxen/received_events",
         "repos_url" : "https://api.github.com/users/dunxen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dunxen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dunxen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dunxen"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r887153076"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887153076"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "small nit: you can avoid setting the sequence number here (the default works as well, `double_tx` doesn't need to be replaced), but if you want to leave it like that it's fine :) ",
      "commit_id" : "fd564f3460e5c90a84ae64d64070ec3f0f15f5e2",
      "created_at" : "2022-06-01T18:02:49Z",
      "diff_hunk" : "@@ -397,6 +403,95 @@ def test_too_many_replacements(self):\n         double_tx_hex = double_tx.serialize().hex()\n         self.nodes[0].sendrawtransaction(double_tx_hex, 0)\n \n+    def test_too_many_replacements_with_default_mempool_params(self):\n+        \"\"\"\n+        Test rule 5 of BIP125 (do not allow replacements that cause more than 100\n+        evictions) without having to rely on non-default mempool parameters.\n+\n+        In order to do this, create a number of \"root\" UTXOs, and then hang\n+        enough transactions off of each root UTXO to exceed the MAX_REPLACEMENT_LIMIT.\n+        Then create a conflicting RBF replacement transaction.\n+        \"\"\"\n+        normal_node = self.nodes[1]\n+        wallet = MiniWallet(normal_node)\n+        wallet.rescan_utxos()\n+        # Clear mempools to avoid cross-node sync failure.\n+        for node in self.nodes:\n+            self.generate(node, 1)\n+\n+        # This has to be chosen so that the total number of transactions can exceed\n+        # MAX_REPLACEMENT_LIMIT without having any one tx graph run into the descendant\n+        # limit; 10 works.\n+        num_tx_graphs = 10\n+\n+        # (Number of transactions per graph, BIP125 rule 5 failure expected)\n+        cases = [\n+            # Test the base case of evicting fewer than MAX_REPLACEMENT_LIMIT\n+            # transactions.\n+            ((MAX_REPLACEMENT_LIMIT // num_tx_graphs) - 1, False),\n+\n+            # Test hitting the rule 5 eviction limit.\n+            (MAX_REPLACEMENT_LIMIT // num_tx_graphs, True),\n+        ]\n+\n+        for (txs_per_graph, failure_expected) in cases:\n+            self.log.debug(f\"txs_per_graph: {txs_per_graph}, failure: {failure_expected}\")\n+            # \"Root\" utxos of each txn graph that we will attempt to double-spend with\n+            # an RBF replacement.\n+            root_utxos = []\n+\n+            # For each root UTXO, create a package that contains the spend of that\n+            # UTXO and `txs_per_graph` children tx.\n+            for graph_num in range(num_tx_graphs):\n+                root_utxos.append(wallet.get_utxo())\n+\n+                optin_parent_tx = wallet.send_self_transfer_multi(\n+                    from_node=normal_node,\n+                    sequence=BIP125_SEQUENCE_NUMBER,\n+                    utxos_to_spend=[root_utxos[graph_num]],\n+                    num_outputs=txs_per_graph,\n+                )\n+                assert_equal(True, normal_node.getmempoolentry(optin_parent_tx['txid'])['bip125-replaceable'])\n+                new_utxos = optin_parent_tx['new_utxos']\n+\n+                for utxo in new_utxos:\n+                    # Create spends for each output from the \"root\" of this graph.\n+                    child_tx = wallet.send_self_transfer(\n+                        from_node=normal_node,\n+                        utxo_to_spend=utxo,\n+                    )\n+\n+                    assert normal_node.getmempoolentry(child_tx['txid'])\n+\n+            num_txs_invalidated = len(root_utxos) + (num_tx_graphs * txs_per_graph)\n+\n+            if failure_expected:\n+                assert num_txs_invalidated > MAX_REPLACEMENT_LIMIT\n+            else:\n+                assert num_txs_invalidated <= MAX_REPLACEMENT_LIMIT\n+\n+            # Now attempt to submit a tx that double-spends all the root tx inputs, which\n+            # would invalidate `num_txs_invalidated` transactions.\n+            double_tx = wallet.create_self_transfer_multi(\n+                from_node=normal_node,\n+                sequence=BIP125_SEQUENCE_NUMBER,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25228#discussion_r887153076",
      "id" : 887153076,
      "line" : 477,
      "node_id" : "PRRC_kwDOABII58404OG0",
      "original_commit_id" : "fd564f3460e5c90a84ae64d64070ec3f0f15f5e2",
      "original_line" : 477,
      "original_position" : 104,
      "original_start_line" : null,
      "path" : "test/functional/feature_rbf.py",
      "position" : 104,
      "pull_request_review_id" : 992474347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25228",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887153076/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-01T18:07:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/887153076",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25042473?v=4",
         "events_url" : "https://api.github.com/users/danielabrozzoni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/danielabrozzoni/followers",
         "following_url" : "https://api.github.com/users/danielabrozzoni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/danielabrozzoni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/danielabrozzoni",
         "id" : 25042473,
         "login" : "danielabrozzoni",
         "node_id" : "MDQ6VXNlcjI1MDQyNDcz",
         "organizations_url" : "https://api.github.com/users/danielabrozzoni/orgs",
         "received_events_url" : "https://api.github.com/users/danielabrozzoni/received_events",
         "repos_url" : "https://api.github.com/users/danielabrozzoni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/danielabrozzoni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/danielabrozzoni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/danielabrozzoni"
      }
   }
]
