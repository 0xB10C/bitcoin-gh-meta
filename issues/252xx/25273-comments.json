[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24897](https://github.com/bitcoin/bitcoin/pull/24897) ([Draft / POC] Silent Payments by w0xlt)\n* [#24128](https://github.com/bitcoin/bitcoin/pull/24128) (wallet: BIP 326 sequence based anti-fee-snipe for taproot inputs by MarcoFalke)\n* [#23475](https://github.com/bitcoin/bitcoin/pull/23475) (wallet: add config to prioritize a solution that doesn't create change in coin selection by brunoerg)\n* [#21283](https://github.com/bitcoin/bitcoin/pull/21283) (Implement BIP 370 PSBTv2 by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-04T00:47:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1146481423",
      "id" : 1146481423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585EVesP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1146481423/reactions"
      },
      "updated_at" : "2022-06-17T06:04:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1146481423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-16T19:42:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1158065891",
      "id" : 1158065891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585FBq7j",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158065891/reactions"
      },
      "updated_at" : "2022-06-16T19:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1158065891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900971740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since this can never return a nullopt (errors throw), maybe just return `CreatedTransactionResult`?",
      "commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "created_at" : "2022-06-18T15:43:42Z",
      "diff_hunk" : "@@ -488,13 +487,13 @@ static std::vector<RPCArg> FundTxDoc(bool solving_data = true)\n     return args;\n }\n \n-void FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& fee_out, int& change_position, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)\n+std::optional<CreatedTransactionResult> FundTransaction(CWallet& wallet, const CMutableTransaction& tx, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900971740",
      "id" : 900971740,
      "line" : 490,
      "node_id" : "PRRC_kwDOABII5841s7zc",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 490,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/spend.cpp",
      "position" : 17,
      "pull_request_review_id" : 1011430105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-18T15:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">Lastly, instead of using -1 as a magic number for the change output position, the change position is changed to be an optional with no value set indicating no desired change output position (when provided as an input parameter) or no change output present (in the result).\r\n\r\nI'm not sure this is an improvement. It just adds complexity, for no benefit in this particular instance?",
      "created_at" : "2022-06-18T15:48:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1159486874",
      "id" : 1159486874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585FHF2a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159486874/reactions"
      },
      "updated_at" : "2022-06-18T15:48:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159486874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900979687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would be better to return the `PreselectedInput` and have the caller use `SetSequence` etc directly.",
      "commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "created_at" : "2022-06-18T15:55:02Z",
      "diff_hunk" : "@@ -61,82 +128,153 @@ class CCoinControl\n     int m_max_depth = DEFAULT_MAX_DEPTH;\n     //! SigningProvider that has pubkeys and scripts to do spend size estimation for external inputs\n     FlatSigningProvider m_external_provider;\n+    //! Locktime\n+    std::optional<uint32_t> m_locktime;\n+    //! Version\n+    std::optional<uint32_t> m_version;\n \n     CCoinControl();\n \n     bool HasSelected() const\n     {\n-        return (setSelected.size() > 0);\n+        return (m_selected.size() > 0);\n     }\n \n     bool IsSelected(const COutPoint& output) const\n     {\n-        return (setSelected.count(output) > 0);\n+        return (m_selected.count(output) > 0);\n     }\n \n     bool IsExternalSelected(const COutPoint& output) const\n     {\n-        return (m_external_txouts.count(output) > 0);\n+        const auto it = m_selected.find(output);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasTxOut();\n     }\n \n     bool GetExternalOutput(const COutPoint& outpoint, CTxOut& txout) const\n     {\n-        const auto ext_it = m_external_txouts.find(outpoint);\n-        if (ext_it == m_external_txouts.end()) {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        if (!it->second.HasTxOut()) {\n             return false;\n         }\n-        txout = ext_it->second;\n+        txout = it->second.GetTxOut();\n         return true;\n     }\n \n-    void Select(const COutPoint& output)\n+    void Select(const COutPoint& output, std::optional<uint32_t> sequence = std::nullopt, std::optional<CScript> script_sig = std::nullopt, std::optional<CScriptWitness> script_witness = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900979687",
      "id" : 900979687,
      "line" : 170,
      "node_id" : "PRRC_kwDOABII5841s9vn",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 170,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/wallet/coincontrol.h",
      "position" : 124,
      "pull_request_review_id" : 1011430920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-18T15:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900983932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not? As long as one input has a non-final sequence, it should still work.\r\n\r\n(`DiscourageFeeSniping` would need its sanity checks adjusted to tolerate it, though)",
      "commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "created_at" : "2022-06-18T16:00:58Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900983932",
      "id" : 900983932,
      "line" : 854,
      "node_id" : "PRRC_kwDOABII5841s-x8",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 854,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 75,
      "pull_request_review_id" : 1011431317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-18T16:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\nSUMMARY: MemorySanitizer: use-of-uninitialized-value src/wallet/spend.cpp:1025:5 in wallet::CreateTransaction(wallet::CWallet&, std::__1::vector<wallet::CRecipient, std::__1::allocator<wallet::CRecipient> > const&, std::__1::optional<unsigned int>, bilingual_str&, wallet::CCoinControl const&, FeeCalculation&, bool)",
      "created_at" : "2022-06-18T16:14:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1159490903",
      "id" : 1159490903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585FHG1X",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159490903/reactions"
      },
      "updated_at" : "2022-06-18T16:14:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159490903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
