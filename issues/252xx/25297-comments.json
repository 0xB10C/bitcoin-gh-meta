[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25494](https://github.com/bitcoin/bitcoin/pull/25494) (indexes: Stop using node internal types by ryanofsky)\n* [#25337](https://github.com/bitcoin/bitcoin/pull/25337) (refactor: encapsulate wallet's address book access by furszy)\n* [#25296](https://github.com/bitcoin/bitcoin/pull/25296) (Add DataStream without ser-type and ser-version and use it where possible by MarcoFalke)\n* [#25272](https://github.com/bitcoin/bitcoin/pull/25272) (wallet: guard and alert about a wallet invalid state during chain sync by furszy)\n* [#25218](https://github.com/bitcoin/bitcoin/pull/25218) (refactor: introduce generic 'Result' class and connect it to CreateTransaction and GetNewDestination by furszy)\n* [#24914](https://github.com/bitcoin/bitcoin/pull/24914) (wallet: Load database records in a particular order by achow101)\n* [#24897](https://github.com/bitcoin/bitcoin/pull/24897) ([Draft / POC] Silent Payments by w0xlt)\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n* [#23417](https://github.com/bitcoin/bitcoin/pull/23417) (wallet, spkm: Move key management from DescriptorScriptPubKeyMan to wallet level KeyManager by achow101)\n* [#22838](https://github.com/bitcoin/bitcoin/pull/22838) (descriptors: Be able to specify change and receiving in a single descriptor string by achow101)\n* [#19602](https://github.com/bitcoin/bitcoin/pull/19602) (wallet: Migrate legacy wallets to descriptor wallets by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-06-08T01:02:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1149330883",
      "id" : 1149330883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585EgWXD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1149330883/reactions"
      },
      "updated_at" : "2022-06-29T01:50:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1149330883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894696115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894696115"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n\r\n```suggestion\r\n                MarkConflicted(batch, /*hashBlock=*/prev->conflicting_block_hash, /*conflicting_height=*/prev->conflicting_block_height, /*hashTx=*/wtx.GetHash());\r\n```",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T16:17:47Z",
      "diff_hunk" : "@@ -1072,13 +1068,15 @@ bool CWallet::LoadToWallet(const uint256& hash, const UpdateWalletTxFn& fill_wtx\n     if (/* insertion took place */ ins.second) {\n         wtx.m_it_wtxOrdered = wtxOrdered.insert(std::make_pair(wtx.nOrderPos, &wtx));\n     }\n-    AddToSpends(hash);\n+    // Do not flush the wallet here for performance reasons\n+    WalletBatch batch(GetDatabase(), false);\n+    AddToSpends(hash, batch);\n     for (const CTxIn& txin : wtx.tx->vin) {\n         auto it = mapWallet.find(txin.prevout.hash);\n         if (it != mapWallet.end()) {\n             CWalletTx& prevtx = it->second;\n             if (auto* prev = prevtx.state<TxStateConflicted>()) {\n-                MarkConflicted(prev->conflicting_block_hash, prev->conflicting_block_height, wtx.GetHash());\n+                MarkConflicted(batch, prev->conflicting_block_hash, prev->conflicting_block_height, wtx.GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894696115",
      "id" : 894696115,
      "line" : 1079,
      "node_id" : "PRRC_kwDOABII5841U_qz",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1079,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 93,
      "pull_request_review_id" : 1003035094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894696115/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T16:24:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894696115",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894697860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894697860"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n                            SetAddressBookWithDB(batch, /*address=*/dest.dest, /*strName=*/\"\", /*strPurpose=*/\"receive\");\r\n```",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T16:20:07Z",
      "diff_hunk" : "@@ -1130,7 +1130,7 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n                         // (e.g. it wasn't generated on this node or we're restoring from backup)\n                         // add it to the address book for proper transaction accounting\n                         if (!*dest.internal && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\n-                            SetAddressBook(dest.dest, \"\", \"receive\");\n+                            SetAddressBookWithDB(batch, dest.dest, \"\", \"receive\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894697860",
      "id" : 894697860,
      "line" : 1133,
      "node_id" : "PRRC_kwDOABII5841VAGE",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1133,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 120,
      "pull_request_review_id" : 1003035094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894697860/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T16:24:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894697860",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894698739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894698739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n                        MarkConflicted(batch, /*hashBlock=*/conf->confirmed_block_hash, /*conflicting_height=*/conf->confirmed_block_height, /*hashTx=*/range.first->second);\r\n```",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T16:21:15Z",
      "diff_hunk" : "@@ -1090,14 +1088,16 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n     const CTransaction& tx = *ptx;\n     {\n         AssertLockHeld(cs_wallet);\n+        // Do not flush the wallet here for performance reasons\n+        WalletBatch batch(GetDatabase(), false /*fFlushOnClose*/);\n \n         if (auto* conf = std::get_if<TxStateConfirmed>(&state)) {\n             for (const CTxIn& txin : tx.vin) {\n                 std::pair<TxSpends::const_iterator, TxSpends::const_iterator> range = mapTxSpends.equal_range(txin.prevout);\n                 while (range.first != range.second) {\n                     if (range.first->second != tx.GetHash()) {\n                         WalletLogPrintf(\"Transaction %s (in block %s) conflicts with wallet transaction %s (both spend %s:%i)\\n\", tx.GetHash().ToString(), conf->confirmed_block_hash.ToString(), range.first->second.ToString(), range.first->first.hash.ToString(), range.first->first.n);\n-                        MarkConflicted(conf->confirmed_block_hash, conf->confirmed_block_height, range.first->second);\n+                        MarkConflicted(batch, conf->confirmed_block_hash, conf->confirmed_block_height, range.first->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894698739",
      "id" : 894698739,
      "line" : 1100,
      "node_id" : "PRRC_kwDOABII5841VATz",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1100,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 111,
      "pull_request_review_id" : 1003035094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894698739/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T16:24:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894698739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894699964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894699964"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n            return AddToWallet(batch, MakeTransactionRef(tx), /*state=*/tx_state, /*update_wtx=*/nullptr, rescanning_old_block);\r\n```",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T16:22:46Z",
      "diff_hunk" : "@@ -1139,7 +1139,7 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n             // Block disconnection override an abandoned tx as unconfirmed\n             // which means user may have to call abandontransaction again\n             TxState tx_state = std::visit([](auto&& s) -> TxState { return s; }, state);\n-            return AddToWallet(MakeTransactionRef(tx), tx_state, /*update_wtx=*/nullptr, /*fFlushOnClose=*/false, rescanning_old_block);\n+            return AddToWallet(batch, MakeTransactionRef(tx), tx_state, /*update_wtx=*/nullptr, rescanning_old_block);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894699964",
      "id" : 894699964,
      "line" : 1142,
      "node_id" : "PRRC_kwDOABII5841VAm8",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1142,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 129,
      "pull_request_review_id" : 1003035094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894699964/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T16:24:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894699964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94266259?v=4",
         "events_url" : "https://api.github.com/users/w0xlt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/w0xlt/followers",
         "following_url" : "https://api.github.com/users/w0xlt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/w0xlt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/w0xlt",
         "id" : 94266259,
         "login" : "w0xlt",
         "node_id" : "U_kgDOBZ5jkw",
         "organizations_url" : "https://api.github.com/users/w0xlt/orgs",
         "received_events_url" : "https://api.github.com/users/w0xlt/received_events",
         "repos_url" : "https://api.github.com/users/w0xlt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/w0xlt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/w0xlt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/w0xlt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review w0xlt!\r\n\r\nAbout the nits:\r\nI don't think that the arguments names are needed in most of those cases, there isn't a real benefit adding them, the variables have a clear name that represent what they are (except one).",
      "created_at" : "2022-06-10T17:04:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1152564538",
      "id" : 1152564538,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585Esr06",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1152564538/reactions"
      },
      "updated_at" : "2022-06-10T17:04:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1152564538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894742680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894742680"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably better to do a `const auto& txid = range.first->second;` above the if block (the same value is accessed multiple times).\r\n\r\nWill do it if have to retouch the area.",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T17:09:18Z",
      "diff_hunk" : "@@ -1090,14 +1088,16 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n     const CTransaction& tx = *ptx;\n     {\n         AssertLockHeld(cs_wallet);\n+        // Do not flush the wallet here for performance reasons\n+        WalletBatch batch(GetDatabase(), false /*fFlushOnClose*/);\n \n         if (auto* conf = std::get_if<TxStateConfirmed>(&state)) {\n             for (const CTxIn& txin : tx.vin) {\n                 std::pair<TxSpends::const_iterator, TxSpends::const_iterator> range = mapTxSpends.equal_range(txin.prevout);\n                 while (range.first != range.second) {\n                     if (range.first->second != tx.GetHash()) {\n                         WalletLogPrintf(\"Transaction %s (in block %s) conflicts with wallet transaction %s (both spend %s:%i)\\n\", tx.GetHash().ToString(), conf->confirmed_block_hash.ToString(), range.first->second.ToString(), range.first->first.hash.ToString(), range.first->first.n);\n-                        MarkConflicted(conf->confirmed_block_hash, conf->confirmed_block_height, range.first->second);\n+                        MarkConflicted(batch, conf->confirmed_block_hash, conf->confirmed_block_height, range.first->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894742680",
      "id" : 894742680,
      "in_reply_to_id" : 894698739,
      "line" : 1100,
      "node_id" : "PRRC_kwDOABII5841VLCY",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1100,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 111,
      "pull_request_review_id" : 1003098725,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894742680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T17:09:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894742680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894745100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894745100"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ðð¼, will do if have to retouch the area.",
      "commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "created_at" : "2022-06-10T17:12:43Z",
      "diff_hunk" : "@@ -1130,7 +1130,7 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const SyncTxS\n                         // (e.g. it wasn't generated on this node or we're restoring from backup)\n                         // add it to the address book for proper transaction accounting\n                         if (!*dest.internal && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\n-                            SetAddressBook(dest.dest, \"\", \"receive\");\n+                            SetAddressBookWithDB(batch, dest.dest, \"\", \"receive\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#discussion_r894745100",
      "id" : 894745100,
      "in_reply_to_id" : 894697860,
      "line" : 1133,
      "node_id" : "PRRC_kwDOABII5841VLoM",
      "original_commit_id" : "843b987865d8020da584962c67f31238b2ccf864",
      "original_line" : 1133,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 120,
      "pull_request_review_id" : 1003102338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25297",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894745100/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T17:12:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894745100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Flush on close is probably not quite the performance improvement that you think it is. While it is an improvement for BDB, with SQLite, the argument is ignored. SQLite flushes after each write operation regardless. It would be better to use transactions with `TxnBegin` and `TxnCommit` as these do actually batch the operations into single atomic writes.\r\n\r\nOtherwise, I think this is a good idea to be reusing the batches.",
      "created_at" : "2022-06-13T20:44:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1154421627",
      "id" : 1154421627,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585EzxN7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1154421627/reactions"
      },
      "updated_at" : "2022-06-13T20:46:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1154421627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-22T01:20:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1162517997",
      "id" : 1162517997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585FSp3t",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162517997/reactions"
      },
      "updated_at" : "2022-06-22T01:20:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1162517997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the feedback ðð¼ \r\n\r\n>  It would be better to use transactions with TxnBegin and TxnCommit as these do actually batch the operations into single atomic writes.\r\n\r\nAlmost there, been working on it :).\r\n\r\n> Otherwise, I think this is a good idea to be reusing the batches.\r\n\r\nHave another branch with more of them (chained to the batched operations work). I'll probably end up decoupling some of them into another PR (otherwise this will end up being pretty big).",
      "created_at" : "2022-06-23T20:04:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1164817555",
      "id" : 1164817555,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585FbbST",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164817555/reactions"
      },
      "updated_at" : "2022-06-23T20:04:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1164817555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Update:\r\n\r\nPushed the first step toward the implementation of db write batched operations for entire processes.\r\n\r\nBasically, is the utilization of the same db handler across all the methods, whom internally write to db, that are called during a specific process workflow (only the parent method who starts the process will construct the `WalletBatch`).\r\n\r\nIn order to provide the `WalletBatch` reference, without knowing if the underlying method/s will use it or not, implemented the capability to construct an uninitialized `WalletBatch`, who will be automatically initialized on the first write call.\r\nIf no db write method is called, the object will remain uninitialized for the entire process workflow without consuming any extra resource.\r\n\r\nNote:\r\nI haven't updated the PR description yet. Will do it once the work is finished (still have more to push).",
      "created_at" : "2022-06-28T23:53:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25297#issuecomment-1169395527",
      "id" : 1169395527,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25297",
      "node_id" : "IC_kwDOABII585Fs49H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169395527/reactions"
      },
      "updated_at" : "2022-06-29T03:12:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1169395527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
