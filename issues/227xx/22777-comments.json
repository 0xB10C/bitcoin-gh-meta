[
   {
      "author_association" : "MEMBER",
      "body" : "Previously attempted in #9403, which was abandoned by the author.",
      "created_at" : "2021-08-23T09:50:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-903614528",
      "id" : 903614528,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58413BBA",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-23T09:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903614528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r693830234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693830234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Doesn't this mean we won't request tx relay, but are (theoretically) still happy to process them?\r\n\r\nWouldn't it be better if this check here wasn't needed and `m_tx_relay` was never initialized? See also https://github.com/bitcoin/bitcoin/pull/21160#discussion_r693531183",
      "commit_id" : "e064b1bed24813f7f4c42093978f7a7de3c21365",
      "created_at" : "2021-08-23T09:55:06Z",
      "diff_hunk" : "@@ -1098,7 +1098,7 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, int64_t nTime)\n                            CAddress(CService(), addr.nServices);\n     CAddress addrMe = CAddress(CService(), nLocalNodeServices);\n \n-    const bool tx_relay = !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr;\n+    const bool tx_relay = !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr && !pnode.IsFeelerConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r693830234",
      "id" : 693830234,
      "line" : 1101,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzgzMDIzNA==",
      "original_commit_id" : "e064b1bed24813f7f4c42093978f7a7de3c21365",
      "original_line" : 1101,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 735934072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T10:00:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693830234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r693927035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693927035"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> nit: Doesn't this mean we won't request tx relay, but are (theoretically) still happy to process them?\r\n\r\nNo. For feeler connections, we disconnect as soon as we receive the `version` message, and we don't process any other message types before receiving `version`, so it's not possible for us to process any incoming transactions or announcements.\r\n\r\n> Wouldn't it be better if this check here wasn't needed and m_tx_relay was never initialized?\r\n\r\nI agree that it'd be better if `m_tx_relay` wasn't initialized until we receive the `version` message, and have implemented that in #22778. However, I don't think that's relevant here. For outbound peers, `PushNodeVersion` is sent _before_ receiving the `version` message, so this check can't be dependent on whether `m_tx_relay` has been initialized.",
      "commit_id" : "e064b1bed24813f7f4c42093978f7a7de3c21365",
      "created_at" : "2021-08-23T12:29:36Z",
      "diff_hunk" : "@@ -1098,7 +1098,7 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, int64_t nTime)\n                            CAddress(CService(), addr.nServices);\n     CAddress addrMe = CAddress(CService(), nLocalNodeServices);\n \n-    const bool tx_relay = !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr;\n+    const bool tx_relay = !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr && !pnode.IsFeelerConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r693927035",
      "id" : 693927035,
      "in_reply_to_id" : 693830234,
      "line" : 1101,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MzkyNzAzNQ==",
      "original_commit_id" : "e064b1bed24813f7f4c42093978f7a7de3c21365",
      "original_line" : 1101,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 736060529,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T12:29:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/693927035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22850](https://github.com/bitcoin/bitcoin/pull/22850) (net: Make m_mempool optional in PeerManager by sriramdvt)\n* [#22778](https://github.com/bitcoin/bitcoin/pull/22778) (net processing: Reduce resource usage for inbound block-relay-only connections by jnewbery)\n* [#21160](https://github.com/bitcoin/bitcoin/pull/21160) (net/net processing: Move tx inventory into net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-23T13:29:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-903769607",
      "id" : 903769607,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58413m4H",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T09:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903769607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-08-23T17:16:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-903961948",
      "id" : 903961948,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58414V1c",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-23T17:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903961948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-08-23T17:22:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-903965825",
      "id" : 903965825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58414WyB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-23T17:22:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903965825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Currently, we set fRelay to 1 in the version message for feeler connections, indicating that we want the peer to relay transactions to us. However, we close the connection immediately on receipt of the version message, and so never process any incoming transaction announcements. This PR changes that behaviour to instead set fRelay to 0 indicating that we do not wish to receive transaction announcements from the peer.\r\n\r\nConcept ACK. Approach ACK.\r\n\r\n~~Do we have any hidden RPC to test this without using python test framework? Or maybe I can wait for some feeler connections and see messages in Wireshark~~",
      "created_at" : "2021-08-23T17:40:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-903977127",
      "id" : 903977127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58414Zin",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T18:41:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903977127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694354532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694354532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand the reason for `P2PFeelerReceiver`. A real peer also wouldn't know that they are about to get disconnected by us as a feeler, so why simulate it here instead of just using `P2PInterface`?",
      "commit_id" : "b9f26e7a550a7a4872d958ad6a701ad2eb0af5bf",
      "created_at" : "2021-08-23T22:37:41Z",
      "diff_hunk" : "@@ -14,6 +14,13 @@ def check_node_connections(*, node, num_in, num_out):\n     assert_equal(info[\"connections_in\"], num_in)\n     assert_equal(info[\"connections_out\"], num_out)\n \n+class P2PFeelerReceiver(P2PInterface):\n+    def on_version(self, message):\n+        # The bitcoind node closes feeler connections as soon as a version\n+        # message is received from the test framework. Don't send any responses\n+        # to the node's version message since the connection will already be\n+        # closed.\n+        pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694354532",
      "id" : 694354532,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDM1NDUzMg==",
      "original_commit_id" : "4d972c44380f743d64f592c65f4070edfd1770fa",
      "original_line" : 23,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 10,
      "pull_request_review_id" : 736623351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T23:14:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694354532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694366565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694366565"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: there are several comments that describe the possible connection types and could be updated for feelers, I hope I caught them all [here](https://github.com/bitcoin/bitcoin/pull/22096/commits/c34ad3309f93979b274a37de013502b05d25fad8)",
      "commit_id" : "b9f26e7a550a7a4872d958ad6a701ad2eb0af5bf",
      "created_at" : "2021-08-23T23:07:17Z",
      "diff_hunk" : "@@ -1228,6 +1227,9 @@ bool CConnman::AddConnection(const std::string& address, ConnectionType conn_typ\n     // no limit for ADDR_FETCH because -seednode has no limit either\n     case ConnectionType::ADDR_FETCH:\n         break;\n+    // no limit for FEELER connections since they're short-lived\n+    case ConnectionType::FEELER:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694366565",
      "id" : 694366565,
      "line" : 1231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDM2NjU2NQ==",
      "original_commit_id" : "4d972c44380f743d64f592c65f4070edfd1770fa",
      "original_line" : 1231,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 736623351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-23T23:14:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694366565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If I understand it correctly, the problem solved here is that our feeler peer might assemble/send out unnecessary tx announcements in the short time before they notice that they got disconnected.\r\n\r\nNot quite. The `fRelay` field in the `version` message indicates whether the peer should announce new unconfirmed transactions to us (https://github.com/bitcoin/bips/blob/master/bip-0037.mediawiki#extensions-to-existing-messages). When we open a feeler connection to a peer, we obviously don't want it to announce txs to us, since we're going to disconnect as soon as we receive their `version` message.\r\n\r\nThis PR is maybe better understood when considered alongside #22778, where we'll save having to allocate the `TxRelay` data structure when receiving inbound connections with `fRelay` set to `0`.\r\n\r\n> Aren't tx invs are just one of several unnecessary messages? e.g. we also send them an GETADDR before disconnecting, so that they might prepare an answer which we'll never receive. So I wonder if a more general solution would make sense. (would it maybe work to skip sending VERACK to feelers?)\r\n\r\nI agree that we probably shouldn't send `getaddr`, `sendaddrv2` and `wtxidrelay` to the peer. I'm not sure about skipping `verack`. Those changes could happen in a separate PR.",
      "created_at" : "2021-08-24T13:18:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-904635009",
      "id" : 904635009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII584166KB",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-24T13:18:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904635009",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694843113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694843113"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since the node will disconnect as soon as it receives our `version` message, there's a race between it disconnecting and the `P2PInterface` sending the responses to its `version` message here: https://github.com/bitcoin/bitcoin/blob/eb09c26724e3f714b613788fc506f2ff3a208d2c/test/functional/test_framework/p2p.py#L435-L441. If it disconnects first, those calls to `send_message()` may fail, causing the test to fail.",
      "commit_id" : "9a45648438ae62c4087a6d01d14050035dd0e78c",
      "created_at" : "2021-08-24T13:20:42Z",
      "diff_hunk" : "@@ -14,6 +14,13 @@ def check_node_connections(*, node, num_in, num_out):\n     assert_equal(info[\"connections_in\"], num_in)\n     assert_equal(info[\"connections_out\"], num_out)\n \n+class P2PFeelerReceiver(P2PInterface):\n+    def on_version(self, message):\n+        # The bitcoind node closes feeler connections as soon as a version\n+        # message is received from the test framework. Don't send any responses\n+        # to the node's version message since the connection will already be\n+        # closed.\n+        pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694843113",
      "id" : 694843113,
      "in_reply_to_id" : 694354532,
      "line" : 23,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDg0MzExMw==",
      "original_commit_id" : "4d972c44380f743d64f592c65f4070edfd1770fa",
      "original_line" : 23,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 10,
      "pull_request_review_id" : 737217576,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T13:20:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694843113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694845807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694845807"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Updated!",
      "commit_id" : "9a45648438ae62c4087a6d01d14050035dd0e78c",
      "created_at" : "2021-08-24T13:23:42Z",
      "diff_hunk" : "@@ -1228,6 +1227,9 @@ bool CConnman::AddConnection(const std::string& address, ConnectionType conn_typ\n     // no limit for ADDR_FETCH because -seednode has no limit either\n     case ConnectionType::ADDR_FETCH:\n         break;\n+    // no limit for FEELER connections since they're short-lived\n+    case ConnectionType::FEELER:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#discussion_r694845807",
      "id" : 694845807,
      "in_reply_to_id" : 694366565,
      "line" : 1231,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5NDg0NTgwNw==",
      "original_commit_id" : "4d972c44380f743d64f592c65f4070edfd1770fa",
      "original_line" : 1231,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 13,
      "pull_request_review_id" : 737221171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22777",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-24T13:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/694845807",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "trying to wrap my head around not acquiring the `CSemaphoreGrant` / having a limit to the amount of feelers we open from the tests...\r\n\r\nwhen a bitcoind node opens a feeler connection, it acquires the grant in `ThreadOpenConnections`. but I think its fine to not replicate this from the tests because there's no logic that is ensuring the current connection count matches the maximums for feelers (like with outbound-full-relay or block-relay-only connections). the `addconnection` RPC only works for regtest, so we don't have to worry about potential resource usage on mainnet. and other than not enforcing a maximum number of connections, I don't think there are other logic conditions that change.\r\n\r\n@jnewbery does that match your reasoning? ",
      "created_at" : "2021-08-24T18:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-904857460",
      "id" : 904857460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII58417wd0",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-25T18:41:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/904857460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-09-01T16:04:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22777#issuecomment-910430112",
      "id" : 910430112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22777",
      "node_id" : "IC_kwDOABII5842RA-g",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T16:04:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/910430112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
