[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree that corrupt data shouldn't assert.\r\n\r\n`Check()` used to be restricted to tests / use of the `checkaddrman` option, it was never run per default. This PR makes it run always for `Unserialize()`, so it introduces stricter rules for the level of inconsistencies we tolerate from peers.dat. \r\nI think this change of default behavior should be mentioned in the OP and maybe somewhere in the code, because it also introduces new possibilities of p2p addrman poisoning to make us drop our peers.dat - so we should be confident all checks in `Check()` are correct before enabling this.",
      "created_at" : "2021-08-18T08:27:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-900923279",
      "id" : 900923279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII5841sv-P",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T08:27:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900923279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks, renamed PR title",
      "created_at" : "2021-08-18T08:30:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-900925089",
      "id" : 900925089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII5841swah",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T08:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900925089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! I think there is a bug in the `addman_serdeser` fuzz test (see CI fail) that would need fixing, see https://github.com/mzumsande/bitcoin/commit/f4840614c0b945460a833ba8e9d0da2df3ce80c3",
      "created_at" : "2021-08-18T08:41:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-900932484",
      "id" : 900932484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII5841syOE",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T08:41:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900932484",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "With this change, if we have a bug that causes us to write a peers.dat file that's corrupt in any way, then it would mostly be undetected - the addrman would be cleared and startup would continue as normal. As @mzumsande points out, if it's possible to trigger such a bug over p2p, then an adversary could cause victims to lose their entire addrman on restart.\r\n\r\nIt might be safer to do the `ForceCheck`, but then catch the exception, rename peers.dat to peers.bak, and terminate with some error message like \"Corrupt peers.dat file found. addrman database has been wiped and peers.dat has been renamed to peers.bak. Please report this to the Bitcoin Core developers.\" That way, we'd get bug reports if there was a bug in our serialization code, and there may be a way to salvage the peers.bak file if needed.",
      "created_at" : "2021-08-18T09:22:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-900959795",
      "id" : 900959795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII5841s44z",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-18T09:22:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/900959795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22734#discussion_r691065092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22734"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691065092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: maybe mention \"addrman\" somewhere in this message. The following looks too generic:\r\n```\r\n2021-08-18T07:12:57Z ERROR: DeserializeDB: Deserialize or I/O error - Corrupt data. Consistency check failed with code -16.: iostream error\r\n```\r\n\r\nnit: remove the dot after %s: `with code -16.: iostream error`",
      "commit_id" : "fab42d7dab8ad674e9e37baca9af625bf2c465bb",
      "created_at" : "2021-08-18T09:27:32Z",
      "diff_hunk" : "@@ -468,7 +468,12 @@ class CAddrMan\n             LogPrint(BCLog::ADDRMAN, \"addrman lost %i new and %i tried addresses due to collisions or invalid addresses\\n\", nLostUnk, nLost);\n         }\n \n-        Check();\n+        const int check_code{ForcedCheck()};\n+        if (check_code != 0) {\n+            throw std::ios_base::failure(strprintf(\n+                \"Corrupt data. Consistency check failed with code %s.\",\n+                check_code));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#discussion_r691065092",
      "id" : 691065092,
      "line" : 475,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTA2NTA5Mg==",
      "original_commit_id" : "fab42d7dab8ad674e9e37baca9af625bf2c465bb",
      "original_line" : 475,
      "original_position" : 9,
      "original_start_line" : 473,
      "path" : "src/addrman.h",
      "position" : 9,
      "pull_request_review_id" : 732638490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22734",
      "side" : "RIGHT",
      "start_line" : 473,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-18T09:37:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691065092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">With this change, if we have a bug that causes us to write a peers.dat file that's corrupt in any way, then it would mostly be undetected - the addrman would be cleared and startup would continue as normal. As @mzumsande points out, if it's possible to trigger such a bug over p2p, then an adversary could cause victims to lose their entire addrman on restart.\r\n\r\n> It might be safer to do the ForceCheck, but then catch the exception, rename peers.dat to peers.bak, and terminate with some error message like \"Corrupt peers.dat file found. addrman database has been wiped and peers.dat has been renamed to peers.bak. Please report this to the Bitcoin Core developers.\" That way, we'd get bug reports if there was a bug in our serialization code, and there may be a way to salvage the peers.bak file if needed.\r\n\r\nI agree with John.",
      "created_at" : "2021-08-20T18:22:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-902874897",
      "id" : 902874897,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII58410McR",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-20T18:22:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902874897",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22740](https://github.com/bitcoin/bitcoin/pull/22740) ([addrman] Move serialization code to cpp by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-08-21T02:22:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-903039535",
      "id" : 903039535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII584100ov",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-21T02:22:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903039535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I agree with @vasild that this is an unrelated bug that already exists. I've created a separate pull to fix that: #22762",
      "created_at" : "2021-08-21T12:45:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-903111513",
      "id" : 903111513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII58411GNZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-21T12:45:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/903111513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-09-01T03:11:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22734#issuecomment-909836806",
      "id" : 909836806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22734",
      "node_id" : "IC_kwDOABII5842OwIG",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-01T03:11:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909836806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
