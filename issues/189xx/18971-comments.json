[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-05-14T00:08:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628309919",
      "id" : 628309919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODMwOTkxOQ==",
      "updated_at" : "2020-05-14T00:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628309919",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18918 (wallet: Move salvagewallet into wallettool by achow101)\n* #18907 (walletdb: Don't remove database transaction logs and instead error by achow101)\n* #18904 (Don't call lsn_reset in periodic flush by bvbfan)\n* #18836 (wallet: upgradewallet fixes and additional tests by achow101)\n* #18792 (wallet: Remove boost from PeriodicFlush by MarcoFalke)\n* #18731 (refactor: Make CCheckQueue RAII-styled by hebasto)\n* #18710 (Add local thread pool to CCheckQueue by hebasto)\n* #18618 (gui: Drop RecentRequestsTableModel dependency to WalletModel by promag)\n* #18608 (refactor: Remove CAddressBookData::destdata by ryanofsky)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-14T03:06:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628358883",
      "id" : 628358883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODM1ODg4Mw==",
      "updated_at" : "2020-05-23T06:57:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628358883",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Strong concept ACK for the effort and end result, but I'm scared it looks like the intermediate commits here are moving and changing code at the same time instead of just leaving code where it is or moving it in trivial to review `--color-moved` MOVEONLY commits. This was previously a hurdle for me in https://github.com/bitcoin/bitcoin/pull/16341#issuecomment-541330425, but maybe the problem is less severe here because it looks like the moves are happening in single commits, not in harder to reconcile add and remove commits.\r\n\r\nI would definitely appreciate it (can't speak for other reviewers) if this PR could be updated to use MOVEONLY commits (multiple small ones throughout or a big one at the beginning or end), but I'll give this a try and maybe the review will be easier than I'm expecting ð ",
      "created_at" : "2020-05-14T22:33:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628920481",
      "id" : 628920481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODkyMDQ4MQ==",
      "updated_at" : "2020-05-14T22:33:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628920481",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> but I'm scared it looks like the intermediate commits here are moving and changing code at the same time instead of just leaving code where it is or moving it in trivial to review\r\n\r\nI only found one commit which was moving and changing behavior at the same time. This was `wallet: Move cursor functions to WalletDatabase and handle internally` which I have now split into `walletdb: Handle cursor internally` (changes behavior) and `walletdb: Move cursor functions to WalletDatabase` (move).",
      "created_at" : "2020-05-15T01:39:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-628975249",
      "id" : 628975249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODk3NTI0OQ==",
      "updated_at" : "2020-05-15T01:39:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628975249",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "The patch changes ref counting of db files. Now `Acquire` is called only in `Rewrite` since previous batch do it. Now ref count is always 0 (except you call Rewrite) which makes whole read/write racy.",
      "created_at" : "2020-05-15T13:01:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629222719",
      "id" : 629222719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTIyMjcxOQ==",
      "updated_at" : "2020-05-15T13:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629222719",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The patch changes ref counting of db files. Now `Acquire` is called only in `Rewrite` since previous batch do it. Now ref count is always 0 (except you call Rewrite) which makes whole read/write racy.\r\n\r\n`Acquire` is called by `WalletBatch`'s constructor so the ref count is still incremented every time the database is being used. And `Release` is called by `WalletBatch`'s destructor.",
      "created_at" : "2020-05-15T16:15:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629349300",
      "id" : 629349300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM0OTMwMA==",
      "updated_at" : "2020-05-15T16:15:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629349300",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426012118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426012118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `const fs::path&`\r\n\r\nin commit: d4a55140ea3e47ee6e4c93c484c7c72cfed741dd",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-15T19:44:02Z",
      "diff_hunk" : "@@ -103,6 +105,207 @@ static void WalletShowInfo(CWallet* wallet_instance)\n     tfm::format(std::cout, \"Address Book: %zu\\n\", wallet_instance->m_address_book.size());\n }\n \n+/* End of headers, beginning of key/value data */\n+static const char *HEADER_END = \"HEADER=END\";\n+/* End of key/value data */\n+static const char *DATA_END = \"DATA=END\";\n+\n+static bool SalvageWallet(fs::path path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426012118",
      "id" : 426012118,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjExOA==",
      "original_commit_id" : "0f991e733516fa26e1ceaca10a5b582093950e53",
      "original_line" : 113,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 412921503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426012118",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426013423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426013423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO \"Attempt to recover private keys from a corrupt wallet\" explains salvage more clearly than \"Perform salvage operations on a wallet file\". I understand that's specific to `RecoverKeysOnlyFilter`, but perhaps its possible to clarify the documentation?\r\n\r\n",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-15T19:46:53Z",
      "diff_hunk" : "@@ -54,7 +54,6 @@ void WalletInit::AddWalletOptions() const\n     gArgs.AddArg(\"-paytxfee=<amt>\", strprintf(\"Fee (in %s/kB) to add to transactions you send (default: %s)\",\n                                                             CURRENCY_UNIT, FormatMoney(CFeeRate{DEFAULT_PAY_TX_FEE}.GetFeePerK())), ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n     gArgs.AddArg(\"-rescan\", \"Rescan the block chain for missing wallet transactions on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n-    gArgs.AddArg(\"-salvagewallet\", \"Attempt to recover private keys from a corrupt wallet on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426013423",
      "id" : 426013423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMzQyMw==",
      "original_commit_id" : "8ef1b45b4d3de71214da1a6bc6e09f6e9a14d7d4",
      "original_line" : 57,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/init.cpp",
      "position" : null,
      "pull_request_review_id" : 412923311,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426013423",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This commit is part of #18918 so comments should be left there.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-15T22:08:15Z",
      "diff_hunk" : "@@ -103,6 +105,207 @@ static void WalletShowInfo(CWallet* wallet_instance)\n     tfm::format(std::cout, \"Address Book: %zu\\n\", wallet_instance->m_address_book.size());\n }\n \n+/* End of headers, beginning of key/value data */\n+static const char *HEADER_END = \"HEADER=END\";\n+/* End of key/value data */\n+static const char *DATA_END = \"DATA=END\";\n+\n+static bool SalvageWallet(fs::path path)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067977",
      "id" : 426067977,
      "in_reply_to_id" : 426012118,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Nzk3Nw==",
      "original_commit_id" : "0f991e733516fa26e1ceaca10a5b582093950e53",
      "original_line" : 113,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 412994378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067977",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This commit is part of #18918 so comments should be left there.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-15T22:08:20Z",
      "diff_hunk" : "@@ -54,7 +54,6 @@ void WalletInit::AddWalletOptions() const\n     gArgs.AddArg(\"-paytxfee=<amt>\", strprintf(\"Fee (in %s/kB) to add to transactions you send (default: %s)\",\n                                                             CURRENCY_UNIT, FormatMoney(CFeeRate{DEFAULT_PAY_TX_FEE}.GetFeePerK())), ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n     gArgs.AddArg(\"-rescan\", \"Rescan the block chain for missing wallet transactions on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);\n-    gArgs.AddArg(\"-salvagewallet\", \"Attempt to recover private keys from a corrupt wallet on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::WALLET);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r426067999",
      "id" : 426067999,
      "in_reply_to_id" : 426013423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Nzk5OQ==",
      "original_commit_id" : "8ef1b45b4d3de71214da1a6bc6e09f6e9a14d7d4",
      "original_line" : 57,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/init.cpp",
      "position" : null,
      "pull_request_review_id" : 412994405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426067999",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@achow101 re @ryanofsky's comment, I set out to expand and clarify https://github.com/bitcoin/bitcoin/pull/18971/commits/67e30b2b42b4d710739e6fe303cbca69be68032c into several simpler move-only commits. \r\n\r\nYou can use `git diff 67e30b2b42b4d710739e6fe303cbca69be68032c 125796d8e60b8e740857e427cbaad4aa23f74b52` to compare the results, as there are some changes I've left out, and slight difference, e.g. I took the approach of exposing `WalletBatch::ReadKeyValue`, but they don't affect the later commits.\r\n\r\nhttps://github.com/achow101/bitcoin/compare/refactor-storage...Empact:refactor-storage-moveonly",
      "created_at" : "2020-05-15T22:39:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629535592",
      "id" : 629535592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTUzNTU5Mg==",
      "updated_at" : "2020-05-15T22:39:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629535592",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Empact Thanks for doing that! Unfortunately I worked out my own way of doing the separation before I saw your comment. My version was pushed to #18918.",
      "created_at" : "2020-05-15T23:55:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629553130",
      "id" : 629553130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTU1MzEzMA==",
      "updated_at" : "2020-05-15T23:55:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629553130",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> `Acquire` is called by `WalletBatch`'s constructor so the ref count is still incremented every time the database is being used. And `Release` is called by `WalletBatch`'s destructor.\r\n\r\nGot'cha, sorry about that, i've not notice it. I still have concern about touching db env in multi threading. `BerkeleyDatabase` should guard every env usage, for example in contructor with shared env, the easiest test is to call `CreateWalletFromFile` from distinct threads with same db location, it will crash at \r\n`auto inserted = this->env->m_databases.emplace(strFile, std::ref(*this));`\r\nbefore actual assert in next line.",
      "created_at" : "2020-05-17T16:58:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-629828484",
      "id" : 629828484,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTgyODQ4NA==",
      "updated_at" : "2020-05-17T16:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629828484",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-05-18T10:53:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-630104158",
      "id" : 630104158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDEwNDE1OA==",
      "updated_at" : "2020-05-18T10:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630104158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427420606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427420606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "When building with clang --enable-debug -Werror I'm seeing the following compiler error:\r\n\r\n```cpp\r\n./wallet/walletdb.h:322:112: error: member access into incomplete type 'CWallet'\r\n             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);\r\n                                                                                                               ^\r\n./wallet/ismine.h:14:7: note: forward declaration of 'CWallet'\r\nclass CWallet;\r\n      ^\r\n1 error generated.\r\n```",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-19T16:05:32Z",
      "diff_hunk" : "@@ -287,11 +290,47 @@ class WalletBatch\n     //! Abort current transaction\n     bool TxnAbort();\n private:\n-    BerkeleyBatch m_batch;\n     WalletDatabase& m_database;\n };\n \n //! Compacts BDB state so that wallet.dat is self-contained (if there are changes)\n void MaybeCompactWalletDB();\n \n+//! State of scanning the wallet during ReadKeyValue\n+class CWalletScanState {\n+public:\n+    unsigned int nKeys{0};\n+    unsigned int nCKeys{0};\n+    unsigned int nWatchKeys{0};\n+    unsigned int nKeyMeta{0};\n+    unsigned int m_unknown_records{0};\n+    bool fIsEncrypted{false};\n+    bool fAnyUnordered{false};\n+    std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_active_external_spks;\n+    std::map<OutputType, uint256> m_active_internal_spks;\n+    std::map<uint256, DescriptorCache> m_descriptor_caches;\n+    std::map<std::pair<uint256, CKeyID>, CKey> m_descriptor_keys;\n+    std::map<std::pair<uint256, CKeyID>, std::pair<CPubKey, std::vector<unsigned char>>> m_descriptor_crypt_keys;\n+\n+    CWalletScanState() {\n+    }\n+};\n+\n+//! Unserialize a give Key-Value pair and load it into the wallet and wallet scan state\n+bool ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n+             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427420606",
      "id" : 427420606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyMDYwNg==",
      "original_commit_id" : "6c47d41779ec5b335acf75652228d541b7a5b67a",
      "original_line" : 322,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 414600810,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427420606",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427423048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427423048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(It may not be directly related to this PR; saw a similar build error in another wallet PR today.)",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-19T16:09:00Z",
      "diff_hunk" : "@@ -287,11 +290,47 @@ class WalletBatch\n     //! Abort current transaction\n     bool TxnAbort();\n private:\n-    BerkeleyBatch m_batch;\n     WalletDatabase& m_database;\n };\n \n //! Compacts BDB state so that wallet.dat is self-contained (if there are changes)\n void MaybeCompactWalletDB();\n \n+//! State of scanning the wallet during ReadKeyValue\n+class CWalletScanState {\n+public:\n+    unsigned int nKeys{0};\n+    unsigned int nCKeys{0};\n+    unsigned int nWatchKeys{0};\n+    unsigned int nKeyMeta{0};\n+    unsigned int m_unknown_records{0};\n+    bool fIsEncrypted{false};\n+    bool fAnyUnordered{false};\n+    std::vector<uint256> vWalletUpgrade;\n+    std::map<OutputType, uint256> m_active_external_spks;\n+    std::map<OutputType, uint256> m_active_internal_spks;\n+    std::map<uint256, DescriptorCache> m_descriptor_caches;\n+    std::map<std::pair<uint256, CKeyID>, CKey> m_descriptor_keys;\n+    std::map<std::pair<uint256, CKeyID>, std::pair<CPubKey, std::vector<unsigned char>>> m_descriptor_crypt_keys;\n+\n+    CWalletScanState() {\n+    }\n+};\n+\n+//! Unserialize a give Key-Value pair and load it into the wallet and wallet scan state\n+bool ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n+             CWalletScanState &wss, std::string& strType, std::string& strErr) EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r427423048",
      "id" : 427423048,
      "in_reply_to_id" : 427420606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQyMzA0OA==",
      "original_commit_id" : "6c47d41779ec5b335acf75652228d541b7a5b67a",
      "original_line" : 322,
      "original_position" : 110,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.h",
      "position" : null,
      "pull_request_review_id" : 414603837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427423048",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure what's causing the travis failure. It seems to be caused for a non-existent fileid when `get_fileid` is called, but I can't figure out why that would be the case nor can I replicate it locally.",
      "created_at" : "2020-05-21T17:19:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-632235166",
      "id" : 632235166,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjIzNTE2Ng==",
      "updated_at" : "2020-05-21T17:19:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632235166",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Not sure what's causing the travis failure. It seems to be caused for a non-existent fileid when `get_fileid` is called, but I can't figure out why that would be the case nor can I replicate it locally.\r\n\r\n`get_fileid` should not be called in mock db (some older bdb version in Travis?)",
      "created_at" : "2020-05-26T13:22:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634021594",
      "id" : 634021594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDAyMTU5NA==",
      "updated_at" : "2020-05-26T13:23:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634021594",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> `get_fileid` should not be called in mock db\r\n\r\nAh, that's probably it. Thanks. Odd that I can't get the error locally though.\r\n\r\n> (some older bdb version in Travis?)\r\n\r\nIt's actually newer. Travis typically uses BDB provided by Ubuntu which is 5.3. I have 4.8 installed on my system.",
      "created_at" : "2020-05-26T18:52:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634211030",
      "id" : 634211030,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDIxMTAzMA==",
      "updated_at" : "2020-05-26T18:52:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634211030",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> It's actually newer. Travis typically uses BDB provided by Ubuntu which is 5.3. I have 4.8 installed on my system.\r\n\r\nI can't reproduce it either, bdb 5.3.28.",
      "created_at" : "2020-05-27T10:42:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#issuecomment-634578411",
      "id" : 634578411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18971",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDU3ODQxMQ==",
      "updated_at" : "2020-05-27T10:42:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634578411",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431230059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431230059"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Combine VerifyDatabaseFile and VerifyEnvironment\" (289aa21c6a6c11ce172a92f878a3ede6652fc2e4)\r\n\r\nHere and below filesystem_error is no longer caught. Would suggest adding it back to preserve error handling behavior (I could be missing something but it looks like BerkeleyEnvironment::Open could still throw this error)",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-27T15:26:21Z",
      "diff_hunk" : "@@ -3680,17 +3680,7 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n \n     // Keep same database environment instance across Verify/Recover calls below.\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n-\n-    try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n-    } catch (const fs::filesystem_error& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431230059",
      "id" : 431230059,
      "line" : 3688,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIzMDA1OQ==",
      "original_commit_id" : "289aa21c6a6c11ce172a92f878a3ede6652fc2e4",
      "original_line" : 3688,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 35,
      "pull_request_review_id" : 419340191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431230059",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431245932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431245932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Move Db->open to BerkeleyDatabase::Open\" (d0ccd47c355319ec9709c52cdcdf0be78a26ac25)\r\n\r\nNote: seems like there two small changes to behavior here when IsDummy is true: CLIENT_VERSION is written and strFile member is set, but both changes seem good.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-27T15:46:34Z",
      "diff_hunk" : "@@ -351,13 +351,26 @@ void BerkeleyEnvironment::CheckpointLSN(const std::string& strFile)\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr)\n {\n+    database.Open(pszMode);\n     fReadOnly = (!strchr(pszMode, '+') && !strchr(pszMode, 'w'));\n     fFlushOnClose = fFlushOnCloseIn;\n     env = database.env.get();\n-    if (database.IsDummy()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r431245932",
      "id" : 431245932,
      "line" : 368,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI0NTkzMg==",
      "original_commit_id" : "d0ccd47c355319ec9709c52cdcdf0be78a26ac25",
      "original_line" : 368,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 356,
      "pull_request_review_id" : 419340191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/431245932",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432114397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432114397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added it back.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-28T20:48:20Z",
      "diff_hunk" : "@@ -3680,17 +3680,7 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n \n     // Keep same database environment instance across Verify/Recover calls below.\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n-\n-    try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n-    } catch (const fs::filesystem_error& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432114397",
      "id" : 432114397,
      "in_reply_to_id" : 431230059,
      "line" : 3688,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjExNDM5Nw==",
      "original_commit_id" : "289aa21c6a6c11ce172a92f878a3ede6652fc2e4",
      "original_line" : 3688,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 35,
      "pull_request_review_id" : 420480068,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432114397",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432660562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432660562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nNote: Was looking into history of why the previous code was calling CheckUniqueFileid in a loop instead of doing a map lookup. Looks like it was done to keep changes minimal in https://github.com/bitcoin/bitcoin/pull/11687/commits/d8a99f65e53019becdd8d2631396012bafb29741 and avoid needing to change CheckUniqueFileid. Looping or mapping was never needed before that commit because only one environment at a time could be opened.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T18:22:45Z",
      "diff_hunk" : "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432660562",
      "id" : 432660562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2MDU2Mg==",
      "original_commit_id" : "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "original_line" : 425,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432660562",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432665557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432665557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nWould be good to add GUARDED_BY(cs_db) if possible",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T18:33:08Z",
      "diff_hunk" : "@@ -27,22 +27,7 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n-\n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n-    }\n-\n-    for (const auto& item : env.m_fileids) {\n-        if (fileid == item.second && &fileid != &item.second) {\n-            throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (duplicates fileid %s from %s)\", filename,\n-                HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n-        }\n-    }\n-}\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432665557",
      "id" : 432665557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2NTU1Nw==",
      "original_commit_id" : "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "original_line" : 30,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432665557",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432669086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432669086"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (79fe2edc4457ee70754b08d5e8d2309b86038395)\r\n\r\nThis is just a style comment, but there's already a lot going on in this method, and it might be nice to move this long comment and block of code out to a `void AddUniqueFileId(Db& db, const std::string& path)` helper function that gets file id, checks it and adds it to the map",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T18:40:46Z",
      "diff_hunk" : "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);\n+            m_file_path = (env->Directory() / strFile).string();\n+\n+            if (!env->IsMock()) {\n+                // Check that the BDB file id has not already been loaded in any BDB environment\n+                // to avoid BDB data consistency bugs that happen when different data\n+                // files in the same environment have the same fileid. All BDB environments are\n+                // checked to prevent bitcoin from opening the same data file through another\n+                // environment when the file is referenced through equivalent but\n+                // not obviously identical symlinked or hard linked or bind mounted\n+                // paths. In the future a more relaxed check for equal inode and\n+                // device ids could be done instead, which would allow opening\n+                // different backup copies of a wallet at the same time. Maybe even\n+                // more ideally, an exclusive lock for accessing the database could\n+                // be implemented, so no equality checks are needed at all. (Newer\n+                // versions of BDB have an set_lk_exclusive method for this\n+                // purpose, but the older version we use does not.)\n+                WalletDatabaseFileId fileid;\n+                int fileid_ret = pdb_temp->get_mpf()->get_fileid(fileid.value);\n+                if (fileid_ret != 0) {\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (get_fileid failed with %d)\", strFile, fileid_ret));\n+                }\n+                for (const auto& item : g_fileids) {\n+                    if (fileid == item.second && item.first != m_file_path) {\n+                        throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (duplicates fileid %s from %s)\", strFile,\n+                            HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n+                    }\n+                }\n+                g_fileids[m_file_path] = fileid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432669086",
      "id" : 432669086,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY2OTA4Ng==",
      "original_commit_id" : "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "original_line" : 420,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432669086",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432677500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432677500"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Add BerkeleyDatabase::Release\" (bd13bec012a56447e0dae9e46ba3693bcc2b561d)\r\n\r\nNote: Maybe this comment could be extended to say how Release should be used. The commit message has a longer comment, but I'm not sure I understand it. Particularly: \"Flush can be done before Release, and Close after.\" I don't see how calling close after release could be safe because it it would decrement the use count twice. Is the idea that caller should do something like Open Change Release, Open Change Release, Open Change Close? It'd be good to have some kind of RAII WalletBatch type class to force correct usage, if something like this isn't already added later",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T18:58:22Z",
      "diff_hunk" : "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432677500",
      "id" : 432677500,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY3NzUwMA==",
      "original_commit_id" : "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "original_line" : 149,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432677500",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432686357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432686357"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nWhy is this calling g_dbenvs.erase? It seems like it is redundant with env = nullptr assignment below which should trigger erasing in BerkeleyEnvironment::~BerkeleyEnvironment destructor. It also seems unsafe if there's another database open in the same environment.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T19:18:46Z",
      "diff_hunk" : "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432686357",
      "id" : 432686357,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY4NjM1Nw==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 365,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432686357",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432690287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432690287"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nQ: If there are multiple databases open in the same environment, previously logs would be consolidated and removed if any database was closed and no other database was writing, but now it will not consolidate logs until the last database in the environment is closed? This seems fine, but it would be good if the commit message was clearer about what the exact change in behavior is since this doesn't seem purely like a refactoring.\r\n\r\nAlso, maybe the commit could be split up. It seems like log consolidation code moving from here to the environment destructor could be done independently of the flush/close api change. I could be missing the connection, though.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T19:28:01Z",
      "diff_hunk" : "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432690287",
      "id" : 432690287,
      "line" : 639,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5MDI4Nw==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 639,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 628,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432690287",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432694132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432694132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Change BerkeleyDatabase::Flush to Close\" (1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71)\r\n\r\nTodo was actually already implemented and should be dropped. It was added in 2d796faf62095e83f74337c26e7e1a8c3957cf3c https://github.com/bitcoin/bitcoin/pull/14320#discussion_r227811095 and implemented in f1f4bb7345b90853ec5037478173601035593d26 #11911",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T19:36:58Z",
      "diff_hunk" : "@@ -720,22 +728,16 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n     }\n }\n \n-void BerkeleyDatabase::Flush(bool shutdown)\n+void BerkeleyDatabase::Close()\n {\n     if (!IsDummy()) {\n-        env->Flush(shutdown);\n-        if (shutdown) {\n-            LOCK(cs_db);\n-            g_dbenvs.erase(env->Directory().string());\n-            env = nullptr;\n-        } else {\n-            // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the\n-            // first database shutdown when multiple databases are open in the same\n-            // environment, should replace raw database `env` pointers with shared or weak\n-            // pointers, or else separate the database and environment shutdowns so\n-            // environments can be shut down after databases.\n-            g_fileids.erase(m_file_path);\n-        }\n+        env->Flush();\n+        // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432694132",
      "id" : 432694132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjY5NDEzMg==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 735,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432694132",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432704579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432704579"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9cfb631f808aa6ccb10ab31d4b8325bd940a8916)\r\n\r\nWhat's this doing? It seems like either this should already be 0 or it would be unsafe to overwrite if not already 0",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T19:53:37Z",
      "diff_hunk" : "@@ -652,30 +646,23 @@ bool BerkeleyDatabase::PeriodicFlush()\n     {\n         // Don't do this if any databases are in use\n         int nRefCount = 0;\n-        std::map<std::string, int>::iterator mit = env->mapFileUseCount.begin();\n-        while (mit != env->mapFileUseCount.end())\n-        {\n-            nRefCount += (*mit).second;\n-            mit++;\n+        for (auto& db_it : env->m_databases) {\n+            nRefCount += db_it.second.get().m_refcount;\n         }\n \n         if (nRefCount == 0)\n         {\n             boost::this_thread::interruption_point();\n-            std::map<std::string, int>::iterator mi = env->mapFileUseCount.find(strFile);\n-            if (mi != env->mapFileUseCount.end())\n-            {\n-                LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n-                int64_t nStart = GetTimeMillis();\n+            LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n+            int64_t nStart = GetTimeMillis();\n \n-                // Flush wallet file so it's self contained\n-                env->CloseDb(strFile);\n-                env->CheckpointLSN(strFile);\n+            // Flush wallet file so it's self contained\n+            env->CloseDb(strFile);\n+            env->CheckpointLSN(strFile);\n \n-                env->mapFileUseCount.erase(mi++);\n-                LogPrint(BCLog::WALLETDB, \"Flushed %s %dms\\n\", strFile, GetTimeMillis() - nStart);\n-                ret = true;\n-            }\n+            m_refcount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432704579",
      "id" : 432704579,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwNDU3OQ==",
      "original_commit_id" : "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "original_line" : 663,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432704579",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432708264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432708264"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (9cfb631f808aa6ccb10ab31d4b8325bd940a8916)\r\n\r\nNote: seems this commit drops distinction between use count being 0 and use count not existing (no map entry). I think 0 use count meant the database wasn't in use but wasn't flushed yet, and no use count meant it was flushed. I think the last piece of code which used this distinction was the log_archive code removed in the previous commit 1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-29T20:01:52Z",
      "diff_hunk" : "@@ -531,11 +529,10 @@ bool BerkeleyBatch::Rewrite(BerkeleyDatabase& database, const char* pszSkip)\n     while (true) {\n         {\n             LOCK(cs_db);\n-            if (!env->mapFileUseCount.count(strFile) || env->mapFileUseCount[strFile] == 0) {\n+            if (database.m_refcount == 0) {\n                 // Flush log data to the dat file\n                 env->CloseDb(strFile);\n                 env->CheckpointLSN(strFile);\n-                env->mapFileUseCount.erase(strFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432708264",
      "id" : 432708264,
      "line" : 536,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjcwODI2NA==",
      "original_commit_id" : "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "original_line" : 536,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 525,
      "pull_request_review_id" : 421187137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432708264",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432987494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432987494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: assert as unreachable?",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-05-31T21:49:56Z",
      "diff_hunk" : "@@ -3682,15 +3682,11 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n \n     try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n+        return database->Verify(error_string);\n     } catch (const fs::filesystem_error& e) {\n         error_string = Untranslated(strprintf(\"Error loading wallet %s. %s\", location.GetName(), fsbridge::get_filesystem_error_message(e)));\n         return false;\n     }\n-\n-    return WalletBatch::VerifyDatabaseFile(wallet_path, error_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432987494",
      "id" : 432987494,
      "line" : 3693,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk4NzQ5NA==",
      "original_commit_id" : "4decfab19f26cf21be6da1a371220e918c0d2dc8",
      "original_line" : 3693,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 40,
      "pull_request_review_id" : 421530443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432987494",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432999447"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432999447"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this is unused",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T00:16:40Z",
      "diff_hunk" : "@@ -141,10 +142,14 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::vector<bilingual_str> warnings;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432999447",
      "id" : 432999447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5OTQ0Nw==",
      "original_commit_id" : "f06619ecd41d08484e02e41fc06a840b9057fcb6",
      "original_line" : 145,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 421542040,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/432999447",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433411606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433411606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you are confusing `BerkeleyBatch` and `BerkeleyDatabase`. `Release` is called by `BerkeleyBatch::Close`, not `BerkeleyDatabase::Close`.\r\n\r\nIn a later commit, a corresponding `Acquire` function is added. In this commit, the thing that `Acquire` does is part of `Open`. The idea with the refcount is thusly: when something tries to use the database, it increments the refcount. When it is done, it decrements the refcount. The goal is to prevent the database from closing while something is still using the database. When `WalletBatch` is initialized, it calls `BerkeleyDatabase::Open` via `BerkeleyBatch`'s constructor. When `WalletBatch` is done and no longer being used, it calls `BerkeleyBatch::Close` which calls `BerkeleyDatabase::Release`. Then both the `BerkeleyBatch` and `WalletBatch` are destructed. The `BerkeleyDatabase` remains open so that future uses of the database don't need to reopen it and for other concurrent `WalletBatch`s to do their work.\r\n\r\nSo the flow with `BerkeleyDatabase` is `Open`, changes, `Release`, `Close`.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T18:28:29Z",
      "diff_hunk" : "@@ -143,9 +143,12 @@ class BerkeleyDatabase\n         return MakeUnique<BerkeleyDatabase>(std::make_shared<BerkeleyEnvironment>(), \"\");\n     }\n \n-    /** Open the database if it is not already opened */\n+    /** Open the database if it is not already opened. Increments mapFileUseCount */\n     void Open(const char* mode);\n \n+    /** Indicate that database user has stopped using the database. Decrement mapFileUseCount */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433411606",
      "id" : 433411606,
      "in_reply_to_id" : 432677500,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMTYwNg==",
      "original_commit_id" : "bd13bec012a56447e0dae9e46ba3693bcc2b561d",
      "original_line" : 149,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/db.h",
      "position" : null,
      "pull_request_review_id" : 422080385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433411606",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433417571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433417571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not entirely sure, but this is moved code.\r\n\r\nThis was originally called during `BerkeleyDatabase::Flush(true)`, i.e. when the database and environment are being closed. So I moved it into the destructor to go along with the other environment closing changes.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T18:39:57Z",
      "diff_hunk" : "@@ -350,6 +355,18 @@ BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bo\n     }\n }\n \n+BerkeleyDatabase::~BerkeleyDatabase()\n+{\n+    Close();\n+    if (env) {\n+        LOCK(cs_db);\n+        size_t erased = env->m_databases.erase(strFile);\n+        assert(erased == 1);\n+        g_dbenvs.erase(env->Directory().string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433417571",
      "id" : 433417571,
      "in_reply_to_id" : 432686357,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxNzU3MQ==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 365,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 422087985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433417571",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433425570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433425570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Q: If there are multiple databases open in the same environment, previously logs would be consolidated and removed if any database was closed and no other database was writing, but now it will not consolidate logs until the last database in the environment is closed?\r\n\r\nI don't think that's what happened previously either. `Flush(true)` seems to have been only called during a bitcoind shutdown, not during typical wallet unloading. So previously, even after a wallet was unloaded, it's log files were never consolidated and removed. So this behavior ends up being retained. I don't think there is a behavior change here, although the it is difficult to work out exactly when the database and environment are actually being flushed and closed.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T18:55:04Z",
      "diff_hunk" : "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433425570",
      "id" : 433425570,
      "in_reply_to_id" : 432690287,
      "line" : 639,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQyNTU3MA==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 639,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 628,
      "pull_request_review_id" : 422098277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433425570",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433435981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433435981"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:16:31Z",
      "diff_hunk" : "@@ -27,22 +27,7 @@ namespace {\n //! (https://docs.oracle.com/cd/E17275_01/html/programmer_reference/program_copy.html),\n //! so bitcoin should never create different databases with the same fileid, but\n //! this error can be triggered if users manually copy database files.\n-void CheckUniqueFileid(const BerkeleyEnvironment& env, const std::string& filename, Db& db, WalletDatabaseFileId& fileid)\n-{\n-    if (env.IsMock()) return;\n-\n-    int ret = db.get_mpf()->get_fileid(fileid.value);\n-    if (ret != 0) {\n-        throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (get_fileid failed with %d)\", filename, ret));\n-    }\n-\n-    for (const auto& item : env.m_fileids) {\n-        if (fileid == item.second && &fileid != &item.second) {\n-            throw std::runtime_error(strprintf(\"BerkeleyBatch: Can't open database %s (duplicates fileid %s from %s)\", filename,\n-                HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n-        }\n-    }\n-}\n+std::unordered_map<std::string, WalletDatabaseFileId> g_fileids;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433435981",
      "id" : 433435981,
      "in_reply_to_id" : 432665557,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNTk4MQ==",
      "original_commit_id" : "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "original_line" : 30,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 422111876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433435981",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:16:37Z",
      "diff_hunk" : "@@ -405,24 +390,34 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n-\n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {\n-                CheckUniqueFileid(*env.second.lock().get(), strFile, *pdb_temp, this->env->m_fileids[strFile]);\n+            m_file_path = (env->Directory() / strFile).string();\n+\n+            if (!env->IsMock()) {\n+                // Check that the BDB file id has not already been loaded in any BDB environment\n+                // to avoid BDB data consistency bugs that happen when different data\n+                // files in the same environment have the same fileid. All BDB environments are\n+                // checked to prevent bitcoin from opening the same data file through another\n+                // environment when the file is referenced through equivalent but\n+                // not obviously identical symlinked or hard linked or bind mounted\n+                // paths. In the future a more relaxed check for equal inode and\n+                // device ids could be done instead, which would allow opening\n+                // different backup copies of a wallet at the same time. Maybe even\n+                // more ideally, an exclusive lock for accessing the database could\n+                // be implemented, so no equality checks are needed at all. (Newer\n+                // versions of BDB have an set_lk_exclusive method for this\n+                // purpose, but the older version we use does not.)\n+                WalletDatabaseFileId fileid;\n+                int fileid_ret = pdb_temp->get_mpf()->get_fileid(fileid.value);\n+                if (fileid_ret != 0) {\n+                    throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (get_fileid failed with %d)\", strFile, fileid_ret));\n+                }\n+                for (const auto& item : g_fileids) {\n+                    if (fileid == item.second && item.first != m_file_path) {\n+                        throw std::runtime_error(strprintf(\"BerkeleyDatabase: Can't open database %s (duplicates fileid %s from %s)\", strFile,\n+                            HexStr(std::begin(item.second.value), std::end(item.second.value)), item.first));\n+                    }\n+                }\n+                g_fileids[m_file_path] = fileid;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436045",
      "id" : 433436045,
      "in_reply_to_id" : 432669086,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjA0NQ==",
      "original_commit_id" : "79fe2edc4457ee70754b08d5e8d2309b86038395",
      "original_line" : 420,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 422111945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436045",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436141"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436141"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed it",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:16:50Z",
      "diff_hunk" : "@@ -720,22 +728,16 @@ bool BerkeleyDatabase::Backup(const std::string& strDest) const\n     }\n }\n \n-void BerkeleyDatabase::Flush(bool shutdown)\n+void BerkeleyDatabase::Close()\n {\n     if (!IsDummy()) {\n-        env->Flush(shutdown);\n-        if (shutdown) {\n-            LOCK(cs_db);\n-            g_dbenvs.erase(env->Directory().string());\n-            env = nullptr;\n-        } else {\n-            // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the\n-            // first database shutdown when multiple databases are open in the same\n-            // environment, should replace raw database `env` pointers with shared or weak\n-            // pointers, or else separate the database and environment shutdowns so\n-            // environments can be shut down after databases.\n-            g_fileids.erase(m_file_path);\n-        }\n+        env->Flush();\n+        // TODO: To avoid g_dbenvs.erase erasing the environment prematurely after the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436141",
      "id" : 433436141,
      "in_reply_to_id" : 432694132,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjE0MQ==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 735,
      "original_position" : 105,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 422112081,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436141",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:16:57Z",
      "diff_hunk" : "@@ -652,30 +646,23 @@ bool BerkeleyDatabase::PeriodicFlush()\n     {\n         // Don't do this if any databases are in use\n         int nRefCount = 0;\n-        std::map<std::string, int>::iterator mit = env->mapFileUseCount.begin();\n-        while (mit != env->mapFileUseCount.end())\n-        {\n-            nRefCount += (*mit).second;\n-            mit++;\n+        for (auto& db_it : env->m_databases) {\n+            nRefCount += db_it.second.get().m_refcount;\n         }\n \n         if (nRefCount == 0)\n         {\n             boost::this_thread::interruption_point();\n-            std::map<std::string, int>::iterator mi = env->mapFileUseCount.find(strFile);\n-            if (mi != env->mapFileUseCount.end())\n-            {\n-                LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n-                int64_t nStart = GetTimeMillis();\n+            LogPrint(BCLog::WALLETDB, \"Flushing %s\\n\", strFile);\n+            int64_t nStart = GetTimeMillis();\n \n-                // Flush wallet file so it's self contained\n-                env->CloseDb(strFile);\n-                env->CheckpointLSN(strFile);\n+            // Flush wallet file so it's self contained\n+            env->CloseDb(strFile);\n+            env->CheckpointLSN(strFile);\n \n-                env->mapFileUseCount.erase(mi++);\n-                LogPrint(BCLog::WALLETDB, \"Flushed %s %dms\\n\", strFile, GetTimeMillis() - nStart);\n-                ret = true;\n-            }\n+            m_refcount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436200",
      "id" : 433436200,
      "in_reply_to_id" : 432704579,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjIwMA==",
      "original_commit_id" : "9cfb631f808aa6ccb10ab31d4b8325bd940a8916",
      "original_line" : 663,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : null,
      "pull_request_review_id" : 422112156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436200",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also split this commit as you suggested.",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:17:10Z",
      "diff_hunk" : "@@ -619,17 +637,7 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n             } else\n                 mi++;\n         }\n-        LogPrint(BCLog::WALLETDB, \"BerkeleyEnvironment::Flush: Flush(%s)%s took %15dms\\n\", fShutdown ? \"true\" : \"false\", fDbEnvInit ? \"\" : \" database not started\", GetTimeMillis() - nStart);\n-        if (fShutdown) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436314",
      "id" : 433436314,
      "in_reply_to_id" : 432690287,
      "line" : 639,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjMxNA==",
      "original_commit_id" : "1dbc24d27d4b54b45c6b49ba41b4f64d0093dd71",
      "original_line" : 639,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/wallet/db.cpp",
      "position" : 628,
      "pull_request_review_id" : 422112303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436314",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:17:17Z",
      "diff_hunk" : "@@ -3682,15 +3682,11 @@ bool CWallet::Verify(interfaces::Chain& chain, const WalletLocation& location, b\n     std::unique_ptr<WalletDatabase> database = WalletDatabase::Create(wallet_path);\n \n     try {\n-        if (!WalletBatch::VerifyEnvironment(wallet_path, error_string)) {\n-            return false;\n-        }\n+        return database->Verify(error_string);\n     } catch (const fs::filesystem_error& e) {\n         error_string = Untranslated(strprintf(\"Error loading wallet %s. %s\", location.GetName(), fsbridge::get_filesystem_error_message(e)));\n         return false;\n     }\n-\n-    return WalletBatch::VerifyDatabaseFile(wallet_path, error_string);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436356",
      "id" : 433436356,
      "in_reply_to_id" : 432987494,
      "line" : 3693,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjM1Ng==",
      "original_commit_id" : "4decfab19f26cf21be6da1a371220e918c0d2dc8",
      "original_line" : 3693,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 40,
      "pull_request_review_id" : 422112361,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:17:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436356",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Removed",
      "commit_id" : "3745ffc627275e60bd4e2dc04117d3e59e9dbea2",
      "created_at" : "2020-06-01T19:17:24Z",
      "diff_hunk" : "@@ -141,10 +142,14 @@ bool ExecuteWalletToolFunc(const std::string& command, const std::string& name)\n             return false;\n         }\n         bilingual_str error;\n-        if (!WalletBatch::VerifyEnvironment(path, error)) {\n+        std::vector<bilingual_str> warnings;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18971#discussion_r433436421",
      "id" : 433436421,
      "in_reply_to_id" : 432999447,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQzNjQyMQ==",
      "original_commit_id" : "f06619ecd41d08484e02e41fc06a840b9057fcb6",
      "original_line" : 145,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/wallettool.cpp",
      "position" : null,
      "pull_request_review_id" : 422112433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18971",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-01T19:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/433436421",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
