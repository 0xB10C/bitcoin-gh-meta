[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18600 ([wallet] Track conflicted transactions removed from mempool and fix UI notifications by ariard)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n* #17443 (Drop checkFinalTx and use Median Time Past to check finality of wallet transactions by ariard)\n* #15719 (Drop Chain::requestMempoolTransactions method by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-15T13:58:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#issuecomment-629251455",
      "id" : 629251455,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18982",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTI1MTQ1NQ==",
      "updated_at" : "2020-05-15T23:18:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629251455",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427797119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427797119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we can dry-up MemPoolRemovalReason completely in the future. The only control flow pending on it I can see is in `removeUnchecked` and it's only consumed by `TransactionRemovedFromMempool`\r\n",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-20T07:29:25Z",
      "diff_hunk" : "@@ -21,6 +21,7 @@ class CConnman;\n class CValidationInterface;\n class uint256;\n class CScheduler;\n+enum class MemPoolRemovalReason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427797119",
      "id" : 427797119,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5NzExOQ==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 24,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 415061702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:43:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427797119",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427799161"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain which one are going to updated with CONFLICTED status and which not, i.e transactions not directly connected to a previous wallet transaction ?",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-20T07:33:19Z",
      "diff_hunk" : "@@ -1111,12 +1112,37 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    // Handle transactions that were removed from the mempool because they\n+    // conflict with transactions in a newly connected block.\n+    if (reason == MemPoolRemovalReason::CONFLICT) {\n+        // Call SyncNotifications, so external -walletnotify notifications will\n+        // be triggered for these transactions. Set Status::UNCONFIRMED instead\n+        // of Status::CONFLICTED for a few reasons:\n+        //\n+        // 1. The transactionRemovedFromMempool callback does not currently\n+        //    provide the conflicting block's hash and height, and for backwards\n+        //    compatibility reasons it may not be not safe to store conflicted\n+        //    wallet transactions with a null block hash. See\n+        //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.\n+        // 2. For most of these transactions, wallet internal conflict detection",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799161",
      "id" : 427799161,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5OTE2MQ==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 1133,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 415061702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:43:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427799161",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427799842"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, document that conflict transaction tracking will always be a best-effort, an unconfirmed transaction may be removed while wallet is shutdown an therefore never getting the notification.",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-20T07:34:42Z",
      "diff_hunk" : "@@ -1111,12 +1112,37 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    // Handle transactions that were removed from the mempool because they\n+    // conflict with transactions in a newly connected block.\n+    if (reason == MemPoolRemovalReason::CONFLICT) {\n+        // Call SyncNotifications, so external -walletnotify notifications will\n+        // be triggered for these transactions. Set Status::UNCONFIRMED instead\n+        // of Status::CONFLICTED for a few reasons:\n+        //\n+        // 1. The transactionRemovedFromMempool callback does not currently\n+        //    provide the conflicting block's hash and height, and for backwards\n+        //    compatibility reasons it may not be not safe to store conflicted\n+        //    wallet transactions with a null block hash. See\n+        //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.\n+        // 2. For most of these transactions, wallet internal conflict detection\n+        //    and MarkConflicted logic will subsequently update them with\n+        //    CONFLICTED status anyway.\n+        // 3. Longstanding behavior since the sync implementation in\n+        //    https://github.com/bitcoin/bitcoin/pull/9371 and the prior sync\n+        //    implementation before that was to mark these transactions\n+        //    unconfirmed rather than conflicted.\n+        //\n+        // The wallet's heuristics for distinguishing between conflicted and\n+        // unconfirmed transactions are imperfect, so everything described above\n+        // could be rethought and changed in the future.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799842",
      "id" : 427799842,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc5OTg0Mg==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 1143,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 415061702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:43:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427799842",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428360222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428360222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427797119\r\n\r\n> I think we can dry-up MemPoolRemovalReason completely in the future. The only control flow pending on it I can see is in `removeUnchecked` and it's only consumed by `TransactionRemovedFromMempool`\r\n\r\nI'm open to removing MemPoolRemovalReason in the future if it simplifies code, hopefully without losing debug or logging benefits or code clarity from using custom enum values instead of generic true/false values",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-20T23:16:46Z",
      "diff_hunk" : "@@ -21,6 +21,7 @@ class CConnman;\n class CValidationInterface;\n class uint256;\n class CScheduler;\n+enum class MemPoolRemovalReason;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428360222",
      "id" : 428360222,
      "in_reply_to_id" : 427797119,
      "line" : 24,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2MDIyMg==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 24,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validationinterface.h",
      "position" : 4,
      "pull_request_review_id" : 415777984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428360222",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428360339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428360339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799842\r\n\r\n> Also, document that conflict transaction tracking will always be a best-effort, an unconfirmed transaction may be removed while wallet is shutdown an therefore never getting the notification.\r\n\r\nThe shutdown thing seems like a good thing to document, but this doesn't seem like a great place to document it. This comment, which is already pretty long, is just trying to say why this piece of code is written this way, and say that it isn't unchangeable without getting into how future improvements need to work.\r\n\r\nBut I made a new devwiki page https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking, and added a link here that I think would be a good place to document complications from shutdown. By the way,\r\nI'm not sure if shutdowns would be the main cause of problems in practice, since startup block and mempool rescanning is pretty good and there's a whole other set of problems that comes from the wallet having incomplete information about ancestors and whether wallet transactions are related to block and mempool transactions, which is even worse for detecting conflicted -> unconfimed transitions than for detecting unconfirmed -> conflicted transitions.",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-20T23:17:11Z",
      "diff_hunk" : "@@ -1111,12 +1112,37 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    // Handle transactions that were removed from the mempool because they\n+    // conflict with transactions in a newly connected block.\n+    if (reason == MemPoolRemovalReason::CONFLICT) {\n+        // Call SyncNotifications, so external -walletnotify notifications will\n+        // be triggered for these transactions. Set Status::UNCONFIRMED instead\n+        // of Status::CONFLICTED for a few reasons:\n+        //\n+        // 1. The transactionRemovedFromMempool callback does not currently\n+        //    provide the conflicting block's hash and height, and for backwards\n+        //    compatibility reasons it may not be not safe to store conflicted\n+        //    wallet transactions with a null block hash. See\n+        //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.\n+        // 2. For most of these transactions, wallet internal conflict detection\n+        //    and MarkConflicted logic will subsequently update them with\n+        //    CONFLICTED status anyway.\n+        // 3. Longstanding behavior since the sync implementation in\n+        //    https://github.com/bitcoin/bitcoin/pull/9371 and the prior sync\n+        //    implementation before that was to mark these transactions\n+        //    unconfirmed rather than conflicted.\n+        //\n+        // The wallet's heuristics for distinguishing between conflicted and\n+        // unconfirmed transactions are imperfect, so everything described above\n+        // could be rethought and changed in the future.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428360339",
      "id" : 428360339,
      "in_reply_to_id" : 427799842,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM2MDMzOQ==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 1143,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 415777984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428360339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428438413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428438413"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18982#discussion_r427799161\r\n\r\n> Can you explain which one are going to updated with CONFLICTED status and which not, i.e transactions not directly connected to a previous wallet transaction ?\r\n\r\nSure, added more details",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-21T04:28:41Z",
      "diff_hunk" : "@@ -1111,12 +1112,37 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    // Handle transactions that were removed from the mempool because they\n+    // conflict with transactions in a newly connected block.\n+    if (reason == MemPoolRemovalReason::CONFLICT) {\n+        // Call SyncNotifications, so external -walletnotify notifications will\n+        // be triggered for these transactions. Set Status::UNCONFIRMED instead\n+        // of Status::CONFLICTED for a few reasons:\n+        //\n+        // 1. The transactionRemovedFromMempool callback does not currently\n+        //    provide the conflicting block's hash and height, and for backwards\n+        //    compatibility reasons it may not be not safe to store conflicted\n+        //    wallet transactions with a null block hash. See\n+        //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.\n+        // 2. For most of these transactions, wallet internal conflict detection",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r428438413",
      "id" : 428438413,
      "in_reply_to_id" : 427799161,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQzODQxMw==",
      "original_commit_id" : "90118ec54f6921ed102ef45bb4f4d3a0ac8782b8",
      "original_line" : 1133,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 415777984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T11:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428438413",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "(requested @jonatack as reviewer to help with documentation, since a lot is added here, and it'd be good to know if it makes sense to someone not in the weeds of transaction state tracking)",
      "created_at" : "2020-05-21T11:53:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#issuecomment-632045253",
      "id" : 632045253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18982",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjA0NTI1Mw==",
      "updated_at" : "2020-05-21T11:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632045253",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429295636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429295636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: remove EOL comma, otherwise some people following the link may end up here :)\r\n\r\n![Screenshot from 2020-05-22 16-50-24](https://user-images.githubusercontent.com/2415484/82680590-05f2f200-9c3c-11ea-81f8-fd2438d3a832.jpg)\r\n",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-22T14:54:23Z",
      "diff_hunk" : "@@ -1111,12 +1112,42 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    // Handle transactions that were removed from the mempool because they\n+    // conflict with transactions in a newly connected block.\n+    if (reason == MemPoolRemovalReason::CONFLICT) {\n+        // Call SyncNotifications, so external -walletnotify notifications will\n+        // be triggered for these transactions. Set Status::UNCONFIRMED instead\n+        // of Status::CONFLICTED for a few reasons:\n+        //\n+        // 1. The transactionRemovedFromMempool callback does not currently\n+        //    provide the conflicting block's hash and height, and for backwards\n+        //    compatibility reasons it may not be not safe to store conflicted\n+        //    wallet transactions with a null block hash. See\n+        //    https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993.\n+        // 2. For most of these transactions, the wallet's internal conflict\n+        //    detection in the blockConnected handler will subsequently call\n+        //    MarkConflicted and update them with CONFLICTED status anyway. This\n+        //    applies to any wallet transaction that has inputs spent in the\n+        //    block, or that has ancestors in the wallet with inputs spent by\n+        //    the block.\n+        // 3. Longstanding behavior since the sync implementation in\n+        //    https://github.com/bitcoin/bitcoin/pull/9371 and the prior sync\n+        //    implementation before that was to mark these transactions\n+        //    unconfirmed rather than conflicted.\n+        //\n+        // Nothing described above should be seen as an unchangeable requirement\n+        // when improving this code in the future. The wallet's heuristics for\n+        // distinguishing between conflicted and unconfirmed transactions are\n+        // imperfect, and could be improved in general, see\n+        // https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429295636",
      "id" : 429295636,
      "line" : 1148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI5NTYzNg==",
      "original_commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "original_line" : 1148,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 416974841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T16:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429295636",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429309505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429309505"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: is `ptx` a pointer?\r\n```diff\r\n-const CTransactionRef &ptx\r\n+const CTransactionRef& tx\r\n```\r\n",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-22T15:19:57Z",
      "diff_hunk" : "@@ -208,9 +208,9 @@ void CMainSignals::TransactionAddedToMempool(const CTransactionRef &ptx) {\n                           ptx->GetWitnessHash().ToString());\n }\n \n-void CMainSignals::TransactionRemovedFromMempool(const CTransactionRef &ptx) {\n-    auto event = [ptx, this] {\n-        m_internals->Iterate([&](CValidationInterface& callbacks) { callbacks.TransactionRemovedFromMempool(ptx); });\n+void CMainSignals::TransactionRemovedFromMempool(const CTransactionRef &ptx, MemPoolRemovalReason reason) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429309505",
      "id" : 429309505,
      "line" : 211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMwOTUwNQ==",
      "original_commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "original_line" : 211,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/validationinterface.cpp",
      "position" : 7,
      "pull_request_review_id" : 416974841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T16:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429309505",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429317905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429317905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: suggested nicety while touching this code, at lines 1106 and 1178:\r\n```diff\r\n- CWalletTx::Confirmation confirm(CWalletTx::Status::UNCONFIRMED, /* block_height */ 0, {}, /* nIndex */ 0);\r\n+ CWalletTx::Confirmation confirm(CWalletTx::Status::UNCONFIRMED, /* block_height */ 0, /* hashBlock= */ {}, /* nIndex */ 0);\r\n```\r\n",
      "commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "created_at" : "2020-05-22T15:36:07Z",
      "diff_hunk" : "@@ -1129,7 +1160,7 @@ void CWallet::blockConnected(const CBlock& block, int height)\n     for (size_t index = 0; index < block.vtx.size(); index++) {\n         CWalletTx::Confirmation confirm(CWalletTx::Status::CONFIRMED, height, block_hash, index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#discussion_r429317905",
      "id" : 429317905,
      "line" : 1161,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTMxNzkwNQ==",
      "original_commit_id" : "8242b093d3db52b7e443d650bafd307a03527639",
      "original_line" : 1161,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 54,
      "pull_request_review_id" : 416974841,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18982",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T16:19:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429317905",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Also, AFAICT the added documentation in this PR coherently describes what the code is doing.",
      "created_at" : "2020-05-22T16:25:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18982#issuecomment-632782318",
      "id" : 632782318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18982",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjc4MjMxOA==",
      "updated_at" : "2020-05-22T16:25:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632782318",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
