[
   {
      "author_association" : "MEMBER",
      "body" : "This takes a different approach from the caching in #16442. I prefer it because it isolates all of the caching logic inside the indexer rather than in net processing. I'll put the other approach up as a different branch for comparison.",
      "created_at" : "2020-05-12T15:06:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627403715",
      "id" : 627403715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzQwMzcxNQ==",
      "updated_at" : "2020-05-12T15:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627403715",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r423819184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423819184"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there any particular reason for limiting the size of the cache? With this numbers it would be full at block 2000000, i.e. in (2000000-630000)/(6 * 24 * 365) ~ 26 years.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-12T15:18:56Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r423819184",
      "id" : 423819184,
      "line" : 35,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxOTE4NA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 35,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 5,
      "pull_request_review_id" : 410152048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-12T15:21:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423819184",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424002630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424002630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wanted to have some limit so that a bug doesn't turn into a memory exhaustion possibility (since we only ever add to this map, and never remove). I don't think the exact number matters. Presumably in 26 years, anyone who wants to serve compact block filters from a v0.21 Bitcoin Core server will be able to patch their own code.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-12T20:08:44Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424002630",
      "id" : 424002630,
      "in_reply_to_id" : 423819184,
      "line" : 35,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMjYzMA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 35,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 5,
      "pull_request_review_id" : 410383758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-12T20:08:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424002630",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18876 ([WIP] Serve BIP 157 compact filters by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-13T07:52:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627814619",
      "id" : 627814619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzgxNDYxOQ==",
      "updated_at" : "2020-05-13T07:52:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627814619",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424364005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424364005"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree that when in doubt, it's better to be overcautious than risking introducing a memory exhaustion bug -- I just wanted to get sure there are no other reasons for the limit that I'm not aware of.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T11:26:57Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424364005",
      "id" : 424364005,
      "in_reply_to_id" : 423819184,
      "line" : 35,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM2NDAwNQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 35,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 5,
      "pull_request_review_id" : 410830038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T11:26:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424364005",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm almost ready for ACKing this PR, just have some minor suggestion/discussion points:\r\n- Would it make sense to also only check the cache if we have checkpoints, i.e. a method structure like\r\n```\r\nbool is_checkpoint = (block_index->nHeight % CFCHECKPT_INTERVAL == 0); \r\nif (is_checkpoint)\r\n    // Check the headers cache\r\n\r\n// Regular lookup\r\n\r\nif (is_checkpoint)\r\n    // Add to the headers cache\r\n```\r\n? Of course, the drawback of this approach is that the condition for checking needs to be removed if the cache is ever used for other filter headers than those from the checkpoints. Also not sure if its really worth it from a performance point of view. But in 999 out of 1000 times the lookup in the map could be skipped.\r\n- In the regular case the cache should never get full, considering that this would by plan only happen in the far future (block 2000000, >25 years from now, with the current maximum size constant of 2000). If it gets full however, should we take some action like putting a debug output or even an assert, to get noticed that we either have some memory exhaustion bug or that the maximum size needs to be increased?\r\n- Any idea how to effectively test performance improvements like this? I don't know anything better than just putting some `LogPrintf`s in the cache hit / cache add cases, run the (maybe slightly modified) functional test and analyze the log output to check if it behaves as expected.",
      "created_at" : "2020-05-13T12:10:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627939760",
      "id" : 627939760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzkzOTc2MA==",
      "updated_at" : "2020-05-13T12:13:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627939760",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424406311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424406311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    Mutex m_cs_headers_cache;\r\n```\r\n\r\nnit (feel free to ignore). I haven't tested this, but from reading the code, a non-recursive mutex should be sufficient.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T12:43:33Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    RecursiveMutex m_cs_headers_cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424406311",
      "id" : 424406311,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNjMxMQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 36,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : 14,
      "pull_request_review_id" : 410883693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T12:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424406311",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424507108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424507108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a very minor issue but if we use the hash instead of the height as the key we could end up with headers of orphaned blocks in the cache since they will not be overridden or removed. This could also be the case if `CFCHECKPT_INTERVAL` would ever change. I know the chances for that happening are slim and if it happens we can deal with it then, just wanted to put it there.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T14:59:39Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424507108",
      "id" : 424507108,
      "line" : 413,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNzEwOA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 35,
      "pull_request_review_id" : 411014712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T15:31:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424507108",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424637193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424637193"
         }
      },
      "author_association" : "NONE",
      "body" : "The test suite explicitly checks that filters for stale blocks may still be fetched.\r\n\r\nhttps://github.com/jnewbery/bitcoin/blob/2020-05-cfcheckpts-cache/test/functional/p2p_blockfilters.py#L89-L101",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T18:14:51Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424637193",
      "id" : 424637193,
      "in_reply_to_id" : 424507108,
      "line" : 413,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNzE5Mw==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 35,
      "pull_request_review_id" : 411180373,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T18:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424637193",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1562417?v=4",
         "events_url" : "https://api.github.com/users/clarkmoody/events{/privacy}",
         "followers_url" : "https://api.github.com/users/clarkmoody/followers",
         "following_url" : "https://api.github.com/users/clarkmoody/following{/other_user}",
         "gists_url" : "https://api.github.com/users/clarkmoody/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/clarkmoody",
         "id" : 1562417,
         "login" : "clarkmoody",
         "node_id" : "MDQ6VXNlcjE1NjI0MTc=",
         "organizations_url" : "https://api.github.com/users/clarkmoody/orgs",
         "received_events_url" : "https://api.github.com/users/clarkmoody/received_events",
         "repos_url" : "https://api.github.com/users/clarkmoody/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/clarkmoody/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/clarkmoody/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/clarkmoody"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424643299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424643299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "doesn't this statically cap (and freeze forever) the cache after inserting 2000 entries? Wouldn't it make sense to have some sort of invalidation logic? (I can't come up with a good one though)",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T18:24:51Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424643299",
      "id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzI5OQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411187904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T18:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424643299",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-05-13T18:25:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628166454",
      "id" : 628166454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODE2NjQ1NA==",
      "updated_at" : "2020-05-13T18:25:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628166454",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If someone can mine enough blocks to fill up this cache, we have other problems. I think an adversary needs to mine blocks in the order of the 2000th triangle number to fill this up.\r\n\r\nAnd when this cache is full due to natural reasons (in 20 years), disks will be fast enough that we won't need a cache.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T18:32:45Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648190",
      "id" : 424648190,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0ODE5MA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411193878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T18:32:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648190",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe disks are fast enough or smart enough with caching today already, so it might not be needed after all. A benchmark would be nice...",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T18:33:41Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648698",
      "id" : 424648698,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0ODY5OA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411194523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T18:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648698",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424651189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424651189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh. You'r right. \r\nI missed the `% CFCHECKPT_INTERVAL == 0`.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T18:38:10Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424651189",
      "id" : 424651189,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1MTE4OQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411197656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T18:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424651189",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> we could end up with headers of orphaned blocks in the cache\r\n\r\nCorrect. If there's a re-org across checkpoint block, then the disconnect block's filter header stays in the cache. That's an explicit design decision, since:\r\n- the cost is very small (32 bytes for header + map overhead so < 100 bytes)\r\n- it's an infrequent event\r\n- it saves on the complexity of having to recalculate the cache on re-orgs (eg compare with https://github.com/bitcoin-core-review-club/bitcoin/commit/af3bddfbdfb7de06d6e63a0a425da483c435521a#diff-eff7adeaec73a769788bb78858815c91R1258)\r\n\r\n> if CFCHECKPT_INTERVAL would ever change\r\n\r\nIn that case, we'd need to change the software, which would involve a stop/start. This is an in-memory cache so gets dropped on shutdown.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T19:29:50Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680456",
      "id" : 424680456,
      "in_reply_to_id" : 424507108,
      "line" : 413,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MDQ1Ng==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 35,
      "pull_request_review_id" : 411234636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T19:29:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680456",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. I'll change to `Mutex`.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T19:30:23Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    RecursiveMutex m_cs_headers_cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680741",
      "id" : 424680741,
      "in_reply_to_id" : 424406311,
      "line" : 36,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MDc0MQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 36,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : 14,
      "pull_request_review_id" : 411235010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T19:30:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680741",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424681368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424681368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remind me to change this to 4000 in 2026 :)\r\n\r\nI agree that a benchmark would be nice.",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T19:31:36Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424681368",
      "id" : 424681368,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MTM2OA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411235844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T19:31:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424681368",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424682225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424682225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```cpp\r\n// TODO change to 4000 in 2026\r\n```\r\n\r\n;)",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T19:33:17Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424682225",
      "id" : 424682225,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MjIyNQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411237025,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T19:33:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424682225",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424685028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424685028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops sorry, I meant 2046",
      "commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "created_at" : "2020-05-13T19:38:25Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424685028",
      "id" : 424685028,
      "in_reply_to_id" : 424643299,
      "line" : 412,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NTAyOA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 412,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 34,
      "pull_request_review_id" : 411240539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-13T19:38:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424685028",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
