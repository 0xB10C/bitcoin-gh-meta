[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this PR touches critical parts of the codebase, I think it deserves a thorough review. I'm going to go through the original PR (#16323) commit by commit and write down my notes here: https://docs.google.com/document/d/1tduRmqcvhdl3FRkmdnj0f3_fknXuIZ57R8zdCGHNt6k/edit?usp=sharing",
      "created_at" : "2020-05-13T18:27:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-628167453",
      "id" : 628167453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODE2NzQ1Mw==",
      "updated_at" : "2020-05-13T18:27:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628167453",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on newer #17479. `git-bisect`ing the `validationinterface_tests/unregister_all_during_call` says:\r\n\r\n```\r\n194935b1a2968b594a42cb880e30701dd2e2bc7c is the first bad commit\r\n```",
      "created_at" : "2020-05-18T21:49:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630453121",
      "id" : 630453121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ1MzEyMQ==",
      "updated_at" : "2020-05-18T21:49:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630453121",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rebased on newer #17479. `git-bisect`ing the `validationinterface_tests/unregister_all_during_call` says:\r\n> \r\n> ```\r\n> 194935b1a2968b594a42cb880e30701dd2e2bc7c is the first bad commit\r\n> ```\r\n\r\nTest was relying on the fact that BlockChecked as synchronous and that commit made it asynchronous. You can switch it to a different synchronous method:\r\n\r\n```diff\r\n--- a/src/test/validationinterface_tests.cpp\r\n+++ b/src/test/validationinterface_tests.cpp\r\n@@ -57,15 +57,13 @@ public:\r\n     {\r\n         if (m_on_destroy) m_on_destroy();\r\n     }\r\n-    void BlockChecked(const CBlock& block, const BlockValidationState& state) override\r\n+    void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock> &block) override\r\n     {\r\n         if (m_on_call) m_on_call();\r\n     }\r\n     static void Call()\r\n     {\r\n-        std::shared_ptr<const CBlock> block = std::make_shared<CBlock>();\r\n-        BlockValidationState state;\r\n-        GetMainSignals().BlockChecked(block, state);\r\n+        GetMainSignals().NewPoWValidBlock(nullptr, std::make_shared<CBlock>());\r\n     }\r\n     std::function<void()> m_on_call;\r\n     std::function<void()> m_on_destroy;\r\n```",
      "created_at" : "2020-05-18T22:35:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630470943",
      "id" : 630470943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ3MDk0Mw==",
      "updated_at" : "2020-05-18T22:35:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630470943",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Now `p2p_unrequested_blocks.py` is failing. `git-bisect` says: \r\n```\r\n1d9f66ea37ac6f22f26013cd57ed75fc04a9481f is the first bad commit\r\n```\r\n-----\r\n\r\nAs noted in the Google Doc:\r\n\r\n> Up to this point, it seems that splitting this commit into:\r\n> \r\n> 1. Changing the call semantics of `ProcessNewBlock`\r\n> 2. Changing the return type to a `std::future`\r\n> \r\n> Might make it easier to review.\r\n\r\nSo I plan to split it up and track it down.",
      "created_at" : "2020-05-18T23:50:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630493441",
      "id" : 630493441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ5MzQ0MQ==",
      "updated_at" : "2020-05-18T23:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630493441",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Split up the first commit into:\r\n\r\n1. cb178903b0752de3edfd87f6013c2b4de41b6e13 which changes the call semantics of `ProcessNewBlock` and deals with the fallout of that\r\n2. 7532cf6c56d015e8bae646138d71df825d2684ab which changes the return from a bool to a future of a bool and deals with the fallout of that\r\n3. 2dcdb537b5c1dce60db217238c5e75dae602e755 which contains changes that are non-obvious to me to be correct\r\n\r\n-----\r\n\r\nI also botched the `git-bisect` before (didn't call `make` in a `bash -c`), new output:\r\n```\r\n$ git bisect run bash -c \"make -j50 && python3 test/functional/p2p_unrequested_blocks.py\"\r\n\r\n...\r\n\r\n7c77827558715180594f5881b6d02982504c4fad is the first bad commit\r\ncommit 7c77827558715180594f5881b6d02982504c4fad\r\nAuthor: Matt Corallo <git@bluematt.me>\r\nDate:   Mon Jun 17 13:13:36 2019 -0400\r\n\r\n    Move net_processing's ProcessNewBlock calls to resolve async.\r\n\r\n    Essentially, our goal is to not process anything for the given peer\r\n    until the block finishes processing (emulating the previous behavior)\r\n    without actually blocking the ProcessMessages loops. Obviously, in\r\n    most cases, we'll just go on to the next peer and immediately hit a\r\n    cs_main lock, blocking us anyway, but this we can slowly improve\r\n    that state over time by moving things from CNodeState to CPeerState.\r\n\r\n src/net_processing.cpp | 79 ++++++++++++++++++++++++++++++++++++++++++--------\r\n 1 file changed, 67 insertions(+), 12 deletions(-)\r\nbisect run success\r\n```",
      "created_at" : "2020-05-19T19:37:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-631038490",
      "id" : 631038490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTAzODQ5MA==",
      "updated_at" : "2020-05-19T19:37:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631038490",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Got the unit tests and functional tests to pass!",
      "created_at" : "2020-05-21T22:06:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-632370917",
      "id" : 632370917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjM3MDkxNw==",
      "updated_at" : "2020-05-21T22:06:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632370917",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
