[
   {
      "author_association" : "MEMBER",
      "body" : "@promag can you explain how this is different from #13501 and what the reasoning was for closing that PR?",
      "created_at" : "2018-11-06T15:07:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436285128",
      "id" : 436285128,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjI4NTEyOA==",
      "updated_at" : "2018-11-06T15:07:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436285128",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is now the trillionth attempt in fixing the issue. Could you provide some rationale how this is different from the other approaches and why it should be preferred over the other ones?",
      "created_at" : "2018-11-06T15:08:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436285740",
      "id" : 436285740,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjI4NTc0MA==",
      "updated_at" : "2018-11-06T15:08:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436285740",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This is simpler than #13501, and if it works I think it is preferable. Instead of trying to wait for all reply data to be sent before stopping the event loop and calling `evhttp_free`, it lets `evhttp_free` worry about this and stop the event loop itself. Assuming `http_free` does the right thing, this is a cleaner and less invasive.\r\n\r\nI am curious what exactly the behavior of `evhttp_free` is. For example if we are in the middle of sending a huge reply to a slow client, and the server is shut down, how long does this wait (if it waits at all) to send all the data before shutting down? IIUC #13501 would wait as long as it took, and currently we wait for 2 seconds.",
      "created_at" : "2018-11-06T15:38:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436296906",
      "id" : 436296906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjI5NjkwNg==",
      "updated_at" : "2018-11-06T15:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436296906",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems like `evhttp_free` just immediately calls `shutdown` and `close` on all open connections, so I would expect this change not to always fix #11777. \r\n\r\nhttps://github.com/libevent/libevent/blob/9afe7a6c12c112a6cbc49cf1bd684781275b2579/http.c#L1243\r\nhttps://github.com/libevent/libevent/blob/9afe7a6c12c112a6cbc49cf1bd684781275b2579/http.c#L3721\r\n\r\nBut maybe the `WriteHeader(\"Connection\", \"close\")` call added to `HTTPRequest::WriteReply` improves things in some way, so even if there is a race condition, it won't trigger in practice?",
      "created_at" : "2018-11-06T16:07:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436308425",
      "id" : 436308425,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjMwODQyNQ==",
      "updated_at" : "2018-11-06T16:07:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436308425",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2018-11-06T17:57:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436347520",
      "id" : 436347520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjM0NzUyMA==",
      "updated_at" : "2018-11-06T17:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436347520",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky right, can't call `evhttp_free` with ongoing requests.\r\n\r\nUpdated code and PR description, should be more clear of the current problem and the approach used.",
      "created_at" : "2018-11-07T03:19:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436490876",
      "id" : 436490876,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjQ5MDg3Ng==",
      "updated_at" : "2018-11-07T03:19:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436490876",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Split in multiple commits for easy review.\r\n\r\nIt can be arguable to remove the timeout but IMO it's safe because:\r\n - if an HTTP worker is with a long task then calling `event_base_loopbreak` is no good\r\n - active connections will timeout and close if no request/response happens (30 seconds by default).\r\n\r\nThis can be observed by:\r\n```\r\nbitcoind -regtest\r\ntime nc localhost 18443\r\nbitcoin-cli -regtest stop\r\nnc localhost 18443  0.00s user 0.01s system 0% cpu 30.025 total\r\n                                                   ^^^^^^\r\n```\r\nThe only way to improve this in a correct way is to lower the connection timeout (that I know of)",
      "created_at" : "2018-11-07T09:33:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14670#issuecomment-436561767",
      "id" : 436561767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14670",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNjU2MTc2Nw==",
      "updated_at" : "2018-11-07T09:35:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/436561767",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
