[
   {
      "body" : "ACK",
      "created_at" : "2012-11-11T09:00:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-10264474",
      "id" : 10264474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-11-11T09:00:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/10264474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Regarding Begin/End/AbortMessage, wouldn't it be cleaner to introduce a CMessageBuilder class, which holds a scoped lock of a referenced CNode::cs_vSend, and forwards operator<< to the respective vSend? For example CNode::PushMessage(pszCommand, a1) could then become simply { CMessageBuilder m(this, pszCommand); m << a1; m.Send(); }.",
      "created_at" : "2012-11-11T11:12:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-10265277",
      "id" : 10265277,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-11-11T11:12:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/10265277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "How about just building unlocked, then copying the message into vSend.\r\n\r\nThat adds a memory copy (potentially large for \"block\" messages), but it eliminates the locking mess, and also eliminates the whole nHeaderStart-then-back-out-if-we-abort stuff.  Clean and simple, if the memory copy burden is OK.",
      "created_at" : "2012-11-16T02:22:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-10434403",
      "id" : 10434403,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-11-16T02:22:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/10434403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/494411?v=3",
         "events_url" : "https://api.github.com/users/jgarzik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jgarzik/followers",
         "following_url" : "https://api.github.com/users/jgarzik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jgarzik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jgarzik",
         "id" : 494411,
         "login" : "jgarzik",
         "organizations_url" : "https://api.github.com/users/jgarzik/orgs",
         "received_events_url" : "https://api.github.com/users/jgarzik/received_events",
         "repos_url" : "https://api.github.com/users/jgarzik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jgarzik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jgarzik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jgarzik"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/25511af4a57816c4f9bb960527f090a9719c9010 for binaries and test log.",
      "created_at" : "2012-11-23T10:19:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-10655317",
      "id" : 10655317,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-11-23T10:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/10655317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   },
   {
      "body" : "I like @jgarzik's idea. Shared-nothing passing messages is a safe and elegant default, if it turns out to be a performance burden, which I don't believe so, it can always be optimized again **without** the locking mess.",
      "created_at" : "2012-12-06T07:44:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11075710",
      "id" : 11075710,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-12-06T07:44:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11075710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Hi, sorry I have not had time to follow up on these locking changes, but..\r\n\r\nActually locking and synchronous shared-nothing message passing are very\r\nsimilar from a theoretical point of view.\r\n\r\nTo build an intuition for this, imagine that you create a thread for every\r\nset of locks that can be held in the program at the same time, by some\r\nthread.  What does this mean? It means that you create a thread for every\r\nsingle \"group\" of data that is protected by a set of locks, much like in a\r\nfine-grained message-passing implementation.\r\n\r\nAlso, for any two locks that can be held at the same time, define a lock\r\nacquisition order (so lock A must be taken before lock B, if they can both\r\nbe held by the same thread at the same time).\r\n\r\nNow, imagine that every time you take a lock, you instead pass a message to\r\nthe designated thread with a copy of \"the environment\" which consists of\r\nall variables visible in the lexical scope.  This message is synchronous,\r\nso you wait until that other thread returns.\r\n\r\nThen this is equivalent to the synchronous shared nothing message passing\r\nimplementation.\r\n\r\nNote that no other thread can legally modify \"the environment\" because that\r\nwould require a lock, and thus execution of said modification would have to\r\nhappen in a thread which is currently blocked.\r\n\r\nAnyways, what this means is that the process of annotating which data is\r\nprotected by which locks is exactly the same information that one encodes\r\nwhen restructuring a program into message-passing style.  However,\r\nmessage-passing style is a pretty heavy transformation, as it affects both\r\nperformance and correctness.  Lock annotation only deals with correctness.\r\n\r\nAlso, for performance reasons, message-passing style in C++ is often not\r\nsynchronous.  Asynchronous message-passing can actually be a lot harder to\r\ndo right than a lock-based implementation because the number of states that\r\nthe program can be in is suddenly expanded over the lock-based\r\nimplementation.\r\n\r\nSo I would suggest that the bitcoin software is not rewritten to use\r\nmessage-passing.\r\n\r\nRather, simply use lock annotations, and as a hygiene issue, limit the size\r\nof \"the environment\" typically by restricting the visibility of global\r\nvariables.\r\n\r\nAlso, try to get rid of TRY_LOCK.\r\n\r\nAlexander\r\n\r\nOn 6 December 2012 04:44, Wladimir J. van der Laan <notifications@github.com\r\n> wrote:\r\n\r\n> I like @jgarzik <https://github.com/jgarzik>'s idea. Shared-nothing\r\n> passing messages is a safe and elegant default, if it turns out to be a\r\n> performance burden, which I don't believe so, it can always be optimized\r\n> again *without* the locking mess.\r\n>\r\n> Ã¢ÂÂ\r\n> Reply to this email directly or view it on GitHub<https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11075710>.\r\n>\r\n>",
      "created_at" : "2012-12-06T17:22:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11094855",
      "id" : 11094855,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-12-06T17:22:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11094855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/339369?v=3",
         "events_url" : "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderkjeldaas/followers",
         "following_url" : "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderkjeldaas",
         "id" : 339369,
         "login" : "alexanderkjeldaas",
         "organizations_url" : "https://api.github.com/users/alexanderkjeldaas/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderkjeldaas/received_events",
         "repos_url" : "https://api.github.com/users/alexanderkjeldaas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderkjeldaas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderkjeldaas"
      }
   },
   {
      "body" : "Indeed, theoretically they are equivalent (still, in practice it is harder to mess up as subtly with message passing, as you can see in one glance what is passed instead of having to spend a lot of time carefully analyzing locks).\r\n \r\nBut I think jgarzik was talking about one specific case, building a message that's going to go over a socket anyway to get rid of a TRY_LOCK, not rewriting the entire application.",
      "created_at" : "2012-12-06T18:58:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11098676",
      "id" : 11098676,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-12-06T19:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11098676",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Aha. Mea culpa.  That does indeed seem like a good plan.\r\n\r\nOn 6 December 2012 15:58, Wladimir J. van der Laan <notifications@github.com\r\n> wrote:\r\n\r\n> Indeed, theoretically they are equivalent.\r\n> But I think jgarzik was talking about one specific case, building a\r\n> message that's going to go over a socket anyway to get rid of a TRY_LOCK,\r\n> not rewriting the entire application.\r\n>\r\n> Ã¢ÂÂ\r\n> Reply to this email directly or view it on GitHub<https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11098676>.\r\n>\r\n>",
      "created_at" : "2012-12-06T19:31:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11100068",
      "id" : 11100068,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-12-06T19:31:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11100068",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/339369?v=3",
         "events_url" : "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/alexanderkjeldaas/followers",
         "following_url" : "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/alexanderkjeldaas",
         "id" : 339369,
         "login" : "alexanderkjeldaas",
         "organizations_url" : "https://api.github.com/users/alexanderkjeldaas/orgs",
         "received_events_url" : "https://api.github.com/users/alexanderkjeldaas/received_events",
         "repos_url" : "https://api.github.com/users/alexanderkjeldaas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/alexanderkjeldaas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/alexanderkjeldaas"
      }
   },
   {
      "body" : "Merging; I'm excited about using clang to help us make sure locking is correct and efficient.\r\n",
      "created_at" : "2012-12-12T17:27:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2003#issuecomment-11298939",
      "id" : 11298939,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2003",
      "updated_at" : "2012-12-12T17:27:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/11298939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/331997?v=3",
         "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gavinandresen/followers",
         "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gavinandresen",
         "id" : 331997,
         "login" : "gavinandresen",
         "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
         "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
         "repos_url" : "https://api.github.com/users/gavinandresen/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gavinandresen"
      }
   }
]
