[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25729](https://github.com/bitcoin/bitcoin/pull/25729) (wallet: Check max transaction weight in CoinSelection by aureleoules)\n* [#25721](https://github.com/bitcoin/bitcoin/pull/25721) (refactor: Replace BResult with util::Result by ryanofsky)\n* [#25273](https://github.com/bitcoin/bitcoin/pull/25273) (wallet: Pass through transaction locktime and preset input sequences and scripts to CreateTransaction by achow101)\n* [#25183](https://github.com/bitcoin/bitcoin/pull/25183) (rpc: Segwit-only inputs option for fundrawtransaction by aureleoules)\n* [#24584](https://github.com/bitcoin/bitcoin/pull/24584) (wallet: avoid mixing different `OutputTypes` during coin selection by josibake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-20T10:51:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#issuecomment-1190125519",
      "id" : 1190125519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25647",
      "node_id" : "IC_kwDOABII585G79_P",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1190125519/reactions"
      },
      "updated_at" : "2022-07-28T17:05:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1190125519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Simulation results here https://github.com/S3RK/coin-selection-simulation/tree/25647-sim/results/25647",
      "created_at" : "2022-07-21T07:32:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#issuecomment-1191145752",
      "id" : 1191145752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25647",
      "node_id" : "IC_kwDOABII585G_3EY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191145752/reactions"
      },
      "updated_at" : "2022-07-21T07:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191145752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932582168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932582168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: calculate and store min_change\" (ef71f057495b0a152667857ab277c0e76e76ad76):\r\n\r\nWhen I read `min_change` I think of the modifier of the target for the coin selection parameters. This seems to rather be the upper bound for dust. Perhaps we should use a different name here instead of the same term.\r\n\r\n```suggestion\r\n    CAmount min_viable_change{0};\r\n```",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T19:07:31Z",
      "diff_hunk" : "@@ -123,6 +123,10 @@ struct CoinSelectionParams {\n     /** Mininmum change to target in Knapsack solver: select coins to cover the payment and\n      * at least this value of change. */\n     CAmount m_min_change_target{0};\n+    /** Minimum amount for creating a change output.\n+     * If change budget is smaller than min_change then we forgo creation of change output.\n+     */\n+    CAmount min_change{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932582168",
      "id" : 932582168,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843lhMY",
      "original_commit_id" : "ef71f057495b0a152667857ab277c0e76e76ad76",
      "original_line" : 129,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : null,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932582168/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932582168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932586988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932586988"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: calculate and store min_change\" (ef71f057495b0a152667857ab277c0e76e76ad76):\r\nShouldn't this be the same criteria we use for discarding the remainder? Also, I think the +1 should be added to either of the terms, so we can pull it out of the parens.\r\n\r\n```suggestion\r\n    coin_selection_params.min_change = std::max(coin_selection_params.m_cost_of_change, dust) + 1;\r\n```",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T19:13:32Z",
      "diff_hunk" : "@@ -745,6 +745,13 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n     coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n     coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + coin_selection_params.m_change_fee;\n \n+    // The smallest change amount should be:\n+    // 1. at least equal to dust threshold\n+    // 2. at least 1 sat greater than fees to spend it at m_discard_feerate\n+    const auto dust = GetDustThreshold(change_prototype_txout, coin_selection_params.m_discard_feerate);\n+    const auto change_spend_fee = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size);\n+    coin_selection_params.min_change = std::max(change_spend_fee + 1, dust);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932586988",
      "id" : 932586988,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843liXs",
      "original_commit_id" : "ef71f057495b0a152667857ab277c0e76e76ad76",
      "original_line" : 753,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932586988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932586988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932593733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932593733"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: add SelectionResult::GetChange\" (83bf6ab231af6db030cab876b169551f438c2499):\r\n\r\nNaming-nit: My understanding was that `change_budget` refers to `change_amount + change_fee`, but in this function `change_budget` is actually just `change`?\r\n\r\n```suggestion\r\nCAmount SelectionResult::GetChange(const CAmount min_viable_change, const CAmount change_fee) const\r\n{\r\n    // change = SUM(inputs) - SUM(outputs) - fees\r\n    // 1) With SFFO we don't pay any fees\r\n    // 2) Otherwise we pay all the fees:\r\n    //  - input fees are covered by GetSelectedEffectiveValue()\r\n    //  - non_input_fee is included in m_target\r\n    //  - change_fee\r\n    const CAmount change = m_use_effective\r\n                                  ? GetSelectedEffectiveValue() - m_target - change_fee\r\n                                  : GetSelectedValue() - m_target;\r\n\r\n    if (change < min_viable_change) {\r\n        return 0;\r\n    }\r\n\r\n    return change;\r\n}\r\n```",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T19:22:50Z",
      "diff_hunk" : "@@ -480,4 +485,24 @@ std::string GetAlgorithmName(const SelectionAlgorithm algo)\n     }\n     assert(false);\n }\n+\n+CAmount SelectionResult::GetChange(const CAmount min_change, const CAmount change_fee) const\n+{\n+    // change_budget = SUM(inputs) - SUM(outputs) - fees\n+    // 1) With SFFO we don't pay any fees\n+    // 2) Otherwise we pay all the fees:\n+    //  - input fees are covered by GetSelectedEffectiveValue()\n+    //  - non_input_fee is included in m_target\n+    //  - change_fee\n+    const CAmount change_budget = m_use_effective\n+                                  ? GetSelectedEffectiveValue() - m_target - change_fee\n+                                  : GetSelectedValue() - m_target;\n+\n+    if (change_budget < min_change) {\n+        return 0;\n+    }\n+\n+    return change_budget;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932593733",
      "id" : 932593733,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843lkBF",
      "original_commit_id" : "83bf6ab231af6db030cab876b169551f438c2499",
      "original_line" : 512,
      "original_position" : 34,
      "original_start_line" : 489,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932593733/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932593733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932598916"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932598916"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"wallet: use GetChange() in tx building\" (64af431f328de586b3e8769ec875a7cf9083b44e):\r\n\r\nStyle-nit: Inconsistent line breaking between if and brace.",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T19:29:42Z",
      "diff_hunk" : "@@ -792,23 +792,23 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n     }\n     TRACE5(coin_selection, selected_coins, wallet.GetName().c_str(), GetAlgorithmName(result->GetAlgo()).c_str(), result->GetTarget(), result->GetWaste(), result->GetSelectedValue());\n \n-    // Always make a change output\n-    // We will reduce the fee from this change output later, and remove the output if it is too small.\n-    const CAmount change_and_fee = result->GetSelectedValue() - recipients_sum;\n-    assert(change_and_fee >= 0);\n-    CTxOut newTxOut(change_and_fee, scriptChange);\n-\n-    if (nChangePosInOut == -1) {\n-        // Insert change txn at random position:\n-        nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-    }\n-    else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-        return _(\"Transaction change output index out of range\");\n+    const CAmount change_amount = result->GetChange(coin_selection_params.min_change, coin_selection_params.m_change_fee);\n+    if (change_amount > 0) {\n+        CTxOut newTxOut(change_amount, scriptChange);\n+        if (nChangePosInOut == -1)\n+        {\n+            // Insert change txn at random position:\n+            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n+        }\n+        else if ((unsigned int)nChangePosInOut > txNew.vout.size())\n+        {\n+            return _(\"Transaction change output index out of range\");\n+        }\n+        txNew.vout.insert(txNew.vout.begin() + nChangePosInOut, newTxOut);\n+    } else {\n+        nChangePosInOut = -1;\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932598916",
      "id" : 932598916,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843llSE",
      "original_commit_id" : "64af431f328de586b3e8769ec875a7cf9083b44e",
      "original_line" : 914,
      "original_position" : 31,
      "original_start_line" : 795,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932598916/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932598916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932626345"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932626345"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"wallet: use GetChange() when computing waste\" (45ee9d3a737cc23babb9200c4d75d7dae4dc6700):\r\n\r\nShouldn't the first value here be the maximum of `cost_of_change`  and  `dust_threshold`? I think that the former can be lower than the latter for feerates below discard_feerate.",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T20:09:01Z",
      "diff_hunk" : "@@ -156,7 +156,7 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n     for (const size_t& i : best_selection) {\n         result.AddInput(utxo_pool.at(i));\n     }\n-    result.ComputeAndSetWaste(CAmount{0});\n+    result.ComputeAndSetWaste(cost_of_change, cost_of_change, CAmount{0});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932626345",
      "id" : 932626345,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII5843lr-p",
      "original_commit_id" : "45ee9d3a737cc23babb9200c4d75d7dae4dc6700",
      "original_line" : 159,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 5,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932626345/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932626345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932633319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932633319"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In \"wallet: use GetChange() when computing waste\" (45ee9d3a737cc23babb9200c4d75d7dae4dc6700):\r\n\r\nAs suggested before, I'd prefer `min_viable_change` for this value here and below.",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-07-28T20:18:50Z",
      "diff_hunk" : "@@ -406,9 +406,15 @@ CAmount GenerateChangeTarget(CAmount payment_value, FastRandomContext& rng)\n     }\n }\n \n-void SelectionResult::ComputeAndSetWaste(CAmount change_cost)\n+void SelectionResult::ComputeAndSetWaste(const CAmount min_change, const CAmount change_cost, const CAmount change_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r932633319",
      "id" : 932633319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843ltrn",
      "original_commit_id" : "45ee9d3a737cc23babb9200c4d75d7dae4dc6700",
      "original_line" : 409,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1054616217,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932633319/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-28T20:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/932633319",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-28T23:00:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#issuecomment-1198707276",
      "id" : 1198707276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25647",
      "node_id" : "IC_kwDOABII585HctJM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1198707276/reactions"
      },
      "updated_at" : "2022-07-28T23:00:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1198707276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940990376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940990376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure I understand the question about the remainder. I've tried to keep the existing behaviour unchanged.\r\n\r\nWe can totally add +1 to the dust threshold but that would be a change in behaviour. Are we sure we want to do it?",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:24:00Z",
      "diff_hunk" : "@@ -745,6 +745,13 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n     coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n     coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + coin_selection_params.m_change_fee;\n \n+    // The smallest change amount should be:\n+    // 1. at least equal to dust threshold\n+    // 2. at least 1 sat greater than fees to spend it at m_discard_feerate\n+    const auto dust = GetDustThreshold(change_prototype_txout, coin_selection_params.m_discard_feerate);\n+    const auto change_spend_fee = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size);\n+    coin_selection_params.min_change = std::max(change_spend_fee + 1, dust);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940990376",
      "id" : 940990376,
      "in_reply_to_id" : 932586988,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844Fl-o",
      "original_commit_id" : "ef71f057495b0a152667857ab277c0e76e76ad76",
      "original_line" : 753,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1066228144,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940990376/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-09T07:24:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940990376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940991118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940991118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I fixed it",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:24:51Z",
      "diff_hunk" : "@@ -792,23 +792,23 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n     }\n     TRACE5(coin_selection, selected_coins, wallet.GetName().c_str(), GetAlgorithmName(result->GetAlgo()).c_str(), result->GetTarget(), result->GetWaste(), result->GetSelectedValue());\n \n-    // Always make a change output\n-    // We will reduce the fee from this change output later, and remove the output if it is too small.\n-    const CAmount change_and_fee = result->GetSelectedValue() - recipients_sum;\n-    assert(change_and_fee >= 0);\n-    CTxOut newTxOut(change_and_fee, scriptChange);\n-\n-    if (nChangePosInOut == -1) {\n-        // Insert change txn at random position:\n-        nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n-    }\n-    else if ((unsigned int)nChangePosInOut > txNew.vout.size()) {\n-        return _(\"Transaction change output index out of range\");\n+    const CAmount change_amount = result->GetChange(coin_selection_params.min_change, coin_selection_params.m_change_fee);\n+    if (change_amount > 0) {\n+        CTxOut newTxOut(change_amount, scriptChange);\n+        if (nChangePosInOut == -1)\n+        {\n+            // Insert change txn at random position:\n+            nChangePosInOut = rng_fast.randrange(txNew.vout.size() + 1);\n+        }\n+        else if ((unsigned int)nChangePosInOut > txNew.vout.size())\n+        {\n+            return _(\"Transaction change output index out of range\");\n+        }\n+        txNew.vout.insert(txNew.vout.begin() + nChangePosInOut, newTxOut);\n+    } else {\n+        nChangePosInOut = -1;\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940991118",
      "id" : 940991118,
      "in_reply_to_id" : 932598916,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844FmKO",
      "original_commit_id" : "64af431f328de586b3e8769ec875a7cf9083b44e",
      "original_line" : 914,
      "original_position" : 31,
      "original_start_line" : 795,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1066229159,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940991118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-09T07:24:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940991118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940994464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940994464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:28:09Z",
      "diff_hunk" : "@@ -123,6 +123,10 @@ struct CoinSelectionParams {\n     /** Mininmum change to target in Knapsack solver: select coins to cover the payment and\n      * at least this value of change. */\n     CAmount m_min_change_target{0};\n+    /** Minimum amount for creating a change output.\n+     * If change budget is smaller than min_change then we forgo creation of change output.\n+     */\n+    CAmount min_change{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940994464",
      "id" : 940994464,
      "in_reply_to_id" : 932582168,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844Fm-g",
      "original_commit_id" : "ef71f057495b0a152667857ab277c0e76e76ad76",
      "original_line" : 129,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : null,
      "pull_request_review_id" : 1066233509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940994464/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-09T07:28:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940994464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940995100"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940995100"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:28:52Z",
      "diff_hunk" : "@@ -480,4 +485,24 @@ std::string GetAlgorithmName(const SelectionAlgorithm algo)\n     }\n     assert(false);\n }\n+\n+CAmount SelectionResult::GetChange(const CAmount min_change, const CAmount change_fee) const\n+{\n+    // change_budget = SUM(inputs) - SUM(outputs) - fees\n+    // 1) With SFFO we don't pay any fees\n+    // 2) Otherwise we pay all the fees:\n+    //  - input fees are covered by GetSelectedEffectiveValue()\n+    //  - non_input_fee is included in m_target\n+    //  - change_fee\n+    const CAmount change_budget = m_use_effective\n+                                  ? GetSelectedEffectiveValue() - m_target - change_fee\n+                                  : GetSelectedValue() - m_target;\n+\n+    if (change_budget < min_change) {\n+        return 0;\n+    }\n+\n+    return change_budget;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r940995100",
      "id" : 940995100,
      "in_reply_to_id" : 932593733,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844FnIc",
      "original_commit_id" : "83bf6ab231af6db030cab876b169551f438c2499",
      "original_line" : 512,
      "original_position" : 34,
      "original_start_line" : 489,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1066234379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940995100/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-09T07:28:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/940995100",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941005409"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941005409"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:39:36Z",
      "diff_hunk" : "@@ -406,9 +406,15 @@ CAmount GenerateChangeTarget(CAmount payment_value, FastRandomContext& rng)\n     }\n }\n \n-void SelectionResult::ComputeAndSetWaste(CAmount change_cost)\n+void SelectionResult::ComputeAndSetWaste(const CAmount min_change, const CAmount change_cost, const CAmount change_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941005409",
      "id" : 941005409,
      "in_reply_to_id" : 932633319,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844Fpph",
      "original_commit_id" : "45ee9d3a737cc23babb9200c4d75d7dae4dc6700",
      "original_line" : 409,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : null,
      "pull_request_review_id" : 1066248893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941005409/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-09T07:39:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941005409",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941007231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941007231"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Technically yes, but it doesn't matter in this case because BnB would never have change more than `cost_of_change`.\r\n\r\nI'd say a better way to fix it is to use `min_viable_change` for the upper bound of BnB. But I don't want to do expand the scope of this PR. Can we leave it for the follow up?",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T07:41:31Z",
      "diff_hunk" : "@@ -156,7 +156,7 @@ std::optional<SelectionResult> SelectCoinsBnB(std::vector<OutputGroup>& utxo_poo\n     for (const size_t& i : best_selection) {\n         result.AddInput(utxo_pool.at(i));\n     }\n-    result.ComputeAndSetWaste(CAmount{0});\n+    result.ComputeAndSetWaste(cost_of_change, cost_of_change, CAmount{0});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941007231",
      "id" : 941007231,
      "in_reply_to_id" : 932626345,
      "line" : 159,
      "node_id" : "PRRC_kwDOABII5844FqF_",
      "original_commit_id" : "45ee9d3a737cc23babb9200c4d75d7dae4dc6700",
      "original_line" : 159,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 5,
      "pull_request_review_id" : 1066251440,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941007231/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-09T07:41:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941007231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941646567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941646567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The changeless window is based on `cost_of_change`, not just `change_spend_fee`. So the minimum viable change should be `cost_of_change + 1`.\r\n\r\nI agree that the `+ 1` should not be applied to the dust threshold. The existing behavior throws away change when it is `< dust` or `<= cost of change`. So that's equivalent to `< dust` or `< cost of change + 1`.",
      "commit_id" : "e763496caab2f9b9f9ba038f7a020caa56997c1b",
      "created_at" : "2022-08-09T18:00:23Z",
      "diff_hunk" : "@@ -745,6 +745,13 @@ static BResult<CreatedTransactionResult> CreateTransactionInternal(\n     coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n     coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + coin_selection_params.m_change_fee;\n \n+    // The smallest change amount should be:\n+    // 1. at least equal to dust threshold\n+    // 2. at least 1 sat greater than fees to spend it at m_discard_feerate\n+    const auto dust = GetDustThreshold(change_prototype_txout, coin_selection_params.m_discard_feerate);\n+    const auto change_spend_fee = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size);\n+    coin_selection_params.min_change = std::max(change_spend_fee + 1, dust);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25647#discussion_r941646567",
      "id" : 941646567,
      "in_reply_to_id" : 932586988,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5844IGLn",
      "original_commit_id" : "ef71f057495b0a152667857ab277c0e76e76ad76",
      "original_line" : 753,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1067162564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25647",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941646567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-09T18:00:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/941646567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
