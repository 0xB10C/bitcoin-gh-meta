[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result class and use it in LoadChainstate by ryanofsky)\n* [#25623](https://github.com/bitcoin/bitcoin/pull/25623) ([kernel 3e/n] Decouple `CDBWrapper` and `CBlockTreeDB` from `ArgsManager` by dongcarl)\n* [#25527](https://github.com/bitcoin/bitcoin/pull/25527) ([kernel 3c/n] Decouple validation cache initialization from `ArgsManager` by dongcarl)\n* [#25077](https://github.com/bitcoin/bitcoin/pull/25077) (Fix chain tip data race and corrupt rest response by MarcoFalke)\n* [#23443](https://github.com/bitcoin/bitcoin/pull/23443) (p2p: Erlay support signaling by naumenkogs)\n* [#22663](https://github.com/bitcoin/bitcoin/pull/22663) (dbwrapper: properly destroy objects in case CDBWrapper ctor throws by Crypt-iQ)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-21T18:21:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1191798486",
      "id" : 1191798486,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585HCWbW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191798486/reactions"
      },
      "updated_at" : "2022-07-29T08:07:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1191798486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r927693341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add testcases for snapshot initialization\" (15da925f2951eaadf81aea9d5b67ec1646581d30)\r\n\r\nMight be a little more robust to destroy the old chainman before creating a new one. I.e. add another blank `chainman.reset()` call before this.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-07-22T14:11:53Z",
      "diff_hunk" : "@@ -328,6 +354,31 @@ struct SnapshotTestSetup : TestChain100Setup {\n             loaded_snapshot_blockhash);\n         return std::make_tuple(&validation_chainstate, &snapshot_chainstate);\n     }\n+\n+    // Simulate a restart of the node by flushing all state to disk, clearing the\n+    // existing ChainstateManager, and unloading the block index.\n+    //\n+    // @returns a reference to the \"restarted\" ChainstateManager\n+    ChainstateManager& SimulateNodeRestart()\n+    {\n+        ChainstateManager& chainman = *Assert(m_node.chainman);\n+\n+        BOOST_TEST_MESSAGE(\"Simulating node restart\");\n+        {\n+            LOCK(::cs_main);\n+            for (CChainState* cs : chainman.GetAll()) {\n+                cs->ForceFlushStateToDisk();\n+            }\n+            chainman.ResetChainstates();\n+            BOOST_CHECK_EQUAL(chainman.GetAll().size(), 0);\n+            const ChainstateManager::Options chainman_opts{\n+                ::Params(),\n+                static_cast<int64_t(*)()>(::GetTime),\n+            };\n+            m_node.chainman.reset(new ChainstateManager(chainman_opts));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r927693341",
      "id" : 927693341,
      "line" : 378,
      "node_id" : "PRRC_kwDOABII5843S3od",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 378,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 90,
      "pull_request_review_id" : 1047965884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-07-22T14:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/927693341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934682927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Am I correct this is not documented in `design/assumeutxo.md` ? I think this is the case where the user already loaded a snapshot UTXO through `loadtxoutset`, a `chainstate_[SHA256 blockhash of snapshot base block]` has been created and the `bitcoind` process is restarted.\r\n\r\n(can be done in a follow-up)",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T15:55:01Z",
      "diff_hunk" : "@@ -31,10 +31,15 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     };\n \n     LOCK(cs_main);\n-    chainman.InitializeChainstate(options.mempool);\n     chainman.m_total_coinstip_cache = cache_sizes.coins;\n     chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n \n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934682927",
      "id" : 934682927,
      "line" : 41,
      "node_id" : "PRRC_kwDOABII5843tiEv",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 41,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 12,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934682927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934711915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note for reviewers: for now `is_snapshot` is always true as there is a single usage. This is not the case anymore with the remaining commits of the #24232 patchset.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:27:20Z",
      "diff_hunk" : "@@ -4720,6 +4708,46 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+static bool DeleteCoinsDBFromDisk(const fs::path db_path, bool is_snapshot)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934711915",
      "id" : 934711915,
      "line" : 4711,
      "node_id" : "PRRC_kwDOABII5843tpJr",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 4711,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934720426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426"
         }
      },
      "author_association" : "MEMBER",
      "body" : "even if name is explicit, could be documented \"Switch active chainstate to snapshot one\" in case of future refactor to check function correctness (and `DetectSnapshotChainstate` could say it activates the snapshot if any)",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:38:11Z",
      "diff_hunk" : "@@ -990,6 +984,15 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool* mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    void ResetChainstates() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    CChainState& ActivateExistingSnapshot(CTxMemPool* mempool, uint256 base_blockhash)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934720426",
      "id" : 934720426,
      "line" : 993,
      "node_id" : "PRRC_kwDOABII5843trOq",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 993,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 30,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934720426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934727831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "comment can be extended \"There should be a single snapshot at any given time\"",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:47:54Z",
      "diff_hunk" : "@@ -33,6 +39,30 @@ class SnapshotMetadata\n \n     SERIALIZE_METHODS(SnapshotMetadata, obj) { READWRITE(obj.m_base_blockhash, obj.m_coins_count); }\n };\n+\n+//! The file in the snapshot chainstate dir which stores the base blockhash. This\n+//! is needed to reconstruct snapshot chainstates on init.\n+const fs::path SNAPSHOT_BLOCKHASH_FILENAME{\"base_blockhash\"};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934727831",
      "id" : 934727831,
      "line" : 45,
      "node_id" : "PRRC_kwDOABII5843ttCX",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 45,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/node/utxo_snapshot.h",
      "position" : 22,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934727831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934731872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note to reviewers: this method is used in the remaining #24232 patchset.",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-01T16:52:56Z",
      "diff_hunk" : "@@ -990,6 +984,15 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! When starting up, search the datadir for a chainstate based on a UTXO\n+    //! snapshot that is in the process of being validated.\n+    bool DetectSnapshotChainstate(CTxMemPool* mempool) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    void ResetChainstates() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r934731872",
      "id" : 934731872,
      "line" : 991,
      "node_id" : "PRRC_kwDOABII5843tuBg",
      "original_commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "original_line" : 991,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 28,
      "pull_request_review_id" : 1057524936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:55:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934731872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@dergoegge I think you could be interested to review the assumeutxo work. In case of future hypothetical integration of libutreexo in Core, I believe there would be intersecting code paths and data structure modified. It might also prepare for future [synergies](https://github.com/jamesob/assumeutxo-docs/tree/master/proposal#how-will-this-work-with-accumulators-uhs-or-utreexo-if-those-things-come-around) between utreexo and assumeutxo.",
      "created_at" : "2022-08-01T17:00:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1201469507",
      "id" : 1201469507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585HnPhD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201469507/reactions"
      },
      "updated_at" : "2022-08-01T17:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201469507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Planning on diving deeply into this, thanks for splitting it up @jamesob!\r\n\r\nQuestions from going over the commits:\r\n\r\nQ1:  Is the intended layout:\r\n- `<datadir>`\r\n  - `chainstate`\r\n    - `*.ldb`\r\n    - `*.log`\r\n    - `CURRENT`\r\n    - `LOCK`\r\n    - `MANIFEST-*`\r\n  - `chainstate_snapshot`\r\n    - `base_blockhash`\r\n    - `*.ldb`\r\n    - `*.log`\r\n    - `CURRENT`\r\n    - `LOCK`\r\n    - `MANIFEST-*` \r\n\r\nQ2: The last 6 commits seem to be focused on unit tests, but it seems to me that the functionality being added here is better tested with functional tests. Is there something we need to test here that a functional test won't be able to do?",
      "created_at" : "2022-08-02T19:51:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1203150779",
      "id" : 1203150779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585Htp-7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150779/reactions"
      },
      "updated_at" : "2022-08-02T19:51:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150779",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r935973938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note to other reviewers: the call to `DestroyDB` will actually remove the entire directory, including the blockhash file if it still existed since we place the blockhash file inside what leveldb considers to be its directory, but it's probably better to remove it ourselves just so we can print nice errors.\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/de3c46c93818c6e4000175bcdbf7dd332f54768d/src/leveldb/db/db_impl.cc#L1550",
      "commit_id" : "15da925f2951eaadf81aea9d5b67ec1646581d30",
      "created_at" : "2022-08-02T19:56:04Z",
      "diff_hunk" : "@@ -4708,6 +4708,46 @@ const AssumeutxoData* ExpectedAssumeutxo(\n     return nullptr;\n }\n \n+static bool DeleteCoinsDBFromDisk(const fs::path db_path, bool is_snapshot)\n+    EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+{\n+    AssertLockHeld(::cs_main);\n+\n+    if (is_snapshot) {\n+        fs::path base_blockhash_path = db_path / node::SNAPSHOT_BLOCKHASH_FILENAME;\n+\n+        if (fs::exists(base_blockhash_path)) {\n+            bool removed = fs::remove(base_blockhash_path);\n+            if (!removed) {\n+                LogPrintf(\"[snapshot] failed to remove file %s\\n\",\n+                          fs::PathToString(base_blockhash_path));\n+            }\n+        } else {\n+            LogPrintf(\"[snapshot] snapshot chainstate dir being removed lacks %s file\\n\",\n+                    fs::PathToString(node::SNAPSHOT_BLOCKHASH_FILENAME));\n+        }\n+    }\n+\n+    std::string path_str = fs::PathToString(db_path);\n+    LogPrintf(\"Removing leveldb dir at %s\\n\", path_str);\n+\n+    // We have to destruct before this call leveldb::DB in order to release the db\n+    // lock, otherwise `DestroyDB` will fail. See `leveldb::~DBImpl()`.\n+    const bool destroyed = dbwrapper::DestroyDB(path_str, {}).ok();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#discussion_r935973938",
      "id" : 935973938,
      "line" : 4736,
      "node_id" : "PRRC_kwDOABII5843ydQy",
      "original_commit_id" : "aa26b508fb3424169108aade3083a9f771dbcab2",
      "original_line" : 4736,
      "original_position" : 29,
      "original_start_line" : 4720,
      "path" : "src/validation.cpp",
      "position" : 29,
      "pull_request_review_id" : 1059352598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25667",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4720,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-02T19:56:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/935973938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:23:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25667#issuecomment-1203703035",
      "id" : 1203703035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25667",
      "node_id" : "IC_kwDOABII585Hvwz7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703035/reactions"
      },
      "updated_at" : "2022-08-03T09:23:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203703035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
