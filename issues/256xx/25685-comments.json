[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25734](https://github.com/bitcoin/bitcoin/pull/25734) (wallet, refactor: #24584 follow-ups by josibake)\n* [#25721](https://github.com/bitcoin/bitcoin/pull/25721) (refactor: Replace BResult with util::Result by ryanofsky)\n* [#25679](https://github.com/bitcoin/bitcoin/pull/25679) (wallet: Correctly identify external inputs that are also in the wallet by achow101)\n* [#25659](https://github.com/bitcoin/bitcoin/pull/25659) (wallet: simplify ListCoins implementation by furszy)\n* [#25183](https://github.com/bitcoin/bitcoin/pull/25183) (rpc: Filter inputs by type during CoinSelection by aureleoules)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-23T15:16:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1193141240",
      "id" : 1193141240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585HHeP4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1193141240/reactions"
      },
      "updated_at" : "2022-08-04T10:10:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1193141240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-28T23:00:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1198707202",
      "id" : 1198707202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585HctIC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1198707202/reactions"
      },
      "updated_at" : "2022-07-28T23:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1198707202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "rebased, conflicts solved.",
      "created_at" : "2022-07-29T17:19:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1199775546",
      "id" : 1199775546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585Hgx86",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199775546/reactions"
      },
      "updated_at" : "2022-07-29T17:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199775546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, this seems like a good improvement.",
      "created_at" : "2022-08-01T21:41:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1201751800",
      "id" : 1201751800,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585HoUb4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201751800/reactions"
      },
      "updated_at" : "2022-08-01T21:41:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201751800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/75942586?v=4",
         "events_url" : "https://api.github.com/users/ishaanam/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ishaanam/followers",
         "following_url" : "https://api.github.com/users/ishaanam/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ishaanam/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ishaanam",
         "id" : 75942586,
         "login" : "ishaanam",
         "node_id" : "MDQ6VXNlcjc1OTQyNTg2",
         "organizations_url" : "https://api.github.com/users/ishaanam/orgs",
         "received_events_url" : "https://api.github.com/users/ishaanam/received_events",
         "repos_url" : "https://api.github.com/users/ishaanam/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ishaanam/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ishaanam/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ishaanam"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It's not clear to me that this provides any significant benefit over a much simpler change of just excluding pre-selected inputs from AvailableCoins. The only other improvement this provides is better error reporting, but I think it would be better to just go through SelectCoins and improve its error reporting instead of pulling things out so that errors are reported elsewhere.",
      "created_at" : "2022-08-02T19:51:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1203150120",
      "id" : 1203150120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585Htp0o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150120/reactions"
      },
      "updated_at" : "2022-08-02T19:51:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203150120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> It's not clear to me that this provides any significant benefit over a much simpler change of just excluding pre-selected inputs from AvailableCoins. The only other improvement this provides is better error reporting, but I think it would be better to just go through SelectCoins and improve its error reporting instead of pulling things out so that errors are reported elsewhere.\r\n\r\nThere are several benefits, (aside from what I wrote in the PR description):\r\n\r\n#### Sources Architecture:\r\n\r\n - Do make sense for you to be fetching, and verifying, coins in a function whose main responsibility is perform the Coin Selection process?\r\n \r\n    The Coin Selection should receive coins, and certain user/wallet parameters, so it can produce all the possible solutions for a certain target amount, picking and returning the best of them.\r\n\r\n\tJust imagine how this would looks like if Coin Selection would be a separated library (which, for its increasing specialization, could easily be one in the future). You would never include the pre-selected-inputs fetching and verification process into the Coin Selection responsibilities at all because cannot/shouldn't do it there.\r\n\r\n#### Tangible Improvements:\r\n\r\n1.  As we will do the pre-selected-inputs fetching and verification prior to calling `AvailableCoins`, if there is an error when the wallet fetches any of the preset-inputs, the transaction creation process can fail right away without calling `AvailableCoins` (Function that, as we know, walks-through the entire wallet's transactions map and performs all the internal available coins checks).\r\n \r\n     This prevents us from wasting resources that we are currently wasting for, literally, no reason.\r\n\r\n\tIn master, we are first looping-through the entire wallet's map inside  `AvailableCoins`, which is a resource intensive task if you have a big wallet, just to fail right after it finishes, discarding the coins result, because one of the pre-set inputs has an error.\r\n\r\n3.  If the user disallowed the \"other inputs selection\" by setting `m_allow_other_inputs=false` (which means: âno coins from the AvailableCoins result function will be used during Coin Selectionâ):â¨\r\n\r\n\tIn master: we loop-through the entire wallet's map inside `AvailableCoins` first, then we discard the computed result (because we will not use it..), then we fetch and use the pre-selected-inputs only.\r\n\tWhich is time and processing power wasted for no reason.\r\n\r\n\tIn this PR: we simply select the preset inputs, skip `AvailableCoins` if `m_allow_other_inputs=false` and provides them to `SelectCoins`.\r\n\r\n-------------------\r\n\r\n> but I think it would be better to just go through SelectCoins and improve its error reporting instead of pulling things out so that errors are reported elsewhere.\r\n\r\nWe are currently failing inside the Coin Selection process due:\r\n* âInvalid pre-selected inputâ\r\n* âNot found pre-selected inputâ\r\n* âNot solvable pre-selected inputâ\r\n\r\nThese errors have nothing to do with the Coin Selection process. Why keep them there?\r\n\r\nIt's not that I located these errors on a random place. I placed them inside a \"Fetch Coins\" procedure whose main responsibility is fetch the coins that the user pre-selected and fetch the available coins in the wallet. Which seems totally reasonable for me.\r\n\r\nI mean, this errors have been obscured inside Coin Selection all this time, not being properly notified, because they should had never been placed there in the first place. It's all about a proper responsibility division to make the process clearer and cleaner so it's less error-prone (and in this case, in some occasions, actually faster and less resource consuming).",
      "created_at" : "2022-08-02T22:16:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1203267086",
      "id" : 1203267086,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585HuGYO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203267086/reactions"
      },
      "updated_at" : "2022-08-02T23:27:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203267086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "To make the speed improvements more visible, pushed a new benchmark f6d0bb2d.\r\n\r\nBasically, the new bench measures the transaction creation process, for a wallet with ~250k UTXO, only using the pre-selected-inputs inside coin control. Setting `m_allow_other_inputs=false` to disallow the wallet to include coins automatically.\r\n\r\n#### This is the result on this PR (tip f6d0bb2d):\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|        1,048,675.00 |              953.58 |    0.3% |      0.06 | `WalletCreateTransaction`\r\n\r\nvs\r\n\r\n#### This is the result on current master (tip 4a4289e2):\r\n\r\n|               ns/op |                op/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|       96,373,458.20 |               10.38 |    0.2% |      5.30 | `WalletCreateTransaction`\r\n\r\n#### Summary\r\n\r\nThe benchmark took to run in master: **96.37 milliseconds**, while in this PR: **1 millisecond**  ð .\r\n\r\n-------------\r\n\r\nUpdated PR description with the benchmark results.",
      "created_at" : "2022-08-03T18:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1204322868",
      "id" : 1204322868,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585HyII0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204322868/reactions"
      },
      "updated_at" : "2022-08-04T17:39:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204322868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937198427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937198427"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 23448cae6f4a5f00766df9220860b16311266417 \"wallet: encapsulate pre-selected-inputs lookup into its own function\"\r\n\r\nI think this should return a `SelectionResult` rather than `CoinsResult`. It would elimiate the second iteration inside of `SelectCoins`.\r\n\r\nIt could also return the selected value too so the caller could reduce the target before `SelectCoins` and eliminate an additional iteration of the preselcted inputs.",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-03T22:49:58Z",
      "diff_hunk" : "@@ -105,6 +105,54 @@ void CoinsResult::clear()\n     other.clear();\n }\n \n+// Fetch the coin control selected inputs and wrap them inside a COutput.\n+// Coins could be internal (from the wallet) or external.\n+BResult<CoinsResult> FetchSelectedInputs(const CWallet& wallet, const CCoinControl& coin_control,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937198427",
      "id" : 937198427,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII58433INb",
      "original_commit_id" : "23448cae6f4a5f00766df9220860b16311266417",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1061090900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937198427/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T22:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937198427",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937199343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199343"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 84b4ffe85ba0267c49080e9a096e45d6af63e720 \"wallet: remove fetch pre-selected-inputs responsibility from SelectCoins\"\r\n\r\nI don't think it's necessary to have another function here to wrap these two calls. They could just be in `CreateTransactionInternal`",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-03T22:51:55Z",
      "diff_hunk" : "@@ -153,6 +153,31 @@ BResult<CoinsResult> FetchSelectedInputs(const CWallet& wallet, const CCoinContr\n     return result;\n }\n \n+BResult<CoinsFund> FetchCoins(const CWallet& wallet, const CCoinControl& coin_control,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937199343",
      "id" : 937199343,
      "line" : 156,
      "node_id" : "PRRC_kwDOABII58433Ibv",
      "original_commit_id" : "84b4ffe85ba0267c49080e9a096e45d6af63e720",
      "original_line" : 156,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 4,
      "pull_request_review_id" : 1061090900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199343/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T22:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937199609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "M\r\nIn 84b4ffe85ba0267c49080e9a096e45d6af63e720 \"wallet: remove fetch pre-selected-inputs responsibility from SelectCoins\"\r\n\r\nThis check could be moved to the top of `AvailableCoins` and it would achieve the same effect. Doing so would also not change `AvailableCoins`'s semantics.",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-03T22:52:26Z",
      "diff_hunk" : "@@ -153,6 +153,31 @@ BResult<CoinsResult> FetchSelectedInputs(const CWallet& wallet, const CCoinContr\n     return result;\n }\n \n+BResult<CoinsFund> FetchCoins(const CWallet& wallet, const CCoinControl& coin_control,\n+                              const CoinSelectionParams& coin_selection_params) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)\n+{\n+    CoinsFund result;\n+\n+    // Fetch manually select coins\n+    if (coin_control.HasSelected()) {\n+        result.pre_selected_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+        if (!result.pre_selected_inputs) return result.pre_selected_inputs.GetError();\n+\n+        // If no other inputs are allowed, return early\n+        if (!coin_control.m_allow_other_inputs) return result;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937199609",
      "id" : 937199609,
      "line" : 167,
      "node_id" : "PRRC_kwDOABII58433If5",
      "original_commit_id" : "84b4ffe85ba0267c49080e9a096e45d6af63e720",
      "original_line" : 167,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 15,
      "pull_request_review_id" : 1061090900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199609/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T22:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937199609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937201516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937201516"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 84b4ffe85ba0267c49080e9a096e45d6af63e720 \"wallet: remove fetch pre-selected-inputs responsibility from SelectCoins\"\r\n\r\nI'm wondering if we should just make this function only return a `SelectionResult` for the automatic coin selection and move the preset input stuff to the caller. If `FetchSelectedInputs` made a `SelectionResult` for the preset inputs, then the only preset input things left in `SelectCoins` would be the merging of the `SelectionResult`s, and that can be done in the caller too.",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-03T22:56:50Z",
      "diff_hunk" : "@@ -575,24 +602,17 @@ std::optional<SelectionResult> ChooseSelectionResult(const CWallet& wallet, cons\n     return best_result;\n }\n \n-std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsResult& available_coins, const CAmount& nTargetValue, const CCoinControl& coin_control, const CoinSelectionParams& coin_selection_params)\n+std::optional<SelectionResult> SelectCoins(const CWallet& wallet, CoinsFund& coins, const CAmount& nTargetValue, const CCoinControl& coin_control, const CoinSelectionParams& coin_selection_params)\n {\n     CAmount value_to_select = nTargetValue;\n \n+    // Add the manually selected coins first",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r937201516",
      "id" : 937201516,
      "line" : 609,
      "node_id" : "PRRC_kwDOABII58433I9s",
      "original_commit_id" : "84b4ffe85ba0267c49080e9a096e45d6af63e720",
      "original_line" : 609,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 52,
      "pull_request_review_id" : 1061090900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937201516/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-03T22:59:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937201516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r938067217"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938067217"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good thought ðð¼ \r\n\r\nMost likely, will need to do this change incrementally (right after 23448cae) because if `FetchSelectedInputs` returns a `SelectionResult`, need to add a method for merging two `SelectionResult` objects (the pre-set-inputs result and the wallet's selection result).\r\n\r\nWe are currently creating an `OutputGroup` at the beginning of `SelectCoins` with the pre-set-inputs just to merge it at the end of the function with the wallet's selection algorithm result. The reason is that `SelectResult` only has a function `AddInputs(OutputGroups)` and not an `AddInputs(set<COutputs>)` nor a merge method.\r\n\r\nSide note, based on a quick code review: the selection result built from the combination of pre-set-inputs and the wallet selected ones should be having an inaccurate waste calculation -- will do some tests in another PR --).",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-04T17:27:03Z",
      "diff_hunk" : "@@ -105,6 +105,54 @@ void CoinsResult::clear()\n     other.clear();\n }\n \n+// Fetch the coin control selected inputs and wrap them inside a COutput.\n+// Coins could be internal (from the wallet) or external.\n+BResult<CoinsResult> FetchSelectedInputs(const CWallet& wallet, const CCoinControl& coin_control,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r938067217",
      "id" : 938067217,
      "in_reply_to_id" : 937198427,
      "line" : 110,
      "node_id" : "PRRC_kwDOABII58436cUR",
      "original_commit_id" : "23448cae6f4a5f00766df9220860b16311266417",
      "original_line" : 110,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 6,
      "pull_request_review_id" : 1062333921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938067217/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T17:27:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938067217",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-05T13:55:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#issuecomment-1206486135",
      "id" : 1206486135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25685",
      "node_id" : "IC_kwDOABII585H6YR3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206486135/reactions"
      },
      "updated_at" : "2022-08-05T13:55:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1206486135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r938977841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938977841"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I added it here (inside the `coin_control.HasSelected()` block) to not change the current behavior and minimize the amount of changes.\r\n\r\nIn master, even if `m_allow_other_inputs` is false, we are automatically falling back to select coins from the wallet if there are no pre-set inputs inside coin control.\r\n\r\nThis basically is because the default value for `m_allow_other_inputs` is false, and some RPC commands that don't allow inputs manual selection such as `sendtoaddress` and `sendmany` are not setting it to true. So.. they are always falling back to select coins from the wallet.\r\n\r\nSo.. if I move this check below, will need to set `m_allow_other_inputs=true` in every caller that does not add any input manually (or.. change the default value to be true inside coin control).\r\n\r\nbut.. let me see if those two RPC commands are the only affected ones. Maybe it's a straightforward change.\r\nI do agree that the current master behavior of automatically falling back to select coins from the wallet even when `m_allow_other_inputs=false` is messy and not an expected behavior.",
      "commit_id" : "f6d0bb2dbf3945bdb2896492824fccdb12136e3b",
      "created_at" : "2022-08-05T16:28:07Z",
      "diff_hunk" : "@@ -153,6 +153,31 @@ BResult<CoinsResult> FetchSelectedInputs(const CWallet& wallet, const CCoinContr\n     return result;\n }\n \n+BResult<CoinsFund> FetchCoins(const CWallet& wallet, const CCoinControl& coin_control,\n+                              const CoinSelectionParams& coin_selection_params) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)\n+{\n+    CoinsFund result;\n+\n+    // Fetch manually select coins\n+    if (coin_control.HasSelected()) {\n+        result.pre_selected_inputs = FetchSelectedInputs(wallet, coin_control, coin_selection_params);\n+        if (!result.pre_selected_inputs) return result.pre_selected_inputs.GetError();\n+\n+        // If no other inputs are allowed, return early\n+        if (!coin_control.m_allow_other_inputs) return result;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25685#discussion_r938977841",
      "id" : 938977841,
      "in_reply_to_id" : 937199609,
      "line" : 167,
      "node_id" : "PRRC_kwDOABII584396ox",
      "original_commit_id" : "84b4ffe85ba0267c49080e9a096e45d6af63e720",
      "original_line" : 167,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 15,
      "pull_request_review_id" : 1063597940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25685",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938977841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-05T16:28:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/938977841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
