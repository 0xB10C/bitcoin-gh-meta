[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23277#discussion_r729115253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23277"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729115253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't `meta.key_origin.path.size() >= 3` be better if the worry is to go out of range here? Might also log a warning when this happens as it means (I guess?) that the wallet is somehow corrupted.",
      "commit_id" : "e3ac2c0d41d49c988dee980b8999b303c825f403",
      "created_at" : "2021-10-14T15:45:43Z",
      "diff_hunk" : "@@ -374,7 +374,7 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n         auto it = mapKeyMetadata.find(keyid);\n         if (it != mapKeyMetadata.end()){\n             CKeyMetadata meta = it->second;\n-            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id) {\n+            if (!meta.hd_seed_id.IsNull() && meta.hd_seed_id != m_hd_chain.seed_id && meta.key_origin.path.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23277#discussion_r729115253",
      "id" : 729115253,
      "line" : 377,
      "node_id" : "PRRC_kwDOABII584rdWp1",
      "original_commit_id" : "e3ac2c0d41d49c988dee980b8999b303c825f403",
      "original_line" : 377,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 5,
      "pull_request_review_id" : 779947566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23277",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729115253/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-10-14T15:45:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729115253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, I agree this shouldn't cause a crash.",
      "created_at" : "2021-10-14T15:49:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23277#issuecomment-943486637",
      "id" : 943486637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23277",
      "node_id" : "IC_kwDOABII5844PHat",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943486637/reactions"
      },
      "updated_at" : "2021-10-14T15:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943486637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The root cause of the problem this is fixing is that the wallet does not contain the upgraded key metadata because it is encrypted and has not been unlocked yet, and a transaction was found that involved inactive HD chains. So this segfault can be triggered with a non-corrupted wallet. I don't think it is necessarily correct to log an error and move on as doing so could result in missing funds.\r\n\r\nTo avoid the crash, I think access to `meta.key_origin.path` should be guarded by both the length check and `meta.has_key_origin`. Then if `has_key_origin == false`, `meta.hdKeypath` can be used to figure out what to derive. This would avoid the segfault while not losing any functionality.",
      "created_at" : "2021-10-15T02:34:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23277#issuecomment-943937284",
      "id" : 943937284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23277",
      "node_id" : "IC_kwDOABII5844Q1cE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943937284/reactions"
      },
      "updated_at" : "2021-10-15T02:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/943937284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> The root cause of the problem this is fixing is that the wallet does not contain the upgraded key metadata because it is encrypted and has not been unlocked yet, and a transaction was found that involved inactive HD chains. So this segfault can be triggered with a non-corrupted wallet. I don't think it is necessarily correct to log an error and move on as doing so could result in missing funds.\r\n> \r\n> To avoid the crash, I think access to `meta.key_origin.path` should be guarded by both the length check and `meta.has_key_origin`. Then if `has_key_origin == false`, `meta.hdKeypath` can be used to figure out what to derive. This would avoid the segfault while not losing any functionality.\r\n\r\nI note that has_key_origin was False when I originally patched my own bitcoind in my gist, \r\n```\r\n60268txo)\r\n[Switching to Thread 0x7ffff1461640 (LWP 171684)]\r\n\r\nThread 9 \"b-scheduler\" hit Breakpoint 2, LegacyScriptPubKeyMan::MarkUnusedAddresses (this=0x555556444560, script=...)\r\n    at wallet/scriptpubkeyman.cpp:379\r\n379\t                WalletLogPrintf(\"Debug: meta.key_origin.path[1] %s:\\n\", meta.key_origin.path[1]);\r\n(gdb) p meta\r\n$1 = {static VERSION_BASIC = 1, static VERSION_WITH_HDDATA = 10, static VERSION_WITH_KEY_ORIGIN = 12, \r\n  static CURRENT_VERSION = 12, nVersion = 10, nCreateTime = 1509688921, hdKeypath = \"m/0'/0'/0'\", \r\n  hd_seed_id = {<uint160> = {<base_blob<160>> = {static WIDTH = 20, \r\n        m_data = \"4\\264Y\\351\\243\\302\\231\\032\\\\Ø¸Z\\301&6W\\001\\214\\272\", <incomplete sequence \\313>}, <No data fields>}, <No data fields>}, key_origin = {fingerprint = \"\\000\\000\\000\", path = std::vector of length 0, capacity 0}, has_key_origin = false}\r\n(gdb) q\r\nA debugging session is active.\r\n\r\n\tInferior 1 [process 171676] will be killed.\r\n\r\nQuit anyway? (y or n) y\r\n                                                                             \r\n```\r\n\r\n\r\n>because it is encrypted and has not been unlocked yet, \r\n\r\nbitcoint-qt is  displaying my decrypted wallet.\r\n",
      "created_at" : "2021-10-15T08:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23277#issuecomment-944123158",
      "id" : 944123158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23277",
      "node_id" : "IC_kwDOABII5844Ri0W",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944123158/reactions"
      },
      "updated_at" : "2021-10-15T08:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/944123158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/124807?v=4",
         "events_url" : "https://api.github.com/users/rooprob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rooprob/followers",
         "following_url" : "https://api.github.com/users/rooprob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rooprob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rooprob",
         "id" : 124807,
         "login" : "rooprob",
         "node_id" : "MDQ6VXNlcjEyNDgwNw==",
         "organizations_url" : "https://api.github.com/users/rooprob/orgs",
         "received_events_url" : "https://api.github.com/users/rooprob/received_events",
         "repos_url" : "https://api.github.com/users/rooprob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rooprob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rooprob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rooprob"
      }
   }
]
