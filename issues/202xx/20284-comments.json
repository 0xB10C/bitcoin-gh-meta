[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery spotted the potential problem here: https://github.com/bitcoin/bitcoin/pull/19954#discussion_r515607619",
      "created_at" : "2020-11-02T11:04:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#issuecomment-720402264",
      "id" : 720402264,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDQwMjI2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-02T11:04:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720402264",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nI think this requires a bit more discussion. I'm going to raise it as a meeting topic for the next p2p meeting (Nov 3).\r\n\r\nMarking this as a 0.21 milestone, since we'll need to make a decision before that release.",
      "created_at" : "2020-11-02T13:29:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#issuecomment-720472622",
      "id" : 720472622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDQ3MjYyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-02T13:29:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720472622",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18722 (addrman: improve performance by using more suitable containers by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-11-02T14:58:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#issuecomment-720523138",
      "id" : 720523138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDUyMzEzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-02T14:58:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720523138",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r516035544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516035544"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for adding an actual versioning mechanism, at least next time we won't have to resort to a hack like this!",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-02T15:07:11Z",
      "diff_hunk" : "@@ -410,9 +413,20 @@ friend class CAddrManTest;\n \n         OverrideStream<Stream> s(&s_, s_.GetType(), stream_version);\n \n-        unsigned char nKeySize;\n-        s >> nKeySize;\n-        if (nKeySize != 32) throw std::ios_base::failure(\"Incorrect keysize in addrman deserialization\");\n+        //! The maximum format this software can Unserialize().\n+        static constexpr Format maximum_supported_format = Format::V3_BIP155;\n+\n+        uint8_t compat;\n+        s >> compat;\n+        const uint8_t lowest_compatible = compat - m_incompatibility_base;\n+        if (lowest_compatible > maximum_supported_format) {\n+            throw std::ios_base::failure(\n+                strprintf(\"Unsupported format of addrman database: %u. It is compatible with \"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r516035544",
      "id" : 516035544,
      "line" : 424,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjAzNTU0NA==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 424,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 89,
      "pull_request_review_id" : 521713341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T15:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516035544",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-11-02T15:10:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#issuecomment-720530252",
      "id" : 720530252,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDUzMDI1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-02T15:10:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720530252",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-11-03T14:40:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#issuecomment-721156298",
      "id" : 721156298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20284",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMTE1NjI5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-03T14:40:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/721156298",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520327284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520327284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "unrelated style nit: Any reason why this can't use `CustomUintFormatter` (and its run-time sanity checks)?",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T06:44:40Z",
      "diff_hunk" : "@@ -332,7 +339,12 @@ friend class CAddrManTest;\n         OverrideStream<Stream> s(&s_, s_.GetType(), s_.GetVersion() | ADDRV2_FORMAT);\n \n         s << static_cast<uint8_t>(Format::V3_BIP155);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520327284",
      "id" : 520327284,
      "line" : 341,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMyNzI4NA==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 341,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 47,
      "pull_request_review_id" : 526899023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T06:55:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520327284",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520329901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520329901"
         }
      },
      "author_association" : "MEMBER",
      "body" : "stye-nit: I think the \"continue\" (and logging) is responsibility (and is already done) by the calling code that also catches the exception. No need to assume this exception is always caught.\r\n\r\n",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T06:51:55Z",
      "diff_hunk" : "@@ -410,9 +413,20 @@ friend class CAddrManTest;\n \n         OverrideStream<Stream> s(&s_, s_.GetType(), stream_version);\n \n-        unsigned char nKeySize;\n-        s >> nKeySize;\n-        if (nKeySize != 32) throw std::ios_base::failure(\"Incorrect keysize in addrman deserialization\");\n+        //! The maximum format this software can Unserialize().\n+        static constexpr Format maximum_supported_format = Format::V3_BIP155;\n+\n+        uint8_t compat;\n+        s >> compat;\n+        const uint8_t lowest_compatible = compat - m_incompatibility_base;\n+        if (lowest_compatible > maximum_supported_format) {\n+            throw std::ios_base::failure(\n+                strprintf(\"Unsupported format of addrman database: %u. It is compatible with \"\n+                          \"formats >=%u, but the maximum supported by this version of %s is %u. \"\n+                          \"Continuing operation without using the saved list of peers.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520329901",
      "id" : 520329901,
      "line" : 426,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDMyOTkwMQ==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 426,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 91,
      "pull_request_review_id" : 526899023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T06:55:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520329901",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520412455"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520412455"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We usually use ALL_CAPS for constant names.",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T09:27:18Z",
      "diff_hunk" : "@@ -176,6 +177,20 @@ friend class CAddrManTest;\n     mutable RecursiveMutex cs;\n \n private:\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made. This is 32 instead of 0 because we overtook the \"key size\" field\n+    //! which was 32 historically and we don't want to start with 0 and bump into 32 at\n+    //! some point in the future.\n+    static constexpr uint8_t m_incompatibility_base = 32;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520412455",
      "id" : 520412455,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxMjQ1NQ==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 192,
      "original_position" : 24,
      "original_start_line" : 188,
      "path" : "src/addrman.h",
      "position" : 24,
      "pull_request_review_id" : 527008374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : 188,
      "start_side" : "RIGHT",
      "updated_at" : "2020-11-10T09:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520412455",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520414528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520414528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a very badly named constant! The whole point of this PR is that we want the code to be forward compatible if possible, and only in exceptional circumstances make format changes that aren't. If the format is bumped, but lowest_compatible is not, then older software will still be able to read it.\r\n\r\nI'd suggest moving this to a class-level static constant called FILE_FORMAT or similar, and use it in both the serialize and unserialize functions.",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T09:30:13Z",
      "diff_hunk" : "@@ -410,9 +413,20 @@ friend class CAddrManTest;\n \n         OverrideStream<Stream> s(&s_, s_.GetType(), stream_version);\n \n-        unsigned char nKeySize;\n-        s >> nKeySize;\n-        if (nKeySize != 32) throw std::ios_base::failure(\"Incorrect keysize in addrman deserialization\");\n+        //! The maximum format this software can Unserialize().\n+        static constexpr Format maximum_supported_format = Format::V3_BIP155;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520414528",
      "id" : 520414528,
      "line" : 417,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNDUyOA==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 417,
      "original_position" : 82,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 82,
      "pull_request_review_id" : 527008374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T09:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520414528",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520417770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520417770"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this requires better documentation. At the very least, the `* Serialized format.` comment above needs updating. You might also add `asmap_version` while you're doing that, since the documentation wasn't updated correctly last time either.\r\n\r\nI'd suggest something like:\r\n\r\n\"The lowest version of software that can read this peers.dat file. Update this to be the same as `FILE_FORMAT` when making a change to the file format that is not forwards compatible.\"",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T09:34:58Z",
      "diff_hunk" : "@@ -332,7 +339,12 @@ friend class CAddrManTest;\n         OverrideStream<Stream> s(&s_, s_.GetType(), s_.GetVersion() | ADDRV2_FORMAT);\n \n         s << static_cast<uint8_t>(Format::V3_BIP155);\n-        s << ((unsigned char)32);\n+\n+        // Increment `lowest_compatible` iff a newly introduced format is incompatible with",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520417770",
      "id" : 520417770,
      "line" : 343,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQxNzc3MA==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 343,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 50,
      "pull_request_review_id" : 527008374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T09:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520417770",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520425775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520425775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"we don't want to bump into 32\" isn't the reason we start at 32. The reason is that v0.20 and earlier wrote 32 into this field, so if we didn't use this offset, then minimum_version would be greater than the current version and v0.21 software wouldn't be able to read old peers.dat files. I'd just leave the explanation out.",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T09:46:45Z",
      "diff_hunk" : "@@ -176,6 +177,20 @@ friend class CAddrManTest;\n     mutable RecursiveMutex cs;\n \n private:\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made. This is 32 instead of 0 because we overtook the \"key size\" field\n+    //! which was 32 historically and we don't want to start with 0 and bump into 32 at\n+    //! some point in the future.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520425775",
      "id" : 520425775,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQyNTc3NQ==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 191,
      "original_position" : 23,
      "original_start_line" : 189,
      "path" : "src/addrman.h",
      "position" : 23,
      "pull_request_review_id" : 527008374,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : 189,
      "start_side" : "RIGHT",
      "updated_at" : "2020-11-10T09:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520425775",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520447920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520447920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Any value equal to or greater than 32 should be fine here. As this is a breaking change (old versions can't read the peers.dat created by this version of Bitcoin Core), might as well bump to 33 right away to avoid confusion with the \"magic value\" 32.\r\n",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T10:19:17Z",
      "diff_hunk" : "@@ -176,6 +177,20 @@ friend class CAddrManTest;\n     mutable RecursiveMutex cs;\n \n private:\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made. This is 32 instead of 0 because we overtook the \"key size\" field\n+    //! which was 32 historically and we don't want to start with 0 and bump into 32 at\n+    //! some point in the future.\n+    static constexpr uint8_t m_incompatibility_base = 32;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520447920",
      "id" : 520447920,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0NzkyMA==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 192,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 24,
      "pull_request_review_id" : 527053663,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T10:19:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520447920",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520457896"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520457896"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or perhaps use `0x80` as a very obvious offset. We're unlikely to have 128 file versions so we're not going to run out of bits.",
      "commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "created_at" : "2020-11-10T10:34:29Z",
      "diff_hunk" : "@@ -176,6 +177,20 @@ friend class CAddrManTest;\n     mutable RecursiveMutex cs;\n \n private:\n+    //! Serialization versions.\n+    enum Format : uint8_t {\n+        V0_HISTORICAL = 0,    //!< historic format, before commit e6b343d88\n+        V1_DETERMINISTIC = 1, //!< for pre-asmap files\n+        V2_ASMAP = 2,         //!< for files including asmap version\n+        V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+    };\n+\n+    //! The initial value of a field that is incremented every time an incompatible format\n+    //! change is made. This is 32 instead of 0 because we overtook the \"key size\" field\n+    //! which was 32 historically and we don't want to start with 0 and bump into 32 at\n+    //! some point in the future.\n+    static constexpr uint8_t m_incompatibility_base = 32;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20284#discussion_r520457896",
      "id" : 520457896,
      "in_reply_to_id" : 520447920,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ1Nzg5Ng==",
      "original_commit_id" : "5cde64168976dea9e5d1422b23159413de1307dc",
      "original_line" : 192,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 24,
      "pull_request_review_id" : 527066174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20284",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-10T10:34:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520457896",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
