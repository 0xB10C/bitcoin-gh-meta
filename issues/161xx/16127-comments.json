[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18731 (refactor: Make CCheckQueue RAII-styled by hebasto)\n* #18710 (Add local thread pool to CCheckQueue by hebasto)\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n* #16673 (Relog configuration args on debug.log rotation by LarryRuane)\n* #15719 (Drop Chain::requestMempoolTransactions method by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-05-31T05:21:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497579493",
      "id" : 497579493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzU3OTQ5Mw==",
      "updated_at" : "2020-05-09T03:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497579493",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Strong concept ACK: thanks for fixing this!",
      "created_at" : "2019-05-31T06:59:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497599196",
      "id" : 497599196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzU5OTE5Ng==",
      "updated_at" : "2019-05-31T06:59:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497599196",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In a few cases we need to use `std::mutex` rather than the sync.h primitives.\r\n\r\nCan you explain why?",
      "created_at" : "2019-05-31T07:07:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497601104",
      "id" : 497601104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzYwMTEwNA==",
      "updated_at" : "2019-05-31T07:07:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497601104",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag Our \"default\" mutexes are recursive mutexes (which you can enter multiple times from the same thread). They're easier to work with as you don't need to worry about whether to call a lock-grabbing function from either inside or outside the lock. However, recursive mutexes can't be used for condition variable waiting, so for those, we use std::mutex (which is not recursive) directly.\n\nLonger term we should try to get rid of recursive mutexes entirely; code is much cleaner without them.",
      "created_at" : "2019-05-31T10:31:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497661895",
      "id" : 497661895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzY2MTg5NQ==",
      "updated_at" : "2019-05-31T10:31:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497661895",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "How is this different from using `Mutex` and `Lock`?\r\n\r\nE.g.\r\n\r\n```cpp\r\nMutex m;\r\nLOCK(m);",
      "created_at" : "2019-05-31T14:42:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-497733944",
      "id" : 497733944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzczMzk0NA==",
      "updated_at" : "2019-05-31T14:42:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497733944",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa thanks, I was aware of that. I wasn't sure _why_ \"In a few cases we need to use `std::mutex`\".",
      "created_at" : "2019-06-02T19:36:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-498059158",
      "id" : 498059158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5ODA1OTE1OA==",
      "updated_at" : "2019-06-02T19:36:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/498059158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> How is this different from using `Mutex` and `Lock`?\r\n\r\nIf you do `Mutex cs;` instead of `std::mutex cs;` then you can do `LOCK(cs);` or `WAIT_LOCK(cs, g);` instead of `MutexGuard g(cs);`. In that case the type of `g` changes from a trivial subclass of `std::lock_guard` to `UniqueLock` which is a subclass of `std::unique_lock` that supports `DEBUG_LOCKCONTENTION` in which case it uses `LogPrintf` to report potential deadlocks or lock contention. Even without the extra features we have, `std::unique_lock` is potentially higher overhead than `std::lock_guard`, but `std::lock_guard` isn't unlockable except on destruction, so `unique_lock` is needed for use with condition variables.\r\n\r\n * We can't use `Mutex` for locking for the logging API, because that is a circular dependency.\r\n * We use `std::mutex` in code that implements our specialised locking behaviour got `Mutex` etc.\r\n * We don't use `Mutex` in `support/lockedpool.h`, probably because at present it is independent of bitcoin interfaces in general (this PR adds a dependency on threadsafety.h, so maybe just using `Mutex` would make sense at that point).\r\n * We use `std::mutex` instead of `Mutex` for protecting `dir_locks` in `util/system.h`, not sure if there's a circular dependency there to justify it though?\r\n * We also use `std::mutex` in some unit tests, which I don't think matters much.\r\n\r\nThere's some cases where we currently use `std::lock_guard<std::mutex> g(cs)` where `cs` is a `Mutex`, rather than calling `LOCK(cs);` or `WAIT_LOCK(cs, g);` That saves a bit of overhead, while losing our contention/deadlock debugging info, which I'm not sure makes much sense. I've updated this PR to change those instances to just use `LOCK(cs)` instead of `lock_guard`.\r\n\r\nI think that means it makes sense to:\r\n\r\n * Use `Mutex` and `LOCK` etc as the \"normal\" locking mechanism.\r\n * Use `RecursiveMutex` (aka `CCriticalSection`) if recursive locks are needed, or it's old code that we haven't worked through yet.\r\n * Use `std::mutex` and `{ MutexGuard guard(mutex); ... }` for code that's used to implement `Mutex`\r\n\r\nI've bumped this PR to replace a couple of the `lock_guard` instances that referred to our Mutex/CCriticalSection classes with `LOCK` instead of `MutexGuard`.",
      "created_at" : "2019-06-03T01:22:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-498083950",
      "id" : 498083950,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5ODA4Mzk1MA==",
      "updated_at" : "2019-06-03T01:22:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/498083950",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> We can't use Mutex for locking for the logging API, because that is a circular dependency.\r\n\r\nI don't think this is true (that we can't allow a circular dependency), but maybe you can explain more. I think ideally, we would just use `Mutex` and `RecursiveMutex` everywhere, since they fully support LOCK macros, lock assertions, lock annotations, deadlock detection, and so on. What exactly is the need for std::mutex and MutexGuard?\r\n",
      "created_at" : "2019-06-05T12:48:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-499068336",
      "id" : 499068336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTA2ODMzNg==",
      "updated_at" : "2019-06-05T13:28:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499068336",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > We can't use Mutex for locking for the logging API, because that is a circular dependency.\r\n> \r\n> I don't think this is true (that we can't allow a circular dependency), but maybe you can explain more. \r\n\r\nMaybe; `LOCK(m);` becomes a call to `UniqueLock` contstructor, which calls `Enter()` (or `TryEnter()`), which calls `EnterCritical()`, which calls `push_lock()` which may call `potential_deadlock_detected()` which then calls `LogPrintf`, which calls `LogPrintStr` which, when logging to a file, will then lock `m_file_mutex`. But I don't think that actually causes a problem, because I don't think any lock is ever taken while the m_file_mutex is held, so that shouldn't trigger potential_deadlock_detected.\r\n\r\nThere's also the case if you compile with `-DDEBUG_LOCKCONTENTION`. If two processes try to log simultaneously, the first one will lock `m_file_mutex` successfully, while the second one will fail at the `try_lock` phase of `UniqueLock::Enter`, which will then call `PrintLockContention` and hence `LogPrintf`, and recursively fail for the same reason until `m_file_mutex` is released, at which point things should clean up.\r\n\r\n> I think ideally, we would just use `Mutex` and `RecursiveMutex` everywhere, since they fully support LOCK macros, lock assertions, lock annotations, deadlock detection, and so on. What exactly is the need for std::mutex and MutexGuard?\r\n\r\nIf we can switch all the uses of std::mutex to Mutex, I don't think there's a need for MutexGuard.",
      "created_at" : "2019-06-05T13:54:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-499092691",
      "id" : 499092691,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTA5MjY5MQ==",
      "updated_at" : "2019-06-05T13:54:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499092691",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased; updated to only use `MutexGuard` for logging.h.\r\n\r\nRemaining uses of `std::mutex` and `lock_guard` are sync.h (duh), logging.h (which is used by sync.h), support/lockedpool.h (could be changed to Mutex, but I'm not confident the overhead wouldn't cause problems), tests/checkqueue_tests.cpp (complicated, and just a test) and leveldb.",
      "created_at" : "2020-02-11T07:31:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-584508080",
      "id" : 584508080,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NDUwODA4MA==",
      "updated_at" : "2020-02-11T07:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584508080",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r391997044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391997044"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: if you're reflowing this code anyway, can you put { } around the then branch?",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-03-13T02:23:02Z",
      "diff_hunk" : "@@ -290,11 +291,14 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_UniqueCheck)\n             control.Add(vChecks);\n         }\n     }\n-    bool r = true;\n-    BOOST_REQUIRE_EQUAL(UniqueCheck::results.size(), COUNT);\n-    for (size_t i = 0; i < COUNT; ++i)\n-        r = r && UniqueCheck::results.count(i) == 1;\n-    BOOST_REQUIRE(r);\n+    {\n+        LOCK(UniqueCheck::m);\n+        bool r = true;\n+        BOOST_REQUIRE_EQUAL(UniqueCheck::results.size(), COUNT);\n+        for (size_t i = 0; i < COUNT; ++i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r391997044",
      "id" : 391997044,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5NzA0NA==",
      "original_commit_id" : "7c3979f9c54293a91fa950af8d7610a7f2487c28",
      "original_line" : 298,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/test/checkqueue_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 374008911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T06:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391997044",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r391998012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391998012"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe move MutexGuard to sync.h, as it's more generally useful?",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-03-13T02:27:50Z",
      "diff_hunk" : "@@ -62,9 +63,18 @@ namespace BCLog {\n     {\n     private:\n         mutable std::mutex m_cs;                   // Can not use Mutex from sync.h because in debug mode it would cause a deadlock when a potential deadlock was detected\n-        FILE* m_fileout = nullptr;                 // GUARDED_BY(m_cs)\n-        std::list<std::string> m_msgs_before_open; // GUARDED_BY(m_cs)\n-        bool m_buffering{true};                    //!< Buffer messages before logging can be started. GUARDED_BY(m_cs)\n+\n+        // so MutexGuard provides an annotated version of lock_guard for us",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r391998012",
      "id" : 391998012,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5ODAxMg==",
      "original_commit_id" : "165d3edc86ec30cfbbde551a24e72c7f104c5c43",
      "original_line" : 67,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/logging.h",
      "position" : null,
      "pull_request_review_id" : 374008911,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T06:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391998012",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r392085444"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392085444"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There are a bunch of places that include logging.h but not sync.h, so doing it via threadsafety.h might keep things a little more minimal? I've done this.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-03-13T08:22:12Z",
      "diff_hunk" : "@@ -62,9 +63,18 @@ namespace BCLog {\n     {\n     private:\n         mutable std::mutex m_cs;                   // Can not use Mutex from sync.h because in debug mode it would cause a deadlock when a potential deadlock was detected\n-        FILE* m_fileout = nullptr;                 // GUARDED_BY(m_cs)\n-        std::list<std::string> m_msgs_before_open; // GUARDED_BY(m_cs)\n-        bool m_buffering{true};                    //!< Buffer messages before logging can be started. GUARDED_BY(m_cs)\n+\n+        // so MutexGuard provides an annotated version of lock_guard for us",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r392085444",
      "id" : 392085444,
      "in_reply_to_id" : 391998012,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NTQ0NA==",
      "original_commit_id" : "165d3edc86ec30cfbbde551a24e72c7f104c5c43",
      "original_line" : 67,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/logging.h",
      "position" : null,
      "pull_request_review_id" : 374116067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T06:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392085444",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r392085481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392085481"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-03-13T08:22:18Z",
      "diff_hunk" : "@@ -290,11 +291,14 @@ BOOST_AUTO_TEST_CASE(test_CheckQueue_UniqueCheck)\n             control.Add(vChecks);\n         }\n     }\n-    bool r = true;\n-    BOOST_REQUIRE_EQUAL(UniqueCheck::results.size(), COUNT);\n-    for (size_t i = 0; i < COUNT; ++i)\n-        r = r && UniqueCheck::results.count(i) == 1;\n-    BOOST_REQUIRE(r);\n+    {\n+        LOCK(UniqueCheck::m);\n+        bool r = true;\n+        BOOST_REQUIRE_EQUAL(UniqueCheck::results.size(), COUNT);\n+        for (size_t i = 0; i < COUNT; ++i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r392085481",
      "id" : 392085481,
      "in_reply_to_id" : 391997044,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA4NTQ4MQ==",
      "original_commit_id" : "7c3979f9c54293a91fa950af8d7610a7f2487c28",
      "original_line" : 298,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/test/checkqueue_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 374116124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-06T06:07:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392085481",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased to master to avoid #18111 and updated with @sipa's suggestions.",
      "created_at" : "2020-03-13T08:24:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-598605665",
      "id" : 598605665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODYwNTY2NQ==",
      "updated_at" : "2020-03-13T08:24:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598605665",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-25T19:48:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-604049302",
      "id" : 604049302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDA0OTMwMg==",
      "updated_at" : "2020-03-25T19:48:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604049302",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased for the ToString changes",
      "created_at" : "2020-03-26T03:21:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-604205991",
      "id" : 604205991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNDIwNTk5MQ==",
      "updated_at" : "2020-03-26T03:21:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604205991",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-17T15:18:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-615303711",
      "id" : 615303711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNTMwMzcxMQ==",
      "updated_at" : "2020-04-17T15:18:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/615303711",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased",
      "created_at" : "2020-05-06T11:58:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-624606896",
      "id" : 624606896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNDYwNjg5Ng==",
      "updated_at" : "2020-05-06T11:58:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/624606896",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-05-09T04:52:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#issuecomment-626105963",
      "id" : 626105963,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16127",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNjEwNTk2Mw==",
      "updated_at" : "2020-05-09T04:52:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/626105963",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422453441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422453441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c3cf2f55013c4ea1c1ef4a878fc7ff8e92f2c42d\r\nIt seems this changes behavior as `m_could_reserve = true;` is also guarded by mutex currently.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-09T05:00:33Z",
      "diff_hunk" : "@@ -1989,18 +1988,15 @@ class CoinsViewScanReserver\n \n     bool reserve() {\n         CHECK_NONFATAL(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(g_utxosetscan);\n-        if (g_scan_in_progress) {\n+        if (g_scan_in_progress.exchange(true)) {\n             return false;\n         }\n-        g_scan_in_progress = true;\n         m_could_reserve = true;\n         return true;\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422453441",
      "id" : 422453441,
      "line" : 1996,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MzQ0MQ==",
      "original_commit_id" : "c3cf2f55013c4ea1c1ef4a878fc7ff8e92f2c42d",
      "original_line" : 1996,
      "original_position" : 20,
      "original_start_line" : 1989,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 74,
      "pull_request_review_id" : 408612834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : 1989,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-09T05:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422453441",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422453632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422453632"
         }
      },
      "author_association" : "MEMBER",
      "body" : "960d64d326c501dbe22b80094171d7fe3e86bd69\r\nIt seems this changes behavior as the whole block is guarded by mutex currently.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-09T05:03:14Z",
      "diff_hunk" : "@@ -1286,8 +1285,7 @@ class WalletRescanReserver\n     bool reserve()\n     {\n         assert(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(m_wallet.mutexScanning);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422453632",
      "id" : 422453632,
      "line" : 1289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1MzYzMg==",
      "original_commit_id" : "960d64d326c501dbe22b80094171d7fe3e86bd69",
      "original_line" : 1289,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 12,
      "pull_request_review_id" : 408613004,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-09T05:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422453632",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422455250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422455250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`m_could_reserve` isn't a global, and instances of `CoinsViewScanReserver` aren't shared across threads either.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-09T05:31:33Z",
      "diff_hunk" : "@@ -1989,18 +1988,15 @@ class CoinsViewScanReserver\n \n     bool reserve() {\n         CHECK_NONFATAL(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(g_utxosetscan);\n-        if (g_scan_in_progress) {\n+        if (g_scan_in_progress.exchange(true)) {\n             return false;\n         }\n-        g_scan_in_progress = true;\n         m_could_reserve = true;\n         return true;\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422455250",
      "id" : 422455250,
      "in_reply_to_id" : 422453441,
      "line" : 1996,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NTI1MA==",
      "original_commit_id" : "c3cf2f55013c4ea1c1ef4a878fc7ff8e92f2c42d",
      "original_line" : 1996,
      "original_position" : 20,
      "original_start_line" : 1989,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 74,
      "pull_request_review_id" : 408614445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : 1989,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-09T05:31:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422455250",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422455355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422455355"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same reasoning as previous; except that this one sets `fScanningWallet` to `true` twice :(",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-09T05:33:44Z",
      "diff_hunk" : "@@ -1286,8 +1285,7 @@ class WalletRescanReserver\n     bool reserve()\n     {\n         assert(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(m_wallet.mutexScanning);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422455355",
      "id" : 422455355,
      "in_reply_to_id" : 422453632,
      "line" : 1289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NTM1NQ==",
      "original_commit_id" : "960d64d326c501dbe22b80094171d7fe3e86bd69",
      "original_line" : 1289,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 12,
      "pull_request_review_id" : 408614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-09T05:33:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422455355",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422456173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422456173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, I see that all instances of `CoinsViewScanReserver` are local in the `scantxoutset()` function.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-09T05:47:28Z",
      "diff_hunk" : "@@ -1989,18 +1988,15 @@ class CoinsViewScanReserver\n \n     bool reserve() {\n         CHECK_NONFATAL(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(g_utxosetscan);\n-        if (g_scan_in_progress) {\n+        if (g_scan_in_progress.exchange(true)) {\n             return false;\n         }\n-        g_scan_in_progress = true;\n         m_could_reserve = true;\n         return true;\n     }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r422456173",
      "id" : 422456173,
      "in_reply_to_id" : 422453441,
      "line" : 1996,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ1NjE3Mw==",
      "original_commit_id" : "c3cf2f55013c4ea1c1ef4a878fc7ff8e92f2c42d",
      "original_line" : 1996,
      "original_position" : 20,
      "original_start_line" : 1989,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 74,
      "pull_request_review_id" : 408615250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "RIGHT",
      "start_line" : 1989,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-09T05:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422456173",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r426133811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426133811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So why not dropping the following `m_wallet.fScanningWallet = true;` ?",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-16T08:44:20Z",
      "diff_hunk" : "@@ -1286,8 +1285,7 @@ class WalletRescanReserver\n     bool reserve()\n     {\n         assert(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(m_wallet.mutexScanning);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r426133811",
      "id" : 426133811,
      "in_reply_to_id" : 422453632,
      "line" : 1289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzMzgxMQ==",
      "original_commit_id" : "960d64d326c501dbe22b80094171d7fe3e86bd69",
      "original_line" : 1289,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 12,
      "pull_request_review_id" : 413060075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-16T08:44:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426133811",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r426136962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426136962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As `WalletRescanReserver.m_wallet` is a reference, the object being referenced to could be shared among different threads. So not using the `mutexScanning` mutex here is not thread-safe, IMO.",
      "commit_id" : "a05b44ba00b6b2328967d0ea85576abd6be381b7",
      "created_at" : "2020-05-16T09:29:07Z",
      "diff_hunk" : "@@ -1286,8 +1285,7 @@ class WalletRescanReserver\n     bool reserve()\n     {\n         assert(!m_could_reserve);\n-        std::lock_guard<std::mutex> lock(m_wallet.mutexScanning);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16127#discussion_r426136962",
      "id" : 426136962,
      "in_reply_to_id" : 422453632,
      "line" : 1289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzNjk2Mg==",
      "original_commit_id" : "960d64d326c501dbe22b80094171d7fe3e86bd69",
      "original_line" : 1289,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 12,
      "pull_request_review_id" : 413062849,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16127",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-16T09:29:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426136962",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
