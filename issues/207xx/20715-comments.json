[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20828 (fuzz: Introduce CallOneOf helper to replace switch-case by MarcoFalke)\n* #16545 (refactor: Implement missing error checking for ArgsManager flags by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-18T16:57:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#issuecomment-748203792",
      "id" : 748203792,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20715",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODIwMzc5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T12:26:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748203792",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-12-19T09:30:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#issuecomment-748448430",
      "id" : 748448430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20715",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODQ0ODQzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-19T09:30:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748448430",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555515823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555515823"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why ban a dash anywhere in the command, rather than just at the start?",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-12T05:04:40Z",
      "diff_hunk" : "@@ -518,6 +533,11 @@ void ArgsManager::AddArg(const std::string& name, const std::string& help, unsig\n     auto ret = arg_map.emplace(arg_name, Arg{name.substr(eq_index, name.size() - eq_index), help, flags});\n     assert(ret.second); // Make sure an insertion actually happened\n \n+    if (flags & ArgsManager::COMMAND) {\n+        Assert(flags == ArgsManager::COMMAND); // Combination not allowed\n+        Assert(name.find('=') == std::string::npos);\n+        Assert(name.find('-') == std::string::npos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555515823",
      "id" : 555515823,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTUxNTgyMw==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 539,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : null,
      "pull_request_review_id" : 565941201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555515823",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555571079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555571079"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure multiple (sub)commands makes sense for us. At present, I think we have:\r\n\r\n * bitcoind - doesn't take subcommands\r\n * bitcoin-wallet - wants a single subcommand\r\n * bitcoin-tx - wants multiple instructions with parameters\r\n * bitcoin-cli - wants to do its own parsing of stuff after the options\r\n * bitcoin-qt - does its own parsing of stuff after the options for payment server support\r\n \r\nFor bitcoin-util, I think we want it to be more like bitcoin-wallet, and if we were to do a psbt version of bitcoin-tx's multiple commands in order to construct a psbt, I think that would look like `bitcoin-util psbt <subsubcmd> <subsubcmd> ..`.\r\n\r\nSo I don't think it makes much sense to support multiple subcommands, particularly without letting them have their own params. Which I think means you could have a nicer implementation with something like https://github.com/ajtowns/bitcoin/commits/202101-getcommand which lets you just say `AddCmd(...)` to start introducing new commands, don't have to explicitly set `accept_any_command` when parsing, and can just invoke `GetCommand()` and `GetArguments()` to get the pre-parsed results. Thoughts?\r\n\r\nI've added a second commit on that branch that allows the ArgsManager options to come after the command, which is the same as this PR, but differs from current master (which leaves later options up to the command -- so bitcoin-cli treats them as rpc args, while bitcoin-wallet currently just silently ignores them).",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-12T07:50:34Z",
      "diff_hunk" : "@@ -310,8 +311,16 @@ bool ArgsManager::ParseParameters(int argc, const char* const argv[], std::strin\n             key[0] = '-';\n #endif\n \n-        if (key[0] != '-')\n-            break;\n+        if (key[0] != '-') {\n+            if (accept_any_command) break;\n+            Optional<unsigned int> flags = GetArgFlags(key);\n+            if (!flags || !(*flags & ArgsManager::COMMAND)) {\n+                error = strprintf(\"Invalid command '%s'\", argv[i]);\n+                return false;\n+            }\n+            m_commands.push_back(key);\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555571079",
      "id" : 555571079,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3MTA3OQ==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 322,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : null,
      "pull_request_review_id" : 565941201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555571079",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555574662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555574662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would be a lot better if we could link options to commands (so `-format` could be tied to `createfromdump` directly rather than having it hidden in the help text and having a special cased if statement). Some options would need to be available for multiple (but not all) commands (`-dumpfile` for `dump` and `createfromdump` eg).\r\n\r\nThis seems like a bit more of an intrusive change to make, and probably doesn't have to be done immediately though.\r\n",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-12T07:57:48Z",
      "diff_hunk" : "@@ -33,59 +33,60 @@ static void SetupWalletToolArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-format=<format>\", \"The format of the wallet file to create. Either \\\"bdb\\\" or \\\"sqlite\\\". Only used with 'createfromdump'\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-printtoconsole\", \"Send trace/debug info to console (default: 1 when no -debug is true, 0 otherwise).\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n \n-    argsman.AddArg(\"info\", \"Get wallet info\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"create\", \"Create new wallet file\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"salvage\", \"Attempt to recover private keys from a corrupt wallet. Warning: 'salvage' is experimental.\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"dump\", \"Print out all of the wallet key-value records\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"createfromdump\", \"Create new wallet file from dumped records\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"info\", \"Get wallet info\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"create\", \"Create new wallet file\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"salvage\", \"Attempt to recover private keys from a corrupt wallet. Warning: 'salvage' is experimental.\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"dump\", \"Print out all of the wallet key-value records\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"createfromdump\", \"Create new wallet file from dumped records\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555574662",
      "id" : 555574662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU3NDY2Mg==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 40,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/bitcoin-wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 565941201,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555574662",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555582290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555582290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This seems like a bit more of an intrusive change to make, and probably doesn't have to be done immediately though.\r\n\r\nIndeed. Will leave this for a follow-up. This should be a minimal bugfix/feature commit.",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-12T08:13:50Z",
      "diff_hunk" : "@@ -33,59 +33,60 @@ static void SetupWalletToolArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-format=<format>\", \"The format of the wallet file to create. Either \\\"bdb\\\" or \\\"sqlite\\\". Only used with 'createfromdump'\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-printtoconsole\", \"Send trace/debug info to console (default: 1 when no -debug is true, 0 otherwise).\", ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n \n-    argsman.AddArg(\"info\", \"Get wallet info\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"create\", \"Create new wallet file\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"salvage\", \"Attempt to recover private keys from a corrupt wallet. Warning: 'salvage' is experimental.\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"dump\", \"Print out all of the wallet key-value records\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n-    argsman.AddArg(\"createfromdump\", \"Create new wallet file from dumped records\", ArgsManager::ALLOW_ANY, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"info\", \"Get wallet info\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"create\", \"Create new wallet file\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"salvage\", \"Attempt to recover private keys from a corrupt wallet. Warning: 'salvage' is experimental.\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"dump\", \"Print out all of the wallet key-value records\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);\n+    argsman.AddArg(\"createfromdump\", \"Create new wallet file from dumped records\", ArgsManager::COMMAND, OptionsCategory::COMMANDS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r555582290",
      "id" : 555582290,
      "in_reply_to_id" : 555574662,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTU4MjI5MA==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 40,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/bitcoin-wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 566023116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555582290",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r556369068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556369068"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-13T09:14:16Z",
      "diff_hunk" : "@@ -518,6 +533,11 @@ void ArgsManager::AddArg(const std::string& name, const std::string& help, unsig\n     auto ret = arg_map.emplace(arg_name, Arg{name.substr(eq_index, name.size() - eq_index), help, flags});\n     assert(ret.second); // Make sure an insertion actually happened\n \n+    if (flags & ArgsManager::COMMAND) {\n+        Assert(flags == ArgsManager::COMMAND); // Combination not allowed\n+        Assert(name.find('=') == std::string::npos);\n+        Assert(name.find('-') == std::string::npos);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r556369068",
      "id" : 556369068,
      "in_reply_to_id" : 555515823,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2OTA2OA==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 539,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : null,
      "pull_request_review_id" : 567022546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556369068",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r556369445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556369445"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, took most of your changes",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-13T09:14:52Z",
      "diff_hunk" : "@@ -310,8 +311,16 @@ bool ArgsManager::ParseParameters(int argc, const char* const argv[], std::strin\n             key[0] = '-';\n #endif\n \n-        if (key[0] != '-')\n-            break;\n+        if (key[0] != '-') {\n+            if (accept_any_command) break;\n+            Optional<unsigned int> flags = GetArgFlags(key);\n+            if (!flags || !(*flags & ArgsManager::COMMAND)) {\n+                error = strprintf(\"Invalid command '%s'\", argv[i]);\n+                return false;\n+            }\n+            m_commands.push_back(key);\n+            continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r556369445",
      "id" : 556369445,
      "in_reply_to_id" : 555571079,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjM2OTQ0NQ==",
      "original_commit_id" : "faaf1b26c1abf768a3b36c0fb8c5ba814b6f24c1",
      "original_line" : 322,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : null,
      "pull_request_review_id" : 567023069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-14T10:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556369445",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nðµï¸ @jonatack has been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-01-13T11:46:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#issuecomment-759396625",
      "id" : 759396625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20715",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTM5NjYyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T11:46:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759396625",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-14T10:16:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#issuecomment-760099386",
      "id" : 760099386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20715",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDA5OTM4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T10:16:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760099386",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased once more",
      "created_at" : "2021-01-14T15:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#issuecomment-760258967",
      "id" : 760258967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20715",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDI1ODk2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T15:12:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760258967",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557883567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557883567"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be good to call it `AddCommand` and `GetCommand` for consistency?",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-15T06:11:15Z",
      "diff_hunk" : "@@ -359,6 +374,19 @@ Optional<unsigned int> ArgsManager::GetArgFlags(const std::string& name) const\n     return nullopt;\n }\n \n+bool ArgsManager::GetCommand(std::string& cmd, std::vector<std::string>& args) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557883567",
      "id" : 557883567,
      "line" : 377,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg4MzU2Nw==",
      "original_commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "original_line" : 377,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : 45,
      "pull_request_review_id" : 568878130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-15T06:17:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557883567",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557884197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557884197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I wonder if it wouldn't be better to always copy the remaining args into `m_command` and have the only difference be that you get an \"unknown command\" when `m_accept_any_command` is set",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-15T06:12:09Z",
      "diff_hunk" : "@@ -359,6 +374,19 @@ Optional<unsigned int> ArgsManager::GetArgFlags(const std::string& name) const\n     return nullopt;\n }\n \n+bool ArgsManager::GetCommand(std::string& cmd, std::vector<std::string>& args) const\n+{\n+    LOCK(cs_args);\n+    assert(!m_accept_any_command); // AddCmd must have been called before this",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557884197",
      "id" : 557884197,
      "line" : 380,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg4NDE5Nw==",
      "original_commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "original_line" : 380,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/util/system.cpp",
      "position" : 48,
      "pull_request_review_id" : 568878130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-15T06:17:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557884197",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557886983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557886983"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This feels a bit messy; when trying this for bitcoin-util, I added a `struct CmdArg { string cmd; vector<string> args; };` to track them both.",
      "commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "created_at" : "2021-01-15T06:15:48Z",
      "diff_hunk" : "@@ -94,33 +95,28 @@ int main(int argc, char* argv[])\n         return EXIT_FAILURE;\n     }\n \n-    std::string method {};\n-    for(int i = 1; i < argc; ++i) {\n-        if (!IsSwitchChar(argv[i][0])) {\n-            if (!method.empty()) {\n-                tfm::format(std::cerr, \"Error: two methods provided (%s and %s). Only one method should be provided.\\n\", method, argv[i]);\n-                return EXIT_FAILURE;\n-            }\n-            method = argv[i];\n-        }\n-    }\n-\n-    if (method.empty()) {\n+    std::string method;\n+    std::vector<std::string> cmdargs;\n+    if (!args.GetCommand(method, cmdargs)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20715#discussion_r557886983",
      "id" : 557886983,
      "line" : 100,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg4Njk4Mw==",
      "original_commit_id" : "fad369f04361e2e3a834589b63fab160b9b4e1b2",
      "original_line" : 100,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/bitcoin-wallet.cpp",
      "position" : 101,
      "pull_request_review_id" : 568878130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20715",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-15T06:17:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557886983",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
