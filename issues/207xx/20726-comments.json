[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20373 (refactor, net: Increase CNode data member encapsulation by hebasto)\n* #20158 (tree-wide: De-globalize ChainstateManager by dongcarl)\n* #19860 (Improve diversification of new connections: privacy and stability by naumenkogs)\n* #19843 (Refactoring and minor improvement for self-advertisements by naumenkogs)\n* #19315 ([tests] Allow outbound & block-relay-only connections in functional tests. by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-20T00:26:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20726#issuecomment-748544179",
      "id" : 748544179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODU0NDE3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T00:26:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748544179",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20726#discussion_r546324067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20726"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546324067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We do relay transactions with manual peers, right?",
      "commit_id" : "47994f4ec94d1283f34e4770497725bdb83de1f3",
      "created_at" : "2020-12-20T05:21:50Z",
      "diff_hunk" : "@@ -2566,6 +2572,33 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    if (msg_type == NetMsgType::BLOCKRELAY) {\n+        if (pfrom.fSuccessfullyConnected) {\n+            // Disconnect peers that send blockrelay message after VERACK; this\n+            // must be negotiated between VERSION and VERACK.\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (pfrom.IsFullOutboundConn() || pfrom.IsAddrFetchConn()) {\n+            // If we picked an outbound for tx- or addr-relay and it sends us a\n+            // BLOCKRELAY, find another peer.\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        if (pfrom.m_tx_relay != nullptr && WITH_LOCK(pfrom.m_tx_relay->cs_filter, return pfrom.m_tx_relay->fRelayTxes)) {\n+            // Can't send a BLOCKRELAY message if they didn't turn off tx-relay\n+            // in the version message.\n+            pfrom.fDisconnect = true;\n+        }\n+        if (pfrom.IsInboundConn()) {\n+            pfrom.UpdateConnectionType(ConnectionType::INBOUND_BLOCK_RELAY);\n+        }\n+        // If an outbound peer (manual or block-relay-only) sends us this\n+        // message, we just ignore it. We won't relay transactions with such",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20726#discussion_r546324067",
      "id" : 546324067,
      "line" : 2597,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMyNDA2Nw==",
      "original_commit_id" : "47994f4ec94d1283f34e4770497725bdb83de1f3",
      "original_line" : 2597,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 39,
      "pull_request_review_id" : 555987112,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20726",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-20T05:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546324067",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nI think the inbound-block-relay connection type highlights that it may be a good idea to use more clear terms for outbound-full-relay and outbound-block-relay connections. In short: `{inbound, outbound}-{full, block}-relay`. I'll post a proposal/RFC.",
      "created_at" : "2020-12-20T08:27:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20726#issuecomment-748578410",
      "id" : 748578410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODU3ODQxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T08:27:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748578410",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-12-20T12:02:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20726#issuecomment-748598786",
      "id" : 748598786,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODU5ODc4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T12:02:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748598786",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK to having a way to not send `addr` messages to inbound block-relay-only peers.\r\n\r\nDid you consider doing this implicitly, i.e. only consider a peer an addr-relay peer if:\r\n\r\n1. it's an outbound peer that isn't block-relay-peer; or\r\n2. it's an inbound peer and we've received an `addr`, `addrv2` or `getaddr` from the peer.\r\n\r\nFor inbound peers we would defer initializing the addr-relay data structures and considering the peer an addr-relay peer until we receive the first address traffic from it.\r\n\r\nI think this would achieve the goals you want (reduce bandwidth, avoid relaying addresses to black holes, potentially reduce memory usage in future) without the need for a protocol change.",
      "created_at" : "2020-12-20T12:32:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20726#issuecomment-748601961",
      "id" : 748601961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20726",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODYwMTk2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-20T13:34:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748601961",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
