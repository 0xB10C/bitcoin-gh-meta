[
   {
      "author_association" : "MEMBER",
      "body" : "I expect this to be a difficult sell because we generally don't treat any of the data files as a stable external interface. Pointers to the file system can be considered implementation details subject to change.\r\n\r\nBut on the other hand, the format of the block files *specifically* hasn't ever significantly changed, and is (I think) unlikely to change. \r\n\r\nTo be clear I definitely see when this can be useful. For example the size of our own `contrib/linearize` tool could be cut in half by using this.\r\n",
      "created_at" : "2020-12-18T13:26:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#issuecomment-748083364",
      "id" : 748083364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20702",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODA4MzM2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T13:26:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748083364",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20012 (rpc: Remove duplicate name and argNames from CRPCCommand by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-12-18T16:58:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#issuecomment-748204434",
      "id" : 748204434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20702",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODIwNDQzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T16:58:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748204434",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Perhaps there are ways to mitigate this issue? I could see two situations in which block data move around:\r\n\r\n* arbitrarily during run time - this seems incredibly unlikely outside of reorgs (reindexing needs to be done in case of reorgs anyway)\r\n* on upgrade - upgrade may take longer time because of this; similar things already happened to indexes\r\n\r\nA simple way to deal with these is to have some kind of \"block layout version\" that can be obtained over RPC. If the layout is ever changed, the version is bumped and indexers will need to reindex. As described above, this is most likely in case of a long upgrade needs to be done anyway, so it wouldn't be too annoying.\r\n\r\nTo make it a bit more future-proof we could have two version numbers: one for the format of blocks already on disk, another for format in general. If bitcoind is updated, the existing blocks are not changed, but future blocks may have some differences then the former version number doesn't change the latter does - avoids reindex when not actually needed and also avoids indexers that don't support a new version blindly attempting to process a layout they don't understand.\r\n\r\nI believe it'd be best to introduce this versioning right from the start. (Just return constant zeroes for now.)\r\n\r\nIf it ever happens that a single block (or a few blocks) is moved around, then doing full reindexing would be inefficient but I assume it'd be sensible to not try to solve it right now. That means let's not do something excessive like adding a layout version to each block now.",
      "created_at" : "2020-12-18T19:08:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#issuecomment-748267420",
      "id" : 748267420,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20702",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0ODI2NzQyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-18T19:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/748267420",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1178779?v=4",
         "events_url" : "https://api.github.com/users/Kixunil/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kixunil/followers",
         "following_url" : "https://api.github.com/users/Kixunil/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kixunil/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kixunil",
         "id" : 1178779,
         "login" : "Kixunil",
         "node_id" : "MDQ6VXNlcjExNzg3Nzk=",
         "organizations_url" : "https://api.github.com/users/Kixunil/orgs",
         "received_events_url" : "https://api.github.com/users/Kixunil/received_events",
         "repos_url" : "https://api.github.com/users/Kixunil/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kixunil/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kixunil/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kixunil"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546035310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546035310"
         }
      },
      "author_association" : "NONE",
      "body" : "@romanz do you have any plan for what to do with `electrs` if this is removed in the future?",
      "commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "created_at" : "2020-12-18T19:09:56Z",
      "diff_hunk" : "@@ -2470,6 +2470,60 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+static RPCHelpMan getblocklocations()\n+{\n+    return RPCHelpMan{\"getblocklocations\",\n+                \"\\nEXPERIMENTAL warning: this call may be removed or changed in future releases.\\n\"\n+                \"\\nReturns a JSON for the location of 'blockhash' and its previous 'nblocks' block and undo data.\\n\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546035310",
      "id" : 546035310,
      "line" : 2477,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjAzNTMxMA==",
      "original_commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "original_line" : 2477,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 8,
      "pull_request_review_id" : 555747009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T19:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546035310",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1178779?v=4",
         "events_url" : "https://api.github.com/users/Kixunil/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kixunil/followers",
         "following_url" : "https://api.github.com/users/Kixunil/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kixunil/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kixunil",
         "id" : 1178779,
         "login" : "Kixunil",
         "node_id" : "MDQ6VXNlcjExNzg3Nzk=",
         "organizations_url" : "https://api.github.com/users/Kixunil/orgs",
         "received_events_url" : "https://api.github.com/users/Kixunil/received_events",
         "repos_url" : "https://api.github.com/users/Kixunil/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kixunil/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kixunil/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kixunil"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546043984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546043984"
         }
      },
      "author_association" : "NONE",
      "body" : "Perhaps it'd make more sense to test that the blocks stored on the returned offsets contain the same data as when using `getblock` call?",
      "commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "created_at" : "2020-12-18T19:21:55Z",
      "diff_hunk" : "@@ -0,0 +1,47 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the getblocklocations rpc call.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class GetblocklocationsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        \"\"\"Test a trivial usage of the getblocklocations RPC command.\"\"\"\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        node.generate(7)\n+\n+        EXPECTED_LOCATIONS = [\n+            {'file': 0, 'data': 1861, 'undo': 254, 'prev': '1893864d81638cae904357907559248964050547ddcd0dbe3f72e65b5a31bf1f'},\n+            {'file': 0, 'data': 1601, 'undo': 213, 'prev': '1b086a63a5d5c320c747fee32cdb819c6f4f9eb78c24b7c5a33ae794218dc639'},\n+            {'file': 0, 'data': 1341, 'undo': 172, 'prev': '448640031d1418c70a109ea4f88f497804f3336c7309ff7e535894beb80b26e4'},\n+            {'file': 0, 'data': 1081, 'undo': 131, 'prev': '602403f82060e224423a9f22062fad3f5333beeee3c30313f6ea808e37b7e0b2'},\n+            {'file': 0, 'data': 821, 'undo': 90, 'prev': '334ab00aba5d213c8f67161ddff346c4643d0709c3bdafa4b4b05fe6f7e4ed48'},\n+            {'file': 0, 'data': 561, 'undo': 49, 'prev': '43f10598f19eced9c514f5ae40dbce0ab101362a22e18820901c6e03d7babe0b'},\n+            {'file': 0, 'data': 301, 'undo': 8, 'prev': '0f9188f13cb7b2c71f2a335e3a4fc328bf5beb436012afca590b1a11466e2206'},\n+            {'file': 0, 'data': 8, 'prev': '0000000000000000000000000000000000000000000000000000000000000000'},  # genesis block\n+        ]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546043984",
      "id" : 546043984,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0Mzk4NA==",
      "original_commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/rpc_getblocklocations.py",
      "position" : 31,
      "pull_request_review_id" : 555747009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T19:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546043984",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1178779?v=4",
         "events_url" : "https://api.github.com/users/Kixunil/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kixunil/followers",
         "following_url" : "https://api.github.com/users/Kixunil/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kixunil/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kixunil",
         "id" : 1178779,
         "login" : "Kixunil",
         "node_id" : "MDQ6VXNlcjExNzg3Nzk=",
         "organizations_url" : "https://api.github.com/users/Kixunil/orgs",
         "received_events_url" : "https://api.github.com/users/Kixunil/received_events",
         "repos_url" : "https://api.github.com/users/Kixunil/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kixunil/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kixunil/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kixunil"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546044099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546044099"
         }
      },
      "author_association" : "NONE",
      "body" : "I'd like to see this description clarified. Something like: \"The number of blocks to process, including the block with given blockhash. The blocks following the given block will be returned if bigger than one.\"\r\n\r\nI'm not entirely satisfied with my wording either, so will be happy for clearer version. The idea is to communicate what exactly is in the result.",
      "commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "created_at" : "2020-12-18T19:22:13Z",
      "diff_hunk" : "@@ -2470,6 +2470,60 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+static RPCHelpMan getblocklocations()\n+{\n+    return RPCHelpMan{\"getblocklocations\",\n+                \"\\nEXPERIMENTAL warning: this call may be removed or changed in future releases.\\n\"\n+                \"\\nReturns a JSON for the location of 'blockhash' and its previous 'nblocks' block and undo data.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nblocks\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Number of block locations to return\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546044099",
      "id" : 546044099,
      "line" : 2480,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NDA5OQ==",
      "original_commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "original_line" : 2480,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 11,
      "pull_request_review_id" : 555747009,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T19:22:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546044099",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1178779?v=4",
         "events_url" : "https://api.github.com/users/Kixunil/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kixunil/followers",
         "following_url" : "https://api.github.com/users/Kixunil/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kixunil/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kixunil",
         "id" : 1178779,
         "login" : "Kixunil",
         "node_id" : "MDQ6VXNlcjExNzg3Nzk=",
         "organizations_url" : "https://api.github.com/users/Kixunil/orgs",
         "received_events_url" : "https://api.github.com/users/Kixunil/received_events",
         "repos_url" : "https://api.github.com/users/Kixunil/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kixunil/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kixunil/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kixunil"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546046367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546046367"
         }
      },
      "author_association" : "NONE",
      "body" : "I suppose this is hit (also) when the block is pruned? Perhaps document it?",
      "commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "created_at" : "2020-12-18T19:25:04Z",
      "diff_hunk" : "@@ -2470,6 +2470,60 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n+static RPCHelpMan getblocklocations()\n+{\n+    return RPCHelpMan{\"getblocklocations\",\n+                \"\\nEXPERIMENTAL warning: this call may be removed or changed in future releases.\\n\"\n+                \"\\nReturns a JSON for the location of 'blockhash' and its previous 'nblocks' block and undo data.\\n\",\n+                {\n+                    {\"blockhash\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The block hash\"},\n+                    {\"nblocks\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"Number of block locations to return\"},\n+                },\n+                {\n+                    RPCResult{\n+                        RPCResult::Type::ARR, \"\", \"\",\n+                        {\n+                            {RPCResult::Type::NUM, \"file\", \"blk*.dat/rev*.dat file index\"},\n+                            {RPCResult::Type::NUM, \"data\", \"block data file offset\"},\n+                            {RPCResult::Type::NUM, \"undo\", \"undo data file offset (if exists)\"},\n+                            {RPCResult::Type::STR_HEX, \"prev\", \"previous block hash\"},\n+                        }\n+                    },\n+                },\n+                RPCExamples{\n+                    HelpExampleCli(\"getblocklocation\", \"\\\"00000000c937983704a73af28acdec37b049d214adbda81d7e2a3dd146f6ed09\\\" 10\")\n+                },\n+                [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue {\n+\n+    uint256 hash(ParseHashV(request.params[0], \"blockhash\"));\n+    size_t nblocks = request.params[1].get_int();\n+\n+    const CBlockIndex* pblockindex = WITH_LOCK(cs_main, return LookupBlockIndex(hash));\n+    if (!pblockindex) {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20702#discussion_r546046367",
      "id" : 546046367,
      "line" : 2503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjA0NjM2Nw==",
      "original_commit_id" : "6e61171710ac34c06e213db33ff9d07b170f22c2",
      "original_line" : 2503,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 34,
      "pull_request_review_id" : 555758011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20702",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-18T19:25:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546046367",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1178779?v=4",
         "events_url" : "https://api.github.com/users/Kixunil/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Kixunil/followers",
         "following_url" : "https://api.github.com/users/Kixunil/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Kixunil/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Kixunil",
         "id" : 1178779,
         "login" : "Kixunil",
         "node_id" : "MDQ6VXNlcjExNzg3Nzk=",
         "organizations_url" : "https://api.github.com/users/Kixunil/orgs",
         "received_events_url" : "https://api.github.com/users/Kixunil/received_events",
         "repos_url" : "https://api.github.com/users/Kixunil/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Kixunil/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Kixunil/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Kixunil"
      }
   }
]
