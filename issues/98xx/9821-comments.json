[
   {
      "body" : "Concept ACK.  I think this should use a runtime test case at init, not just a boost testcase-- code may be built on a system where it works but run elsewhere and this is too important to mess up. :)",
      "created_at" : "2017-02-21T20:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281465447",
      "id" : 281465447,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T20:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281465447",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I'm OK with adding this to the sanity checks, but in all fairness we don't check that for `/dev/urandom` either, we used to not even have a boost testcase for this code path. Also a failure while reading randomness will already always trigger a fatal abort.",
      "created_at" : "2017-02-21T20:12:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281465909",
      "id" : 281465909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T20:15:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281465909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I think `getrandom` if available should be preferred over using /dev/urandom. While a local root access can both replace /dev/urandom with something else or intercept `getrandom` calls, I expect the latter to require more invasive/detectable changes.",
      "created_at" : "2017-02-21T20:20:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281467995",
      "id" : 281467995,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T20:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281467995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "~Two questions:~\r\n* ~What if you're using a 2.25 or later glibc (which has the `getrandom` function), but your Linux kernel is pre-3.17 (which does not have the syscall)? I have a hard time fnding information about this in the glibc documentation. Either it simulates it by reading /dev/urandom instead, or it fails. If the actual behavior is to fail, we should probably fall back to reading /dev/urandom at runtime rather than at compile time.~\r\n* ~Given that our release binaries should probably not be required to work only on post-2.25 glibc, with this patch we can't compile release binaries against a post-2.25 glibc...~\r\n\r\nNevermind, it seems you're using the syscall directly.\r\n",
      "created_at" : "2017-02-21T20:56:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281477450",
      "id" : 281477450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T21:07:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281477450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : ">  but in all fairness we don't check that for /dev/urandom either, \r\n\r\nYes but we don't have an issue there where there are older kernels that don't have the functionality... (Also, I would be of the view that we should have a runtime test currently too-- but I didn't want to bloat up the original PR that added this.)\r\n",
      "created_at" : "2017-02-21T21:01:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281478836",
      "id" : 281478836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T21:01:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281478836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Concept ACK. utACK on the build changes in particular.",
      "created_at" : "2017-02-21T22:40:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#issuecomment-281506061",
      "id" : 281506061,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9821",
      "updated_at" : "2017-02-21T22:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/281506061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9821#discussion_r102338966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9821"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102338966"
         }
      },
      "body" : "Does this not need the GRND_BLOCK flag? I think we want this blocking rather than returning /dev/random data, no?",
      "commit_id" : "224e6eb089a0f4977d22f3803fc27e44b5e7eea5",
      "created_at" : "2017-02-21T22:46:15Z",
      "diff_hunk" : "@@ -92,32 +103,65 @@ static void RandAddSeedPerfmon()\n }\n \n /** Get 32 bytes of system entropy. */\n-static void GetOSRand(unsigned char *ent32)\n+void GetOSRand(unsigned char *ent32)\n {\n-#ifdef WIN32\n+#if defined(WIN32)\n     HCRYPTPROV hProvider;\n     int ret = CryptAcquireContextW(&hProvider, NULL, NULL, PROV_RSA_FULL, CRYPT_VERIFYCONTEXT);\n     if (!ret) {\n         RandFailure();\n     }\n-    ret = CryptGenRandom(hProvider, 32, ent32);\n+    ret = CryptGenRandom(hProvider, NUM_OS_RANDOM_BYTES, ent32);\n     if (!ret) {\n         RandFailure();\n     }\n     CryptReleaseContext(hProvider, 0);\n+#elif defined(HAVE_SYS_GETRANDOM)\n+    /* Linux. From the getrandom(2) man page:\n+     * \"If the urandom source has been initialized, reads of up to 256 bytes\n+     * will always return as many bytes as requested and will not be\n+     * interrupted by signals.\"\n+     */\n+    if (syscall(SYS_getrandom, ent32, NUM_OS_RANDOM_BYTES, 0) != NUM_OS_RANDOM_BYTES) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9821#discussion_r102338966",
      "id" : 102338966,
      "original_commit_id" : "224e6eb089a0f4977d22f3803fc27e44b5e7eea5",
      "original_position" : 44,
      "path" : "src/random.cpp",
      "position" : 44,
      "pull_request_review_id" : 23092665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9821",
      "updated_at" : "2017-02-21T22:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102338966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
