[
   {
      "body" : "I see that @TheBlueMatt and I managed to make almost the exact same change:\r\n2a278cdaf6ea46dc85a61a37a12a8acd7acd5670 vs a5032b5b0c55c90a8e4df658d85d99824cf4699d. I'm happy to rebase and drop mine if his goes in first.\r\n\r\nEdit: I should also mention that this and #9715 are complementary.",
      "created_at" : "2017-02-08T07:03:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278245944",
      "id" : 278245944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T07:05:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278245944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "What is the risk by not merging this?",
      "created_at" : "2017-02-08T10:39:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278292537",
      "id" : 278292537,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T10:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278292537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "Concept ACK, will give this a more full review after breakfast.\n\nOn February 8, 2017 1:46:00 AM EST, Cory Fields <notifications@github.com> wrote:\n>This is the last of my net issues for 0.14. As discussed with\n>@TheBlueMatt and @gmaxwell.\n>\n>Fixes for a few problems discovered while running a network\n>stress/fuzzer:\n>- Remote nodes weren't always banned when they hadn't yet sent a\n>verack. Regression from 7a8c2519015650acd51eaf42719f04e53f839bbe.\n>- Require a verack before sending any non-handshake messages. This is\n>much more straightforward behavior, and allows for tests to be easily\n>written\n>- Now that there's a sane model for testing, add checks for leaky\n>messages sent out before the handshake is complete, as well as for\n>banning in those cases.\n>You can view, comment on, or merge this pull request online at:\n>\n>  https://github.com/bitcoin/bitcoin/pull/9720\n>\n>-- Commit Summary --\n>\n>  * net: correctly ban before the handshake is complete\n>  * net: parse reject earlier\n>  * net: require a verack before responding to anything else\n>  * qa: allow for a node that does not send an initial version message\n>  * qa: add a test to detect leaky p2p messages\n>\n>-- File Changes --\n>\n>    M qa/pull-tester/rpc-tests.py (1)\n>    A qa/rpc-tests/p2p-leaktests.py (135)\n>    M qa/rpc-tests/test_framework/mininode.py (21)\n>    M src/net_processing.cpp (115)\n>\n>-- Patch Links --\n>\n>https://github.com/bitcoin/bitcoin/pull/9720.patch\n>https://github.com/bitcoin/bitcoin/pull/9720.diff\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9720\n",
      "created_at" : "2017-02-08T14:02:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278336444",
      "id" : 278336444,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T14:02:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278336444",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100094218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100094218"
         }
      },
      "body" : "mind putting braces around this?",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-08T15:40:50Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100094218",
      "id" : 100094218,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 20789251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-08T16:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100094218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100097401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100097401"
         }
      },
      "body" : "nit: The name makes me think `true` means `fShouldBan` was set to true. Invert the boolean?",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-08T15:52:03Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100097401",
      "id" : 100097401,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 20789251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-08T16:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100097401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "I got a few questions about these changes, so I've updated the commit messages to provide (I hope) better back-story/context.",
      "created_at" : "2017-02-08T16:32:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#issuecomment-278380156",
      "id" : 278380156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9720",
      "updated_at" : "2017-02-08T16:32:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278380156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110045"
         }
      },
      "body" : "Heh, i waffled back and forth on this. Sure.",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-08T16:37:52Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110045",
      "id" : 100110045,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 20805665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-08T16:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110096"
         }
      },
      "body" : "Will do.",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-08T16:38:03Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100110096",
      "id" : 100110096,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 20805720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-08T16:38:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100110096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100111274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100111274"
         }
      },
      "body" : "The usual fix for waffling is comment and clarify name :p",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-08T16:42:54Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100111274",
      "id" : 100111274,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : 83,
      "pull_request_review_id" : 20806985,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-08T16:42:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100111274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100255289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100255289"
         }
      },
      "body" : "Nit: avoid `BOOST_FOREACH` if possible (though this was moved code, so perhaps not applicable, but..).\r\n```C++\r\nfor (const CBlockReject& reject : state.rejects) [...]\r\n```",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-09T08:51:19Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100255289",
      "id" : 100255289,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 20954540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-09T08:53:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100255289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/250224?v=3",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100273335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100273335"
         }
      },
      "body" : "No, for moved code this is not applicable. To avoid confusion, let's keep code style changes, moves and bugfixes separate where possible.",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-09T10:17:43Z",
      "diff_hunk" : "@@ -2594,6 +2594,35 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n+static bool SendRejectsAndCheckBan(CNode* pnode, CConnman& connman)\n+{\n+    AssertLockHeld(cs_main);\n+    CNodeState &state = *State(pnode->GetId());\n+\n+    BOOST_FOREACH(const CBlockReject& reject, state.rejects)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100273335",
      "id" : 100273335,
      "original_commit_id" : "0abd2ccfaa24fdd1e5d24271e2360c4d9d64b662",
      "original_position" : 9,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 20973291,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-09T10:17:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100273335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100352357"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100352357"
         }
      },
      "body" : "There are a few cases it looks like we return true after setting misbehaving, so this probably needs to be checked either way (or those cases need updating - but that might result in double-logging).",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-09T16:49:18Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100352357",
      "id" : 100352357,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 21058137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-09T16:49:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100352357",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100362538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100362538"
         }
      },
      "body" : "I was trying to avoid the cs_main lock for each message received, but you're right that it means that we rely on a return value that's not very well-defined.\r\n\r\nI'll just make it unconditional. Until we have parallel processing, there's not much harm in that.\r\n\r\n",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-09T17:30:01Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100362538",
      "id" : 100362538,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 21068804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-09T17:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100362538",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100363468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100363468"
         }
      },
      "body" : "Sounds good.",
      "commit_id" : "42b8a7921e3c347adacc183ba07eb3efdfd631d1",
      "created_at" : "2017-02-09T17:34:00Z",
      "diff_hunk" : "@@ -2706,8 +2735,11 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, const std::atomic<bool>& i\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n-        if (!fRet)\n+        if (!fRet) {\n             LogPrintf(\"%s(%s, %u bytes) FAILED peer=%d\\n\", __func__, SanitizeString(strCommand), nMessageSize, pfrom->id);\n+            LOCK(cs_main);\n+            SendRejectsAndCheckBan(pfrom, connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9720#discussion_r100363468",
      "id" : 100363468,
      "original_commit_id" : "f9829821a2ac4cacd939d39607dbfd419d8e449a",
      "original_position" : 44,
      "path" : "src/net_processing.cpp",
      "position" : 123,
      "pull_request_review_id" : 21069797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9720",
      "updated_at" : "2017-02-09T17:34:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/100363468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
