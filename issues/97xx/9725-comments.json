[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267"
         }
      },
      "body" : "Perhaps we should have a comment here explaining that this function is used for all transaction notifications, and not just when things are added to the mempool?  I can imagine a future reader being confused about why BlockConnected and BlockDisconnected both call this function...",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-02-23T15:22:53Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267",
      "id" : 102736267,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23501945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507"
         }
      },
      "body" : "OK, added a few comments.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-02-23T20:10:56Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507",
      "id" : 102806507,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23574836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136"
         }
      },
      "body" : "To help others review, these two functions seem to mesh with current behavior. I don't see how they could possibly be usable by any client, but there ya go.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T20:18:37Z",
      "diff_hunk" : "@@ -160,3 +162,19 @@ void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CB\n         }\n     }\n }\n+\n+void CZMQNotificationInterface::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136",
      "id" : 104512136,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 17,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 17,
      "pull_request_review_id" : 25352756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485"
         }
      },
      "body" : "Mind changing AddToWalletIfInvolvingMe to take a CTransactionRef here? Looks like we end up keeping 2 copies otherwise.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T20:29:10Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485",
      "id" : 104514485,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25355088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885"
         }
      },
      "body" : "The same set of conflicted transactions is sent here for each block.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T21:18:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885",
      "id" : 104524885,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25366381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518"
         }
      },
      "body" : "pindex can no longer be NULL here.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T22:22:29Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518",
      "id" : 104539518,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25381496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672"
         }
      },
      "body" : "Assert pair.first here too, I think. It'd be nice to doc that the BlockConnected() params are now always non-null.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T22:28:00Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672",
      "id" : 104540672,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25382753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Concept ACK.",
      "created_at" : "2017-03-06T22:30:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284555612",
      "id" : 284555612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T22:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284555612",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555"
         }
      },
      "body" : "Fixed, with a lot more code :(.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T23:13:52Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555",
      "id" : 104549555,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T23:14:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592",
      "id" : 104549592,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T23:15:08Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790",
      "id" : 104549790,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-06T23:18:30Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406",
      "id" : 104550406,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T15:12:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "To fix the issue @theuni found (\"The same set of conflicted transactions is sent here for each block.\"), I had to go rewrite a big chunk of how the mempool removal callback logic works. Now what was previously a standalone class which listens to mempool for transactions removed has gone into the ConnectTrace class, which is accessed in ActivateBestChain to generate callbacks.\r\nAlso, had to rebase.",
      "created_at" : "2017-03-06T23:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284568275",
      "id" : 284568275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T23:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284568275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104680242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104680242"
         }
      },
      "body" : "In commit \"Add pblock to connectTrace at the end of ConnectTip, not start\":\r\n\r\nMaybe write \"The block is added to connectTrace only if the connection succeeds.\" ? \"Always\" and \"in the case\" imply contradictory things to me.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T14:37:06Z",
      "diff_hunk" : "@@ -2240,24 +2240,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is always added to connectTrace in the case connection succeeds.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104680242",
      "id" : 104680242,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104680242",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104682862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104682862"
         }
      },
      "body" : "In commit \"Add pblock to connectTrace at the end of ConnectTip, not start\":\r\n\r\nThis does appear to be doing what the commit message says. But could you add a line like \"Cleanup, no change in behavior\" to the commit message if that is the intention here?\r\n\r\nAs someone interested in being able to contribute reviews, and in being able to understand the direction we're taking the code, it's really helpful to me when I can read a commit message that not only tells me what change the commit is making, but also provides a little hint about why the change is being made.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T14:46:27Z",
      "diff_hunk" : "@@ -2291,6 +2290,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104682862",
      "id" : 104682862,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104682862",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Rebased for trivial conflict from #9605.",
      "created_at" : "2017-03-07T15:12:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284749354",
      "id" : 284749354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-07T15:12:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284749354",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691509"
         }
      },
      "body" : "In commit \"Make ConnectTrace::blocksConnected private, hide behind accessors\":\r\n\r\nDoesn't really matter because this is only called in a single place, and that place happens to require a copy. But if you wanted to write this in a move-compatible way (giving callers flexibility to either move or copy), you could write:\r\n\r\n```\r\nvoid BlockConnected(CBlockIndex* pindex, std::shared_ptr<const CBlock> pblock) {\r\n    blocksConnected.emplace_back(pindex, std::move(pblock));\r\n}\r\n```",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:17:47Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691509",
      "id" : 104691509,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691509",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691580"
         }
      },
      "body" : "In commit \"Make ConnectTrace::blocksConnected private, hide behind accessors\":\r\n\r\nNow we are copying the vector (as well as the shared_ptrs inside) whenever it is accessed, which we weren't doing before. Any reason for this not to return a const reference to the vector to avoid this?\r\n\r\nAlso the method itself should be marked const.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:18:01Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n+        blocksConnected.emplace_back(pindex, pblock);\n+    }\n+\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104691580",
      "id" : 104691580,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104691580",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104692562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104692562"
         }
      },
      "body" : "In commit \"Handle conflicted transactions directly in ConnectTrace\":\r\n\r\nUsing std::move and emplace would be slightly more efficient. Would also make this code have a more internally consistent style.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:21:33Z",
      "diff_hunk" : "@@ -2231,19 +2198,46 @@ static int64_t nTimePostConnect = 0;\n /**\n  * Used to track blocks whose transactions were applied to the UTXO state as a\n  * part of a single ActivateBestChainStep call.\n+ *\n+ * This class also tracks transactions that are removed from the mempool as\n+ * conflicts and and can be used to pass all those transactions through\n+ * SyncTransaction.\n  */\n-struct ConnectTrace {\n+class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+    std::vector<CTransactionRef> conflictedTxs;\n+    CTxMemPool &pool;\n \n public:\n+    ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        pool.NotifyEntryRemoved.connect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n+    ~ConnectTrace() {\n+        pool.NotifyEntryRemoved.disconnect(boost::bind(&ConnectTrace::NotifyEntryRemoved, this, _1, _2));\n+    }\n+\n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n         blocksConnected.emplace_back(pindex, pblock);\n     }\n \n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {\n         return blocksConnected;\n     }\n+\n+    void NotifyEntryRemoved(CTransactionRef txRemoved, MemPoolRemovalReason reason) {\n+        if (reason == MemPoolRemovalReason::CONFLICT) {\n+            conflictedTxs.push_back(txRemoved);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104692562",
      "id" : 104692562,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 75,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104692562",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104693002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104693002"
         }
      },
      "body" : "In commit \"Handle conflicted transactions directly in ConnectTrace\":\r\n\r\nAgain, I would find it really helpful if the commit message gave a hint about why the change is being made instead of only saying what the change is.\r\n\r\nIs this just a cleanup not intended to change behavior? Is it important that signal connect/disconnect no longer happen under cs_main? Please mention in the commit message.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:23:06Z",
      "diff_hunk" : "@@ -2526,8 +2512,15 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n             fInitialDownload = IsInitialBlockDownload();\n \n             // throw all transactions though the signal-interface\n-\n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n+            connectTrace.CallSyncTransactionOnConflictedTransactions();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104693002",
      "id" : 104693002,
      "original_commit_id" : "91dc381aa73f3931152249e5f116d7f29673bd2e",
      "original_position" : 114,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104693002",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104694067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104694067"
         }
      },
      "body" : "In commit \"Keep conflictedTxs in ConnectTrace per-block\":\r\n\r\nCould construct the vector in the desired state initially (just pass `1` or `{{}}` to the constructor) instead of creating it empty and then pushing.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:27:02Z",
      "diff_hunk" : "@@ -2200,17 +2200,18 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;\n     CTxMemPool &pool;\n \n public:\n     ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        conflictedTxs.emplace_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104694067",
      "id" : 104694067,
      "original_commit_id" : "5459aca910afe48fb53bbba4e9574e4790624d8c",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104694067",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104697616"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104697616"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe s/NULL/nullptr/.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:39:13Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104697616",
      "id" : 104697616,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104697616",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104701476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104701476"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe break assert into two lines so it's easier to know which condition failed.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T15:52:33Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104701476",
      "id" : 104701476,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104701476",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104703615"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104703615"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nMaybe s/> > />>/.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T16:00:18Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;\n+    std::shared_ptr<const CBlock> pblock;\n+    std::shared_ptr<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104703615",
      "id" : 104703615,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104703615",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104711671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104711671"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nThis awaitingClear variable never seems to be used anywhere except in asserts. It would definitely be worth mentioning this in a comment on the awaitingClear declaration, because otherwise the state this class is tracking appears to be more complicated than it really is.\r\n\r\nAlso, if possible, I think it would be better to make the interface less fragile and get rid of the need for any awaitingClear variable to detect misuse. It seems you could replace the GetBlocksConnected/ClearBlocksConnected function pair with a single function:\r\n\r\n```\r\nstd::vector<PerBlockConnectTrace> ClearBlocksConnected() {\r\n    if (!blocksConnected.back().pindex) {\r\n        blocksConnected.pop_back();\r\n    }\r\n    std::vector<PerBlockConnectTrace> ret(1);\r\n    ret.swap(blocksConnected);\r\n    return std::move(ret);\r\n}\r\n```\r\n\r\nIf you did this, another advantage would be that you could make conflictedTxs a plain vector instead of a shared_ptr to a vector, because you would no longer be creating copies of it. ",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T16:28:57Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();\n+            assert(!awaitingClear);\n+            awaitingClear = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104711671",
      "id" : 104711671,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 47,
      "path" : "src/validation.cpp",
      "position" : 118,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104711671",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104714457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104714457"
         }
      },
      "body" : "In commit \"Handle SyncTransaction in ActivateBestChain instead of ConnectTrace\":\r\n\r\nCould you add a comment explaining this pop_back behavior? I thought the whole point of adding an initial null block to the blocksConnected vector was to support NotifyEntryRemoved calls prior to any BlockConnected call. But if this will now throw away the results of those calls, why not just avoid creating initial null block and have NotifyEntryRemoved do nothing if called when blocksConnected.empty()?\r\n\r\nI'm probably missing something, so a comment here mentioning the real purpose of the pop could be helpful.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T16:38:19Z",
      "diff_hunk" : "@@ -2220,28 +2226,33 @@ class ConnectTrace {\n     }\n \n     void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n-        blocksConnected.emplace_back(pindex, pblock);\n-        conflictedTxs.emplace_back();\n+        assert(!awaitingClear);\n+        assert(pindex && pblock);\n+        blocksConnected.back().pindex = pindex;\n+        blocksConnected.back().pblock = pblock;\n+        blocksConnected.emplace_back();\n+    }\n+\n+    std::vector<PerBlockConnectTrace> GetBlocksConnected() {\n+        if (!blocksConnected.back().pindex) {\n+            blocksConnected.pop_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104714457",
      "id" : 104714457,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 45,
      "path" : "src/validation.cpp",
      "position" : 116,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104714457",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104718278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104718278"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\":\r\n\r\nRealize you are only moving this, but this TODO comment seems to be describing what the current behavior is, not what the TODO is. Maybe remove TODO at the beginning of this comment, and add \"TODO: \\<thing to be done\\>\" at the end, where I'm guessing \\<thing to be done\\> is somehow fixing the race condition.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T16:52:29Z",
      "diff_hunk" : "@@ -1172,6 +1171,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104718278",
      "id" : 104718278,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 26,
      "path" : "src/wallet/wallet.cpp",
      "position" : 46,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104718278",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104732789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104732789"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\"\r\n\r\nCould you update the commit message to explicitly say which of the changes in the commit are changes in behavior as opposed to just internal code reorganization? Maybe the following would be accurate? \"This commit doesn't change the behavior of ZMQ notifications or network message processing in any way. It does slightly change the way the wallet processes transactions. The wallet now no longer releases cs_main and cs_wallet between transactions when it is processing multiple transactions from the same block.\"\r\n\r\nAlso if this is accurate, maybe consider changing the wallet locking in a separate commit (or even a separate PR), instead of mixing code cleanup and a locking improvement in the same change.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T17:50:26Z",
      "diff_hunk" : "@@ -1155,11 +1155,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104732789",
      "id" : 104732789,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 6,
      "path" : "src/wallet/wallet.cpp",
      "position" : 26,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104732789",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104734533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104734533"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\":\r\n\r\nWhat does the part of your commit message that says \"CValidationInterface starts listening to mempool directly, placing it in the middle\" mean?\r\n\r\nWasn't CValidationInterface always in the middle between validation code and the various listeners? And aren't the calls to the CValidationInterface still happening in the exact same places as before, just with updated function names and arguments?",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T17:57:53Z",
      "diff_hunk" : "@@ -33,7 +34,9 @@ void UnregisterAllValidationInterfaces();\n class CValidationInterface {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104734533",
      "id" : 104734533,
      "original_commit_id" : "ffbac04438b513483dca2c40dfd189e9e24a1db0",
      "original_position" : 17,
      "path" : "src/validationinterface.h",
      "position" : 20,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104734533",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104735895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104735895"
         }
      },
      "body" : "In commit \"SyncTransaction->TxAddedToMempool/BlockConnected/Disconnected\"\r\n\r\n>> Perhaps we should have a comment here\r\n\r\n> OK, added a few comments.\r\n\r\nFWIW, not seeing a comment here. Maybe they were added elsewhere, but it would seem good to mention right in the top of the function body that this is not only called when a transaction is added to the mempool like the name would suggest. Alternately, you could leave this function named SyncTransaction and have TransactionAddedToMempool call SyncTransaction to avoid the misleading title.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T18:03:49Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104735895",
      "id" : 104735895,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104735895",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104737176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104737176"
         }
      },
      "body" : "In commit \"Add override to functions using CValidationInterface methods\"\r\n\r\nI think normally you drop \"virtual\" when you add \"override\" to make the two different types of method declarations more distinct. At least that's the style I'm used to, and we seem to follow it everywhere else we're currently using override.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T18:09:31Z",
      "diff_hunk" : "@@ -30,10 +30,10 @@ class PeerLogicValidation : public CValidationInterface {\n public:\n     PeerLogicValidation(CConnman* connmanIn);\n \n-    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted);\n-    virtual void UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlockIndex *pindexFork, bool fInitialDownload);\n-    virtual void BlockChecked(const CBlock& block, const CValidationState& state);\n-    virtual void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock);\n+    virtual void BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104737176",
      "id" : 104737176,
      "original_commit_id" : "2897190e78e8733402be878c9e18c41bae6cb7f8",
      "original_position" : 8,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 25526582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T18:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104737176",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756416"
         }
      },
      "body" : "Is there actually a difference between nullptr and NULL to the compiler (it overrides differently, sometimes, if you're calling a function, no?)",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:28:14Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756416",
      "id" : 104756416,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 5,
      "path" : "src/validation.cpp",
      "position" : 75,
      "pull_request_review_id" : 25607210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:28:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756416",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756495"
         }
      },
      "body" : "Heh, I still find the pre-C++11 version to be easier to read :P",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:28:32Z",
      "diff_hunk" : "@@ -2195,6 +2195,12 @@ static int64_t nTimeFlush = 0;\n static int64_t nTimeChainState = 0;\n static int64_t nTimePostConnect = 0;\n \n+struct PerBlockConnectTrace {\n+    CBlockIndex* pindex = NULL;\n+    std::shared_ptr<const CBlock> pblock;\n+    std::shared_ptr<std::vector<CTransactionRef> > conflictedTxs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104756495",
      "id" : 104756495,
      "original_commit_id" : "01f38bf2c2459eb6a5a35c43c291167e19110cda",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 25607290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104756495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757029"
         }
      },
      "body" : "Tweaked, carryover from too-little-diff-change.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:30:42Z",
      "diff_hunk" : "@@ -2240,24 +2240,23 @@ struct ConnectTrace {\n  * Connect a new block to chainActive. pblock is either NULL or a pointer to a CBlock\n  * corresponding to pindexNew, to bypass loading it again from disk.\n  *\n- * The block is always added to connectTrace (either after loading from disk or by copying\n- * pblock) - if that is not intended, care must be taken to remove the last entry in\n- * blocksConnected in case of failure.\n+ * The block is always added to connectTrace in the case connection succeeds.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757029",
      "id" : 104757029,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 7,
      "path" : "src/validation.cpp",
      "position" : 144,
      "pull_request_review_id" : 25607824,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757198"
         }
      },
      "body" : "I prefer to force peoplt to not take the atomic increment hit without changing the code :).",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:31:21Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104757198",
      "id" : 104757198,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 8,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25607998,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:31:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104757198",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104758212"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104758212"
         }
      },
      "body" : "Oops, indeed. Now it just returns a reference, which should also be fine. The method is not technically const later (without making things mutable), so I'll leave the second part.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:35:19Z",
      "diff_hunk" : "@@ -2233,7 +2233,17 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  */\n struct ConnectTrace {\n+private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n+\n+public:\n+    void BlockConnected(CBlockIndex* pindex, const std::shared_ptr<const CBlock>& pblock) {\n+        blocksConnected.emplace_back(pindex, pblock);\n+    }\n+\n+    std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > GetBlocksConnected() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104758212",
      "id" : 104758212,
      "original_commit_id" : "99634d420b2a2d7c9c7e96d7ac71c253c70a8485",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25608986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:35:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104758212",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104759201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104759201"
         }
      },
      "body" : "Sure, added more to the commit message.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:39:36Z",
      "diff_hunk" : "@@ -2291,6 +2290,8 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime6 = GetTimeMicros(); nTimePostConnect += nTime6 - nTime5; nTimeTotal += nTime6 - nTime1;\n     LogPrint(\"bench\", \"  - Connect postprocess: %.2fms [%.2fs]\\n\", (nTime6 - nTime5) * 0.001, nTimePostConnect * 0.000001);\n     LogPrint(\"bench\", \"- Connect block: %.2fms [%.2fs]\\n\", (nTime6 - nTime1) * 0.001, nTimeTotal * 0.000001);\n+\n+    connectTrace.blocksConnected.emplace_back(pindexNew, pthisBlock);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104759201",
      "id" : 104759201,
      "original_commit_id" : "5130d7cdcc5577e6c7fcdf8f9a57230a9a322442",
      "original_position" : 35,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25610005,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:39:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104759201",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104760269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104760269"
         }
      },
      "body" : "OK, did that for the whole patch set.",
      "commit_id" : "d9c8399716c6688689f02da41105588ae0d72c16",
      "created_at" : "2017-03-07T19:43:57Z",
      "diff_hunk" : "@@ -2200,17 +2200,18 @@ static int64_t nTimePostConnect = 0;\n  * part of a single ActivateBestChainStep call.\n  *\n  * This class also tracks transactions that are removed from the mempool as\n- * conflicts and and can be used to pass all those transactions through\n- * SyncTransaction.\n+ * conflicts (per block) and and can be used to pass all those transactions\n+ * through SyncTransaction.\n  */\n class ConnectTrace {\n private:\n     std::vector<std::pair<CBlockIndex*, std::shared_ptr<const CBlock> > > blocksConnected;\n-    std::vector<CTransactionRef> conflictedTxs;\n+    std::vector<std::vector<CTransactionRef> > conflictedTxs;\n     CTxMemPool &pool;\n \n public:\n     ConnectTrace(CTxMemPool &_pool) : pool(_pool) {\n+        conflictedTxs.emplace_back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104760269",
      "id" : 104760269,
      "original_commit_id" : "5459aca910afe48fb53bbba4e9574e4790624d8c",
      "original_position" : 18,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25611109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-07T19:43:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104760269",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
