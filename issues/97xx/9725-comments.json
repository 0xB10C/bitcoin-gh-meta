[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267"
         }
      },
      "body" : "Perhaps we should have a comment here explaining that this function is used for all transaction notifications, and not just when things are added to the mempool?  I can imagine a future reader being confused about why BlockConnected and BlockDisconnected both call this function...",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-02-23T15:22:53Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102736267",
      "id" : 102736267,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23501945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102736267",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507"
         }
      },
      "body" : "OK, added a few comments.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-02-23T20:10:56Z",
      "diff_hunk" : "@@ -144,8 +144,10 @@ void CZMQNotificationInterface::UpdatedBlockTip(const CBlockIndex *pindexNew, co\n     }\n }\n \n-void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CBlockIndex* pindex, int posInBlock)\n+void CZMQNotificationInterface::TransactionAddedToMempool(const CTransactionRef& ptx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r102806507",
      "id" : 102806507,
      "original_commit_id" : "9765f81d764f075818a0f645619e94b51aad0a91",
      "original_position" : 5,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 5,
      "pull_request_review_id" : 23574836,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102806507",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136"
         }
      },
      "body" : "To help others review, these two functions seem to mesh with current behavior. I don't see how they could possibly be usable by any client, but there ya go.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T20:18:37Z",
      "diff_hunk" : "@@ -160,3 +162,19 @@ void CZMQNotificationInterface::SyncTransaction(const CTransaction& tx, const CB\n         }\n     }\n }\n+\n+void CZMQNotificationInterface::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex* pindexConnected, const std::vector<CTransactionRef>& vtxConflicted)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104512136",
      "id" : 104512136,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 17,
      "path" : "src/zmq/zmqnotificationinterface.cpp",
      "position" : 17,
      "pull_request_review_id" : 25352756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104512136",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485"
         }
      },
      "body" : "Mind changing AddToWalletIfInvolvingMe to take a CTransactionRef here? Looks like we end up keeping 2 copies otherwise.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T20:29:10Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104514485",
      "id" : 104514485,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25355088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104514485",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885"
         }
      },
      "body" : "The same set of conflicted transactions is sent here for each block.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T21:18:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104524885",
      "id" : 104524885,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25366381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104524885",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518"
         }
      },
      "body" : "pindex can no longer be NULL here.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T22:22:29Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104539518",
      "id" : 104539518,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25381496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104539518",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672"
         }
      },
      "body" : "Assert pair.first here too, I think. It'd be nice to doc that the BlockConnected() params are now always non-null.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T22:28:00Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104540672",
      "id" : 104540672,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25382753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104540672",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Concept ACK.",
      "created_at" : "2017-03-06T22:30:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284555612",
      "id" : 284555612,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T22:30:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284555612",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555"
         }
      },
      "body" : "Fixed, with a lot more code :(.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T23:13:52Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);\n-                const CBlock& block = *(pair.second);\n-                for (unsigned int i = 0; i < block.vtx.size(); i++)\n-                    GetMainSignals().SyncTransaction(*block.vtx[i], pair.first, i);\n+                GetMainSignals().BlockConnected(pair.second, pair.first, *mrt.GetConflictedTransactions());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549555",
      "id" : 104549555,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 103,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549555",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T23:14:04Z",
      "diff_hunk" : "@@ -2518,14 +2511,10 @@ bool ActivateBestChain(CValidationState &state, const CChainParams& chainparams,\n \n             // throw all transactions though the signal-interface\n \n-            } // MemPoolConflictRemovalTracker destroyed and conflict evictions are notified\n-\n             // Transactions in the connected block are notified\n             for (const auto& pair : connectTrace.blocksConnected) {\n                 assert(pair.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549592",
      "id" : 104549592,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 99,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 25392075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549592",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T23:15:08Z",
      "diff_hunk" : "@@ -1198,6 +1197,38 @@ void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex,\n     }\n }\n \n+void CWallet::TransactionAddedToMempool(const CTransactionRef& ptx) {\n+    LOCK2(cs_main, cs_wallet);\n+    SyncTransaction(ptx, NULL, -1);\n+}\n+\n+void CWallet::BlockConnected(const std::shared_ptr<const CBlock>& pblock, const CBlockIndex *pindex, const std::vector<CTransactionRef>& vtxConflicted) {\n+    LOCK2(cs_main, cs_wallet);\n+    // TODO: Tempoarily ensure that mempool removals are notified before\n+    // connected transactions.  This shouldn't matter, but the abandoned\n+    // state of transactions in our wallet is currently cleared when we\n+    // receive another notification and there is a race condition where\n+    // notification of a connected conflict might cause an outside process\n+    // to abandon a transaction and then have it inadvertantly cleared by\n+    // the notification that the conflicted transaction was evicted.\n+\n+    for (const CTransactionRef& ptx : vtxConflicted) {\n+        SyncTransaction(ptx, NULL, -1);\n+    }\n+    for (size_t i = 0; i < pblock->vtx.size(); i++) {\n+        SyncTransaction(pblock->vtx[i], pindex, pindex ? i : -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104549790",
      "id" : 104549790,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 38,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104549790",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406"
         }
      },
      "body" : "Fixed.",
      "commit_id" : "c79226b8358298be0752418adfa9e68c6099673c",
      "created_at" : "2017-03-06T23:18:30Z",
      "diff_hunk" : "@@ -1181,11 +1181,10 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n     }\n }\n \n-void CWallet::SyncTransaction(const CTransaction& tx, const CBlockIndex *pindex, int posInBlock)\n-{\n-    LOCK2(cs_main, cs_wallet);\n+void CWallet::SyncTransaction(const CTransactionRef& ptx, const CBlockIndex *pindexBlockConnected, int posInBlock) {\n+    const CTransaction& tx = *ptx;\n \n-    if (!AddToWalletIfInvolvingMe(tx, pindex, posInBlock, true))\n+    if (!AddToWalletIfInvolvingMe(tx, pindexBlockConnected, posInBlock, true))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#discussion_r104550406",
      "id" : 104550406,
      "original_commit_id" : "942c45aa63d842a2e34e12dfb71702d209a86f21",
      "original_position" : 11,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 25392873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9725",
      "updated_at" : "2017-03-06T23:21:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104550406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "To fix the issue @theuni found (\"The same set of conflicted transactions is sent here for each block.\"), I had to go rewrite a big chunk of how the mempool removal callback logic works. Now what was previously a standalone class which listens to mempool for transactions removed has gone into the ConnectTrace class, which is accessed in ActivateBestChain to generate callbacks.\r\nAlso, had to rebase.",
      "created_at" : "2017-03-06T23:24:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9725#issuecomment-284568275",
      "id" : 284568275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9725",
      "updated_at" : "2017-03-06T23:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284568275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
