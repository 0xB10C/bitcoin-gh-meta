[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "A call to `SyncWithValidationInterfaceQueue()` also fixes it. I am +0.1 on stopping the scheduler thread and flushing the queue - looks more robust to me.",
      "created_at" : "2022-09-27T16:12:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26188#issuecomment-1259730507",
      "id" : 1259730507,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26188",
      "node_id" : "IC_kwDOABII585LFfZL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259730507/reactions"
      },
      "updated_at" : "2022-09-28T08:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1259730507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26188#discussion_r982751603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26188"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982751603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't really like duplicating the shutdown sequence, especially not in the same order. This is just bloating the tests with hard to understand and hard to maintain code.\r\n\r\nThe reason that the bug exits is a presumed silent merge conflict. I already fixed the same bug in fa176e253fb473767c61d4d8cd2d93e87d71a015, but the test here copied the unfixed code.\r\n\r\nMy preference would be to use the same fix in all unit tests and not use a different fix for each unit test.",
      "commit_id" : "eaec74f3b94190d98157888439f9cccd79f79e4a",
      "created_at" : "2022-09-28T18:46:51Z",
      "diff_hunk" : "@@ -79,6 +80,13 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\n     // Shutdown sequence (c.f. Shutdown() in init.cpp)\n     coin_stats_index.Stop();\n \n+    // Make sure coin_stats_index is not used by the scheduler thread after it\n+    // has been destroyed.\n+    if (m_node.scheduler) {\n+        m_node.scheduler->stop();\n+    }\n+    GetMainSignals().FlushBackgroundCallbacks();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26188#discussion_r982751603",
      "id" : 982751603,
      "line" : 88,
      "node_id" : "PRRC_kwDOABII5846k5lz",
      "original_commit_id" : "eaec74f3b94190d98157888439f9cccd79f79e4a",
      "original_line" : 88,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/coinstatsindex_tests.cpp",
      "position" : 17,
      "pull_request_review_id" : 1124199917,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26188",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982751603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-28T18:47:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/982751603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> A call to `SyncWithValidationInterfaceQueue()` also fixes it. I am +0.1 on stopping the scheduler thread and flushing the queue - looks more robust to me.\r\n\r\nHmm, I would think the opposite `SyncWithValidationInterfaceQueue` seems like the more robust approach to me. It forces all events that may have been posted before the index is stopped to be processed before the index destructor is called.\r\n\r\nStopping the scheduler seems more indirect and more error prone because it make additional assumptions that validationinterface uses the scheduler internally and that it is safe to stop the scheduler at all because nothing else depends on it.\r\n\r\nAlso agree with Marco's suggestion that it would be good to stick to consistent approach across tests, which also favors `SyncWithValidationInterfaceQueue`",
      "created_at" : "2022-09-28T19:03:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26188#issuecomment-1261345679",
      "id" : 1261345679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26188",
      "node_id" : "IC_kwDOABII585LLpuP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1261345679/reactions"
      },
      "updated_at" : "2022-09-28T19:03:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1261345679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
