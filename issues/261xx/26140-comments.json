[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-09-20T20:06:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#issuecomment-1252852686",
      "id" : 1252852686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26140",
      "node_id" : "IC_kwDOABII585KrQPO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1252852686/reactions"
      },
      "updated_at" : "2022-09-20T20:06:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1252852686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26378](https://github.com/bitcoin/bitcoin/pull/26378) (refactor: Pass reference to last header, not pointer by MarcoFalke)\n* [#24125](https://github.com/bitcoin/bitcoin/pull/24125) (p2p: Replace RecursiveMutex `m_tx_inventory_mutex` with Mutex and rename it by w0xlt)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-09-21T04:12:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#issuecomment-1253180742",
      "id" : 1253180742,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26140",
      "node_id" : "IC_kwDOABII585KsgVG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253180742/reactions"
      },
      "updated_at" : "2022-10-24T23:53:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253180742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2022-09-21T16:42:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#issuecomment-1253966269",
      "id" : 1253966269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26140",
      "node_id" : "IC_kwDOABII585KvgG9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253966269/reactions"
      },
      "updated_at" : "2022-09-21T16:42:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1253966269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1003303992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003303992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If this is touched, why not pick a better name, like `m_num_unconnecting_headers_msgs` (https://github.com/bitcoin/bitcoin/pull/25555/files)",
      "commit_id" : "8c22a6e0bfaf139812b14f561ce8c373e4842bb0",
      "created_at" : "2022-10-24T13:19:03Z",
      "diff_hunk" : "@@ -391,6 +391,18 @@ struct Peer {\n     /** Whether we've sent our peer a sendheaders message. **/\n     std::atomic<bool> m_sent_sendheaders{false};\n \n+    /** Length of current-streak of unconnecting headers announcements */\n+    int m_unconnecting_headers GUARDED_BY(NetEventsInterface::g_msgproc_mutex){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1003303992",
      "id" : 1003303992,
      "line" : 395,
      "node_id" : "PRRC_kwDOABII5847zTQ4",
      "original_commit_id" : "8c22a6e0bfaf139812b14f561ce8c373e4842bb0",
      "original_line" : 395,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 1153126868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003303992/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T13:20:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003303992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1003385420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003385420"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, makes sense. Also renamed `MAX_UNCONNECTING_HEADERS`.",
      "commit_id" : "ca898b46d791aa3cbef126739961f2059c8b8d6f",
      "created_at" : "2022-10-24T14:28:37Z",
      "diff_hunk" : "@@ -391,6 +391,18 @@ struct Peer {\n     /** Whether we've sent our peer a sendheaders message. **/\n     std::atomic<bool> m_sent_sendheaders{false};\n \n+    /** Length of current-streak of unconnecting headers announcements */\n+    int m_unconnecting_headers GUARDED_BY(NetEventsInterface::g_msgproc_mutex){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1003385420",
      "id" : 1003385420,
      "in_reply_to_id" : 1003303992,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847znJM",
      "original_commit_id" : "8c22a6e0bfaf139812b14f561ce8c373e4842bb0",
      "original_line" : 395,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1153245382,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003385420/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-24T14:28:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1003385420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased to avoid the `p2p_sendtxrcncl.py` failure.",
      "created_at" : "2022-10-28T09:35:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#issuecomment-1294768179",
      "id" : 1294768179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26140",
      "node_id" : "IC_kwDOABII585NLJgz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1294768179/reactions"
      },
      "updated_at" : "2022-10-28T09:35:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1294768179",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1008297535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008297535"
         }
      },
      "author_association" : "NONE",
      "body" : "Would you explain what are unconnecting headers? My understanding is that these headers are for blocks which are received via an `inv` message but do not have any parent and belong to no chain. Is this correct?",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-10-28T17:32:06Z",
      "diff_hunk" : "@@ -134,7 +134,7 @@ static constexpr double BLOCK_DOWNLOAD_TIMEOUT_PER_PEER = 0.5;\n /** Maximum number of headers to announce when relaying blocks with headers message.*/\n static const unsigned int MAX_BLOCKS_TO_ANNOUNCE = 8;\n /** Maximum number of unconnecting headers announcements before DoS score */\n-static const int MAX_UNCONNECTING_HEADERS = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1008297535",
      "id" : 1008297535,
      "line" : 137,
      "node_id" : "PRRC_kwDOABII5848GWY_",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 137,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 1160405914,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008297535/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-28T17:40:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1008297535",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/54557628?v=4",
         "events_url" : "https://api.github.com/users/Riahiamirreza/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Riahiamirreza/followers",
         "following_url" : "https://api.github.com/users/Riahiamirreza/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Riahiamirreza/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Riahiamirreza",
         "id" : 54557628,
         "login" : "Riahiamirreza",
         "node_id" : "MDQ6VXNlcjU0NTU3NjI4",
         "organizations_url" : "https://api.github.com/users/Riahiamirreza/orgs",
         "received_events_url" : "https://api.github.com/users/Riahiamirreza/received_events",
         "repos_url" : "https://api.github.com/users/Riahiamirreza/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Riahiamirreza/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Riahiamirreza/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Riahiamirreza"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012016081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012016081"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do we really need to pass `Peer& peer` here? I know it's a pattern that's used in other functions too, but I don't understand why we wouldn't just call `GetPeerRef(pfrom.GetId())` instead. Unless I'm misunderstanding, `pfrom` and `peer` should always refer to the same node, so this seems unnecessarily confusing and bloating the function signature?",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:22:10Z",
      "diff_hunk" : "@@ -659,7 +662,8 @@ class PeerManagerImpl final : public PeerManager\n     /** Potentially fetch blocks from this peer upon receipt of a new headers tip */\n     void HeadersDirectFetchBlocks(CNode& pfrom, const Peer& peer, const CBlockIndex* pindexLast);\n     /** Update peer state based on received headers message */\n-    void UpdatePeerStateForReceivedHeaders(CNode& pfrom, const CBlockIndex *pindexLast, bool received_new_header, bool may_have_more_headers);\n+    void UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer, const CBlockIndex* pindexLast, bool received_new_header, bool may_have_more_headers)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012016081",
      "id" : 1012016081,
      "line" : 665,
      "node_id" : "PRRC_kwDOABII5848UiPR",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 665,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012016081/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012016081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012018042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012018042"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I know this is a move operation, but seems more logical to put it inside the `if` statement imo\r\n```suggestion\r\n    if (peer.m_unconnecting_headers_msgs > 0) {\r\n        LogPrint(BCLog::NET, \"peer=%d: resetting m_unconnecting_headers_msgs (%d -> 0)\\n\", pfrom.GetId(), peer.m_unconnecting_headers_msgs);\r\n        peer.m_unconnecting_headers_msgs = 0;\r\n    }\r\n```",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:23:49Z",
      "diff_hunk" : "@@ -2684,15 +2689,16 @@ void PeerManagerImpl::HeadersDirectFetchBlocks(CNode& pfrom, const Peer& peer, c\n  * whether that header was new and whether the headers message was full,\n  * update the state we keep for the peer.\n  */\n-void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom,\n+void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer,\n         const CBlockIndex *pindexLast, bool received_new_header, bool may_have_more_headers)\n {\n+    if (peer.m_unconnecting_headers_msgs > 0) {\n+        LogPrint(BCLog::NET, \"peer=%d: resetting m_unconnecting_headers_msgs (%d -> 0)\\n\", pfrom.GetId(), peer.m_unconnecting_headers_msgs);\n+    }\n+    peer.m_unconnecting_headers_msgs = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012018042",
      "id" : 1012018042,
      "line" : 2698,
      "node_id" : "PRRC_kwDOABII5848Uit6",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 2698,
      "original_position" : 186,
      "original_start_line" : 2695,
      "path" : "src/net_processing.cpp",
      "position" : 186,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012018042/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2695,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012018042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012021264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012021264"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this is no longer locked with `cs_main`, I'm wondering if the `m_chainman.m_best_header` passed to `MaybeSendGetHeaders` and the `m_chainman.m_best_header->nHeight` passed to `LogPrint` could be different? I know it's just logging and not super critical, but could be annoying for debugging if so. Probably better to make that more robust?",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:26:13Z",
      "diff_hunk" : "@@ -2401,38 +2405,39 @@ arith_uint256 PeerManagerImpl::GetAntiDoSWorkThreshold()\n  *\n  * We'll send a getheaders message in response to try to connect the chain.\n  *\n- * The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n+ * The peer can send up to MAX_UNCONNECTING_HEADERS_MSGS in a row that\n  * don't connect before given DoS points.\n  *\n  * Once a headers message is received that is valid and does connect,\n- * nUnconnectingHeaders gets reset back to 0.\n+ * m_unconnecting_headers_msgs gets reset back to 0.\n  */\n void PeerManagerImpl::HandleFewUnconnectingHeaders(CNode& pfrom, Peer& peer,\n         const std::vector<CBlockHeader>& headers)\n {\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n-    LOCK(cs_main);\n-    CNodeState *nodestate = State(pfrom.GetId());\n-\n-    nodestate->nUnconnectingHeaders++;\n+    peer.m_unconnecting_headers_msgs++;\n     // Try to fill in the missing headers.\n     if (MaybeSendGetHeaders(pfrom, GetLocator(m_chainman.m_best_header), peer)) {\n-        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, m_unconnecting_headers_msgs=%d)\\n\",\n             headers[0].GetHash().ToString(),\n             headers[0].hashPrevBlock.ToString(),\n             m_chainman.m_best_header->nHeight,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012021264",
      "id" : 1012021264,
      "line" : 2425,
      "node_id" : "PRRC_kwDOABII5848UjgQ",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 2425,
      "original_position" : 149,
      "original_start_line" : 2421,
      "path" : "src/net_processing.cpp",
      "position" : 149,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012021264/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2421,
      "start_side" : "LEFT",
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012021264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012023296"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012023296"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: Could use a WITH_LOCK here ",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:27:41Z",
      "diff_hunk" : "@@ -2401,38 +2405,39 @@ arith_uint256 PeerManagerImpl::GetAntiDoSWorkThreshold()\n  *\n  * We'll send a getheaders message in response to try to connect the chain.\n  *\n- * The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n+ * The peer can send up to MAX_UNCONNECTING_HEADERS_MSGS in a row that\n  * don't connect before given DoS points.\n  *\n  * Once a headers message is received that is valid and does connect,\n- * nUnconnectingHeaders gets reset back to 0.\n+ * m_unconnecting_headers_msgs gets reset back to 0.\n  */\n void PeerManagerImpl::HandleFewUnconnectingHeaders(CNode& pfrom, Peer& peer,\n         const std::vector<CBlockHeader>& headers)\n {\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n-    LOCK(cs_main);\n-    CNodeState *nodestate = State(pfrom.GetId());\n-\n-    nodestate->nUnconnectingHeaders++;\n+    peer.m_unconnecting_headers_msgs++;\n     // Try to fill in the missing headers.\n     if (MaybeSendGetHeaders(pfrom, GetLocator(m_chainman.m_best_header), peer)) {\n-        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, m_unconnecting_headers_msgs=%d)\\n\",\n             headers[0].GetHash().ToString(),\n             headers[0].hashPrevBlock.ToString(),\n             m_chainman.m_best_header->nHeight,\n-            pfrom.GetId(), nodestate->nUnconnectingHeaders);\n+            pfrom.GetId(), peer.m_unconnecting_headers_msgs);\n+    }\n+\n+    {\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012023296",
      "id" : 1012023296,
      "line" : 2430,
      "node_id" : "PRRC_kwDOABII5848UkAA",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 2430,
      "original_position" : 155,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 155,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012023296/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012023296",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012024675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012024675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: line length\r\n```suggestion\r\n        EXCLUSIVE_LOCKS_REQUIRED(!m_most_recent_block_mutex, peer.m_getdata_requests_mutex, NetEventsInterface::g_msgproc_mutex)\r\n        LOCKS_EXCLUDED(::cs_main);\r\n```",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:28:49Z",
      "diff_hunk" : "@@ -890,10 +894,11 @@ class PeerManagerImpl final : public PeerManager\n     std::atomic<std::chrono::seconds> m_last_tip_update{0s};\n \n     /** Determine whether or not a peer can request a transaction, and return it (or nullptr if not found or not allowed). */\n-    CTransactionRef FindTxForGetData(const CNode& peer, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now) LOCKS_EXCLUDED(cs_main);\n+    CTransactionRef FindTxForGetData(const Peer& peer, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+        LOCKS_EXCLUDED(cs_main) EXCLUSIVE_LOCKS_REQUIRED(NetEventsInterface::g_msgproc_mutex);\n \n     void ProcessGetData(CNode& pfrom, Peer& peer, const std::atomic<bool>& interruptMsgProc)\n-        EXCLUSIVE_LOCKS_REQUIRED(!m_most_recent_block_mutex, peer.m_getdata_requests_mutex) LOCKS_EXCLUDED(::cs_main);\n+        EXCLUSIVE_LOCKS_REQUIRED(!m_most_recent_block_mutex, peer.m_getdata_requests_mutex, NetEventsInterface::g_msgproc_mutex) LOCKS_EXCLUDED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012024675",
      "id" : 1012024675,
      "line" : 901,
      "node_id" : "PRRC_kwDOABII5848UkVj",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 901,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 80,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012024675/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012024675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012026290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012026290"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think MarcoFalke's suggestion `m_num_unconnecting_headers_msgs` (with `num`) is better than `m_unconnecting_headers_msgs`, quickly shows that this is a count.",
      "commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "created_at" : "2022-11-02T16:30:13Z",
      "diff_hunk" : "@@ -391,6 +391,18 @@ struct Peer {\n     /** Whether we've sent our peer a sendheaders message. **/\n     std::atomic<bool> m_sent_sendheaders{false};\n \n+    /** Length of current-streak of unconnecting headers announcements */\n+    int m_unconnecting_headers GUARDED_BY(NetEventsInterface::g_msgproc_mutex){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1012026290",
      "id" : 1012026290,
      "in_reply_to_id" : 1003303992,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848Ukuy",
      "original_commit_id" : "8c22a6e0bfaf139812b14f561ce8c373e4842bb0",
      "original_line" : 395,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1165603518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012026290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-02T16:30:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012026290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021387219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021387219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I meant to name it exactly like Marco did in #25555 ð¤¦ Has the correct name now.",
      "commit_id" : "de97ab234f8479d388b0925dad75e83cf4148413",
      "created_at" : "2022-11-14T11:31:43Z",
      "diff_hunk" : "@@ -391,6 +391,18 @@ struct Peer {\n     /** Whether we've sent our peer a sendheaders message. **/\n     std::atomic<bool> m_sent_sendheaders{false};\n \n+    /** Length of current-streak of unconnecting headers announcements */\n+    int m_unconnecting_headers GUARDED_BY(NetEventsInterface::g_msgproc_mutex){0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021387219",
      "id" : 1021387219,
      "in_reply_to_id" : 1003303992,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58484SHT",
      "original_commit_id" : "8c22a6e0bfaf139812b14f561ce8c373e4842bb0",
      "original_line" : 395,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1178904668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021387219/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T11:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021387219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021388248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021388248"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a commit to annotate `m_best_header` as guarded by `cs_main` and fixed this up to log the same height that is being passed to `MaybeSendGetHeaders`.",
      "commit_id" : "de97ab234f8479d388b0925dad75e83cf4148413",
      "created_at" : "2022-11-14T11:32:51Z",
      "diff_hunk" : "@@ -2401,38 +2405,39 @@ arith_uint256 PeerManagerImpl::GetAntiDoSWorkThreshold()\n  *\n  * We'll send a getheaders message in response to try to connect the chain.\n  *\n- * The peer can send up to MAX_UNCONNECTING_HEADERS in a row that\n+ * The peer can send up to MAX_UNCONNECTING_HEADERS_MSGS in a row that\n  * don't connect before given DoS points.\n  *\n  * Once a headers message is received that is valid and does connect,\n- * nUnconnectingHeaders gets reset back to 0.\n+ * m_unconnecting_headers_msgs gets reset back to 0.\n  */\n void PeerManagerImpl::HandleFewUnconnectingHeaders(CNode& pfrom, Peer& peer,\n         const std::vector<CBlockHeader>& headers)\n {\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n-    LOCK(cs_main);\n-    CNodeState *nodestate = State(pfrom.GetId());\n-\n-    nodestate->nUnconnectingHeaders++;\n+    peer.m_unconnecting_headers_msgs++;\n     // Try to fill in the missing headers.\n     if (MaybeSendGetHeaders(pfrom, GetLocator(m_chainman.m_best_header), peer)) {\n-        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, nUnconnectingHeaders=%d)\\n\",\n+        LogPrint(BCLog::NET, \"received header %s: missing prev block %s, sending getheaders (%d) to end (peer=%d, m_unconnecting_headers_msgs=%d)\\n\",\n             headers[0].GetHash().ToString(),\n             headers[0].hashPrevBlock.ToString(),\n             m_chainman.m_best_header->nHeight,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021388248",
      "id" : 1021388248,
      "in_reply_to_id" : 1012021264,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58484SXY",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 2425,
      "original_position" : 149,
      "original_start_line" : 2421,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1178907628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021388248/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "LEFT",
      "updated_at" : "2022-11-14T11:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021388248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021401372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021401372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We do this in a lot of places in `net_processing`, afaict we pass in a `Peer` when possible (because it is already available at the call site) otherwise we use `GetPeerRef`.",
      "commit_id" : "de97ab234f8479d388b0925dad75e83cf4148413",
      "created_at" : "2022-11-14T11:43:42Z",
      "diff_hunk" : "@@ -659,7 +662,8 @@ class PeerManagerImpl final : public PeerManager\n     /** Potentially fetch blocks from this peer upon receipt of a new headers tip */\n     void HeadersDirectFetchBlocks(CNode& pfrom, const Peer& peer, const CBlockIndex* pindexLast);\n     /** Update peer state based on received headers message */\n-    void UpdatePeerStateForReceivedHeaders(CNode& pfrom, const CBlockIndex *pindexLast, bool received_new_header, bool may_have_more_headers);\n+    void UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer, const CBlockIndex* pindexLast, bool received_new_header, bool may_have_more_headers)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021401372",
      "id" : 1021401372,
      "in_reply_to_id" : 1012016081,
      "line" : 665,
      "node_id" : "PRRC_kwDOABII58484Vkc",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 665,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 1178931598,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021401372/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T11:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021401372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021404128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021404128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't see the benefit of this and it would only make this harder to review imo.",
      "commit_id" : "de97ab234f8479d388b0925dad75e83cf4148413",
      "created_at" : "2022-11-14T11:45:33Z",
      "diff_hunk" : "@@ -2684,15 +2689,16 @@ void PeerManagerImpl::HeadersDirectFetchBlocks(CNode& pfrom, const Peer& peer, c\n  * whether that header was new and whether the headers message was full,\n  * update the state we keep for the peer.\n  */\n-void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom,\n+void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer,\n         const CBlockIndex *pindexLast, bool received_new_header, bool may_have_more_headers)\n {\n+    if (peer.m_unconnecting_headers_msgs > 0) {\n+        LogPrint(BCLog::NET, \"peer=%d: resetting m_unconnecting_headers_msgs (%d -> 0)\\n\", pfrom.GetId(), peer.m_unconnecting_headers_msgs);\n+    }\n+    peer.m_unconnecting_headers_msgs = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021404128",
      "id" : 1021404128,
      "in_reply_to_id" : 1012018042,
      "line" : null,
      "node_id" : "PRRC_kwDOABII58484WPg",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 2698,
      "original_position" : 186,
      "original_start_line" : 2695,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1178933979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021404128/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-14T11:45:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021404128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021409351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021409351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`nUnconnectingHeaders` tracks the number of `headers` messages (with fewer than `MAX_BLOCKS_TO_ANNOUNCE` headers) in which the first header did not connect to any known chain.",
      "commit_id" : "de97ab234f8479d388b0925dad75e83cf4148413",
      "created_at" : "2022-11-14T11:49:08Z",
      "diff_hunk" : "@@ -134,7 +134,7 @@ static constexpr double BLOCK_DOWNLOAD_TIMEOUT_PER_PEER = 0.5;\n /** Maximum number of headers to announce when relaying blocks with headers message.*/\n static const unsigned int MAX_BLOCKS_TO_ANNOUNCE = 8;\n /** Maximum number of unconnecting headers announcements before DoS score */\n-static const int MAX_UNCONNECTING_HEADERS = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26140#discussion_r1021409351",
      "id" : 1021409351,
      "in_reply_to_id" : 1008297535,
      "line" : 137,
      "node_id" : "PRRC_kwDOABII58484XhH",
      "original_commit_id" : "cafaa981042eb38e26e6f8d8194ee8f2082b283f",
      "original_line" : 137,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 1178938595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26140",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021409351/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T11:49:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021409351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   }
]
