[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24007#discussion_r780849935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780849935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While I've seen protocol proposals leveraging same-txid-different-witness, I don't know any of them which is effectively deployed now (?). If they're and their usages is high enough to lead to a significant rate of witness conflicts, by that time I would expect this new replacement policy to be widely deployed in the miner ecosystem.\r\n\r\nOf course, the majority of miners might run a different policy than the default Core's one. Though, until the contrary is corroborated by periodic probing of miner's mempools, I think we can reasonably hold the assumption they're.\r\n\r\nSo to simplify, I lean to account witness replacement in fee estimation as early as this PR.\r\n\r\nWhat do you think ?",
      "commit_id" : "b15079ac7bc539df9854069b834f9ca437e79b8e",
      "created_at" : "2022-01-10T00:06:40Z",
      "diff_hunk" : "@@ -1013,18 +1038,33 @@ bool MemPoolAccept::Finalize(const ATMPArgs& args, Workspace& ws)\n                 (int)entry->GetTxSize() - (int)ws.m_conflicting_size);\n         ws.m_replaced_transactions.push_back(it->GetSharedTx());\n     }\n-    m_pool.RemoveStaged(ws.m_all_conflicting, false, MemPoolRemovalReason::REPLACED);\n+    if (ws.m_witness_replace) {\n+        // Only remove the direct conflict; preserve and update the descendants.\n+        m_pool.RemoveStaged(ws.m_iters_conflicting, /* updateDescendants */ true, MemPoolRemovalReason::REPLACED);\n+    } else {\n+        m_pool.RemoveStaged(ws.m_all_conflicting, /* updateDescendants */ false, MemPoolRemovalReason::REPLACED);\n+    }\n \n     // This transaction should only count for fee estimation if:\n     // - it's not being re-added during a reorg which bypasses typical mempool fee limits\n     // - the node is not behind\n     // - the transaction is not dependent on any other transactions in the mempool\n     // - it's not part of a package. Since package relay is not currently supported, this\n-    // transaction has not necessarily been accepted to miners' mempools.\n-    bool validForFeeEstimation = !bypass_limits && !args.m_package_submission && IsCurrentForFeeEstimation(m_active_chainstate) && m_pool.HasNoInputsOf(tx);\n+    //   transaction has not necessarily been accepted to miners' mempools\n+    // - this is not a witness replacement. Miners may not have witness replacement implemented\n+    //   (yet). TODO: re-include witness replacements in v25.0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24007#discussion_r780849935",
      "id" : 780849935,
      "line" : 1055,
      "node_id" : "PRRC_kwDOABII584uitMP",
      "original_commit_id" : "b15079ac7bc539df9854069b834f9ca437e79b8e",
      "original_line" : 1055,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 130,
      "pull_request_review_id" : 847323456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24007",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780849935/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T00:24:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/780849935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24007#discussion_r781043034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781043034"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reasoning was based on #9519 - adding a witness replacement to the fee estimator isn't really accurate unless miners are also allowing witness replacements. I think it's reasonable to wait 1 or 2 releases for miners to update their policies? We just need to not forget to remove this bool. I imagine it'll take some time for it to be used, anyway.",
      "commit_id" : "b15079ac7bc539df9854069b834f9ca437e79b8e",
      "created_at" : "2022-01-10T10:06:42Z",
      "diff_hunk" : "@@ -1013,18 +1038,33 @@ bool MemPoolAccept::Finalize(const ATMPArgs& args, Workspace& ws)\n                 (int)entry->GetTxSize() - (int)ws.m_conflicting_size);\n         ws.m_replaced_transactions.push_back(it->GetSharedTx());\n     }\n-    m_pool.RemoveStaged(ws.m_all_conflicting, false, MemPoolRemovalReason::REPLACED);\n+    if (ws.m_witness_replace) {\n+        // Only remove the direct conflict; preserve and update the descendants.\n+        m_pool.RemoveStaged(ws.m_iters_conflicting, /* updateDescendants */ true, MemPoolRemovalReason::REPLACED);\n+    } else {\n+        m_pool.RemoveStaged(ws.m_all_conflicting, /* updateDescendants */ false, MemPoolRemovalReason::REPLACED);\n+    }\n \n     // This transaction should only count for fee estimation if:\n     // - it's not being re-added during a reorg which bypasses typical mempool fee limits\n     // - the node is not behind\n     // - the transaction is not dependent on any other transactions in the mempool\n     // - it's not part of a package. Since package relay is not currently supported, this\n-    // transaction has not necessarily been accepted to miners' mempools.\n-    bool validForFeeEstimation = !bypass_limits && !args.m_package_submission && IsCurrentForFeeEstimation(m_active_chainstate) && m_pool.HasNoInputsOf(tx);\n+    //   transaction has not necessarily been accepted to miners' mempools\n+    // - this is not a witness replacement. Miners may not have witness replacement implemented\n+    //   (yet). TODO: re-include witness replacements in v25.0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24007#discussion_r781043034",
      "id" : 781043034,
      "in_reply_to_id" : 780849935,
      "line" : 1055,
      "node_id" : "PRRC_kwDOABII584ujcVa",
      "original_commit_id" : "b15079ac7bc539df9854069b834f9ca437e79b8e",
      "original_line" : 1055,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 130,
      "pull_request_review_id" : 847595420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24007",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781043034/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T10:06:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781043034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We should probably use the same criteria for the feerate increase. Either this new criteria is safe to apply to other replacements, or it isn't safe.",
      "created_at" : "2022-01-12T07:44:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24007#issuecomment-1010736034",
      "id" : 1010736034,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24007",
      "node_id" : "IC_kwDOABII5848Ppui",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1010736034/reactions"
      },
      "updated_at" : "2022-01-12T07:44:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1010736034",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> We should probably use the same criteria for the feerate increase. Either this new criteria is safe to apply to other replacements, or it isn't safe.\r\n\r\nJust to clarify, what do you mean by \"the same\" criteria? Our current rules require an increase in absolute fees, which is not possible when the txid is the same.",
      "created_at" : "2022-01-14T10:28:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24007#issuecomment-1012996025",
      "id" : 1012996025,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24007",
      "node_id" : "IC_kwDOABII5848YRe5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012996025/reactions"
      },
      "updated_at" : "2022-01-14T10:28:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012996025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
