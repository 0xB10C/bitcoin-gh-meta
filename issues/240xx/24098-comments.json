[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22953](https://github.com/bitcoin/bitcoin/pull/22953) (refactor: introduce single-separator split helper (boost::split replacement) by theStack)\n* [#21422](https://github.com/bitcoin/bitcoin/pull/21422) (Add feerate histogram to getmempoolinfo by kiminuo)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-19T05:48:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016106985",
      "id" : 1016106985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848kI_p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016106985/reactions"
      },
      "updated_at" : "2022-01-19T18:01:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016106985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-19T08:40:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016205759",
      "id" : 1016205759,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848khG_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016205759/reactions"
      },
      "updated_at" : "2022-01-19T08:40:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016205759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Force pushed to rebase after #24054 was merged; no other changes.",
      "created_at" : "2022-01-19T10:29:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016296840",
      "id" : 1016296840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848k3WI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016296840/reactions"
      },
      "updated_at" : "2022-01-19T10:29:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016296840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Is there a large cost to maintaining both ways? If not, it might be better to keep both to not upset users for a weak motivation.",
      "created_at" : "2022-01-19T11:30:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016369472",
      "id" : 1016369472,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848lJFA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016369472/reactions"
      },
      "updated_at" : "2022-01-19T11:30:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016369472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r787655265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787655265"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if I try to pass a blockhash without the extension (.<bin|hex|json>) in `/headers`, like:\r\n`/rest/headers/000000001aeae195809d120b5d66a39c83eb48792e068f8ea1fea19d84a4278a?count=5`\r\nreturns: `Invalid hash: 000000001aeae195809d120b5d66a39c83eb48792e068f8ea1fea19d84a4278a?count=5`\r\n\r\nIn the deprecated, `/rest/headers/5/000000001aeae195809d120b5d66a39c83eb48792e068f8ea1fea19d84a4278a`\r\nreturns: `output format not found (available: .bin, .hex, .json)`\r\n\r\n\r\n",
      "commit_id" : "f861b6df054f5ebfe7a86d4b453ff95dabf3e178",
      "created_at" : "2022-01-19T11:31:21Z",
      "diff_hunk" : "@@ -195,15 +193,27 @@ static bool rest_headers(const std::any& context,\n     std::vector<std::string> path;\n     boost::split(path, param, boost::is_any_of(\"/\"));\n \n-    if (path.size() != 2)\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"No header count specified. Use /rest/headers/<count>/<hash>.<ext>.\");\n+    std::string raw_count {};\n+    std::string hashStr {};\n+    if (path.size() == 2) {\n+        // deprecated path: /rest/headers/<count>/<hash>\n+        hashStr = path[1];\n+        raw_count = path[0];\n+    }\n+    else if (path.size() == 1) {\n+        // new path with query parameter: /rest/headers/<hash>?count=<count>\n+        hashStr = path[0];\n+        raw_count = req->GetQueryParameter(\"count\", \"5\");;\n+    }\n+    else {\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid request. Use /rest/headers/<hash>.<ext>?count=<count>\");\n+    }\n \n-    const auto parsed_count{ToIntegral<size_t>(path[0])};\n+    auto parsed_count = ToIntegral<size_t>(raw_count);\n     if (!parsed_count.has_value() || *parsed_count < 1 || *parsed_count > MAX_REST_HEADERS_RESULTS) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, path[0]));\n+        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, raw_count));\n     }\n \n-    std::string hashStr = path[1];\n     uint256 hash;\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r787655265",
      "id" : 787655265,
      "line" : 219,
      "node_id" : "PRRC_kwDOABII584u8qph",
      "original_commit_id" : "f861b6df054f5ebfe7a86d4b453ff95dabf3e178",
      "original_line" : 219,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 88,
      "pull_request_review_id" : 856666265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787655265/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T11:31:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787655265",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r787750681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787750681"
         }
      },
      "author_association" : "NONE",
      "body" : "You're right, that should be handled better. I've:\r\n- updated `ParseDataFormat` to ignore the query string even when no data format is found\r\n- updated documentation on `ParseDataFormat` in `rest.h` to document existing and new behaviour\r\n- added a test case to `test_query_string` to capture what you've found\r\n\r\nRebased and pushed to 0415aaa",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-19T13:36:46Z",
      "diff_hunk" : "@@ -195,15 +193,27 @@ static bool rest_headers(const std::any& context,\n     std::vector<std::string> path;\n     boost::split(path, param, boost::is_any_of(\"/\"));\n \n-    if (path.size() != 2)\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"No header count specified. Use /rest/headers/<count>/<hash>.<ext>.\");\n+    std::string raw_count {};\n+    std::string hashStr {};\n+    if (path.size() == 2) {\n+        // deprecated path: /rest/headers/<count>/<hash>\n+        hashStr = path[1];\n+        raw_count = path[0];\n+    }\n+    else if (path.size() == 1) {\n+        // new path with query parameter: /rest/headers/<hash>?count=<count>\n+        hashStr = path[0];\n+        raw_count = req->GetQueryParameter(\"count\", \"5\");;\n+    }\n+    else {\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid request. Use /rest/headers/<hash>.<ext>?count=<count>\");\n+    }\n \n-    const auto parsed_count{ToIntegral<size_t>(path[0])};\n+    auto parsed_count = ToIntegral<size_t>(raw_count);\n     if (!parsed_count.has_value() || *parsed_count < 1 || *parsed_count > MAX_REST_HEADERS_RESULTS) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, path[0]));\n+        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, raw_count));\n     }\n \n-    std::string hashStr = path[1];\n     uint256 hash;\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r787750681",
      "id" : 787750681,
      "in_reply_to_id" : 787655265,
      "line" : 221,
      "node_id" : "PRRC_kwDOABII584u9B8Z",
      "original_commit_id" : "f861b6df054f5ebfe7a86d4b453ff95dabf3e178",
      "original_line" : 221,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 102,
      "pull_request_review_id" : 856801988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787750681/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T13:37:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/787750681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Is there a large cost to maintaining both ways? If not, it might be better to keep both to not upset users for a weak motivation.\r\n\r\nThe PR is already setup to maintain both ways, so anyone using the (to be) deprecated endpoints should not be affected. This is documented in REST-interface.md too, so users are aware it is still supported but that they should probably use the new endpoint for new applications. The maintenance overhead is minimal, basically in [`rest_headers`](https://github.com/bitcoin/bitcoin/pull/24098/files#diff-590507deaf686d6571f73979df5f3c6da6013a13e597f390b8facce39f7c69d1R200-R204) and [`rest_filter_header`](https://github.com/bitcoin/bitcoin/pull/24098/files#diff-590507deaf686d6571f73979df5f3c6da6013a13e597f390b8facce39f7c69d1R372-R376) we have an if/else branch that adds 3 LoC to maintain the old endpoints too. Some additional refactoring could be done to simplify without the two branches, but it's no big deal.\r\n\r\nPersonally, I would definitely not remove the old endpoints in the next release, and probably not until some bigger API refactoring would make this desirable, in which case we should notify users more explicitly. I did not add any deprecation logging to avoid behaviour change, and because I think we don't have to push users away from the old endpoints yet.",
      "created_at" : "2022-01-19T13:47:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016482318",
      "id" : 1016482318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848lkoO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016482318/reactions"
      },
      "updated_at" : "2022-01-19T13:47:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016482318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I didn't understand `Deprecated (but not removed) since 23.0:`, will both ways be kept?\r\n\r\nThank you for the review! Correct, I argue both should be kept at least for now, and that's how it's currently implemented. I'm open to suggestions for better phrasing, but typically deprecated means a feature is no longer developed and may be removed in the future, but is still available. See e.g. [Microsoft's definition](https://docs.microsoft.com/en-us/dynamics365/fin-ops-core/dev-itpro/migration-upgrade/deprecated-features). Does that clear things up?",
      "created_at" : "2022-01-19T13:53:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016486748",
      "id" : 1016486748,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848lltc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016486748/reactions"
      },
      "updated_at" : "2022-01-19T13:53:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016486748",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@stickies-v instead of deprecating the old behavior the new can be just called backwards-compatible. By the way, an example of an externalized backward-compatible REST-service (in a way similar to what you have here) using Caddy webserver can be seen at https://github.com/jsarenik/bitcoin-faucet-shell/blob/master/Caddyfile.txt",
      "created_at" : "2022-01-19T16:46:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1016657935",
      "id" : 1016657935,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848mPgP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016657935/reactions"
      },
      "updated_at" : "2022-01-19T16:46:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1016657935",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/244565?v=4",
         "events_url" : "https://api.github.com/users/jsarenik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jsarenik/followers",
         "following_url" : "https://api.github.com/users/jsarenik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jsarenik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jsarenik",
         "id" : 244565,
         "login" : "jsarenik",
         "node_id" : "MDQ6VXNlcjI0NDU2NQ==",
         "organizations_url" : "https://api.github.com/users/jsarenik/orgs",
         "received_events_url" : "https://api.github.com/users/jsarenik/received_events",
         "repos_url" : "https://api.github.com/users/jsarenik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jsarenik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jsarenik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jsarenik"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> @stickies-v instead of deprecating the old behavior the new can be just called backwards-compatible.\r\n\r\nWe can, but I'm not convinced we should? I think deprecating the old endpoints has a clear benefit of keeping the documented interface simpler and better adhering to common REST API practices. Simultaneously, since they're not removed, existing users are not affected, just gently nudged towards the new interface if and when it suits them. \r\nThank you for your review!",
      "created_at" : "2022-01-20T10:30:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1017331461",
      "id" : 1017331461,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII5848oz8F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1017331461/reactions"
      },
      "updated_at" : "2022-01-20T10:30:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1017331461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790169294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790169294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested! Works! ",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-22T18:10:58Z",
      "diff_hunk" : "@@ -195,15 +193,27 @@ static bool rest_headers(const std::any& context,\n     std::vector<std::string> path;\n     boost::split(path, param, boost::is_any_of(\"/\"));\n \n-    if (path.size() != 2)\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"No header count specified. Use /rest/headers/<count>/<hash>.<ext>.\");\n+    std::string raw_count {};\n+    std::string hashStr {};\n+    if (path.size() == 2) {\n+        // deprecated path: /rest/headers/<count>/<hash>\n+        hashStr = path[1];\n+        raw_count = path[0];\n+    }\n+    else if (path.size() == 1) {\n+        // new path with query parameter: /rest/headers/<hash>?count=<count>\n+        hashStr = path[0];\n+        raw_count = req->GetQueryParameter(\"count\", \"5\");;\n+    }\n+    else {\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid request. Use /rest/headers/<hash>.<ext>?count=<count>\");\n+    }\n \n-    const auto parsed_count{ToIntegral<size_t>(path[0])};\n+    auto parsed_count = ToIntegral<size_t>(raw_count);\n     if (!parsed_count.has_value() || *parsed_count < 1 || *parsed_count > MAX_REST_HEADERS_RESULTS) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, path[0]));\n+        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Header count is invalid or out of acceptable range (1-%u): %s\", MAX_REST_HEADERS_RESULTS, raw_count));\n     }\n \n-    std::string hashStr = path[1];\n     uint256 hash;\n     if (!ParseHashStr(hashStr, hash))\n         return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid hash: \" + hashStr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790169294",
      "id" : 790169294,
      "in_reply_to_id" : 787655265,
      "line" : 221,
      "node_id" : "PRRC_kwDOABII584vGQbO",
      "original_commit_id" : "f861b6df054f5ebfe7a86d4b453ff95dabf3e178",
      "original_line" : 221,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 102,
      "pull_request_review_id" : 860229304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790169294/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-22T18:10:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790169294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336549"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why only `count` as a query parameter? How about\r\n```\r\nGET /rest/headers?block_hash=&count=&format=\r\n\r\nblock_hash defaults to tip\r\ncount defaults to 5\r\nformat defaults to request accept header, JSON if not specified\r\n```",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-23T22:00:12Z",
      "diff_hunk" : "@@ -47,18 +47,24 @@ The HTTP request and response are both handled entirely in-memory.\n With the /notxdetails/ option JSON response will only contain the transaction hash instead of the complete transaction details. The option only affects the JSON response.\n \n #### Blockheaders\n-`GET /rest/headers/<COUNT>/<BLOCK-HASH>.<bin|hex|json>`\n+`GET /rest/headers/<BLOCK-HASH>.<bin|hex|json>?count=<COUNT=5>`",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336549",
      "id" : 790336549,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII584vG5Ql",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/REST-interface.md",
      "position" : 5,
      "pull_request_review_id" : 860377099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336549/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T22:29:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe use std::optional because an empty string could be the default?",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-23T22:03:00Z",
      "diff_hunk" : "@@ -639,6 +640,42 @@ HTTPRequest::RequestMethod HTTPRequest::GetRequestMethod() const\n     }\n }\n \n+std::string HTTPRequest::GetQueryParameter(const std::string& key, const std::string& default_val) const\n+{\n+    std::string uri = evhttp_request_get_uri(req);\n+    auto result = GetQueryParameterFromUri(uri, key, default_val);\n+\n+    return result;\n+}\n+\n+std::string GetQueryParameterFromUri(const std::string& uri, const std::string& key, const std::string& default_val)\n+{\n+    auto query_start = uri.rfind('?');\n+    if (query_start != std::string::npos) {\n+        // Capture everything after the '?' sign, i.e. the query string\n+        auto query_string = uri.substr(query_start + 1, uri.size() - (query_start + 1));\n+\n+        // Parse the query string into a key-value queue and iterate over it\n+        struct evkeyvalq params_q;\n+        evhttp_parse_query_str(query_string.c_str(), &params_q);\n+\n+        struct evkeyval* param;\n+        for (param = params_q.tqh_first; param; param = param->next.tqe_next) {\n+            if (param->key == key) {\n+                std::string result = param->value;\n+                evhttp_clear_headers(&params_q);\n+                return result;\n+            }\n+        }\n+        evhttp_clear_headers(&params_q);\n+    }\n+\n+    if (default_val != \"\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336836",
      "id" : 790336836,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII584vG5VE",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 673,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 42,
      "pull_request_review_id" : 860377099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T22:29:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790336836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790338713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790338713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should use `evhttp_uri_parse`.",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-23T22:21:27Z",
      "diff_hunk" : "@@ -639,6 +640,42 @@ HTTPRequest::RequestMethod HTTPRequest::GetRequestMethod() const\n     }\n }\n \n+std::string HTTPRequest::GetQueryParameter(const std::string& key, const std::string& default_val) const\n+{\n+    std::string uri = evhttp_request_get_uri(req);\n+    auto result = GetQueryParameterFromUri(uri, key, default_val);\n+\n+    return result;\n+}\n+\n+std::string GetQueryParameterFromUri(const std::string& uri, const std::string& key, const std::string& default_val)\n+{\n+    auto query_start = uri.rfind('?');",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790338713",
      "id" : 790338713,
      "line" : 653,
      "node_id" : "PRRC_kwDOABII584vG5yZ",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 653,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 22,
      "pull_request_review_id" : 860377099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790338713/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-23T22:29:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790338713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790766518"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790766518"
         }
      },
      "author_association" : "NONE",
      "body" : "Agreed and done, for both `GetQueryParameterFromUri` and `HTTPRequest:GetQueryParameter`.",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-24T13:56:27Z",
      "diff_hunk" : "@@ -639,6 +640,42 @@ HTTPRequest::RequestMethod HTTPRequest::GetRequestMethod() const\n     }\n }\n \n+std::string HTTPRequest::GetQueryParameter(const std::string& key, const std::string& default_val) const\n+{\n+    std::string uri = evhttp_request_get_uri(req);\n+    auto result = GetQueryParameterFromUri(uri, key, default_val);\n+\n+    return result;\n+}\n+\n+std::string GetQueryParameterFromUri(const std::string& uri, const std::string& key, const std::string& default_val)\n+{\n+    auto query_start = uri.rfind('?');\n+    if (query_start != std::string::npos) {\n+        // Capture everything after the '?' sign, i.e. the query string\n+        auto query_string = uri.substr(query_start + 1, uri.size() - (query_start + 1));\n+\n+        // Parse the query string into a key-value queue and iterate over it\n+        struct evkeyvalq params_q;\n+        evhttp_parse_query_str(query_string.c_str(), &params_q);\n+\n+        struct evkeyval* param;\n+        for (param = params_q.tqh_first; param; param = param->next.tqe_next) {\n+            if (param->key == key) {\n+                std::string result = param->value;\n+                evhttp_clear_headers(&params_q);\n+                return result;\n+            }\n+        }\n+        evhttp_clear_headers(&params_q);\n+    }\n+\n+    if (default_val != \"\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790766518",
      "id" : 790766518,
      "in_reply_to_id" : 790336836,
      "line" : 673,
      "node_id" : "PRRC_kwDOABII584vIiO2",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 673,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : 42,
      "pull_request_review_id" : 860991881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790766518/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-24T13:56:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790766518",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790768636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790768636"
         }
      },
      "author_association" : "NONE",
      "body" : "I agree and considered that, but decided to omit this for now to keep this PR's scope limited. Would you be okay with this being incorporated in a follow up PR (which I'm happy to take on right away?)",
      "commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "created_at" : "2022-01-24T13:58:54Z",
      "diff_hunk" : "@@ -47,18 +47,24 @@ The HTTP request and response are both handled entirely in-memory.\n With the /notxdetails/ option JSON response will only contain the transaction hash instead of the complete transaction details. The option only affects the JSON response.\n \n #### Blockheaders\n-`GET /rest/headers/<COUNT>/<BLOCK-HASH>.<bin|hex|json>`\n+`GET /rest/headers/<BLOCK-HASH>.<bin|hex|json>?count=<COUNT=5>`",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790768636",
      "id" : 790768636,
      "in_reply_to_id" : 790336549,
      "line" : 50,
      "node_id" : "PRRC_kwDOABII584vIiv8",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 50,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "doc/REST-interface.md",
      "position" : 5,
      "pull_request_review_id" : 860995025,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790768636/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-24T13:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790768636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790920772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790920772"
         }
      },
      "author_association" : "NONE",
      "body" : "Agreed and done.",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-24T16:26:54Z",
      "diff_hunk" : "@@ -639,6 +640,42 @@ HTTPRequest::RequestMethod HTTPRequest::GetRequestMethod() const\n     }\n }\n \n+std::string HTTPRequest::GetQueryParameter(const std::string& key, const std::string& default_val) const\n+{\n+    std::string uri = evhttp_request_get_uri(req);\n+    auto result = GetQueryParameterFromUri(uri, key, default_val);\n+\n+    return result;\n+}\n+\n+std::string GetQueryParameterFromUri(const std::string& uri, const std::string& key, const std::string& default_val)\n+{\n+    auto query_start = uri.rfind('?');",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790920772",
      "id" : 790920772,
      "in_reply_to_id" : 790338713,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vJH5E",
      "original_commit_id" : "0415aaafb2f7206c117f58cc7a4a967cee0fa619",
      "original_line" : 653,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : 861215930,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790920772/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-24T16:26:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/790920772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Rebased and:\r\n- fixed wrong indentation of [GetQueryParameter](https://github.com/bitcoin/bitcoin/compare/0415aaafb2f7206c117f58cc7a4a967cee0fa619..e1822e79b3d5230f976360e5500d7ef59dd8783c#diff-aa9c90add56b31a60e0d574fa9025945be2b01306c265d00e3aa0a27c6b4bc3fL132-R146) documentation\r\n- incorporated promag's comments on [std::optional](https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336836) and [evhttp_uri_parse](https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790338713)\r\n\r\nThank you @promag for your review. To address your comment:\r\n> I don't see a strong reason for this change TBH\r\n\r\nI agree this is not a critical issue. However, I think everyone can agree my proposal is the more standard way of organizing API endpoints. If that's true (and so far no one argued the opposite), it's better to refactor this earlier rather than later, because for example in [#17631](https://github.com/bitcoin/bitcoin/pull/17631#discussion_r733031180) we (I think rightfully) preferred internal consistency over adhering to best practices. We now also have the functionality in place for other existing or new endpoints to easily accept query parameters, including your [proposal](https://github.com/bitcoin/bitcoin/pull/24098#discussion_r790336549) for the data format.\r\n\r\n_Note: I've just learned I should only rebase in case of merge conflicts. My apologies for the added review difficulty, won't happen going forward._",
      "created_at" : "2022-01-24T16:27:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#issuecomment-1020285387",
      "id" : 1020285387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24098",
      "node_id" : "IC_kwDOABII58480FHL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1020285387/reactions"
      },
      "updated_at" : "2022-01-24T16:27:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1020285387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/69010457?v=4",
         "events_url" : "https://api.github.com/users/stickies-v/events{/privacy}",
         "followers_url" : "https://api.github.com/users/stickies-v/followers",
         "following_url" : "https://api.github.com/users/stickies-v/following{/other_user}",
         "gists_url" : "https://api.github.com/users/stickies-v/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/stickies-v",
         "id" : 69010457,
         "login" : "stickies-v",
         "node_id" : "MDQ6VXNlcjY5MDEwNDU3",
         "organizations_url" : "https://api.github.com/users/stickies-v/orgs",
         "received_events_url" : "https://api.github.com/users/stickies-v/received_events",
         "repos_url" : "https://api.github.com/users/stickies-v/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/stickies-v/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/stickies-v/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/stickies-v"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792480603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792480603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: most of the .cpp translation units include their own header file first, before all other includes, i.e.:\r\n\r\n```c++\r\n#include <rest.h>\r\n\r\n#include <blockfilter.h>\r\n#include <chain.h>\r\n#include <chainparams.h>\r\n...\r\n```",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T10:05:38Z",
      "diff_hunk" : "@@ -14,6 +14,7 @@\n #include <node/context.h>\n #include <primitives/block.h>\n #include <primitives/transaction.h>\n+#include <rest.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792480603",
      "id" : 792480603,
      "line" : 17,
      "node_id" : "PRRC_kwDOABII584vPEtb",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 17,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 4,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792480603/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792480603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792505218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792505218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Now that this enum is exposed in the header, consider using a slightly more descriptive name such as `RESTRequestFormat` or similar.",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T10:35:55Z",
      "diff_hunk" : "@@ -0,0 +1,28 @@\n+// Copyright (c) 2015-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_REST_H\n+#define BITCOIN_REST_H\n+\n+#include <string>\n+\n+enum class RetFormat {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792505218",
      "id" : 792505218,
      "line" : 10,
      "node_id" : "PRRC_kwDOABII584vPKuC",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 10,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/rest.h",
      "position" : 10,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792505218/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792505218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792506087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792506087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "While touching this line:\r\n\r\n```suggestion\r\n    if (pos_format == std::string::npos) {\r\n```",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T10:37:03Z",
      "diff_hunk" : "@@ -137,25 +132,30 @@ static ChainstateManager* GetChainman(const std::any& context, HTTPRequest* req)\n     return node_context->chainman.get();\n }\n \n-static RetFormat ParseDataFormat(std::string& param, const std::string& strReq)\n+RetFormat ParseDataFormat(std::string& param, const std::string& strReq)\n {\n-    const std::string::size_type pos = strReq.rfind('.');\n-    if (pos == std::string::npos)\n+    // Remove query string (if any, separated with '?') as it should not interfere with\n+    // parsing param and data format\n+    const std::string::size_type pos_querystr = strReq.rfind('?');\n+    const std::string::size_type pos_format = strReq.rfind('.');\n+    param = strReq.substr(0, std::min(pos_format, pos_querystr));\n+\n+    // No format string is found\n+    if (pos_format == std::string::npos)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792506087",
      "id" : 792506087,
      "line" : 144,
      "node_id" : "PRRC_kwDOABII584vPK7n",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 144,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 46,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792506087/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792506087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792560203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792560203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps also test a URI that contains a `?` before `.`, eg `\"/rest/endpoint/someresource?p1=v1.json\")`",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T11:51:30Z",
      "diff_hunk" : "@@ -0,0 +1,43 @@\n+// Copyright (c) 2012-2022 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <rest.h>\n+#include <test/util/setup_common.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <string>\n+\n+BOOST_FIXTURE_TEST_SUITE(rest_tests, BasicTestingSetup)\n+\n+BOOST_AUTO_TEST_CASE(test_query_string)\n+{\n+    std::string param;\n+    RetFormat rf;\n+    // No query string\n+    rf = ParseDataFormat(param, \"/rest/endpoint/someresource.json\");\n+    BOOST_CHECK_EQUAL(param, \"/rest/endpoint/someresource\");\n+    BOOST_CHECK_EQUAL(rf, RetFormat::JSON);\n+\n+    // Query string with single parameter\n+    rf = ParseDataFormat(param, \"/rest/endpoint/someresource.json?p1=v1\");\n+    BOOST_CHECK_EQUAL(param, \"/rest/endpoint/someresource\");\n+    BOOST_CHECK_EQUAL(rf, RetFormat::JSON);\n+\n+    // Query string with multiple parameters\n+    rf = ParseDataFormat(param, \"/rest/endpoint/someresource.json?p1=v1&p2=v2\");\n+    BOOST_CHECK_EQUAL(param, \"/rest/endpoint/someresource\");\n+    BOOST_CHECK_EQUAL(rf, RetFormat::JSON);\n+\n+    // Incorrectly formed query string will not be handled",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792560203",
      "id" : 792560203,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII584vPYJL",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/test/rest_tests.cpp",
      "position" : 33,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792560203/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792560203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792564751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564751"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    } else if (uri_parts.size() == 2) {\r\n```",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T11:58:10Z",
      "diff_hunk" : "@@ -355,13 +367,30 @@ static bool rest_filter_header(const std::any& context, HTTPRequest* req, const\n \n     std::vector<std::string> uri_parts;\n     boost::split(uri_parts, param, boost::is_any_of(\"/\"));\n-    if (uri_parts.size() != 3) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid URI format. Expected /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\");\n+    std::string raw_count {};\n+    size_t blockhash_index {};\n+    if (uri_parts.size() == 3) {\n+        // deprecated path: /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\n+        blockhash_index = 2;\n+        raw_count = uri_parts[1];\n+    }\n+    else if (uri_parts.size() == 2) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792564751",
      "id" : 792564751,
      "line" : 377,
      "node_id" : "PRRC_kwDOABII584vPZQP",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 377,
      "original_position" : 116,
      "original_start_line" : 376,
      "path" : "src/rest.cpp",
      "position" : 116,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564751/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 376,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792564863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    } else {\r\n```",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T11:58:19Z",
      "diff_hunk" : "@@ -355,13 +367,30 @@ static bool rest_filter_header(const std::any& context, HTTPRequest* req, const\n \n     std::vector<std::string> uri_parts;\n     boost::split(uri_parts, param, boost::is_any_of(\"/\"));\n-    if (uri_parts.size() != 3) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid URI format. Expected /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\");\n+    std::string raw_count {};\n+    size_t blockhash_index {};\n+    if (uri_parts.size() == 3) {\n+        // deprecated path: /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\n+        blockhash_index = 2;\n+        raw_count = uri_parts[1];\n+    }\n+    else if (uri_parts.size() == 2) {\n+        // new path with query parameter: /rest/blockfilterheaders/<filtertype>/<blockhash>?count=<count>\n+        blockhash_index = 1;\n+        raw_count = req->GetQueryParameter(\"count\", \"5\");\n+    }\n+    else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792564863",
      "id" : 792564863,
      "line" : 382,
      "node_id" : "PRRC_kwDOABII584vPZR_",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 382,
      "original_position" : 121,
      "original_start_line" : 381,
      "path" : "src/rest.cpp",
      "position" : 121,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564863/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 381,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792564863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792571528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792571528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We don't usually use exceptions to return error conditions in the Bitcoin Core codebase. If you do this, wherever there's a key that doesn't have a default, the calling code will have to wrap this call in a try/except, and then catch the runtime_error and return it as a RESTERR.\r\n\r\nDid you consider returning a `std::optional<std::string>`, and then using [std::optional<t>::value_or()](https://en.cppreference.com/w/cpp/utility/optional/value_or) to add the default, and [std::optional<t>::has_value()](https://en.cppreference.com/w/cpp/utility/optional/operator_bool) to catch if a non-default option hasn't been set?",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T12:06:41Z",
      "diff_hunk" : "@@ -83,6 +84,19 @@ class HTTPRequest\n      */\n     RequestMethod GetRequestMethod() const;\n \n+    /** Get the query parameter value from request uri for a specified key.\n+     * Throws std::runtime_error if key does not exist and no default_val is specified.\n+     *\n+     * If the query string contains duplicate keys, the first value is returned. Many web frameworks\n+     * would instead parse this as an array of values, but this is not (yet) implemented as it is\n+     * currently not needed in any of the endpoints.\n+     *\n+     * @param[in] key represents the query parameter of which the value is returned\n+     * @param[in] default_val (optional) is returned if key is not in query string\n+     * @throws std::runtime_error if key is not in query string and no default_val was provided",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792571528",
      "id" : 792571528,
      "line" : 96,
      "node_id" : "PRRC_kwDOABII584vPa6I",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 96,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/httpserver.h",
      "position" : 24,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792571528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792571528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792574341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792574341"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to lose the `const` here?",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T12:10:01Z",
      "diff_hunk" : "@@ -355,13 +367,30 @@ static bool rest_filter_header(const std::any& context, HTTPRequest* req, const\n \n     std::vector<std::string> uri_parts;\n     boost::split(uri_parts, param, boost::is_any_of(\"/\"));\n-    if (uri_parts.size() != 3) {\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid URI format. Expected /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\");\n+    std::string raw_count {};\n+    size_t blockhash_index {};\n+    if (uri_parts.size() == 3) {\n+        // deprecated path: /rest/blockfilterheaders/<filtertype>/<count>/<blockhash>\n+        blockhash_index = 2;\n+        raw_count = uri_parts[1];\n+    }\n+    else if (uri_parts.size() == 2) {\n+        // new path with query parameter: /rest/blockfilterheaders/<filtertype>/<blockhash>?count=<count>\n+        blockhash_index = 1;\n+        raw_count = req->GetQueryParameter(\"count\", \"5\");\n+    }\n+    else {\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid URI format. Expected /rest/blockfilterheaders/<filtertype>/<blockhash>.<ext>?count=<count>\");\n+    }\n+\n+    auto parsed_count = ToIntegral<size_t>(raw_count);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792574341",
      "id" : 792574341,
      "line" : 386,
      "node_id" : "PRRC_kwDOABII584vPbmF",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 386,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/rest.cpp",
      "position" : 125,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792574341/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792574341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792575674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792575674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did you consider making `query_string` an optional argument to `test_rest_request()`? It seems a bit contrived to pass the URI without the `req_type` as part of the string, but with the query_string.",
      "commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "created_at" : "2022-01-26T12:11:56Z",
      "diff_hunk" : "@@ -53,12 +53,13 @@ def skip_test_if_missing_module(self):\n \n     def test_rest_request(self, uri, http_method='GET', req_type=ReqType.JSON, body='', status=200, ret_type=RetType.JSON):\n         rest_uri = '/rest' + uri\n-        if req_type == ReqType.JSON:\n-            rest_uri += '.json'\n-        elif req_type == ReqType.BIN:\n-            rest_uri += '.bin'\n-        elif req_type == ReqType.HEX:\n-            rest_uri += '.hex'\n+        query_string = ''",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24098#discussion_r792575674",
      "id" : 792575674,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII584vPb66",
      "original_commit_id" : "e1822e79b3d5230f976360e5500d7ef59dd8783c",
      "original_line" : 56,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/interface_rest.py",
      "position" : 10,
      "pull_request_review_id" : 863331148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24098",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792575674/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-26T12:18:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/792575674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
