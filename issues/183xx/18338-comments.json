[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18354 (Protect wallet from scheduler race conditions. by bvbfan)\n* #18278 (interfaces: Describe and follow some code conventions by ryanofsky)\n* #15761 (Replace -upgradewallet startup option with upgradewallet RPC by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-03-13T03:54:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598535986",
      "id" : 598535986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODUzNTk4Ng==",
      "updated_at" : "2020-03-15T19:26:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598535986",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I wrote a test for new register/unregister functions that could be added here: d65b4874fda47aad2e412f0e0cac27e8eafb3838 ([branch](https://github.com/ryanofsky/bitcoin/commits/review.18338.1-edit))",
      "created_at" : "2020-03-13T05:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598559646",
      "id" : 598559646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODU1OTY0Ng==",
      "updated_at" : "2020-03-13T05:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598559646",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> unregister from notifications earlier in UnloadWallet instead of\r\nReleaseWallet, and use a new RegisterSharedValidationInterface function to\r\nprevent the CValidationInterface shared_ptr from being deleted until the last\r\nnotification is actually finished.\r\n\r\nDoes not fix the root issue, which is notification thread hold mutex (no matter when notification is disconnected if it's the last instance of the wallet) then goes in Release wallet, flush, then deleting mutex while it's hold is SIGSEGV. Unit test does not do anything to ensure that.",
      "created_at" : "2020-03-13T13:31:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598721224",
      "id" : 598721224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODcyMTIyNA==",
      "updated_at" : "2020-03-13T13:35:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598721224",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Does not fix the root issue, which is notification thread hold mutex (no matter when notification is disconnected if it's the last instance of the wallet) then goes in Release wallet, flush, then deleting mutex while it's hold is SIGSEGV. Unit test does not do anything to ensure that.\r\n\r\nCan you give instructions to reproduce the issue or post a backtrace of the SIGSEGV? ReleaseWallet should not be called during a notification because ReleaseWallet is only called when the shared pointer reference count reaches 0. The unit test verifies that the reference count doesn't reach 0 during a notification until after the notification callback method returns, by checking that the destructor is called only after the callback returns.",
      "created_at" : "2020-03-13T14:19:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598742979",
      "id" : 598742979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODc0Mjk3OQ==",
      "updated_at" : "2020-03-13T14:19:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598742979",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "```\r\n#!/bin/bash\r\nwhile [ 1 ]\r\ndo\r\n    src/bitcoin-cli -testnet loadwallet test\r\n    src/bitcoin-cli -testnet unloadwallet test\r\ndone\r\n```\r\nRunning on testnet from scratch in parallel with this script it should not crash. Whole point of `EmptyQueue` was to not have notification holding wallet mutex while we delete it.",
      "created_at" : "2020-03-14T07:24:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599022346",
      "id" : 599022346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTAyMjM0Ng==",
      "updated_at" : "2020-03-14T07:24:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599022346",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@bvbfan that script crashes `bitcoin-qt -regtest -server -printtoconsole`.\r\n\r\nStill investigating but looking at call stack it's caused by queued connections \"in flight\" (like `WalletController::walletAdded(WalletModel*)`) while the wallet model is deleted in `WalletController::removeAndDeleteWallet`.",
      "created_at" : "2020-03-16T00:17:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599286541",
      "id" : 599286541,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTI4NjU0MQ==",
      "updated_at" : "2020-03-16T00:17:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599286541",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "It looks like another issue, wallet model holds a unique_ptr to interface wallet which in other hand have a shared_ptr to actual wallet. Since `UnloadWallet` actually deletes wallet (it gets it from wallet map) unless wallet model outlive wallet. First make sure it works like that\r\n`bitcoind -testnet` (it's testnet because every few seconds new block is connected and notification is activated)",
      "created_at" : "2020-03-16T12:18:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599504930",
      "id" : 599504930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTUwNDkzMA==",
      "updated_at" : "2020-03-16T12:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599504930",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   }
]
