[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18354 (Protect wallet from scheduler race conditions. by bvbfan)\n* #18278 (interfaces: Describe and follow some code conventions by ryanofsky)\n* #15761 (Replace -upgradewallet startup option with upgradewallet RPC by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-03-13T03:54:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598535986",
      "id" : 598535986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODUzNTk4Ng==",
      "updated_at" : "2020-03-15T19:26:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598535986",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I wrote a test for new register/unregister functions that could be added here: d65b4874fda47aad2e412f0e0cac27e8eafb3838 ([branch](https://github.com/ryanofsky/bitcoin/commits/review.18338.1-edit))",
      "created_at" : "2020-03-13T05:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598559646",
      "id" : 598559646,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODU1OTY0Ng==",
      "updated_at" : "2020-03-13T05:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598559646",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> unregister from notifications earlier in UnloadWallet instead of\r\nReleaseWallet, and use a new RegisterSharedValidationInterface function to\r\nprevent the CValidationInterface shared_ptr from being deleted until the last\r\nnotification is actually finished.\r\n\r\nDoes not fix the root issue, which is notification thread hold mutex (no matter when notification is disconnected if it's the last instance of the wallet) then goes in Release wallet, flush, then deleting mutex while it's hold is SIGSEGV. Unit test does not do anything to ensure that.",
      "created_at" : "2020-03-13T13:31:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598721224",
      "id" : 598721224,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODcyMTIyNA==",
      "updated_at" : "2020-03-13T13:35:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598721224",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Does not fix the root issue, which is notification thread hold mutex (no matter when notification is disconnected if it's the last instance of the wallet) then goes in Release wallet, flush, then deleting mutex while it's hold is SIGSEGV. Unit test does not do anything to ensure that.\r\n\r\nCan you give instructions to reproduce the issue or post a backtrace of the SIGSEGV? ReleaseWallet should not be called during a notification because ReleaseWallet is only called when the shared pointer reference count reaches 0. The unit test verifies that the reference count doesn't reach 0 during a notification until after the notification callback method returns, by checking that the destructor is called only after the callback returns.",
      "created_at" : "2020-03-13T14:19:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-598742979",
      "id" : 598742979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5ODc0Mjk3OQ==",
      "updated_at" : "2020-03-13T14:19:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598742979",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "```\r\n#!/bin/bash\r\nwhile [ 1 ]\r\ndo\r\n    src/bitcoin-cli -testnet loadwallet test\r\n    src/bitcoin-cli -testnet unloadwallet test\r\ndone\r\n```\r\nRunning on testnet from scratch in parallel with this script it should not crash. Whole point of `EmptyQueue` was to not have notification holding wallet mutex while we delete it.",
      "created_at" : "2020-03-14T07:24:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599022346",
      "id" : 599022346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTAyMjM0Ng==",
      "updated_at" : "2020-03-14T07:24:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599022346",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@bvbfan that script crashes `bitcoin-qt -regtest -server -printtoconsole`.\r\n\r\nStill investigating but looking at call stack it's caused by queued connections \"in flight\" (like `WalletController::walletAdded(WalletModel*)`) while the wallet model is deleted in `WalletController::removeAndDeleteWallet`.",
      "created_at" : "2020-03-16T00:17:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599286541",
      "id" : 599286541,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTI4NjU0MQ==",
      "updated_at" : "2020-03-16T00:17:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599286541",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "It looks like another issue, wallet model holds a unique_ptr to interface wallet which in other hand have a shared_ptr to actual wallet. Since `UnloadWallet` actually deletes wallet (it gets it from wallet map) unless wallet model outlive wallet. First make sure it works like that\r\n`bitcoind -testnet` (it's testnet because every few seconds new block is connected and notification is activated)",
      "created_at" : "2020-03-16T12:18:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599504930",
      "id" : 599504930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTUwNDkzMA==",
      "updated_at" : "2020-03-16T12:18:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599504930",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> First make sure it works like that\r\n> `bitcoind -testnet` (it's testnet because every few seconds new block is connected and notification is activated)\r\n\r\nThanks for clarifying this. I had tried a bunch of ways to reproduce the issue with -regtest and could never get it to happen. But with cf4cb28efcf80c018a7f070c671f43cd172dbd86 and -testnet I was able to get the deadlock to happen in just a few minutes.\r\n\r\nI still haven't been able to reproduce a SIGSEGV or any problem with this current PR 73bd96206851aa88db79b8efbc844700630980e1, though. So again if you have a stack trace it would help. Or it would help if you could describe in a more step-by-step way how you see the SIGSEGV happening\r\n",
      "created_at" : "2020-03-16T15:59:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599617151",
      "id" : 599617151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTYxNzE1MQ==",
      "updated_at" : "2020-03-16T15:59:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599617151",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I still haven't been able to reproduce a SIGSEGV or any problem with this current PR 73bd962, though. So again if you have a stack trace it would help. Or it would help if you could describe in a more step-by-step way how you see the SIGSEGV happening\r\n\r\nSince `UnloadWallet` actively deletes wallet that's may not happen since `g_wallet_init_interface` is global and it's call `UnloadWallet` in its destructor.",
      "created_at" : "2020-03-16T17:06:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599654176",
      "id" : 599654176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTY1NDE3Ng==",
      "updated_at" : "2020-03-16T17:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599654176",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > I still haven't been able to reproduce a SIGSEGV or any problem with this current PR [73bd962](https://github.com/bitcoin/bitcoin/commit/73bd96206851aa88db79b8efbc844700630980e1), though. So again if you have a stack trace it would help. Or it would help if you could describe in a more step-by-step way how you see the SIGSEGV happening\r\n> \r\n> Since `UnloadWallet` actively deletes wallet that's may not happen since `g_wallet_init_interface` is global and it's call `UnloadWallet` in its destructor.\r\n\r\nWhat may not happen?",
      "created_at" : "2020-03-16T17:32:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599667902",
      "id" : 599667902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTY2NzkwMg==",
      "updated_at" : "2020-03-16T17:32:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599667902",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> What may not happen?\r\n\r\nOh, maybe you are referring to the bitcoin-qt bug. I haven't tried to reproduce that yet.",
      "created_at" : "2020-03-16T17:34:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599668968",
      "id" : 599668968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTY2ODk2OA==",
      "updated_at" : "2020-03-16T17:34:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599668968",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599286541\r\n\r\n> @bvbfan that script crashes `bitcoin-qt -regtest -server -printtoconsole`.\r\n> \r\n> Still investigating but looking at call stack it's caused by queued connections \"in flight\" (like `WalletController::walletAdded(WalletModel*)`) while the wallet model is deleted in `WalletController::removeAndDeleteWallet`.\r\n\r\n@promag, I was able to reproduce this and I think it's basically a separate issue from the deadlock that happens with bitcoind. I created a bug report https://github.com/bitcoin/bitcoin/issues/18362. Would move any discussion of that issue there",
      "created_at" : "2020-03-16T18:56:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599706438",
      "id" : 599706438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTcwNjQzOA==",
      "updated_at" : "2020-03-16T18:56:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599706438",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393264763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393264763"
         }
      },
      "author_association" : "NONE",
      "body" : "`BlockUntilSyncedToCurrentChain` is still needed, unless we can expect data loss",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-16T19:32:30Z",
      "diff_hunk" : "@@ -137,6 +133,9 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393264763",
      "id" : 393264763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NDc2Mw==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 375524933,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-16T19:32:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393264763",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393265428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393265428"
         }
      },
      "author_association" : "NONE",
      "body" : "Why not shared_ptr here?",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-16T19:33:52Z",
      "diff_hunk" : "@@ -151,7 +159,7 @@ class CMainSignals {\n private:\n     std::unique_ptr<MainSignalsInstance> m_internals;\n \n-    friend void ::RegisterValidationInterface(CValidationInterface*);\n+    friend void ::RegisterSharedValidationInterface(std::shared_ptr<CValidationInterface>);\n     friend void ::UnregisterValidationInterface(CValidationInterface*);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393265428",
      "id" : 393265428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NTQyOA==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 30,
      "path" : "src/validationinterface.h",
      "position" : 30,
      "pull_request_review_id" : 375525771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-16T19:33:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393265428",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393266368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393266368"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393264763\r\n\r\n> `BlockUntilSyncedToCurrentChain` is still needed, unless we can expect data loss\r\n\r\nBlockUntilSyncedToCurrentChain can't be called with locks held and it doesn't make sense here. It makes sense at beginning of RPC calls to ensure consistency between calls. It doesn't directly relate to writing or consolidating data.",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-16T19:35:52Z",
      "diff_hunk" : "@@ -137,6 +133,9 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393266368",
      "id" : 393266368,
      "in_reply_to_id" : 393264763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NjM2OA==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 375526926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-16T19:41:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393266368",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393267054"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393267054"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393265428\r\n\r\n> Why not shared_ptr here?\r\n\r\nThis is an existing function the PR isn't changing (and there's no reason to change it)",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-16T19:37:15Z",
      "diff_hunk" : "@@ -151,7 +159,7 @@ class CMainSignals {\n private:\n     std::unique_ptr<MainSignalsInstance> m_internals;\n \n-    friend void ::RegisterValidationInterface(CValidationInterface*);\n+    friend void ::RegisterSharedValidationInterface(std::shared_ptr<CValidationInterface>);\n     friend void ::UnregisterValidationInterface(CValidationInterface*);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393267054",
      "id" : 393267054,
      "in_reply_to_id" : 393265428,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzI2NzA1NA==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 30,
      "path" : "src/validationinterface.h",
      "position" : 30,
      "pull_request_review_id" : 375526926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-16T19:41:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393267054",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "In #18362 the bug is mostly `horizontalHeader` is nullptr (invalid pointer).\r\nBasically i did not like transfer ownership of wallet to the notification that's not expected to me.",
      "created_at" : "2020-03-16T19:46:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599727503",
      "id" : 599727503,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTcyNzUwMw==",
      "updated_at" : "2020-03-16T19:46:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599727503",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "]> Basically i did not like transfer ownership of wallet to the notification that's not expected to me.\r\n\r\nSure, but if you are already using a shared_ptr to refer to an object some places, it makes sense to use it consistently. Combining shared pointers and raw pointers and asynchronous notifications is a recipe for bugs.",
      "created_at" : "2020-03-16T19:53:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#issuecomment-599730693",
      "id" : 599730693,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18338",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTczMDY5Mw==",
      "updated_at" : "2020-03-16T19:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599730693",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393464732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393464732"
         }
      },
      "author_association" : "NONE",
      "body" : "Where lock is held? If here it's, that's nasty bug.",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-17T06:20:19Z",
      "diff_hunk" : "@@ -137,6 +133,9 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393464732",
      "id" : 393464732,
      "in_reply_to_id" : 393264763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzQ2NDczMg==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 375764667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-17T06:20:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393464732",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393520043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393520043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Where lock is held? If here it's, that's nasty bug.\r\n\r\nRight, I don't think there is a nasty bug now. I think it is good to avoid nasty bugs by not calling BlockUntilSyncedToCurrentChain when it is not necessary.",
      "commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "created_at" : "2020-03-17T08:44:43Z",
      "diff_hunk" : "@@ -137,6 +133,9 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18338#discussion_r393520043",
      "id" : 393520043,
      "in_reply_to_id" : 393264763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzUyMDA0Mw==",
      "original_commit_id" : "73bd96206851aa88db79b8efbc844700630980e1",
      "original_position" : 19,
      "path" : "src/wallet/wallet.cpp",
      "position" : 19,
      "pull_request_review_id" : 375834093,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18338",
      "updated_at" : "2020-03-17T08:44:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393520043",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
