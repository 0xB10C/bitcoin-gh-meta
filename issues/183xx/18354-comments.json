[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18338 (wip: Fix wallet unload race condition by promag)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-03-15T19:12:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#issuecomment-599251772",
      "id" : 599251772,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18354",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTI1MTc3Mg==",
      "updated_at" : "2020-03-15T19:12:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599251772",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Simplify patch, make more fuzzing test\r\n```\r\n#!/bin/bash\r\nwhile [ 1 ]\r\ndo\r\n    src/bitcoin-cli -testnet loadwallet test\r\n    src/bitcoin-cli -testnet unloadwallet test3\r\n    src/bitcoin-cli -testnet loadwallet test2\r\n    src/bitcoin-cli -testnet unloadwallet test\r\n    src/bitcoin-cli -testnet loadwallet test3\r\n    src/bitcoin-cli -testnet unloadwallet test2\r\ndone\r\n```",
      "created_at" : "2020-03-16T13:46:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#issuecomment-599544782",
      "id" : 599544782,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18354",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTU0NDc4Mg==",
      "updated_at" : "2020-03-16T13:46:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599544782",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393055199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393055199"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why's this adding `|| m_are_callbacks_running`? In the case where m_callbacks_pending is empty and m_are_callbacks_running is true, won't ProcessQueue return immediately and the loop below be a busy loop consuming 100% of CPU?\r\n\r\nAlso could use `while (WITH_LOCK(m_cs_callbacks_pending, return ...)) {` instead of a lambda",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T14:17:11Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393055199",
      "id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA1NTE5OQ==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375260070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393055199",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393063319"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393063319"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a partial fix for the bug, not a full fix. While calling BlockUntilSyncedToCurrentChain before reset makes it less likely the wallet pointer will be deleted while still in use, it's still possible for a blockconnected or other notification to be running when wallet.reset() is called below",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T14:24:50Z",
      "diff_hunk" : "@@ -137,6 +135,8 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+    wallet->BlockUntilSyncedToCurrentChain();\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393063319",
      "id" : 393063319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA2MzMxOQ==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/wallet/wallet.cpp",
      "position" : 15,
      "pull_request_review_id" : 375260070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393063319",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393173751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393173751"
         }
      },
      "author_association" : "NONE",
      "body" : "That's guaranteed it https://github.com/bitcoin/bitcoin/pull/18354/commits/16e9578c1ecc3240282e136c378fb0433e775e41#diff-e8d9e22d9683f73a9fb8399be0dab640R93",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T16:59:20Z",
      "diff_hunk" : "@@ -137,6 +135,8 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+    wallet->BlockUntilSyncedToCurrentChain();\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393173751",
      "id" : 393173751,
      "in_reply_to_id" : 393063319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE3Mzc1MQ==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/wallet/wallet.cpp",
      "position" : 15,
      "pull_request_review_id" : 375411624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393173751",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393175374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393175374"
         }
      },
      "author_association" : "NONE",
      "body" : "> Why's this adding || m_are_callbacks_running? In the case where m_callbacks_pending is empty and m_are_callbacks_running is true, won't ProcessQueue return immediately and the loop below be a busy loop consuming 100% of CPU?\r\n\r\nIt's same without `m_are_callbacks_running` i.e. while loop consume a lot of CPU. The change is to ensure notification thread is finish processing callback.",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T17:01:05Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393175374",
      "id" : 393175374,
      "in_reply_to_id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE3NTM3NA==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375413030,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393175374",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393183034"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393183034"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As I understand it, the EmptyQueue call added there (in UnregisterValidationInterface) does nothing if `m_pscheduler->AreThreadsServicingQueue()` is true, which it always is, except during shutdown. So a notification could still be in progress and raw wallet pointer still in use after the UnregisterValidationInterface call and handler.reset() call and wallet.reset() call. Adding the BlockUntilSyncedToCurrentChain right before probably makes this much less unlikely, but not impossible. #18338 is be a more direct, race-free fix for the issue, because it gets rid of the raw pointer and uses shared_ptr for all wallet references.",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T17:10:48Z",
      "diff_hunk" : "@@ -137,6 +135,8 @@ void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n     // Notify the unload intent so that all remaining shared pointers are\n     // released.\n     wallet->NotifyUnload();\n+    wallet->BlockUntilSyncedToCurrentChain();\n+    wallet->m_chain_notifications_handler.reset();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393183034",
      "id" : 393183034,
      "in_reply_to_id" : 393063319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE4MzAzNA==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/wallet/wallet.cpp",
      "position" : 15,
      "pull_request_review_id" : 375420566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393183034",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393193401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393193401"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Why's this adding || m_are_callbacks_running? In the case where m_callbacks_pending is empty and m_are_callbacks_running is true, won't ProcessQueue return immediately and the loop below be a busy loop consuming 100% of CPU?\r\n\r\nOh, you're right. The current code is can busy-loop when the queue non-empty and running is true, though AreThreadsServicingQueue check makes this less likely to happen. I still don't understand why you now want to busy loop in the case where the queue is empty and running is true. Again prefer just using shared_ptr to avoid use-after-free bugs instead of doing more complicated things with the scheduler.",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T17:28:27Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393193401",
      "id" : 393193401,
      "in_reply_to_id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE5MzQwMQ==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375434268,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393193401",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393220993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393220993"
         }
      },
      "author_association" : "NONE",
      "body" : "Got'cha, you're right. I'll investigate for solution.",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T18:11:21Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393220993",
      "id" : 393220993,
      "in_reply_to_id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIyMDk5Mw==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375469306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393220993",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393233993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393233993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Got'cha, you're right. I'll investigate for solution.\r\n\r\nAgain would suggest closing this PR and using #18338 which I think is more consistent and less fragile fix",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T18:34:57Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393233993",
      "id" : 393233993,
      "in_reply_to_id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzMzk5Mw==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375485578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:34:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393233993",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393234040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393234040"
         }
      },
      "author_association" : "NONE",
      "body" : "`AreThreadsServicingQueue` is not needed at all. Its purpose is obsolete in the context.",
      "commit_id" : "65b2983e9a00ed051f7e12faaae674ce20f8e982",
      "created_at" : "2020-03-16T18:35:04Z",
      "diff_hunk" : "@@ -199,13 +199,16 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n }\n \n void SingleThreadedSchedulerClient::EmptyQueue() {\n-    assert(!m_pscheduler->AreThreadsServicingQueue());\n-    bool should_continue = true;\n-    while (should_continue) {\n-        ProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue())\n+        return;\n+\n+    auto shouldProcessQueue = [this]() {\n         LOCK(m_cs_callbacks_pending);\n-        should_continue = !m_callbacks_pending.empty();\n-    }\n+        return !m_callbacks_pending.empty() || m_are_callbacks_running;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#discussion_r393234040",
      "id" : 393234040,
      "in_reply_to_id" : 393055199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzIzNDA0MA==",
      "original_commit_id" : "16e9578c1ecc3240282e136c378fb0433e775e41",
      "original_position" : 15,
      "path" : "src/scheduler.cpp",
      "position" : 15,
      "pull_request_review_id" : 375485646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18354",
      "updated_at" : "2020-03-16T18:35:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/393234040",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Use future instead of raw loop for waiting pending callbacks. It still much matters to me compared to #18338 ",
      "created_at" : "2020-03-17T06:49:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18354#issuecomment-599906008",
      "id" : 599906008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18354",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTkwNjAwOA==",
      "updated_at" : "2020-03-17T06:50:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599906008",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8323581?v=4",
         "events_url" : "https://api.github.com/users/bvbfan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/bvbfan/followers",
         "following_url" : "https://api.github.com/users/bvbfan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/bvbfan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/bvbfan",
         "id" : 8323581,
         "login" : "bvbfan",
         "node_id" : "MDQ6VXNlcjgzMjM1ODE=",
         "organizations_url" : "https://api.github.com/users/bvbfan/orgs",
         "received_events_url" : "https://api.github.com/users/bvbfan/received_events",
         "repos_url" : "https://api.github.com/users/bvbfan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/bvbfan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/bvbfan"
      }
   }
]
