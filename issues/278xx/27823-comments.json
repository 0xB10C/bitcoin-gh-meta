[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27711](https://github.com/bitcoin/bitcoin/pull/27711) (kernel: Remove shutdown from kernel library by TheCharlatan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-06-04T18:55:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1575673596",
      "id" : 1575673596,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d6t78",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575673596/reactions"
      },
      "updated_at" : "2023-06-05T00:05:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575673596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217034392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392"
         }
      },
      "author_association" : "NONE",
      "body" : "Wouldn't it be better to check for `!=` instead for `>`? If the file is corrupt, then the indices might as well suddenly go down.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:27:22Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217034392",
      "id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585IiniY",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461336335,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217034392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that would be incorrect, because there will be multiple indexes for a given height in case of stale blocks / forks.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:32:01Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039090",
      "id" : 1217039090,
      "in_reply_to_id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585Iiory",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461337650,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:32:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358"
         }
      },
      "author_association" : "NONE",
      "body" : "True!",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-04T19:32:23Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1217039358",
      "id" : 1217039358,
      "in_reply_to_id" : 1217034392,
      "line" : 266,
      "node_id" : "PRRC_kwDOABII585Iiov-",
      "original_commit_id" : "fe0006221737023fd66f6fbf37f605670920fe77",
      "original_line" : 266,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 7,
      "pull_request_review_id" : 1461337678,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-04T19:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1217039358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Little disclaimer: It's my first Review for Bitcoin Core. So treat my input with care, I might have no clue what I am talking about.\r\n\r\nWhat I don't like about this change is that previously the user at least had a chance of finding out what's wrong, without debugging the code. Now he won't have any info of what went wrong other than \"Error loading block database\", which can have multiple other reasons. Is there a way for us to communicate this better? Maybe a log? Or can we throw here? The sad thing is that the return seems to be intermangled with none error cases like `ShutdownRequested`.",
      "created_at" : "2023-06-04T19:34:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1575685598",
      "id" : 1575685598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d6w3e",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575685598/reactions"
      },
      "updated_at" : "2023-06-04T19:34:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1575685598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19430475?v=4",
         "events_url" : "https://api.github.com/users/Brotcrunsher/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Brotcrunsher/followers",
         "following_url" : "https://api.github.com/users/Brotcrunsher/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Brotcrunsher/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Brotcrunsher",
         "id" : 19430475,
         "login" : "Brotcrunsher",
         "node_id" : "MDQ6VXNlcjE5NDMwNDc1",
         "organizations_url" : "https://api.github.com/users/Brotcrunsher/orgs",
         "received_events_url" : "https://api.github.com/users/Brotcrunsher/received_events",
         "repos_url" : "https://api.github.com/users/Brotcrunsher/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Brotcrunsher/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Brotcrunsher/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Brotcrunsher"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218054540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Couldn't `vSortedByHeight` contain blocks from different chains at the same height?",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T13:11:23Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218054540",
      "id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585ImgmM",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462508209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T13:11:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218054540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218160139"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you mean with \"different chains\"? `vSortedHeight` could contain blocks with the same height x (forks), but I can't see how these could have made it into the block index without having a predecessor of height x - 1 at the time they were added. Also, these shouldn't make the added check fail.\r\n\r\nI do wonder though if it would be possible / more general to directly check that each block of height > 0 has a predecessor in the chain, instead of doing what the PR currently suggests. I'll look into that.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T14:30:58Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218160139",
      "id" : 1218160139,
      "in_reply_to_id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585Im6YL",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462689403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T14:40:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218160139",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Now he won't have any info of what went wrong other than \"Error loading block database\", which can have multiple other reasons. Is there a way for us to communicate this better? Maybe a log? Or can we throw here?\r\n\r\nThanks! Yes, adding a log seems like a good idea, I'll do that with the next push!",
      "created_at" : "2023-06-05T14:34:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#issuecomment-1576922867",
      "id" : 1576922867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27823",
      "node_id" : "IC_kwDOABII585d_e7z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576922867/reactions"
      },
      "updated_at" : "2023-06-05T14:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1576922867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218214833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> What do you mean with \"different chains\"? `vSortedHeight` could contain blocks with the same height x (forks), but I can't see how these could have made it into the block index without having a predecessor of height x - 1 at the time they were added. Also, these shouldn't make the added check fail.\r\n\r\nyeah ok. nvm. Got confused by the early return (I thought it in the other way around).\r\nThe check will have the previous block at the same height, so `pindex->nHeight > previous_index->nHeight + 1` will be false.\r\n\r\n> I do wonder though if it would be possible / more general to directly check that each block of height > 0 has a predecessor in the chain, instead of doing what the PR currently suggests. I'll look into that.\r\n\r\nWouldn't that be broken if we ever add a parallel headers download process?\r\nWhich IIRC we don't have because they are downloaded from a single peer at time. But if we implement it, we could get orphan block indexes pretty easily.",
      "commit_id" : "6d853ab639a7ddecf7d934c4d1fb48d29eccc27b",
      "created_at" : "2023-06-05T15:09:22Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218214833",
      "id" : 1218214833,
      "in_reply_to_id" : 1218054540,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585InHux",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1462776690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 263,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T15:09:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218214833",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218371741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Wouldn't that be broken if we ever add a parallel headers download process?\r\n> Which IIRC we don't have because they are downloaded from a single peer at time. But if we implement it, we could get orphan block indexes pretty easily.\r\n\r\nYes, but only we had a very naive parallel headers download process. I would imagine that if we ever parallelized headers download, we'd take care not to accept orphaned block indexes into our main block index (for DoS reasons) but would keep those headers in some kind of intermediate buffer until we can connect them.\r\n\r\n`net_processing` makes sure that we only save headers that we connect ([code](https://github.com/bitcoin/bitcoin/blob/f4a8269dfc144cc918570bdb870aa5143a11c1fe/src/net_processing.cpp#L2871-L2881)).",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-05T17:22:11Z",
      "diff_hunk" : "@@ -260,8 +260,11 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) return false; // corruption, non-contiguous block indexes\n+        previous_index = pindex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1218371741",
      "id" : 1218371741,
      "in_reply_to_id" : 1218054540,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585InuCd",
      "original_commit_id" : "0b8b0e3051bb972a878f1855e7d32822b799e1e1",
      "original_line" : 269,
      "original_position" : 8,
      "original_start_line" : 263,
      "path" : "src/node/blockstorage.cpp",
      "position" : null,
      "pull_request_review_id" : 1463032349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-05T17:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218371741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1231516688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've probably confused myself by how I'm checking this, but this doesn't seem to be the error site that is being hit?  The diff below passes.  (Your updated test does indeed fail on master and pass after building this pull, as described in the OP.)\r\n\r\n<details><summary>test diff</summary><p>\r\n\r\n```diff\r\ndiff --git a/test/functional/feature_init.py b/test/functional/feature_init.py\r\nindex 194ba9ed265..38bd3d5db0f 100755\r\n--- a/test/functional/feature_init.py\r\n+++ b/test/functional/feature_init.py\r\n@@ -107,6 +107,12 @@ class InitStressTest(BitcoinTestFramework):\r\n             'blocks/blk*.dat': 'Corrupted block database detected.',\r\n         }\r\n \r\n+        errors_logged = [\r\n+            \"ERROR: LoadBlockIndex: block index is non-contiguous\",\r\n+            \"LevelDB read failure: Corruption: not an sstable (bad magic number)\",\r\n+            \"ReadBlockFromDisk(CBlock&, CBlockIndex*): GetHash() doesn't match index for CBlockIndex\",\r\n+        ]\r\n+\r\n         for file_patt, err_fragment in files_to_delete.items():\r\n             target_files = list(node.chain_path.glob(file_patt))\r\n \r\n@@ -126,6 +132,7 @@ class InitStressTest(BitcoinTestFramework):\r\n             self.stop_node(0)\r\n \r\n         self.log.info(\"Test startup errors after perturbing certain essential files\")\r\n+        i = 0\r\n         for file_patt, err_fragment in files_to_perturb.items():\r\n             shutil.copytree(node.chain_path / \"blocks\", node.chain_path / \"blocks_bak\")\r\n             shutil.copytree(node.chain_path / \"chainstate\", node.chain_path / \"chainstate_bak\")\r\n@@ -139,8 +146,10 @@ class InitStressTest(BitcoinTestFramework):\r\n                     tweaked_contents[50:350] = b'1' * 300\r\n                 with open(target_file, \"wb\") as tf_write:\r\n                     tf_write.write(bytes(tweaked_contents))\r\n\r\n-            start_expecting_error(err_fragment)\r\n+            self.log.info(f\"{i} - {err_fragment} - {errors_logged[i]}\")\r\n+            with node.assert_debug_log([errors_logged[i]]):\r\n+                start_expecting_error(err_fragment)\r\n+            i += 1\r\n \r\n             shutil.rmtree(node.chain_path / \"blocks\")\r\n             shutil.rmtree(node.chain_path / \"chainstate\")\r\n```\r\n</p></details>\r\n",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-15T20:42:47Z",
      "diff_hunk" : "@@ -260,8 +260,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1231516688",
      "id" : 1231516688,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585JZ3QQ",
      "original_commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1482357475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T01:12:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1231516688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1232345298"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The diff below passes.\r\n\r\nWhere does it pass for you?\r\nI tried to apply the diff too, and for me it passes on this branch and fails after removing 04d533781002be054e6f2493f3ab2389135ceec5 (not because the log message isn't found, but because the bitcoin core crashes with the assert before that).\r\nThat is what I would have expected, since the diff adds an additional check for the added log \"ERROR: LoadBlockIndex: block index is non-contiguous\", which is supposed to be hit as a result of the perturbation of the block files.",
      "commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "created_at" : "2023-06-16T14:41:16Z",
      "diff_hunk" : "@@ -260,8 +260,13 @@ bool BlockManager::LoadBlockIndex()\n     std::sort(vSortedByHeight.begin(), vSortedByHeight.end(),\n               CBlockIndexHeightOnlyComparator());\n \n+    CBlockIndex* previous_index{nullptr};\n     for (CBlockIndex* pindex : vSortedByHeight) {\n         if (ShutdownRequested()) return false;\n+        if (previous_index && pindex->nHeight > previous_index->nHeight + 1) {\n+            return error(\"%s: block index is non-contiguous, index of height %d missing\", __func__, previous_index->nHeight + 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27823#discussion_r1232345298",
      "id" : 1232345298,
      "in_reply_to_id" : 1231516688,
      "line" : 267,
      "node_id" : "PRRC_kwDOABII585JdBjS",
      "original_commit_id" : "5352a981de1cc17e231e7336098bf03d600002ff",
      "original_line" : 267,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 8,
      "pull_request_review_id" : 1483668947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27823",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-16T14:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1232345298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
