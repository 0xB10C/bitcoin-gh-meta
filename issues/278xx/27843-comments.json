[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I can't test this right now, as I uninstalled i2pd and now don't seem to be able to re-connect to any of the reseed servers and get connected :(\r\n\r\nA cursory look at the code reads to me that they should behave similarly; although as you state non-I2P connections are done in `AcceptConnection`, the check on open connections is actually in `CreateNodeFromAcceptedSocket`, which is called from both sites, i.e. also from `ThreadI2PAcceptIncoming`:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/fbe48f97dfec3138b06b5f00b75655da0c985008/src/net.cpp#L2117-L2118\r\n\r\nAre the connections stacking up on the i2pd side before they are accepted into bitcoind? How were you measuring accepted connections in `bitcoind`?",
      "created_at" : "2023-06-12T11:21:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1587128836",
      "id" : 1587128836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585emaoE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587128836/reactions"
      },
      "updated_at" : "2023-06-12T11:21:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587128836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The connections will get marked for disconnect in AttemptToEvictConnection but linger until DisconnectNodes is called. I was calling the `getconnectioncount` RPC, so these are connections that bitcoind has. Again not sure if this matters as I couldn't exhaust file descriptors, but figured I would point it out since the original behavior was to:\r\n- connect\r\n- mark for disconnect\r\n- disconnect\r\n\r\nall in the same thread.",
      "created_at" : "2023-06-12T11:40:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1587159335",
      "id" : 1587159335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585emiEn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587159335/reactions"
      },
      "updated_at" : "2023-06-12T11:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1587159335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Crypt-iQ did you see this using the i2pd router? With a debug build, or a regular one? (Also make sure that conf file options like `checkaddrman` and `checkmempool` are off).\r\n\r\nI attempted to reproduce with your script using the Java I2P router on mainnet with a regular build on master (after changing `const char* pszDest = \"tfshhokzifn2g46dc6dxwrwwxwbeo4l5eeepequ52kpvrflm3foq.b32.i2p\";` in your test code to my i2p address).\r\n\r\nWith `-netinfo` I saw an initial spike to 128 connections that quickly went back to normal, then 130 on the second run (with a temporary additional block-relay-only conn).  Given that there were 4 addnode connections, for a ceiling of 125 default max + 4 manual + 1 temporary block-relay-only peer = 129-130 total, this didn't seem too bad. Will have a look with i2pd.\r\n\r\nJust before launching the script\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         52      10       0      62\r\nout        12       1       1      15       3       4\r\ntotal      64      11       1      77\r\n```\r\n\r\nInitial spike to 128 connections\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         51      63       0     114\r\nout        11       1       1      14       2       4\r\ntotal      62      64       1     128\r\n```\r\n\r\nA few seconds later\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         54       8       0      62\r\nout        11       1       1      14       2       4\r\ntotal      65       9       1      76\r\n```\r\n\r\nOn a second run, saw 130\r\n\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         53      62       0     115\r\nout        12       1       1      15       3       4\r\ntotal      65      63       1     130\r\n```\r\n\r\n(Note that the totals are off by one because I have a manual ipv4 connection that is not being counted by -netinfo due to ipv4 not being \"reachable\" in getnetworkinfo; am fixing.)\r\n\r\n- `bitcoin-cli -netinfo` continued to function without an error\r\n- I did see two listening errors in the debug log\r\n\r\n```\r\n2023-06-14T16:02:01.006225Z [i2paccept] [i2p.cpp:257] [Log] [i2p] Error listening: Cannot connect to 127.0.0.1:7656\r\n2023-06-14T16:14:44.067120Z [i2paccept] [i2p.cpp:257] [Log] [i2p] Error listening: Cannot connect to 127.0.0.1:7656\r\n```\r\n\r\nWill look further with i2pd + mitigation.",
      "created_at" : "2023-06-14T16:38:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591624983",
      "id" : 1591624983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e3kUX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591624983/reactions"
      },
      "updated_at" : "2023-06-14T17:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591624983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I used the default-install i2p from here: https://geti2p.net/en/ and no extra bitcoind options. I also ran the script in multiple terminals to make even more connections at a time",
      "created_at" : "2023-06-14T17:33:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591715098",
      "id" : 1591715098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e36Ua",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591715098/reactions"
      },
      "updated_at" : "2023-06-14T17:33:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591715098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> 2023-06-14T16:14:44.067120Z [i2paccept] [i2p.cpp:257] [Log] [i2p] Error listening: Cannot connect to 127.0.0.1:7656\r\n\r\nI experienced two issues that this log line might be related to:\r\n- the i2p SAM bridge crashed due to OOM\r\n- the number of ephemeral ports were exhausted for connections with `127.0.0.1:7656` (may be worth checking the output of `netstat -a | grep TCP`",
      "created_at" : "2023-06-14T17:49:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591732934",
      "id" : 1591732934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e3-rG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591732934/reactions"
      },
      "updated_at" : "2023-06-14T17:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591732934",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, we both tested with the same router.\r\n\r\nTried this time with i2pd (latest stable 2.48.0). I saw a similar max number of connections, except that i2pd then crashed and I had to restart it manually.\r\n\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         19      98       0     117\r\nout        10       2       1      14       2       4\r\ntotal      29     100       1     131\r\n```\r\n",
      "created_at" : "2023-06-14T18:30:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591786952",
      "id" : 1591786952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e4L3I",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591786952/reactions"
      },
      "updated_at" : "2023-06-14T18:30:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591786952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I also ran the script in multiple terminals to make even more connections at a time\r\n\r\nRunning it in two terminals got the race to happen clearly.  Then i2pd crashed again.\r\n\r\n```\r\n        onion     i2p   cjdns   total   block  manual\r\nin         21     117       0     138\r\nout        11       1       1      14       2       4\r\ntotal      32     118       1     152\r\n```\r\n",
      "created_at" : "2023-06-14T18:34:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591791353",
      "id" : 1591791353,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e4M75",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591791353/reactions"
      },
      "updated_at" : "2023-06-14T18:34:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591791353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW I wasn't able to crash i2pd or get the `bitcoin-cli` error due to ephemeral port exhaustion when the scripts ran on a separate machine, but was still able to get the high connection count.",
      "created_at" : "2023-06-14T18:39:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591797479",
      "id" : 1591797479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e4Obn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591797479/reactions"
      },
      "updated_at" : "2023-06-14T18:39:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591797479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "That seems good, if we can just worry about mitigating the connection count race. (Nice find!)",
      "created_at" : "2023-06-14T18:44:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1591803288",
      "id" : 1591803288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e4P2Y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591803288/reactions"
      },
      "updated_at" : "2023-06-14T18:44:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1591803288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@Crypt-iQ would you be willing to re-test with the rather crude patch on this branch: https://github.com/bitcoin/bitcoin/compare/master...willcl-ark:bitcoin:27843-i2p-thread It just adds another `DisconnectNodes()` (and `NotifyNumConnectionsChanged()`) call to the I2P thread. I am still battling to do an initial sync of i2pd still after wiping my computer recently so I can't test myself :(\r\n\r\nYou should be able to fetch only the single branch with: `git remote add -t 27843-i2p-thread willcl-ark https://github.com/willcl-ark/bitcoin.git`  \r\nAnd then check out the branch as normal: `git checkout 27843-i2p-thread`",
      "created_at" : "2023-06-15T13:19:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1593044695",
      "id" : 1593044695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e8-7X",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593044695/reactions"
      },
      "updated_at" : "2023-06-15T13:19:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593044695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Sure thing @willcl-ark ",
      "created_at" : "2023-06-15T13:28:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1593065348",
      "id" : 1593065348,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e9D-E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593065348/reactions"
      },
      "updated_at" : "2023-06-15T13:28:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593065348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that patch will race on `m_disconnected_nodes` if both threads are calling it simultaneously because `m_disconnected_nodes.remove(...)` isn't covered by the `m_nodes_mutex`. I also think both threads could call `m_disconnected_nodes.remove(...)` on the same element",
      "created_at" : "2023-06-15T13:50:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1593111318",
      "id" : 1593111318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585e9PMW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593111318/reactions"
      },
      "updated_at" : "2023-06-15T14:12:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1593111318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh right. I added a mutex on `DisconnectNodes()` to pretect against that.\r\n\r\nI'm not planning on opening these changes as a pull here (at least not in their current ill-thought-out state), but am curious to know if the updated branch does indeed fix the race you observed?",
      "created_at" : "2023-06-16T12:07:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1594576001",
      "id" : 1594576001,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585fC0yB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1594576001/reactions"
      },
      "updated_at" : "2023-06-16T12:07:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1594576001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Ich auch?",
      "created_at" : "2023-06-16T12:16:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1594585836",
      "id" : 1594585836,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585fC3Ls",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1594585836/reactions"
      },
      "updated_at" : "2023-06-16T12:16:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1594585836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85792632?v=4",
         "events_url" : "https://api.github.com/users/Dadudidas/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Dadudidas/followers",
         "following_url" : "https://api.github.com/users/Dadudidas/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Dadudidas/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Dadudidas",
         "id" : 85792632,
         "login" : "Dadudidas",
         "node_id" : "MDQ6VXNlcjg1NzkyNjMy",
         "organizations_url" : "https://api.github.com/users/Dadudidas/orgs",
         "received_events_url" : "https://api.github.com/users/Dadudidas/received_events",
         "repos_url" : "https://api.github.com/users/Dadudidas/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Dadudidas/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Dadudidas/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Dadudidas"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The patch fixes it @willcl-ark, the number of conns evens out at 114",
      "created_at" : "2023-06-17T03:16:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1595597141",
      "id" : 1595597141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585fGuFV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595597141/reactions"
      },
      "updated_at" : "2023-06-17T03:16:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1595597141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "ok",
      "created_at" : "2023-07-01T08:57:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27843#issuecomment-1615739130",
      "id" : 1615739130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27843",
      "node_id" : "IC_kwDOABII585gTjj6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1615739130/reactions"
      },
      "updated_at" : "2023-07-01T08:57:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1615739130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/52573111?v=4",
         "events_url" : "https://api.github.com/users/tuanggo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tuanggo/followers",
         "following_url" : "https://api.github.com/users/tuanggo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tuanggo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tuanggo",
         "id" : 52573111,
         "login" : "tuanggo",
         "node_id" : "MDQ6VXNlcjUyNTczMTEx",
         "organizations_url" : "https://api.github.com/users/tuanggo/orgs",
         "received_events_url" : "https://api.github.com/users/tuanggo/received_events",
         "repos_url" : "https://api.github.com/users/tuanggo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tuanggo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tuanggo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tuanggo"
      }
   }
]
