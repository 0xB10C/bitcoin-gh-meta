[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#25380](https://github.com/bitcoin/bitcoin/pull/25380) (Detect and ignore transactions that were CPFP'd in the fee estimator by darosior)\n* [#10443](https://github.com/bitcoin/bitcoin/pull/10443) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-10T22:17:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#issuecomment-1542881490",
      "id" : 1542881490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27622",
      "node_id" : "IC_kwDOABII585b9oDS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542881490/reactions"
      },
      "updated_at" : "2023-05-11T04:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542881490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "cc @instagibbs @TheBlueMatt ",
      "created_at" : "2023-05-11T09:27:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#issuecomment-1543653619",
      "id" : 1543653619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27622",
      "node_id" : "IC_kwDOABII585cAkjz",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543653619/reactions"
      },
      "updated_at" : "2023-05-11T09:27:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543653619",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191301314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191301314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's a bit strange for policy/fees to have a dependency on scheduler. Maybe register `FlushFeeEstimates()` with the scheduler within `AppInitMain()` instead?",
      "commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "created_at" : "2023-05-11T14:51:02Z",
      "diff_hunk" : "@@ -12,6 +12,7 @@\n #include <policy/feerate.h>\n #include <primitives/transaction.h>\n #include <random.h>\n+#include <scheduler.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191301314",
      "id" : 1191301314,
      "line" : 15,
      "node_id" : "PRRC_kwDOABII585HAdDC",
      "original_commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "original_line" : 15,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/policy/fees.cpp",
      "position" : 4,
      "pull_request_review_id" : 1422800079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191301314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T14:52:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191301314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191350003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191350003"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit (feel free to ignore): An alternative to adding a function here would be to call the already existing `Ticks<std::chrono::hours>(a)` over `count_hours(a)`, but either seems fine.",
      "commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "created_at" : "2023-05-11T15:24:51Z",
      "diff_hunk" : "@@ -53,6 +53,7 @@ constexpr auto TicksSinceEpoch(Timepoint t)\n {\n     return Ticks<Duration>(t.time_since_epoch());\n }\n+constexpr int64_t count_hours(std::chrono::hours t) { return t.count(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191350003",
      "id" : 1191350003,
      "line" : 56,
      "node_id" : "PRRC_kwDOABII585HAo7z",
      "original_commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "original_line" : 56,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/util/time.h",
      "position" : 4,
      "pull_request_review_id" : 1422877741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191350003/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191350003",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191352778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191352778"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \r\n\r\n```suggestion\r\n        fee_dat = self.nodes[0].chain_path / \"fee_estimates.dat\"\r\n```",
      "commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "created_at" : "2023-05-11T15:26:52Z",
      "diff_hunk" : "@@ -290,6 +291,38 @@ def sanity_check_rbf_estimates(self, utxos):\n         est_feerate = node.estimatesmartfee(2)[\"feerate\"]\n         assert_equal(est_feerate, high_feerate_kvb)\n \n+    def test_old_fee_estimate_file(self):\n+        # Get the initial fee rate while node is running\n+        fee_rate = self.nodes[0].estimatesmartfee(1)[\"feerate\"]\n+\n+        # Restart node to ensure fee_estimate.dat file is read\n+        self.stop_node(0)\n+        self.start_node(0)\n+        assert_equal(self.nodes[0].estimatesmartfee(1)[\"feerate\"], fee_rate)\n+\n+        fee_dat = os.path.join(self.nodes[0].datadir, self.chain, \"fee_estimates.dat\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191352778",
      "id" : 1191352778,
      "line" : 303,
      "node_id" : "PRRC_kwDOABII585HApnK",
      "original_commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "original_line" : 303,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/feature_fee_estimation.py",
      "position" : 21,
      "pull_request_review_id" : 1422877741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191352778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191352778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191357213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I am not a fan of uninterruptible sleep in tests. `assert_debug_log` can be used to wait, if you supply a timeout argument (or rely on the default timeout)",
      "commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "created_at" : "2023-05-11T15:30:12Z",
      "diff_hunk" : "@@ -290,6 +291,38 @@ def sanity_check_rbf_estimates(self, utxos):\n         est_feerate = node.estimatesmartfee(2)[\"feerate\"]\n         assert_equal(est_feerate, high_feerate_kvb)\n \n+    def test_old_fee_estimate_file(self):\n+        # Get the initial fee rate while node is running\n+        fee_rate = self.nodes[0].estimatesmartfee(1)[\"feerate\"]\n+\n+        # Restart node to ensure fee_estimate.dat file is read\n+        self.stop_node(0)\n+        self.start_node(0)\n+        assert_equal(self.nodes[0].estimatesmartfee(1)[\"feerate\"], fee_rate)\n+\n+        fee_dat = os.path.join(self.nodes[0].datadir, self.chain, \"fee_estimates.dat\")\n+\n+        # Stop the node and backdate the fee_estimates.dat file for 13 hours\n+        self.stop_node(0)\n+        hour = 60 * 60\n+        last_modified_time = time.time() - 13 * hour\n+        os.utime(fee_dat, (last_modified_time, last_modified_time))\n+\n+        # Start node and ensure the fee_estimates.dat file was not read\n+        self.start_node(0)\n+        assert_equal(self.nodes[0].estimatesmartfee(1)[\"errors\"], [\"Insufficient data or no feerate found\"])\n+\n+\n+    def test_estimate_dat_is_flushed_periodically(self):\n+            # Check if the string \"Flushed fee estimates to fee_estimates.dat.\" is present in the debug log file.\n+            # If it is, it indicates that fee estimates have been successfully flushed to disk.\n+            with self.nodes[0].assert_debug_log(expected_msgs=[\"Flushed fee estimates to fee_estimates.dat.\"]):\n+                # Mock the scheduler for an hour, sleep for a short period to allow the flush to finish\n+                hour = 3600\n+                self.nodes[0].mockscheduler(hour)\n+                time.sleep(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27622#discussion_r1191357213",
      "id" : 1191357213,
      "line" : 323,
      "node_id" : "PRRC_kwDOABII585HAqsd",
      "original_commit_id" : "a2ad5e475f318552c50bcc8bb966c4841d7ef8b4",
      "original_line" : 323,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "test/functional/feature_fee_estimation.py",
      "position" : 41,
      "pull_request_review_id" : 1422877741,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27622",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:32:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
