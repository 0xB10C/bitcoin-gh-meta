[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#26969](https://github.com/bitcoin/bitcoin/pull/26969) (net, refactor: net_processing, add `ProcessCompactBlockTxns` by brunoerg)\n* [#26812](https://github.com/bitcoin/bitcoin/pull/26812) (test: add end-to-end tests for CConnman and PeerManager by vasild)\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-11T14:05:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1544049487",
      "id" : 1544049487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cCFNP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544049487/reactions"
      },
      "updated_at" : "2023-05-12T13:46:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544049487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191251631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would this be better as a `map<uint256, map<NodeId, list<>::iterator>>` ? Seems like it'd make some of the `FIXME`s easier.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:24:31Z",
      "diff_hunk" : "@@ -901,7 +901,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    typedef std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;\n+    typedef std::multimap<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191251631",
      "id" : 1191251631,
      "line" : 904,
      "node_id" : "PRRC_kwDOABII585HAQ6v",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 904,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191307770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this case is (mostly) for when a non-high-bandwidth peer tells us about a block, we request it via a compact block, and then we get a different block from some other peer, UpdateTip to that, and only afterwards see the CMPCTBLOCK response from the original peer. But now that response is probably useless, so replace it with a GETDATA.\r\n\r\nI wonder if that might be better expressed as: `if (in_flight_same_peer && pindex->pprev != ActiveChain().Tip())` ?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:55:20Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191307770",
      "id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HAen6",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191313364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be better to name this `requested_block_from_this_peer` ? (I think for new code we prefer `bool x{false};` so we get errors if we're accidently narrowing values?)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:58:03Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191313364",
      "id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAf_U",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191320979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`already_in_flight == 0 || (already_in_flight == 1 && in_flight_same_peer)` ?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:03:31Z",
      "diff_hunk" : "@@ -4297,6 +4297,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n             range_flight.first++;\n         }\n+        bool first_in_flight = !already_in_flight || in_flight_same_peer;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191320979",
      "id" : 1191320979,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAh2T",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4300,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191323390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Test the bool first?)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:05:16Z",
      "diff_hunk" : "@@ -4357,8 +4363,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large\n+                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191323390",
      "id" : 1191323390,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAib-",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4368,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191357478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Out of the last 612 compact blocks my node's reconstructed that required requesting transactions, 277 needed 10 or fewer (45%), 441 needed 50 or fewer (72%), 488 needed 100 or fewer (80%), 548 needed 500 or fewer (90%). I'd probably prefer 50 or 100 than 10, I guess?\r\n\r\n(In simpler times, 1086/1162 (93%) need 10 or fewer, 1140/1162 (98%) needed 50 or fewer, 1144/1162 (98.5%) needed 100 or fewer. Again, I'm not including blocks that requested 0 txs in those denominators)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:30:25Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191357478",
      "id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HAqwm",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191369251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This logic is different to the previous `first_in_flight`; probably should be the same?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:39:18Z",
      "diff_hunk" : "@@ -4452,13 +4465,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             LOCK(cs_main);\n \n             bool expected_blocktxn = false;\n+            bool first_in_flight = true;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n                     expected_blocktxn = true;\n                     break;\n                 }\n+                first_in_flight = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191369251",
      "id" : 1191369251,
      "line" : 4478,
      "node_id" : "PRRC_kwDOABII585HAtoj",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4478,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 273,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191418745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds right, I'll sit on this for a bit",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:17:34Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191418745",
      "id" : 1191418745,
      "in_reply_to_id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HA5t5",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1422991579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:17:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191426977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use `pfrom.m_bip152_highbandwidth_to`?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:24:43Z",
      "diff_hunk" : "@@ -4364,8 +4364,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     fProcessBLOCKTXN = true;\n                 } else {\n                     // We will try to round-trip any compact blocks we get on failure,\n-                    // as long as it's first, or not too large\n-                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {\n+                    // as long as it's first, or not too large, and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    auto hb_peer = std::find(lNodesAnnouncingHeaderAndIDs.begin(), lNodesAnnouncingHeaderAndIDs.end(), pfrom.GetId());\n+                    if ((hb_peer != lNodesAnnouncingHeaderAndIDs.end() && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191426977",
      "id" : 1191426977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HA7uh",
      "original_commit_id" : "df1218b447aabfc54f86406d4813057df1ddf216",
      "original_line" : 4370,
      "original_position" : 9,
      "original_start_line" : 4369,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423003852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:24:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191435827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what if we just removed the limit, since it's not much of a protection, especially if the missing 10 txns are *nscriptions",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:32:57Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191435827",
      "id" : 1191435827,
      "in_reply_to_id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HA94z",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1423017870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191441529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably better to defer it as an unrelated change anyway?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:38:28Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191441529",
      "id" : 1191441529,
      "in_reply_to_id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HA_R5",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1423026354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "don't love your name suggestion; changed the initialization though",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:46:14Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449571",
      "id" : 1191449571,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBBPj",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423038359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the limit's fine; when you start up with an empty mempool, you'll be requesting most of the transactions in the block because your mempool's empty, and there's no need to do that three times in parallel. Could perhaps have the limit work the other way: if you've already got N txs and need K txs, and `0 < K <= N/4 + 10`; then if the block just has ten 100kvB txs, you won't request them multiple times.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:46:16Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449589",
      "id" : 1191449589,
      "in_reply_to_id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HBBP1",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1423038391,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:46:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191458103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:54:47Z",
      "diff_hunk" : "@@ -4364,8 +4364,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     fProcessBLOCKTXN = true;\n                 } else {\n                     // We will try to round-trip any compact blocks we get on failure,\n-                    // as long as it's first, or not too large\n-                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {\n+                    // as long as it's first, or not too large, and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    auto hb_peer = std::find(lNodesAnnouncingHeaderAndIDs.begin(), lNodesAnnouncingHeaderAndIDs.end(), pfrom.GetId());\n+                    if ((hb_peer != lNodesAnnouncingHeaderAndIDs.end() && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191458103",
      "id" : 1191458103,
      "in_reply_to_id" : 1191426977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBDU3",
      "original_commit_id" : "df1218b447aabfc54f86406d4813057df1ddf216",
      "original_line" : 4370,
      "original_position" : 9,
      "original_start_line" : 4369,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423054145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191480873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Let me rephrase. What I meant was that `in_flight_same_peer` confused me: \"we just received the block from this peer, of course it was in flight, how else would it get to us?\". But what the bool is actually telling us is that we had deliberately asked this peer for this block, it wasn't just spontaneously sent to us.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T17:16:56Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191480873",
      "id" : 1191480873,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBI4p",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423093314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T17:16:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191523726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Imo, it doesn't seem worthwhile to have the limit:\r\n* the good case (small K) should be far more common than the bad one (large K)\r\n* the limit makes relay of blocks with large K less reliable w.r.t to stalling (reduces to what we have now)\r\n* the limit adds code complexity and a maintenance burden. 10 is not a good value according to your data and if #10984 had been merged then we would need to re-evaluate now. Who's to say this won't change again.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:01:25Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191523726",
      "id" : 1191523726,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HBTWO",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1423160189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191541721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "after attempting the change, I think that would violate https://github.com/bitcoin/bitcoin/pull/27626/commits/e424dcba60e61f014b19a3e2f59238ca3b91f3db#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R1394 which requires insertion ordering to know which is the stalling peer.\r\n\r\ntotally forgot about the FIXME...",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:21:34Z",
      "diff_hunk" : "@@ -901,7 +901,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    typedef std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;\n+    typedef std::multimap<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191541721",
      "id" : 1191541721,
      "in_reply_to_id" : 1191251631,
      "line" : 905,
      "node_id" : "PRRC_kwDOABII585HBXvZ",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 905,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1423187928,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:21:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191560489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, I can see that and how it reads cleaner, changed",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:42:17Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191560489",
      "id" : 1191560489,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBcUp",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423217956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:42:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191569820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, cleaner thank you",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:51:29Z",
      "diff_hunk" : "@@ -4452,13 +4465,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             LOCK(cs_main);\n \n             bool expected_blocktxn = false;\n+            bool first_in_flight = true;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n                     expected_blocktxn = true;\n                     break;\n                 }\n+                first_in_flight = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191569820",
      "id" : 1191569820,
      "in_reply_to_id" : 1191369251,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBemc",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4487,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423234162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:51:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191650786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "if the issue is during warmup, that's a pretty small window, and typically won't actually do parallel fetching, 3 seems rare even when warmed up with limit of 10. I'll gather some more stats on that front, seeing how many parallel blocks are initialized.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T20:19:33Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191650786",
      "id" : 1191650786,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HByXi",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1423375759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T20:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192138027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This could be a `else if` of the outer if statement. That would avoid the nesting here.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-12T09:28:46Z",
      "diff_hunk" : "@@ -4342,8 +4372,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    if (first_in_flight ||\n+                        (pfrom.m_bip152_highbandwidth_to && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT)) {\n+                        req.blockhash = pindex->GetBlockHash();\n+                        m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192138027",
      "id" : 1192138027,
      "line" : 4381,
      "node_id" : "PRRC_kwDOABII585HDpUr",
      "original_commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "original_line" : 4381,
      "original_position" : 249,
      "original_start_line" : 4378,
      "path" : "src/net_processing.cpp",
      "position" : 249,
      "pull_request_review_id" : 1424128109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4378,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-12T09:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192388557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "03e8c7046776890a74a29b343f4e0355748945c3",
      "created_at" : "2023-05-12T13:35:28Z",
      "diff_hunk" : "@@ -4342,8 +4372,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    if (first_in_flight ||\n+                        (pfrom.m_bip152_highbandwidth_to && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT)) {\n+                        req.blockhash = pindex->GetBlockHash();\n+                        m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192388557",
      "id" : 1192388557,
      "in_reply_to_id" : 1192138027,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HEmfN",
      "original_commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "original_line" : 4381,
      "original_position" : 249,
      "original_start_line" : 4378,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1424529964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-12T13:35:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll clean up history later when we're closer to ACKs",
      "created_at" : "2023-05-12T13:38:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1545766429",
      "id" : 1545766429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cIoYd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545766429/reactions"
      },
      "updated_at" : "2023-05-12T13:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545766429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192406738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This \"warmup\" should really only be an issue after we've seen new blocks from 3+ peers since we don't persist hb peers across restarts and we have to wait for `MaybeSetPeerAsAnnouncingHeaderAndIDs` to be called on multiple unique peers. I now suspect the warmup period handles itself? My logs show 4+ blocks per node with only one partial block.",
      "commit_id" : "03e8c7046776890a74a29b343f4e0355748945c3",
      "created_at" : "2023-05-12T13:50:40Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192406738",
      "id" : 1192406738,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HEq7S",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1424559087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T13:50:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In contrast to previous effort, it will not help if subsequent peers send block headers only\r\n\r\nCan you elaborate on this? Are you saying that falling back to full block download is pointless?\r\n",
      "created_at" : "2023-05-12T17:47:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546082245",
      "id" : 1546082245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cJ1fF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546082245/reactions"
      },
      "updated_at" : "2023-05-12T17:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546082245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors Basically previous efforts would allow the peer to send a header, not a compact block, and we would fire off an additional `getdata` for the compact block. See this block of code: https://github.com/bitcoin/bitcoin/pull/10984/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R1411\r\n\r\nIMO it's unlikely to make an impact, as high-bandwidth peers are already demonstrably fast, and allows us to control better who takes up the additional slots.",
      "created_at" : "2023-05-12T17:56:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546091957",
      "id" : 1546091957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cJ321",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546091957/reactions"
      },
      "updated_at" : "2023-05-12T17:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546091957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So that earlier attempt would solicit a compact block from a (BIP 152) low-bandwidth mode peer, in response to it announcing a header. That's similar to what we already do in `HeadersDirectFetchBlocks`, but allowing more than 1 in transit?\r\n\r\nWhereas in this PR we focus on the high-bandwidth mode peers, which are [allowed to send us](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki#intended-protocol-flow) a `cmpctblock` message straight away (rather than waiting for us to ask). Right now we can only have one `cmpctblock` -> `getblocktxn` -> `blocktxn` \"session\" in progress. This PR makes that 3.\r\n\r\nThis approach seems fine, but the other attempts were never merged, which is why I am confused by the \"it will not help\" phrase. Are you saying these earlier attempts failed in some experiment, are they useless in general or is this new approach just better (and less complex?)?",
      "created_at" : "2023-05-12T19:13:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546170005",
      "id" : 1546170005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cKK6V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546170005/reactions"
      },
      "updated_at" : "2023-05-12T19:13:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546170005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This PR makes that 3.\r\n\r\nMakes it 3 parallel block downloads, first can be of any kind, the 2nd and 3rd must be compact block announcements from high badwidth peers. \r\n\r\n> I am confused by the \"it will not help\" phrase\r\n\r\nThis PR does not take advantage of low-bandwidth compact block peers message patterns, in other words.",
      "created_at" : "2023-05-12T19:17:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546173220",
      "id" : 1546173220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cKLsk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546173220/reactions"
      },
      "updated_at" : "2023-05-12T19:17:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546173220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
