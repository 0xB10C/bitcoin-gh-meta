[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\nA summary of reviews will appear here.\n",
      "created_at" : "2023-05-12T08:03:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27636#issuecomment-1545342843",
      "id" : 1545342843,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27636",
      "node_id" : "IC_kwDOABII585cHA97",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545342843/reactions"
      },
      "updated_at" : "2023-05-12T08:03:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545342843",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192264695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192264695"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems like it would be more natural to write this as:\r\n\r\n```c++\r\nclass ChainstateNotifications\r\n{\r\n    virtual void NotifyBlockTip(SynchronizationState state, CBlockIndex* index) {}\r\n    virtual void NotifyHeaderTip(SynchronizationState state, int64_t height, int64_t timestamp, bool presync) {}\r\n    virtual void ShowProgress(const std::string& title, int nProgress, bool resume_possible) {}\r\n    virtual void DoWarning(const bilingual_str& warning) {}\r\n    virtual void InitError(const bilingual_str& user_message) {}\r\n};\r\n```",
      "commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "created_at" : "2023-05-12T11:49:24Z",
      "diff_hunk" : "@@ -15,13 +15,29 @@\n #include <functional>\n #include <optional>\n \n+class CBlockIndex;\n class CChainParams;\n+enum class SynchronizationState;\n \n static constexpr bool DEFAULT_CHECKPOINTS_ENABLED{true};\n static constexpr auto DEFAULT_MAX_TIP_AGE{24h};\n \n namespace kernel {\n \n+/**\n+ * A struct containing callback functions to issue notifications from the\n+ * `ChainstateManager`. More ergonomically referred to as\n+ * `ChainstateManager::NotificationCallbacks` due to the using-declaration in\n+ * `ChainstateManager`.\n+ */\n+struct ChainstateManagerNotificationCallbacks {\n+    const std::function<void(SynchronizationState state, CBlockIndex* index)> notify_block_tip;\n+    const std::function<void(SynchronizationState state, int64_t height, int64_t timestamp, bool presync)> notify_header_tip;\n+    const std::function<void(const std::string& title, int nProgress, bool resume_possible)> show_progress;\n+    const std::function<void(const bilingual_str& warning)> do_warning;\n+    const std::function<void(const bilingual_str& user_message)> init_error;\n+};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192264695",
      "id" : 1192264695,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII585HEIP3",
      "original_commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "original_line" : 39,
      "original_position" : 25,
      "original_start_line" : 33,
      "path" : "src/kernel/chainstatemanager_opts.h",
      "position" : 25,
      "pull_request_review_id" : 1424328154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192264695/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 33,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-12T12:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192264695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192290165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192290165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "These new AbortNode calls seem more awkward. And they aren't really future-proof since `AbortNode` calls the global `StartShutdown` function which is specific to the node and will have to be changed for the kernel. Also the name \"abort node\" doesn't make sense in the kernel context if the kernel application isn't a bitcoin node. Would suggest adding a `FatalError` notification to complement `InitError` in `ChainstateNotifications` class suggested previously:\r\n\r\n```c++\r\nclass ChainstateNotifications\r\n{\r\n    ...\r\n    virtual void FatalError(const bilingual_str& error_message, const bilingual_str abort_message={}) {}\r\n};\r\n```\r\n\r\nOther kernel clients could customize `FatalError` but the node implementation would call `SetMiscWarning(error_message)` and `InitError(abort_message or \"A fatal internal error occurred, see debug.log for details\")` and `StartShutdown()` like `AbortNode` function does currently, to keep behavior unchanged.",
      "commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "created_at" : "2023-05-12T12:18:15Z",
      "diff_hunk" : "@@ -527,7 +527,7 @@ void BlockManager::FlushUndoFile(int block_file, bool finalize)\n {\n     FlatFilePos undo_pos_old(block_file, m_blockfile_info[block_file].nUndoSize);\n     if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n-        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\", m_opts.init_error_callback);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192290165",
      "id" : 1192290165,
      "line" : 530,
      "node_id" : "PRRC_kwDOABII585HEOd1",
      "original_commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "original_line" : 530,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/blockstorage.cpp",
      "position" : 16,
      "pull_request_review_id" : 1424328154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192290165/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T12:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192290165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192295222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192295222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think I would tie these notifications to the ChainStateManager class specifically as they really make sense anywhere in validation code. Would suggest changing `chainstatemanager_notifications` to  `chainstate_notifications`, or `validation_notifications` and dropping the \"manager\" in these places",
      "commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "created_at" : "2023-05-12T12:23:32Z",
      "diff_hunk" : "@@ -0,0 +1,14 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_CHAINSTATEMANAGER_NOTIFICATIONS_H\n+#define BITCOIN_NODE_CHAINSTATEMANAGER_NOTIFICATIONS_H\n+\n+#include <kernel/chainstatemanager_opts.h>\n+\n+namespace node {\n+kernel::ChainstateManagerNotificationCallbacks DefaultChainstateManagerNotifications();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192295222",
      "id" : 1192295222,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII585HEPs2",
      "original_commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "original_line" : 11,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/node/chainstatemanager_notifications.h",
      "position" : 11,
      "pull_request_review_id" : 1424328154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192295222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T12:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192295222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192715879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192715879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would you also prefer passing this `validation_notifications` class to the other users of these notification functions, even if they only use one of the methods?",
      "commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "created_at" : "2023-05-12T19:08:27Z",
      "diff_hunk" : "@@ -0,0 +1,14 @@\n+// Copyright (c) 2023 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_CHAINSTATEMANAGER_NOTIFICATIONS_H\n+#define BITCOIN_NODE_CHAINSTATEMANAGER_NOTIFICATIONS_H\n+\n+#include <kernel/chainstatemanager_opts.h>\n+\n+namespace node {\n+kernel::ChainstateManagerNotificationCallbacks DefaultChainstateManagerNotifications();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27636#discussion_r1192715879",
      "id" : 1192715879,
      "in_reply_to_id" : 1192295222,
      "line" : 11,
      "node_id" : "PRRC_kwDOABII585HF2Zn",
      "original_commit_id" : "0b159b9256c214a289135ca7bfaf70e48ab28e20",
      "original_line" : 11,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/node/chainstatemanager_notifications.h",
      "position" : 11,
      "pull_request_review_id" : 1425030271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27636",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192715879/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T19:08:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192715879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8421793?v=4",
         "events_url" : "https://api.github.com/users/TheCharlatan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheCharlatan/followers",
         "following_url" : "https://api.github.com/users/TheCharlatan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheCharlatan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheCharlatan",
         "id" : 8421793,
         "login" : "TheCharlatan",
         "node_id" : "MDQ6VXNlcjg0MjE3OTM=",
         "organizations_url" : "https://api.github.com/users/TheCharlatan/orgs",
         "received_events_url" : "https://api.github.com/users/TheCharlatan/received_events",
         "repos_url" : "https://api.github.com/users/TheCharlatan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheCharlatan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheCharlatan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheCharlatan"
      }
   }
]
