[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/27602#pullrequestreview-1418933543), [willcl-ark](https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-05-08T21:23:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539072919",
      "id" : 1539072919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGOX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919/reactions"
      },
      "updated_at" : "2023-05-10T20:00:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Motivation: this fix was discussed over IRC by @willcl-ark @glozow @sipa and @darosior \r\n\r\nhttps://gnusha.org/bitcoin-core-dev/2023-05-02.log",
      "created_at" : "2023-05-08T21:24:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539074312",
      "id" : 1539074312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGkI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312/reactions"
      },
      "updated_at" : "2023-05-08T21:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't this just change the fingerprinting vector from `GETDATA txid` to `FILTERCLEAR; FILTERADD whatever; MEMPOOL` ? In which case we're just as easily fingerprinted, but we spend more cpu while being fingerprinted?",
      "commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "created_at" : "2023-05-09T08:11:42Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489",
      "id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G09QB",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 1418112808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T08:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852"
         }
      },
      "author_association" : "NONE",
      "body" : "Do you mean keep adding what you're interested in into the filter so it triggers an `INV` from the node and, therefore, we can request it (or, similarly, keep resetting the filter and just add the one single transaction that we want to probe)? If so, isn't that equivalent to having no filter?\r\n\r\nI think in both of the aforementioned cases (which boil down to the same logic if I'm not mistaken) the patch prevents the attacker from requesting unannounced transactions straight-away, they will have to wait for `m_next_inv_send_time` to go off.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:01:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852",
      "id" : 1188745852,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G2tJ8",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1418860317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:01:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_last_mempool_req` is now unused and can be removed completely? Also, it might be good to not touch the `return` here when there is no reason, to avoid code churn and review burden.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:13:52Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337",
      "id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2xbJ",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418888189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:13:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722"
         }
      },
      "author_association" : "NONE",
      "body" : "> m_last_mempool_req is now unused and can be removed completely?\r\n\r\nLooks like it\r\n\r\n> Also, it might be good to not touch the return here when there is no reason, to avoid code churn and review burden.\r\n\r\nI thought the only reason why this was split into two lines is that it was a bit too long (?), I tried to follow the same approach as in `L2267` and, while I think it looks more compact the way it is now, I don't have a strong opinion about on styling atm, so I'm happy to amend it if there is consensus that this is best.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T18:00:47Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722",
      "id" : 1188956722,
      "in_reply_to_id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G3goy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419184844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T18:01:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Addressed comments by @MarcoFalke and fixed a couple of logs from the tests",
      "created_at" : "2023-05-09T19:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1540782565",
      "id" : 1540782565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b1nnl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565/reactions"
      },
      "updated_at" : "2023-05-09T19:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I see what you mean. That makes sense.\r\n\r\nNext point on those lines though: adding many things to `m_recently_announced_invs` can overflow the bloom filter, either causing false positives (leading to privacy bugs), or since it's a rolling bloom filter, causing overflow leading to false negatives (leading to functionality bugs where you can't get the txs from the MEMPOOL response). Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T00:46:20Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200",
      "id" : 1189250200,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G4oSY",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1419619927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T00:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ?\r\n\r\nYeah, I think that makes perfect sense, given there is no point in adding something to the filter if we are going to unconditionally serve it anyway.\r\n\r\n> Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?\r\n\r\nIt may indeed. I haven't got my head around how to properly compute what are the odds of this happening though, given it feels like it depends on how often `MEMPOOL` messages are sent to us, which may be unbounded (how many `MEMPOOL` requests can we receive in a `UNCONDITIONAL_RELAY_DELAY` period, and how full our mempool may be?). In any case, this feels detrimental for the peer implementing this behavior instead of for us (?)\r\n\r\nSomething I'm really wondering is why this is actually bound by `INVENTORY_MAX_RECENT_RELAY (3500)`  instead of by `MAX_PEER_TX_ANNOUNCEMENTS (5000)`. It feels quite inconsistent that we are able to accept up to 5000 transaction announcements from someone but we are only able to remember the last 3500 that we have announced to someone(else).\r\n\r\nI think what may make even more sense would be to reply to mempool messages only with transactions that fall into the `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` check, that way we don't really have to add transactions to `m_recently_announced_invs` here, and we are also discouraging peers bloating us with `MEMPOOL` messages. As long as they have a filter set, any transaction that matches their filter will be announced to them anyway (h/t @sdaftuar). I guess this could be done as a followup if it makes sense.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T18:56:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606",
      "id" : 1190289606,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8mDG",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421218257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? \r\n\r\nAlso wouldn't that also apply here? https://github.com/bitcoin/bitcoin/blob/27c40e3dcf280a137bcfaa787674c26781d911b8/src/net_processing.cpp#L5688\r\n",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T19:42:56Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642",
      "id" : 1190326642,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8vFy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421274926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:42:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-05-10T20:00:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164",
      "id" : 1542733164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b9D1s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164/reactions"
      },
      "updated_at" : "2023-05-10T20:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MAX_PEER_TX_ANNOUNCEMENTS` doesn't really provide a rate limit -- it stops the queue from being more than 5k at any point in time, but the flow through the queue could still be 400tx/s, for instance.  Beyond that, `m_recently_announced_invs` only tracks things we announced, not things we received, and we rate limit that (as per the static_assert on `INVENTORY_MAX_RECENT_RELAY`).\r\n\r\nDelaying MEMPOOL results for 2 minutes seems annoying. But how about just recording the timestamp of the last MEMPOOL request into the `txrelay` structure, and skipping the bloom lookup if `m_time <= max(now-2min, txrelay->last_mempool_request)` ?\r\n\r\nYou could make the inv-trickle insertion into the bloom filter conditional too, but I think that would so rarely actually have an effect that it wouldn't matter?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T00:26:46Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125",
      "id" : 1190497125,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G9Ytl",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421520316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T00:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
