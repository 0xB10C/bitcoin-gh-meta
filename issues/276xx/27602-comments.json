[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [glozow](https://github.com/bitcoin/bitcoin/pull/27602#pullrequestreview-1418933543), [willcl-ark](https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-05-08T21:23:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539072919",
      "id" : 1539072919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGOX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919/reactions"
      },
      "updated_at" : "2023-05-10T20:00:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539072919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Motivation: this fix was discussed over IRC by @willcl-ark @glozow @sipa and @darosior \r\n\r\nhttps://gnusha.org/bitcoin-core-dev/2023-05-02.log",
      "created_at" : "2023-05-08T21:24:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1539074312",
      "id" : 1539074312,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585bvGkI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312/reactions"
      },
      "updated_at" : "2023-05-08T21:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539074312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't this just change the fingerprinting vector from `GETDATA txid` to `FILTERCLEAR; FILTERADD whatever; MEMPOOL` ? In which case we're just as easily fingerprinted, but we spend more cpu while being fingerprinted?",
      "commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "created_at" : "2023-05-09T08:11:42Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188287489",
      "id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G09QB",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 1418112808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T08:11:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188287489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852"
         }
      },
      "author_association" : "NONE",
      "body" : "Do you mean keep adding what you're interested in into the filter so it triggers an `INV` from the node and, therefore, we can request it (or, similarly, keep resetting the filter and just add the one single transaction that we want to probe)? If so, isn't that equivalent to having no filter?\r\n\r\nI think in both of the aforementioned cases (which boil down to the same logic if I'm not mistaken) the patch prevents the attacker from requesting unannounced transactions straight-away, they will have to wait for `m_next_inv_send_time` to go off.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:01:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188745852",
      "id" : 1188745852,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G2tJ8",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1418860317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:01:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188745852",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_last_mempool_req` is now unused and can be removed completely? Also, it might be good to not touch the `return` here when there is no reason, to avoid code churn and review burden.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T15:13:52Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188763337",
      "id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2xbJ",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418888189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T15:13:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188763337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722"
         }
      },
      "author_association" : "NONE",
      "body" : "> m_last_mempool_req is now unused and can be removed completely?\r\n\r\nLooks like it\r\n\r\n> Also, it might be good to not touch the return here when there is no reason, to avoid code churn and review burden.\r\n\r\nI thought the only reason why this was split into two lines is that it was a bit too long (?), I tried to follow the same approach as in `L2267` and, while I think it looks more compact the way it is now, I don't have a strong opinion about on styling atm, so I'm happy to amend it if there is consensus that this is best.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-09T18:00:47Z",
      "diff_hunk" : "@@ -2255,16 +2255,12 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds now)\n {\n     auto txinfo = m_mempool.info(gtxid);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) return std::move(txinfo.tx);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1188956722",
      "id" : 1188956722,
      "in_reply_to_id" : 1188763337,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G3goy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 2263,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419184844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T18:01:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188956722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Addressed comments by @MarcoFalke and fixed a couple of logs from the tests",
      "created_at" : "2023-05-09T19:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1540782565",
      "id" : 1540782565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b1nnl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565/reactions"
      },
      "updated_at" : "2023-05-09T19:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540782565",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, I see what you mean. That makes sense.\r\n\r\nNext point on those lines though: adding many things to `m_recently_announced_invs` can overflow the bloom filter, either causing false positives (leading to privacy bugs), or since it's a rolling bloom filter, causing overflow leading to false negatives (leading to functionality bugs where you can't get the txs from the MEMPOOL response). Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T00:46:20Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1189250200",
      "id" : 1189250200,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G4oSY",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1419619927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T00:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189250200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ?\r\n\r\nYeah, I think that makes perfect sense, given there is no point in adding something to the filter if we are going to unconditionally serve it anyway.\r\n\r\n> Even then this approach seems like it can trigger false positives fairly easily, since the rolling bloom filter capacity is only 3500 txs?\r\n\r\nIt may indeed. I haven't got my head around how to properly compute what are the odds of this happening though, given it feels like it depends on how often `MEMPOOL` messages are sent to us, which may be unbounded (how many `MEMPOOL` requests can we receive in a `UNCONDITIONAL_RELAY_DELAY` period, and how full our mempool may be?). In any case, this feels detrimental for the peer implementing this behavior instead of for us (?)\r\n\r\nSomething I'm really wondering is why this is actually bound by `INVENTORY_MAX_RECENT_RELAY (3500)`  instead of by `MAX_PEER_TX_ANNOUNCEMENTS (5000)`. It feels quite inconsistent that we are able to accept up to 5000 transaction announcements from someone but we are only able to remember the last 3500 that we have announced to someone(else).\r\n\r\nI think what may make even more sense would be to reply to mempool messages only with transactions that fall into the `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` check, that way we don't really have to add transactions to `m_recently_announced_invs` here, and we are also discouraging peers bloating us with `MEMPOOL` messages. As long as they have a filter set, any transaction that matches their filter will be announced to them anyway (h/t @sdaftuar). I guess this could be done as a followup if it makes sense.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T18:56:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190289606",
      "id" : 1190289606,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8mDG",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421218257,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190289606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642"
         }
      },
      "author_association" : "NONE",
      "body" : "> Wouldn't it be better to make the insertion conditional on `txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY` ? \r\n\r\nAlso wouldn't that also apply here? https://github.com/bitcoin/bitcoin/blob/27c40e3dcf280a137bcfaa787674c26781d911b8/src/net_processing.cpp#L5688\r\n",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-10T19:42:56Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190326642",
      "id" : 1190326642,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G8vFy",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421274926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T19:42:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190326642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2023-05-10T20:00:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1542733164",
      "id" : 1542733164,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585b9D1s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164/reactions"
      },
      "updated_at" : "2023-05-10T20:00:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1542733164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`MAX_PEER_TX_ANNOUNCEMENTS` doesn't really provide a rate limit -- it stops the queue from being more than 5k at any point in time, but the flow through the queue could still be 400tx/s, for instance.  Beyond that, `m_recently_announced_invs` only tracks things we announced, not things we received, and we rate limit that (as per the static_assert on `INVENTORY_MAX_RECENT_RELAY`).\r\n\r\nDelaying MEMPOOL results for 2 minutes seems annoying. But how about just recording the timestamp of the last MEMPOOL request into the `txrelay` structure, and skipping the bloom lookup if `m_time <= max(now-2min, txrelay->last_mempool_request)` ?\r\n\r\nYou could make the inv-trickle insertion into the bloom filter conditional too, but I think that would so rarely actually have an effect that it wouldn't matter?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T00:26:46Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190497125",
      "id" : 1190497125,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G9Ytl",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1421520316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T00:26:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190497125",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'm only a casual lurker on the net_processing side but i was under the impression we were thinking of the BIP35 as permissioned anyways. If we are already trusting the peer that sends use MEMPOOL message, why not just include everything we've got?\r\nA practical counter-argument to this could be - yeah but at this time [around 20% to 30% of reachable nodes](https://github.com/bitcoin/bitcoin/pull/27426#issuecomment-1529678174) set `peerbloomfilters` so it's still worth closing an obvious fingerprinting vector.\r\n\r\nAnother thing is whether it's breaking any usecase. Since the message is from a trusted peer a client may be relying on getting the whole mempool. For instance BTCPay/NBXplorer needs `whitelist=mempool` iirc. What's the proportion of announced vs non-announced transactions? How much would be left out with this patch?",
      "created_at" : "2023-05-11T08:20:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543552214",
      "id" : 1543552214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cALzW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543552214/reactions"
      },
      "updated_at" : "2023-05-11T08:20:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543552214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190924614"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> But how about just recording the timestamp of the last MEMPOOL request ...\r\n\r\nPatch might look something like... (EDIT: Err, except that's just essentially reverting back to what we have now?)\r\n\r\n<details><summary>Details</summary>\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -295,6 +295,8 @@ struct Peer {\r\n          *  permitted if the peer has NetPermissionFlags::Mempool or we advertise\r\n          *  NODE_BLOOM. See BIP35. */\r\n         bool m_send_mempool GUARDED_BY(m_tx_inventory_mutex){false};\r\n+        std::chrono::microseconds m_last_mempool_time GUARDED_BY(m_tx_inventory_mutex){0};\r\n+\r\n         /** The next time after which we will send an `inv` message containing\r\n          *  transaction announcements to this peer. */\r\n         std::chrono::microseconds m_next_inv_send_time GUARDED_BY(m_tx_inventory_mutex){0};\r\n@@ -2258,7 +2260,7 @@ CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay,\r\n     auto txinfo = m_mempool.info(gtxid);\r\n     if (txinfo.tx) {\r\n         // If a TX is older than UNCONDITIONAL_RELAY_DELAY, permit the request unconditionally.\r\n-        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\r\n+        if (txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY || WITH_LOCK(tx_relay.m_tx_inventory_mutex, return txinfo.m_time <= tx_relay.m_last_mempool_time)) {\r\n             return std::move(txinfo.tx);\r\n         }\r\n     }\r\n@@ -5619,6 +5621,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                     tx_relay->m_send_mempool = false;\r\n                     const CFeeRate filterrate{tx_relay->m_fee_filter_received.load()};\r\n \r\n+                    tx_relay->m_last_mempool_time = current_time;\r\n                     LOCK(tx_relay->m_bloom_filter_mutex);\r\n \r\n                     for (const auto& txinfo : vtxinfo) {\r\n@@ -5632,7 +5635,6 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\r\n                         if (tx_relay->m_bloom_filter) {\r\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\r\n                         }\r\n-                        tx_relay->m_tx_inventory_known_filter.insert(hash);\r\n                         tx_relay->m_recently_announced_invs.insert(hash);\r\n                         vInv.push_back(inv);\r\n                         if (vInv.size() == MAX_INV_SZ) {\r\n```\r\n</details> ",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T09:51:51Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190924614",
      "id" : 1190924614,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_BFG",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422203739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190924614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190966758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, other idea: how about just making sure you only send at most 3500 mempool entries younger than 2 minutes, in response to a MEMPOOL message, and add them all to the filter, and don't worry if that causes overflow on results from a previous response?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T10:28:01Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190966758",
      "id" : 1190966758,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_LXm",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422269233,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190966758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> i was under the impression we were thinking of the BIP35 as permissioned anyways.\r\n> ...\r\n> For instance BTCPay/NBXplorer needs `whitelist=mempool` iirc.\r\n\r\nJust on these points, currently the MEMPOOL message will be responded to _either_ if you have the whitelist permission `mempool` on the peer **or** if you have enabled NODE_BLOOM (with `-peerbloomfilters`). In the latter case I don't think we can accurately describe these as \"trusted peers\". See the changes in [`4581a68` (#27559)](https://github.com/bitcoin/bitcoin/pull/27559/commits/4581a682d2d1fdd0e56fb4a56e6228be878a04a3) which clarify this.\r\n\r\n",
      "created_at" : "2023-05-11T10:34:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543749307",
      "id" : 1543749307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cA767",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543749307/reactions"
      },
      "updated_at" : "2023-05-11T10:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543749307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190981465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> how about just making sure you only send at most 3500 mempool entries younger than 2 minutes, in response to a MEMPOOL message\r\n\r\nWouldn't that imply that peers are now expected to send the `mempool` message in a loop (or at least twice over a span of two minutes) to detect if there were more transactions to get? If yes, I wonder if it conflicts with the idea to potentially only allow a single `mempool` message per connection.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T10:42:52Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1190981465",
      "id" : 1190981465,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_O9Z",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422291699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T10:56:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190981465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191023800"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if we can remove mapRelay and as a result can get more efficient data structures to remember (w)txids per `Peer`, knowing that only transaction in the mempool can be in them.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T11:25:18Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191023800",
      "id" : 1191023800,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_ZS4",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422357714,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T11:25:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191023800",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The title \"avoid serving non-announced txs as a result of a MEMPOOL message\" is confusing - it gives the impression that this PR will change the response to `MEMPOOL` messages, but it does not do that. Before and after the PR we would send the full mempool in a reply to `mempool` (correct me if I got it wrong).\r\n",
      "created_at" : "2023-05-11T12:34:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543917289",
      "id" : 1543917289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cBk7p",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543917289/reactions"
      },
      "updated_at" : "2023-05-11T12:34:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543917289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  What's the proportion of announced vs non-announced transactions? How much would be left out with this patch?\r\n\r\nThe PR (as it is right now) still announces everything in response to mempool. The client just cannot request extremely recent things, which will be announced normally every ~5 seconds. This is \"I haven't even announced this to you yet, why are you requesting it from me? seems suspicious. Just wait 5 seconds and I'll announce it to you.\"\r\n\r\nA normal client, who presumably does not already know what it wants to request until it receives an announcement (i.e. using `mempool` to learn about transactions), shouldn't be affected at all.",
      "created_at" : "2023-05-11T12:56:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#issuecomment-1543955685",
      "id" : 1543955685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27602",
      "node_id" : "IC_kwDOABII585cBuTl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543955685/reactions"
      },
      "updated_at" : "2023-05-11T12:56:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543955685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191157352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I wonder if we can remove mapRelay and as a result can get more efficient data structures to remember (w)txids per Peer, knowing that only transaction in the mempool can be in them.\r\n\r\n`mapRelay` is mostly what's in the mempool, but can also contain entries that were announced less than 15min ago + fell out of the mempool since then. This is sometimes good for fingerprinting :shrug: but also seems like largely redundant information to me.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:07:35Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191157352",
      "id" : 1191157352,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_55o",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422573948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:07:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191157352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191170092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think we can remove `mapRelay` -- we need it so we can continue to relay recently announced txs that we've removed from the mempool?\r\n\r\nHow about this approach: when we get a MEMPOOL message, at the next `fSendTrickle` time, for each tx that matches the filter, if it's older than 2 minutes, announce it immediately, otherwise just put it into `m_tx_inventory_to_send` and let it be sent out at the usual rate. Only use `m_recently_announced_invs` for txs relayed via `m_tx_inventory_to_send`. (Maybe bump the \"2 minutes\" by a small random amount)",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:17:10Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191170092",
      "id" : 1191170092,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585G_9As",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422594028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191170092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191189563"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        self.log.info(\"Check all transactions are returned by the match-all filter\")\r\n```",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:31:23Z",
      "diff_hunk" : "@@ -135,14 +136,38 @@ def test_msg_mempool(self):\n         self.log.info(\"Check that a node with bloom filters enabled services p2p mempool messages\")\n         filter_peer = P2PBloomFilter()\n \n-        self.log.debug(\"Create a tx relevant to the peer before connecting\")\n-        txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=9 * COIN)\n+        self.log.info(\"Create two tx before connecting, one relevant to the node another that is not\")\n+        rel_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=1 * COIN)\n+        rel_wtxid = self.nodes[0].getmempoolentry(rel_txid)[\"wtxid\"]\n+        irr_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=2 * COIN)\n+        irr_wtxid = self.nodes[0].getmempoolentry(irr_txid)[\"wtxid\"]\n \n-        self.log.debug(\"Send a mempool msg after connecting and check that the tx is received\")\n+        self.log.info(\"Send a mempool msg after connecting and check that the relevant tx is received\")\n         self.nodes[0].add_p2p_connection(filter_peer)\n         filter_peer.send_and_ping(filter_peer.watch_filter_init)\n-        filter_peer.send_message(msg_mempool())\n-        filter_peer.wait_for_tx(txid)\n+        filter_peer.send_and_ping(msg_mempool())\n+        filter_peer.wait_for_tx(rel_txid)\n+\n+        self.log.info(\"Request the irrelevant transaction even though it has not being offered to us\")\n+        filter_peer.tx_received = False\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(irr_wtxid, 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Create a third transaction (that was therefore not part of the mempool message) and try to retrieve it\")\n+        add_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=3 * COIN)\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(self.nodes[0].getmempoolentry(add_txid)[\"wtxid\"], 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Check this is also sound for a peer that has a match-all filter set\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191189563",
      "id" : 1191189563,
      "line" : 161,
      "node_id" : "PRRC_kwDOABII585HABw7",
      "original_commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "original_line" : 161,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/p2p_filter.py",
      "position" : 39,
      "pull_request_review_id" : 1422624974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:31:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191189563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191190564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this log line could be removed as this seems part of the previous check?",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:32:36Z",
      "diff_hunk" : "@@ -135,14 +136,38 @@ def test_msg_mempool(self):\n         self.log.info(\"Check that a node with bloom filters enabled services p2p mempool messages\")\n         filter_peer = P2PBloomFilter()\n \n-        self.log.debug(\"Create a tx relevant to the peer before connecting\")\n-        txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=9 * COIN)\n+        self.log.info(\"Create two tx before connecting, one relevant to the node another that is not\")\n+        rel_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=filter_peer.watch_script_pubkey, amount=1 * COIN)\n+        rel_wtxid = self.nodes[0].getmempoolentry(rel_txid)[\"wtxid\"]\n+        irr_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=2 * COIN)\n+        irr_wtxid = self.nodes[0].getmempoolentry(irr_txid)[\"wtxid\"]\n \n-        self.log.debug(\"Send a mempool msg after connecting and check that the tx is received\")\n+        self.log.info(\"Send a mempool msg after connecting and check that the relevant tx is received\")\n         self.nodes[0].add_p2p_connection(filter_peer)\n         filter_peer.send_and_ping(filter_peer.watch_filter_init)\n-        filter_peer.send_message(msg_mempool())\n-        filter_peer.wait_for_tx(txid)\n+        filter_peer.send_and_ping(msg_mempool())\n+        filter_peer.wait_for_tx(rel_txid)\n+\n+        self.log.info(\"Request the irrelevant transaction even though it has not being offered to us\")\n+        filter_peer.tx_received = False\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(irr_wtxid, 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Create a third transaction (that was therefore not part of the mempool message) and try to retrieve it\")\n+        add_txid, _ = self.wallet.send_to(from_node=self.nodes[0], scriptPubKey=getnewdestination()[1], amount=3 * COIN)\n+        filter_peer.send_and_ping(msg_getdata([CInv(t=MSG_WTX, h=int(self.nodes[0].getmempoolentry(add_txid)[\"wtxid\"], 16))]))\n+        assert not filter_peer.tx_received\n+\n+        self.log.info(\"Check this is also sound for a peer that has a match-all filter set\")\n+        unfilter_peer = P2PBloomFilter()\n+        self.nodes[0].add_p2p_connection(unfilter_peer)\n+        unfilter_peer.send_and_ping(msg_mempool())\n+\n+        self.log.info(\"Here the all transactions are relevant\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191190564",
      "id" : 1191190564,
      "line" : 166,
      "node_id" : "PRRC_kwDOABII585HACAk",
      "original_commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "original_line" : 166,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "test/functional/p2p_filter.py",
      "position" : 44,
      "pull_request_review_id" : 1422626564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:32:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191190564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191211092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This is sometimes good for fingerprinting\r\n\r\nfingerprinting seems bad, so another reason for removal? \r\n\r\n> I don't think we can remove mapRelay -- we need it so we can continue to relay recently announced txs that we've removed from the mempool?\r\n\r\nSure that is what it does, but if the only use case is for spy nodes to fingerprint, it may be better to remove it?\r\n\r\nSee #27625. Feel free to NACK.",
      "commit_id" : "27c40e3dcf280a137bcfaa787674c26781d911b8",
      "created_at" : "2023-05-11T13:58:13Z",
      "diff_hunk" : "@@ -5639,7 +5633,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             if (!tx_relay->m_bloom_filter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         }\n                         tx_relay->m_tx_inventory_known_filter.insert(hash);\n-                        // Responses to MEMPOOL requests bypass the m_recently_announced_invs filter.\n+                        tx_relay->m_recently_announced_invs.insert(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27602#discussion_r1191211092",
      "id" : 1191211092,
      "in_reply_to_id" : 1188287489,
      "line" : 5636,
      "node_id" : "PRRC_kwDOABII585HAHBU",
      "original_commit_id" : "c04f145894d2fe8cc419354ca82d570cc469fe75",
      "original_line" : 5636,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 59,
      "pull_request_review_id" : 1422659629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27602",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T13:58:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191211092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
