[
   {
      "body" : "I'm following the payment request testplan: https://github.com/gavinandresen/QA/blob/master/PaymentRequestTest.md\r\n\r\n\"Unsigned payment request\"\r\n- OK\r\n\r\n\"Signed payment request\"\r\n- OK\r\n\r\n\"Signed payment request, multiple addresses\"\r\n- Overview is correct, sent transactions are correct\r\n- Strange: no label is added for the second address when doing this. Not sure this is a regression though.\r\n\r\n\"PaymentACK message\"\r\n- OK (paymentack received message displays)\r\n\r\n\"Expired payment request\"\r\n- OK (payment request expired dialog pops up)\r\n",
      "created_at" : "2013-08-31T06:47:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#issuecomment-23601721",
      "id" : 23601721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2958",
      "updated_at" : "2013-08-31T06:47:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/23601721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099703"
         }
      },
      "body" : "This should be changed to dynamic units via ``model->getOptionsModel()->getDisplayUnit()``, remember my recent pull :).",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:12:01Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099703",
      "id" : 6099703,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 7,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099704"
         }
      },
      "body" : "Same here ``model->getOptionsModel()->getDisplayUnit()``.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:12:49Z",
      "diff_hunk" : "@@ -163,6 +165,51 @@ void SendCoinsDialog::on_sendButton_clicked()\n             tr(\"Error: Transaction creation failed!\"),\n             QMessageBox::Ok, QMessageBox::Ok);\n         break;\n+    case WalletModel::Aborted: // User aborted, nothing to do\n+    case WalletModel::OK:\n+    case WalletModel::TransactionCommitFailed:\n+        break;\n+    }\n+\n+    if(prepareStatus.status != WalletModel::OK) {\n+        fNewRecipientAllowed = true;\n+        return;\n+    }\n+\n+    qint64 txFee = currentTransaction.getTransactionFee();\n+    QString questionString = tr(\"Are you sure you want to send?\");\n+    questionString.append(\"<br /><br />%1\");\n+\n+    if(txFee > 0)\n+    {\n+        // append fee string if a fee is required\n+        questionString.append(\"<hr /><span style='color:#aa0000;'>\");\n+        questionString.append(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, txFee));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099704",
      "id" : 6099704,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 85,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099706"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099706"
         }
      },
      "body" : "Same here ``model->getOptionsModel()->getDisplayUnit()``.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:13:04Z",
      "diff_hunk" : "@@ -163,6 +165,51 @@ void SendCoinsDialog::on_sendButton_clicked()\n             tr(\"Error: Transaction creation failed!\"),\n             QMessageBox::Ok, QMessageBox::Ok);\n         break;\n+    case WalletModel::Aborted: // User aborted, nothing to do\n+    case WalletModel::OK:\n+    case WalletModel::TransactionCommitFailed:\n+        break;\n+    }\n+\n+    if(prepareStatus.status != WalletModel::OK) {\n+        fNewRecipientAllowed = true;\n+        return;\n+    }\n+\n+    qint64 txFee = currentTransaction.getTransactionFee();\n+    QString questionString = tr(\"Are you sure you want to send?\");\n+    questionString.append(\"<br /><br />%1\");\n+\n+    if(txFee > 0)\n+    {\n+        // append fee string if a fee is required\n+        questionString.append(\"<hr /><span style='color:#aa0000;'>\");\n+        questionString.append(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, txFee));\n+        questionString.append(\"</span> \");\n+        questionString.append(tr(\"added as transaction fee\"));\n+    }\n+    if(txFee > 0 || recipients.count() > 1)\n+    {\n+        // add total amount string if there are more then one recipients or a fee is required\n+        questionString.append(\"<hr />\");\n+        questionString.append(tr(\"Total Amount %1\").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, currentTransaction.getTotalTransactionAmount()+txFee)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099706",
      "id" : 6099706,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 93,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099706",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099709"
         }
      },
      "body" : "I'm not sure if we should use fixed font-sizes.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:15:08Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));\n+            recipientElement.append(tr(\"to\"));\n+\n+            if(rcp.label.length() > 0)\n+            {\n+                recipientElement.append(QString(\" %1 <span style='font-size:8px;'>%2</span><br />\").arg(GUIUtil::HtmlEscape(rcp.label), rcp.address)); // add address with label",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099709",
      "id" : 6099709,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 12,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099721"
         }
      },
      "body" : "Is this still used anywhere after this pull?",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:18:18Z",
      "diff_hunk" : "@@ -192,58 +191,70 @@ bool WalletModel::validateAddress(const QString &address)\n \n     if((total + nTransactionFee) > getBalance())\n     {\n-        return SendCoinsReturn(AmountWithFeeExceedsBalance, nTransactionFee);\n+        transaction.setTransactionFee(nTransactionFee);\n+        return SendCoinsReturn(AmountWithFeeExceedsBalance);\n     }\n \n     {\n         LOCK2(cs_main, wallet->cs_wallet);\n \n-        CReserveKey keyChange(wallet);\n+        transaction.newPossibleKeyChange(wallet);\n         int64 nFeeRequired = 0;\n         std::string strFailReason;\n-        CWalletTx wtx;\n-        bool fCreated = wallet->CreateTransaction(vecSend, wtx, keyChange, nFeeRequired, strFailReason);\n+\n+        CWalletTx *newTx = transaction.getTransaction();\n+        CReserveKey *keyChange = transaction.getPossibleKeyChange();\n+        bool fCreated = wallet->CreateTransaction(vecSend, *newTx, *keyChange, nFeeRequired, strFailReason);\n+        transaction.setTransactionFee(nFeeRequired);\n \n         if(!fCreated)\n         {\n             if((total + nFeeRequired) > wallet->GetBalance())\n             {\n-                return SendCoinsReturn(AmountWithFeeExceedsBalance, nFeeRequired);\n+                return SendCoinsReturn(AmountWithFeeExceedsBalance);\n             }\n             emit message(tr(\"Send Coins\"), QString::fromStdString(strFailReason),\n                          CClientUIInterface::MSG_ERROR);\n             return TransactionCreationFailed;\n         }\n+    }\n+\n+    return SendCoinsReturn(OK);\n+}\n+\n+WalletModel::SendCoinsReturn WalletModel::sendCoins(WalletModelTransaction &transaction)\n+{\n+    QByteArray transaction_array; /* store serialized transaction */\n+\n+    {\n+        LOCK2(cs_main, wallet->cs_wallet);\n+        CWalletTx *newTx = transaction.getTransaction();\n+\n         // Store PaymentRequests in wtx.vOrderForm in wallet.\n-        foreach(const SendCoinsRecipient &rcp, recipients)\n+        foreach(const SendCoinsRecipient &rcp, transaction.getRecipients())\n         {\n             if (rcp.paymentRequest.IsInitialized())\n             {\n                 std::string key(\"PaymentRequest\");\n                 std::string value;\n                 rcp.paymentRequest.SerializeToString(&value);\n-                wtx.vOrderForm.push_back(make_pair(key, value));\n+                newTx->vOrderForm.push_back(make_pair(key, value));\n             }\n-        }        \n-\n-        if(!uiInterface.ThreadSafeAskFee(nFeeRequired))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099721",
      "id" : 6099721,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 84,
      "path" : "src/qt/walletmodel.cpp",
      "position" : 84,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099751"
         }
      },
      "body" : "Yes. We should use that. @laanwj should i takeover again and fix these things?",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:57:39Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099751",
      "id" : 6099751,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 7,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099755"
         }
      },
      "body" : "Hmm... i would keep the current font. Even with fixed font's line breaks are possible.\r\nI also think fixed fonts can look really bad.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T09:58:41Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));\n+            recipientElement.append(tr(\"to\"));\n+\n+            if(rcp.label.length() > 0)\n+            {\n+                recipientElement.append(QString(\" %1 <span style='font-size:8px;'>%2</span><br />\").arg(GUIUtil::HtmlEscape(rcp.label), rcp.address)); // add address with label",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099755",
      "id" : 6099755,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 12,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099782"
         }
      },
      "body" : "I think it's still used when you submit transactions over RPC.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T10:23:50Z",
      "diff_hunk" : "@@ -192,58 +191,70 @@ bool WalletModel::validateAddress(const QString &address)\n \n     if((total + nTransactionFee) > getBalance())\n     {\n-        return SendCoinsReturn(AmountWithFeeExceedsBalance, nTransactionFee);\n+        transaction.setTransactionFee(nTransactionFee);\n+        return SendCoinsReturn(AmountWithFeeExceedsBalance);\n     }\n \n     {\n         LOCK2(cs_main, wallet->cs_wallet);\n \n-        CReserveKey keyChange(wallet);\n+        transaction.newPossibleKeyChange(wallet);\n         int64 nFeeRequired = 0;\n         std::string strFailReason;\n-        CWalletTx wtx;\n-        bool fCreated = wallet->CreateTransaction(vecSend, wtx, keyChange, nFeeRequired, strFailReason);\n+\n+        CWalletTx *newTx = transaction.getTransaction();\n+        CReserveKey *keyChange = transaction.getPossibleKeyChange();\n+        bool fCreated = wallet->CreateTransaction(vecSend, *newTx, *keyChange, nFeeRequired, strFailReason);\n+        transaction.setTransactionFee(nFeeRequired);\n \n         if(!fCreated)\n         {\n             if((total + nFeeRequired) > wallet->GetBalance())\n             {\n-                return SendCoinsReturn(AmountWithFeeExceedsBalance, nFeeRequired);\n+                return SendCoinsReturn(AmountWithFeeExceedsBalance);\n             }\n             emit message(tr(\"Send Coins\"), QString::fromStdString(strFailReason),\n                          CClientUIInterface::MSG_ERROR);\n             return TransactionCreationFailed;\n         }\n+    }\n+\n+    return SendCoinsReturn(OK);\n+}\n+\n+WalletModel::SendCoinsReturn WalletModel::sendCoins(WalletModelTransaction &transaction)\n+{\n+    QByteArray transaction_array; /* store serialized transaction */\n+\n+    {\n+        LOCK2(cs_main, wallet->cs_wallet);\n+        CWalletTx *newTx = transaction.getTransaction();\n+\n         // Store PaymentRequests in wtx.vOrderForm in wallet.\n-        foreach(const SendCoinsRecipient &rcp, recipients)\n+        foreach(const SendCoinsRecipient &rcp, transaction.getRecipients())\n         {\n             if (rcp.paymentRequest.IsInitialized())\n             {\n                 std::string key(\"PaymentRequest\");\n                 std::string value;\n                 rcp.paymentRequest.SerializeToString(&value);\n-                wtx.vOrderForm.push_back(make_pair(key, value));\n+                newTx->vOrderForm.push_back(make_pair(key, value));\n             }\n-        }        \n-\n-        if(!uiInterface.ThreadSafeAskFee(nFeeRequired))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099782",
      "id" : 6099782,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 84,
      "path" : "src/qt/walletmodel.cpp",
      "position" : 84,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099783"
         }
      },
      "body" : "This was also in @jonasschnelli's pull, which I just rebased. We can keep font improvements for a future pull.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T10:24:30Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));\n+            recipientElement.append(tr(\"to\"));\n+\n+            if(rcp.label.length() > 0)\n+            {\n+                recipientElement.append(QString(\" %1 <span style='font-size:8px;'>%2</span><br />\").arg(GUIUtil::HtmlEscape(rcp.label), rcp.address)); // add address with label",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099783",
      "id" : 6099783,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 12,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : 12,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099785"
         }
      },
      "body" : "@jonasschnelli I'd rather just get this merged ASAP and leave improvements to later. So if there's nothing breaking or obviously incorrect I'd like to get ACKs.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T10:25:19Z",
      "diff_hunk" : "@@ -97,9 +97,18 @@ void SendCoinsDialog::on_sendButton_clicked()\n         QString amount = BitcoinUnits::formatWithUnit(model->getOptionsModel()->getDisplayUnit(), rcp.amount);\n         if (rcp.authenticatedMerchant.isEmpty())\n         {\n-            QString address = rcp.address;\n-            QString to = GUIUtil::HtmlEscape(rcp.label);\n-            formatted.append(tr(\"<b>%1</b> to %2 (%3)\").arg(amount, to, address));\n+            QString recipientElement = QString(\"<b>%1</b> \").arg(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, rcp.amount));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099785",
      "id" : 6099785,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 7,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099785",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099789"
         }
      },
      "body" : "Will fix these before merge.",
      "commit_id" : "9e8904f6aeb6e98b4781fcf408b0a2bee550051d",
      "created_at" : "2013-08-31T10:27:32Z",
      "diff_hunk" : "@@ -163,6 +165,51 @@ void SendCoinsDialog::on_sendButton_clicked()\n             tr(\"Error: Transaction creation failed!\"),\n             QMessageBox::Ok, QMessageBox::Ok);\n         break;\n+    case WalletModel::Aborted: // User aborted, nothing to do\n+    case WalletModel::OK:\n+    case WalletModel::TransactionCommitFailed:\n+        break;\n+    }\n+\n+    if(prepareStatus.status != WalletModel::OK) {\n+        fNewRecipientAllowed = true;\n+        return;\n+    }\n+\n+    qint64 txFee = currentTransaction.getTransactionFee();\n+    QString questionString = tr(\"Are you sure you want to send?\");\n+    questionString.append(\"<br /><br />%1\");\n+\n+    if(txFee > 0)\n+    {\n+        // append fee string if a fee is required\n+        questionString.append(\"<hr /><span style='color:#aa0000;'>\");\n+        questionString.append(BitcoinUnits::formatWithUnit(BitcoinUnits::BTC, txFee));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#discussion_r6099789",
      "id" : 6099789,
      "original_commit_id" : "fecfa1dffee97d471f86ca45c5639b3f23ff59d9",
      "original_position" : 85,
      "path" : "src/qt/sendcoinsdialog.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/2958",
      "updated_at" : "2013-08-31T10:42:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/6099789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "I didn't try to compile, but you can get a looked-at-the-code ACK. We should merge and improve the rest afterwards.",
      "created_at" : "2013-08-31T11:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#issuecomment-23604964",
      "id" : 23604964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2958",
      "updated_at" : "2013-08-31T11:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/23604964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1419649?v=3",
         "events_url" : "https://api.github.com/users/Diapolo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Diapolo/followers",
         "following_url" : "https://api.github.com/users/Diapolo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Diapolo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Diapolo",
         "id" : 1419649,
         "login" : "Diapolo",
         "organizations_url" : "https://api.github.com/users/Diapolo/orgs",
         "received_events_url" : "https://api.github.com/users/Diapolo/received_events",
         "repos_url" : "https://api.github.com/users/Diapolo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Diapolo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Diapolo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Diapolo"
      }
   },
   {
      "body" : "Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/9e8904f6aeb6e98b4781fcf408b0a2bee550051d for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/current/\nContact BlueMatt on freenode if something looks broken.",
      "created_at" : "2013-09-01T13:37:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/2958#issuecomment-23625014",
      "id" : 23625014,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/2958",
      "updated_at" : "2013-09-01T13:37:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/23625014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2110907?v=3",
         "events_url" : "https://api.github.com/users/BitcoinPullTester/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BitcoinPullTester/followers",
         "following_url" : "https://api.github.com/users/BitcoinPullTester/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BitcoinPullTester/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BitcoinPullTester",
         "id" : 2110907,
         "login" : "BitcoinPullTester",
         "organizations_url" : "https://api.github.com/users/BitcoinPullTester/orgs",
         "received_events_url" : "https://api.github.com/users/BitcoinPullTester/received_events",
         "repos_url" : "https://api.github.com/users/BitcoinPullTester/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BitcoinPullTester/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BitcoinPullTester/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BitcoinPullTester"
      }
   }
]
