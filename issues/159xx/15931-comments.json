[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16341](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16341.html) (Introduce ScriptPubKeyMan interface and use it for key and script management (aka wallet boxes) by achow101)\n* [#15729](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15729.html) (rpc: Raise error in getbalance if minconf is not zero by promag)\n* [#15129](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15129.html) (rpc: Added ability to remove watch only addresses by benthecarman)\n* [#14707](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14707.html) ([RPC] Include coinbase transactions in receivedby RPCs by andrewtoth)\n* [#14582](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14582.html) (wallet: try -avoidpartialspends mode and use its result if fees do not change by kallewoof)\n* [#10102](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10102.html) ([experimental] Multiprocess bitcoin by ryanofsky)\n* [#9381](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9381.html) (Remove CWalletTx merging logic from AddToWallet by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-05-01T18:27:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-488368727",
      "id" : 488368727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4ODM2ODcyNw==",
      "updated_at" : "2019-08-07T06:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/488368727",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-01T19:47:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-488393965",
      "id" : 488393965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4ODM5Mzk2NQ==",
      "updated_at" : "2019-05-01T19:47:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/488393965",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-07T16:03:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-490143435",
      "id" : 490143435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDE0MzQzNQ==",
      "updated_at" : "2019-05-07T16:03:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490143435",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-14T13:00:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-492227305",
      "id" : 492227305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjIyNzMwNQ==",
      "updated_at" : "2019-05-14T13:00:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492227305",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added to the \"Chasing Concept ACK\" board. @ryanofsky maybe you could give an initial Concept/Approach ACK/NACK ?",
      "created_at" : "2019-06-19T01:30:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-503370626",
      "id" : 503370626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMzM3MDYyNg==",
      "updated_at" : "2019-06-19T01:30:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/503370626",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes would be awesome to get a Concept ACK on the approach followed but if it's not the best one, I'm eager to rework the PR in depth! Going to rebase/fix tests failure soon",
      "created_at" : "2019-06-19T03:15:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-503389407",
      "id" : 503389407,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMzM4OTQwNw==",
      "updated_at" : "2019-06-19T04:35:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/503389407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295421954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295421954"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_last_block_processed_height field in CWallet\" (0284c72ab07362150fd26c86966ea7c7bc6cfed5)\r\n\r\nWould be good to initialize this to -1 here for safety (and also for documentation, to be clear that this can be -1).\r\n\r\nWould also be good to add GUARDED_BY(cs_wallet) annotation.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T17:38:25Z",
      "diff_hunk" : "@@ -815,6 +815,11 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n      */\n     uint256 m_last_block_processed GUARDED_BY(cs_wallet);\n \n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates.\n+     */\n+    int m_last_block_processed_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295421954",
      "id" : 295421954,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQyMTk1NA==",
      "original_commit_id" : "0284c72ab07362150fd26c86966ea7c7bc6cfed5",
      "original_position" : 7,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295421954",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295430761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295430761"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Use CWallet::m_last_block_processed_height in GetDepthInMainChain\" (233ae92f2d51333f158810d85d13cf63a1144e6b)\r\n\r\nCan we use -1 instead of 0 for this to be consistent with nIndex? Also would be good to note  here that when a transaction is conflicted, `hashBlock` and `block_height` refer to the earliest block with a conflicting transaction instead of the block containing the transaction.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T17:59:05Z",
      "diff_hunk" : "@@ -351,6 +351,11 @@ class CMerkleTx\n      */\n     int nIndex;\n \n+    /* Refers to height of block against which tx is merkle branch linked to\n+     * An block_height == 0 means that tx isn't yet linked to any block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295430761",
      "id" : 295430761,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQzMDc2MQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295430761",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295434058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295434058"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Use CWallet::m_last_block_processed_height in GetDepthInMainChain\" (233ae92f2d51333f158810d85d13cf63a1144e6b)\r\n\r\nIsn't this going to break existing serialization of transactions in the wallet? I think it'd be best not to change the serialized representation and just make this a memory-only field that gets filled when the wallet is loaded.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T18:06:42Z",
      "diff_hunk" : "@@ -383,9 +389,10 @@ class CMerkleTx\n         READWRITE(hashBlock);\n         READWRITE(vMerkleBranch);\n         READWRITE(nIndex);\n+        READWRITE(m_block_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295434058",
      "id" : 295434058,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQzNDA1OA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 24,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295434058",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295463739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295463739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nThis logic is getting hard to follow with three repetitive if(hashBlock...) blocks. Now that this is unconditionally updating hashBlock, I think the new logic is equivalent to the following and can be simplified:\r\n\r\n```c++\r\nassert(!wtxIn.isAbandoned()); // Incoming transactions should never have special abandoned block hash\r\nif (wtxIn.hashBlock != wtx.hashBlock) {\r\n    wtx.hashBlock = wtxIn.hashBlock;\r\n    wtx.m_block_height = wtxIn.m_block_height;\r\n    fUpdated = true;\r\n}\r\n```",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T18:53:20Z",
      "diff_hunk" : "@@ -965,12 +965,19 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n         if (!wtxIn.hashUnset() && wtxIn.hashBlock != wtx.hashBlock)\n         {\n             wtx.hashBlock = wtxIn.hashBlock;\n+            wtx.m_block_height = wtxIn.m_block_height;\n+            fUpdated = true;\n+        }\n+        if (wtxIn.hashBlock.IsNull() && !wtx.hashBlock.IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295463739",
      "id" : 295463739,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ2MzczOQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 7,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295463739",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295476638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295476638"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nIt looks like a remaining place where m_block_height is still unset is in [`importprunedfunds`](https://github.com/bitcoin/bitcoin/blob/8a1975586d3cc7f98961581859fd146a632bbd34/src/wallet/rpcdump.cpp#L425-L426). It would probably be good to change that code to call `wtx.SetMerkleBranch` instead of setting members directly.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:06:25Z",
      "diff_hunk" : "@@ -4424,13 +4437,16 @@ CWalletKey::CWalletKey(int64_t nExpires)\n     nTimeExpires = nExpires;\n }\n \n-void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295476638",
      "id" : 295476638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ3NjYzOA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 151,
      "path" : "src/wallet/wallet.cpp",
      "position" : 466,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295476638",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295482350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295482350"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nThere's no particular reason for keeping this height value, is there? I think it'd be cleaner to always represent abandoned transactions with block hash=ABANDON_HASH, block height=-1, index=-1 than to awkwardly make block hash and block height point different places.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:17:00Z",
      "diff_hunk" : "@@ -1152,6 +1161,8 @@ bool CWallet::AbandonTransaction(interfaces::Chain::Lock& locked_chain, const ui\n             // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.nIndex = -1;\n+            // Conflicting height is inherited from ancestor tx",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295482350",
      "id" : 295482350,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ4MjM1MA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 62,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295482350",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295486339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295486339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nThis comment seems out of date since position information is saved regardless. Would just drop it.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:28:03Z",
      "diff_hunk" : "@@ -1090,8 +1097,10 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n             CWalletTx wtx(this, ptx);\n \n             // Get merkle branch if transaction was found in a block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295486339",
      "id" : 295486339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ4NjMzOQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 48,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295486339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295487658"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295487658"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nI don't think this additional text belongs here since it is really commenting on the code calling this function, and not explaining what is happening right here. Would just drop this comment.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:31:41Z",
      "diff_hunk" : "@@ -1090,8 +1097,10 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n             CWalletTx wtx(this, ptx);\n \n             // Get merkle branch if transaction was found in a block\n-            if (!block_hash.IsNull())\n-                wtx.SetMerkleBranch(block_hash, posInBlock);\n+            // Set block_hash to Null, posInBlock to 0, block_height to 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295487658",
      "id" : 295487658,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ4NzY1OA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 51,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295487658",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295493094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295493094"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_block_height field in CMerkleTx\" (8a1975586d3cc7f98961581859fd146a632bbd34)\r\n\r\nNot really related to this PR, but I'm surprised this code is treating `vtxConflicted` transactions as if they are in the mempool and not marking them as conflicted with `nIndex` set to -1, and block hash and height pointing to the conflicting block. Maybe add a TODO here that we could explicitly mark these transactions as being conflicted (have GetDepthInMainChain return negative values instead of 0).",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:46:28Z",
      "diff_hunk" : "@@ -1267,11 +1280,11 @@ void CWallet::BlockConnected(const CBlock& block, const std::vector<CTransaction\n \n     m_last_block_processed_height += 1;\n     for (const CTransactionRef& ptx : vtxConflicted) {\n-        SyncTransaction(ptx, {} /* block hash */, 0 /* position in block */);\n+        SyncTransaction(ptx, {} /* block hash */, 0 /* block height */, 0 /* position in block */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295493094",
      "id" : 295493094,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ5MzA5NA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 110,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295493094",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295495763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295495763"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Restrain waitForNotificationsIfNewBlocksConnected  check to strict tip to avoid race condition\" (6b7962a650def5629eb2f897b6ace79a684c0cf0)\r\n\r\nThis commit seems to be doing two unrelated things: dropping the BlockUntilSyncedToCurrentChain call here and also changing the BlockUntilSyncedToCurrentChain implementation. Would suggest splitting this into two separate commits if possible.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:53:19Z",
      "diff_hunk" : "@@ -94,10 +94,7 @@ static std::set<CWallet*> g_unloading_wallet_set;\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    // Unregister and delete the wallet right after BlockUntilSyncedToCurrentChain\n-    // so that it's in sync with the current chainstate.\n     wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295495763",
      "id" : 295495763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ5NTc2Mw==",
      "original_commit_id" : "6b7962a650def5629eb2f897b6ace79a684c0cf0",
      "original_position" : 7,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295495763",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295496246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295496246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Restrain waitForNotificationsIfNewBlocksConnected  check to strict tip to avoid race condition\" (6b7962a650def5629eb2f897b6ace79a684c0cf0)\r\n\r\nWould suggest renaming `waitForNotificationsIfNewBlocksConnected` to `waitForNotificationsIfTipChanged` to accurately describe the new behavior.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T19:54:26Z",
      "diff_hunk" : "@@ -241,8 +241,7 @@ class Chain\n     virtual std::unique_ptr<Handler> handleNotifications(Notifications& notifications) = 0;\n \n     //! Wait for pending notifications to be processed unless block hash points to the current\n-    //! chain tip, or to a possible descendant of the current chain tip that isn't currently\n-    //! connected.\n+    //! chain tip.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295496246",
      "id" : 295496246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTQ5NjI0Ng==",
      "original_commit_id" : "6b7962a650def5629eb2f897b6ace79a684c0cf0",
      "original_position" : 6,
      "path" : "src/interfaces/chain.h",
      "position" : 29,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295496246",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295501695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295501695"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Use CWallet::m_last_block_processed_height in GetDepthInMainChain\" (233ae92f2d51333f158810d85d13cf63a1144e6b)\r\n\r\nCan we `assert(m_block_height > 0)` after this point? I'm afraid of another bug like the `importprunedfunds` one mentioned earlier leaving m_block_height unset and this function returning bogus values.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T20:08:34Z",
      "diff_hunk" : "@@ -4448,10 +4448,18 @@ void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int b\n \n int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+\n     if (hashUnset())\n         return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295501695",
      "id" : 295501695,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTUwMTY5NQ==",
      "original_commit_id" : "233ae92f2d51333f158810d85d13cf63a1144e6b",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : 477,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295501695",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295505197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295505197"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Use CWallet::m_last_block_processed_height in GetDepthInMainChain\" (233ae92f2d51333f158810d85d13cf63a1144e6b)\r\n\r\nThis looks right but is the logic is kind of obscure. Maybe you could add an explanatory comment like \"If nIndex is -1 and the block hash is set, it means the transaction is conflicted, and that m_block_height will be set to the height of the earliest conflicting block, so can return 0 is that block has been disconnected.\"\r\n\r\nI think it'd also be good to replace nested `if(A) { if (B) return; }` with `if (A && B) { return; } `",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T20:17:54Z",
      "diff_hunk" : "@@ -4448,10 +4448,18 @@ void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int b\n \n int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+\n     if (hashUnset())\n         return 0;\n \n-    return locked_chain.getBlockDepth(hashBlock) * (nIndex == -1 ? -1 : 1);\n+    if (nIndex == -1) {\n+        // Tx is no more conflicted but it's not more confirmed, so return 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295505197",
      "id" : 295505197,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTUwNTE5Nw==",
      "original_commit_id" : "233ae92f2d51333f158810d85d13cf63a1144e6b",
      "original_position" : 12,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295505197",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295508382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295508382"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Add m_last_block_processed_height field in CWallet\" (0284c72ab07362150fd26c86966ea7c7bc6cfed5)\r\n\r\nCan this `assert(m_last_block_processed_height >= 0)`? This would catch usage errors if there are calls to this function before the wallet is initialized.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-06-19T20:25:30Z",
      "diff_hunk" : "@@ -1308,6 +1313,10 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    int GetLastBlockHeight() const { return m_last_block_processed_height; };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295508382",
      "id" : 295508382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5NTUwODM4Mg==",
      "original_commit_id" : "0284c72ab07362150fd26c86966ea7c7bc6cfed5",
      "original_position" : 17,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 251859358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/295508382",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301367213"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm filled at startup using ```getBlockHeight```, given we already have ```hashBlock``` ? Do you envision the wallet to always query chain state to succeed its startup ?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T01:52:58Z",
      "diff_hunk" : "@@ -383,9 +389,10 @@ class CMerkleTx\n         READWRITE(hashBlock);\n         READWRITE(vMerkleBranch);\n         READWRITE(nIndex);\n+        READWRITE(m_block_height);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367213",
      "id" : 301367213,
      "in_reply_to_id" : 295434058,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2NzIxMw==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 24,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 259235521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301367213",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301367411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Updated ```AddToWallet```, hope it's clearer ",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T01:54:08Z",
      "diff_hunk" : "@@ -965,12 +965,19 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n         if (!wtxIn.hashUnset() && wtxIn.hashBlock != wtx.hashBlock)\n         {\n             wtx.hashBlock = wtxIn.hashBlock;\n+            wtx.m_block_height = wtxIn.m_block_height;\n+            fUpdated = true;\n+        }\n+        if (wtxIn.hashBlock.IsNull() && !wtx.hashBlock.IsNull()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367411",
      "id" : 301367411,
      "in_reply_to_id" : 295463739,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2NzQxMQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 7,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259235764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301367411",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368195"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oooops, I forgot this one. I've added a call to ```SetMerkleBranch``` in ```importprunedfunds``` but had to change its argument to hask for transaction height too. Seems to me similar to the serialization issue, do we want wallet to ask chain the state of its stored transactions every time, even it should be able to infer it from the blocks already connected ?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T01:58:59Z",
      "diff_hunk" : "@@ -4424,13 +4437,16 @@ CWalletKey::CWalletKey(int64_t nExpires)\n     nTimeExpires = nExpires;\n }\n \n-void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368195",
      "id" : 301368195,
      "in_reply_to_id" : 295476638,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2ODE5NQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 151,
      "path" : "src/wallet/wallet.cpp",
      "position" : 466,
      "pull_request_review_id" : 259236717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368195",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368385"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be dropped on 1458ded",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:00:16Z",
      "diff_hunk" : "@@ -1090,8 +1097,10 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n             CWalletTx wtx(this, ptx);\n \n             // Get merkle branch if transaction was found in a block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368385",
      "id" : 301368385,
      "in_reply_to_id" : 295486339,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2ODM4NQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 48,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259236975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368385",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368491"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be dropped on 1458ded\r\n",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:00:51Z",
      "diff_hunk" : "@@ -1090,8 +1097,10 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n             CWalletTx wtx(this, ptx);\n \n             // Get merkle branch if transaction was found in a block\n-            if (!block_hash.IsNull())\n-                wtx.SetMerkleBranch(block_hash, posInBlock);\n+            // Set block_hash to Null, posInBlock to 0, block_height to 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368491",
      "id" : 301368491,
      "in_reply_to_id" : 295487658,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2ODQ5MQ==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 51,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259237088,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301368491",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301369291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301369291"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, see 9c07c16",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:06:23Z",
      "diff_hunk" : "@@ -241,8 +241,7 @@ class Chain\n     virtual std::unique_ptr<Handler> handleNotifications(Notifications& notifications) = 0;\n \n     //! Wait for pending notifications to be processed unless block hash points to the current\n-    //! chain tip, or to a possible descendant of the current chain tip that isn't currently\n-    //! connected.\n+    //! chain tip.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301369291",
      "id" : 301369291,
      "in_reply_to_id" : 295496246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM2OTI5MQ==",
      "original_commit_id" : "6b7962a650def5629eb2f897b6ace79a684c0cf0",
      "original_position" : 6,
      "path" : "src/interfaces/chain.h",
      "position" : 29,
      "pull_request_review_id" : 259238012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301369291",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370162"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Splitted between 8a16c67 and 9c07c16",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:11:34Z",
      "diff_hunk" : "@@ -94,10 +94,7 @@ static std::set<CWallet*> g_unloading_wallet_set;\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    // Unregister and delete the wallet right after BlockUntilSyncedToCurrentChain\n-    // so that it's in sync with the current chainstate.\n     wallet->WalletLogPrintf(\"Releasing wallet\\n\");\n-    wallet->BlockUntilSyncedToCurrentChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370162",
      "id" : 301370162,
      "in_reply_to_id" : 295495763,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MDE2Mg==",
      "original_commit_id" : "6b7962a650def5629eb2f897b6ace79a684c0cf0",
      "original_position" : 7,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259238952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370162",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370461"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Commented and updated logic as suggested on 573ca36",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:12:49Z",
      "diff_hunk" : "@@ -4448,10 +4448,18 @@ void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int b\n \n int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+\n     if (hashUnset())\n         return 0;\n \n-    return locked_chain.getBlockDepth(hashBlock) * (nIndex == -1 ? -1 : 1);\n+    if (nIndex == -1) {\n+        // Tx is no more conflicted but it's not more confirmed, so return 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370461",
      "id" : 301370461,
      "in_reply_to_id" : 295505197,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MDQ2MQ==",
      "original_commit_id" : "233ae92f2d51333f158810d85d13cf63a1144e6b",
      "original_position" : 12,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259239177,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370461",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370602"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Check should be there in b1ae297",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:13:42Z",
      "diff_hunk" : "@@ -1308,6 +1313,10 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    int GetLastBlockHeight() const { return m_last_block_processed_height; };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370602",
      "id" : 301370602,
      "in_reply_to_id" : 295508382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MDYwMg==",
      "original_commit_id" : "0284c72ab07362150fd26c86966ea7c7bc6cfed5",
      "original_position" : 17,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 259239323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370602",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370949"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm, I introduced  ```assert(m_block_height >= -1)``` as we may GetDepthInMainChain on fresh transactions, their ```hashBlock``` being unset, their depth should appear as zero.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:15:58Z",
      "diff_hunk" : "@@ -4448,10 +4448,18 @@ void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int b\n \n int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+\n     if (hashUnset())\n         return 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370949",
      "id" : 301370949,
      "in_reply_to_id" : 295501695,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MDk0OQ==",
      "original_commit_id" : "233ae92f2d51333f158810d85d13cf63a1144e6b",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : 477,
      "pull_request_review_id" : 259239738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301370949",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301371748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301371748"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, I did a second round with the following model in head  (state, triplet<hashBlock, nIndex, block_height>) : NEW<{}, -1, -1>, UNCONFIRMED<{}, 0, 0>, CONFIRMED<block_hash, posInBlock, block_height>, ABANDON<ABANDON_HASH, -1, -1>, CONFLICTED<hashBlock, -1, conflicting_height>.\r\nDo you have one similar, should we noted it somewhere ?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:20:32Z",
      "diff_hunk" : "@@ -1152,6 +1161,8 @@ bool CWallet::AbandonTransaction(interfaces::Chain::Lock& locked_chain, const ui\n             // If the orig tx was not in block/mempool, none of its spends can be in mempool\n             assert(!wtx.InMempool());\n             wtx.nIndex = -1;\n+            // Conflicting height is inherited from ancestor tx",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301371748",
      "id" : 301371748,
      "in_reply_to_id" : 295482350,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MTc0OA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 62,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259240595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301371748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301372154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301372154"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, updated on 6289909, maybe I should refine it in its own commit?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-09T02:23:12Z",
      "diff_hunk" : "@@ -1267,11 +1280,11 @@ void CWallet::BlockConnected(const CBlock& block, const std::vector<CTransaction\n \n     m_last_block_processed_height += 1;\n     for (const CTransactionRef& ptx : vtxConflicted) {\n-        SyncTransaction(ptx, {} /* block hash */, 0 /* position in block */);\n+        SyncTransaction(ptx, {} /* block hash */, 0 /* block height */, 0 /* position in block */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301372154",
      "id" : 301372154,
      "in_reply_to_id" : 295493094,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTM3MjE1NA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 110,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 259241075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301372154",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Answered back to @ryanofsky comments on 1458ded, I'm on cleaning last Travis failures",
      "created_at" : "2019-07-09T02:24:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-509461542",
      "id" : 509461542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwOTQ2MTU0Mg==",
      "updated_at" : "2019-07-09T02:24:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/509461542",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r303713964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303713964"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note : I've seen one Travis failure on feature_reindex.py due to the assert. I wasn't able to reproduce it on my local dev env, I think it's caused by Travis really slow setup, but that's not great, what's your take on it ?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-16T03:18:25Z",
      "diff_hunk" : "@@ -1308,6 +1313,10 @@ class CWallet final : public CCryptoKeyStore, private interfaces::Chain::Notific\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    int GetLastBlockHeight() const { return m_last_block_processed_height; };",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r303713964",
      "id" : 303713964,
      "in_reply_to_id" : 295508382,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzcxMzk2NA==",
      "original_commit_id" : "0284c72ab07362150fd26c86966ea7c7bc6cfed5",
      "original_position" : 17,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 262170043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303713964",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306404822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306404822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This line is introduced in a too-early commit (_Add m_last_block_processed_height field in CWallet_) where the member variable _m_block_height_ doesn't yet exist. The _Add m_last_block_processed_height field in CWallet_ commit doesn't build because the variable is not declared.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T16:05:21Z",
      "diff_hunk" : "@@ -4608,36 +4606,48 @@ CWalletKey::CWalletKey(int64_t nExpires)\n     nTimeExpires = nExpires;\n }\n \n-void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;\n }\n \n-int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n+int CMerkleTx::GetDepthInMainChain() const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+    assert(m_block_height >= -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306404822",
      "id" : 306404822,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQwNDgyMg==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 430,
      "path" : "src/wallet/wallet.cpp",
      "position" : 475,
      "pull_request_review_id" : 265517375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306404822",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306413990"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306413990"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this required? the txoutproof includes a block header, which could be used to look up the height in the chain.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T16:24:46Z",
      "diff_hunk" : "@@ -375,6 +375,7 @@ UniValue importprunedfunds(const JSONRPCRequest& request)\n                 {\n                     {\"rawtransaction\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"A raw transaction in hex funding an already-existing address in wallet\"},\n                     {\"txoutproof\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The hex output from gettxoutproof that contains the transaction\"},\n+                    {\"height\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The height in which transaction has been confirmed\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306413990",
      "id" : 306413990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQxMzk5MA==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 4,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 265517375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306413990",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306420045"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306420045"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to move this function declaration.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T16:38:09Z",
      "diff_hunk" : "@@ -864,6 +873,9 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     /** Internal database handle. */\n     std::unique_ptr<WalletDatabase> database;\n \n+    //! Fetches a key from the keypool\n+    bool GetKeyFromPool(CPubKey& key, bool internal = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306420045",
      "id" : 306420045,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQyMDA0NQ==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 166,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 265535761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306420045",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306441436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306441436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can these three lines be replaced by a call to `wtx.SetMerkleBranch()`?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T17:28:34Z",
      "diff_hunk" : "@@ -251,16 +256,17 @@ BOOST_FIXTURE_TEST_CASE(coin_mark_dirty_immature_credit, TestChain100Setup)\n \n     wtx.hashBlock = ::ChainActive().Tip()->GetBlockHash();\n     wtx.nIndex = 0;\n+    wtx.m_block_height = ::ChainActive().Height();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306441436",
      "id" : 306441436,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQ0MTQzNg==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 44,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 265535761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306441436",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306448468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306448468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In _Move CWallet ptr from CWalletTx to CMerkleTx_: is there any point in keeping the `CMerkleTx`/`CWalletTx` division after this? `CMerkleTx` is _only_ used as a base class for _CWalletTx_. It's been around since the first git commit, and I expect Satoshi thought `CMerkleTx` could be useful outside the wallet, but now that it's adding a pointer to the CWallet, it seems redundant to have it as a separate class.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T17:44:28Z",
      "diff_hunk" : "@@ -372,6 +372,9 @@ class CMerkleTx\n   /** Constant used in hashBlock to indicate tx has been abandoned */\n     static const uint256 ABANDON_HASH;\n \n+protected:\n+    const CWallet* pwallet;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306448468",
      "id" : 306448468,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQ0ODQ2OA==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 265535761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306448468",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306459728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306459728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The comment says `An block_height == 0` in commit _Add m_block_height field in CMerkleTx_ and then changes to `A block_height == -1` in _Use CWallet::m_last_block_processed_height in GetDepthInMainChain_.\r\n\r\nIt would be better to not change this in the course of the PR and just set it to `A block_height == -1` in the first PR.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T18:09:53Z",
      "diff_hunk" : "@@ -351,6 +351,11 @@ class CMerkleTx\n      */\n     int nIndex;\n \n+    /* Refers to height of block against which tx is merkle branch linked to\n+     * An block_height == 0 means that tx isn't yet linked to any block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306459728",
      "id" : 306459728,
      "in_reply_to_id" : 295430761,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQ1OTcyOA==",
      "original_commit_id" : "8a1975586d3cc7f98961581859fd146a632bbd34",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 265535761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306459728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306466421"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306466421"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This height accounting in the wallet scares me slightly. I think that prior to this change, the wallet tolerates any bug in the node that sends duplicate `BlockConnected()` or `BlockDisconnected()` calls over the CValidationInterface. After this change, a duplicate `BlockConnected` notification could cause the wallet to get into a very bad inconsistent state.\r\n\r\nIs it possible to update the CValidationInterface to also pass the block height when sending BlockConnected/BlockDisconnected notifications?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-23T18:24:52Z",
      "diff_hunk" : "@@ -1422,12 +1414,13 @@ void CWallet::BlockConnected(const CBlock& block, const std::vector<CTransaction\n     // to abandon a transaction and then have it inadvertently cleared by\n     // the notification that the conflicted transaction was evicted.\n \n+    m_last_block_processed_height += 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306466421",
      "id" : 306466421,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjQ2NjQyMQ==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 186,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 265594064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306466421",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've done a quick code review. The main thing that I'd like to see changed is merging the `CMerkleTx` and `CWalletTx` classes now that `CMerkleTx` is accessing wallet data (see discussion here: http://www.erisian.com.au/bitcoin-core-dev/log-2019-07-23.html#l-322)",
      "created_at" : "2019-07-23T18:26:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514327967",
      "id" : 514327967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDMyNzk2Nw==",
      "updated_at" : "2019-07-23T18:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514327967",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(excellent work, by the way. Great to see some of these locked_chain instances being cleaned up)",
      "created_at" : "2019-07-23T18:28:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514328665",
      "id" : 514328665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDMyODY2NQ==",
      "updated_at" : "2019-07-23T18:28:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514328665",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306958014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306958014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ooops, bad rebase sorry, should be corrected",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-24T18:28:54Z",
      "diff_hunk" : "@@ -4608,36 +4606,48 @@ CWalletKey::CWalletKey(int64_t nExpires)\n     nTimeExpires = nExpires;\n }\n \n-void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CMerkleTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;\n }\n \n-int CMerkleTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n+int CMerkleTx::GetDepthInMainChain() const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+    assert(m_block_height >= -1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306958014",
      "id" : 306958014,
      "in_reply_to_id" : 306404822,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjk1ODAxNA==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 430,
      "path" : "src/wallet/wallet.cpp",
      "position" : 475,
      "pull_request_review_id" : 266205506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306958014",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306961660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306961660"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmmm well we could use `getBlockHeight` again in this function but I didn't want because was planning to remove this Chain method after we move ScanForWalletTransactions and its logic on the node side.\r\n\r\nMaybe that a bit premature, but IMO this RPC should come with all proofs + height without us having to query the chain..",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-24T18:36:57Z",
      "diff_hunk" : "@@ -375,6 +375,7 @@ UniValue importprunedfunds(const JSONRPCRequest& request)\n                 {\n                     {\"rawtransaction\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"A raw transaction in hex funding an already-existing address in wallet\"},\n                     {\"txoutproof\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The hex output from gettxoutproof that contains the transaction\"},\n+                    {\"height\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The height in which transaction has been confirmed\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306961660",
      "id" : 306961660,
      "in_reply_to_id" : 306413990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjk2MTY2MA==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 4,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 266210260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306961660",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306967081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306967081"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See #16451, thanks for going forwad on it :)",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-24T18:48:59Z",
      "diff_hunk" : "@@ -372,6 +372,9 @@ class CMerkleTx\n   /** Constant used in hashBlock to indicate tx has been abandoned */\n     static const uint256 ABANDON_HASH;\n \n+protected:\n+    const CWallet* pwallet;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306967081",
      "id" : 306967081,
      "in_reply_to_id" : 306448468,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjk2NzA4MQ==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 5,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 266217071,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306967081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306995955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306995955"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right, it's far better to rely on message content than counting the message in itself.\r\nTo do, I've extended BlockDisconnected, for BlockConnected we have CBlockIndex it was just masked between Notification and CWallet",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-24T20:01:34Z",
      "diff_hunk" : "@@ -1422,12 +1414,13 @@ void CWallet::BlockConnected(const CBlock& block, const std::vector<CTransaction\n     // to abandon a transaction and then have it inadvertently cleared by\n     // the notification that the conflicted transaction was evicted.\n \n+    m_last_block_processed_height += 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306995955",
      "id" : 306995955,
      "in_reply_to_id" : 306466421,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNjk5NTk1NQ==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 186,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 266253623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/306995955",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed @jnewbery comments on a53586c, except https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306961660 where I'm still thinking on it",
      "created_at" : "2019-07-24T20:03:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514779211",
      "id" : 514779211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDc3OTIxMQ==",
      "updated_at" : "2019-07-24T20:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514779211",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r307006966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/307006966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't like this change for a couple of reasons:\r\n\r\n- it's a breaking change for clients, so they'll need to reimplement their code\r\n- the RPC doesn't do any checking on the `height` value passed, so it's possible to get the wallet into some inconsistent state by passing a bad `height` value.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-07-24T20:30:23Z",
      "diff_hunk" : "@@ -375,6 +375,7 @@ UniValue importprunedfunds(const JSONRPCRequest& request)\n                 {\n                     {\"rawtransaction\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"A raw transaction in hex funding an already-existing address in wallet\"},\n                     {\"txoutproof\", RPCArg::Type::STR_HEX, RPCArg::Optional::NO, \"The hex output from gettxoutproof that contains the transaction\"},\n+                    {\"height\", RPCArg::Type::NUM, RPCArg::Optional::NO, \"The height in which transaction has been confirmed\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r307006966",
      "id" : 307006966,
      "in_reply_to_id" : 306413990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwNzAwNjk2Ng==",
      "original_commit_id" : "8d84bd560865fdf83fc86a05114cbed38789ca7e",
      "original_position" : 4,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : null,
      "pull_request_review_id" : 266268054,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/307006966",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-07-30T05:12:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-516264490",
      "id" : 516264490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjI2NDQ5MA==",
      "updated_at" : "2019-07-30T05:12:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516264490",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/16451 is merged. You should be able to rebase this and remove one of the commits.",
      "created_at" : "2019-07-31T12:07:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-516820571",
      "id" : 516820571,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNjgyMDU3MQ==",
      "updated_at" : "2019-07-31T12:07:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/516820571",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased without CMerkleTx relative commit",
      "created_at" : "2019-08-06T05:19:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518504999",
      "id" : 518504999,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODUwNDk5OQ==",
      "updated_at" : "2019-08-06T05:20:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518504999",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311123565"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure if this macro does anything?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-06T15:19:15Z",
      "diff_hunk" : "@@ -831,7 +836,14 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     uint256 m_last_block_processed GUARDED_BY(cs_wallet);\n \n     //! Fetches a key from the keypool\n-    bool GetKeyFromPool(CPubKey &key, bool internal = false);\n+    bool GetKeyFromPool(CPubKey& key, bool internal = false);\n+\n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates. For safety, we\n+     * initialize it to -1.\n+     */\n+    int m_last_block_processed_height{-1};\n+    GUARDED_BY(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123565",
      "id" : 311123565,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTEyMzU2NQ==",
      "original_commit_id" : "8fa26b2a6864c3347293d62bf29a0c46f54c716a",
      "original_position" : 129,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 271423875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311123565",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311123704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please don't fixup style from surrounding code. It makes the diff less clean.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-06T15:19:32Z",
      "diff_hunk" : "@@ -831,7 +836,14 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     uint256 m_last_block_processed GUARDED_BY(cs_wallet);\n \n     //! Fetches a key from the keypool\n-    bool GetKeyFromPool(CPubKey &key, bool internal = false);\n+    bool GetKeyFromPool(CPubKey& key, bool internal = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123704",
      "id" : 311123704,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTEyMzcwNA==",
      "original_commit_id" : "8fa26b2a6864c3347293d62bf29a0c46f54c716a",
      "original_position" : 122,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 271423875,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311123704",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suggest you reverse the order of the first two commits:\r\n\r\n1. have one commit that _only_ updates the signature of `BlockDiscconected` in the validation interface.\r\n2. the second commit adds `m_last_block_processed_height` and uses the `pindex` in `BlockConnected`/`BlockDisconnected` to set the height.\r\n\r\nHaving one way for setting `m_last_block_processed_height` in the first commit which is replaced by a different way in the second commit makes this confusing for reviewers.",
      "created_at" : "2019-08-06T15:29:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518720861",
      "id" : 518720861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODcyMDg2MQ==",
      "updated_at" : "2019-08-06T15:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518720861",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on reducing reliance on `locked_chain`. It seems worth adding `m_block_height`.  \r\n\r\nI might be more clear to swap the first two (?) commits, thereby introducing `m_last_block_processed_height` without the `+= 1` stuff.\r\n\r\nGetting a bunch of warnings on macOS along these lines:\r\n\r\n```\r\nIn file included from wallet/ismine.cpp:12:\r\n./wallet/wallet.h:846:5: warning: declaration does not declare anything [-Wmissing-declarations]\r\n    GUARDED_BY(cs_wallet);\r\n    ^\r\n./threadsafety.h:18:23: note: expanded from macro 'GUARDED_BY'\r\n#define GUARDED_BY(x) __attribute__((guarded_by(x)))\r\n                      ^\r\nIn file included from wallet/ismine.cpp:12:\r\n./wallet/wallet.h:846:5: warning: attribute guarded_by ignored, because it is not attached to a declaration [-Wignored-attributes]\r\n./threadsafety.h:18:48: note: expanded from macro 'GUARDED_BY'\r\n#define GUARDED_BY(x) __attribute__((guarded_by(x)))\r\n                                               ^\r\n2 warnings generated.\r\n```\r\n\r\nI'm worried that serializing `m_block_height` in `CWalletTx` makes wallets non backwards compatible, but I can't produce a problem (shameless plug for #12134).",
      "created_at" : "2019-08-06T15:39:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518725058",
      "id" : 518725058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODcyNTA1OA==",
      "updated_at" : "2019-08-06T15:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518725058",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311369642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311369642"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I misused some linter scripts I think\r\n\r\n(in fact syntax _variable_ {-1} GUARDED_BY(lock) failed on some compilers compare to _variable_ GUARDED_BY(lock) =  -1) ",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-07T05:04:47Z",
      "diff_hunk" : "@@ -831,7 +836,14 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     uint256 m_last_block_processed GUARDED_BY(cs_wallet);\n \n     //! Fetches a key from the keypool\n-    bool GetKeyFromPool(CPubKey &key, bool internal = false);\n+    bool GetKeyFromPool(CPubKey& key, bool internal = false);\n+\n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates. For safety, we\n+     * initialize it to -1.\n+     */\n+    int m_last_block_processed_height{-1};\n+    GUARDED_BY(cs_wallet);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311369642",
      "id" : 311369642,
      "in_reply_to_id" : 311123565,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTM2OTY0Mg==",
      "original_commit_id" : "8fa26b2a6864c3347293d62bf29a0c46f54c716a",
      "original_position" : 129,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 271730323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311369642",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for review @Sjors, \r\n\r\nI inverted the 2 top commits at 71a053c to ease review.\r\n\r\nAbout `m_block_height` in `CWalletTx`, caching in block height in-memory let us with 2 options at serialization : \r\n* serialize in-memory member too, deserialize it at wallet loading\r\n* query `getBlockHeight` by passing `hashBlock`at `LoadToWallet` called by `ReadKeyValue`\r\n\r\nI tried also to implement 2nd option, but seems to me really inefficient due to the necessity to add another `cs_main` lock in `LoadWallet` for the length of deserialization to preserve locks order.\r\n\r\nIt may need release notes but I think it's move us towards less interdependence between wallet and chain. What's your thoughts ?",
      "created_at" : "2019-08-07T05:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518951928",
      "id" : 518951928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODk1MTkyOA==",
      "updated_at" : "2019-08-07T06:12:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518951928",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311408799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311408799"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's fine to use CBlockIndex pointers in CValidationInterface methods, but Chain::Notification methods should just pass `int height` parameters. Using CBlockIndex here exposes node internals to the wallet and  makes #10102 less efficient because CBlockIndex data would have to be serialized and sent across a socket.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-07T07:39:32Z",
      "diff_hunk" : "@@ -224,8 +221,8 @@ class Chain\n         virtual ~Notifications() {}\n         virtual void TransactionAddedToMempool(const CTransactionRef& tx) {}\n         virtual void TransactionRemovedFromMempool(const CTransactionRef& ptx) {}\n-        virtual void BlockConnected(const CBlock& block, const std::vector<CTransactionRef>& tx_conflicted) {}\n-        virtual void BlockDisconnected(const CBlock& block) {}\n+        virtual void BlockConnected(const CBlock& block, const std::vector<CTransactionRef>& tx_conflicted, const CBlockIndex* index) {}\n+        virtual void BlockDisconnected(const CBlock& block, const CBlockIndex* index) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311408799",
      "id" : 311408799,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMTQwODc5OQ==",
      "original_commit_id" : "71a053ca85c64a0e9aeb18b1a6875104c9c5efc5",
      "original_position" : 26,
      "path" : "src/interfaces/chain.h",
      "position" : null,
      "pull_request_review_id" : 271779183,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/311408799",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Changing wallet serialization makes this PR more complicated to understand and test, and is something that can complicate wallet design going forward by increasing the number of data formats we have to think about staying compatible with.\r\n\r\nNote that `mapValue` can be used to change `WalletTx` serialization in a backwards-compatible way. It's a key-value store that anything can be written to/read from. Take a look at the `ReadOrderPos()`/`WriteOrderPos()` for an example of a parameter being written/read from the `mapValue` store.\r\n\r\n@ryanofsky - how can we be sure that if we add a `getBlockHeight()` call for every tx in the wallet, we won't introduce a performance regression for very large wallets?",
      "created_at" : "2019-08-07T12:55:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519083686",
      "id" : 519083686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTA4MzY4Ng==",
      "updated_at" : "2019-08-07T12:55:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519083686",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ryanofsky - how can we be sure that if we add a getBlockHeight() call for every tx in the wallet, we won't introduce a performance regression for very large wallets?\r\n\r\nI don't think we can be sure without measuring. I would say if there is a performance regression, I think it would be better to handle in a followup PR that's only changing the serialization and avoiding getBlockHeight() calls, and not changing serialization along with the other things that already have to change here.\r\n\r\nThe reason I'm skeptical there would be a performance regression is that we're talking about adding a single map lookup in a loop which is already doing multiple allocations, map insertions, disk reads, and deserialization, and with the whole loop preceding a rescan. I wouldn't be shocked to see a difference, but I would be surprised to see a difference, and wouldn't want to make the wallet format more complicated and inconsistent, just for the possibility that a difference might exist.\r\n\r\n> Note that mapValue can be used to change WalletTx serialization in a backwards-compatible way. \r\n\r\nChanging the serialization in a backward compatible way would probably be good, but would create some risk for the future (especially without #12134) that we write new code that assumes data is present and seems to work on new wallets, but then turns out not to work on old wallets.",
      "created_at" : "2019-08-07T13:34:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519099417",
      "id" : 519099417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTA5OTQxNw==",
      "updated_at" : "2019-08-07T13:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519099417",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "To be sure, if there is reason to think changing serialization will soup up the wallet, please don't let me stand in the way. My reaction isn't \"please don't do this\", just \"why wouldn't you want to mess with this if you didn't have to?\"",
      "created_at" : "2019-08-07T14:00:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519110546",
      "id" : 519110546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTExMDU0Ng==",
      "updated_at" : "2019-08-07T14:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519110546",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Loading large wallets after initialization will need to lock cs_main to deserialize their txn, which maybe a performance regression. Removing chain lock in the wallet would make it better but still be a hit.\r\n\r\nBut agree, this PR is already big enough, I will change for 2nd option, and let's talk about safe serialization in another one, if needed and after more thoughts.",
      "created_at" : "2019-08-07T14:23:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519120238",
      "id" : 519120238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTEyMDIzOA==",
      "updated_at" : "2019-08-07T14:24:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519120238",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ryanofsky in fact I just realized we may have to take 1st option, `bitcoin-wallet` binary load a wallet and can't get its chain interface..\r\n\r\nDo you see a 3rd option beyond the 2 I've mentioned ?",
      "created_at" : "2019-08-07T18:43:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519221758",
      "id" : 519221758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTIyMTc1OA==",
      "updated_at" : "2019-08-07T18:43:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519221758",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @ryanofsky in fact I just realized we may have to take 1st option, `bitcoin-wallet` binary load a wallet and can't get its chain interface..\r\n> \r\n> Do you see a 3rd option beyond the 2 I've mentioned ?\r\n\r\nJust skip this if interfaces::Chain* pointer is null. Bitcoin-wallet won't do anything that requires knowing the block height of transactions in the wallet.",
      "created_at" : "2019-08-07T19:26:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519236266",
      "id" : 519236266,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTIzNjI2Ng==",
      "updated_at" : "2019-08-07T19:26:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519236266",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Just skip this if interfaces::Chain* pointer is null.\r\n\r\nThat makes sense, though maybe make that more explicit?",
      "created_at" : "2019-08-08T09:03:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519434221",
      "id" : 519434221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTQzNDIyMQ==",
      "updated_at" : "2019-08-08T09:03:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519434221",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, I've beefed up comments on this, tell me it's enough (see in `CWallet::Verify` and `CWallet::LoadWallet`)\r\n\r\nThe query-chain-to-know-height approach makes compatibility not an issue, and doesn't block us to go forward with tx height serialization later . A caveat, right now, it has to lock chain for the whole deserialization period to preserve lock order. This inefficiency should go away when we remove chain locks in wallet (hopefully soon).\r\n\r\nPlease notify a diff in `AddToWallet` since last review, where we now also check block height of incoming transaction against its old version. Reason is when we load wallet while reindexing, `getBlockHeight` is not going to find block, so even if tx block hash doesn't change, we need to correct its height when we get block notification (`BlockConnected`) after reindex is done.\r\n\r\nAlso, I didn't pollute wallet db code path by passing the chain lock, as this one may be null in case of wallet tool and lock can be taken recursively without issue. Instead, we check again in `LoadToWallet` with the added method `hasChain` to know if we can query chain state safely.",
      "created_at" : "2019-08-08T17:05:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519605528",
      "id" : 519605528,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTYwNTUyOA==",
      "updated_at" : "2019-08-08T17:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519605528",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm annotated `GetDepthInMainChain` with a `NO_THREAD_SAFETY_ANALYSIS` right now to avoid member access into incomplete type (same as `GetConflicts` and `GetAvailableCredit`). If anyone has an idea how to resolve them smoothly, I will  take it.",
      "created_at" : "2019-08-08T17:38:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519617268",
      "id" : 519617268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTYxNzI2OA==",
      "updated_at" : "2019-08-08T17:38:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519617268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added a `GetDepthInMainChain()` call back into `SubmitMemoryPoolAndRelay()` in #16557. I think we probably want to get that log fix in first and rebase this PR on top of that (with the _Remove locked_chain from GetDepthInMainChain and its callers_ commit updated to remove _locked_chain_ from `SubmitMemoryPoolAndRelay()`)",
      "created_at" : "2019-08-09T15:18:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519958907",
      "id" : 519958907,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15931",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxOTk1ODkwNw==",
      "updated_at" : "2019-08-09T15:18:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/519958907",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312547306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312547306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: place this new data member immediately next to `m_last_block_processed`. The comment for both need to emphasize that this block hash/height is for the **node's** tip and doesn't indicate that the wallet has scanned up to this hash/height.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T16:02:44Z",
      "diff_hunk" : "@@ -833,6 +845,12 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     //! Fetches a key from the keypool\n     bool GetKeyFromPool(CPubKey &key, bool internal = false);\n \n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates. For safety, we\n+     * initialize it to -1.\n+     */\n+    int m_last_block_processed_height GUARDED_BY(cs_wallet) = -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312547306",
      "id" : 312547306,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjU0NzMwNg==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 113,
      "path" : "src/wallet/wallet.h",
      "position" : 114,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312547306",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312568142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312568142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this new assert is right. A user might 'abandon' a transaction and it later be relayed or confirmed in a block.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T17:01:00Z",
      "diff_hunk" : "@@ -1118,16 +1115,12 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n     bool fUpdated = false;\n     if (!fInsertedNew)\n     {\n-        // Merge\n-        if (!wtxIn.hashUnset() && wtxIn.hashBlock != wtx.hashBlock)\n-        {\n-            wtx.hashBlock = wtxIn.hashBlock;\n-            fUpdated = true;\n-        }\n-        // If no longer abandoned, update\n-        if (wtxIn.hashBlock.IsNull() && wtx.isAbandoned())\n-        {\n+        assert(!wtxIn.isAbandoned()); // Incoming transactions should never have special abandoned block hash",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312568142",
      "id" : 312568142,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjU2ODE0Mg==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 42,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312568142",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312570526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312570526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: add comment on why a chain might not be available. I think this is only the case in the wallettool.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T17:07:52Z",
      "diff_hunk" : "@@ -1180,9 +1173,14 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n     return true;\n }\n \n-void CWallet::LoadToWallet(const CWalletTx& wtxIn)\n+void CWallet::LoadToWallet(CWalletTx& wtxIn)\n {\n     uint256 hash = wtxIn.GetHash();\n+    Optional<int> block_height = MakeOptional(false, int());\n+    if (hasChain()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312570526",
      "id" : 312570526,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjU3MDUyNg==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312570526",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312576506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312576506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don'd understand why you've removed this conditional (I think it's because you want to set the tx's block height to 0 (https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301371748), but I don't understand why you want to do that).\r\n\r\nIn general, I think it'd be easier if `hashBlock`, `nIndex` and `m_block_height` were added to a struct along with an `tx_state` enum which could take `UNCONFIRMED`, `CONFIRMED`, `CONFLICTED` or `ABANDONED`. I think these magic values in `nIndex` are confusing and should only be dealt with by the serialization/deserialization code.\r\n\r\nEDIT: if you do add that struct, consider using it as an argument for `SyncTransaction()` and `AddToWalletIfInvolvingMe()`.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T17:24:17Z",
      "diff_hunk" : "@@ -1248,9 +1246,7 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n \n             CWalletTx wtx(this, ptx);\n \n-            // Get merkle branch if transaction was found in a block\n-            if (!block_hash.IsNull())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312576506",
      "id" : 312576506,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjU3NjUwNg==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 97,
      "path" : "src/wallet/wallet.cpp",
      "position" : 87,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312576506",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312611972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312611972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think an alternative would be to reset the `hashBlock`, `nIndex` and `m_block_height` for all transactions matching the block hash when a `BlockDisconnected` is received. That would involve iterating through all of the wallet txs to check their `hashBlock`s. Re-orgs are supposed to be pretty rare, so I think that's ok. Thoughts?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T19:03:11Z",
      "diff_hunk" : "@@ -4628,36 +4651,49 @@ CKeyPool::CKeyPool(const CPubKey& vchPubKeyIn, bool internalIn)\n     m_pre_split = false;\n }\n \n-void CWalletTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CWalletTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;\n }\n \n-int CWalletTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n+int CWalletTx::GetDepthInMainChain() const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+    AssertLockHeld(pwallet->cs_wallet);\n+    assert(m_block_height >= -1);\n     if (hashUnset())\n         return 0;\n \n-    return locked_chain.getBlockDepth(hashBlock) * (nIndex == -1 ? -1 : 1);\n+    // If nIndex is -1 and the block hash is set, it means the transaction is conflicted, and that m_block_height",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312611972",
      "id" : 312611972,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjYxMTk3Mg==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 490,
      "path" : "src/wallet/wallet.cpp",
      "position" : 480,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312611972",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312613808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312613808"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand why this has to be removed. Can you add some more detail to the commit log?\r\n\r\n(I think the current commit log \"Scheduler thread servicing chain state is stopped before wallet unloading and can't be useful\" isn't right. `ReleaseWallet()` is the delete expression for the CWallet shared_ptr, and so is called for example when the wallet is unloaded during runtime.)",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T19:09:14Z",
      "diff_hunk" : "@@ -98,10 +98,7 @@ static std::set<CWallet*> g_unloading_wallet_set;\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    // Unregister and delete the wallet right after BlockUntilSyncedToCurrentChain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312613808",
      "id" : 312613808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjYxMzgwOA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312613808",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312622408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312622408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is a change in behaviour. The was previously (current tip height) - (height of block with conflicting tx). This is now just (height of block with conflicting tx).",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-09T19:38:10Z",
      "diff_hunk" : "@@ -1332,12 +1329,12 @@ bool CWallet::AbandonTransaction(interfaces::Chain::Lock& locked_chain, const ui\n     return true;\n }\n \n-void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n+void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, const uint256& hashTx)\n {\n     auto locked_chain = chain().lock();\n     LOCK(cs_wallet);\n \n-    int conflictconfirms = -locked_chain->getBlockDepth(hashBlock);\n+    int conflictconfirms = -conflicting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312622408",
      "id" : 312622408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjYyMjQwOA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 161,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 273228460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312622408",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313034668"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313034668"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, had a comment about it, it doesn't imply that the wallet has seen all blocks since genesis up until `m_last_block_processed_height`",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-12T17:19:13Z",
      "diff_hunk" : "@@ -833,6 +845,12 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     //! Fetches a key from the keypool\n     bool GetKeyFromPool(CPubKey &key, bool internal = false);\n \n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates. For safety, we\n+     * initialize it to -1.\n+     */\n+    int m_last_block_processed_height GUARDED_BY(cs_wallet) = -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313034668",
      "id" : 313034668,
      "in_reply_to_id" : 312547306,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzAzNDY2OA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 113,
      "path" : "src/wallet/wallet.h",
      "position" : 114,
      "pull_request_review_id" : 273833477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313034668",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313052247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313052247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "After reading again about how to use abandontransaction, I think you're right, tx might be not in a block or not in your mempool so you can flag is as abandoned. But after this, it can still being included as part of other peers mempools. Removed it, was suggested here initially https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295463739",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-12T17:58:40Z",
      "diff_hunk" : "@@ -1118,16 +1115,12 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n     bool fUpdated = false;\n     if (!fInsertedNew)\n     {\n-        // Merge\n-        if (!wtxIn.hashUnset() && wtxIn.hashBlock != wtx.hashBlock)\n-        {\n-            wtx.hashBlock = wtxIn.hashBlock;\n-            fUpdated = true;\n-        }\n-        // If no longer abandoned, update\n-        if (wtxIn.hashBlock.IsNull() && wtx.isAbandoned())\n-        {\n+        assert(!wtxIn.isAbandoned()); // Incoming transactions should never have special abandoned block hash",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313052247",
      "id" : 313052247,
      "in_reply_to_id" : 312568142,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzA1MjI0Nw==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 42,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 273854789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313052247",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313056664"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313056664"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Okay, this point is already mentioned in commit message, `Verify` and `LoadWallet` but added also on this place.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-12T18:09:09Z",
      "diff_hunk" : "@@ -1180,9 +1173,14 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n     return true;\n }\n \n-void CWallet::LoadToWallet(const CWalletTx& wtxIn)\n+void CWallet::LoadToWallet(CWalletTx& wtxIn)\n {\n     uint256 hash = wtxIn.GetHash();\n+    Optional<int> block_height = MakeOptional(false, int());\n+    if (hasChain()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313056664",
      "id" : 313056664,
      "in_reply_to_id" : 312570526,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzA1NjY2NA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 273860373,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313056664",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313066785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313066785"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for this one, in fact after thinking of it, that would be a bug if you have multiple conflicting txn, you would pick up the one with the highest height instead of the highest depth so not the most conflicting one..",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-12T18:31:37Z",
      "diff_hunk" : "@@ -1332,12 +1329,12 @@ bool CWallet::AbandonTransaction(interfaces::Chain::Lock& locked_chain, const ui\n     return true;\n }\n \n-void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n+void CWallet::MarkConflicted(const uint256& hashBlock, int conflicting_height, const uint256& hashTx)\n {\n     auto locked_chain = chain().lock();\n     LOCK(cs_wallet);\n \n-    int conflictconfirms = -locked_chain->getBlockDepth(hashBlock);\n+    int conflictconfirms = -conflicting_height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313066785",
      "id" : 313066785,
      "in_reply_to_id" : 312622408,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzA2Njc4NQ==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 161,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 273872772,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313066785",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314509181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314509181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Gone this way, see https://github.com/bitcoin/bitcoin/pull/16624",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T21:36:29Z",
      "diff_hunk" : "@@ -1248,9 +1246,7 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, const uint256\n \n             CWalletTx wtx(this, ptx);\n \n-            // Get merkle branch if transaction was found in a block\n-            if (!block_hash.IsNull())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314509181",
      "id" : 314509181,
      "in_reply_to_id" : 312576506,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUwOTE4MQ==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 97,
      "path" : "src/wallet/wallet.cpp",
      "position" : 87,
      "pull_request_review_id" : 275683243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314509181",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314510848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314510848"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes I've thought about while working on the rescan logic. I've introduced a `Rewind` callback in the `Chain::Notifications`, it should call a wallet method to zeroed out cleanly tx `hashBlock`, `nIndex` and `m_block_height`. I've proposed to introduce in this future-PR, this one is already wide enough.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T21:41:53Z",
      "diff_hunk" : "@@ -4628,36 +4651,49 @@ CKeyPool::CKeyPool(const CPubKey& vchPubKeyIn, bool internalIn)\n     m_pre_split = false;\n }\n \n-void CWalletTx::SetMerkleBranch(const uint256& block_hash, int posInBlock)\n+void CWalletTx::SetMerkleBranch(const uint256& block_hash, int posInBlock, int block_height)\n {\n     // Update the tx's hashBlock\n     hashBlock = block_hash;\n \n     // set the position of the transaction in the block\n     nIndex = posInBlock;\n+\n+    // set tx height\n+    m_block_height = block_height;\n }\n \n-int CWalletTx::GetDepthInMainChain(interfaces::Chain::Lock& locked_chain) const\n+int CWalletTx::GetDepthInMainChain() const\n {\n+    if (pwallet == nullptr)\n+        return 0;\n+    AssertLockHeld(pwallet->cs_wallet);\n+    assert(m_block_height >= -1);\n     if (hashUnset())\n         return 0;\n \n-    return locked_chain.getBlockDepth(hashBlock) * (nIndex == -1 ? -1 : 1);\n+    // If nIndex is -1 and the block hash is set, it means the transaction is conflicted, and that m_block_height",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314510848",
      "id" : 314510848,
      "in_reply_to_id" : 312611972,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUxMDg0OA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 490,
      "path" : "src/wallet/wallet.cpp",
      "position" : 480,
      "pull_request_review_id" : 275685267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314510848",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314516068"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've run tests again, can't remember but I had a test staling some point which was solved by this, I think I may have introduce a height error at some point which would false `waitForNotificationsIfTipChanged` and later corrected it without realizing it would fix this. Drop this commit.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T21:59:12Z",
      "diff_hunk" : "@@ -98,10 +98,7 @@ static std::set<CWallet*> g_unloading_wallet_set;\n // Custom deleter for shared_ptr<CWallet>.\n static void ReleaseWallet(CWallet* wallet)\n {\n-    // Unregister and delete the wallet right after BlockUntilSyncedToCurrentChain",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516068",
      "id" : 314516068,
      "in_reply_to_id" : 312613808,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUxNjA2OA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 275691648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:14:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314516068",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314516784"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3a04cd6776f7f1ec86cad20de90c9fbb24655536\r\n\r\nnit, could drop `&` from 1st argument, it was discussed elsewhere that smart pointers and iterators should be used as value.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T22:01:48Z",
      "diff_hunk" : "@@ -114,7 +114,7 @@ class CValidationInterface {\n      *\n      * Called on a background thread.\n      */\n-    virtual void BlockDisconnected(const std::shared_ptr<const CBlock> &block) {}\n+    virtual void BlockDisconnected(const std::shared_ptr<const CBlock>& block, const CBlockIndex* pindex) {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516784",
      "id" : 314516784,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUxNjc4NA==",
      "original_commit_id" : "3a04cd6776f7f1ec86cad20de90c9fbb24655536",
      "original_position" : 5,
      "path" : "src/validationinterface.h",
      "position" : 5,
      "pull_request_review_id" : 275692610,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314516784",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314517774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314517774"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3d32a691d2df4c73a39a64a5d331c29b5eb94213\r\n\r\nIs this a bugfix?",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T22:05:32Z",
      "diff_hunk" : "@@ -1442,9 +1443,12 @@ void CWallet::BlockDisconnected(const CBlock& block, int height)\n     auto locked_chain = chain().lock();\n     LOCK(cs_wallet);\n \n+    m_last_block_processed_height = height - 1;\n     for (const CTransactionRef& ptx : block.vtx) {\n         SyncTransaction(ptx, {} /* block hash */, 0 /* position in block */);\n     }\n+\n+    m_last_block_processed = block.hashPrevBlock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314517774",
      "id" : 314517774,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUxNzc3NA==",
      "original_commit_id" : "3d32a691d2df4c73a39a64a5d331c29b5eb94213",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : 231,
      "pull_request_review_id" : 275692610,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314517774",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314521199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314521199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3d32a691d2df4c73a39a64a5d331c29b5eb94213\r\n\r\nWhy isn't this named `SetLastBlockProcessedHeight`?\r\n\r\nAnyway I think the variable should be `m_chain_tip_height`. Also, I think now `m_last_block_processed` should be improved, like:\r\n```cpp\r\n    uint256 m_chain_tip_hash GUARDED_BY(cs_wallet);\r\n    int m_chain_tip_height GUARDED_BY(cs_wallet){-1};\r\n```\r\nand both should be set at once.\r\n",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-15T22:18:58Z",
      "diff_hunk" : "@@ -1356,6 +1363,19 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    /** Get last block processed height */\n+    int GetLastBlockHeight() const EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)\n+    {\n+        AssertLockHeld(cs_wallet);\n+        return m_last_block_processed_height;\n+    };\n+    /** Set last block processed height, currently only use in unit test */\n+    void SetLastBlockHeight(int block_height) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314521199",
      "id" : 314521199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDUyMTE5OQ==",
      "original_commit_id" : "b75a18f8a3f54049a7daf18e85adaec2da0801ad",
      "original_position" : 26,
      "path" : "src/wallet/wallet.h",
      "position" : 172,
      "pull_request_review_id" : 275692610,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-15T22:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314521199",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315242405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315242405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Agree for the name of method and set at once, but not sure for variables. I think it would be confusing, as intent of this PR is to let the wallet have its own view of what chain tip is after processing block from validation interface. So real chain tip and the wallet one may diverge.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T14:31:48Z",
      "diff_hunk" : "@@ -1356,6 +1363,19 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    /** Get last block processed height */\n+    int GetLastBlockHeight() const EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)\n+    {\n+        AssertLockHeld(cs_wallet);\n+        return m_last_block_processed_height;\n+    };\n+    /** Set last block processed height, currently only use in unit test */\n+    void SetLastBlockHeight(int block_height) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315242405",
      "id" : 315242405,
      "in_reply_to_id" : 314521199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI0MjQwNQ==",
      "original_commit_id" : "b75a18f8a3f54049a7daf18e85adaec2da0801ad",
      "original_position" : 26,
      "path" : "src/wallet/wallet.h",
      "position" : 172,
      "pull_request_review_id" : 276599944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T14:31:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315242405",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315246890"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315246890"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah these would be from the wallet POV.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T14:40:06Z",
      "diff_hunk" : "@@ -1356,6 +1363,19 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n \n     /** Implement lookup of key origin information through wallet key metadata. */\n     bool GetKeyOrigin(const CKeyID& keyid, KeyOriginInfo& info) const override;\n+\n+    /** Get last block processed height */\n+    int GetLastBlockHeight() const EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)\n+    {\n+        AssertLockHeld(cs_wallet);\n+        return m_last_block_processed_height;\n+    };\n+    /** Set last block processed height, currently only use in unit test */\n+    void SetLastBlockHeight(int block_height) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315246890",
      "id" : 315246890,
      "in_reply_to_id" : 314521199,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI0Njg5MA==",
      "original_commit_id" : "b75a18f8a3f54049a7daf18e85adaec2da0801ad",
      "original_position" : 26,
      "path" : "src/wallet/wallet.h",
      "position" : 172,
      "pull_request_review_id" : 276605479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T14:40:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315246890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315250728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315250728"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes it was a bugfix compare to a53586c at least, it became obvious only after switching to query the chain based on block hash at wallet loading!",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T14:46:40Z",
      "diff_hunk" : "@@ -1442,9 +1443,12 @@ void CWallet::BlockDisconnected(const CBlock& block, int height)\n     auto locked_chain = chain().lock();\n     LOCK(cs_wallet);\n \n+    m_last_block_processed_height = height - 1;\n     for (const CTransactionRef& ptx : block.vtx) {\n         SyncTransaction(ptx, {} /* block hash */, 0 /* position in block */);\n     }\n+\n+    m_last_block_processed = block.hashPrevBlock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315250728",
      "id" : 315250728,
      "in_reply_to_id" : 314517774,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI1MDcyOA==",
      "original_commit_id" : "3d32a691d2df4c73a39a64a5d331c29b5eb94213",
      "original_position" : 17,
      "path" : "src/wallet/wallet.cpp",
      "position" : 231,
      "pull_request_review_id" : 276610164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T14:46:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315250728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315291853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315291853"
         }
      },
      "author_association" : "NONE",
      "body" : "If I'm reading @jnewbery's comment correctly, part of the documentation for `m_last_block_processed` and `m_last_block_processed_height` can be shared.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T16:06:36Z",
      "diff_hunk" : "@@ -833,6 +845,12 @@ class CWallet final : public FillableSigningProvider, private interfaces::Chain:\n     //! Fetches a key from the keypool\n     bool GetKeyFromPool(CPubKey &key, bool internal = false);\n \n+    /* Height of last block processed is used by wallet to know depth of transactions\n+     * without relying on Chain interface beyond asynchronous updates. For safety, we\n+     * initialize it to -1.\n+     */\n+    int m_last_block_processed_height GUARDED_BY(cs_wallet) = -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315291853",
      "id" : 315291853,
      "in_reply_to_id" : 312547306,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5MTg1Mw==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 113,
      "path" : "src/wallet/wallet.h",
      "position" : 114,
      "pull_request_review_id" : 276662148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T18:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315291853",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315294228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315294228"
         }
      },
      "author_association" : "NONE",
      "body" : "Would it be possible to set `m_last_block_processed_height` when setting `m_last_block_processed` below? Or does the intermediary calls rely on the value of either?\r\n\r\nSimilarly for `CWallet::BlockDisconnected`.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T16:12:20Z",
      "diff_hunk" : "@@ -1425,6 +1425,7 @@ void CWallet::BlockConnected(const CBlock& block, const std::vector<CTransaction\n     // to abandon a transaction and then have it inadvertently cleared by\n     // the notification that the conflicted transaction was evicted.\n \n+    m_last_block_processed_height = height;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315294228",
      "id" : 315294228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5NDIyOA==",
      "original_commit_id" : "b75a18f8a3f54049a7daf18e85adaec2da0801ad",
      "original_position" : 4,
      "path" : "src/wallet/wallet.cpp",
      "position" : 204,
      "pull_request_review_id" : 276662148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T18:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315294228",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315340601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315340601"
         }
      },
      "author_association" : "NONE",
      "body" : "Nits:\r\n\r\n1. Consider rewording for succinctness and clarity: Height of block against which tx is linked via a merkle branch.\r\n2. End each sentence with a period as they tend to blend when reading the comment.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T18:05:17Z",
      "diff_hunk" : "@@ -488,6 +489,11 @@ class CWalletTx\n      */\n     int nIndex;\n \n+    /* Refers to height of block against which tx is merkle branch linked to",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315340601",
      "id" : 315340601,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTM0MDYwMQ==",
      "original_commit_id" : "a9b7592ce9765cb8fcaa5b98debfc6cc7284b72b",
      "original_position" : 14,
      "path" : "src/wallet/wallet.h",
      "position" : 14,
      "pull_request_review_id" : 276662148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T18:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315340601",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315347964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315347964"
         }
      },
      "author_association" : "NONE",
      "body" : "Instead of initializing an `Optional<int>` then conditionally assigning it based on the result of `hasChain()`, could you instead define something like `chainHeight()` to return an `Optional<int>`? This would hide the chain logic from `LoadToWallet()`.\r\n\r\nIf not, consider directly assigning `0` to `wtxIn.m_block_height` and conditionally updating it based on `hasChain()`. The addition of `Optional<int>` here just seems to add indirection for the reader.",
      "commit_id" : "8078da35c608829834df877a431f7b0d71820209",
      "created_at" : "2019-08-19T18:23:01Z",
      "diff_hunk" : "@@ -1180,9 +1173,14 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFlushOnClose)\n     return true;\n }\n \n-void CWallet::LoadToWallet(const CWalletTx& wtxIn)\n+void CWallet::LoadToWallet(CWalletTx& wtxIn)\n {\n     uint256 hash = wtxIn.GetHash();\n+    Optional<int> block_height = MakeOptional(false, int());\n+    if (hasChain()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315347964",
      "id" : 315347964,
      "in_reply_to_id" : 312570526,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTM0Nzk2NA==",
      "original_commit_id" : "0233a55a71b9ade7e65d26ef6ce718a761e4389b",
      "original_position" : 60,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 276662148,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15931",
      "updated_at" : "2019-08-19T18:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315347964",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   }
]
