[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r281782731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281782731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit: Why shuffle the includes for no reason?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-07T18:53:19Z",
      "diff_hunk" : "@@ -34,7 +35,6 @@\n #include <timedata.h>\n #include <tinyformat.h>\n #include <txdb.h>\n-#include <txmempool.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r281782731",
      "id" : 281782731,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTc4MjczMQ==",
      "original_commit_id" : "0f7a07c4a455be9bfe6197ae4fc3b5edaba7e277",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 234700228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281782731",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r281783295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281783295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, will fix.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-07T18:54:52Z",
      "diff_hunk" : "@@ -34,7 +35,6 @@\n #include <timedata.h>\n #include <tinyformat.h>\n #include <txdb.h>\n-#include <txmempool.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r281783295",
      "id" : 281783295,
      "in_reply_to_id" : 281782731,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTc4MzI5NQ==",
      "original_commit_id" : "0f7a07c4a455be9bfe6197ae4fc3b5edaba7e277",
      "original_position" : 12,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 234701028,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281783295",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15981](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15981.html) (Use __func__ for log messages by Bushstar)\n* [#15759](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15759.html) ([p2p] Add 2 outbound blocks-only connections by sdaftuar)\n* [#15192](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15192.html) (Add missing cs_main locks in ThreadImport(...)/Shutdown(...)/gettxoutsetinfo(...)/InitScriptExecutionCache(). Add missing locking annotations. by practicalswift)\n* [#15191](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15191.html) (validation: Add missing cs_{LastBlockFile,nBlockSequenceId} locks in PruneAndFlush() and UnloadBlockIndex(). Add missing locking annotations. by practicalswift)\n* [#14856](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14856.html) (net: remove more CConnman globals (theuni) by dongcarl)\n* [#14193](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14193.html) (validation: Add missing mempool locks by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-05-07T22:50:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490282681",
      "id" : 490282681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDI4MjY4MQ==",
      "updated_at" : "2019-05-14T13:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490282681",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r282111893"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282111893"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Does this implementation really need to be in the header?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-08T15:09:48Z",
      "diff_hunk" : "@@ -422,6 +422,195 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+/** @see CChainState::FlushStateToDisk */\n+enum class FlushStateMode {\n+    NONE,\n+    IF_NEEDED,\n+    PERIODIC,\n+    ALWAYS\n+};\n+\n+struct CBlockIndexWorkComparator\n+{\n+    bool operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r282111893",
      "id" : 282111893,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjExMTg5Mw==",
      "original_commit_id" : "65e22684281996ee49889642c745143e99736ae2",
      "original_position" : 60,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 235115884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282111893",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I dislike that member functions that previously could (and should) only be called in the validation module are now callable from anywhere. To make it worse, they are easily confused e.g. `::ActivateBestChain` vs `CChainState::ActivateBestChain`. The only solution I could think of is to mark the public methods that are not supposed to be called outside of validation with an underscore or something (similar to python).",
      "created_at" : "2019-05-08T16:30:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490557315",
      "id" : 490557315,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDU1NzMxNQ==",
      "updated_at" : "2019-05-08T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490557315",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "An alternative could be to remove the global methods (e.g. `::ActivateBestChain`) and inline them into the members?",
      "created_at" : "2019-05-08T16:36:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490559432",
      "id" : 490559432,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDU1OTQzMg==",
      "updated_at" : "2019-05-08T16:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490559432",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r282162424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282162424"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The method implementation doesn't, but the struct declaration does because it affects the layout of CChainState objects.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-08T17:11:53Z",
      "diff_hunk" : "@@ -422,6 +422,195 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+/** @see CChainState::FlushStateToDisk */\n+enum class FlushStateMode {\n+    NONE,\n+    IF_NEEDED,\n+    PERIODIC,\n+    ALWAYS\n+};\n+\n+struct CBlockIndexWorkComparator\n+{\n+    bool operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r282162424",
      "id" : 282162424,
      "in_reply_to_id" : 282111893,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjE2MjQyNA==",
      "original_commit_id" : "65e22684281996ee49889642c745143e99736ae2",
      "original_position" : 60,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 235180228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282162424",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> could (and should) only be called in the validation module are now callable from anywhere\r\n\r\nWould you say the root cause of that is that ::ChainstateActive is global? Maybe we can make that only available through interfaces? There's not that many places we access member functions from.",
      "created_at" : "2019-05-08T17:15:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490572428",
      "id" : 490572428,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDU3MjQyOA==",
      "updated_at" : "2019-05-08T17:15:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490572428",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Would you say the root cause of that is that ::ChainstateActive is global?\r\n\r\nAlso, `chainActive`, `mapBlockIndex`, .... I fail to see how an interface could help here. Shouldn't `CChainState` be the interface?",
      "created_at" : "2019-05-08T17:26:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490576375",
      "id" : 490576375,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDU3NjM3NQ==",
      "updated_at" : "2019-05-08T17:26:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490576375",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> An alternative could be to remove the global methods (e.g. ::ActivateBestChain) and inline them into the members?\r\n\r\nI like this idea but left it on the table in the interest of minimizing the diff.\r\n\r\nIn general, my preference would be to have anything outside of validation deal with the CChainState interface (`::ChainstateActive()` or other instances), and have anything only to be used by validation in a static function outside of the header file. I didn't initially do this (to keep the diff small), but I'm happy to add commits if that seems preferable.",
      "created_at" : "2019-05-08T17:43:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490582434",
      "id" : 490582434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDU4MjQzNA==",
      "updated_at" : "2019-05-08T17:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490582434",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-08T21:06:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490499616",
      "id" : 490499616,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MDQ5OTYxNg==",
      "updated_at" : "2019-05-08T21:06:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/490499616",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283475344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283475344"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit de39209d0c move-only: make the CChainState interface public\r\n\r\nCould keep this implementation in the cpp file? Only put the struct and declaration in the header?\r\n\r\nAlso, the commit description mentions a \"namespace\", which is no longer true, so should be removed?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-13T18:23:45Z",
      "diff_hunk" : "@@ -422,6 +422,195 @@ inline CBlockIndex* LookupBlockIndex(const uint256& hash)\n /** Find the last common block between the parameter chain and a locator. */\n CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& locator) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+enum DisconnectResult\n+{\n+    DISCONNECT_OK,      // All good.\n+    DISCONNECT_UNCLEAN, // Rolled back, but UTXO set was inconsistent with block.\n+    DISCONNECT_FAILED   // Something else went wrong.\n+};\n+\n+class ConnectTrace;\n+\n+/** @see CChainState::FlushStateToDisk */\n+enum class FlushStateMode {\n+    NONE,\n+    IF_NEEDED,\n+    PERIODIC,\n+    ALWAYS\n+};\n+\n+struct CBlockIndexWorkComparator\n+{\n+    bool operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283475344",
      "id" : 283475344,
      "in_reply_to_id" : 282111893,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzQ3NTM0NA==",
      "original_commit_id" : "65e22684281996ee49889642c745143e99736ae2",
      "original_position" : 60,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 236841987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283475344",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283479959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283479959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 9147f28ec0 refactoring: FlushStateToDisk -> CChainState\r\n\r\n\r\nIt seems weird to move a method that was `static` in validation.cpp to the header file as a public member function. At the very least it should be private. (However, I'd prefer if in the same commit the `FlushStateToDisk` and `PruneAndFlush` were moved to a public method in CChainState.)",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-13T18:34:51Z",
      "diff_hunk" : "@@ -524,6 +533,21 @@ class CChainState {\n \n     bool LoadBlockIndex(const Consensus::Params& consensus_params, CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Update the on-disk chain state.\n+     * The caches and indexes are flushed depending on the mode we're called with\n+     * if they're too large, if it's been a while since the last write,\n+     * or always and in all cases if we're in prune mode and are deleting files.\n+     *\n+     * If FlushStateMode::NONE is used, then FlushStateToDisk(...) won't do anything\n+     * besides checking if we need to prune.\n+     */\n+    bool FlushStateToDisk(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283479959",
      "id" : 283479959,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzQ3OTk1OQ==",
      "original_commit_id" : "9147f28ec03181d69fe46aa81dbe82086b2c684d",
      "original_position" : 48,
      "path" : "src/validation.h",
      "position" : 150,
      "pull_request_review_id" : 236841987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283479959",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283481731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283481731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 61fd34e244  refactoring: IsInitialBlockDownload -> CChainState\r\n\r\n\r\nInstead of a question, say \"Whether this c...\"?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-13T18:39:46Z",
      "diff_hunk" : "@@ -523,6 +521,14 @@ class CChainState {\n      */\n     CCriticalSection m_cs_chainstate;\n \n+    /**\n+     * Is this chainstate undergoing initial block download?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283481731",
      "id" : 283481731,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzQ4MTczMQ==",
      "original_commit_id" : "61fd34e24400b4cee07a379630331f37d2847588",
      "original_position" : 14,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 236841987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283481731",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283481944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283481944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 61fd34e refactoring: IsInitialBlockDownload -> CChainState\r\n\r\nThis is only toggled once (aka latched)? So should keep that nomenclature? ",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-13T18:40:24Z",
      "diff_hunk" : "@@ -523,6 +521,14 @@ class CChainState {\n      */\n     CCriticalSection m_cs_chainstate;\n \n+    /**\n+     * Is this chainstate undergoing initial block download?\n+     *\n+     * Mutable because we need to be able to mark IsInitialBlockDownload()\n+     * const, which toggles this for caching purposes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r283481944",
      "id" : 283481944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzQ4MTk0NA==",
      "original_commit_id" : "61fd34e24400b4cee07a379630331f37d2847588",
      "original_position" : 17,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 236841987,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283481944",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284016299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284016299"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there any particular reason why  `FlushStateToDisk` `PruneAndFlush` should not be ChainState members and `FlushStateToDisk` `IsInitialBlockDownload` should be? Curious how your comment in https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-490582434 applies to these individual cases. Not that it really matters, but it'd be nice to have consistency, and maybe explicit rationale for why things are or aren't members in the commit messages.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-14T21:55:01Z",
      "diff_hunk" : "@@ -278,9 +279,9 @@ void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n \n /** Flush all state, indexes and buffers to disk. */\n-void FlushStateToDisk();\n+void FlushStateToDisk(CChainState& chainstate);\n /** Prune block files and flush state to disk. */\n-void PruneAndFlush();\n+void PruneAndFlush(CChainState& chainstate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284016299",
      "id" : 284016299,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDAxNjI5OQ==",
      "original_commit_id" : "9147f28ec03181d69fe46aa81dbe82086b2c684d",
      "original_position" : 16,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 237522242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284016299",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284070760"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284070760"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No good reason beyond the fact that `FlushStateToDisk` affects on-disk block files (which are shared across chainstates) - but that's a symptom of a more general issue (that FSTD handles pruning, which seems like a separate concern) so probably not worth worrying about here.\r\n\r\n",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T02:55:50Z",
      "diff_hunk" : "@@ -278,9 +279,9 @@ void PruneOneBlockFile(const int fileNumber) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n void UnlinkPrunedFiles(const std::set<int>& setFilesToPrune);\n \n /** Flush all state, indexes and buffers to disk. */\n-void FlushStateToDisk();\n+void FlushStateToDisk(CChainState& chainstate);\n /** Prune block files and flush state to disk. */\n-void PruneAndFlush();\n+void PruneAndFlush(CChainState& chainstate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284070760",
      "id" : 284070760,
      "in_reply_to_id" : 284016299,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDA3MDc2MA==",
      "original_commit_id" : "9147f28ec03181d69fe46aa81dbe82086b2c684d",
      "original_position" : 16,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 237588704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284070760",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284071249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284071249"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with your general concern, but usage of `FlushStateToDisk` happens in places that won't work with `private` like `AcceptToMemoryPoolWithTime` and so if we made it private, we'd have to attach a bunch of `friend` statements which seems kind of gross.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T02:58:41Z",
      "diff_hunk" : "@@ -524,6 +533,21 @@ class CChainState {\n \n     bool LoadBlockIndex(const Consensus::Params& consensus_params, CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Update the on-disk chain state.\n+     * The caches and indexes are flushed depending on the mode we're called with\n+     * if they're too large, if it's been a while since the last write,\n+     * or always and in all cases if we're in prune mode and are deleting files.\n+     *\n+     * If FlushStateMode::NONE is used, then FlushStateToDisk(...) won't do anything\n+     * besides checking if we need to prune.\n+     */\n+    bool FlushStateToDisk(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284071249",
      "id" : 284071249,
      "in_reply_to_id" : 283479959,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDA3MTI0OQ==",
      "original_commit_id" : "9147f28ec03181d69fe46aa81dbe82086b2c684d",
      "original_position" : 48,
      "path" : "src/validation.h",
      "position" : 150,
      "pull_request_review_id" : 237589247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284071249",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the good feedback @Sjors @MarcoFalke @ryanofsky. I agree with the comments so far and have incorporated all of them aside from those noted above. Initially I hadn't touched the global `Flush` functions because I thought it'd create an unnecessarily large diff, but it turns out that it's negligible.\r\n\r\nI took the liberty of renaming the global function equivalents for clarity, and in the process I did notice something sort of interesting. `PruneAndFlush()` doesn't seem to actually do any flushing, just pruning, and so I'm calling it `PruneBlockFiles()` accordingly. This might be worth more general investigation because other parts of the code seem to assume that call flushes chainstate (which doesn't seem correct).",
      "created_at" : "2019-05-15T03:04:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-492485689",
      "id" : 492485689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjQ4NTY4OQ==",
      "updated_at" : "2019-05-15T03:04:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492485689",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284220451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284220451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, makes sense",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T12:04:53Z",
      "diff_hunk" : "@@ -524,6 +533,21 @@ class CChainState {\n \n     bool LoadBlockIndex(const Consensus::Params& consensus_params, CBlockTreeDB& blocktree) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Update the on-disk chain state.\n+     * The caches and indexes are flushed depending on the mode we're called with\n+     * if they're too large, if it's been a while since the last write,\n+     * or always and in all cases if we're in prune mode and are deleting files.\n+     *\n+     * If FlushStateMode::NONE is used, then FlushStateToDisk(...) won't do anything\n+     * besides checking if we need to prune.\n+     */\n+    bool FlushStateToDisk(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284220451",
      "id" : 284220451,
      "in_reply_to_id" : 283479959,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDIyMDQ1MQ==",
      "original_commit_id" : "9147f28ec03181d69fe46aa81dbe82086b2c684d",
      "original_position" : 48,
      "path" : "src/validation.h",
      "position" : 150,
      "pull_request_review_id" : 237776265,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284220451",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284223105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284223105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit a8930a66b1 move-only: make the CChainState interface public\r\n\r\n\r\nWhy is this moved to the end of the cpp file instead of keeping it at the top? This breaks both `git blame` and git diff with `--color-moved=dimmed-zebra --ignore-all-space`",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T12:12:22Z",
      "diff_hunk" : "@@ -4916,3 +4760,21 @@ class CMainCleanup\n         mapBlockIndex.clear();\n     }\n } instance_of_cmaincleanup;\n+\n+bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284223105",
      "id" : 284223105,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDIyMzEwNQ==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 545,
      "path" : "src/validation.cpp",
      "position" : 542,
      "pull_request_review_id" : 237779586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284223105",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284224235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284224235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n/** @returns the most-work valid chainstate. */\r\n```\r\n\r\nin commit 7794d41a58 refactoring: introduce ChainstateActive()\r\n\r\n\r\nCould clarify that this the chainstate is fully validated (as opposed to a pow header chain)",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T12:15:48Z",
      "diff_hunk" : "@@ -435,6 +610,9 @@ bool InvalidateBlock(CValidationState& state, const CChainParams& chainparams, C\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/** @returns the most-work chainstate. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284224235",
      "id" : 284224235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDIyNDIzNQ==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 226,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 237779586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284224235",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284226967"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284226967"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 7ab9e339a8 refactoring: FlushStateToDisk -> CChainState\r\n\r\n\r\nstyle-question: You remove the global with the same name in this commit, so the `this->` is not required?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T12:23:21Z",
      "diff_hunk" : "@@ -2196,27 +2035,31 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     }\n     if (full_flush_completed) {\n         // Update best block in wallet (so we can detect restored wallets).\n-        GetMainSignals().ChainStateFlushed(::ChainActive().GetLocator());\n+        GetMainSignals().ChainStateFlushed(m_chain.GetLocator());\n     }\n     } catch (const std::runtime_error& e) {\n         return AbortNode(state, std::string(\"System error while flushing: \") + e.what());\n     }\n     return true;\n }\n \n-void FlushStateToDisk() {\n+void CChainState::ForceFlushStateToDisk() {\n     CValidationState state;\n     const CChainParams& chainparams = Params();\n-    if (!FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {\n+    if (!this->FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284226967",
      "id" : 284226967,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDIyNjk2Nw==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 313,
      "path" : "src/validation.cpp",
      "position" : 313,
      "pull_request_review_id" : 237779586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284226967",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284229049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284229049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 7ab9e339a8 refactoring: FlushStateToDisk -> CChainState\r\n\r\n\r\nI'd rather not add a comment that starts with \"confusingly\". You renamed the function and removed the confusion.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T12:28:58Z",
      "diff_hunk" : "@@ -2196,27 +2035,31 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     }\n     if (full_flush_completed) {\n         // Update best block in wallet (so we can detect restored wallets).\n-        GetMainSignals().ChainStateFlushed(::ChainActive().GetLocator());\n+        GetMainSignals().ChainStateFlushed(m_chain.GetLocator());\n     }\n     } catch (const std::runtime_error& e) {\n         return AbortNode(state, std::string(\"System error while flushing: \") + e.what());\n     }\n     return true;\n }\n \n-void FlushStateToDisk() {\n+void CChainState::ForceFlushStateToDisk() {\n     CValidationState state;\n     const CChainParams& chainparams = Params();\n-    if (!FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {\n+    if (!this->FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {\n         LogPrintf(\"%s: failed to flush state (%s)\\n\", __func__, FormatStateMessage(state));\n     }\n }\n \n-void PruneAndFlush() {\n+void CChainState::PruneBlockFiles() {\n     CValidationState state;\n     fCheckForPruning = true;\n     const CChainParams& chainparams = Params();\n-    if (!FlushStateToDisk(chainparams, state, FlushStateMode::NONE)) {\n+\n+    // Confusingly, nothing is actually flushed to disk due to\n+    // FlushStateMode::NONE; the only effect of this call is to prune\n+    // block files if necessary.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284229049",
      "id" : 284229049,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDIyOTA0OQ==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 327,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 237779586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284229049",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284264160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284264160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like prefixing with `this->` for methods because it makes it obvious we're calling a method, sort of like `m_`. See the IRC discussion: http://www.erisian.com.au/bitcoin-core-dev/log-2019-05-06.html#l-572\r\n\r\nHappy to undo it if it's controversial though.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T13:48:32Z",
      "diff_hunk" : "@@ -2196,27 +2035,31 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     }\n     if (full_flush_completed) {\n         // Update best block in wallet (so we can detect restored wallets).\n-        GetMainSignals().ChainStateFlushed(::ChainActive().GetLocator());\n+        GetMainSignals().ChainStateFlushed(m_chain.GetLocator());\n     }\n     } catch (const std::runtime_error& e) {\n         return AbortNode(state, std::string(\"System error while flushing: \") + e.what());\n     }\n     return true;\n }\n \n-void FlushStateToDisk() {\n+void CChainState::ForceFlushStateToDisk() {\n     CValidationState state;\n     const CChainParams& chainparams = Params();\n-    if (!FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {\n+    if (!this->FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284264160",
      "id" : 284264160,
      "in_reply_to_id" : 284226967,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDI2NDE2MA==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 313,
      "path" : "src/validation.cpp",
      "position" : 313,
      "pull_request_review_id" : 237832831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284264160",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284266146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284266146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be in an awkward place at the top of the file - right below the \"global state\" comment. Happy to move it back if you think the diff convenience is worth it though.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T13:52:23Z",
      "diff_hunk" : "@@ -4916,3 +4760,21 @@ class CMainCleanup\n         mapBlockIndex.clear();\n     }\n } instance_of_cmaincleanup;\n+\n+bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284266146",
      "id" : 284266146,
      "in_reply_to_id" : 284223105,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDI2NjE0Ng==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 545,
      "path" : "src/validation.cpp",
      "position" : 542,
      "pull_request_review_id" : 237835367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284266146",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284266408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284266408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah good point! Thanks.",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T13:52:54Z",
      "diff_hunk" : "@@ -435,6 +610,9 @@ bool InvalidateBlock(CValidationState& state, const CChainParams& chainparams, C\n /** Remove invalidity status from a block and its descendants. */\n void ResetBlockFailureFlags(CBlockIndex* pindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+/** @returns the most-work chainstate. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284266408",
      "id" : 284266408,
      "in_reply_to_id" : 284224235,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDI2NjQwOA==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 226,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 237835732,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T13:54:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284266408",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> PruneAndFlush() doesn't seem to actually do any flushing\r\n\r\nMy mistake: flushes *do* happen when calling `PruneAndFlush()`. I've undone that particular rename and removed the comment I added. ",
      "created_at" : "2019-05-15T13:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#issuecomment-492665786",
      "id" : 492665786,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15976",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MjY2NTc4Ng==",
      "updated_at" : "2019-05-15T13:57:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/492665786",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284290728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284290728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand what the \"global state\" comment should convey. If a symbol is global and not const, we prefix it with `g_`. Might want to remove it?",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T14:38:31Z",
      "diff_hunk" : "@@ -4916,3 +4760,21 @@ class CMainCleanup\n         mapBlockIndex.clear();\n     }\n } instance_of_cmaincleanup;\n+\n+bool CBlockIndexWorkComparator::operator()(const CBlockIndex *pa, const CBlockIndex *pb) const {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284290728",
      "id" : 284290728,
      "in_reply_to_id" : 284223105,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDI5MDcyOA==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 545,
      "path" : "src/validation.cpp",
      "position" : 542,
      "pull_request_review_id" : 237866934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T14:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284290728",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284291087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284291087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Asked because we don't do this elsewhere. You can pick whatever you prefer ofc",
      "commit_id" : "64d0f872fcf6b61de9e4e62ce13dbbe3b00cbb6c",
      "created_at" : "2019-05-15T14:39:12Z",
      "diff_hunk" : "@@ -2196,27 +2035,31 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     }\n     if (full_flush_completed) {\n         // Update best block in wallet (so we can detect restored wallets).\n-        GetMainSignals().ChainStateFlushed(::ChainActive().GetLocator());\n+        GetMainSignals().ChainStateFlushed(m_chain.GetLocator());\n     }\n     } catch (const std::runtime_error& e) {\n         return AbortNode(state, std::string(\"System error while flushing: \") + e.what());\n     }\n     return true;\n }\n \n-void FlushStateToDisk() {\n+void CChainState::ForceFlushStateToDisk() {\n     CValidationState state;\n     const CChainParams& chainparams = Params();\n-    if (!FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {\n+    if (!this->FlushStateToDisk(chainparams, state, FlushStateMode::ALWAYS)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15976#discussion_r284291087",
      "id" : 284291087,
      "in_reply_to_id" : 284226967,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDI5MTA4Nw==",
      "original_commit_id" : "5fe4eb3a1a8ca7da24a451360a7d38c768e12b10",
      "original_position" : 313,
      "path" : "src/validation.cpp",
      "position" : 313,
      "pull_request_review_id" : 237867411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15976",
      "updated_at" : "2019-05-15T14:39:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284291087",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
