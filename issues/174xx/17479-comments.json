[
   {
      "author_association" : "MEMBER",
      "body" : "This is the first two commits from #16279. Thanks for your work, @TheBlueMatt!",
      "created_at" : "2019-11-14T17:18:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-553988839",
      "id" : 553988839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Mzk4ODgzOQ==",
      "updated_at" : "2019-11-14T17:18:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/553988839",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17485](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17485.html) (net processing: Don't reach into CBlockIndex to check for block mutation by jnewbery)\n* [#17399](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17399.html) (validation: Templatize ValidationState instead of subclassing by jkczyz)\n* [#16442](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16442.html) (Serve BIP 157 compact filters by jimpo)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n* [#15545](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15545.html) ([doc] explain why CheckBlock() is called before AcceptBlock by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-11-14T19:15:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554036805",
      "id" : 554036805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDAzNjgwNQ==",
      "updated_at" : "2019-11-15T00:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554036805",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've added a commit that deduplicates post-block-checking code, which makes the main commit in this PR smaller and (I hope) easier to understand.",
      "created_at" : "2019-11-14T21:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554084723",
      "id" : 554084723,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDA4NDcyMw==",
      "updated_at" : "2019-11-14T21:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554084723",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've taken the final (behaviour change) commit from #16279 and PR'ed it as #17485. That gives some justification for this PR. If we get the anti-dos / mutation checks back from validation immediately, we can use that state to mark the block as no longer in-flight, rather than by indirectly checking that the block has been written to disk.\r\n\r\nSeparating into two PRs makes this easier to review. This PR should result in no behaviour changes (modulo the `BlockChecked()` callback in net processing now being called immediately instead of on the background scheduler thread), and the follow-up PR has the (minor) behaviour change along with lots of commenting and justification.",
      "created_at" : "2019-11-14T22:28:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554110522",
      "id" : 554110522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDExMDUyMg==",
      "updated_at" : "2019-11-14T22:28:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554110522",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I found the last commit in this PR (71867666388bf1137b431f944fd430f262480eba) a bit hard to parse, so I split it up in my branch here: https://github.com/bitcoin/bitcoin/compare/master...dongcarl:2019-11-processnewblock-early-return-redo-last. The main change in the last commit on this branch resides in f46102be8fdd1ef8a21b821c121ed9fa027c9d32 on mine, and f46102be8fdd1ef8a21b821c121ed9fa027c9d32 also retains the same commit message. Feel free to use/use only to review/not use.",
      "created_at" : "2019-11-15T21:06:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554528497",
      "id" : 554528497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDUyODQ5Nw==",
      "updated_at" : "2019-11-15T21:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554528497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347011474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347011474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps I'm understanding wrong but this shouldn't apply anymore?",
      "commit_id" : "0bf87d2034902e23cc4b58c2f6ae0b0ae4af48cc",
      "created_at" : "2019-11-15T21:07:35Z",
      "diff_hunk" : "@@ -199,22 +199,33 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347011474",
      "id" : 347011474,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzAxMTQ3NA==",
      "original_commit_id" : "71867666388bf1137b431f944fd430f262480eba",
      "original_position" : 11,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 317869779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "updated_at" : "2019-11-15T22:18:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347011474",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the branch @dongcarl ! I've reset to that and made a couple of minor comment changes.",
      "created_at" : "2019-11-15T22:19:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#issuecomment-554551727",
      "id" : 554551727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17479",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDU1MTcyNw==",
      "updated_at" : "2019-11-15T22:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554551727",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347035231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347035231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "BlockChecked is called for any block that we try to connect to the chain. See the call in `ConnectTip()`:\r\n\r\n- if the call to `ConnectBlock()` failed, then we'll call `BlockChecked()` with a state that is NOT `IsValid()`.\r\n- if the call to `ConnectBlock()` succeeded, then the block has been connected and is part of the main chain, and we'll call `BlockChecked()` with a state that IS `IsValid()`.\r\n\r\nNote that we may never even call `ConnectTip()` if we don't try to connect the block to the most work chain.",
      "commit_id" : "0bf87d2034902e23cc4b58c2f6ae0b0ae4af48cc",
      "created_at" : "2019-11-15T22:23:13Z",
      "diff_hunk" : "@@ -199,22 +199,33 @@ static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n  * block is made active. Note that it does not, however, guarantee that the\n  * specific block passed to it has been checked for validity!\n  *\n- * If you want to *possibly* get feedback on whether pblock is valid, you must\n- * install a CValidationInterface (see validationinterface.h) - this will have\n- * its BlockChecked method called whenever *any* block completes validation.\n+ * Performs initial sanity checks using the provided BlockValidationState before\n+ * connecting any block(s). If you want to *possibly* get feedback on whether\n+ * pblock is valid beyond just cursory mutation/DoS checks, you must install\n+ * a CValidationInterface (see validationinterface.h) - this will have its\n+ * BlockChecked method called whenever *any* block completes validation (note",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347035231",
      "id" : 347035231,
      "in_reply_to_id" : 347011474,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzAzNTIzMQ==",
      "original_commit_id" : "71867666388bf1137b431f944fd430f262480eba",
      "original_position" : 11,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 317901418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "updated_at" : "2019-11-15T22:23:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347035231",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347577049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347577049"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`submitblock_StateCacher` is the last client of validationinterface, I think we can go further, tweak it a bit and remove definitely `BlockChecked`, see : https://github.com/ariard/bitcoin/commits/2019-11-processnewblock-review\r\n(but maybe to include this in a follow-up cleanup PR?)",
      "commit_id" : "0bf87d2034902e23cc4b58c2f6ae0b0ae4af48cc",
      "created_at" : "2019-11-18T19:50:34Z",
      "diff_hunk" : "@@ -784,6 +784,9 @@ static UniValue submitblock(const JSONRPCRequest& request)\n     if (!new_block && accepted) {\n         return \"duplicate\";\n     }\n+    if (!dos_state.IsValid()) {\n+        return BIP22ValidationResult(dos_state);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347577049",
      "id" : 347577049,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU3NzA0OQ==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_position" : 5,
      "path" : "src/rpc/mining.cpp",
      "position" : 22,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "updated_at" : "2019-11-18T20:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347577049",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347580252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347580252"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't this check break `BlockChecked` where we check `state.IsValid` for promoting peer to compact block announcement?",
      "commit_id" : "0bf87d2034902e23cc4b58c2f6ae0b0ae4af48cc",
      "created_at" : "2019-11-18T19:57:34Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347580252",
      "id" : 347580252,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU4MDI1Mg==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "updated_at" : "2019-11-18T20:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347580252",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347582776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347582776"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can't this branch combined with `BlockChecked` by passing new_block as param? Even wonder if we still need `fNewBlock` in PNB, as  `BlockChecked`  erase block from `mapBlockSource` independently of validity/novelty",
      "commit_id" : "0bf87d2034902e23cc4b58c2f6ae0b0ae4af48cc",
      "created_at" : "2019-11-18T20:03:34Z",
      "diff_hunk" : "@@ -1888,16 +1888,23 @@ void static ProcessOrphanTx(CConnman* connman, std::set<uint256>& orphan_work_se\n }\n \n /**\n- *  A block has been processed. If this is the first time we've seen the block,\n+ *  A block has been processed. If the block was failed anti-dos / mutation checks, then\n+ *  call BlockChecked() to maybe punish peer. If this is the first time we've seen the block,\n  *  update the node's nLastBlockTime. Otherwise erase it from mapBlockSource.\n  */\n-void static BlockProcessed(CNode* pfrom, std::shared_ptr<CBlock> pblock, bool new_block)\n+void static BlockProcessed(CNode* pfrom, CConnman* connman, std::shared_ptr<CBlock> pblock, BlockValidationState& state, bool new_block)\n {\n-    if (new_block) {\n-        pfrom->nLastBlockTime = GetTime();\n-    } else {\n+    if (!state.IsValid()) {\n+        // The block failed anti-dos / mutation checks. Call BlockChecked() callback here.\n+        // This clears the block from mapBlockSource.\n+        BlockChecked(*pblock, state, connman);\n+    } else if (!new_block) {\n+        // Block was valid but we've seen it before. Clear it from mapBlockSource.\n         LOCK(cs_main);\n         ::mapBlockSource.erase(pblock->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17479#discussion_r347582776",
      "id" : 347582776,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NzU4Mjc3Ng==",
      "original_commit_id" : "a49a153f7cab063ce4f9ae898c9ffa94e8fcf510",
      "original_position" : 22,
      "path" : "src/net_processing.cpp",
      "position" : 42,
      "pull_request_review_id" : 318587270,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17479",
      "updated_at" : "2019-11-18T20:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/347582776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   }
]
