[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18077 (net: Add NAT-PMP port forwarding support by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-11-09T23:42:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-552147683",
      "id" : 552147683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjE0NzY4Mw==",
      "updated_at" : "2020-02-11T21:34:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552147683",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Don't think this should get in the way of implementing something like this, but have to note here, as it's a significant change of behavior from before: reconnecting to peers \"aggressively\", was, up to now, the reserve of spy nodes and mass-connectors and such. For normal nodes the chance of making the same outgoing connection twice was pretty low. Historically this has been one of the ways used to detect these.",
      "created_at" : "2019-11-10T11:03:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-552184378",
      "id" : 552184378,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjE4NDM3OA==",
      "updated_at" : "2019-11-10T11:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552184378",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "It would be really good to limit it so that an honest node won't attempt to connect twice to the same peer through this mechanism for some prudent amount of time... like two minutes.\r\n\r\nI don't think it would cause any harm to the intent of this mechanism to not bring them up as fast as possible, and it would avoid  tripping up detection of aggressive mass connectors.",
      "created_at" : "2019-11-13T18:11:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-553531390",
      "id" : 553531390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MzUzMTM5MA==",
      "updated_at" : "2019-11-13T18:11:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/553531390",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure if Iâm misreading this code (I havenât tested it), but it looks like on restart we would only  attempt to connect once to each anchor, and then it gets removed from consideration.  Does that satisfy the concern about rapid reconnects?  I guess if a user rapidly restarted their node, we could see rapid connections to the same peers, but that seems pretty weird.\r\n\r\nAnyway I just skimmed the discussion in #17326.  I think Greg or Matt commented that we shouldnât do this with all our block-relay-only connections, but since we only have 2 at the moment, perhaps itâs fine for now.  And then in the future if we expand to say 8 block-relay peers we might still cap the anchors at 2.  Does that reflect the thinking of others as well?",
      "created_at" : "2019-11-14T20:49:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-554073351",
      "id" : 554073351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NDA3MzM1MQ==",
      "updated_at" : "2019-11-14T20:49:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/554073351",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r346539871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346539871"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think by putting this logic down here, youâre bypassing some important filtering that happens in the loop above, where we skip over some entries that addrMan gives us (for instance, the `IsReachable()â check).  I think the best thing would be to move this logic up to that loop (similar to the tried table collision selector) so that all those other criteria are still enforced.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2019-11-14T20:52:30Z",
      "diff_hunk" : "@@ -1863,11 +1863,28 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             // well for sanity.)\n             bool block_relay_only = nOutboundBlockRelay < m_max_outbound_block_relay && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n \n+            if (block_relay_only && !m_anchors.empty()) {\n+                addrConnect = m_anchors.back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r346539871",
      "id" : 346539871,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0NjUzOTg3MQ==",
      "original_commit_id" : "99d6f6fc6c11c7797dcf232be75d1803d7cacfa1",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 317252129,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/346539871",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r348988284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348988284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2019-11-21T09:53:23Z",
      "diff_hunk" : "@@ -1863,11 +1863,28 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             // well for sanity.)\n             bool block_relay_only = nOutboundBlockRelay < m_max_outbound_block_relay && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n \n+            if (block_relay_only && !m_anchors.empty()) {\n+                addrConnect = m_anchors.back();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r348988284",
      "id" : 348988284,
      "in_reply_to_id" : 346539871,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0ODk4ODI4NA==",
      "original_commit_id" : "99d6f6fc6c11c7797dcf232be75d1803d7cacfa1",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 320757443,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/348988284",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar \r\n\r\nThank you for your review. Your comment has been addressed.\r\n\r\nAlso, an additional safety check added to \"p2p: Integrate ReadAnchors() into CConnman()\" commit in the latest push.",
      "created_at" : "2019-11-21T09:56:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-557008273",
      "id" : 557008273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzAwODI3Mw==",
      "updated_at" : "2019-11-21T09:56:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557008273",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367057240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367057240"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why clear the whole instead of picking randomly `m_max_outbound_block_relay` among the anchors set? If one of our most recent anchors isn't reliable we should be allowed to pick up among older anchors to still of the counter-measure. ",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-15T19:14:13Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);\n+    if (m_anchors.size() > m_max_outbound_block_relay) {\n+        // Keep our policy safe.\n+        m_anchors.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367057240",
      "id" : 367057240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA1NzI0MA==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 16,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 343456401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367057240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367058564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367058564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: isn't cleaner to avoid read() in CConnman constructor and instead do it in CConnman::Start like we do for peers.dat?",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-15T19:17:03Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367058564",
      "id" : 367058564,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA1ODU2NA==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 13,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 343456401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367058564",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367073224"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367073224"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "May we check here also `nOutboundFullRelay`, and so keep same connection order, i.e full-relay then block-only or is there any advantage to invert order ?",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-15T19:48:43Z",
      "diff_hunk" : "@@ -1805,11 +1807,24 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             if (nTries > 100)\n                 break;\n \n-            CAddrInfo addr = addrman.SelectTriedCollision();\n+            CAddress addr;\n+            if (!m_anchors.empty() && (nOutboundBlockRelay < m_max_outbound_block_relay) && !fFeeler) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367073224",
      "id" : 367073224,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA3MzIyNA==",
      "original_commit_id" : "d405145e8f935b454ba77e23cf7327515b85151e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : 34,
      "pull_request_review_id" : 343456401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367073224",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367081001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367081001"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What do you think about waiting some time like 24hours or one block announcement before to qualify node as anchor? That would require at least some good behavior from it, that said and may favor too much well-reliable nodes and decay network-wide connectivity..\r\n\r\nnit: you may use scheduler for DumpAnchors like we do for DumpAddresses, that would avoid file syscalls while holding cs_main",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-15T20:05:50Z",
      "diff_hunk" : "@@ -2088,6 +2088,9 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                       pfrom->nVersion.load(), pfrom->nStartingHeight,\n                       pfrom->GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom->addr.ToString()) : \"\"),\n                       pfrom->m_tx_relay == nullptr ? \"block-relay\" : \"full-relay\");\n+            if (!pfrom->m_tx_relay) {\n+                DumpAnchors(connman->m_anchors_db_path, connman->GetBlockRelayNodeAddresses());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r367081001",
      "id" : 367081001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA4MTAwMQ==",
      "original_commit_id" : "a41cf3dedb70f418d3003b182ce1d925576161eb",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 343456401,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/367081001",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added 0.20 milestone as this mitigates a security issue so it would be good to have.",
      "created_at" : "2020-01-20T20:09:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-576415049",
      "id" : 576415049,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3NjQxNTA0OQ==",
      "updated_at" : "2020-01-20T20:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/576415049",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r369783170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369783170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can use [`logging/timer.h`](https://github.com/bitcoin/bitcoin/blob/master/src/logging/timer.h#L96-L101) if you care to. [(example)](https://github.com/bitcoin/bitcoin/blob/master/src/validation.cpp#L2296)",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-22T20:21:48Z",
      "diff_hunk" : "@@ -165,3 +165,10 @@ std::vector<CAddress> ReadAnchors(const fs::path& anchors_db_path)\n \n     return ret;\n }\n+\n+void DumpAnchors(const fs::path& anchors_db_path, const std::vector<CAddress>& anchors)\n+{\n+    int64_t start = GetTimeMillis();\n+    SerializeFileDB(\"anchors\", anchors_db_path, anchors);\n+    LogPrintf(\"Flushed %d anchor outbound peer addresses to anchors.dat in %d ms\\n\", anchors.size(), GetTimeMillis() - start);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r369783170",
      "id" : 369783170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4MzE3MA==",
      "original_commit_id" : "161dfb8aa4c534c2faea403bd515a26d10c952fe",
      "original_position" : 9,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 346876682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369783170",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r369789242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369789242"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I like the idea of moving this onto the scheduler thread, but not a huge deal given this only happens once per blocks-only connection.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-22T20:36:26Z",
      "diff_hunk" : "@@ -2088,6 +2088,9 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                       pfrom->nVersion.load(), pfrom->nStartingHeight,\n                       pfrom->GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom->addr.ToString()) : \"\"),\n                       pfrom->m_tx_relay == nullptr ? \"block-relay\" : \"full-relay\");\n+            if (!pfrom->m_tx_relay) {\n+                DumpAnchors(connman->m_anchors_db_path, connman->GetBlockRelayNodeAddresses());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r369789242",
      "id" : 369789242,
      "in_reply_to_id" : 367081001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc4OTI0Mg==",
      "original_commit_id" : "a41cf3dedb70f418d3003b182ce1d925576161eb",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 346876682,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/369789242",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ariard \r\n\r\nThe only idea of this PR is to make a node to try restore outbound block-relay-only connections as they were just before node restart. It is expected that this change in node behavior mitigates restart-based eclipse attacks without significant other tradeoffs.\r\n\r\n> IMO before to go forward we need to agree on a) the scope of anchors: full-relay, block-relay, both...\r\n\r\nAnchoring as a new procedure, or anchors as \"seemingly safe\" nodes are out of the scope of this PR.\r\n\r\n>  b) anchors selection & lifecyle, i.e after how much time do we select them or based on any metrics, do we prune them from anchors.dat, do we keep a bigger file and select randomly from it\r\n\r\nWith an idea _to make a node to try restore outbound block-relay-only connections as they were just before node restart_, anchors are the last known outbound block-relay-only connections only.\r\n\r\nhttps://github.com/bitcoin/bitcoin/pull/17428#discussion_r367081001\r\n> What do you think about waiting some time like 24hours or one block announcement before to qualify node as anchor? That would require at least some good behavior from it, that said and may favor too much well-reliable nodes and decay network-wide connectivity..\r\n\r\nIn this PR anchors are considered as the last known outbound block-relay-only connections, not as \"presumable safe\" ones.",
      "created_at" : "2020-01-26T13:09:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-578500393",
      "id" : 578500393,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODUwMDM5Mw==",
      "updated_at" : "2020-01-26T13:09:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578500393",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371009058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371009058"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~I'd prefer to initialize `m_anchors` member in constructor.~",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T15:46:26Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371009058",
      "id" : 371009058,
      "in_reply_to_id" : 367058564,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAwOTA1OA==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 13,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 348387692,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371009058",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371009626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371009626"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The worst case is assumed. If condition `m_anchors.size() > m_max_outbound_block_relay` is satisfied, we could suppose that the `anchors.dat` file is wrong or corrupted.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T15:53:38Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);\n+    if (m_anchors.size() > m_max_outbound_block_relay) {\n+        // Keep our policy safe.\n+        m_anchors.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371009626",
      "id" : 371009626,
      "in_reply_to_id" : 367057240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAwOTYyNg==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 16,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 348388178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371009626",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371020152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371020152"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The order is not inverted. The first target \"anchors\" is added, and was not present before, i.e., the new order is \"anchors\" then \"full-relay\" then \"block-relay-only\".\r\nIf anchors would not the first, they could be connected as other type nodes, and anchoring could not happen.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T18:31:04Z",
      "diff_hunk" : "@@ -1805,11 +1807,24 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             if (nTries > 100)\n                 break;\n \n-            CAddrInfo addr = addrman.SelectTriedCollision();\n+            CAddress addr;\n+            if (!m_anchors.empty() && (nOutboundBlockRelay < m_max_outbound_block_relay) && !fFeeler) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371020152",
      "id" : 371020152,
      "in_reply_to_id" : 367073224,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMDE1Mg==",
      "original_commit_id" : "d405145e8f935b454ba77e23cf7327515b85151e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : 34,
      "pull_request_review_id" : 348396951,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371020152",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371021403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371021403"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> nit: you may use scheduler for DumpAnchors like we do for DumpAddresses, that would avoid file syscalls while holding cs_main\r\n\r\n> I like the idea of moving this onto the scheduler thread, but not a huge deal given this only happens once per blocks-only connection.\r\n\r\nAgree that using `CScheduler.scheduleFromNow()` for `DumpAnchors` is an improvement. Let's leave it for follow ups.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T18:52:21Z",
      "diff_hunk" : "@@ -2088,6 +2088,9 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                       pfrom->nVersion.load(), pfrom->nStartingHeight,\n                       pfrom->GetId(), (fLogIPs ? strprintf(\", peeraddr=%s\", pfrom->addr.ToString()) : \"\"),\n                       pfrom->m_tx_relay == nullptr ? \"block-relay\" : \"full-relay\");\n+            if (!pfrom->m_tx_relay) {\n+                DumpAnchors(connman->m_anchors_db_path, connman->GetBlockRelayNodeAddresses());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371021403",
      "id" : 371021403,
      "in_reply_to_id" : 367081001,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMTQwMw==",
      "original_commit_id" : "a41cf3dedb70f418d3003b182ce1d925576161eb",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 348397982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371021403",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371023351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371023351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in the latest push.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T19:24:53Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371023351",
      "id" : 371023351,
      "in_reply_to_id" : 367058564,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMzM1MQ==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 13,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 348399659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371023351",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371023391"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371023391"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. Done in the latest push.",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-26T19:25:36Z",
      "diff_hunk" : "@@ -165,3 +165,10 @@ std::vector<CAddress> ReadAnchors(const fs::path& anchors_db_path)\n \n     return ret;\n }\n+\n+void DumpAnchors(const fs::path& anchors_db_path, const std::vector<CAddress>& anchors)\n+{\n+    int64_t start = GetTimeMillis();\n+    SerializeFileDB(\"anchors\", anchors_db_path, anchors);\n+    LogPrintf(\"Flushed %d anchor outbound peer addresses to anchors.dat in %d ms\\n\", anchors.size(), GetTimeMillis() - start);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r371023391",
      "id" : 371023391,
      "in_reply_to_id" : 369783170,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAyMzM5MQ==",
      "original_commit_id" : "161dfb8aa4c534c2faea403bd515a26d10c952fe",
      "original_position" : 9,
      "path" : "src/addrdb.cpp",
      "position" : null,
      "pull_request_review_id" : 348399689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-29T20:10:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/371023391",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated d405145e8f935b454ba77e23cf7327515b85151e -> f2b4cfdc75952e61ba98eeffe26b2f86a78a45c9 ([pr17428.02](https://github.com/hebasto/bitcoin/commits/pr17428.02) -> [pr17428.03](https://github.com/hebasto/bitcoin/commits/pr17428.03), [compare](https://github.com/hebasto/bitcoin/compare/pr17428.02..pr17428.03)).\r\n\r\n@ariard @jamesob \r\n\r\nThank you for your reviews. Your comments have been addressed.\r\n\r\n\r\n@jamesob\r\n> ... seeing some strange behavior locally.\r\n\r\nAdded additional logging when connecting to an anchor fails.",
      "created_at" : "2020-01-26T19:37:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-578535216",
      "id" : 578535216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODUzNTIxNg==",
      "updated_at" : "2020-01-26T19:37:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578535216",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a fixup. Ready for testing and (re)reviewing now.",
      "created_at" : "2020-01-26T20:38:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-578540792",
      "id" : 578540792,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODU0MDc5Mg==",
      "updated_at" : "2020-01-26T20:38:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578540792",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Couldn't there be a risk here, that if one of the anchor peers is malicious and knows a DoS vulnerability, this ensures they can keep repeatedly crashing your node, even if you setup a watchdog to restart it?",
      "created_at" : "2020-01-29T03:53:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-579580035",
      "id" : 579580035,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTU4MDAzNQ==",
      "updated_at" : "2020-01-29T03:53:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579580035",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-01-29T13:28:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-579754482",
      "id" : 579754482,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTc1NDQ4Mg==",
      "updated_at" : "2020-01-29T13:28:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579754482",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #16702 has been merged.",
      "created_at" : "2020-01-29T20:13:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-579938535",
      "id" : 579938535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTkzODUzNQ==",
      "updated_at" : "2020-01-29T20:13:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579938535",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> Couldn't there be a risk here, that if one of the anchor peers is malicious and knows a DoS vulnerability, this ensures they can keep repeatedly crashing your node, even if you setup a watchdog to restart it?\r\n\r\n~Could manual deletion of the `anchors.dat` file be a remedy?~ See: https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-582890916",
      "created_at" : "2020-01-29T20:14:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-579939131",
      "id" : 579939131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3OTkzOTEzMQ==",
      "updated_at" : "2020-02-06T12:49:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579939131",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r372715777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372715777"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No you're melting 2 different problems, tracking the anchors set and connecting to peers among this one. I don't understand why reaching the `m_max_outbound_block_relay` means we have to delete our whole repository of maybe-good anchors peers. \r\n\r\nIn the scenario you're aiming, if victim restarts and the 2 anchors peers are honest but unreliable, you're going to drop them and pick maybe new outbound peers from attacker-provided ones. You can avoid this if you have a bigger set of _potential_ anchor peers.\r\n",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-30T01:12:22Z",
      "diff_hunk" : "@@ -2176,12 +2176,19 @@ void CConnman::SetNetworkActive(bool active)\n     uiInterface.NotifyNetworkActiveChanged(fNetworkActive);\n }\n \n-CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In) : nSeed0(nSeed0In), nSeed1(nSeed1In)\n+CConnman::CConnman(uint64_t nSeed0In, uint64_t nSeed1In)\n+    : m_anchors_db_path{GetDataDir() / \"anchors.dat\"}, nSeed0(nSeed0In), nSeed1(nSeed1In)\n {\n     SetTryNewOutboundPeer(false);\n \n     Options connOptions;\n     Init(connOptions);\n+\n+    m_anchors = ReadAnchors(m_anchors_db_path);\n+    if (m_anchors.size() > m_max_outbound_block_relay) {\n+        // Keep our policy safe.\n+        m_anchors.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r372715777",
      "id" : 372715777,
      "in_reply_to_id" : 367057240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNTc3Nw==",
      "original_commit_id" : "ea5a307eaf1a2325b33df6a2a35ea6df783f4e6b",
      "original_position" : 16,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 350530344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-30T01:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372715777",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r372718282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372718282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "But anchors nodes are block-only, so now you have block-only-as-anchors, full-relay, block-only-classics. You can still test addresses returned from `addrman` against `m_anchors` andon continue in case of equality to avoid the problem you're describing, but don't think that changes something, do we favor first-connected nodes in anyway ?",
      "commit_id" : "a2822de7c042454a73e8f9a357e3539f89562f5e",
      "created_at" : "2020-01-30T01:22:56Z",
      "diff_hunk" : "@@ -1805,11 +1807,24 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             if (nTries > 100)\n                 break;\n \n-            CAddrInfo addr = addrman.SelectTriedCollision();\n+            CAddress addr;\n+            if (!m_anchors.empty() && (nOutboundBlockRelay < m_max_outbound_block_relay) && !fFeeler) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#discussion_r372718282",
      "id" : 372718282,
      "in_reply_to_id" : 367073224,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxODI4Mg==",
      "original_commit_id" : "d405145e8f935b454ba77e23cf7327515b85151e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : 34,
      "pull_request_review_id" : 350533306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17428",
      "updated_at" : "2020-01-30T01:22:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/372718282",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@hebasto \r\n\r\nConcept ACK, reading your comment I do understand that this PR is really-scoped, so don't mind https://github.com/bitcoin/bitcoin/issues/17326#issuecomment-580033087 and https://github.com/bitcoin/bitcoin/pull/17428#discussion_r372715777 but would happily review future work to make anchors better (sorry for the noise)\r\n\r\nA note explaining the exact attack scenario mitigated near to m_anchors or somewhere else would be cool to avoid future reviewers relying on wrong-scoped security assumptions.\r\n\r\nGoign to test PR soon.",
      "created_at" : "2020-01-30T01:50:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-580047275",
      "id" : 580047275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDA0NzI3NQ==",
      "updated_at" : "2020-01-30T01:50:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580047275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr oy. uh. forget them if you uncleanly exit?",
      "created_at" : "2020-01-30T08:15:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-580134777",
      "id" : 580134777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MDEzNDc3Nw==",
      "updated_at" : "2020-01-30T08:15:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/580134777",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-02-05T13:51:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-582416644",
      "id" : 582416644,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjQxNjY0NA==",
      "updated_at" : "2020-02-05T13:51:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582416644",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased after #18023 has been merged.",
      "created_at" : "2020-02-05T21:36:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-582624214",
      "id" : 582624214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjYyNDIxNA==",
      "updated_at" : "2020-02-05T21:36:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582624214",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr \r\n> Couldn't there be a risk here, that if one of the anchor peers is malicious and knows a DoS vulnerability, this ensures they can keep repeatedly crashing your node, even if you setup a watchdog to restart it?\r\n\r\nIf an exploitable DoS vulnerability would exist, this risk would come true, unfortunately.\r\nAs a DoS attack timing is unpredictable, it seems infeasible to prevent such a risk in the scope of this PR. This might be prevented by means of detecting a particular DoS attack, no?",
      "created_at" : "2020-02-06T12:49:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-582890916",
      "id" : 582890916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mjg5MDkxNg==",
      "updated_at" : "2020-02-06T12:49:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582890916",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">If an exploitable DoS vulnerability would exist, this risk would come true, unfortunately.\r\n\r\nThis is probably among the more common vulnerability types.\r\n\r\n(Let's go with @gmaxwell's suggestion to address it.)",
      "created_at" : "2020-02-06T13:33:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-582907316",
      "id" : 582907316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MjkwNzMxNg==",
      "updated_at" : "2020-02-06T13:33:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/582907316",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After a consideration of @luke-jr's concerns and @gmaxwell's suggestion, I'm going to close this PR.\r\n\r\nThe initial idea to mitigate eclipse attacks based on node restarts, included ones initiated by adversary, introduces a [new risk](https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-579580035).\r\n\r\n@gmaxwell's [suggestion](https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-580134777) nullifies the initial idea by making anchoring usable only for clean (user initiated) restarts. The long-term impact of such changes on the entire p2p network is unclear, and requires further study.",
      "created_at" : "2020-02-08T13:34:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-583737058",
      "id" : 583737058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4MzczNzA1OA==",
      "updated_at" : "2020-02-08T13:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583737058",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think closing this is a mistake.  Not saving state across crashes in no way nullifies the advantage of preserving connections, and it's also a natural implementation-- e.g. the software will fail to write out the latest peers.dat across a crash.",
      "created_at" : "2020-02-08T14:42:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-583742368",
      "id" : 583742368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mzc0MjM2OA==",
      "updated_at" : "2020-02-08T14:42:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583742368",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@gmaxwell \r\n> I think closing this is a mistake. Not saving state across crashes in no way nullifies the advantage of preserving connections, and it's also a natural implementation-- e.g. the software will fail to write out the latest peers.dat across a crash.\r\n\r\nReopened. Going to implement your suggestion soon.\r\n\r\nDefinitely, the OP requires an update.",
      "created_at" : "2020-02-08T14:49:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-583743029",
      "id" : 583743029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4Mzc0MzAyOQ==",
      "updated_at" : "2020-02-08T14:49:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/583743029",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Looking forward to an update to this PR :)",
      "created_at" : "2020-02-24T20:35:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-590535864",
      "id" : 590535864,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDUzNTg2NA==",
      "updated_at" : "2020-02-24T20:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590535864",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "to be clear, the scope of this PR is to attempt to persist connections across *clean* restarts triggered for whatever reason?",
      "created_at" : "2020-02-25T15:58:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-590939755",
      "id" : 590939755,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDkzOTc1NQ==",
      "updated_at" : "2020-02-25T15:58:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590939755",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@gmaxwell \r\n> Not saving state across crashes in no way nullifies the advantage of preserving connections\r\n\r\nmy understanding is this PR was intended to mitigate a restart-based eclipse attack. so, if an attacker crashes a victim node, the anchors help reduce the chance of victim being eclipsed. if we change to only persisting connections on clean restarts, we lose the benefit of that scenario. ( I understand the risk of implementing that solution )\r\n\r\nI'm still thinking it through & reading relevant material, but wondering.. what are the advantages you see of having anchors for clean restarts? (vs not having anchors). Is it to mitigate a smaller subset of eclipse attacks that occur with users intentionally restarting their nodes?",
      "created_at" : "2020-02-25T16:55:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-590960921",
      "id" : 590960921,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDk2MDkyMQ==",
      "updated_at" : "2020-02-25T16:55:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590960921",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was thinking along the same lines as Amiti and would like to understand if the DoS attack possibility mentioned above is serious enough to give up the anchors in a unclean restart, because it seems to be especially desirable to have them in this scenario:Â \r\n1. I think that the suggestion to delete anchor.dat on crashes would just change the big picture in case of a subset of DoS attacks working only on the victim's outbound connections - for more general DoS attacks, the attacker could just as well connect to us after we have restarted (if we allow incoming connections) and attack again.\r\n2. Such a repeated DoS attack would be tough to apply in a targeted way, because the connection is outgoing from the victim, reducing the incentives.\r\n3. If an eclipse attacker somehow manages to control our addrman for an extended time (long enough to wait for our clean restart) it seems to me that we are pretty much screwed anyway: Even if anchors protect us from our restart, the attacker could also choose to wait until one by one, our anchors disconnect from us via clean restarts and are replaced by attacker nodes.\r\n4. On the other hand, an attack on our addrman that would only be effective for a short while and recoverable long-time, combined with a DoS attack that forces us to restart *now* uncleanly, would be a scenario in which having anchors would seem really great.",
      "created_at" : "2020-02-25T21:16:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-591073367",
      "id" : 591073367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTA3MzM2Nw==",
      "updated_at" : "2020-02-25T21:16:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591073367",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Couldn't there be a risk here, that if one of the anchor peers is malicious and knows a DoS vulnerability, this ensures they can keep repeatedly crashing your node, even if you setup a watchdog to restart it?\r\n> \r\n> If an exploitable DoS vulnerability would exist, this risk would come true, unfortunately.\r\n> As a DoS attack timing is unpredictable, it seems infeasible to prevent such a risk in the scope of this PR. This might be prevented by means of detecting a particular DoS attack, no?\r\n\r\nIf there was a known remote crash vulnerability and the behaviour was \"okay, in case of a crash, we don't try anchors\" wouldn't an attacker trying to eclipse a node use that exploit to ensure they can completely eclipse the node?\r\n\r\nIf your node is remote crashable, you want to fix it pretty quickly anyway because that often means you're vulnerable to remote code execution as well; so not sure the fix here is actually better?",
      "created_at" : "2020-02-26T01:03:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-591179774",
      "id" : 591179774,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTE3OTc3NA==",
      "updated_at" : "2020-02-26T01:03:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591179774",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "An adversary has two distinct ways to force a victim node to restart:\r\n1) online activity that exploits a DoS vulnerability (i.e., a remote-crashable node)\r\n2) _offline_ activity: e.g., power failures, node operator's delusion via social engineering etc.\r\n\r\nThe current PR implementation works well against the latter adversary activity.\r\n\r\nRegarding the former case, I agree with @ajtowns:\r\n> If your node is remote crashable, you want to fix it pretty quickly anyway...\r\n\r\n---\r\n\r\nAlso an adversary could just wait for a user-initiated (clean) restart of a victim node, which includes restart after a node upgrade. In such cases the current PR implementation works well too.",
      "created_at" : "2020-02-26T14:20:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-591449881",
      "id" : 591449881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTQ0OTg4MQ==",
      "updated_at" : "2020-02-26T14:20:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591449881",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated 78b2f950350688f11b544d24ec44816554c67631 -> 780107e41fe86e31392b3ef76b917e623483259f ([pr17428.06](https://github.com/hebasto/bitcoin/commits/pr17428.06) -> [pr17428.07](https://github.com/hebasto/bitcoin/commits/pr17428.07), [compare](https://github.com/hebasto/bitcoin/compare/pr17428.06..pr17428.07)):\r\n\r\n- a new \"anchors.dat\" file is created only during clean shutdown now\r\n\r\nAlso see:\r\n- https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-580134777\r\n- https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-583742368\r\n- https://bitcoincore.reviews/17428.html",
      "created_at" : "2020-02-27T19:33:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-592138078",
      "id" : 592138078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MjEzODA3OA==",
      "updated_at" : "2020-02-27T19:33:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/592138078",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "hm, if my understanding of the code is correct, I think we also need to wipe the `anchors.dat` file on startup to prevent the malicious-anchor-connection-keeps-crashing-your-node issue. \r\n\r\nmy understanding is that currently you only (potentially) remove connections from `anchors.dat` when you next invoke `DumpAnchors()` and replace them. But I might be missing something?\r\n\r\nscenario: one of your outbound blocks-relay-only peers is malicious, but patient. eventually you restart your node for whatever reason. they are persisted to your anchors. when you startup you reconnect to them & they crash your node. and then you're caught in the same loop? ",
      "created_at" : "2020-02-27T19:47:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-592144553",
      "id" : 592144553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MjE0NDU1Mw==",
      "updated_at" : "2020-02-27T19:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/592144553",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar \r\n> hm, if my understanding of the code is correct, I think we also need to wipe the `anchors.dat` file on startup to prevent the malicious-anchor-connection-keeps-crashing-your-node issue.\r\n> \r\n> my understanding is that currently you only (potentially) remove connections from `anchors.dat` when you next invoke `DumpAnchors()` and replace them. But I might be missing something?\r\n> \r\n> scenario: one of your outbound blocks-relay-only peers is malicious, but patient. eventually you restart your node for whatever reason. they are persisted to your anchors. when you startup you reconnect to them & they crash your node. and then you're caught in the same loop?\r\n\r\nIt seems we need to re-write the `anchors.dat` file every time when another anchor is dropped in `m_anchors.pop_back();`, no?",
      "created_at" : "2020-02-27T20:16:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17428#issuecomment-592156578",
      "id" : 592156578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17428",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MjE1NjU3OA==",
      "updated_at" : "2020-02-27T20:16:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/592156578",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
