[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Review notes:\r\n\r\n1) Don't love -- self.assert_mempool_unchanged(self.nodes[1], waitingtime=5). Long timeouts which return early are OK, but short-er timeouts which always wait for the whole timeout are riskier IMO especially when we don't control the runtime.\r\n2) The test doesn't check that the descendants limit is actually enforced, e.g., that MAX_CUSTOM_DESCDENDANTS+1 is *not* in the mempool\r\n3) The Lightning carve out should also get a test, but doesn't need to be here.",
      "created_at" : "2020-02-24T18:21:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-590476635",
      "id" : 590476635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDQ3NjYzNQ==",
      "updated_at" : "2020-02-24T18:21:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590476635",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@JeremyRubin: Thanks for your review notes! I fully agree to your points 1 and 2 (can't say anything about point 3 yet), they both actually stem from the fact that I can't find a concrete way to express the event of \"_node1 has received all txs from node0_\". As long as I don't know that all txs from node0 have been broadcasted, it is impossible to check that something is _not_ in the mempool on node1 (there could still arrive a tx in the future). That's why I worked with just waiting some time, which is of course ugly. Is there any other way? Can I somehow ask node0 if it has broadcasted to all of its peers?",
      "created_at" : "2020-02-25T09:35:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-590772489",
      "id" : 590772489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MDc3MjQ4OQ==",
      "updated_at" : "2020-02-25T09:37:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/590772489",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "You could expose the CNodeState via an RPC enabled just for testing. That's probably the most robust for what you want to test.",
      "created_at" : "2020-02-26T20:35:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-591630302",
      "id" : 591630302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTYzMDMwMg==",
      "updated_at" : "2020-02-26T20:35:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591630302",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It is possible to set the poisson delay to 0 with `-whitelist=noban@127.0.0.1`. Not sure if that solves your problem and it might even interact with other functionality of the test.",
      "created_at" : "2020-02-26T22:01:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-591666926",
      "id" : 591666926,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTY2NjkyNg==",
      "updated_at" : "2020-02-26T22:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591666926",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Turns out that I thought *way* too complicated when working in this originally, as the solution is really as simple as just activating the immediate tx relay through `-whitelist=127.0.0.1`. Magically the minute while I was trying this out @MarcoFalke suggested the same (with `noban@` though). :smile: \r\nAs far as I can see the other functionality of the test is not affected by tx relay/timing, so using this parameter for node0 should be fine.\r\n@JeremyRubin: Thanks for your suggestion, the idea of exposing parts of CNodeState could be useful for the future.\r\n\r\nRebased and force-pushed with the simpler solution.\r\nAlso edited the PR description to strikethrough the original complicated parts (can also be completely removed if that is preferred).",
      "created_at" : "2020-02-26T22:30:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-591678172",
      "id" : 591678172,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTY3ODE3Mg==",
      "updated_at" : "2020-02-26T22:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591678172",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Also endorse using a whitelist -- I wasn't sure if you wanted all of the whitelist behaviors, such as re-relay and others, but if it works for this test then that's perfect.\r\n\r\nYou may still need some sync to wait until the mempool is the expected size (e.g., \r\n```python\r\nstart = now()\r\nwhile len(mempool1) != MAX_ANCESTORS_CUSTOM + 1 + MAX_DESCENDANTS_CUSTOM:\r\n   if now() > start + 60 seconds:\r\n      raise AssertionError(\"test timed out on mempool sync\")\r\n   else:\r\n      sleep(0.01)\r\n```\r\n). While this is still race-conditiony, in most cases the relay should happen immediately, but it's just possible the mempool hasn't synced fast enough.\r\n\r\nThis kind of waiting is more OK, as it's just a test timeout that happens when we're pretty sure it's an error, and we quit the loop most times after one iteration.",
      "created_at" : "2020-02-26T22:54:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-591686257",
      "id" : 591686257,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTY4NjI1Nw==",
      "updated_at" : "2020-02-26T22:54:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591686257",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@JeremyRubin: Agreed, makes absolute sense to be cautious and wait for the (unlikely, but possible) case that node1 has not been synced. Luckily there exists already a function `wait_until` in the test framework util that contains pretty much exactly your suggested waiting loop, where the condition is passed in form of a lambda function, leading to:\r\n`wait_until(lambda: len(self.nodes[1].getrawmempool(False)) == MAX_ANCESTORS_CUSTOM + 1 + MAX_DESCENDANTS_CUSTOM)`\r\nForce-pushed using this approach, with the timeout lowered to 10 seconds (instead of the default 60 seconds).",
      "created_at" : "2020-02-26T23:25:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17461#issuecomment-591696522",
      "id" : 591696522,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17461",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5MTY5NjUyMg==",
      "updated_at" : "2020-02-26T23:25:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/591696522",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   }
]
