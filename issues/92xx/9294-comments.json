[
   {
      "body" : "Interesting assertion error in CWallet::CreateRawTransaction\r\n```\r\nstderr:\r\nbitcoind: ../../src/wallet/wallet.cpp:2395: bool CWallet::CreateTransaction(const std::vector<CRecipient>&, CWalletTx&, CReserveKey&, CAmount&, int&, std::string&, const CCoinControl*, bool): Assertion `ret' failed.\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/test_framework.py\", line 145, in main\r\n    self.run_test()\r\n  File \"/home/travis/build/bitcoin/bitcoin/build/../qa/rpc-tests/fundrawtransaction.py\", line 498, in run_test\r\n    fundedTx = self.nodes[1].fundrawtransaction(rawTx)\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/coverage.py\", line 49, in __call__\r\n    return_val = self.auth_service_proxy_instance.__call__(*args, **kwargs)\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/authproxy.py\", line 150, in __call__\r\n    response = self._request('POST', self.__url.path, postdata.encode('utf-8'))\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/authproxy.py\", line 130, in _request\r\n    self.__conn.request(method, path, postdata, headers)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1125, in request\r\n    self._send_request(method, url, body, headers)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1163, in _send_request\r\n    self.endheaders(body)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1121, in endheaders\r\n    self._send_output(message_body)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 951, in _send_output\r\n    self.send(msg)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 886, in send\r\n    self.connect()\r\n  File \"/usr/lib/python3.4/http/client.py\", line 863, in connect\r\n    self.timeout, self.source_address)\r\n  File \"/usr/lib/python3.4/socket.py\", line 512, in create_connection\r\n    raise err\r\n  File \"/usr/lib/python3.4/socket.py\", line 503, in create_connection\r\n    sock.connect(sa)\r\n```",
      "created_at" : "2016-12-06T10:44:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-265118191",
      "id" : 265118191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-06T10:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/265118191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Travis is failing because it did what it is supposed to: finding bugs.\r\nOnce #9295 is merged, travis should succeed.",
      "created_at" : "2016-12-06T12:53:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-265142636",
      "id" : 265142636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-06T12:53:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/265142636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514545"
         }
      },
      "body" : "Still three?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-08T13:39:10Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514545",
      "id" : 91514545,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 32,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 12022893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514738"
         }
      },
      "body" : "three?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-08T13:40:19Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')\n+        except JSONRPCException as e:\n+            assert(e.error['code']==-12)\n+\n+        # drain the external keys\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        assert(len(addr) == 6)\n+        # the next one should fail\n+        try:\n+            addr = nodes[0].getnewaddress()\n+            raise AssertionError('Keypool should be exhausted after three external addresses (ceil rounded 80% of six)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514738",
      "id" : 91514738,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 46,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 12023095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "body" : "> Once #9295 is merged, travis should succeed.\r\n\r\nShall we find out?",
      "created_at" : "2016-12-10T19:20:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266231176",
      "id" : 266231176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-10T19:20:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266231176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2016-12-11T10:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266273821",
      "id" : 266273821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-11T10:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266273821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Travis succeeds now.",
      "created_at" : "2016-12-12T08:37:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266371184",
      "id" : 266371184,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-12T08:37:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266371184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93681318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93681318"
         }
      },
      "body" : "Prefer to explicitly add (internal ? 1 : 0)",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-22T19:19:44Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(int)internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93681318",
      "id" : 93681318,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93681318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93688939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93688939"
         }
      },
      "body" : "Seems like it would be better to just access the specific counter once with a post-increment, and use variables here.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-22T20:09:31Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(int)internal);\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        externalChainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);\n+        metadata.hdKeypath = \"m/0'/\" + std::string(internal ? \"1'/\"+ std::to_string(hdChain.nInternalChainCounter) : \"0'/\" + std::to_string(hdChain.nExternalChainCounter)) + \"'\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93688939",
      "id" : 93688939,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 44,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93688939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689481"
         }
      },
      "body" : "IMO this is unintuitive ~~and can lead to loss~~. If users set a keypool size of 100, they expect to be able to safely generate 100 addresses between backups. I usually round down to 90 in advice to give some breathing room, but 80% here will break even that.\r\n\r\nTherefore, the full keypool size should be ensured on both chains.\r\n\r\nEdit: Forgot this was HD. Less critical in that case.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-22T20:13:15Z",
      "diff_hunk" : "@@ -2815,30 +2831,42 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // try to generate 80% external keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689481",
      "id" : 93689481,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 137,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689981"
         }
      },
      "body" : "IMO it would be better to use an enum for internal vs external rather than a bool.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-22T20:16:23Z",
      "diff_hunk" : "@@ -87,7 +87,7 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-CPubKey CWallet::GenerateNewKey()\n+CPubKey CWallet::GenerateNewKey(bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981",
      "id" : 93689981,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93692459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93692459"
         }
      },
      "body" : "Yes. This is a discussion point and I'd like to get others feedback (maybe @gmaxwell and @sipa).\r\nThe question is, if you want a keypool of 100 external + 50 (TBD)  internals = total 150 keys, if you set the keypool to 100.\r\n\r\nIMO user given values should be respected. If the user chooses keypool=100, the keypool should contain 100 keys. But as said, no strong opinion on that.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2016-12-22T20:34:41Z",
      "diff_hunk" : "@@ -2815,30 +2831,42 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // try to generate 80% external keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93692459",
      "id" : 93692459,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 137,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14225939,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93692459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Overhauled after recommendation from @sipa and @luke-jr.\r\n* The amount of external pre-generated keys now back at 100% from `-keypool=(default 100)`.\r\n* The amount of internal pre-generated keys is +20% from `-keypool=(default 100)`.\r\n* Pre-generate two internal keys at minimum\r\n\r\n... this now results in always have 120% keys pre-generated (20% internal key)",
      "created_at" : "2017-01-06T13:49:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-270906367",
      "id" : 270906367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-06T13:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270906367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Updated with a small nit-fix (https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981) and a fix for wallet-dump.py RPC test. Travis should succeed now.",
      "created_at" : "2017-01-09T07:46:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271225631",
      "id" : 271225631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-09T07:46:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271225631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167594"
         }
      },
      "body" : "It's called `externalChainChildKey` but it could be either.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T14:45:18Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(internal ? 1 : 0));\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        externalChainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167594",
      "id" : 95167594,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167924"
         }
      },
      "body" : "update comment",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T14:46:51Z",
      "diff_hunk" : "@@ -1296,7 +1299,7 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n     LOCK(cs_wallet);\n \n     // ensure this wallet.dat can only be opened by clients supporting HD",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167924",
      "id" : 95167924,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 49,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95168762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95168762"
         }
      },
      "body" : "/HD/HD split/?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T14:50:51Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);\n+        int64_t missingInternal = max(targetInternal - amountInternal, (int64_t) 0);\n+\n+        if (!IsHDEnabled() || !CanSupportFeature(FEATURE_HD_SPLIT))\n         {\n-            CKeyPool tmpKeypool;\n-            if (!walletdb.ReadPool(id, tmpKeypool))\n-                throw runtime_error(std::string(__func__) + \": read failed\");\n-            amountI += tmpKeypool.fInternal;\n-            amountE += !tmpKeypool.fInternal;\n+            // don't flag keypool keys internal if we don't use HD",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95168762",
      "id" : 95168762,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 123,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95168762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169601"
         }
      },
      "body" : "I find it a bit confusing that this value goes from `0`(non-existant) to `-keypool` then to `-keypool*.2`. Perhaps have it start at 0 on previous commit, then set it to non-0 here (unless there is reasoning).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T14:54:57Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169601",
      "id" : 95169601,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169944"
         }
      },
      "body" : "Seems like a separate optimization?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T14:56:43Z",
      "diff_hunk" : "@@ -3129,7 +3151,11 @@ bool CReserveKey::GetReservedKey(CPubKey& pubkey, bool internal)\n         if (nIndex != -1)\n             vchPubKey = keypool.vchPubKey;\n         else {\n-            return false;\n+            if (pwallet->IsLocked())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169944",
      "id" : 95169944,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 153,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95171761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95171761"
         }
      },
      "body" : "Might make sense to explicitly count both types and use those counts if we foresee a future with more possible types rather than implicitly count `total - external`. You'd know better than me how likely that is.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T15:05:38Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95171761",
      "id" : 95171761,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95171761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95173485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95173485"
         }
      },
      "body" : "also, this is 100%, not 80% of 6. 100% vs 20%, not 80% vs 20%.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-09T15:13:48Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')\n+        except JSONRPCException as e:\n+            assert(e.error['code']==-12)\n+\n+        # drain the external keys\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        assert(len(addr) == 6)\n+        # the next one should fail\n+        try:\n+            addr = nodes[0].getnewaddress()\n+            raise AssertionError('Keypool should be exhausted after three external addresses (ceil rounded 80% of six)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95173485",
      "id" : 95173485,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 46,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95173485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386634"
         }
      },
      "body" : "I think it make sense to keep this as it is: `keypoolsize` should be alined with the `-keypool` conf. That's why `keypoolsize` in `getwalletinfo` responses only the external key-count in the keypool (`-keypool` conf arg also defines the external key count).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T15:28:26Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386634",
      "id" : 95386634,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 15939297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386917"
         }
      },
      "body" : "> IMO it would be better to use an enum for internal vs external rather than a bool.\r\n\r\nWhy? Either its internal or external. Once we have more configurable HD key derivation (ext-pubkey-derivation, hd-multisig) we could switch to a enum or a more flexible design.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T15:29:39Z",
      "diff_hunk" : "@@ -87,7 +87,7 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-CPubKey CWallet::GenerateNewKey()\n+CPubKey CWallet::GenerateNewKey(bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386917",
      "id" : 95386917,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 15939594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95389732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95389732"
         }
      },
      "body" : "Right. This is no longer required because we always derive at minimum 2 internal keys. And `ReserveKeyFromKeyPool` will topup the keypool.\r\nWill remove that part.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T15:41:36Z",
      "diff_hunk" : "@@ -3129,7 +3151,11 @@ bool CReserveKey::GetReservedKey(CPubKey& pubkey, bool internal)\n         if (nIndex != -1)\n             vchPubKey = keypool.vchPubKey;\n         else {\n-            return false;\n+            if (pwallet->IsLocked())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95389732",
      "id" : 95389732,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 153,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15942513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95389732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95392157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95392157"
         }
      },
      "body" : "> I find it a bit confusing that this value goes from 0(non-existant) to -keypool then to -keypool*.2. Perhaps have it start at 0 on previous commit, then set it to non-0 here (unless there is reasoning).\r\n\r\nFixed. I decided to squash the two commit into a single one because the current PR is a non-splittable change.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T15:51:11Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95392157",
      "id" : 95392157,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 15945010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95392157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Fixed @instagibbs points. Squashed into a single commit.",
      "created_at" : "2017-01-10T15:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271612354",
      "id" : 271612354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-10T15:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271612354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95394754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95394754"
         }
      },
      "body" : "Sorry, I agree with what you're saying I just wasn't clear enough. I suppose it's along the lines of @luke-jr 's comment about enum, keeping flexible for the future. Not a blocker, just a suggestion. That can be deferred. ",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T16:01:15Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95394754",
      "id" : 95394754,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 15947689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95394754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "utACK 4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T16:04:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271616131",
      "id" : 271616131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-10T16:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271616131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95395818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95395818"
         }
      },
      "body" : "Right. This is generally a good idea. IMO the next possible HD extensions (far away) are maybe xpub watch-only-wallets, flexible keypath, hd-multisig.\r\nI can't imagine any change the would require a third (or more then two) type(s) during key derivation as well as in the keypool.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-10T16:05:09Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95395818",
      "id" : 95395818,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 15948789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95395818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "I'm not sure how this would work together with #8723 but at a first glance at the code, it seems to simplify things: concept ACK. Can you explain more about its interaction with #8723 and maybe suggest one of them to focus review on first?",
      "created_at" : "2017-01-10T18:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271653613",
      "id" : 271653613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-10T18:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271653613",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1008458?v=3",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2017-01-12T19:46:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-272262994",
      "id" : 272262994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-12T19:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272262994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876001"
         }
      },
      "body" : "This should set nInternalChainCounter for old versions - maybe use `std::numeric_limits<uint32_t>::max()` (and make it private, with all accessors throwing if it's not a sufficient version)?\r\n\r\nAlso, braces, please.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:19:41Z",
      "diff_hunk" : "@@ -58,13 +61,16 @@ class CHDChain\n     {\n         READWRITE(this->nVersion);\n         READWRITE(nExternalChainCounter);\n+        if (this->nVersion >= VERSION_HD_CHAIN_SPLIT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876001",
      "id" : 95876001,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 18,
      "path" : "src/wallet/walletdb.h",
      "position" : 18,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876240"
         }
      },
      "body" : "To avoid implicit casting when/if the type changes for this parameter. Also makes it clearer at the call-locations what the parameter is specifying.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:21:02Z",
      "diff_hunk" : "@@ -87,7 +87,7 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-CPubKey CWallet::GenerateNewKey()\n+CPubKey CWallet::GenerateNewKey(bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876240",
      "id" : 95876240,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876524"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876524"
         }
      },
      "body" : "Is there a reason to do this check here, rather than inside `DeriveNewChildKey`?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:22:25Z",
      "diff_hunk" : "@@ -100,7 +100,7 @@ CPubKey CWallet::GenerateNewKey()\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret);\n+        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876524",
      "id" : 95876524,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876524",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876955"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876955"
         }
      },
      "body" : "Seems like this could be significantly simplified with:\r\n\r\n```C++\r\nuint32_t &nChainCounter = (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter);\r\n```",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:24:34Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(chainChildKey, BIP32_HARDENED_KEY_LIMIT+(internal ? 1 : 0));\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        chainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95876955",
      "id" : 95876955,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 50,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95876955",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95877306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95877306"
         }
      },
      "body" : "I think this won't work if the user specifies a HD-but-not-split wallet version for `-walletupgrade`?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:26:25Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95877306",
      "id" : 95877306,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95877306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95877821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95877821"
         }
      },
      "body" : "Probably should check the return value here. Since `TopUpKeyPool` also checks `IsLocked`, perhaps replace it above?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:29:27Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95877821",
      "id" : 95877821,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 103,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95877821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95878452"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95878452"
         }
      },
      "body" : "Maybe `KeypoolCountKeys(bool internal)`?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:32:56Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95878452",
      "id" : 95878452,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 112,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95878452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95878639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95878639"
         }
      },
      "body" : "Iterating over the entire keypool, even if small (which is not guaranteed), seems excessive to do for every keypool top-up... *especially* if we're reading the wallet db (ie, I/O) for each key.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:34:02Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()\n+{\n+    AssertLockHeld(cs_wallet); // setKeyPool\n+\n+    CWalletDB walletdb(strWalletFile);\n+\n+    // count amount of external keys\n+    size_t amountE = 0;\n+    for(const int64_t& id : setKeyPool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95878639",
      "id" : 95878639,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 117,
      "path" : "src/wallet/wallet.cpp",
      "position" : 124,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95878639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95879714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95879714"
         }
      },
      "body" : "Shouldn't the cast be directly on `nTargetSize`, rather than the result of the subtraction?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:39:45Z",
      "diff_hunk" : "@@ -2890,30 +2906,45 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95879714",
      "id" : 95879714,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 151,
      "path" : "src/wallet/wallet.cpp",
      "position" : 158,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95879714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95879952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95879952"
         }
      },
      "body" : "Also don't create extra internal keys (already current code behaviour, but comment could be clearer).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:40:55Z",
      "diff_hunk" : "@@ -2890,30 +2906,45 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);\n+        int64_t missingInternal = max(targetInternal - amountInternal, (int64_t) 0);\n+\n+        if (!IsHDEnabled() || !CanSupportFeature(FEATURE_HD_SPLIT))\n+        {\n+            // don't flag keypool keys internal if we don't use HD",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95879952",
      "id" : 95879952,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 156,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95879952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95880566"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95880566"
         }
      },
      "body" : "Better to count down and avoid adding every iteration:\r\n\r\n```C++\r\nfor (int64_t i = missingInternal + missingExternal; i--; )\r\n```",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:43:51Z",
      "diff_hunk" : "@@ -2890,30 +2906,45 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);\n+        int64_t missingInternal = max(targetInternal - amountInternal, (int64_t) 0);\n+\n+        if (!IsHDEnabled() || !CanSupportFeature(FEATURE_HD_SPLIT))\n+        {\n+            // don't flag keypool keys internal if we don't use HD\n+            missingInternal = 0;\n+        }\n+        bool internal = true;\n+        CWalletDB walletdb(strWalletFile);\n+        for(unsigned int i = 0; i < missingInternal + missingExternal; i++)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95880566",
      "id" : 95880566,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 161,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95880566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95880783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95880783"
         }
      },
      "body" : "(Assuming counting down, and `internal` initialised to `false` above:)\r\n\r\n```C++\r\nif (i < missingInternal) {\r\n    internal = true;\r\n}\r\n```",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:45:03Z",
      "diff_hunk" : "@@ -2890,30 +2906,45 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);\n+        int64_t missingInternal = max(targetInternal - amountInternal, (int64_t) 0);\n+\n+        if (!IsHDEnabled() || !CanSupportFeature(FEATURE_HD_SPLIT))\n+        {\n+            // don't flag keypool keys internal if we don't use HD\n+            missingInternal = 0;\n+        }\n+        bool internal = true;\n+        CWalletDB walletdb(strWalletFile);\n+        for(unsigned int i = 0; i < missingInternal + missingExternal; i++)\n         {\n             int64_t nEnd = 1;\n+            internal = (i < missingInternal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95880783",
      "id" : 95880783,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 164,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95880783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95881341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95881341"
         }
      },
      "body" : "These exceptions used to be thrown after the key was removed from the set, allowing a retry to succeed. That is no longer the case here, potentially leading to irrecoverable situations. I'm unsure if this is good or bad.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:48:04Z",
      "diff_hunk" : "@@ -2929,14 +2960,24 @@ void CWallet::ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool)\n \n         CWalletDB walletdb(strWalletFile);\n \n-        nIndex = *(setKeyPool.begin());\n-        setKeyPool.erase(setKeyPool.begin());\n-        if (!walletdb.ReadPool(nIndex, keypool))\n-            throw runtime_error(std::string(__func__) + \": read failed\");\n-        if (!HaveKey(keypool.vchPubKey.GetID()))\n-            throw runtime_error(std::string(__func__) + \": unknown key in key pool\");\n-        assert(keypool.vchPubKey.IsValid());\n-        LogPrintf(\"keypool reserve %d\\n\", nIndex);\n+        // try to find a key that matches the internal/external filter\n+        for(const int64_t& id : setKeyPool)\n+        {\n+            CKeyPool tmpKeypool;\n+            if (!walletdb.ReadPool(id, tmpKeypool))\n+                throw runtime_error(std::string(__func__) + \": read failed\");\n+            if (!HaveKey(tmpKeypool.vchPubKey.GetID()))\n+                throw runtime_error(std::string(__func__) + \": unknown key in key pool\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95881341",
      "id" : 95881341,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 202,
      "path" : "src/wallet/wallet.cpp",
      "position" : 210,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95881341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95882702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95882702"
         }
      },
      "body" : "Maybe throw an exception if `!ser_action.ForRead() && fInternal`?\r\n\r\nEither way, please add braces.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:55:39Z",
      "diff_hunk" : "@@ -111,6 +116,13 @@ class CKeyPool\n             READWRITE(nVersion);\n         READWRITE(nTime);\n         READWRITE(vchPubKey);\n+        if (nVersion >= FEATURE_HD_SPLIT)\n+            READWRITE(fInternal);\n+        else\n+        {\n+            if (ser_action.ForRead())\n+                fInternal = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95882702",
      "id" : 95882702,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 32,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95882702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95882966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95882966"
         }
      },
      "body" : "Do we want `internal` to have a default? Should it be `false`? IIRC currently new keys default to change unless added to the address book, so this default seems to contradict the status quo.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:56:54Z",
      "diff_hunk" : "@@ -712,8 +724,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * keystore implementation\n      * Generate a new key\n      */\n-    CPubKey GenerateNewKey();\n-    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret);\n+    CPubKey GenerateNewKey(bool internal = false);\n+    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool internal = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95882966",
      "id" : 95882966,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 44,
      "path" : "src/wallet/wallet.h",
      "position" : 49,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95882966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95883264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95883264"
         }
      },
      "body" : "Missing logic to initialise this version.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T20:58:26Z",
      "diff_hunk" : "@@ -46,9 +46,12 @@ class CHDChain\n {\n public:\n     uint32_t nExternalChainCounter;\n+    uint32_t nInternalChainCounter;\n     CKeyID masterKeyID; //!< master key hash160\n \n-    static const int CURRENT_VERSION = 1;\n+    static const int VERSION_HD_BASE        = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95883264",
      "id" : 95883264,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 8,
      "path" : "src/wallet/walletdb.h",
      "position" : 8,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95883264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95883977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95883977"
         }
      },
      "body" : "`keypoolsize` should probably be the lower of the two and deprecated. There is no reason to assume prior use didn't look at it for info on change keys.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T21:02:36Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95883977",
      "id" : 95883977,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 49,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 58,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95883977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95884181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95884181"
         }
      },
      "body" : "`\"keypoolsizes\": {\"internal\": N, \"external\": N}` sounds like a good idea here.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T21:03:47Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95884181",
      "id" : 95884181,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95884181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95884308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95884308"
         }
      },
      "body" : "Shouldn't this use `CanSupportFeature(FEATURE_HD_SPLIT)`?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-12T21:04:32Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95884308",
      "id" : 95884308,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 51,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 60,
      "pull_request_review_id" : 16446426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95884308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947333"
         }
      },
      "body" : "I think always reporting `keypoolsize_hd_internal` (with 0 in non HD-SPLIT case) can make parsing simpler.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:18:00Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947333",
      "id" : 95947333,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 51,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 60,
      "pull_request_review_id" : 16518323,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947412"
         }
      },
      "body" : "I though about that, but this would break the API while the current PRs change does not.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:18:52Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947412",
      "id" : 95947412,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 61,
      "pull_request_review_id" : 16518396,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947588"
         }
      },
      "body" : "A design question, but IMO `DeriveNewChildKey` should execute the derivation and not care about wallet versions and supported features.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:20:56Z",
      "diff_hunk" : "@@ -100,7 +100,7 @@ CPubKey CWallet::GenerateNewKey()\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret);\n+        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947588",
      "id" : 95947588,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 16518563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947698"
         }
      },
      "body" : "I think we should no longer allow non split HD versions.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:22:18Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947698",
      "id" : 95947698,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16518664,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947698",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947772"
         }
      },
      "body" : "The program can never reach this point in `IsLocked()` state because we return at L2871.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:23:10Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947772",
      "id" : 95947772,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 103,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16518728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947886"
         }
      },
      "body" : "Again a design question. setKeyPool.size() - KeypoolCountExternalKeys() = internal key count.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:24:29Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95947886",
      "id" : 95947886,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 112,
      "pull_request_review_id" : 16518846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95947886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948005"
         }
      },
      "body" : "I think we have no other reliable way here and the performance impact should be little. BDB should be pretty fast for that operation and we are only opening the DB once.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:26:06Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()\n+{\n+    AssertLockHeld(cs_wallet); // setKeyPool\n+\n+    CWalletDB walletdb(strWalletFile);\n+\n+    // count amount of external keys\n+    size_t amountE = 0;\n+    for(const int64_t& id : setKeyPool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948005",
      "id" : 95948005,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 117,
      "path" : "src/wallet/wallet.cpp",
      "position" : 124,
      "pull_request_review_id" : 16518966,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948431"
         }
      },
      "body" : "I have set the default to false to keep the exiting behaviour.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:31:27Z",
      "diff_hunk" : "@@ -712,8 +724,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * keystore implementation\n      * Generate a new key\n      */\n-    CPubKey GenerateNewKey();\n-    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret);\n+    CPubKey GenerateNewKey(bool internal = false);\n+    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool internal = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948431",
      "id" : 95948431,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 44,
      "path" : "src/wallet/wallet.h",
      "position" : 49,
      "pull_request_review_id" : 16519404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948510"
         }
      },
      "body" : "`VERSION_HD_BASE` is only there to identify versions that do not support HD SPLIT (first HD version introduced in 0.13).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T07:32:24Z",
      "diff_hunk" : "@@ -46,9 +46,12 @@ class CHDChain\n {\n public:\n     uint32_t nExternalChainCounter;\n+    uint32_t nInternalChainCounter;\n     CKeyID masterKeyID; //!< master key hash160\n \n-    static const int CURRENT_VERSION = 1;\n+    static const int VERSION_HD_BASE        = 1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95948510",
      "id" : 95948510,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 8,
      "path" : "src/wallet/walletdb.h",
      "position" : 8,
      "pull_request_review_id" : 16519491,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95948510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Added a commit that addresses some of @luke-jr points.\r\nMaybe we can try to not bike-shed this with to many design and code-style nits (braces, etc.) otherwise we will very likely delay this for 0.15.",
      "created_at" : "2017-01-13T07:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-272380206",
      "id" : 272380206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-13T07:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272380206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032020"
         }
      },
      "body" : "Then always report it? Right now it's conditional on something more or less irrelevant.\r\n\r\nBut I'm not sure it makes sense to ever report 0 when there are indeed keys that will be used for internal outputs...",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:09:43Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032020",
      "id" : 96032020,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 51,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 60,
      "pull_request_review_id" : 16607871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032283"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032283"
         }
      },
      "body" : "My point is that the existing behaviour is closer to `true` than `false`.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:10:59Z",
      "diff_hunk" : "@@ -712,8 +724,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * keystore implementation\n      * Generate a new key\n      */\n-    CPubKey GenerateNewKey();\n-    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret);\n+    CPubKey GenerateNewKey(bool internal = false);\n+    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool internal = false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032283",
      "id" : 96032283,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 44,
      "path" : "src/wallet/wallet.h",
      "position" : 49,
      "pull_request_review_id" : 16608143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032283",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032544"
         }
      },
      "body" : "Is there some reason not to have a vector or map of separate setKeyPools? (With the current setKeyPool a special case for external keys)",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:12:08Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()\n+{\n+    AssertLockHeld(cs_wallet); // setKeyPool\n+\n+    CWalletDB walletdb(strWalletFile);\n+\n+    // count amount of external keys\n+    size_t amountE = 0;\n+    for(const int64_t& id : setKeyPool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032544",
      "id" : 96032544,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 117,
      "path" : "src/wallet/wallet.cpp",
      "position" : 124,
      "pull_request_review_id" : 16608420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032629"
         }
      },
      "body" : "That's going to break as soon as we have more than internal/external key pools...",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:12:33Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032629",
      "id" : 96032629,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 109,
      "path" : "src/wallet/wallet.cpp",
      "position" : 112,
      "pull_request_review_id" : 16608503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032856"
         }
      },
      "body" : "`TopUpKeyPool` could return `false` for other reasons as well. There's no need to check `IsLocked` at L2871; it's redundant. So just remove that check and do:\r\n\r\n```C++\r\nif (!TopUpKeyPool()) {\r\n    return false;\r\n}\r\n```",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:13:56Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96032856",
      "id" : 96032856,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 103,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16608759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96032856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96033021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96033021"
         }
      },
      "body" : "Maybe move it to `private:` then?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T17:14:52Z",
      "diff_hunk" : "@@ -100,7 +100,7 @@ CPubKey CWallet::GenerateNewKey()\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret);\n+        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96033021",
      "id" : 96033021,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 14,
      "path" : "src/wallet/wallet.cpp",
      "position" : 14,
      "pull_request_review_id" : 16608945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96033021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96049236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96049236"
         }
      },
      "body" : "Since almost everything here is different depending on internal/external, I think it'd be clearer to just make it ```if (internal)``` and separate the behaviors",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-13T18:46:25Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(chainChildKey, BIP32_HARDENED_KEY_LIMIT+(internal ? 1 : 0));\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        chainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96049236",
      "id" : 96049236,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 50,
      "path" : "src/wallet/wallet.cpp",
      "position" : 50,
      "pull_request_review_id" : 16626108,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96049236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96106550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96106550"
         }
      },
      "body" : "This also forcibly upgrades the user's wallet (if from pre-split HD version) if they encrypt their wallet, which I think is unaccptable.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T02:34:17Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96106550",
      "id" : 96106550,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16685243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96106550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96106666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96106666"
         }
      },
      "body" : "Can we just set the target for both internal and external to nTargetSize? It seems super non-user-friendly that the setting which used to mean \"can create this many keys/transactions\" now means \"can create this many keys, or 1/5th as many transactions\". I dont think we care all that much about the performance hit, do we?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T02:38:14Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96106666",
      "id" : 96106666,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 16685343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96106666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107402"
         }
      },
      "body" : "Note that if you change this need to set the newHdChain's version to the appropriate value prior to SetHDChain.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:11:15Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107402",
      "id" : 96107402,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16686065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107529"
         }
      },
      "body" : "I think the 10% number is wrong? current code is 20, I believe? (and I think it should be changed to 100).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:18:43Z",
      "diff_hunk" : "@@ -2296,16 +2296,17 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n             \"Returns an object containing various wallet state info.\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n-            \"  \\\"walletversion\\\": xxxxx,       (numeric) the wallet version\\n\"\n-            \"  \\\"balance\\\": xxxxxxx,           (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"unconfirmed_balance\\\": xxx,   (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"immature_balance\\\": xxxxxx,   (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"txcount\\\": xxxxxxx,           (numeric) the total number of transactions in the wallet\\n\"\n-            \"  \\\"keypoololdest\\\": xxxxxx,      (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n-            \"  \\\"keypoolsize\\\": xxxx,          (numeric) how many new keys are pre-generated\\n\"\n-            \"  \\\"unlocked_until\\\": ttt,        (numeric) the timestamp in seconds since epoch (midnight Jan 1 1970 GMT) that the wallet is unlocked for transfers, or 0 if the wallet is locked\\n\"\n-            \"  \\\"paytxfee\\\": x.xxxx,           (numeric) the transaction fee configuration, set in \" + CURRENCY_UNIT + \"/kB\\n\"\n-            \"  \\\"hdmasterkeyid\\\": \\\"<hash160>\\\" (string) the Hash160 of the HD master pubkey\\n\"\n+            \"  \\\"walletversion\\\": xxxxx,          (numeric) the wallet version\\n\"\n+            \"  \\\"balance\\\": xxxxxxx,              (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"unconfirmed_balance\\\": xxx,      (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"immature_balance\\\": xxxxxx,      (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"txcount\\\": xxxxxxx,              (numeric) the total number of transactions in the wallet\\n\"\n+            \"  \\\"keypoololdest\\\": xxxxxx,         (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n+            \"  \\\"keypoolsize\\\": xxxx,             (numeric) how many new keys are pre-generated\\n\"\n+            \"  \\\"keypoolsize_hd_internal\\\": xxxx, (numeric) how many new keys are pre-generated for internal use (change outputs, 10% of the -keypoolsize target, only appears if HD is enabled)\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107529",
      "id" : 96107529,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 30,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16686184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107555"
         }
      },
      "body" : "I think we really need to update this - keypoololdest is used to know when your backup has been invalidated. I know technically now that we have HD wallets arent invalidated, but until we have rebuilding-from-chain implemented I think we really need to make sure keypoololdest is still useable as \"if your backup is older than this date, backup again\".\r\n\r\nThis means keypoololdest needs to be max(oldest internal keypool, oldest external keypool) isntead.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:20:58Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107555",
      "id" : 96107555,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 47,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 56,
      "pull_request_review_id" : 16686213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107590"
         }
      },
      "body" : "Additionally, this is called at the entry to getwalletinfo, even with HD disabled. While I agree with @luke-jr that there should probably be two separate setKeyPools, at a minimum this function needs an if (!IsHDEnabled()) return setKeyPool.size(); to avoid causing massive slowdown for folks who are using non-hd wallets with massive keypools (to avoid constant backups).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:23:15Z",
      "diff_hunk" : "@@ -2870,18 +2873,31 @@ bool CWallet::NewKeyPool()\n         if (IsLocked())\n             return false;\n \n-        int64_t nKeys = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t)0);\n-        for (int i = 0; i < nKeys; i++)\n-        {\n-            int64_t nIndex = i+1;\n-            walletdb.WritePool(nIndex, CKeyPool(GenerateNewKey()));\n-            setKeyPool.insert(nIndex);\n-        }\n-        LogPrintf(\"CWallet::NewKeyPool wrote %d new keys\\n\", nKeys);\n+        TopUpKeyPool();\n+        LogPrintf(\"CWallet::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n+size_t CWallet::KeypoolCountExternalKeys()\n+{\n+    AssertLockHeld(cs_wallet); // setKeyPool\n+\n+    CWalletDB walletdb(strWalletFile);\n+\n+    // count amount of external keys\n+    size_t amountE = 0;\n+    for(const int64_t& id : setKeyPool)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107590",
      "id" : 96107590,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 117,
      "path" : "src/wallet/wallet.cpp",
      "position" : 124,
      "pull_request_review_id" : 16686247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107590",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107623"
         }
      },
      "body" : "Maybe also mention that keypoolsize_hd_internal is NOT included in this count, as one might assume that external_keypool = keypoolsize - keypoolsize_hd_internal from these docs.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:25:15Z",
      "diff_hunk" : "@@ -2296,16 +2296,17 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n             \"Returns an object containing various wallet state info.\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n-            \"  \\\"walletversion\\\": xxxxx,       (numeric) the wallet version\\n\"\n-            \"  \\\"balance\\\": xxxxxxx,           (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"unconfirmed_balance\\\": xxx,   (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"immature_balance\\\": xxxxxx,   (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"txcount\\\": xxxxxxx,           (numeric) the total number of transactions in the wallet\\n\"\n-            \"  \\\"keypoololdest\\\": xxxxxx,      (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n-            \"  \\\"keypoolsize\\\": xxxx,          (numeric) how many new keys are pre-generated\\n\"\n-            \"  \\\"unlocked_until\\\": ttt,        (numeric) the timestamp in seconds since epoch (midnight Jan 1 1970 GMT) that the wallet is unlocked for transfers, or 0 if the wallet is locked\\n\"\n-            \"  \\\"paytxfee\\\": x.xxxx,           (numeric) the transaction fee configuration, set in \" + CURRENCY_UNIT + \"/kB\\n\"\n-            \"  \\\"hdmasterkeyid\\\": \\\"<hash160>\\\" (string) the Hash160 of the HD master pubkey\\n\"\n+            \"  \\\"walletversion\\\": xxxxx,          (numeric) the wallet version\\n\"\n+            \"  \\\"balance\\\": xxxxxxx,              (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"unconfirmed_balance\\\": xxx,      (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"immature_balance\\\": xxxxxx,      (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"txcount\\\": xxxxxxx,              (numeric) the total number of transactions in the wallet\\n\"\n+            \"  \\\"keypoololdest\\\": xxxxxx,         (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n+            \"  \\\"keypoolsize\\\": xxxx,             (numeric) how many new keys are pre-generated\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107623",
      "id" : 96107623,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 29,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16686282,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107802"
         }
      },
      "body" : "This should be max(max(nTargetSize, 1) - amountExternal, 0) to avoid violating some of the assumptions about at least one keypool entry being available after TopUpKeyPool returns.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:36:28Z",
      "diff_hunk" : "@@ -2890,30 +2906,45 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96107802",
      "id" : 96107802,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 151,
      "path" : "src/wallet/wallet.cpp",
      "position" : 158,
      "pull_request_review_id" : 16686460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96107802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96108060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96108060"
         }
      },
      "body" : "You need to check if internal is enabled here, not just hd enabled, I think. GetReservedKey is used in a few places with internal set to true without checking if internal is enabled, and if its not, you could end up never succeeding in getting a key, since HD might be enabled, but they never find an internal key.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T03:53:05Z",
      "diff_hunk" : "@@ -2929,14 +2961,24 @@ void CWallet::ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool)\n \n         CWalletDB walletdb(strWalletFile);\n \n-        nIndex = *(setKeyPool.begin());\n-        setKeyPool.erase(setKeyPool.begin());\n-        if (!walletdb.ReadPool(nIndex, keypool))\n-            throw runtime_error(std::string(__func__) + \": read failed\");\n-        if (!HaveKey(keypool.vchPubKey.GetID()))\n-            throw runtime_error(std::string(__func__) + \": unknown key in key pool\");\n-        assert(keypool.vchPubKey.IsValid());\n-        LogPrintf(\"keypool reserve %d\\n\", nIndex);\n+        // try to find a key that matches the internal/external filter\n+        for(const int64_t& id : setKeyPool)\n+        {\n+            CKeyPool tmpKeypool;\n+            if (!walletdb.ReadPool(id, tmpKeypool))\n+                throw runtime_error(std::string(__func__) + \": read failed\");\n+            if (!HaveKey(tmpKeypool.vchPubKey.GetID()))\n+                throw runtime_error(std::string(__func__) + \": unknown key in key pool\");\n+            if (!IsHDEnabled() || tmpKeypool.fInternal == internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96108060",
      "id" : 96108060,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 204,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 16686723,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96108060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96108183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96108183"
         }
      },
      "body" : "I do not believe the serializer version is set to the wallet's version. I believe it is the one set in src/wallet/db.h - CLIENT_VERSION.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-14T04:02:23Z",
      "diff_hunk" : "@@ -111,6 +116,13 @@ class CKeyPool\n             READWRITE(nVersion);\n         READWRITE(nTime);\n         READWRITE(vchPubKey);\n+        if (nVersion >= FEATURE_HD_SPLIT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96108183",
      "id" : 96108183,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 27,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 16686868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96108183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96177396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96177396"
         }
      },
      "body" : "Agree. But probably in a separate PR.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T08:01:35Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96177396",
      "id" : 96177396,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 47,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 56,
      "pull_request_review_id" : 16753179,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:11:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96177396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96197113"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96197113"
         }
      },
      "body" : "Where do you see the need to set the `nInternalChainCounter` for old versions here? Old Versions will always have the `nInternalChainCounter` set the `0` over `SetNull()` during the constructor call.\r\n\r\nA new chain (which then will enable `VERSION_HD_CHAIN_SPLIT`) can only be created when a new HD master key will be set which again will enable `FEATURE_HD_SPLIT`.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T10:16:06Z",
      "diff_hunk" : "@@ -58,13 +61,16 @@ class CHDChain\n     {\n         READWRITE(this->nVersion);\n         READWRITE(nExternalChainCounter);\n+        if (this->nVersion >= VERSION_HD_CHAIN_SPLIT)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96197113",
      "id" : 96197113,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 18,
      "path" : "src/wallet/walletdb.h",
      "position" : 18,
      "pull_request_review_id" : 16772475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:16:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96197113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96198575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96198575"
         }
      },
      "body" : "Some weeks back we discusses that and we came up with something that we should create less internal keys. But I'm fine with 100%/100%. Any objections?",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T10:24:12Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96198575",
      "id" : 96198575,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 16774032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:24:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96198575",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96198987"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96198987"
         }
      },
      "body" : "We could... one question is: if the users encrypt his 0.13 wallet (HD enabled but no chain split) in 0.14. Do we want to keep the non-hd split or do we want to enforce an upgrade to HD_Split. The later seems preferable from the users perspective (Is there a reason to not split the HD chains if we can?).",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T10:26:45Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96198987",
      "id" : 96198987,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16774452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T10:26:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96198987",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Added a couple of fixes:\r\n* Most important, as @TheBlueMatt has discovered, the `nVersion` handling of `CKeyPool` was wrong. I have fixed it with a `try{}` to serialise the `fInternal` boolean.\r\n* Return `setKeyPool.size()` if hd or hd-chain-split is disabled\r\n* Removed redundant `IsLocked()` check\r\n* Fixed wrong keypool internal size in RPC help\r\n* Make sure we hand out keypool keys if HD_SPLIT is not enabled\r\n\r\n\r\nI did not cover design-changes and non-important nits in order to get this merged today before the feature freeze. We can fix things and make it more elegant after a possible merge.\r\nI also not changed the keypool distribution (still 100%/20%). Can be done after the freeze and once we all agree whether we'd like to have 100/20 or 100/100.",
      "created_at" : "2017-01-16T10:33:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-272826123",
      "id" : 272826123,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-16T10:33:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272826123",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96299096"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96299096"
         }
      },
      "body" : "I believe it is policy to not upgrade a user's wallet unless they have specifically requested we do so, so, no, I dont think we should use HD_Split at that point.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T20:18:08Z",
      "diff_hunk" : "@@ -1294,8 +1297,8 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n {\n     LOCK(cs_wallet);\n \n-    // ensure this wallet.dat can only be opened by clients supporting HD\n-    SetMinVersion(FEATURE_HD);\n+    // ensure this wallet.dat can only be opened by clients supporting HD with chain split\n+    SetMinVersion(FEATURE_HD_SPLIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96299096",
      "id" : 96299096,
      "original_commit_id" : "0a7b70aa7b8613ab1bcc50fed6d44f6e5c3deb4e",
      "original_position" : 78,
      "path" : "src/wallet/wallet.cpp",
      "position" : 78,
      "pull_request_review_id" : 16876809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T20:18:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96299096",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "ACK e34676e\r\n",
      "created_at" : "2017-01-16T20:39:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-272957165",
      "id" : 272957165,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-16T20:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272957165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304197"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304197"
         }
      },
      "body" : "s/chnage/change/",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T21:00:49Z",
      "diff_hunk" : "@@ -2296,16 +2296,17 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n             \"Returns an object containing various wallet state info.\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n-            \"  \\\"walletversion\\\": xxxxx,       (numeric) the wallet version\\n\"\n-            \"  \\\"balance\\\": xxxxxxx,           (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"unconfirmed_balance\\\": xxx,   (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"immature_balance\\\": xxxxxx,   (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"txcount\\\": xxxxxxx,           (numeric) the total number of transactions in the wallet\\n\"\n-            \"  \\\"keypoololdest\\\": xxxxxx,      (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n-            \"  \\\"keypoolsize\\\": xxxx,          (numeric) how many new keys are pre-generated\\n\"\n-            \"  \\\"unlocked_until\\\": ttt,        (numeric) the timestamp in seconds since epoch (midnight Jan 1 1970 GMT) that the wallet is unlocked for transfers, or 0 if the wallet is locked\\n\"\n-            \"  \\\"paytxfee\\\": x.xxxx,           (numeric) the transaction fee configuration, set in \" + CURRENCY_UNIT + \"/kB\\n\"\n-            \"  \\\"hdmasterkeyid\\\": \\\"<hash160>\\\" (string) the Hash160 of the HD master pubkey\\n\"\n+            \"  \\\"walletversion\\\": xxxxx,          (numeric) the wallet version\\n\"\n+            \"  \\\"balance\\\": xxxxxxx,              (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"unconfirmed_balance\\\": xxx,      (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"immature_balance\\\": xxxxxx,      (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"txcount\\\": xxxxxxx,              (numeric) the total number of transactions in the wallet\\n\"\n+            \"  \\\"keypoololdest\\\": xxxxxx,         (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n+            \"  \\\"keypoolsize\\\": xxxx,             (numeric) how many new keys are pre-generated (excluding internal-/chnage-output keys)\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304197",
      "id" : 96304197,
      "original_commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "original_position" : 38,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 38,
      "pull_request_review_id" : 16882110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T21:00:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304197",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304347"
         }
      },
      "body" : "I'd be fine with reducing the internal keypool significantly once we have rescan logic that can regenerate keys, but until then I think we absolutely need to have it be 100%.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T21:02:10Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304347",
      "id" : 96304347,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 16882280,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T21:02:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304722"
         }
      },
      "body" : "Not doing this would break some uses of walletbackup, I think, so I wouldnt be too happy with this slipping into a different release.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T21:05:20Z",
      "diff_hunk" : "@@ -2315,17 +2316,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96304722",
      "id" : 96304722,
      "original_commit_id" : "12fcde55b79d90edffda62a6568c52a9adef8498",
      "original_position" : 47,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 56,
      "pull_request_review_id" : 16882670,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T21:05:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96304722",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96305141"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96305141"
         }
      },
      "body" : "Also, these docs are super confusing - the way I read it, if I have HD enabled I'll never have a keypool for change-output keys, which isnt true - they're just included here.",
      "commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "created_at" : "2017-01-16T21:08:48Z",
      "diff_hunk" : "@@ -2296,16 +2296,17 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n             \"Returns an object containing various wallet state info.\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n-            \"  \\\"walletversion\\\": xxxxx,       (numeric) the wallet version\\n\"\n-            \"  \\\"balance\\\": xxxxxxx,           (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"unconfirmed_balance\\\": xxx,   (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"immature_balance\\\": xxxxxx,   (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n-            \"  \\\"txcount\\\": xxxxxxx,           (numeric) the total number of transactions in the wallet\\n\"\n-            \"  \\\"keypoololdest\\\": xxxxxx,      (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n-            \"  \\\"keypoolsize\\\": xxxx,          (numeric) how many new keys are pre-generated\\n\"\n-            \"  \\\"unlocked_until\\\": ttt,        (numeric) the timestamp in seconds since epoch (midnight Jan 1 1970 GMT) that the wallet is unlocked for transfers, or 0 if the wallet is locked\\n\"\n-            \"  \\\"paytxfee\\\": x.xxxx,           (numeric) the transaction fee configuration, set in \" + CURRENCY_UNIT + \"/kB\\n\"\n-            \"  \\\"hdmasterkeyid\\\": \\\"<hash160>\\\" (string) the Hash160 of the HD master pubkey\\n\"\n+            \"  \\\"walletversion\\\": xxxxx,          (numeric) the wallet version\\n\"\n+            \"  \\\"balance\\\": xxxxxxx,              (numeric) the total confirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"unconfirmed_balance\\\": xxx,      (numeric) the total unconfirmed balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"immature_balance\\\": xxxxxx,      (numeric) the total immature balance of the wallet in \" + CURRENCY_UNIT + \"\\n\"\n+            \"  \\\"txcount\\\": xxxxxxx,              (numeric) the total number of transactions in the wallet\\n\"\n+            \"  \\\"keypoololdest\\\": xxxxxx,         (numeric) the timestamp (seconds since Unix epoch) of the oldest pre-generated key in the key pool\\n\"\n+            \"  \\\"keypoolsize\\\": xxxx,             (numeric) how many new keys are pre-generated (excluding internal-/chnage-output keys)\\n\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r96305141",
      "id" : 96305141,
      "original_commit_id" : "e34676ef42e265ff883c39cc10d6c1b16f2c8331",
      "original_position" : 38,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 38,
      "pull_request_review_id" : 16883103,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-16T21:08:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96305141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
