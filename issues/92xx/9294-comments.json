[
   {
      "body" : "Interesting assertion error in CWallet::CreateRawTransaction\r\n```\r\nstderr:\r\nbitcoind: ../../src/wallet/wallet.cpp:2395: bool CWallet::CreateTransaction(const std::vector<CRecipient>&, CWalletTx&, CReserveKey&, CAmount&, int&, std::string&, const CCoinControl*, bool): Assertion `ret' failed.\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/test_framework.py\", line 145, in main\r\n    self.run_test()\r\n  File \"/home/travis/build/bitcoin/bitcoin/build/../qa/rpc-tests/fundrawtransaction.py\", line 498, in run_test\r\n    fundedTx = self.nodes[1].fundrawtransaction(rawTx)\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/coverage.py\", line 49, in __call__\r\n    return_val = self.auth_service_proxy_instance.__call__(*args, **kwargs)\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/authproxy.py\", line 150, in __call__\r\n    response = self._request('POST', self.__url.path, postdata.encode('utf-8'))\r\n  File \"/home/travis/build/bitcoin/bitcoin/qa/rpc-tests/test_framework/authproxy.py\", line 130, in _request\r\n    self.__conn.request(method, path, postdata, headers)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1125, in request\r\n    self._send_request(method, url, body, headers)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1163, in _send_request\r\n    self.endheaders(body)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 1121, in endheaders\r\n    self._send_output(message_body)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 951, in _send_output\r\n    self.send(msg)\r\n  File \"/usr/lib/python3.4/http/client.py\", line 886, in send\r\n    self.connect()\r\n  File \"/usr/lib/python3.4/http/client.py\", line 863, in connect\r\n    self.timeout, self.source_address)\r\n  File \"/usr/lib/python3.4/socket.py\", line 512, in create_connection\r\n    raise err\r\n  File \"/usr/lib/python3.4/socket.py\", line 503, in create_connection\r\n    sock.connect(sa)\r\n```",
      "created_at" : "2016-12-06T10:44:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-265118191",
      "id" : 265118191,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-06T10:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/265118191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Travis is failing because it did what it is supposed to: finding bugs.\r\nOnce #9295 is merged, travis should succeed.",
      "created_at" : "2016-12-06T12:53:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-265142636",
      "id" : 265142636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-06T12:53:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/265142636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514545"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514545"
         }
      },
      "body" : "Still three?",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-08T13:39:10Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514545",
      "id" : 91514545,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 32,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 12022893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514738"
         }
      },
      "body" : "three?",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-08T13:40:19Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')\n+        except JSONRPCException as e:\n+            assert(e.error['code']==-12)\n+\n+        # drain the external keys\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        assert(len(addr) == 6)\n+        # the next one should fail\n+        try:\n+            addr = nodes[0].getnewaddress()\n+            raise AssertionError('Keypool should be exhausted after three external addresses (ceil rounded 80% of six)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r91514738",
      "id" : 91514738,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 46,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 12023095,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/91514738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6848764?v=3",
         "events_url" : "https://api.github.com/users/paveljanik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/paveljanik/followers",
         "following_url" : "https://api.github.com/users/paveljanik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/paveljanik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/paveljanik",
         "id" : 6848764,
         "login" : "paveljanik",
         "organizations_url" : "https://api.github.com/users/paveljanik/orgs",
         "received_events_url" : "https://api.github.com/users/paveljanik/received_events",
         "repos_url" : "https://api.github.com/users/paveljanik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/paveljanik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/paveljanik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/paveljanik"
      }
   },
   {
      "body" : "> Once #9295 is merged, travis should succeed.\r\n\r\nShall we find out?",
      "created_at" : "2016-12-10T19:20:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266231176",
      "id" : 266231176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-10T19:20:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266231176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased.",
      "created_at" : "2016-12-11T10:16:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266273821",
      "id" : 266273821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-11T10:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266273821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Travis succeeds now.",
      "created_at" : "2016-12-12T08:37:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-266371184",
      "id" : 266371184,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2016-12-12T08:37:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/266371184",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93681318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93681318"
         }
      },
      "body" : "Prefer to explicitly add (internal ? 1 : 0)",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-22T19:19:44Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(int)internal);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93681318",
      "id" : 93681318,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93681318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93688939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93688939"
         }
      },
      "body" : "Seems like it would be better to just access the specific counter once with a post-increment, and use variables here.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-22T20:09:31Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(int)internal);\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        externalChainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);\n+        metadata.hdKeypath = \"m/0'/\" + std::string(internal ? \"1'/\"+ std::to_string(hdChain.nInternalChainCounter) : \"0'/\" + std::to_string(hdChain.nExternalChainCounter)) + \"'\";",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93688939",
      "id" : 93688939,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 44,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93688939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689481"
         }
      },
      "body" : "IMO this is unintuitive ~~and can lead to loss~~. If users set a keypool size of 100, they expect to be able to safely generate 100 addresses between backups. I usually round down to 90 in advice to give some breathing room, but 80% here will break even that.\r\n\r\nTherefore, the full keypool size should be ensured on both chains.\r\n\r\nEdit: Forgot this was HD. Less critical in that case.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-22T20:13:15Z",
      "diff_hunk" : "@@ -2815,30 +2831,42 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // try to generate 80% external keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689481",
      "id" : 93689481,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 137,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689981"
         }
      },
      "body" : "IMO it would be better to use an enum for internal vs external rather than a bool.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-22T20:16:23Z",
      "diff_hunk" : "@@ -87,7 +87,7 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-CPubKey CWallet::GenerateNewKey()\n+CPubKey CWallet::GenerateNewKey(bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981",
      "id" : 93689981,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 14214639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93689981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93692459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93692459"
         }
      },
      "body" : "Yes. This is a discussion point and I'd like to get others feedback (maybe @gmaxwell and @sipa).\r\nThe question is, if you want a keypool of 100 external + 50 (TBD)  internals = total 150 keys, if you set the keypool to 100.\r\n\r\nIMO user given values should be respected. If the user chooses keypool=100, the keypool should contain 100 keys. But as said, no strong opinion on that.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2016-12-22T20:34:41Z",
      "diff_hunk" : "@@ -2815,30 +2831,42 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        // count amount of available keys (internal, external)\n+        // try to generate 80% external keys",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93692459",
      "id" : 93692459,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 137,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 14225939,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93692459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Overhauled after recommendation from @sipa and @luke-jr.\r\n* The amount of external pre-generated keys now back at 100% from `-keypool=(default 100)`.\r\n* The amount of internal pre-generated keys is +20% from `-keypool=(default 100)`.\r\n* Pre-generate two internal keys at minimum\r\n\r\n... this now results in always have 120% keys pre-generated (20% internal key)",
      "created_at" : "2017-01-06T13:49:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-270906367",
      "id" : 270906367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-06T13:49:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270906367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Updated with a small nit-fix (https://github.com/bitcoin/bitcoin/pull/9294#discussion_r93689981) and a fix for wallet-dump.py RPC test. Travis should succeed now.",
      "created_at" : "2017-01-09T07:46:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271225631",
      "id" : 271225631,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-09T07:46:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271225631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167594"
         }
      },
      "body" : "It's called `externalChainChildKey` but it could be either.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T14:45:18Z",
      "diff_hunk" : "@@ -140,19 +140,22 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n     // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n     masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n \n-    // derive m/0'/0'\n-    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+    // derive m/0'/0' (external chain) OR m/0'/1' (internal chain)\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT+(internal ? 1 : 0));\n \n     // derive child key at next index, skip keys already known to the wallet\n     do {\n         // always derive hardened keys\n         // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n         // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        externalChainChildKey.Derive(childKey, (internal ? hdChain.nInternalChainCounter : hdChain.nExternalChainCounter) | BIP32_HARDENED_KEY_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167594",
      "id" : 95167594,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 34,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167924"
         }
      },
      "body" : "update comment",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T14:46:51Z",
      "diff_hunk" : "@@ -1296,7 +1299,7 @@ bool CWallet::SetHDMasterKey(const CPubKey& pubkey)\n     LOCK(cs_wallet);\n \n     // ensure this wallet.dat can only be opened by clients supporting HD",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95167924",
      "id" : 95167924,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 49,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95167924",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95168762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95168762"
         }
      },
      "body" : "/HD/HD split/?",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T14:50:51Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);\n+        int64_t missingExternal = max( (int64_t)(nTargetSize - amountExternal), (int64_t) 0);\n+        int64_t missingInternal = max(targetInternal - amountInternal, (int64_t) 0);\n+\n+        if (!IsHDEnabled() || !CanSupportFeature(FEATURE_HD_SPLIT))\n         {\n-            CKeyPool tmpKeypool;\n-            if (!walletdb.ReadPool(id, tmpKeypool))\n-                throw runtime_error(std::string(__func__) + \": read failed\");\n-            amountI += tmpKeypool.fInternal;\n-            amountE += !tmpKeypool.fInternal;\n+            // don't flag keypool keys internal if we don't use HD",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95168762",
      "id" : 95168762,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 123,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95168762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169601"
         }
      },
      "body" : "I find it a bit confusing that this value goes from `0`(non-existant) to `-keypool` then to `-keypool*.2`. Perhaps have it start at 0 on previous commit, then set it to non-0 here (unless there is reasoning).",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T14:54:57Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169601",
      "id" : 95169601,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 150,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169944"
         }
      },
      "body" : "Seems like a separate optimization?",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T14:56:43Z",
      "diff_hunk" : "@@ -3129,7 +3151,11 @@ bool CReserveKey::GetReservedKey(CPubKey& pubkey, bool internal)\n         if (nIndex != -1)\n             vchPubKey = keypool.vchPubKey;\n         else {\n-            return false;\n+            if (pwallet->IsLocked())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95169944",
      "id" : 95169944,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 153,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95169944",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95171761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95171761"
         }
      },
      "body" : "Might make sense to explicitly count both types and use those counts if we foresee a future with more possible types rather than implicitly count `total - external`. You'd know better than me how likely that is.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T15:05:38Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95171761",
      "id" : 95171761,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 52,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95171761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95173485"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95173485"
         }
      },
      "body" : "also, this is 100%, not 80% of 6. 100% vs 20%, not 80% vs 20%.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-09T15:13:48Z",
      "diff_hunk" : "@@ -28,30 +28,39 @@ def run_test(self):\n         wallet_info = nodes[0].getwalletinfo()\n         assert(addr_before_encrypting_data['hdmasterkeyid'] != wallet_info['hdmasterkeyid'])\n         assert(addr_data['hdmasterkeyid'] == wallet_info['hdmasterkeyid'])\n-        \n+\n         try:\n             addr = nodes[0].getnewaddress()\n             raise AssertionError('Keypool should be exhausted after one address')\n         except JSONRPCException as e:\n             assert(e.error['code']==-12)\n \n-        # put three new keys in the keypool\n+        # put six new keys in the keypool (80% should be external-, 20% internal-keys)\n         nodes[0].walletpassphrase('test', 12000)\n-        nodes[0].keypoolrefill(3)\n+        nodes[0].keypoolrefill(6)\n         nodes[0].walletlock()\n \n-        # drain the keys\n+        # drain the internal keys\n         addr = set()\n         addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        addr.add(nodes[0].getrawchangeaddress())\n-        # assert that four unique addresses were returned\n-        assert(len(addr) == 4)\n         # the next one should fail\n         try:\n             addr = nodes[0].getrawchangeaddress()\n-            raise AssertionError('Keypool should be exhausted after three addresses')\n+            raise AssertionError('Keypool should be exhausted after three internal addresses (20%)')\n+        except JSONRPCException as e:\n+            assert(e.error['code']==-12)\n+\n+        # drain the external keys\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        addr.add(nodes[0].getnewaddress())\n+        assert(len(addr) == 6)\n+        # the next one should fail\n+        try:\n+            addr = nodes[0].getnewaddress()\n+            raise AssertionError('Keypool should be exhausted after three external addresses (ceil rounded 80% of six)')",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95173485",
      "id" : 95173485,
      "original_commit_id" : "324c7f58189cdf0eb98496aac90dc5faafbce071",
      "original_position" : 46,
      "path" : "qa/rpc-tests/keypool.py",
      "position" : null,
      "pull_request_review_id" : 15713403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95173485",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386634"
         }
      },
      "body" : "I think it make sense to keep this as it is: `keypoolsize` should be alined with the `-keypool` conf. That's why `keypoolsize` in `getwalletinfo` responses only the external key-count in the keypool (`-keypool` conf arg also defines the external key count).",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T15:28:26Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386634",
      "id" : 95386634,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 52,
      "pull_request_review_id" : 15939297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386917"
         }
      },
      "body" : "> IMO it would be better to use an enum for internal vs external rather than a bool.\r\n\r\nWhy? Either its internal or external. Once we have more configurable HD key derivation (ext-pubkey-derivation, hd-multisig) we could switch to a enum or a more flexible design.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T15:29:39Z",
      "diff_hunk" : "@@ -87,7 +87,7 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-CPubKey CWallet::GenerateNewKey()\n+CPubKey CWallet::GenerateNewKey(bool internal)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95386917",
      "id" : 95386917,
      "original_commit_id" : "0971c35319bfb5fe3dd7313b26b90541e46db9c0",
      "original_position" : 5,
      "path" : "src/wallet/wallet.cpp",
      "position" : 5,
      "pull_request_review_id" : 15939594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95386917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95389732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95389732"
         }
      },
      "body" : "Right. This is no longer required because we always derive at minimum 2 internal keys. And `ReserveKeyFromKeyPool` will topup the keypool.\r\nWill remove that part.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T15:41:36Z",
      "diff_hunk" : "@@ -3129,7 +3151,11 @@ bool CReserveKey::GetReservedKey(CPubKey& pubkey, bool internal)\n         if (nIndex != -1)\n             vchPubKey = keypool.vchPubKey;\n         else {\n-            return false;\n+            if (pwallet->IsLocked())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95389732",
      "id" : 95389732,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 153,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 15942513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:49:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95389732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95392157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95392157"
         }
      },
      "body" : "> I find it a bit confusing that this value goes from 0(non-existant) to -keypool then to -keypool*.2. Perhaps have it start at 0 on previous commit, then set it to non-0 here (unless there is reasoning).\r\n\r\nFixed. I decided to squash the two commit into a single one because the current PR is a non-splittable change.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T15:51:11Z",
      "diff_hunk" : "@@ -2809,33 +2831,33 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n         // Top up key pool\n         unsigned int nTargetSize;\n         if (kpSize > 0)\n             nTargetSize = kpSize;\n         else\n             nTargetSize = max(GetArg(\"-keypool\", DEFAULT_KEYPOOL_SIZE), (int64_t) 0);\n \n-        // count amount of available keys\n-        // don't rely on a 50%/50% keypool mix\n-        int64_t amountI = 0, amountE = 0;\n-        for(const int64_t& id : setKeyPool)\n+        // count amount of available keys (internal, external)\n+        // make sure the keypool of external keys fits the user selected target (-keypool)\n+        // generate +20% internal keys (minimum 2 keys)\n+        int64_t amountExternal = KeypoolCountExternalKeys();\n+        int64_t amountInternal = setKeyPool.size() - amountExternal;\n+        int64_t targetInternal = max((int64_t)ceil(nTargetSize * 0.2), (int64_t) 2);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95392157",
      "id" : 95392157,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 112,
      "path" : "src/wallet/wallet.cpp",
      "position" : 150,
      "pull_request_review_id" : 15945010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T15:51:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95392157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Fixed @instagibbs points. Squashed into a single commit.",
      "created_at" : "2017-01-10T15:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271612354",
      "id" : 271612354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-10T15:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271612354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95394754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95394754"
         }
      },
      "body" : "Sorry, I agree with what you're saying I just wasn't clear enough. I suppose it's along the lines of @luke-jr 's comment about enum, keeping flexible for the future. Not a blocker, just a suggestion. That can be deferred. ",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T16:01:15Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95394754",
      "id" : 95394754,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 52,
      "pull_request_review_id" : 15947689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T16:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95394754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "utACK 4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T16:04:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#issuecomment-271616131",
      "id" : 271616131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9294",
      "updated_at" : "2017-01-10T16:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271616131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95395818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95395818"
         }
      },
      "body" : "Right. This is generally a good idea. IMO the next possible HD extensions (far away) are maybe xpub watch-only-wallets, flexible keypath, hd-multisig.\r\nI can't imagine any change the would require a third (or more then two) type(s) during key derivation as well as in the keypool.",
      "commit_id" : "4065d5fd44b9ce68a688c82353822a1cf49efe53",
      "created_at" : "2017-01-10T16:05:09Z",
      "diff_hunk" : "@@ -2300,17 +2301,20 @@ UniValue getwalletinfo(const JSONRPCRequest& request)\n     LOCK2(cs_main, pwalletMain->cs_wallet);\n \n     UniValue obj(UniValue::VOBJ);\n+    size_t kpExternalSize = (int)pwalletMain->KeypoolCountExternalKeys();\n     obj.push_back(Pair(\"walletversion\", pwalletMain->GetVersion()));\n     obj.push_back(Pair(\"balance\",       ValueFromAmount(pwalletMain->GetBalance())));\n     obj.push_back(Pair(\"unconfirmed_balance\", ValueFromAmount(pwalletMain->GetUnconfirmedBalance())));\n     obj.push_back(Pair(\"immature_balance\",    ValueFromAmount(pwalletMain->GetImmatureBalance())));\n     obj.push_back(Pair(\"txcount\",       (int)pwalletMain->mapWallet.size()));\n     obj.push_back(Pair(\"keypoololdest\", pwalletMain->GetOldestKeyPoolTime()));\n-    obj.push_back(Pair(\"keypoolsize\",   (int)pwalletMain->GetKeyPoolSize()));\n+    obj.push_back(Pair(\"keypoolsize\", (int64_t)kpExternalSize));\n+    CKeyID masterKeyID = pwalletMain->GetHDChain().masterKeyID;\n+    if (!masterKeyID.IsNull())\n+        obj.push_back(Pair(\"keypoolsize_hd_internal\",   (int64_t)(pwalletMain->GetKeyPoolSize() - kpExternalSize)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9294#discussion_r95395818",
      "id" : 95395818,
      "original_commit_id" : "76c883cd393d7dc7ae547c592134420b93b35897",
      "original_position" : 43,
      "path" : "src/wallet/rpcwallet.cpp",
      "position" : 52,
      "pull_request_review_id" : 15948789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9294",
      "updated_at" : "2017-01-10T16:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95395818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
