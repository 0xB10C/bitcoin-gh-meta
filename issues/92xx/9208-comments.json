[
   {
      "body" : "~~I just realized there's a potential issue here with the callbacks for conflicted transactions; in the case where a disconnected block transaction ends up conflicting with some tx in a block on the reorg, the call to ATMP will fail (because some input is spent) but not be reported via SyncTransaction() as a conflicted transaction.~~\r\n\r\nEDIT: After some discussion with @morcos I think there's not an issue here.  Mempool conflict tracking in general is basically just best-efforts and, in the case of reorgs, dependent on mempool policy already.",
      "created_at" : "2016-11-29T02:05:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-263455075",
      "id" : 263455075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2016-11-29T16:02:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/263455075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Rebased, and removed WIP tag as this is now ready for review.",
      "created_at" : "2017-01-04T21:05:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-270486202",
      "id" : 270486202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-01-04T21:05:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270486202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "concept ACK,  will review",
      "created_at" : "2017-01-04T21:48:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-270496625",
      "id" : 270496625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-01-04T21:48:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270496625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "Needs rebase. utACK.   ",
      "created_at" : "2017-01-08T09:08:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-271139397",
      "id" : 271139397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-01-08T09:08:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271139397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Rebased",
      "created_at" : "2017-01-08T15:13:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-271156931",
      "id" : 271156931,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-01-08T15:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271156931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "utACK 37a90f1ad0b57de2ab4294dfa4a97d2e666dd479\r\n\r\nPR makes sense, and nothing has changed except a few comments since my last review (for 4d70f47a94cc739e92f7d3f8f4f7b11cf7457ca9).\r\n\r\nOne thing I don't understand is why the pruning test needs to change when it sounds like you are saying the disconnect pool memory bound is large enough that losing transactions \"shouldn't practically occur.\" Are you just updating the pruning test as a precaution, or are changes there needed because the chain it creates is unusual?\r\n\r\nAlso this PR has merge conflicts, but they are very minor. The validation.cpp conflict can be fixed by updating AcceptToMemoryPool arguments which changed in edded808fc4eee94c178e1779b90d1c87a08c23a (#9499).\r\n",
      "created_at" : "2017-02-28T22:33:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-283182978",
      "id" : 283182978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-02-28T22:33:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/283182978",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Rebased.\r\n\r\n@ryanofsky The changes to pruning.py are because:\r\n * Policy limits get applied differently than before; we used to ignore some of the chain limits when adding transactions back to the mempool during a reorg (because we wouldn't look for in-mempool descendants until the end).\r\n * The pruning test is trying to build really big blocks in a number of places, to make the chain big enough to be pruned, and in particular in a few places it relies on the mempool being populated with disconnected transactions after a reorg (so changes to policy that would prevent that are problematic for the test).\r\n\r\nSo I mitigated this in part by increasing the chain limits and in part by trying to keep the mempool somewhat populated with a node's wallet transactions at a couple relevant places in the test.\r\n\r\n[I actually briefly thought that because we now save the mempool in between restarts, we may not need the `resendwallettransactions()` calls I added (which I use to populate the mempool somewhat in a couple places), but I tested locally that removing them results in test failure (plausibly because the mined blocks aren't big enough, which I think is due to the reorg behavior change).  I do think this test needs to be overhauled now that many of the assumptions around mempool behavior have changed, but I think we should do that in another PR.]",
      "created_at" : "2017-03-01T18:34:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-283428044",
      "id" : 283428044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-03-01T18:34:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/283428044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Rebased after #9602.",
      "created_at" : "2017-03-07T19:38:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-284835087",
      "id" : 284835087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-03-07T19:38:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/284835087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r104984128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104984128"
         }
      },
      "body" : "In commit \"Store disconnected block transactions outside mempool during reorg\":\r\n\r\nIt looks like the new `MemPoolRemovalReason::REORG` argument for removeRecursive got dropped during the rebase. (Shame that we don't a have test that would catch this, and that the argument is optional to begin with.)\r\n\r\n",
      "commit_id" : "094733802352fe87f71228873ede000864a9db54",
      "created_at" : "2017-03-08T18:15:48Z",
      "diff_hunk" : "@@ -570,6 +570,44 @@ static bool IsCurrentForFeeEstimation()\n     return true;\n }\n \n+/* Add disconnected block transactions back to mempool.\n+ * If a tx fails, then remove all in-mempool descendants.\n+ * Note: we assume that disconnectpool only contains transactions that are NOT\n+ * confirmed in the current chain nor already in the mempool (otherwise,\n+ * in-mempool descendants of such transactions would be removed).\n+ */\n+void ReacceptToMemoryPool(DisconnectedBlockTransactions &disconnectpool)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<uint256> vHashUpdate;\n+    // disconnectpool's insertion_order index sorts the entries from\n+    // oldest to newest, but the oldest entry will be the last tx from the\n+    // latest mined block that was disconnected.\n+    // Iterate disconnectpool in reverse, so that we add transactions\n+    // back to the mempool starting with the earliest transaction that had\n+    // been previously seen in a block.\n+    auto it = disconnectpool.queuedTx.get<insertion_order>().rbegin();\n+    while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n+        // ignore validation errors in resurrected transactions\n+        CValidationState stateDummy;\n+        if ((*it)->IsCoinBase() || !AcceptToMemoryPool(mempool, stateDummy, *it, false, NULL, NULL, true)) {\n+            // If the transaction doesn't make it in to the mempool, remove any\n+            // transactions that depend on it (which would now be orphans).\n+            mempool.removeRecursive(**it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r104984128",
      "id" : 104984128,
      "original_commit_id" : "344862a0aca6e622653132f2be5592e4d26be3cf",
      "original_position" : 27,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 25842851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208",
      "updated_at" : "2017-03-11T02:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/104984128",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/7133040?v=3",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "body" : "Rebased again to pick up the `pruning.py` fix from #9972 ",
      "created_at" : "2017-03-11T02:27:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#issuecomment-285834888",
      "id" : 285834888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9208",
      "updated_at" : "2017-03-11T02:27:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/285834888",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105523003"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105523003"
         }
      },
      "body" : "Thanks for catching this!  Fixed.",
      "commit_id" : "094733802352fe87f71228873ede000864a9db54",
      "created_at" : "2017-03-11T02:28:03Z",
      "diff_hunk" : "@@ -570,6 +570,44 @@ static bool IsCurrentForFeeEstimation()\n     return true;\n }\n \n+/* Add disconnected block transactions back to mempool.\n+ * If a tx fails, then remove all in-mempool descendants.\n+ * Note: we assume that disconnectpool only contains transactions that are NOT\n+ * confirmed in the current chain nor already in the mempool (otherwise,\n+ * in-mempool descendants of such transactions would be removed).\n+ */\n+void ReacceptToMemoryPool(DisconnectedBlockTransactions &disconnectpool)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<uint256> vHashUpdate;\n+    // disconnectpool's insertion_order index sorts the entries from\n+    // oldest to newest, but the oldest entry will be the last tx from the\n+    // latest mined block that was disconnected.\n+    // Iterate disconnectpool in reverse, so that we add transactions\n+    // back to the mempool starting with the earliest transaction that had\n+    // been previously seen in a block.\n+    auto it = disconnectpool.queuedTx.get<insertion_order>().rbegin();\n+    while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n+        // ignore validation errors in resurrected transactions\n+        CValidationState stateDummy;\n+        if ((*it)->IsCoinBase() || !AcceptToMemoryPool(mempool, stateDummy, *it, false, NULL, NULL, true)) {\n+            // If the transaction doesn't make it in to the mempool, remove any\n+            // transactions that depend on it (which would now be orphans).\n+            mempool.removeRecursive(**it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105523003",
      "id" : 105523003,
      "original_commit_id" : "344862a0aca6e622653132f2be5592e4d26be3cf",
      "original_position" : 27,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 26413001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208",
      "updated_at" : "2017-03-11T02:28:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105523003",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105548855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105548855"
         }
      },
      "body" : "Pass the CTransactionRef by reference? That will avoid an atomic inc/dec when copying/destroing the CTransactionRef.",
      "commit_id" : "094733802352fe87f71228873ede000864a9db54",
      "created_at" : "2017-03-12T04:53:29Z",
      "diff_hunk" : "@@ -191,14 +192,19 @@ struct update_lock_points\n     const LockPoints& lp;\n };\n \n-// extracts a TxMemPoolEntry's transaction hash\n+// extracts a transaction hash from CTxMempoolEntry or CTransactionRef\n struct mempoolentry_txid\n {\n     typedef uint256 result_type;\n     result_type operator() (const CTxMemPoolEntry &entry) const\n     {\n         return entry.GetTx().GetHash();\n     }\n+\n+    result_type operator() (CTransactionRef tx) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105548855",
      "id" : 105548855,
      "original_commit_id" : "286390107010781973a872a513184058e35d7f71",
      "original_position" : 22,
      "path" : "src/txmempool.h",
      "position" : 22,
      "pull_request_review_id" : 26437231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208",
      "updated_at" : "2017-03-12T06:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105548855",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105549132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105549132"
         }
      },
      "body" : "`const CTransactionRef&` here as well, or `queuedTx.insert(std::move(tx))` below.",
      "commit_id" : "094733802352fe87f71228873ede000864a9db54",
      "created_at" : "2017-03-12T05:13:35Z",
      "diff_hunk" : "@@ -690,4 +696,81 @@ class CCoinsViewMemPool : public CCoinsViewBacked\n     bool HaveCoins(const uint256 &txid) const;\n };\n \n+/**\n+ * DisconnectedBlockTransactions\n+\n+ * During the reorg, it's desirable to re-add previously confirmed transactions\n+ * to the mempool, so that anything not re-confirmed in the new chain is\n+ * available to be mined. However, it's more efficient to wait until the reorg\n+ * is complete and process all still-unconfirmed transactions at that time,\n+ * since we expect most confirmed transactions to (typically) still be\n+ * confirmed in the new chain, and re-accepting to the memory pool is expensive\n+ * (and therefore better to not do in the middle of reorg-processing).\n+ * Instead, store the disconnected transactions (in order!) as we go, remove any\n+ * that are included in blocks in the new chain, and then process the remaining\n+ * still-unconfirmed transactions at the end.\n+ */\n+\n+// multi_index tag names\n+struct txid_index {};\n+struct insertion_order {};\n+\n+struct DisconnectedBlockTransactions {\n+    typedef boost::multi_index_container<\n+        CTransactionRef,\n+        boost::multi_index::indexed_by<\n+            // sorted by txid\n+            boost::multi_index::hashed_unique<\n+                boost::multi_index::tag<txid_index>,\n+                mempoolentry_txid,\n+                SaltedTxidHasher\n+            >,\n+            // sorted by order in the blockchain\n+            boost::multi_index::sequenced<\n+                boost::multi_index::tag<insertion_order>\n+            >\n+        >\n+    > indexed_disconnected_transactions;\n+\n+    indexed_disconnected_transactions queuedTx;\n+    uint64_t cachedInnerUsage = 0;\n+\n+    // Estimate the overhead of queuedTx to be 6 pointers + an allocation, as\n+    // no exact formula for boost::multi_index_contained is implemented.\n+    size_t DynamicMemoryUsage() const {\n+        return memusage::MallocUsage(sizeof(CTransactionRef) + 6 * sizeof(void*)) * queuedTx.size() + cachedInnerUsage;\n+    }\n+\n+    void addTransaction(CTransactionRef tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105549132",
      "id" : 105549132,
      "original_commit_id" : "286390107010781973a872a513184058e35d7f71",
      "original_position" : 78,
      "path" : "src/txmempool.h",
      "position" : 78,
      "pull_request_review_id" : 26437231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208",
      "updated_at" : "2017-03-12T06:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105549132",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105550013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105550013"
         }
      },
      "body" : "I don't see `MemPoolRemovalReason::REORG` anywhere?",
      "commit_id" : "094733802352fe87f71228873ede000864a9db54",
      "created_at" : "2017-03-12T06:24:26Z",
      "diff_hunk" : "@@ -570,6 +570,44 @@ static bool IsCurrentForFeeEstimation()\n     return true;\n }\n \n+/* Add disconnected block transactions back to mempool.\n+ * If a tx fails, then remove all in-mempool descendants.\n+ * Note: we assume that disconnectpool only contains transactions that are NOT\n+ * confirmed in the current chain nor already in the mempool (otherwise,\n+ * in-mempool descendants of such transactions would be removed).\n+ */\n+void ReacceptToMemoryPool(DisconnectedBlockTransactions &disconnectpool)\n+{\n+    AssertLockHeld(cs_main);\n+    std::vector<uint256> vHashUpdate;\n+    // disconnectpool's insertion_order index sorts the entries from\n+    // oldest to newest, but the oldest entry will be the last tx from the\n+    // latest mined block that was disconnected.\n+    // Iterate disconnectpool in reverse, so that we add transactions\n+    // back to the mempool starting with the earliest transaction that had\n+    // been previously seen in a block.\n+    auto it = disconnectpool.queuedTx.get<insertion_order>().rbegin();\n+    while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n+        // ignore validation errors in resurrected transactions\n+        CValidationState stateDummy;\n+        if ((*it)->IsCoinBase() || !AcceptToMemoryPool(mempool, stateDummy, *it, false, NULL, NULL, true)) {\n+            // If the transaction doesn't make it in to the mempool, remove any\n+            // transactions that depend on it (which would now be orphans).\n+            mempool.removeRecursive(**it);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9208#discussion_r105550013",
      "id" : 105550013,
      "original_commit_id" : "344862a0aca6e622653132f2be5592e4d26be3cf",
      "original_position" : 27,
      "path" : "src/validation.cpp",
      "position" : 27,
      "pull_request_review_id" : 26437231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9208",
      "updated_at" : "2017-03-12T06:24:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/105550013",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
