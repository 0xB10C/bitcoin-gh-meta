[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I like this.\r\n\r\nGeneralizing a bit, I don't like the presence of 'overwrite_if_exists'. It seems like a footgun opportunity in other cases (e.g. overwrite one wallet with another).\r\n\r\nMy preference would be to either make that impossible or gate it behind an rpc toggle (default being don't overwrite, like when using 'cp/mv --interactive').",
      "created_at" : "2017-09-21T00:11:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#issuecomment-331014968",
      "id" : 331014968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11376",
      "updated_at" : "2017-09-21T00:13:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331014968",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Tested and working. Additional test performed (try to backup to a file that symlinks to the wallet)\r\n```\r\n$ ln -s ~/.bitcoin/regtest/wallet.dat ~/.bitcoin/regtest/wallet.dat.symlink\r\nln: failed to create symbolic link '/home/user/.bitcoin/regtest/wallet.dat.symlink': File exists\r\n$ stat ~/.bitcoin/regtest/wallet.dat.symlink | head -n 1\r\n  File: /home/user/.bitcoin/regtest/wallet.dat.symlink -> /home/user/.bitcoin/regtest/wallet.dat\r\n$ ./bitcoin-cli -regtest backupwallet ~/.bitcoin/regtest/wallet.dat.symlink\r\nerror code: -4\r\nerror message:\r\nError: Wallet backup failed!\r\n$ tail -n 1 ~/.bitcoin/regtest/debug.log\r\n2017-09-21 00:25:02 cannot backup to wallet source file /home/user/.bitcoin/regtest/wallet.dat.symlink\r\n$ stat ~/.bitcoin/regtest/wallet.dat | grep Size                                                                                                                    \r\n  Size: 1388544         Blocks: 2712       IO Block: 4096   regular file\r\n```",
      "created_at" : "2017-09-21T00:26:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#issuecomment-331017100",
      "id" : 331017100,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11376",
      "updated_at" : "2017-09-21T00:27:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331017100",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7999704?v=4",
         "events_url" : "https://api.github.com/users/esotericnonsense/events{/privacy}",
         "followers_url" : "https://api.github.com/users/esotericnonsense/followers",
         "following_url" : "https://api.github.com/users/esotericnonsense/following{/other_user}",
         "gists_url" : "https://api.github.com/users/esotericnonsense/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/esotericnonsense",
         "id" : 7999704,
         "login" : "esotericnonsense",
         "organizations_url" : "https://api.github.com/users/esotericnonsense/orgs",
         "received_events_url" : "https://api.github.com/users/esotericnonsense/received_events",
         "repos_url" : "https://api.github.com/users/esotericnonsense/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/esotericnonsense/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/esotericnonsense/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/esotericnonsense"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks. I think this cannot be guaranteed to work with hard links and whatnot, but it's better than nothing.",
      "created_at" : "2017-09-21T01:51:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#issuecomment-331028271",
      "id" : 331028271,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11376",
      "updated_at" : "2017-09-21T01:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331028271",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140142355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140142355"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You can replace these entire try:except: blocks with a simple assert_raises_jsonrpc call (which also checks the error number).",
      "commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "created_at" : "2017-09-21T03:31:42Z",
      "diff_hunk" : "@@ -190,6 +190,22 @@ def run_test(self):\n         assert_equal(self.nodes[1].getbalance(), balance1)\n         assert_equal(self.nodes[2].getbalance(), balance2)\n \n+        # backup to file self must fail\n+        try:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140142355",
      "id" : 140142355,
      "original_commit_id" : "a673e6e9466e50dccf45a353d58ba8884b3220d2",
      "original_position" : 5,
      "path" : "test/functional/walletbackup.py",
      "position" : null,
      "pull_request_review_id" : 64171272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376",
      "updated_at" : "2017-09-21T06:48:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140142355",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I've changed the test cases to use assert_raises_jsonrpc",
      "created_at" : "2017-09-21T06:49:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#issuecomment-331067880",
      "id" : 331067880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11376",
      "updated_at" : "2017-09-21T06:49:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331067880",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/534388?v=4",
         "events_url" : "https://api.github.com/users/tomasvdw/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tomasvdw/followers",
         "following_url" : "https://api.github.com/users/tomasvdw/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tomasvdw/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tomasvdw",
         "id" : 534388,
         "login" : "tomasvdw",
         "organizations_url" : "https://api.github.com/users/tomasvdw/orgs",
         "received_events_url" : "https://api.github.com/users/tomasvdw/received_events",
         "repos_url" : "https://api.github.com/users/tomasvdw/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tomasvdw/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tomasvdw/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tomasvdw"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yikes -- thank you for reporting and fixing this bug.\r\n\r\nI agree with @esotericnonsense and think we should go further; a command called \"backupwallet\" should never delete/overwrite anything, in my opinion.",
      "created_at" : "2017-09-21T15:22:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#issuecomment-331190925",
      "id" : 331190925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11376",
      "updated_at" : "2017-09-21T15:22:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331190925",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280178"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good that you've included this in the try-except block, since `boost::filesystem::equivalent()` can throw, but the generic catch behaviour below would hide the precise error. You could return a more precise error by:\r\n\r\n- using the `equivalent(const path& p1, const path& p2, system::error_code& ec)` form (http://www.boost.org/doc/libs/1_46_0/libs/filesystem/v3/doc/reference.html#equivalent) and checking the returned `error_code`\r\n- testing the error code in the catch block below\r\n- having two try-catch blocks\r\n\r\nPerhaps a little bit overkill since the only way that `boost::filesystem::equivalent()` can throw is if the source `wallet.dat` file doesn't exist or isn't a regular file/directory/symlink. But something to consider.",
      "commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "created_at" : "2017-09-21T15:41:26Z",
      "diff_hunk" : "@@ -672,6 +672,12 @@ bool CWalletDBWrapper::Backup(const std::string& strDest)\n                     pathDest /= strFile;\n \n                 try {\n+                    if (fs::equivalent(pathSrc, pathDest)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280178",
      "id" : 140280178,
      "original_commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "original_position" : 4,
      "path" : "src/wallet/db.cpp",
      "position" : 4,
      "pull_request_review_id" : 64329744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376",
      "updated_at" : "2017-09-21T15:57:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280178",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280302"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: the repository doesn't enforce max line length, so you can join this with the line above.",
      "commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "created_at" : "2017-09-21T15:41:49Z",
      "diff_hunk" : "@@ -672,6 +672,12 @@ bool CWalletDBWrapper::Backup(const std::string& strDest)\n                     pathDest /= strFile;\n \n                 try {\n+                    if (fs::equivalent(pathSrc, pathDest)) {\n+                        LogPrintf(\"cannot backup to wallet source file %s\\n\",\n+                            pathDest.string());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280302",
      "id" : 140280302,
      "original_commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "original_position" : 6,
      "path" : "src/wallet/db.cpp",
      "position" : 6,
      "pull_request_review_id" : 64329744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376",
      "updated_at" : "2017-09-21T15:57:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280302",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: again, no max line length, so you can join this with the line above.",
      "commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "created_at" : "2017-09-21T15:43:10Z",
      "diff_hunk" : "@@ -190,6 +190,17 @@ def run_test(self):\n         assert_equal(self.nodes[1].getbalance(), balance1)\n         assert_equal(self.nodes[2].getbalance(), balance2)\n \n+        # Backup to source wallet file must fail\n+        sourcePaths = [\n+            tmpdir + \"/node0/regtest/wallet.dat\",\n+            tmpdir + \"/node0/./regtest/wallet.dat\",\n+            tmpdir + \"/node0/regtest/\",\n+            tmpdir + \"/node0/regtest\"]\n+\n+        for sourcePath in sourcePaths:\n+            assert_raises_jsonrpc(-4, \"backup failed\",\n+                    self.nodes[0].backupwallet, sourcePath)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11376#discussion_r140280655",
      "id" : 140280655,
      "original_commit_id" : "e062d5883db171e82153f0949ea52791cebbef7e",
      "original_position" : 13,
      "path" : "test/functional/walletbackup.py",
      "position" : 13,
      "pull_request_review_id" : 64329744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11376",
      "updated_at" : "2017-09-21T15:57:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/140280655",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
