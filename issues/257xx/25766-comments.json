[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24914](https://github.com/bitcoin/bitcoin/pull/24914) (wallet: Load database records in a particular order by achow101)\n* [#23417](https://github.com/bitcoin/bitcoin/pull/23417) (wallet, spkm: Move key management from DescriptorScriptPubKeyMan to wallet level KeyManager by achow101)\n* [#19602](https://github.com/bitcoin/bitcoin/pull/19602) (wallet: Migrate legacy wallets to descriptor wallets by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-08-02T03:01:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#issuecomment-1201960247",
      "id" : 1201960247,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25766",
      "node_id" : "IC_kwDOABII585HpHU3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201960247/reactions"
      },
      "updated_at" : "2022-08-08T18:11:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201960247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK ",
      "created_at" : "2022-08-02T03:18:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#issuecomment-1201968867",
      "id" : 1201968867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25766",
      "node_id" : "IC_kwDOABII585HpJbj",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201968867/reactions"
      },
      "updated_at" : "2022-08-02T03:18:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201968867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "\r\nConcept ACK\r\n\r\n",
      "created_at" : "2022-08-02T04:19:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#issuecomment-1201998688",
      "id" : 1201998688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25766",
      "node_id" : "IC_kwDOABII585HpQtg",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201998688/reactions"
      },
      "updated_at" : "2022-08-02T04:19:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1201998688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15256660?v=4",
         "events_url" : "https://api.github.com/users/benthecarman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/benthecarman/followers",
         "following_url" : "https://api.github.com/users/benthecarman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/benthecarman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/benthecarman",
         "id" : 15256660,
         "login" : "benthecarman",
         "node_id" : "MDQ6VXNlcjE1MjU2NjYw",
         "organizations_url" : "https://api.github.com/users/benthecarman/orgs",
         "received_events_url" : "https://api.github.com/users/benthecarman/received_events",
         "repos_url" : "https://api.github.com/users/benthecarman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/benthecarman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/benthecarman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/benthecarman"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-08-07T13:13:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#issuecomment-1207406215",
      "id" : 1207406215,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25766",
      "node_id" : "IC_kwDOABII585H946H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1207406215/reactions"
      },
      "updated_at" : "2022-08-07T13:13:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1207406215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25766#discussion_r939681799"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939681799"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If the deserialized signature doesn't have a size of 64 bytes, it would lead to a crash as the following assertion in `XOnlyPubKey::VerifySchnorr` will fail,\r\nhttps://github.com/bitcoin/bitcoin/blob/b1a2021f78099c17360dc2179cbcb948059b5969/src/pubkey.cpp#L208\r\ni.e. a signature size check before verifying should be added. As the same is needed below for `WALLETDESCRIPTORCKEY`, probably it would make sense to put the verification (including signature size check) into a helper function to deduplicate?",
      "commit_id" : "75742f2b1b71c83a213164201d9d671191d1f917",
      "created_at" : "2022-08-07T15:04:51Z",
      "diff_hunk" : "@@ -480,10 +502,24 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             if (!ssValue.eof()) {\n                 uint256 checksum;\n                 ssValue >> checksum;\n-                if ((checksum_valid = Hash(vchPrivKey) != checksum)) {\n+                if (Hash(vchPrivKey) != checksum) {\n                     strErr = \"Error reading wallet database: Encrypted key corrupt\";\n                     return false;\n                 }\n+\n+                // Get the signature and check it\n+                if (!ssValue.eof()) {\n+                    std::vector<unsigned char> sig;\n+                    ssValue >> sig;\n+                    // Our checksum is already the hash of the entire private key\n+                    // so we can just use it as our message\n+                    XOnlyPubKey xonly{vchPubKey};\n+                    if (!xonly.VerifySchnorr(checksum, sig)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#discussion_r939681799",
      "id" : 939681799,
      "line" : 518,
      "node_id" : "PRRC_kwDOABII5844AmgH",
      "original_commit_id" : "7cd6ff563649aba615ec6a24af5c4e5b22ac2292",
      "original_line" : 517,
      "original_position" : 81,
      "original_start_line" : 512,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 81,
      "pull_request_review_id" : 1064436269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25766",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939681799/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 513,
      "start_side" : "RIGHT",
      "updated_at" : "2022-08-07T15:15:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939681799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25766#discussion_r939682425"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25766"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939682425"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Wondering if this change would better fit into the later commit 20451e785f6478b5daf3b06bb2f638bc3662cf9f (_\"wallet: Write encrypted key sig if it is not present\"_), where the same is (only) done for `DescriptorScriptPubKeyMan`?",
      "commit_id" : "75742f2b1b71c83a213164201d9d671191d1f917",
      "created_at" : "2022-08-07T15:09:31Z",
      "diff_hunk" : "@@ -246,8 +246,14 @@ bool LegacyScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key\n             if (fDecryptionThoroughlyChecked)\n                 break;\n             else {\n-                // Rewrite these encrypted keys with checksums\n-                batch.WriteCryptedKey(vchPubKey, vchCryptedSecret, mapKeyMetadata[vchPubKey.GetID()]);\n+                // Rewrite these encrypted keys with checksums and signatures\n+                uint256 enckey_hash = Hash(vchCryptedSecret);\n+                std::vector<unsigned char> sig(64);\n+                if (!key.SignSchnorr(enckey_hash, sig, nullptr, uint256())) {\n+                    keyFail = true;\n+                    break;\n+                }\n+                batch.WriteCryptedKey(vchPubKey, vchCryptedSecret, mapKeyMetadata[vchPubKey.GetID()], sig);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#discussion_r939682425",
      "id" : 939682425,
      "line" : 256,
      "node_id" : "PRRC_kwDOABII5844Amp5",
      "original_commit_id" : "7cd6ff563649aba615ec6a24af5c4e5b22ac2292",
      "original_line" : 256,
      "original_position" : 13,
      "original_start_line" : 249,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 13,
      "pull_request_review_id" : 1064436269,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25766",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939682425/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 249,
      "start_side" : "LEFT",
      "updated_at" : "2022-08-07T15:15:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/939682425",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suspect this might actually make the problem worse. With this, a degree of trust in wallets having valid encrypted keys could develop, and it doesn't actually prevent the scam (the scammer just needs access to sufficient funds which remain not at risk).",
      "created_at" : "2022-08-10T00:34:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25766#issuecomment-1210022625",
      "id" : 1210022625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25766",
      "node_id" : "IC_kwDOABII585IH3rh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1210022625/reactions"
      },
      "updated_at" : "2022-08-10T00:34:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1210022625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
