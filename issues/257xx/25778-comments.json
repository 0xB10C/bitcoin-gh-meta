[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25778#discussion_r937542523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25778"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937542523"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Now the fuzz target has some shallow bugs. For example, `GetAmount` fail to get coin value. I guess that's because I simply add newly constructed tx out to outpoints, so `CCoinsViewMemPool::GetCoin` cannot find the outpoint in mempool.\r\n\r\n```log\r\ntest/fuzz/tx_pool.cpp:164 operator(): Assertion `amount_view.GetCoin(outpoint, c)' failed.\r\n==3026798== ERROR: libFuzzer: deadly signal\r\n    #0 0x5609ccdba680 in __sanitizer_print_stack_trace (/home/ubuntu/bitcoin/src/test/fuzz/fuzz+0xfd7680)\r\n    #1 0x5609ccd66988 in fuzzer::PrintStackTrace() (/home/ubuntu/bitcoin/src/test/fuzz/fuzz+0xf83988)\r\n    #2 0x5609ccd4bad3 in fuzzer::Fuzzer::CrashCallback() (/home/ubuntu/bitcoin/src/test/fuzz/fuzz+0xf68ad3)\r\n    #3 0x7f173207341f  (/lib/x86_64-linux-gnu/libpthread.so.0+0x1441f)\r\n    #4 0x7f1731cd900a in __libc_signal_restore_set /build/glibc-SzIz7B/glibc-2.31/signal/../sysdeps/unix/sysv/linux/internal-signals.h:86:3\r\n    #5 0x7f1731cd900a in raise /build/glibc-SzIz7B/glibc-2.31/signal/../sysdeps/unix/sysv/linux/raise.c:48:3\r\n    #6 0x7f1731cb8858 in abort /build/glibc-SzIz7B/glibc-2.31/stdlib/abort.c:79:7\r\n    #7 0x5609cf0fa49d in assertion_fail(char const*, int, char const*, char const*) src/util/check.cpp:13:5\r\n    #8 0x5609cd319c02 in bool&& inline_assertion_check<true, bool>(bool&&, char const*, int, char const*, char const*) src/./util/check.h:67:13\r\n    #9 0x5609cd5cbdda in (anonymous namespace)::tx_pool_standard_fuzz_target(Span<unsigned char const>)::$_4::operator()(COutPoint const&) const src/test/fuzz/tx_pool.cpp:164:9\r\n    #10 0x5609cd5cc62a in (anonymous namespace)::tx_pool_standard_fuzz_target(Span<unsigned char const>)::$_5::operator()() const src/test/fuzz/tx_pool.cpp:198:34\r\n```",
      "commit_id" : "c157a6ca57cd4c1392ad82b85d4b1df0b7d23e11",
      "created_at" : "2022-08-04T09:10:44Z",
      "diff_hunk" : "@@ -177,45 +178,54 @@ FUZZ_TARGET_INIT(tx_pool_standard, initialize_tx_pool)\n         Assert(!outpoints_supply.empty());\n \n         // Create transaction to add to the mempool\n-        const CTransactionRef tx = [&] {\n-            CMutableTransaction tx_mut;\n-            tx_mut.nVersion = CTransaction::CURRENT_VERSION;\n-            tx_mut.nLockTime = fuzzed_data_provider.ConsumeBool() ? 0 : fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n-            const auto num_in = fuzzed_data_provider.ConsumeIntegralInRange<int>(1, outpoints_rbf.size());\n-            const auto num_out = fuzzed_data_provider.ConsumeIntegralInRange<int>(1, outpoints_rbf.size() * 2);\n-\n-            CAmount amount_in{0};\n-            for (int i = 0; i < num_in; ++i) {\n-                // Pop random outpoint\n-                auto pop = outpoints_rbf.begin();\n-                std::advance(pop, fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, outpoints_rbf.size() - 1));\n-                const auto outpoint = *pop;\n-                outpoints_rbf.erase(pop);\n-                amount_in += GetAmount(outpoint);\n-\n-                // Create input\n-                const auto sequence = ConsumeSequence(fuzzed_data_provider);\n-                const auto script_sig = CScript{};\n-                const auto script_wit_stack = std::vector<std::vector<uint8_t>>{WITNESS_STACK_ELEM_OP_TRUE};\n-                CTxIn in;\n-                in.prevout = outpoint;\n-                in.nSequence = sequence;\n-                in.scriptSig = script_sig;\n-                in.scriptWitness.stack = script_wit_stack;\n-\n-                tx_mut.vin.push_back(in);\n-            }\n-            const auto amount_fee = fuzzed_data_provider.ConsumeIntegralInRange<CAmount>(-1000, amount_in);\n-            const auto amount_out = (amount_in - amount_fee) / num_out;\n-            for (int i = 0; i < num_out; ++i) {\n-                tx_mut.vout.emplace_back(amount_out, P2WSH_OP_TRUE);\n-            }\n-            const auto tx = MakeTransactionRef(tx_mut);\n-            // Restore previously removed outpoints\n-            for (const auto& in : tx->vin) {\n-                Assert(outpoints_rbf.insert(in.prevout).second);\n+        const Package package = [&] {\n+            auto n_tx = fuzzed_data_provider.ConsumeIntegralInRange<uint32_t>(1, MAX_PACKAGE_COUNT + 5);\n+            Package txs;\n+            while (n_tx--) {\n+                CMutableTransaction tx_mut;\n+                tx_mut.nVersion = CTransaction::CURRENT_VERSION;\n+                tx_mut.nLockTime = fuzzed_data_provider.ConsumeBool() ? 0 : fuzzed_data_provider.ConsumeIntegral<uint32_t>();\n+                const auto num_in = fuzzed_data_provider.ConsumeIntegralInRange<int>(1, outpoints_rbf.size());\n+                const auto num_out = fuzzed_data_provider.ConsumeIntegralInRange<int>(1, outpoints_rbf.size() * 2);\n+\n+                CAmount amount_in{0};\n+                for (int i = 0; i < num_in; ++i) {\n+                    // Pop random outpoint\n+                    auto pop = outpoints_rbf.begin();\n+                    std::advance(pop, fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, outpoints_rbf.size() - 1));\n+                    const auto outpoint = *pop;\n+                    outpoints_rbf.erase(pop);\n+                    amount_in += GetAmount(outpoint);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25778#discussion_r937542523",
      "id" : 937542523,
      "line" : 198,
      "node_id" : "PRRC_kwDOABII58434cN7",
      "original_commit_id" : "c157a6ca57cd4c1392ad82b85d4b1df0b7d23e11",
      "original_line" : 198,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/test/fuzz/tx_pool.cpp",
      "position" : 66,
      "pull_request_review_id" : 1061550477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25778",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937542523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-04T09:10:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/937542523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/24590067?v=4",
         "events_url" : "https://api.github.com/users/chinggg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/chinggg/followers",
         "following_url" : "https://api.github.com/users/chinggg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/chinggg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/chinggg",
         "id" : 24590067,
         "login" : "chinggg",
         "node_id" : "MDQ6VXNlcjI0NTkwMDY3",
         "organizations_url" : "https://api.github.com/users/chinggg/orgs",
         "received_events_url" : "https://api.github.com/users/chinggg/received_events",
         "repos_url" : "https://api.github.com/users/chinggg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/chinggg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/chinggg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/chinggg"
      }
   }
]
