[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26283](https://github.com/bitcoin/bitcoin/pull/26283) (p2p: Fill reconciliation sets and request reconciliation (Erlay) by naumenkogs)\n* [#25977](https://github.com/bitcoin/bitcoin/pull/25977) (refactor: Replace `std::optional<bilingual_str>` with `util::Result` by ryanofsky)\n* [#25862](https://github.com/bitcoin/bitcoin/pull/25862) (refactor, kernel: Remove gArgs accesses from dbwrapper and txdb by ryanofsky)\n* [#25704](https://github.com/bitcoin/bitcoin/pull/25704) (refactor: Remove almost all validation option globals by MarcoFalke)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#23443](https://github.com/bitcoin/bitcoin/pull/23443) (p2p: Erlay support signaling by naumenkogs)\n* [#22663](https://github.com/bitcoin/bitcoin/pull/22663) (dbwrapper: properly destroy objects in case CDBWrapper ctor throws by Crypt-iQ)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n* [#10443](https://github.com/bitcoin/bitcoin/pull/10443) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-07-29T21:47:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1199966506",
      "id" : 1199966506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585Hhgkq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199966506/reactions"
      },
      "updated_at" : "2022-10-11T21:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199966506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/validation_chainstatemanager_tests.cpp:418:35: error: calling function 'DisconnectTip' requires holding mutex 'bg_chainstate.m_mempool->cs' exclusively [-Werror,-Wthread-safety-precise]\r\n        BOOST_CHECK(bg_chainstate.DisconnectTip(unused_state, &unused_pool));\r\n                                  ^\r\ntest/validation_chainstatemanager_tests.cpp:418:35: note: found near match 'mempool->cs'\r\n1 error generated.\r\n```\r\n",
      "created_at" : "2022-07-30T08:57:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1200119940",
      "id" : 1200119940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585HiGCE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1200119940/reactions"
      },
      "updated_at" : "2022-07-30T08:57:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1200119940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r934711528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add testcases for snapshot initialization\" (5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48)\r\n\r\nSomething wonky is going on in this commit. It seems like some rebase error. This is dropping the `chainstatemanager_loadblockindex` test, and replacing it with an exact copy of the `chainstatemanager_snapshot_init` below, which now appears twice (and is edited in later commit 65ad0860ffd9441b005ac4bc240f596d9a81836f to become a different chainstatemanager_snapshot_completion test)",
      "commit_id" : "93e6a234678b98abe1c50b11b1d47cbe266d25fa",
      "created_at" : "2022-08-01T16:26:47Z",
      "diff_hunk" : "@@ -387,82 +387,57 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n     this->SetupSnapshot();\n }\n \n-//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n-//!\n-//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n-//!   fully-validating chainstate.\n-//!\n-//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n-//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n-//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n-//!\n-BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r934711528",
      "id" : 934711528,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843tpDo",
      "original_commit_id" : "5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48",
      "original_line" : 325,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1057565671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:47:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:23:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1203702766",
      "id" : 1203702766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585Hvwvu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203702766/reactions"
      },
      "updated_at" : "2022-08-03T09:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203702766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Clang failure on some platforms looks spurious:\r\n\r\n```\r\ntest/validation_chainstatemanager_tests.cpp:501:35: error: calling function 'DisconnectTip' requires holding mutex 'bg_chainstate.m_mempool->cs' exclusively [-Werror,-Wthread-safety-precise]\r\n        BOOST_CHECK(bg_chainstate.DisconnectTip(unused_state, &unused_pool));\r\n                                  ^\r\ntest/validation_chainstatemanager_tests.cpp:501:35: note: found near match 'mempool->cs'\r\n1 error generated.\r\n```\r\nbut lock is taken [here](https://github.com/bitcoin/bitcoin/pull/25740/commits/a9e27d3f242361534a1a50e403ab176b556ba528#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bR500). \r\n\r\nAnyone have ideas for workarounds?",
      "created_at" : "2022-09-06T22:47:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238726951",
      "id" : 1238726951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1Xkn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238726951/reactions"
      },
      "updated_at" : "2022-09-06T22:47:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238726951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r964236783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ryanofsky yeah, thanks - not sure what happened there. Should be fixed.",
      "commit_id" : "93e6a234678b98abe1c50b11b1d47cbe266d25fa",
      "created_at" : "2022-09-06T22:47:56Z",
      "diff_hunk" : "@@ -387,82 +387,57 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n     this->SetupSnapshot();\n }\n \n-//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n-//!\n-//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n-//!   fully-validating chainstate.\n-//!\n-//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n-//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n-//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n-//!\n-BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r964236783",
      "id" : 964236783,
      "in_reply_to_id" : 934711528,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845eRXv",
      "original_commit_id" : "5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48",
      "original_line" : 325,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1098333048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T22:47:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If the lock is for `bg_chainstate.GetMempool()->cs` but the annotation requires `bg_chainstate.m_mempool->cs`, the compiler probably isn't going to know that `GetMempool()` and `m_mempool` are the same. Probably should stick with `m_mempool`",
      "created_at" : "2022-09-06T22:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238729341",
      "id" : 1238729341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1YJ9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238729341/reactions"
      },
      "updated_at" : "2022-09-06T22:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238729341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  Probably should stick with m_mempool\r\n\r\nIt's protected :grimacing:. But looks like I can use the `RETURNS_LOCK` annotation on `MempoolMutex()`.\r\n\r\nEdit: that's private too, hah.",
      "created_at" : "2022-09-06T23:02:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238733581",
      "id" : 1238733581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1ZMN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238733581/reactions"
      },
      "updated_at" : "2022-09-06T23:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238733581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-13T16:34:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1245663156",
      "id" : 1245663156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585KP0-0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663156/reactions"
      },
      "updated_at" : "2022-09-13T16:34:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reopening and closing to get Github to deduplicate commits now included on master.",
      "created_at" : "2022-10-13T14:40:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1277723681",
      "id" : 1277723681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585MKIQh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277723681/reactions"
      },
      "updated_at" : "2022-10-13T14:40:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277723681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob this PR should probably be added to #15606 now that it's out of draft.",
      "created_at" : "2022-10-13T15:00:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1277755175",
      "id" : 1277755175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585MKP8n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277755175/reactions"
      },
      "updated_at" : "2022-10-13T15:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277755175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997479271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\nSince this is also caused by an invalid snapshot, should this be below and also call `handle_invalid_snapshot`? Otherwise it seems like this would just continue with the IBD chainstate without invalidating the snapshot chainstate which I think would be incorrect?",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:25:58Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] supposed base block %s does not match the \" /* Continued */\n+          \"snapshot base block %s (height %d). Snapshot is not valid.\",\n+          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n+       return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997479271",
      "id" : 997479271,
      "line" : 5216,
      "node_id" : "PRRC_kwDOABII5847dFNn",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5214,
      "original_position" : 150,
      "original_start_line" : 5209,
      "path" : "src/validation.cpp",
      "position" : 150,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5211,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-17T20:53:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997480620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\nThis only renames the chainstate dir, it's not clear to me if/when the invalid chainstate is deleted. Considering that moving the chainstate dir and deleting it are effectively the same thing here, I think it could just do `fs::remove_all`.",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:27:37Z",
      "diff_hunk" : "@@ -5213,6 +5404,39 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     return *m_snapshot_chainstate;\n }\n \n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997480620",
      "id" : 997480620,
      "line" : 5428,
      "node_id" : "PRRC_kwDOABII5847dFis",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5426,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 273,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-17T20:53:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997485284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\n```\r\nvalidation.cpp: In member function âbool ChainstateManager::PopulateAndValidateSnapshot(Chainstate&, AutoFile&, const node::SnapshotMetadata&)â:\r\nvalidation.cpp:5103:14: warning: catching polymorphic type âstruct StopHashingExceptionâ by value [-Wcatch-value=]\r\n 5103 |     } catch (StopHashingException) {\r\n      |    \r\n```",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:33:24Z",
      "diff_hunk" : "@@ -5043,13 +5089,18 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(coins_cache.GetBestBlock() == base_blockhash);\n \n-    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n-\n     // As above, okay to immediately release cs_main here since no other context knows\n     // about the snapshot_chainstate.\n     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &snapshot_chainstate.CoinsDB());\n \n-    const std::optional<CCoinsStats> maybe_stats = ComputeUTXOStats(CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, breakpoint_fnc);\n+    std::optional<CCoinsStats> maybe_stats;\n+\n+    try {\n+        maybe_stats = ComputeUTXOStats(\n+            CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, SnapshotUTXOHashBreakpoint);\n+    } catch (StopHashingException) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997485284",
      "id" : 997485284,
      "line" : 5103,
      "node_id" : "PRRC_kwDOABII5847dGrk",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5101,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 97,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-17T20:53:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
