[
   {
      "author_association" : "MEMBER",
      "body" : "Currently a draft, so please only review the concept and approach. I'll rebase this after #23411 (which shares the first commit) and take it out of draft.",
      "created_at" : "2021-11-02T19:43:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-958112130",
      "id" : 958112130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5845G6GC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958112130/reactions"
      },
      "updated_at" : "2021-11-02T19:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958112130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23962](https://github.com/bitcoin/bitcoin/pull/23962) (Use int32_t type for transaction size/weight consistently by hebasto)\n* [#17786](https://github.com/bitcoin/bitcoin/pull/17786) (refactor: Nuke policy/fees->mempool circular dependencies by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-11-03T00:06:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-958478249",
      "id" : 958478249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5845ITep",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958478249/reactions"
      },
      "updated_at" : "2022-02-06T14:47:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958478249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-11-03T08:44:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-958748521",
      "id" : 958748521,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5845JVdp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958748521/reactions"
      },
      "updated_at" : "2021-11-03T08:44:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958748521",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23418#discussion_r742736167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23418"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742736167"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In this interface the function may or may not add the second argument to the first and it does not signal to the caller which one of the two it did. I find this puzzling. Surely the caller needs to take a different action depending on whether the two numbers can be summed or not? If the caller does not care and takes the same action either way, and the code is still correct, then why bother and not just skip calling `MaybeAdd()` altogether? (if not adding is also ok)\r\n\r\nOr, if this is used in some kind of blurred logic where everything is ok, is it not better for the sum to produce `numeric_limits<T>::max()` in case of an overflow? E.g. if summing `char` `100 + 30` to produce `127` instead of `100`?\r\n\r\nTo me it would be more logical to check for an overflow and take the appropriate action if one would occur, even if that is to `abort()` the program. We have types that are wide enough to ensure that overflow \"never\" occurs, or if it occurs then `abort()`ing is justified. Something like:\r\n\r\n```cpp\r\ntemplate <typename T>\r\nT SumOrDie(T x, T y)\r\n{\r\n    assert(!AddOverflows(x, y));\r\n    assert(!AddUnderflows(x, y));\r\n    return x + y;\r\n}",
      "commit_id" : "e8522d082e5b7ab421e62c8e76fabbea24531a8d",
      "created_at" : "2021-11-04T11:07:58Z",
      "diff_hunk" : "@@ -22,6 +23,22 @@\n #include <cmath>\n #include <optional>\n \n+template <typename T>\n+static void MaybeAdd(T& mut, const T& apply)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#discussion_r742736167",
      "id" : 742736167,
      "line" : 27,
      "node_id" : "PRRC_kwDOABII584sRUEn",
      "original_commit_id" : "e8522d082e5b7ab421e62c8e76fabbea24531a8d",
      "original_line" : 27,
      "original_position" : 13,
      "original_start_line" : 26,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 797606445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23418",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742736167/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 26,
      "start_side" : "RIGHT",
      "updated_at" : "2021-11-04T11:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742736167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23418#discussion_r744953272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23418"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744953272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This ignores the fee delta when it would otherwise overflow, which seems like incorrect behaviour. Shouldn't we just set `mut` to the max value?",
      "commit_id" : "e8522d082e5b7ab421e62c8e76fabbea24531a8d",
      "created_at" : "2021-11-08T17:41:04Z",
      "diff_hunk" : "@@ -22,6 +23,22 @@\n #include <cmath>\n #include <optional>\n \n+template <typename T>\n+static void MaybeAdd(T& mut, const T& apply)\n+{\n+    if (AdditionOverflow(mut, apply)) {\n+        // Signed integer overflow is UB in theory.\n+        // It is impossible to predict when and if an overflow occurs, since\n+        // the overflow caused by a prioritisetransaction RPC might only be\n+        // later hit when descendant txs are added to the mempool.\n+        // Since it is impossible to predict reliably, leave it up to the user\n+        // to use the RPC endpoint responsibly, considering their mempool\n+        // limits and usage patterns.\n+        return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#discussion_r744953272",
      "id" : 744953272,
      "line" : 37,
      "node_id" : "PRRC_kwDOABII584sZxW4",
      "original_commit_id" : "e8522d082e5b7ab421e62c8e76fabbea24531a8d",
      "original_line" : 37,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 23,
      "pull_request_review_id" : 800425231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23418",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744953272/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-11-08T17:41:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744953272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> See https://godbolt.org/z/aWTKcM6db, I have a couple of suggestions:\r\n> \r\n> 1. make TestAdd, TestAddMatrixOverflow, TestAddMatrix and AdditionOverflow constexpr b/c why not\r\n> 2. Consider replacing MaybeAdd with my implementation of MaybeAddRet, which returns a value instead of mutating a mutable reference, which enables MaybeAddRet to be constexpr. (they appear virtually equally efficient, especially when we take into account we'll be using trivial types with this) (I also think this just makes more sense for a function called \"MaybeAdd\" as opposed to \"MaybeAddEquals\" or smth else)\r\n> 3. Consider adding a    `static_assert(std::is_trivial<T>::value);` to ensure we only are using trivial types\r\n> \r\n> (also, I see that you weren't really asking for a review, but I just saw the PR and started poking around :D )\r\n\r\n@MarcoFalke do you have an opinion about these suggestions?",
      "created_at" : "2022-02-07T09:27:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-1031248405",
      "id" : 1031248405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5849d5oV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031248405/reactions"
      },
      "updated_at" : "2022-02-07T09:27:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031248405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah, MaybeAdd will be removed, in which case the suggestions won't apply.",
      "created_at" : "2022-02-07T13:27:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-1031468919",
      "id" : 1031468919,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5849evd3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031468919/reactions"
      },
      "updated_at" : "2022-02-07T13:27:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031468919",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Please review https://github.com/bitcoin/bitcoin/pull/24224 first, while this stays in draft",
      "created_at" : "2022-02-07T13:27:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23418#issuecomment-1031469422",
      "id" : 1031469422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23418",
      "node_id" : "IC_kwDOABII5849evlu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031469422/reactions"
      },
      "updated_at" : "2022-02-07T13:27:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1031469422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
