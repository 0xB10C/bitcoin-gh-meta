[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r370530478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370530478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The last height, or the maximum height?",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-01-24T09:05:55Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r370530478",
      "id" : 370530478,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzMDQ3OA==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 347820235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370530478",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r370535220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370535220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "They are the same:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/28fbe68fdcac2a06f359b1e48555a3d23015c2b7/src/chain.h#L85-L86",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-01-24T09:18:34Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r370535220",
      "id" : 370535220,
      "in_reply_to_id" : 370530478,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUzNTIyMA==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 37,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 347826438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/370535220",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-01-24T10:03:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-578065964",
      "id" : 578065964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODA2NTk2NA==",
      "updated_at" : "2020-01-26T14:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578065964",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Synced two datadirs (master and this branch) to block 484516, which resulted in 995 rev files, master using 38277312 bytes, and this branch 35573680 bytes. The average wasted space per rev file comes out at 2717 bytes (~3kb), which is quite a bit lower than my assumptions (if it was completely random, it should be ~500kb per rev file).\r\n\r\nCopying blocks/rev* into a separate dir reveals a few kb lower for this branch -- 35570968 -- caused by the latest rev file having some pre-allocation. The same for the master datadir results in 36547408 bytes.\r\n\r\nNot sure why it's not higher, but still. I don't think a backport is even necessary, but fixing this bug and adding a one time sweep/finalize of all rev files is something that we should do.",
      "created_at" : "2020-01-26T11:38:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-578493533",
      "id" : 578493533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU3ODQ5MzUzMw==",
      "updated_at" : "2020-01-26T11:38:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/578493533",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 48081229c10969ac5993c826c8bd7687cd0503e5\r\n\r\nAgree, looks cleaner than #17892!",
      "created_at" : "2020-02-17T16:54:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-587082534",
      "id" : 587082534,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU4NzA4MjUzNA==",
      "updated_at" : "2020-02-17T16:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/587082534",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I looked at the code and just want to confirm that I got it right. Is the following example correct?\r\n\r\nLet's assume for simplicity that `blk*.dat` and `rev*.dat` files can contain up to 3 blocks.\r\nInitially just the genesis block (height 0) is in `blk01` and `rev01`. Then:\r\n* block at height 2 is downloaded\r\n  * it is written to `blk01`\r\n  * undo for it will be written to `rev01`, but not yet\r\n* block at height 3 is downloaded\r\n  * it is written to `blk01`\r\n  * undo for it will be written to `rev01`, but not yet\r\n* block at height 4 is downloaded\r\n  * `blk01` is finalized as it is full with 3 blocks (with heights 0, 2, 3)\r\n  * the downloaded block with height 4 is written to `blk02`\r\n  * its undo will eventually be in `rev02`\r\n* block at height 1 is downloaded\r\n  * it is written to `blk02`\r\n  * its undo is written to `rev02`\r\n  * now that the block at height 2 is chained, undo for it is written to `rev01`\r\n  * now that the block at height 3 is chained, undo for it is written to `rev01`\r\n  * now that the block at height 4 is chained, undo for it is written to `rev02`",
      "created_at" : "2020-03-11T19:16:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-597819294",
      "id" : 597819294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzgxOTI5NA==",
      "updated_at" : "2020-03-11T20:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597819294",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391244966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391244966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We want to flush the rev file along with the block file, but we are not going to do that if `fFinalize` is `true`. What about calling `FlushUndoFile(nLastBlockFile)` unconditionally here?",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-11T20:19:13Z",
      "diff_hunk" : "@@ -1731,19 +1731,23 @@ DisconnectResult CChainState::DisconnectBlock(const CBlock& block, const CBlockI\n     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;\n }\n \n-void static FlushBlockFile(bool fFinalize = false)\n+static void FlushUndoFile(int block_file, bool finalize = false)\n {\n-    LOCK(cs_LastBlockFile);\n+    FlatFilePos undo_pos_old(block_file, vinfoBlockFile[block_file].nUndoSize);\n+    if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+    }\n+}\n \n+static void FlushBlockFile(bool fFinalize = false)\n+{\n+    LOCK(cs_LastBlockFile);\n     FlatFilePos block_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\n-    FlatFilePos undo_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-\n-    bool status = true;\n-    status &= BlockFileSeq().Flush(block_pos_old, fFinalize);\n-    status &= UndoFileSeq().Flush(undo_pos_old, fFinalize);\n-    if (!status) {\n+    if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         AbortNode(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n+    // the undo file is actually finalized at a later stage, but we do want to flush it along with the block file\n+    if (!fFinalize) FlushUndoFile(nLastBlockFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391244966",
      "id" : 391244966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0NDk2Ng==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 373096135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391244966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391249970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391249970"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe I am missing something, but it looks to me that if blocks are being downloaded in-order, then the `_pos.nFile < nLastBlockFile` condition will never be true because those will always be equal?",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-11T20:29:18Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391249970",
      "id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTI0OTk3MA==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 373102528,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391249970",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391416459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391416459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's basically no reason to do a non-final flush of the undo file, except on shutdown (which happens now). This is the same for the block file (since the case you are arguing is for a finalized flush).",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-12T06:04:01Z",
      "diff_hunk" : "@@ -1731,19 +1731,23 @@ DisconnectResult CChainState::DisconnectBlock(const CBlock& block, const CBlockI\n     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;\n }\n \n-void static FlushBlockFile(bool fFinalize = false)\n+static void FlushUndoFile(int block_file, bool finalize = false)\n {\n-    LOCK(cs_LastBlockFile);\n+    FlatFilePos undo_pos_old(block_file, vinfoBlockFile[block_file].nUndoSize);\n+    if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+    }\n+}\n \n+static void FlushBlockFile(bool fFinalize = false)\n+{\n+    LOCK(cs_LastBlockFile);\n     FlatFilePos block_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\n-    FlatFilePos undo_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-\n-    bool status = true;\n-    status &= BlockFileSeq().Flush(block_pos_old, fFinalize);\n-    status &= UndoFileSeq().Flush(undo_pos_old, fFinalize);\n-    if (!status) {\n+    if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         AbortNode(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n+    // the undo file is actually finalized at a later stage, but we do want to flush it along with the block file\n+    if (!fFinalize) FlushUndoFile(nLastBlockFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391416459",
      "id" : 391416459,
      "in_reply_to_id" : 391244966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxNjQ1OQ==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 373296604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391416459",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391416617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391416617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I am pretty sure I tested this but I can't convince myself that you're wrong by looking at the code so I will test this again.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-12T06:04:41Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391416617",
      "id" : 391416617,
      "in_reply_to_id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxNjYxNw==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 373296807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391416617",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391452419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391452419"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, then this turns into a nit, feel free to ignore: maybe update the comment to be in line with the code: \"we do want to flush it along with the block file _in non-finalizing flushes_\".",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-12T08:01:23Z",
      "diff_hunk" : "@@ -1731,19 +1731,23 @@ DisconnectResult CChainState::DisconnectBlock(const CBlock& block, const CBlockI\n     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;\n }\n \n-void static FlushBlockFile(bool fFinalize = false)\n+static void FlushUndoFile(int block_file, bool finalize = false)\n {\n-    LOCK(cs_LastBlockFile);\n+    FlatFilePos undo_pos_old(block_file, vinfoBlockFile[block_file].nUndoSize);\n+    if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+    }\n+}\n \n+static void FlushBlockFile(bool fFinalize = false)\n+{\n+    LOCK(cs_LastBlockFile);\n     FlatFilePos block_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\n-    FlatFilePos undo_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-\n-    bool status = true;\n-    status &= BlockFileSeq().Flush(block_pos_old, fFinalize);\n-    status &= UndoFileSeq().Flush(undo_pos_old, fFinalize);\n-    if (!status) {\n+    if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         AbortNode(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n+    // the undo file is actually finalized at a later stage, but we do want to flush it along with the block file\n+    if (!fFinalize) FlushUndoFile(nLastBlockFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391452419",
      "id" : 391452419,
      "in_reply_to_id" : 391244966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1MjQxOQ==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 373341156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391452419",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391454552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391454552"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The way I see it is that `_pos.nFile < nLastBlockFile && ` can (should) be dropped and the second condition suffices - if we are writing the last (highest) block in the rev file, then also finalize it because we are not going to touch it again.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-12T08:07:03Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r391454552",
      "id" : 391454552,
      "in_reply_to_id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1NDU1Mg==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 373341156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391454552",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r392558570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392558570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry for tardiness, work kept me busy, but I managed to verify that this is *not* working as it should. I will fix soon.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-14T05:23:56Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r392558570",
      "id" : 392558570,
      "in_reply_to_id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU1ODU3MA==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 374699402,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392558570",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I reproduced the bug in a controlled, deterministic environment with a [unit test + tweaks](https://gist.github.com/vasild/8c06b3dbc493522f683a671d71b4c122). The current patch in this PR (4808122) indeed fixes it, but it introduces another problem - it would wrongly skip finalizing of the undo files in case the blocks are downloaded in-height-order.\r\n\r\nThere are two cases when we should finalize an undo file (IFF):\r\n* we have just moved to a subsequent one (like with block files) - \"normal\" in-height-order scenario or\r\n* we are coming back to a lower undo file from a higher undo file to complete an out-of-order block's undo and this undo slot is the last/final in the lower undo file.\r\n\r\nThe following patch (on top of master @ 9cc7eba1b) fixes it:\r\n\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -131,13 +131,39 @@ CTxMemPool mempool(&feeEstimator);\r\n // Internal stuff\r\n namespace {\r\n     CBlockIndex* pindexBestInvalid = nullptr;\r\n \r\n     RecursiveMutex cs_LastBlockFile;\r\n     std::vector<CBlockFileInfo> vinfoBlockFile;\r\n+\r\n+    /** Last blk*.dat file that has been written to.\r\n+     * Used to detect when we move from blkN to blkN+1 so we can trigger a\r\n+     * finalization of blkN.\r\n+     * Blocks are appended to blk files in the order they are received from\r\n+     * the network (which may not be height order). When a blk file is about\r\n+     * to become larger than MAX_BLOCKFILE_SIZE then we move to the next blk\r\n+     * file and finalize the one we just left.\r\n+     */\r\n     int nLastBlockFile = 0;\r\n+\r\n+    /** Highest rev*.dat file that has been written to.\r\n+     * Used to detect the last write to revN so it can be finalized.\r\n+     * Undo files don't have a max size limit. For every block that resides in\r\n+     * blkN, its corresponding undo resides in revN.\r\n+     * However, the undo for a given block is only appended to the rev file\r\n+     * after all blocks at a lower height have been stored together with their\r\n+     * undos. It follows that block and undo data may be in different order\r\n+     * in the corresponding blk and rev files, for example:\r\n+     * blkN: block5, block7, block6\r\n+     * revN: block5, block6, block7\r\n+     * if block7 was received before block6.\r\n+     * Also we may write to revN after writing to revM, for N < M which never\r\n+     * happens with blk files.\r\n+     */\r\n+    int nHighestUndoFile = 0;\r\n+\r\n     /** Global flag to indicate we should check to see if there are\r\n      *  block/undo files that should be deleted.  Set on startup\r\n      *  or if we allocate more file space when we're in prune mode\r\n      */\r\n     bool fCheckForPruning = false;\r\n \r\n@@ -1733,23 +1759,25 @@ DisconnectResult CChainState::DisconnectBlock(const CBlock& block, const CBlockI\r\n     // move best block pointer to prevout block\r\n     view.SetBestBlock(pindex->pprev->GetBlockHash());\r\n \r\n     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;\r\n }\r\n \r\n-void static FlushBlockFile(bool fFinalize = false)\r\n+static void FlushUndoFile(int undo_file, bool finalize = false)\r\n {\r\n-    LOCK(cs_LastBlockFile);\r\n-\r\n-    FlatFilePos block_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\r\n-    FlatFilePos undo_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nUndoSize);\r\n+    FlatFilePos pos(undo_file, vinfoBlockFile[undo_file].nUndoSize);\r\n+    if (!UndoFileSeq().Flush(pos, finalize)) {\r\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\r\n+    }\r\n+}\r\n \r\n-    bool status = true;\r\n-    status &= BlockFileSeq().Flush(block_pos_old, fFinalize);\r\n-    status &= UndoFileSeq().Flush(undo_pos_old, fFinalize);\r\n-    if (!status) {\r\n+static void FlushBlockFile(bool fFinalize = false)\r\n+{\r\n+    LOCK(cs_LastBlockFile);\r\n+    FlatFilePos pos(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\r\n+    if (!BlockFileSeq().Flush(pos, fFinalize)) {\r\n         AbortNode(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\r\n     }\r\n }\r\n \r\n static bool FindUndoPos(BlockValidationState &state, int nFile, FlatFilePos &pos, unsigned int nAddSize);\r\n \r\n@@ -1760,12 +1788,37 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\r\n         FlatFilePos _pos;\r\n         if (!FindUndoPos(state, pindex->nFile, _pos, ::GetSerializeSize(blockundo, CLIENT_VERSION) + 40))\r\n             return error(\"ConnectBlock(): FindUndoPos failed\");\r\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\r\n             return AbortNode(state, \"Failed to write undo data\");\r\n \r\n+        const unsigned thisHeight = static_cast<unsigned>(pindex->nHeight);\r\n+\r\n+        // Flush and finalize the preceding undo file in the case when blocks\r\n+        // come in height order and we have moved to a subsequent undo file.\r\n+        const bool movedToSubsequent = _pos.nFile > nHighestUndoFile;\r\n+        const bool adjacentHeights =\r\n+            thisHeight == vinfoBlockFile[nHighestUndoFile].nHeightLast + 1;\r\n+\r\n+        if (movedToSubsequent && adjacentHeights) {\r\n+            FlushUndoFile(nHighestUndoFile, true);\r\n+        }\r\n+\r\n+        // Flush and finalize the old undo file if we went back to write\r\n+        // to it and we wrote its last entry.\r\n+        const bool wroteToOldFile = _pos.nFile < nHighestUndoFile;\r\n+        const bool isLastEntry = thisHeight == vinfoBlockFile[_pos.nFile].nHeightLast;\r\n+\r\n+        if (wroteToOldFile && isLastEntry) {\r\n+            FlushUndoFile(_pos.nFile, true);\r\n+        }\r\n+\r\n+        if (movedToSubsequent) {\r\n+            nHighestUndoFile = _pos.nFile;\r\n+        }\r\n+\r\n         // update nUndoPos in block index\r\n         pindex->nUndoPos = _pos.nPos;\r\n         pindex->nStatus |= BLOCK_HAVE_UNDO;\r\n         setDirtyBlockIndex.insert(pindex);\r\n     }\r\n \r\n@@ -2291,12 +2344,13 @@ bool CChainState::FlushStateToDisk(\r\n             }\r\n             {\r\n                 LOG_TIME_MILLIS(\"write block and undo data to disk\", BCLog::BENCH);\r\n \r\n                 // First make sure all block and undo data is flushed to disk.\r\n                 FlushBlockFile();\r\n+                FlushUndoFile(nHighestUndoFile);\r\n             }\r\n \r\n             // Then update all block file information (which may refer to block and undo files).\r\n             {\r\n                 LOG_TIME_MILLIS(\"write block index to disk\", BCLog::BENCH);\r\n \r\n```\r\n\r\nFeel free to pick it in its entirety, just pieces of it, just the idea or propose another approach. I will test it.\r\n\r\n[Annotated debug output with the bug present and with the bug fixed (by the above patch).](https://gist.github.com/vasild/34e342c869aff9a5a870b3ef3fff154c)\r\n\r\nRun the unit test like `./src/test/test_bitcoin --run_test=\"*/download_blocks_out_of_order\" --log_level=all -x 0 > /tmp/log`\r\nFilter its output: `grep -w BBB /tmp/log |sed -E -e 's/^2020[^ ]+ //' -e 's/BBB //'`\r\n\r\nI hope this helps!",
      "created_at" : "2020-03-14T09:07:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-599031098",
      "id" : 599031098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTAzMTA5OA==",
      "updated_at" : "2020-03-14T09:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599031098",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r392570411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392570411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No worries. I started at this problem long enough and finally it cracked.\r\n\r\nIndeed `_pos.nFile < nLastBlockFile` is never true if blocks come in-height-order and this needs to be adjusted. However, just removing that condition, as I suggest above, is not ok because then the second condition will be true for every in-height-order write and this will cause excessive flushing and finalizing. See the proposed [patch](https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-599031098) for a fully working solution (I hope).",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-14T09:11:51Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r392570411",
      "id" : 392570411,
      "in_reply_to_id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3MDQxMQ==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 374709388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/392570411",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r394916198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394916198"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've got something but testing takes time (I don't wanna have to wait days each time so I'm juggling 300 GB full node dirs around).",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-19T10:09:51Z",
      "diff_hunk" : "@@ -1757,6 +1761,12 @@ static bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationSt\n             return error(\"ConnectBlock(): FindUndoPos failed\");\n         if (!UndoWriteToDisk(blockundo, _pos, pindex->pprev->GetBlockHash(), chainparams.MessageStart()))\n             return AbortNode(state, \"Failed to write undo data\");\n+        // rev files are written in block height order, whereas blk files are written as blocks come in (often out of order)\n+        // we want to flush the rev (undo) file once we've written the last block, which is indicated by the last height\n+        // in the block file info as below\n+        if (_pos.nFile < nLastBlockFile && static_cast<uint32_t>(pindex->nHeight) == vinfoBlockFile[_pos.nFile].nHeightLast) {\n+            FlushUndoFile(_pos.nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r394916198",
      "id" : 394916198,
      "in_reply_to_id" : 391249970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDkxNjE5OA==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 40,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 377579484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/394916198",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild Tremendous work. Thank you very much. I will look closer at your patch, and also evaluate my solution over the next few days to see if it does what I want. (And compare it to yours.)\r\n\r\nMy solution was to patch this in two places; one for the case \"rev file lags behind\", and one for \"rev file is up to date\". This was very little code (note that the last commit is a NOMERGE to demonstrate the fix).\r\n\r\nI see this, for a node that was a week or so behind, if I grep -v 'UpdateTip':\r\n```\r\n2020-03-19T12:34:31Z Pre-allocating up to position 0x7000000 in blk02004.dat\r\n2020-03-19T12:34:32Z Pre-allocating up to position 0x8000000 in blk02004.dat\r\n2020-03-19T12:34:33Z iterating nFile: last height = 622161; chain tip height = 621899 -> DO NOT FLUSH UNDO FILE\r\n2020-03-19T12:34:33Z Leaving block file 2004: CBlockFileInfo(blocks=112, size=133860058, heights=621899...622161, time=2020-03-16...2020-03-19)\r\n2020-03-19T12:34:34Z unflushed undo: [2003 2004]\r\n2020-03-19T12:34:34Z Pre-allocating up to position 0x1000000 in blk02005.dat\r\n2020-03-19T12:34:34Z New outbound peer connected: version: 70015, blocks=622190, peer=10 (full-relay)\r\n2020-03-19T12:34:34Z Pre-allocating up to position 0x2000000 in blk02005.dat\r\n2020-03-19T12:34:35Z Pre-allocating up to position 0x3000000 in blk02005.dat\r\n2020-03-19T12:34:36Z Pre-allocating up to position 0x4000000 in blk02005.dat\r\n2020-03-19T12:34:38Z Pre-allocating up to position 0x5000000 in blk02005.dat\r\n2020-03-19T12:34:43Z Pre-allocating up to position 0x100000 in rev02005.dat\r\n2020-03-19T12:34:45Z New outbound peer connected: version: 70015, blocks=622190, peer=11 (full-relay)\r\n2020-03-19T12:34:46Z New outbound peer connected: version: 70015, blocks=622190, peer=12 (block-relay)\r\n2020-03-19T12:34:46Z New outbound peer connected: version: 70015, blocks=622190, peer=13 (block-relay)\r\n2020-03-19T12:34:48Z Pre-allocating up to position 0x6000000 in blk02005.dat\r\n2020-03-19T12:34:51Z New outbound peer connected: version: 70015, blocks=622190, peer=14 (block-relay)\r\n2020-03-19T12:35:09Z Pre-allocating up to position 0x7000000 in blk02005.dat\r\n2020-03-19T12:35:10Z Synchronizing blockheaders, height: 622191 (~100.00%)\r\n2020-03-19T12:37:49Z Synchronizing blockheaders, height: 622192 (~100.00%)\r\n2020-03-19T12:39:53Z Pre-allocating up to position 0x200000 in rev02005.dat\r\n2020-03-19T12:40:43Z Pre-allocating up to position 0x8000000 in blk02005.dat\r\n2020-03-19T12:41:24Z Synchronizing blockheaders, height: 622193 (~100.00%)\r\n2020-03-19T12:43:44Z Pre-allocating up to position 0x300000 in rev02005.dat\r\n2020-03-19T12:44:01Z Pre-allocating up to position 0x400000 in rev02005.dat\r\n2020-03-19T12:44:02Z Pre-allocating up to position 0x600000 in rev02003.dat\r\n2020-03-19T12:44:03Z Pre-allocating up to position 0x700000 in rev02003.dat\r\n2020-03-19T12:44:03Z Pre-allocating up to position 0x800000 in rev02003.dat\r\n2020-03-19T12:44:04Z Pre-allocating up to position 0x900000 in rev02003.dat\r\n2020-03-19T12:44:04Z Pre-allocating up to position 0xa00000 in rev02003.dat\r\n2020-03-19T12:44:05Z Pre-allocating up to position 0xb00000 in rev02003.dat\r\n2020-03-19T12:44:06Z Pre-allocating up to position 0x500000 in rev02005.dat\r\n2020-03-19T12:44:06Z Pre-allocating up to position 0x200000 in rev02004.dat\r\n2020-03-19T12:44:06Z Pre-allocating up to position 0xc00000 in rev02003.dat\r\n2020-03-19T12:44:07Z Pre-allocating up to position 0xd00000 in rev02003.dat\r\n2020-03-19T12:44:08Z Pre-allocating up to position 0xe00000 in rev02003.dat\r\n2020-03-19T12:44:09Z Pre-allocating up to position 0x300000 in rev02004.dat\r\n2020-03-19T12:44:09Z Pre-allocating up to position 0x600000 in rev02005.dat\r\n2020-03-19T12:44:10Z Pre-allocating up to position 0xf00000 in rev02003.dat\r\n2020-03-19T12:44:11Z Pre-allocating up to position 0x400000 in rev02004.dat\r\n2020-03-19T12:44:12Z Pre-allocating up to position 0x500000 in rev02004.dat\r\n2020-03-19T12:44:12Z Pre-allocating up to position 0x1000000 in rev02003.dat\r\n2020-03-19T12:44:13Z Pre-allocating up to position 0x1100000 in rev02003.dat\r\n2020-03-19T12:44:14Z *** FLUSH UNDO FILE 2003 ***\r\n2020-03-19T12:44:14Z finalize undo 2003\r\n2020-03-19T12:44:14Z unflushed undo: [2004 2005]\r\n2020-03-19T12:44:14Z Pre-allocating up to position 0x600000 in rev02004.dat\r\n2020-03-19T12:44:15Z Pre-allocating up to position 0x700000 in rev02004.dat\r\n2020-03-19T12:44:16Z Pre-allocating up to position 0x800000 in rev02004.dat\r\n2020-03-19T12:44:16Z Pre-allocating up to position 0x900000 in rev02004.dat\r\n2020-03-19T12:44:16Z Leaving InitialBlockDownload (latching to false)\r\n2020-03-19T12:44:18Z Pre-allocating up to position 0x700000 in rev02005.dat\r\n2020-03-19T12:44:19Z Pre-allocating up to position 0xa00000 in rev02004.dat\r\n2020-03-19T12:44:19Z Pre-allocating up to position 0xb00000 in rev02004.dat\r\n2020-03-19T12:44:20Z Pre-allocating up to position 0xc00000 in rev02004.dat\r\n2020-03-19T12:44:21Z Pre-allocating up to position 0xd00000 in rev02004.dat\r\n2020-03-19T12:44:22Z Pre-allocating up to position 0xe00000 in rev02004.dat\r\n2020-03-19T12:44:22Z Pre-allocating up to position 0x800000 in rev02005.dat\r\n2020-03-19T12:44:23Z Pre-allocating up to position 0x900000 in rev02005.dat\r\n2020-03-19T12:44:23Z Pre-allocating up to position 0xf00000 in rev02004.dat\r\n2020-03-19T12:44:24Z Pre-allocating up to position 0x1000000 in rev02004.dat\r\n2020-03-19T12:44:25Z Pre-allocating up to position 0xa00000 in rev02005.dat\r\n2020-03-19T12:44:26Z Pre-allocating up to position 0x1100000 in rev02004.dat\r\n2020-03-19T12:44:26Z Pre-allocating up to position 0xb00000 in rev02005.dat\r\n2020-03-19T12:44:27Z *** FLUSH UNDO FILE 2004 ***\r\n2020-03-19T12:44:27Z finalize undo 2004\r\n2020-03-19T12:44:27Z unflushed undo: [2005]\r\n2020-03-19T12:44:27Z Pre-allocating up to position 0xc00000 in rev02005.dat\r\n2020-03-19T12:44:28Z Pre-allocating up to position 0xd00000 in rev02005.dat\r\n2020-03-19T12:44:29Z Pre-allocating up to position 0xe00000 in rev02005.dat\r\n2020-03-19T12:44:29Z Pre-allocating up to position 0xf00000 in rev02005.dat\r\n2020-03-19T12:44:30Z Pre-allocating up to position 0x1000000 in rev02005.dat\r\n2020-03-19T13:09:43Z Pre-allocating up to position 0x1100000 in rev02005.dat\r\n2020-03-19T13:32:41Z unflushed undo: [2005]\r\n2020-03-19T13:53:07Z iterating nFile: last height = 622198; chain tip height = 622198 -> FLUSH UNDO FILE\r\n2020-03-19T13:53:07Z finalize undo 2005\r\n2020-03-19T13:53:07Z unflushed undo: []\r\n2020-03-19T13:53:07Z Leaving block file 2005: CBlockFileInfo(blocks=104, size=133278069, heights=621900...622198, time=2020-03-16...2020-03-19)\r\n2020-03-19T13:53:07Z unflushed undo: []\r\n2020-03-19T13:53:07Z Pre-allocating up to position 0x1000000 in blk02006.dat\r\n2020-03-19T13:53:07Z Pre-allocating up to position 0x100000 in rev02006.dat\r\n```\r\n",
      "created_at" : "2020-03-19T14:01:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#issuecomment-601195517",
      "id" : 601195517,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17994",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTE5NTUxNw==",
      "updated_at" : "2020-03-19T14:01:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601195517",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395061642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395061642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I didn't see this comment until now. I'll update the code in the next push.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-19T14:21:17Z",
      "diff_hunk" : "@@ -1731,19 +1731,23 @@ DisconnectResult CChainState::DisconnectBlock(const CBlock& block, const CBlockI\n     return fClean ? DISCONNECT_OK : DISCONNECT_UNCLEAN;\n }\n \n-void static FlushBlockFile(bool fFinalize = false)\n+static void FlushUndoFile(int block_file, bool finalize = false)\n {\n-    LOCK(cs_LastBlockFile);\n+    FlatFilePos undo_pos_old(block_file, vinfoBlockFile[block_file].nUndoSize);\n+    if (!UndoFileSeq().Flush(undo_pos_old, finalize)) {\n+        AbortNode(\"Flushing undo file to disk failed. This is likely the result of an I/O error.\");\n+    }\n+}\n \n+static void FlushBlockFile(bool fFinalize = false)\n+{\n+    LOCK(cs_LastBlockFile);\n     FlatFilePos block_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nSize);\n-    FlatFilePos undo_pos_old(nLastBlockFile, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-\n-    bool status = true;\n-    status &= BlockFileSeq().Flush(block_pos_old, fFinalize);\n-    status &= UndoFileSeq().Flush(undo_pos_old, fFinalize);\n-    if (!status) {\n+    if (!BlockFileSeq().Flush(block_pos_old, fFinalize)) {\n         AbortNode(\"Flushing block file to disk failed. This is likely the result of an I/O error.\");\n     }\n+    // the undo file is actually finalized at a later stage, but we do want to flush it along with the block file\n+    if (!fFinalize) FlushUndoFile(nLastBlockFile);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395061642",
      "id" : 395061642,
      "in_reply_to_id" : 391244966,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA2MTY0Mg==",
      "original_commit_id" : "48081229c10969ac5993c826c8bd7687cd0503e5",
      "original_position" : 28,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 377765292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395061642",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395301371"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395301371"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This will flush the undo file before the corresponding block file which is flushed a [few lines below](https://github.com/bitcoin/bitcoin/pull/17994/files#diff-24efdb00bfbe56b140fb006b562cc70bR3279). Also visible in the log you pasted where `finalize undo 2005` appears before `Leaving block file 2005`.\r\n\r\nI am not sure but I think we want to always flush the block file first and the undo file afterwards.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-19T20:29:34Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+            // when the undo file is keeping up with the block file, we flush it explicitly, here\n+            // when it is lagging behind (more blocks arrive than are being connected), we let the\n+            // undo block write case handle it\n+            LogPrintf(\"iterating nFile: last height = %d; chain tip height = %d -> %s\\n\",\n+                vinfoBlockFile[nFile].nHeightLast,\n+                ChainActive().Tip()->nHeight,\n+                vinfoBlockFile[nFile].nHeightLast == ChainActive().Tip()->nHeight ? \"FLUSH UNDO FILE\" : \"DO NOT FLUSH UNDO FILE\");\n+            if (vinfoBlockFile[nFile].nHeightLast == ChainActive().Tip()->nHeight) {\n+                FlushUndoFile(nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395301371",
      "id" : 395301371,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMTM3MQ==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 87,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 378070039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395301371",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395303817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395303817"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I find this `while` extremely confusing - it looks to me that it will never iterate more than once. We need a block size of more than 128MB (blk file size limit) to get this execute 2 or more times, so that one block spans multiple blk files (!?).\r\n\r\nMaybe out of the scope of this PR, but I think we should `s/while/if/`. Is my understanding correct? If not then we will end up finalizing an empty undo file with this patch on the second and subsequent iterations.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-19T20:34:29Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395303817",
      "id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTMwMzgxNw==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378070039,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395303817",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395446941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395446941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I *think* the way it works now is fine; the \"unflushed undo files\" output is consistently showing the current opened one only, so it indicates the same.\r\n\r\nLet me go through the steps:\r\n\r\n* Sync state: HEIGHT = 100, BLK = 100, UNDO = 100, block file 0\r\n* Block 101 comes in (we assume it does not fit into the current block file, so we will move to block file 1)\r\n* First we want to store it to disk: \r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c4400e1b8a62269d04b57a46d68941fdbaae4303/src/validation.cpp#L3731-L3736\r\n\r\n* We go find a position and end up in the next block file (1), at which point we flush the undo file (0):\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c4400e1b8a62269d04b57a46d68941fdbaae4303/src/validation.cpp#L3254-L3264\r\n\r\n* Sync state: HEIGHT = 100, BLK = 101, UNDO = 100, block file 1\r\n* We now want to accept block 101, and at this point we write the undo data (for block 101)\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/c4400e1b8a62269d04b57a46d68941fdbaae4303/src/validation.cpp#L1773-L1787\r\n\r\n* The condition does not trigger here, because we are synced up (as you pointed out), but we end up writing into undo file 1, and undo file 0 was finalized as it should.\r\n* Sync state: HEIGHT = 101, BLK = 101, UNDO = 101, block file 1\r\n\r\nLet me know if I got something wrong in the above (or if there are any other holes in the patch). I will update the log above once it moves to block file 2007.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T05:40:53Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+            // when the undo file is keeping up with the block file, we flush it explicitly, here\n+            // when it is lagging behind (more blocks arrive than are being connected), we let the\n+            // undo block write case handle it\n+            LogPrintf(\"iterating nFile: last height = %d; chain tip height = %d -> %s\\n\",\n+                vinfoBlockFile[nFile].nHeightLast,\n+                ChainActive().Tip()->nHeight,\n+                vinfoBlockFile[nFile].nHeightLast == ChainActive().Tip()->nHeight ? \"FLUSH UNDO FILE\" : \"DO NOT FLUSH UNDO FILE\");\n+            if (vinfoBlockFile[nFile].nHeightLast == ChainActive().Tip()->nHeight) {\n+                FlushUndoFile(nFile, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395446941",
      "id" : 395446941,
      "in_reply_to_id" : 395301371,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0Njk0MQ==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 87,
      "path" : "src/validation.cpp",
      "position" : 56,
      "pull_request_review_id" : 378242564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395446941",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395448123"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395448123"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I dug into this. Apparently, the system is supposed to support multiple files *per block*. This was a change made 8 years ago in 5382bcf8cd23c36a435c29080770a79b5e28af42 by @sipa. It doesn't look like it is actually working, though, but I could be wrong.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T05:47:50Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395448123",
      "id" : 395448123,
      "in_reply_to_id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0ODEyMw==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378243995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:50:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395448123",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395449720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395449720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@kallewoof No, that commit adds support for multiple *blocks per file*, which is definitely used. There has never been support for multiple files per block.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T05:56:48Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395449720",
      "id" : 395449720,
      "in_reply_to_id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ0OTcyMA==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378245881,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T05:56:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395449720",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395454053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395454053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, yeah you're right. But this while loop makes no sense to me still.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T06:20:03Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395454053",
      "id" : 395454053,
      "in_reply_to_id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1NDA1Mw==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378251059,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T06:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395454053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395457390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395457390"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's just iterating to find the first block file with space for the new block.",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T06:36:10Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395457390",
      "id" : 395457390,
      "in_reply_to_id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ1NzM5MA==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378255053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T06:36:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395457390",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395461388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395461388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Okay, so assuming we one day decided to stop writing block files sequentially, we may have a situation where we try to `find block pos` for `nFile = 2007` where the last block file in existence is actually `nFile = 2010` or something `>2008`, in which case this while loop becomes necessary.\r\n\r\nI don't really see that ever happening though, and it feels like someone mixed up \"block file writing order\" (sequentially; we never write into older block files or into the middle of a file in between other stuff) with \"connect order\" (non-sequentially, as blocks are not stored in height order).",
      "commit_id" : "a3abe25f720104e4abf0d3f01f0b847929167b8b",
      "created_at" : "2020-03-20T06:53:25Z",
      "diff_hunk" : "@@ -3222,6 +3253,16 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17994#discussion_r395461388",
      "id" : 395461388,
      "in_reply_to_id" : 395303817,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ2MTM4OA==",
      "original_commit_id" : "c4400e1b8a62269d04b57a46d68941fdbaae4303",
      "original_position" : 78,
      "path" : "src/validation.cpp",
      "position" : 51,
      "pull_request_review_id" : 378259946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17994",
      "updated_at" : "2020-03-20T06:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/395461388",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/250224?v=4",
         "events_url" : "https://api.github.com/users/kallewoof/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kallewoof/followers",
         "following_url" : "https://api.github.com/users/kallewoof/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kallewoof/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kallewoof",
         "id" : 250224,
         "login" : "kallewoof",
         "node_id" : "MDQ6VXNlcjI1MDIyNA==",
         "organizations_url" : "https://api.github.com/users/kallewoof/orgs",
         "received_events_url" : "https://api.github.com/users/kallewoof/received_events",
         "repos_url" : "https://api.github.com/users/kallewoof/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kallewoof/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kallewoof"
      }
   }
]
