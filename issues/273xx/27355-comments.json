[
   {
      "author_association" : "MEMBER",
      "body" : "Reproducible? If yes, what are the steps to reproduce?",
      "created_at" : "2023-03-28T14:56:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27355#issuecomment-1487049094",
      "id" : 1487049094,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27355",
      "node_id" : "IC_kwDOABII585YopGG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487049094/reactions"
      },
      "updated_at" : "2023-03-28T14:56:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487049094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Reproducible\r\n\r\n100%. Running `time FILE_ENV=\"./ci/test/00_setup_env_native_tsan.sh\" ./ci/test_run_all.sh` on a aarch64 machine running Fedora 37.",
      "created_at" : "2023-03-28T14:58:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27355#issuecomment-1487053086",
      "id" : 1487053086,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27355",
      "node_id" : "IC_kwDOABII585YoqEe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487053086/reactions"
      },
      "updated_at" : "2023-03-28T14:58:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487053086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Retesting this on master (04595484d97100a50c146e5fc080319d9e0f5ca4). 1 line missing from the above output, which is dumped out in the test failure output before the test is re-run is `libc++abi: Pure virtual function called!`:\r\n```bash\r\n2023-04-05T15:47:47.686929Z (mocktime: 2020-08-31T15:34:12Z) [basic block filter index] [util/thread.cpp:20] [TraceThread] basic block filter index thread start\r\ntest/blockfilter_index_tests.cpp(147): fatal error: in \"blockfilter_index_tests/blockfilter_index_initial_sync\": critical check time_start + timeout_ms > GetTimeMillis() has failed\r\nlibc++abi: Pure virtual function called!\r\nmake[3]: *** [Makefile:21866: test/blockfilter_index_tests.cpp.test] Error 1\r\n```",
      "created_at" : "2023-04-05T16:05:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27355#issuecomment-1497754148",
      "id" : 1497754148,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27355",
      "node_id" : "IC_kwDOABII585ZReok",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1497754148/reactions"
      },
      "updated_at" : "2023-04-05T16:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1497754148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that the data race is not the root cause, but happens as a result of the absolute timeout  https://github.com/bitcoin/bitcoin/blob/04595484d97100a50c146e5fc080319d9e0f5ca4/src/test/txindex_tests.cpp#L35\r\nnot being sufficient, because the test environment is too slow for whatever reason.\r\nIn this case, the `BOOST_REQUIRE` in https://github.com/bitcoin/bitcoin/blob/04595484d97100a50c146e5fc080319d9e0f5ca4/src/test/txindex_tests.cpp#L38 fails, and the index isn't terminated correctly (by waiting for `ThreadSync` to stop, as it would be done in `txindex.Stop()` below if the boost assert wasn't hit)\r\n\r\nI could reproduce the error and the data race on my machine (x86_64 Ubuntu) by setting `timeout_ms = 0` in the line above.\r\n\r\nAs a fix, I think that we should wait longer for the sync to finish, by either getting rid of the constant timeout (though that would mean it could run forever if something was wrong) or at least increasing it significantly. I'll look into that.\r\n\r\n",
      "created_at" : "2023-04-05T19:35:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27355#issuecomment-1498015461",
      "id" : 1498015461,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27355",
      "node_id" : "IC_kwDOABII585ZSebl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1498015461/reactions"
      },
      "updated_at" : "2023-04-05T19:46:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1498015461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, the existing timeout of 10 seconds seems plenty for the sync process, which takes just a few milliseconds on my computer.\r\n@fanquake would a higher timeout fix this in your environment? Are you doing some extreme parallelization or someting, such that the test is simply that slow? \r\nOr is there possibly some other reason that prevents the Index sync from finishing on aarch64, so that bumping the timeout wouldn't help?",
      "created_at" : "2023-04-05T20:28:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/27355#issuecomment-1498111803",
      "id" : 1498111803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27355",
      "node_id" : "IC_kwDOABII585ZS187",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1498111803/reactions"
      },
      "updated_at" : "2023-04-05T20:28:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1498111803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
