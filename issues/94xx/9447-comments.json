[
   {
      "body" : "Seems to fail `sendheaders.py` but not on my local machine...  I'll look into it...",
      "created_at" : "2016-12-30T16:09:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269788793",
      "id" : 269788793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
      "updated_at" : "2016-12-30T16:09:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269788793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269152"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269152"
         }
      },
      "body" : "not `__func__` ?",
      "commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "created_at" : "2016-12-31T04:56:13Z",
      "diff_hunk" : "@@ -752,6 +752,33 @@ void PeerLogicValidation::SyncTransaction(const CTransaction& tx, const CBlockIn\n     }\n }\n \n+void PeerLogicValidation::NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock>& pblock) {\n+    CBlockHeaderAndShortTxIDs cmpctblock(*pblock, true);\n+    CNetMsgMaker msgMaker(PROTOCOL_VERSION);\n+\n+    LOCK(cs_main);\n+    bool fWitnessEnabled = IsWitnessEnabled(pindex->pprev, Params().GetConsensus());\n+    uint256 hashBlock(pblock->GetHash());\n+\n+    connman->ForEachNode([this, &cmpctblock, pindex, &msgMaker, fWitnessEnabled, &hashBlock](CNode* pnode) {\n+        // TODO: Avoid the repeated-serialization here\n+        if (pnode->nVersion < INVALID_CB_NO_BAN_VERSION || pnode->fDisconnect)\n+            return;\n+        ProcessBlockAvailability(pnode->GetId());\n+        CNodeState &state = *State(pnode->GetId());\n+        // If the peer has, or we announced to them the previous block already,\n+        // but we don't think they have this one, go ahead and announce it\n+        if (state.fPreferHeaderAndIDs && (!fWitnessEnabled || state.fWantsCmpctWitness) &&\n+                !PeerHasHeader(&state, pindex) && PeerHasHeader(&state, pindex->pprev)) {\n+\n+            LogPrint(\"net\", \"%s sending header-and-ids %s to peer %d\\n\", \"PeerLogicValidation::NewPoWValidBlock\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269152",
      "id" : 94269152,
      "original_commit_id" : "bc51179da8963e9720a3353c14f84f4a039bf0dc",
      "original_position" : 23,
      "path" : "src/net_processing.cpp",
      "position" : 337,
      "pull_request_review_id" : 14800145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
      "updated_at" : "2016-12-31T04:56:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269789"
         }
      },
      "body" : "why not make this < instead of <= ? why do we avoid requesting compact blocks for competing best blocks?",
      "commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "created_at" : "2016-12-31T06:06:53Z",
      "diff_hunk" : "@@ -1782,30 +1880,63 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             }\n         }\n \n+        // When we succeed in decoding a block's txids from a cmpctblock\n+        // message we typically jump to the BLOCKTXN handling code, with a\n+        // dummy (empty) BLOCKTXN message, to re-use the logic there in\n+        // completing processing of the putative block (without cs_main).\n+        bool fProcessBLOCKTXN = false;\n+        CDataStream blockTxnMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n+        // If we end up treating this as a plain headers message, call that as well\n+        // without cs_main.\n+        bool fRevertToHeaderProcessing = false;\n+        CDataStream vHeadersMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n         // Keep a CBlock for \"optimistic\" compactblock reconstructions (see\n         // below)\n         std::shared_ptr<CBlock> pblock = std::make_shared<CBlock>();\n         bool fBlockReconstructed = false;\n \n+        {\n         LOCK(cs_main);\n         // If AcceptBlockHeader returned true, it set pindex\n         assert(pindex);\n         UpdateBlockAvailability(pfrom->GetId(), pindex->GetBlockHash());\n \n-        std::map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n+        std::pair<BlockDownloadMap::iterator, BlockDownloadMap::iterator> rangeInFlight = mmapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = rangeInFlight.first != rangeInFlight.second;\n+        bool fInFlightFromSamePeer = false;\n+        bool fPeerWasFirstRequest = true;\n+        bool peerFound = false;\n+        size_t countPartialBlocksStarted = 0;\n+        while (rangeInFlight.first != rangeInFlight.second) {\n+            if (rangeInFlight.first->second.first == pfrom->GetId()) {\n+                fInFlightFromSamePeer = true;\n+                peerFound = true;\n+            }\n+            if (rangeInFlight.first->second.second->partialBlock)\n+                countPartialBlocksStarted++;\n+            rangeInFlight.first++;\n+            if (!peerFound)\n+                fPeerWasFirstRequest = false;\n+        }\n \n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n-\n+        LogPrintf(\"ChainWork check at height %d new: %s  tip: %s\\n\",pindex->nHeight,pindex->nChainWork.GetHex(),chainActive.Tip()->nChainWork.GetHex());\n         if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269789",
      "id" : 94269789,
      "original_commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "original_position" : 518,
      "path" : "src/net_processing.cpp",
      "position" : 518,
      "pull_request_review_id" : 14800768,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
      "updated_at" : "2016-12-31T06:06:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269821"
         }
      },
      "body" : "What is the deal with block height 165?",
      "commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "created_at" : "2016-12-31T06:11:00Z",
      "diff_hunk" : "@@ -1893,24 +2022,41 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                     fBlockReconstructed = true;\n                 }\n             }\n+            if (pindex->nHeight == 165) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269821",
      "id" : 94269821,
      "original_commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "original_position" : 607,
      "path" : "src/net_processing.cpp",
      "position" : 607,
      "pull_request_review_id" : 14800796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
      "updated_at" : "2016-12-31T06:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269827"
         }
      },
      "body" : "Very much approve of the variable namings chosen in various places.",
      "commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "created_at" : "2016-12-31T06:12:12Z",
      "diff_hunk" : "@@ -1946,17 +2084,27 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         {\n             LOCK(cs_main);\n \n-            map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator it = mapBlocksInFlight.find(resp.blockhash);\n-            if (it == mapBlocksInFlight.end() || !it->second.second->partialBlock ||\n-                    it->second.first != pfrom->GetId()) {\n+            bool fExpectedBLOCKTXN = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269827",
      "id" : 94269827,
      "original_commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "original_position" : 682,
      "path" : "src/net_processing.cpp",
      "position" : 682,
      "pull_request_review_id" : 14800805,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
      "updated_at" : "2016-12-31T06:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269850"
         }
      },
      "body" : "Why not make this <=2 rather than ==1 (for mapBlocksInFlight.size())? this way if two blocks get announced in close proximity we can request compact blocks for both of them (rather than compact block for the oldest, and full block for the most recent).",
      "commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "created_at" : "2016-12-31T06:15:06Z",
      "diff_hunk" : "@@ -2142,10 +2304,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n-                        // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mmapBlocksInFlight.size() == mmapBlocksInFlight.count(vGetData[0].hash) && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269850",
      "id" : 94269850,
      "original_commit_id" : "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
      "original_position" : 791,
      "path" : "src/net_processing.cpp",
      "position" : 791,
      "pull_request_review_id" : 14800829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
      "updated_at" : "2016-12-31T06:15:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "I like the coding style and elegance of this. Will help with testing.",
      "created_at" : "2016-12-31T06:17:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269851859",
      "id" : 269851859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
      "updated_at" : "2016-12-31T06:17:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269851859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "body" : "@rebroad As mentioned in the PR comment, this is built off 3 other PR's.  All of your comments either belong on those PR's or are related to the last commit which was just for debugging the travis failure and will be removed.  I have just left it there for now in case anyone else wants to see the error details.",
      "created_at" : "2016-12-31T14:30:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269867345",
      "id" : 269867345,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
      "updated_at" : "2016-12-31T14:30:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269867345",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "@morcos claimed on IRC the test failures might be (in part) due to the issue mentioned at https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269871618",
      "created_at" : "2016-12-31T16:19:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269871743",
      "id" : 269871743,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
      "updated_at" : "2016-12-31T16:19:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269871743",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   }
]
