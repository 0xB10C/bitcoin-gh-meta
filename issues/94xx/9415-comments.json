[
   {
      "body" : "There's so much currently wrong with this loop that I'm hesitant to make changes before rewriting it entirely. I've been discussing my plans with @TheBlueMatt for doing just that after #9289 is merged.\r\n\r\nSome other fun issues with this loop (I'm sure I'm leaving several out):\r\n- messageHandlerCondition wakes spuriously\r\n- The depth of vRecvGetData and messages to send aren't taken into consideration\r\n- cs_vRecvMsg is held for the duration of message processing, leading to insane lock contention\r\n\r\nI have no objections to slapping some band-aids on here, but I'm really really hoping to address all of those at once in my next PR which moves this handler into net_processing. As a bonus, it should simplify @TheBlueMatt's multi-threaded processing.",
      "created_at" : "2016-12-24T07:41:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269073566",
      "id" : 269073566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T07:41:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269073566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> messageHandlerCondition wakes spuriously\r\n\r\nwho cares? :) It's not like this loop or processing that results from random wakes ever shows up in profiles. \r\n\r\nIf it were a real concern it would be easy to go back to sleep if the boolean hasn't been flipped and not enough time has passed.\r\n\r\n>  but I'm really really hoping to address all of those at once in my next PR which moves this handler into net_processing.\r\n\r\nMy guess is that we may be a bit close to the end of 0.14 to achieve much more in the way of big changes, especially ones with difficult to test concurrency implications.  I just don't want efforts to make big sweeping changes to stand in the way of meaningful improvement-- we probably should have made the changes in this PR a year ago.\r\n\r\nI'm reviewing 9289-- hopefully we can get that in soon.\r\n",
      "created_at" : "2016-12-24T22:19:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102470",
      "id" : 269102470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T22:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269102470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I'm hoping the next PR isn't huge in the way of complicated locking implications, more like simplified locking implications compared to master. Let's wait and take a look next week (and if we decide it can't make it we can come back to here - I think the potential advantage in initial from-network sync time from \"doing it right\" might be worth the extra review/testing implications).\n\nOn December 24, 2016 5:19:59 PM EST, Gregory Maxwell <notifications@github.com> wrote:\n>> messageHandlerCondition wakes spuriously\n>\n>who cares? :) It's not like this loop or processing that results from\n>random wakes ever shows up in profiles. \n>\n>If it were a real concern it would be easy to go back to sleep if the\n>boolean hasn't been flipped and not enough time has passed.\n>\n>>  but I'm really really hoping to address all of those at once in my\n>next PR which moves this handler into net_processing.\n>\n>My guess is that we may be a bit close to the end of 0.14 to achieve\n>much more in the way of big changes, especially ones with difficult to\n>test concurrency implications.  I just don't want efforts to make big\n>sweeping changes to stand in the way of meaningful improvement-- we\n>probably should have made the changes in this PR a year ago.\n>\n>I'm reviewing 9289-- hopefully we can get that in soon.\n>\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102470\n",
      "created_at" : "2016-12-24T22:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269102850",
      "id" : 269102850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-24T22:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269102850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "> who cares? :) It's not like this loop or processing that results from random wakes ever shows up in profiles.\r\n\r\nMy concern was moreso that some platforms (win32) may vary significantly in this wakeup behavior.\r\n\r\nCompletely agree with you though. I certainly wasn't suggesting that we not take the improvements here for the sake of something coming later. In fact, the wake from the miner is necessary either way. I was just pointing out that I'm hoping to be able to delete most of this code soon anyway :)",
      "created_at" : "2016-12-25T06:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269111417",
      "id" : 269111417,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-25T06:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269111417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Mystery: this slows the IBD of the first 200k blocks from a local gigabit ethernet connected peer by about 40%. I've run the test 4 times each way, same result.  Maybe if we solve that, we make IBD faster.",
      "created_at" : "2016-12-27T11:52:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269316189",
      "id" : 269316189,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-27T11:52:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269316189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I bisected my patch down to the  cs_vSend cs_vRecvMsg contention causing fsleep=false to be the cause of the IBD performance regression.",
      "created_at" : "2016-12-27T23:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269398595",
      "id" : 269398595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-27T23:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269398595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Ugh, yea, those desperately need splitting. I know @theuni has been working on a patch to do that, see-also https://github.com/bitcoin/bitcoin/pull/9419/commits/c214d120a363a05ba9afdccff6b4bda6e29ae7c4\n\nOn December 28, 2016 12:39:28 AM GMT+01:00, Gregory Maxwell <notifications@github.com> wrote:\n>I bisected my patch down to the  cs_vSend cs_vRecvMsg contention\n>causing fsleep=false to be the cause of the IBD performance regression.\n>\n>-- \n>You are receiving this because you were mentioned.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269398595\n",
      "created_at" : "2016-12-28T11:34:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269465287",
      "id" : 269465287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-28T11:34:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269465287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "I tested reducing the message handler hold of cs_vrecv lock to be just a narrow space small enough to std::move the message out, and speed up IBD to 200k from a single peer by more than a factor of two over master.",
      "created_at" : "2016-12-29T08:12:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#issuecomment-269595765",
      "id" : 269595765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9415",
      "updated_at" : "2016-12-29T14:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269595765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9415#discussion_r94116433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9415"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94116433"
         }
      },
      "body" : "Looping here to process all outstanding messages might not be desirable because it could let a single peer monopolize processing. Any thoughts on that?",
      "commit_id" : "0199fd1afa60801413ad55fbc9f52c95a8fe0048",
      "created_at" : "2016-12-29T09:28:41Z",
      "diff_hunk" : "@@ -2444,36 +2443,36 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman)\n         ProcessGetData(pfrom, chainparams.GetConsensus(), connman);\n \n     // this maintains the order of responses\n-    if (!pfrom->vRecvGetData.empty()) return fOk;\n-\n-    std::deque<CNetMessage>::iterator it = pfrom->vRecvMsg.begin();\n-    while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n-        // Don't bother if send buffer is too full to respond anyway\n-        if (pfrom->nSendSize >= nMaxSendBufferSize)\n-            break;\n-\n-        // get next message\n-        CNetMessage& msg = *it;\n-\n-        //if (fDebug)\n-        //    LogPrintf(\"%s(message %u msgsz, %u bytes, complete:%s)\\n\", __func__,\n-        //            msg.hdr.nMessageSize, msg.vRecv.size(),\n-        //            msg.complete() ? \"Y\" : \"N\");\n-\n-        // end, if an incomplete message is found\n-        if (!msg.complete())\n-            break;\n-\n-        // at this point, any failure means we can delete the current message\n-        it++;\n+    if (!pfrom->vRecvGetData.empty()) {\n+        connman.WakeMessageHandler();\n+        return fOk;\n+    }\n \n-        // Scan for message start\n-        if (memcmp(msg.hdr.pchMessageStart, chainparams.MessageStart(), CMessageHeader::MESSAGE_START_SIZE) != 0) {\n-            LogPrintf(\"PROCESSMESSAGE: INVALID MESSAGESTART %s peer=%d\\n\", SanitizeString(msg.hdr.GetCommand()), pfrom->id);\n-            fOk = false;\n+    while (!pfrom->fDisconnect) {\n+        std::vector<CNetMessage> vMsg;\n+        if (pfrom->nSendSize >= nMaxSendBufferSize) {\n+            connman.WakeMessageHandler();\n             break;\n         }\n+        {\n+            TRY_LOCK(pfrom->cs_vRecvMsg, lockRecv);\n+            if (lockRecv)\n+            {\n+                if (!pfrom->vRecvMsg.empty()) {\n+                    if (!pfrom->vRecvMsg.front().complete()) break;\n+                    // Move the message.\n+                    vMsg.push_back(std::move(pfrom->vRecvMsg.front()));\n+                    if (pfrom->fDisconnect) break;\n+                    pfrom->vRecvMsg.pop_front();\n+                }\n+            } else {\n+                connman.WakeMessageHandler();\n+            }\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9415#discussion_r94116433",
      "id" : 94116433,
      "original_commit_id" : "45bd16ea210858051907126540a5b56849cf60f0",
      "original_position" : 63,
      "path" : "src/net_processing.cpp",
      "position" : 63,
      "pull_request_review_id" : 14646739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9415",
      "updated_at" : "2016-12-29T09:30:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94116433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
