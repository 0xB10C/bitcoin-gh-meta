[
   {
      "body" : "Concept ACK\r\n\r\n(Tries to solve issue #4082 et al.)",
      "created_at" : "2016-12-30T16:14:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#issuecomment-269789576",
      "id" : 269789576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9404",
      "updated_at" : "2016-12-30T16:14:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269789576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "body" : "Concept ACK but will be simpler when rebased on #9465.",
      "created_at" : "2017-01-04T15:52:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#issuecomment-270404906",
      "id" : 270404906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9404",
      "updated_at" : "2017-01-04T15:52:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270404906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "This has been rebased on #9465 (thanks @gmaxwell)\r\n\r\nIt is now much simpler.   \r\nI added a second commit to almost completely resolve #9466 \r\n\r\n",
      "created_at" : "2017-01-05T16:11:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#issuecomment-270682611",
      "id" : 270682611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9404",
      "updated_at" : "2017-01-05T16:11:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270682611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "Beautiful. utACK.  Should be rebased on the latest nit-update of 9465 (sorry about that), I expect it will do so cleanly.\r\n\r\nWe should open an issue to also resolve these behaviors when nSubtractFeeFromAmount is used; I can understand why you didn't cover those in this PR; though they should only be of comparable complexity to this change.",
      "created_at" : "2017-01-05T21:06:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#issuecomment-270757583",
      "id" : 270757583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9404",
      "updated_at" : "2017-01-05T21:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270757583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Needs rebase on #9465 merge.",
      "created_at" : "2017-01-05T21:37:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#issuecomment-270764890",
      "id" : 270764890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9404",
      "updated_at" : "2017-01-05T21:37:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270764890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94856966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94856966"
         }
      },
      "body" : "I guess there's an edge case left here, where if there's no change output and the fee difference is very large, then we won't reduce the fee?\r\n\r\nIt might be nice to refactor the change-adding logic so that we could add change in that scenario, though I don't want to hold up this PR which is already a strict improvement, do you think it's worth adding a comment that points this out though for future reference?",
      "commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "created_at" : "2017-01-05T21:38:07Z",
      "diff_hunk" : "@@ -2534,8 +2534,17 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     return false;\n                 }\n \n-                if (nFeeRet >= nFeeNeeded)\n+                if (nFeeRet >= nFeeNeeded) {\n+                    // Reduce fee to only the needed amount if we have change output to increase\n+                    // Do not do this if fee was paid by payee\n+                    if (nFeeRet > nFeeNeeded && nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94856966",
      "id" : 94856966,
      "original_commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "original_position" : 8,
      "path" : "src/wallet/wallet.cpp",
      "position" : 82,
      "pull_request_review_id" : 15397912,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404",
      "updated_at" : "2017-01-05T21:39:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94856966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94882975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94882975"
         }
      },
      "body" : "I might be missing something, but instead of \"Do not\", the comment should read \"TODO\". Otherwise, it would imply that it is ok for the payee to pay excessive fee whereas for the payer it is not.",
      "commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "created_at" : "2017-01-06T00:45:49Z",
      "diff_hunk" : "@@ -2550,14 +2534,66 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     return false;\n                 }\n \n-                if (nFeeRet >= nFeeNeeded)\n+                if (nFeeRet >= nFeeNeeded) {\n+                    // Reduce fee to only the needed amount if we have change output to increase\n+                    // Do not do this if fee was paid by payee",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94882975",
      "id" : 94882975,
      "original_commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "original_position" : 81,
      "path" : "src/wallet/wallet.cpp",
      "position" : 81,
      "pull_request_review_id" : 15424846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404",
      "updated_at" : "2017-01-06T00:49:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94882975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94883639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94883639"
         }
      },
      "body" : "can you explain why CENT is used instead of MIN_CHANGE, please?",
      "commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "created_at" : "2017-01-06T00:52:22Z",
      "diff_hunk" : "@@ -2550,14 +2534,66 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     return false;\n                 }\n \n-                if (nFeeRet >= nFeeNeeded)\n+                if (nFeeRet >= nFeeNeeded) {\n+                    // Reduce fee to only the needed amount if we have change output to increase\n+                    // Do not do this if fee was paid by payee\n+                    if (nFeeRet > nFeeNeeded && nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                        CAmount extraFeePaid = nFeeRet - nFeeNeeded;\n+                        vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                        change_position->nValue += extraFeePaid;\n+                        nFeeRet -= extraFeePaid;\n+                    }\n                     break; // Done, enough fee included.\n+                }\n+\n+                // Try to reduce change to include necessary fee\n+                if (nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                    CAmount additionalFeeNeeded = nFeeNeeded - nFeeRet;\n+                    vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                    // Only reduce change if remaining amount is still a large enough output (CENT/2)\n+                    if (change_position->nValue >= CENT/2 + additionalFeeNeeded) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94883639",
      "id" : 94883639,
      "original_commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "original_position" : 96,
      "path" : "src/wallet/wallet.cpp",
      "position" : 96,
      "pull_request_review_id" : 15425509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404",
      "updated_at" : "2017-01-06T00:52:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94883639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94883718"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94883718"
         }
      },
      "body" : "nit: No need to mention code specific values in the comment",
      "commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "created_at" : "2017-01-06T00:53:07Z",
      "diff_hunk" : "@@ -2550,14 +2534,66 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     return false;\n                 }\n \n-                if (nFeeRet >= nFeeNeeded)\n+                if (nFeeRet >= nFeeNeeded) {\n+                    // Reduce fee to only the needed amount if we have change output to increase\n+                    // Do not do this if fee was paid by payee\n+                    if (nFeeRet > nFeeNeeded && nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                        CAmount extraFeePaid = nFeeRet - nFeeNeeded;\n+                        vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                        change_position->nValue += extraFeePaid;\n+                        nFeeRet -= extraFeePaid;\n+                    }\n                     break; // Done, enough fee included.\n+                }\n+\n+                // Try to reduce change to include necessary fee\n+                if (nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                    CAmount additionalFeeNeeded = nFeeNeeded - nFeeRet;\n+                    vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                    // Only reduce change if remaining amount is still a large enough output (CENT/2)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9404#discussion_r94883718",
      "id" : 94883718,
      "original_commit_id" : "53171a915e17e83814328cc3792554159a950757",
      "original_position" : 95,
      "path" : "src/wallet/wallet.cpp",
      "position" : 95,
      "pull_request_review_id" : 15425583,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9404",
      "updated_at" : "2017-01-06T00:53:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94883718",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=3",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
