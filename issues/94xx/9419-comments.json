[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93908872"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93908872"
         }
      },
      "body" : "Why not `IsMultiArgSet`?",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-27T08:50:04Z",
      "diff_hunk" : "@@ -238,9 +240,12 @@ bool LogAcceptCategory(const char* category)\n         static boost::thread_specific_ptr<set<string> > ptrCategory;\n         if (ptrCategory.get() == NULL)\n         {\n-            const vector<string>& categories = mapMultiArgs[\"-debug\"];\n-            ptrCategory.reset(new set<string>(categories.begin(), categories.end()));\n-            // thread_specific_ptr automatically deletes the set when the thread ends.\n+            if (mapMultiArgs.count(\"-debug\")) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93908872",
      "id" : 93908872,
      "original_commit_id" : "67bc69b159dd90105d4cf1e1bf70faf1d81366cd",
      "original_position" : 19,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 14440440,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93908872",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93908981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93908981"
         }
      },
      "body" : "Why is this not `LOCK(cs_args)`?\r\n(maybe I misinterpreted the meaning of `force`)",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-27T08:51:06Z",
      "diff_hunk" : "@@ -412,6 +428,13 @@ bool SoftSetBoolArg(const std::string& strArg, bool fValue)\n         return SoftSetArg(strArg, std::string(\"0\"));\n }\n \n+void ForceSetArg(const std::string& strArg, const std::string& strValue)\n+{\n+    mapArgs[strArg] = strValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93908981",
      "id" : 93908981,
      "original_commit_id" : "67bc69b159dd90105d4cf1e1bf70faf1d81366cd",
      "original_position" : 90,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 14440537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93908981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93928135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93928135"
         }
      },
      "body" : "Prefer less diff? (note this is really from #9243, not strictly this PR).",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-27T12:51:20Z",
      "diff_hunk" : "@@ -238,9 +240,12 @@ bool LogAcceptCategory(const char* category)\n         static boost::thread_specific_ptr<set<string> > ptrCategory;\n         if (ptrCategory.get() == NULL)\n         {\n-            const vector<string>& categories = mapMultiArgs[\"-debug\"];\n-            ptrCategory.reset(new set<string>(categories.begin(), categories.end()));\n-            // thread_specific_ptr automatically deletes the set when the thread ends.\n+            if (mapMultiArgs.count(\"-debug\")) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93928135",
      "id" : 93928135,
      "original_commit_id" : "67bc69b159dd90105d4cf1e1bf70faf1d81366cd",
      "original_position" : 19,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 14459487,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93928135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93928237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93928237"
         }
      },
      "body" : "Fixed in #9243",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-27T12:52:49Z",
      "diff_hunk" : "@@ -412,6 +428,13 @@ bool SoftSetBoolArg(const std::string& strArg, bool fValue)\n         return SoftSetArg(strArg, std::string(\"0\"));\n }\n \n+void ForceSetArg(const std::string& strArg, const std::string& strValue)\n+{\n+    mapArgs[strArg] = strValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r93928237",
      "id" : 93928237,
      "original_commit_id" : "67bc69b159dd90105d4cf1e1bf70faf1d81366cd",
      "original_position" : 90,
      "path" : "src/util.cpp",
      "position" : null,
      "pull_request_review_id" : 14459587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/93928237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Rebased after #9243 merge.",
      "created_at" : "2016-12-27T18:21:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269362967",
      "id" : 269362967,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-27T18:21:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269362967",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Wouldn't it be easier to use a shared_ptr wrapping for cleanup-after-last-use, instead of implementing refcounting yourself? You can still use a manual wrapper to lock/unlock.",
      "created_at" : "2016-12-27T18:46:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269366047",
      "id" : 269366047,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-27T18:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269366047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Hmm, I kinda prefer to not introduce shared_ptr abstractions unless they're optimizing a copy that we don't want to do. I don't think the manual refcounting is that bad.\n\nOn December 27, 2016 7:46:52 PM GMT+01:00, Pieter Wuille <notifications@github.com> wrote:\n>Wouldn't it be easier to use a shared_ptr wrapping for\n>cleanup-after-last-use, instead of implementing refcounting yourself?\n>You can still use a manual wrapper to lock/unlock.\n>\n>-- \n>You are receiving this because you authored the thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269366047\n",
      "created_at" : "2016-12-27T19:28:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269371479",
      "id" : 269371479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-27T19:28:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269371479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "OK, @sipa found a better way to use shared_ptrs here so I went ahead and did that. It means removing some asserts, but I think its worth it.",
      "created_at" : "2016-12-28T13:42:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269478578",
      "id" : 269478578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-28T13:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269478578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94071374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94071374"
         }
      },
      "body" : "The `std::move(addrMany)` here won't do what you want, as `addrName` is a const reference. You can't destroy `addrName` anyway, so just remove the `std::move`.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-28T19:57:19Z",
      "diff_hunk" : "@@ -220,15 +220,41 @@ struct CNodeState {\n     }\n };\n \n-/** Map maintaining per-node state. Requires cs_main. */\n-map<NodeId, CNodeState> mapNodeState;\n+class NodeStateStorage {\n+    /** Map maintaining per-node state. Requires cs_main. */\n+    map<NodeId, CNodeState> mapNodeState;\n+\n+public:\n+    CNodeState *GetNodeState(NodeId nodeid) {\n+        AssertLockHeld(cs_main);\n+        map<NodeId, CNodeState>::iterator it = mapNodeState.find(nodeid);\n+        if (it == mapNodeState.end())\n+            return NULL;\n+        return &it->second;\n+    }\n+\n+    void AddStateForNode(NodeId nodeid, const CAddress& addr, const std::string& addrName) {\n+        LOCK(cs_main);\n+        mapNodeState.emplace_hint(mapNodeState.end(), std::piecewise_construct, std::forward_as_tuple(nodeid), std::forward_as_tuple(addr, std::move(addrName)));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94071374",
      "id" : 94071374,
      "original_commit_id" : "1ee9f54ff16dc21bd7d4170451ec604cb9edce7e",
      "original_position" : 21,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14602012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94071374",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94073460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94073460"
         }
      },
      "body" : "You should add an `std::move` here if you want to avoid a copy.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-28T20:19:38Z",
      "diff_hunk" : "@@ -220,28 +223,65 @@ struct CNodeState {\n     }\n };\n \n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n+\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState> pstateIn) : pstate(pstateIn) { ENTER_CRITICAL_SECTION(pstate->cs); }\n+    friend class NodeStateStorage;\n+\n+public:\n+    ~CNodeStateAccessor() { if (pstate) LEAVE_CRITICAL_SECTION(pstate->cs); }\n+\n+    CNodeStateAccessor(const CNodeStateAccessor&) =delete;\n+    CNodeStateAccessor& operator= (const CNodeStateAccessor&) =delete;\n+\n+    CNodeStateAccessor(CNodeStateAccessor&& o) { pstate = o.pstate; o.pstate = NULL; }\n+\n+    bool operator()() const { return (bool)pstate; }\n+\n+    CNodeState* operator->() { return &(*pstate); }\n+    const CNodeState* operator->() const { return &(*pstate); }\n+};\n+\n class NodeStateStorage {\n     /** Map maintaining per-node state. Requires cs_main. */\n-    map<NodeId, CNodeState> mapNodeState;\n+    map<NodeId, std::shared_ptr<CNodeState> > mapNodeState;\n+    CCriticalSection cs_mapNodeState;\n \n public:\n-    CNodeState *GetNodeState(NodeId nodeid) {\n-        AssertLockHeld(cs_main);\n-        map<NodeId, CNodeState>::iterator it = mapNodeState.find(nodeid);\n-        if (it == mapNodeState.end())\n-            return NULL;\n-        return &it->second;\n+    CNodeStateAccessor GetNodeState(NodeId nodeid) {\n+        AssertLockHeld(cs_main); // TODO: Remove State reliance on cs_main\n+\n+        std::shared_ptr<CNodeState> pstate;\n+        {\n+            LOCK(cs_mapNodeState);\n+            auto it = mapNodeState.find(nodeid);\n+            if (it == mapNodeState.end())\n+                return CNodeStateAccessor();\n+            pstate = it->second;\n+        }\n+        return CNodeStateAccessor(pstate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94073460",
      "id" : 94073460,
      "original_commit_id" : "85aec47cf959060bac7666b398c7653fb0e61733",
      "original_position" : 61,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14602012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94073460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94073568"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94073568"
         }
      },
      "body" : "Add a `std::move` around `pstateIn` to avoid a copy.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-28T20:21:00Z",
      "diff_hunk" : "@@ -220,28 +223,65 @@ struct CNodeState {\n     }\n };\n \n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n+\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState> pstateIn) : pstate(pstateIn) { ENTER_CRITICAL_SECTION(pstate->cs); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94073568",
      "id" : 94073568,
      "original_commit_id" : "85aec47cf959060bac7666b398c7653fb0e61733",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14602012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94073568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Went down the rabbit hole here trying to track down a deadlock and then realized that it was already prevented. Note that (very much on purpose) cs_main is still used prior to all CNodeStateAccessors except for a few where we only call Misbehaving() or otherwise sure we are only locking one CNodeState at a time (to avoid deadlocks where we lock them in different orders).",
      "created_at" : "2016-12-29T19:46:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269683085",
      "id" : 269683085,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-29T19:46:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269683085",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Addressed @sipa's comments.",
      "created_at" : "2016-12-29T20:14:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269686838",
      "id" : 269686838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-29T20:14:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269686838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94182656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94182656"
         }
      },
      "body" : "explicit operator bool instead? Using the call operator for this seems strange.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-29T21:38:11Z",
      "diff_hunk" : "@@ -220,18 +223,68 @@ struct CNodeState {\n     }\n };\n \n-/** Map maintaining per-node state. Requires cs_main. */\n-map<NodeId, CNodeState> mapNodeState;\n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n \n-// Requires cs_main.\n-CNodeState *State(NodeId pnode) {\n-    map<NodeId, CNodeState>::iterator it = mapNodeState.find(pnode);\n-    if (it == mapNodeState.end())\n-        return NULL;\n-    return &it->second;\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }\n+    friend class NodeStateStorage;\n+\n+public:\n+    ~CNodeStateAccessor() { if (pstate) LEAVE_CRITICAL_SECTION(pstate->cs); }\n+\n+    CNodeStateAccessor(const CNodeStateAccessor&) =delete;\n+    CNodeStateAccessor& operator= (const CNodeStateAccessor&) =delete;\n+\n+    CNodeStateAccessor(CNodeStateAccessor&& o) { pstate = o.pstate; o.pstate = NULL; }\n+\n+    bool operator()() const { return (bool)pstate; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94182656",
      "id" : 94182656,
      "original_commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 14713717,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T21:38:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94182656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94182818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94182818"
         }
      },
      "body" : "Stale comment?",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-29T21:40:10Z",
      "diff_hunk" : "@@ -220,28 +223,65 @@ struct CNodeState {\n     }\n };\n \n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n+\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }\n+    friend class NodeStateStorage;\n+\n+public:\n+    ~CNodeStateAccessor() { if (pstate) LEAVE_CRITICAL_SECTION(pstate->cs); }\n+\n+    CNodeStateAccessor(const CNodeStateAccessor&) =delete;\n+    CNodeStateAccessor& operator= (const CNodeStateAccessor&) =delete;\n+\n+    CNodeStateAccessor(CNodeStateAccessor&& o) { pstate = o.pstate; o.pstate = NULL; }\n+\n+    bool operator()() const { return (bool)pstate; }\n+\n+    CNodeState* operator->() { return &(*pstate); }\n+    const CNodeState* operator->() const { return &(*pstate); }\n+};\n+\n class NodeStateStorage {\n     /** Map maintaining per-node state. Requires cs_main. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94182818",
      "id" : 94182818,
      "original_commit_id" : "4bb585ed6c9069b73b20ea1970a3967886e92938",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14713870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T21:40:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94182818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94183279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94183279"
         }
      },
      "body" : "Why not just have a lock as a member?",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-29T21:46:10Z",
      "diff_hunk" : "@@ -220,28 +223,65 @@ struct CNodeState {\n     }\n };\n \n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n+\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94183279",
      "id" : 94183279,
      "original_commit_id" : "4bb585ed6c9069b73b20ea1970a3967886e92938",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14714339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T21:46:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94183279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Wanted to make sure my nits so far were reasonable, so I went ahead and patched 'em in. Feel free to take from https://github.com/theuni/bitcoin/commit/058193e4d51bdd0cb8e7c225130414b817207ac2",
      "created_at" : "2016-12-29T22:20:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#issuecomment-269702525",
      "id" : 269702525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9419",
      "updated_at" : "2016-12-29T22:20:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269702525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94186711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186711"
         }
      },
      "body" : "I dunno I dont really like the bool operator. If you really prefer it I'm happy to change it.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-29T22:20:21Z",
      "diff_hunk" : "@@ -220,18 +223,68 @@ struct CNodeState {\n     }\n };\n \n-/** Map maintaining per-node state. Requires cs_main. */\n-map<NodeId, CNodeState> mapNodeState;\n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n \n-// Requires cs_main.\n-CNodeState *State(NodeId pnode) {\n-    map<NodeId, CNodeState>::iterator it = mapNodeState.find(pnode);\n-    if (it == mapNodeState.end())\n-        return NULL;\n-    return &it->second;\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }\n+    friend class NodeStateStorage;\n+\n+public:\n+    ~CNodeStateAccessor() { if (pstate) LEAVE_CRITICAL_SECTION(pstate->cs); }\n+\n+    CNodeStateAccessor(const CNodeStateAccessor&) =delete;\n+    CNodeStateAccessor& operator= (const CNodeStateAccessor&) =delete;\n+\n+    CNodeStateAccessor(CNodeStateAccessor&& o) { pstate = o.pstate; o.pstate = NULL; }\n+\n+    bool operator()() const { return (bool)pstate; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94186711",
      "id" : 94186711,
      "original_commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 14717639,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T22:20:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94186848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186848"
         }
      },
      "body" : "I didnt realize we had an RAII lock in sync.h that would still do DEBUG_LOCKORDER checks. Will fix with CMutexLock.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-29T22:22:16Z",
      "diff_hunk" : "@@ -220,28 +223,65 @@ struct CNodeState {\n     }\n };\n \n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n+\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94186848",
      "id" : 94186848,
      "original_commit_id" : "4bb585ed6c9069b73b20ea1970a3967886e92938",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14717780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-29T22:22:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94186848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94197671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94197671"
         }
      },
      "body" : "explicit bool matches the semantics of smart pointers, so I think it's a good fit here. But more importantly, the call operator makes it look as though something is happening to the accessor, so I'd really rather not use that.",
      "commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "created_at" : "2016-12-30T02:02:44Z",
      "diff_hunk" : "@@ -220,18 +223,68 @@ struct CNodeState {\n     }\n };\n \n-/** Map maintaining per-node state. Requires cs_main. */\n-map<NodeId, CNodeState> mapNodeState;\n+/** Provides locked access to a CNodeState */\n+class CNodeStateAccessor {\n+private:\n+    std::shared_ptr<CNodeState> pstate;\n \n-// Requires cs_main.\n-CNodeState *State(NodeId pnode) {\n-    map<NodeId, CNodeState>::iterator it = mapNodeState.find(pnode);\n-    if (it == mapNodeState.end())\n-        return NULL;\n-    return &it->second;\n+    CNodeStateAccessor() : pstate() { }\n+    CNodeStateAccessor(std::shared_ptr<CNodeState>&& pstateIn) : pstate(std::move(pstateIn)) { ENTER_CRITICAL_SECTION(pstate->cs); }\n+    friend class NodeStateStorage;\n+\n+public:\n+    ~CNodeStateAccessor() { if (pstate) LEAVE_CRITICAL_SECTION(pstate->cs); }\n+\n+    CNodeStateAccessor(const CNodeStateAccessor&) =delete;\n+    CNodeStateAccessor& operator= (const CNodeStateAccessor&) =delete;\n+\n+    CNodeStateAccessor(CNodeStateAccessor&& o) { pstate = o.pstate; o.pstate = NULL; }\n+\n+    bool operator()() const { return (bool)pstate; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9419#discussion_r94197671",
      "id" : 94197671,
      "original_commit_id" : "79c5a2124cc583de179267ffd8899631ff29f486",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : 65,
      "pull_request_review_id" : 14728724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9419",
      "updated_at" : "2016-12-30T02:02:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94197671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
