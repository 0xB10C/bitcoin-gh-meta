[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94154588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94154588"
         }
      },
      "body" : "I'm not sure if github is messing with the formatting, but this line looks unnecessarily indented.",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2016-12-29T16:37:40Z",
      "diff_hunk" : "@@ -2438,48 +2438,53 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman)\n     //  (4) checksum\n     //  (x) data\n     //\n-    bool fOk = true;\n+    bool fMoreWork = false;\n \n     if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(pfrom, chainparams.GetConsensus(), connman);\n+        ProcessGetData(pfrom, chainparams.GetConsensus(), connman, interruptMsgProc);\n \n     // this maintains the order of responses\n-    if (!pfrom->vRecvGetData.empty()) return fOk;\n+    if (!pfrom->vRecvGetData.empty()) return true;\n+\n+    if (pfrom->fDisconnect)\n+        return false;\n \n-    std::deque<CNetMessage>::iterator it = pfrom->vRecvMsg.begin();\n-    while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n         // Don't bother if send buffer is too full to respond anyway",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94154588",
      "id" : 94154588,
      "original_commit_id" : "65e916c499658e656a6e23455f22666fb0068edc",
      "original_position" : 121,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14685561,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94154588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1530283?v=3",
         "events_url" : "https://api.github.com/users/rebroad/events{/privacy}",
         "followers_url" : "https://api.github.com/users/rebroad/followers",
         "following_url" : "https://api.github.com/users/rebroad/following{/other_user}",
         "gists_url" : "https://api.github.com/users/rebroad/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/rebroad",
         "id" : 1530283,
         "login" : "rebroad",
         "organizations_url" : "https://api.github.com/users/rebroad/orgs",
         "received_events_url" : "https://api.github.com/users/rebroad/received_events",
         "repos_url" : "https://api.github.com/users/rebroad/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/rebroad/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/rebroad"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94155625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94155625"
         }
      },
      "body" : "Yes, the indentation was just kept to avoid creating a huge whitespace diff. This can be cleaned up in a move-only commit as a next step.",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2016-12-29T16:47:43Z",
      "diff_hunk" : "@@ -2438,48 +2438,53 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman)\n     //  (4) checksum\n     //  (x) data\n     //\n-    bool fOk = true;\n+    bool fMoreWork = false;\n \n     if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(pfrom, chainparams.GetConsensus(), connman);\n+        ProcessGetData(pfrom, chainparams.GetConsensus(), connman, interruptMsgProc);\n \n     // this maintains the order of responses\n-    if (!pfrom->vRecvGetData.empty()) return fOk;\n+    if (!pfrom->vRecvGetData.empty()) return true;\n+\n+    if (pfrom->fDisconnect)\n+        return false;\n \n-    std::deque<CNetMessage>::iterator it = pfrom->vRecvMsg.begin();\n-    while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n         // Don't bother if send buffer is too full to respond anyway",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94155625",
      "id" : 94155625,
      "original_commit_id" : "65e916c499658e656a6e23455f22666fb0068edc",
      "original_position" : 121,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14686611,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94155625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@sipa I've spent all day on changing this around some and breaking this up into logical commits in order to satisfy myself (and i hope others) that it's safe. I'll push up a fresh version in a few min, and drop the WIP tag.",
      "created_at" : "2016-12-31T02:09:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-269843583",
      "id" : 269843583,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2016-12-31T02:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269843583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Updated. Don't let the number of commits scare you off, the diffstat isn't too bad.\r\n\r\nI attempted to break this up into small/simple commits, in order to slowly remove the need for cs_vRecvMsg. The last commit actually removes it.\r\n\r\nI'm satisfied that this shouldn't be introducing any new races, as only a handful of vars were actually touched on the SocketHandler thread.\r\n\r\nEdit: time-ordered.",
      "created_at" : "2016-12-31T04:39:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-269849078",
      "id" : 269849078,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2016-12-31T07:04:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269849078",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94270487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94270487"
         }
      },
      "body" : "Whoops, rebase gone bad here. It ends up right in the end. Will fix.",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2016-12-31T07:39:29Z",
      "diff_hunk" : "@@ -1243,9 +1243,10 @@ void CConnman::ThreadSocketHandler()\n                             bool notify = false;\n                             if (!pnode->ReceiveMsgBytes(pchBuf, nBytes, notify))\n                                 pnode->CloseSocketDisconnect();\n+                            RecordBytesRecv(nBytes);\n                             if(notify)\n                                 condMsgProc.notify_one();\n-                            RecordBytesRecv(nBytes);\n+                            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94270487",
      "id" : 94270487,
      "original_commit_id" : "3ab40f619dd1b9f3ff4140510e807a9e1fb577c8",
      "original_position" : 8,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 14801377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94270487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94270593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94270593"
         }
      },
      "body" : "Need to clarify in the commit message: It was almost always the case that only one message was processed in this while loop. See the break at line 2538.\r\n\r\nThis commit changes the behavior so that it's _always_ one message processed per-loop. The only messages that show different behavior are the ones that used to \"continue\" the loop. I think it's perfectly reasonable to skip to the next node for processing in that case.",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2016-12-31T07:57:52Z",
      "diff_hunk" : "@@ -2439,44 +2439,44 @@ bool ProcessMessages(CNode* pfrom, CConnman& connman, std::atomic<bool>& interru\n     //  (4) checksum\n     //  (x) data\n     //\n-    bool fOk = true;\n+    bool fMoreWork = false;\n \n     if (!pfrom->vRecvGetData.empty())\n         ProcessGetData(pfrom, chainparams.GetConsensus(), connman, interruptMsgProc);\n \n     // this maintains the order of responses\n-    if (!pfrom->vRecvGetData.empty()) return fOk;\n+    if (!pfrom->vRecvGetData.empty()) return true;\n \n     auto it = pfrom->vRecvMsg.begin();\n-    while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n+    if (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94270593",
      "id" : 94270593,
      "original_commit_id" : "99599884147ea4db3f960b0e706b039ba1553c80",
      "original_position" : 16,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 14801483,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94270593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@theuni is this worth testing now?",
      "created_at" : "2017-01-03T00:18:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270035728",
      "id" : 270035728,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T00:18:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270035728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "@dcousens Very much so!",
      "created_at" : "2017-01-03T04:16:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270049933",
      "id" : 270049933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T04:16:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270049933",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94386537"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94386537"
         }
      },
      "body" : "I think you meant /, not * here?",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2017-01-03T10:48:47Z",
      "diff_hunk" : "@@ -682,18 +674,27 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n         pch += handled;\n         nBytes -= handled;\n \n-        if (msg.complete()) {\n+        if (msg.complete())\n+            complete = true;\n+    }\n+\n+    int64_t nTime = GetTimeMicros();\n+    LOCK(cs_vRecvMsg);\n+    nRecvBytes += nBytes;\n+    nLastRecv = nTime * 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94386537",
      "id" : 94386537,
      "original_commit_id" : "b1b6772240f5135745e9c0b09be2155944c12f0a",
      "original_position" : 50,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 14911886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94386537",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94386795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94386795"
         }
      },
      "body" : "It might be nice in the RPC for mapRecvBytesPerMsgCmd to add up to nRecvBytes (ie to increment this in the loop per-msg instead of after receiving (which would also mean no api change)).",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2017-01-03T10:51:06Z",
      "diff_hunk" : "@@ -682,18 +674,27 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n         pch += handled;\n         nBytes -= handled;\n \n-        if (msg.complete()) {\n+        if (msg.complete())\n+            complete = true;\n+    }\n+\n+    int64_t nTime = GetTimeMicros();\n+    LOCK(cs_vRecvMsg);\n+    nRecvBytes += nBytes;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94386795",
      "id" : 94386795,
      "original_commit_id" : "b1b6772240f5135745e9c0b09be2155944c12f0a",
      "original_position" : 49,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 14912139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94386795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "See IRC discussion:\r\n\r\n```\r\n<BlueMatt> cfields: hmmm, regarding #9441, do we really want to run the entire ProcessMessages loop (calling SendMessages potentially umpteen times) just to process multiple messages from the same node?\r\n<BlueMatt> (ie remove the loop inside ProcessMessages and move it to ThreadProcessMessages)\r\n<sipa> BlueMatt: i was wondering about that too\r\n<sipa> BlueMatt: but there is hardly any (contentious) locking going on anymore in between\r\n<BlueMatt> yea, but SendMessages.....\r\n<sipa> Ah.\r\n<sipa> i hadn't considered that\r\n<sipa> that defeats the purpose\r\n<sipa> hmm, i was about to say that it negatively impacts batching of invs and addrs\r\n<sipa> but since we have explicit random delays for those, i don't think that's really an issue anymore\r\n<BlueMatt> yea, I dont think it breaks anything\r\n<BlueMatt> just repeatedly calls SendMessages to do nothing\r\n<sipa> oh, it won't break anything\r\n```",
      "created_at" : "2017-01-03T11:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270093178",
      "id" : 270093178,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T11:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270093178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94419909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94419909"
         }
      },
      "body" : "Heh, sure did",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2017-01-03T15:11:55Z",
      "diff_hunk" : "@@ -682,18 +674,27 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n         pch += handled;\n         nBytes -= handled;\n \n-        if (msg.complete()) {\n+        if (msg.complete())\n+            complete = true;\n+    }\n+\n+    int64_t nTime = GetTimeMicros();\n+    LOCK(cs_vRecvMsg);\n+    nRecvBytes += nBytes;\n+    nLastRecv = nTime * 1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94419909",
      "id" : 94419909,
      "original_commit_id" : "b1b6772240f5135745e9c0b09be2155944c12f0a",
      "original_position" : 50,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 14946635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94419909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94420177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94420177"
         }
      },
      "body" : "Sure, that just means more locking. Though this is completely uncontested now, so that's not really a problem.",
      "commit_id" : "1c779a8cfefb45f55f0686de3fccba5285f5cd7b",
      "created_at" : "2017-01-03T15:13:30Z",
      "diff_hunk" : "@@ -682,18 +674,27 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n         pch += handled;\n         nBytes -= handled;\n \n-        if (msg.complete()) {\n+        if (msg.complete())\n+            complete = true;\n+    }\n+\n+    int64_t nTime = GetTimeMicros();\n+    LOCK(cs_vRecvMsg);\n+    nRecvBytes += nBytes;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#discussion_r94420177",
      "id" : 94420177,
      "original_commit_id" : "b1b6772240f5135745e9c0b09be2155944c12f0a",
      "original_position" : 49,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 14946908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9441",
      "updated_at" : "2017-01-04T15:16:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94420177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@TheBlueMatt If I understand you correctly, as mentioned in the summary, that's the part that was cut out here for simplicity. The next set of changes would combine the loops and move them into net_processing. See here for how it looked in a previous iteration: https://github.com/theuni/bitcoin/commit/1a6b10aea129ac363727c2d68fae809c2861e4da#diff-eff7adeaec73a769788bb78858815c91R271\r\n\r\nI'd be happy to add that here, but I'm afraid it adds a significant review burden to this PR.",
      "created_at" : "2017-01-03T15:19:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270137480",
      "id" : 270137480,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T15:19:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270137480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Also from IRC:\r\n```\r\n<BlueMatt> I assume you didnt touch cs_vSend due to https://github.com/bitcoin/bitcoin/pull/9419/commits/c214d120a363a05ba9afdccff6b4bda6e29ae7c4, cfields?\r\n<cfields> BlueMatt: yes, cs_vSend wasn't touched because of your PR. I've just been operating under the assumption that the lock around SendMessages will be removed by one PR or another.\r\n```",
      "created_at" : "2017-01-03T16:15:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270152187",
      "id" : 270152187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T16:15:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270152187",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Digging further into the IRC conversation above, I'd like to clarify that the interaction here between ProcessMessages and SendMessages is _not_ changed substantially in this PR.\r\n\r\n@TheBlueMatt had missed a subtle part of the current behavior, and maybe @sipa too, so I'd just like to explicitly point out the current break here: https://github.com/bitcoin/bitcoin/blob/master/src/net_processing.cpp#L2543, added in https://github.com/bitcoin/bitcoin/pull/3180\r\n\r\nFor the sake of processing in a round-robin fashion, we currently end up running through SendMessages multiple times while draining a node's received message queue. That behavior is _far_ from ideal, and needs to be addressed, but is not changed here*. I have plans to work on this in next steps, but not for 0.14.\r\n\r\n*It's only changed in the case of an invalid header, or bad message checksum.",
      "created_at" : "2017-01-03T18:27:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270185545",
      "id" : 270185545,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-03T18:27:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270185545",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> <BlueMatt> cfields: hmmm, regarding #9441, do we really want to run the entire ProcessMessages loop (calling SendMessages potentially umpteen times) just to process multiple messages from the same node?\r\n<BlueMatt> (ie remove the loop inside ProcessMessages and move it to ThreadProcessMessages)\r\n\r\nClearly people weren't reading PRs on this or you would have noticed that it only processes one at a time right now.  I actually fixed it to process as many as it could until it encountered lock contention, then specifically pinged people for input on the effect. After no response, I unfixed it because of concern about the latency impact.   Handling multiple messages at a time is good, if they're fast ones... \r\n\r\n",
      "created_at" : "2017-01-04T03:15:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270286007",
      "id" : 270286007,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-04T03:15:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270286007",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "I certainly noticed it only processed one message at a time. I missed that\nit calls SendMessages between each.\n",
      "created_at" : "2017-01-04T03:21:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270286554",
      "id" : 270286554,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-04T03:21:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270286554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2017-01-04T14:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270386244",
      "id" : 270386244,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-04T14:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270386244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "Rebased, and I believe I addressed all comments so far.\r\n\r\nI did a full mainnet sync last night with these (pre-rebase) changes, with no issues. I had extra logging to observe the recv pausing behavior, and verified that it's working as intended. It is paused quite frequently during IBD. Obviously that's intended, as it signals for the peer to slow down, but it may be worth discussing the consequences of a higher (or lower!) default for -maxreceivebuffer now that our recv is no longer blocked by processing. Out of scope for this PR, though.",
      "created_at" : "2017-01-04T15:25:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9441#issuecomment-270397280",
      "id" : 270397280,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9441",
      "updated_at" : "2017-01-04T15:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/270397280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
