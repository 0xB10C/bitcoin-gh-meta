[
   {
      "body" : "Most of the diff here is changing the signature of AcceptToMemoryPool trivially....",
      "created_at" : "2017-01-09T19:46:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271387601",
      "id" : 271387601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-09T19:46:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271387601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "To clarify: only rejected transactions are limited based on memory-usage (to 100KB), everything else relies on the standardness limits - 400K weight, which would be 400KB of witness data, max.",
      "created_at" : "2017-01-09T19:51:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271389008",
      "id" : 271389008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-09T19:51:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271389008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "Concept ACK. nice implementation.\r\n\r\nYou should probably consider adding an extra count \"% from memory (% hits against extra),\" to the successful reconstruction log entry.\r\n\r\nThe count limit is unfortunate, merely 100 entries but 40MB max?  you could easily keep count of the worst case memory usage (ignoring the deduplication) and then just target 4MB-- lots less memory and a higher hitrate no doubt.  Ultimately reject will need to be separately limited (too easy for a single trouble maker to blow it out, and not just an attacker: an older peer without a fee filter) somehow but this should be fine for now.",
      "created_at" : "2017-01-09T20:32:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271399263",
      "id" : 271399263,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-09T20:35:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271399263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Indeed, doing smarter limiting would be nice, but this should do for a bare-bones help-the-default-case win for 0.14 (if it turns out to do enough and the fast progress we've been making on review continues through the end of the week). If we prefer it's not really any additional review burden to do a memory-based limit across the entire list.\n\nOn January 9, 2017 3:33:01 PM EST, Gregory Maxwell <notifications@github.com> wrote:\n>Concept ACK. nice implementation.\n>\n>You should probably consider adding an extra count \"% from memory (%\n>hits against extra),\" to the successful reconstruction log entry.\n>\n>The count limit is unfortunate, merely 100 entries but 40MB max?  you\n>could easily keep count of the worst case memory usage (ignoring the\n>deduplication) and then just target 4MB-- lots less memory and a higher\n>hitrate no doubt.\n>\n>-- \n>You are receiving this because you authored the thread.\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271399263\n",
      "created_at" : "2017-01-09T21:17:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271410433",
      "id" : 271410433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-09T21:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271410433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95397606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95397606"
         }
      },
      "body" : "technically this is for rejects as well too now... maybe `vExtraTxnIt` and same for the vector below",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-10T16:12:22Z",
      "diff_hunk" : "@@ -59,6 +59,9 @@ map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(cs_main);\n map<COutPoint, set<map<uint256, COrphanTx>::iterator, IteratorComparator>> mapOrphanTransactionsByPrev GUARDED_BY(cs_main);\n void EraseOrphansFor(NodeId peer) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+static size_t vOrphanAndRecentlyRemovedTxnIt = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95397606",
      "id" : 95397606,
      "original_commit_id" : "b75d967e3cf4d4a9f315d637f32cfec9acaa03a8",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 15950601,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95397606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "It's working for me. I added logging for transactions that come from the extrapool\r\n\r\n> +    LogPrint(\"cmpctblock\", \"Successfully reconstructed block %s with %lu txn prefilled, %lu txn from memory (%lu extra hits), and %lu txn requested\\n\", hash.ToString(), prefilled_count, mempool_count, extra_count, vtx_missing.size());\r\n\r\nPlease add that, I know extra can't be counted completely precisely in the presence of collisions but it's very useful information.\r\n\r\nSome stats: \r\n\r\n$ grep essfu ~/.bitcoin/debug.log | tail -n 72  | awk '{aa=int(substr($15,2))>0; bb=$19>0; if (aa && !bb) {saved+=1} else if (!aa && !bb) {noextra+=1} else {roundtrip+=1} } END {print saved/NR \" \" noextra/NR \" \" roundtrip/NR}' \r\n0.180556 0.527778 0.291667\r\n\r\nSo the extra increased no-roundtrip from 52% to 68%... in the last 72 blocks here. Though I see there are at least a couple blocks where extra was just too small and would have been successful if it were larger, I can tell because <5 were missed and grepped the logs showed that I had previously received them.  I think thats a big enough improvement to justify doing it, but the size should be increased eventually (presumably via better memory management).",
      "created_at" : "2017-01-10T18:54:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271663359",
      "id" : 271663359,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-10T18:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271663359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "Renamed vOrphanAndRecentlyRemovedTxn -> vExtraTxnForCompact, no other changes",
      "created_at" : "2017-01-10T19:50:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271678879",
      "id" : 271678879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-10T19:50:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271678879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95461112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95461112"
         }
      },
      "body" : "A quick examination shows 80-90% of transactions not accepted to the mempool are due to rate limited free transaction.   What do you think about also adding to this check and the one below `&& state.GetRejectCode() != REJECT_INSUFFICIENTFEE`\r\n\r\nYou could be throwing away some transactions that would help blocks reconstruct, but I get close to 100 \"not accepted\" transactions an hour and it seems like I'd rather have 5 hours of non-free transactions rather than 1 hour of all.",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-10T21:28:39Z",
      "diff_hunk" : "@@ -1741,7 +1741,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n                 assert(recentRejects);\n                 recentRejects->insert(tx.GetHash());\n-            }\n+                if (RecursiveDynamicUsage(*ptx) < 100000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95461112",
      "id" : 95461112,
      "original_commit_id" : "863edb45b9841c3058e883015c7576e6f69e3cc6",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 16016728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95461112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95469266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95469266"
         }
      },
      "body" : "It might be more interesting to distinguish REJECT_INSUFFICIENTFEE from rejection because it didn't even meet the static minimum minfee.",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-10T22:10:21Z",
      "diff_hunk" : "@@ -1741,7 +1741,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n                 assert(recentRejects);\n                 recentRejects->insert(tx.GetHash());\n-            }\n+                if (RecursiveDynamicUsage(*ptx) < 100000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95469266",
      "id" : 95469266,
      "original_commit_id" : "863edb45b9841c3058e883015c7576e6f69e3cc6",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 16025138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95469266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95472161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95472161"
         }
      },
      "body" : "I was trying to avoid any complication here, but if you think something simple is worth it I'm ok with adding something.",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-10T22:26:55Z",
      "diff_hunk" : "@@ -1741,7 +1741,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n                 assert(recentRejects);\n                 recentRejects->insert(tx.GetHash());\n-            }\n+                if (RecursiveDynamicUsage(*ptx) < 100000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95472161",
      "id" : 95472161,
      "original_commit_id" : "863edb45b9841c3058e883015c7576e6f69e3cc6",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 16028079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95472161",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95472826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95472826"
         }
      },
      "body" : "Yep understood, my guess was that this was simple and a decent improvement but @gmaxwell has a point in that failed replacements could also be REJECT_INSUFFICIENTFEE and those might not be things you want to throw away.  So up to you if you can simply disambiguate.\r\n",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-10T22:30:40Z",
      "diff_hunk" : "@@ -1741,7 +1741,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n                 assert(recentRejects);\n                 recentRejects->insert(tx.GetHash());\n-            }\n+                if (RecursiveDynamicUsage(*ptx) < 100000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95472826",
      "id" : 95472826,
      "original_commit_id" : "863edb45b9841c3058e883015c7576e6f69e3cc6",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 16028794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95472826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95492635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95492635"
         }
      },
      "body" : "I propose leaving it alone for now, in the long run we'll want some kind of smarter queue. ",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-11T00:55:35Z",
      "diff_hunk" : "@@ -1741,7 +1741,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n                 assert(recentRejects);\n                 recentRejects->insert(tx.GetHash());\n-            }\n+                if (RecursiveDynamicUsage(*ptx) < 100000)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95492635",
      "id" : 95492635,
      "original_commit_id" : "863edb45b9841c3058e883015c7576e6f69e3cc6",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 16048916,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95492635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "> So the extra increased no-roundtrip from 52% to 68%... in the last 72 blocks here. \r\n\r\n[Edited: my results I posted were wrong...  recalculating.]",
      "created_at" : "2017-01-11T10:25:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271832716",
      "id" : 271832716,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-11T16:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271832716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "My last 72 blocks: 0.125 0.625 0.25  (so .62 to .75)\r\n",
      "created_at" : "2017-01-11T19:08:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271963966",
      "id" : 271963966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-11T19:08:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271963966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "body" : "(piling on) with a 1000 transaction buffer: 0.0833333 0.597222 0.319444 (~8% absolute improvement)\r\n\r\nupdate: up to 20% RTT saved now.",
      "created_at" : "2017-01-11T19:12:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-271965112",
      "id" : 271965112,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-12T14:19:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271965112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95698910"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95698910"
         }
      },
      "body" : "const? Or was this intended to remove the matches?",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-11T23:46:49Z",
      "diff_hunk" : "@@ -47,7 +47,7 @@ uint64_t CBlockHeaderAndShortTxIDs::GetShortID(const uint256& txhash) const {\n \n \n \n-ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& cmpctblock) {\n+ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& cmpctblock, std::vector<std::pair<uint256, CTransactionRef>>& extra_txn) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r95698910",
      "id" : 95698910,
      "original_commit_id" : "93380c5247526e2248248a7d539233ec48d11bdd",
      "original_position" : 5,
      "path" : "src/blockencodings.cpp",
      "position" : null,
      "pull_request_review_id" : 16263380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-12T20:20:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95698910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "1000 tx buffer I got\r\n0.19 0.65 0.16\r\n\r\nDefinitely worth merging I say..\r\n\r\nACK 863edb4 , but please also add the extra printing \r\n\r\n",
      "created_at" : "2017-01-12T01:51:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272053214",
      "id" : 272053214,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-12T01:51:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272053214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "body" : "tACK https://github.com/bitcoin/bitcoin/pull/9499/commits/863edb45b9841c3058e883015c7576e6f69e3cc6 (agree with additional printing)",
      "created_at" : "2017-01-12T19:54:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272265198",
      "id" : 272265198,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-12T19:54:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272265198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=3",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "body" : "Made the second parameter to InitData const and added the requested debug print.",
      "created_at" : "2017-01-12T20:20:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272272292",
      "id" : 272272292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-12T20:20:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272272292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r96122207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96122207"
         }
      },
      "body" : "A lot of code duplication here that would probably be better shared, but maybe not critical for 0.14.\r\n",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-14T19:06:10Z",
      "diff_hunk" : "@@ -130,6 +131,37 @@ ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& c\n         if (mempool_count == shorttxids.size())\n             break;\n     }\n+    }\n+\n+    for (size_t i = 0; i < extra_txn.size(); i++) {\n+        uint64_t shortid = cmpctblock.GetShortID(extra_txn[i].first);\n+        std::unordered_map<uint64_t, uint16_t>::iterator idit = shorttxids.find(shortid);\n+        if (idit != shorttxids.end()) {\n+            if (!have_txn[idit->second]) {\n+                txn_available[idit->second] = extra_txn[i].second;\n+                have_txn[idit->second]  = true;\n+                mempool_count++;\n+                extra_count++;\n+            } else {\n+                // If we find two mempool txn that match the short id, just request it.\n+                // This should be rare enough that the extra bandwidth doesn't matter,\n+                // but eating a round-trip due to FillBlock failure would be annoying\n+                // Note that we dont want duplication between extra_txn and mempool to\n+                // trigger this case, so we compare witness hashes first\n+                if (txn_available[idit->second] &&\n+                        txn_available[idit->second]->GetWitnessHash() != extra_txn[i].second->GetWitnessHash()) {\n+                    txn_available[idit->second].reset();\n+                    mempool_count--;\n+                    extra_count--;\n+                }\n+            }\n+        }\n+        // Though ideally we'd continue scanning for the two-txn-match-shortid case,\n+        // the performance win of an early exit here is too good to pass up and worth\n+        // the extra risk.\n+        if (mempool_count == shorttxids.size())\n+            break;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r96122207",
      "id" : 96122207,
      "original_commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "original_position" : 51,
      "path" : "src/blockencodings.cpp",
      "position" : 51,
      "pull_request_review_id" : 16700106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-14T19:06:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96122207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "body" : "I wonder if it might be better to simply cache whether transactions we discard are valid or invalid, rather than the full transaction data. Then hypothetically we can judge the entire block as valid/invalid quickly, even though we still have more data to fetch. But this idea sounds like a lot of work...",
      "created_at" : "2017-01-14T19:07:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272645662",
      "id" : 272645662,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-14T19:07:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272645662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=3",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r96123168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96123168"
         }
      },
      "body" : "Yea, I thought about it, but to avoid having two vectors I decided against it. Will fix in a follow-up pr for post-0.14.",
      "commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "created_at" : "2017-01-14T19:58:57Z",
      "diff_hunk" : "@@ -130,6 +131,37 @@ ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& c\n         if (mempool_count == shorttxids.size())\n             break;\n     }\n+    }\n+\n+    for (size_t i = 0; i < extra_txn.size(); i++) {\n+        uint64_t shortid = cmpctblock.GetShortID(extra_txn[i].first);\n+        std::unordered_map<uint64_t, uint16_t>::iterator idit = shorttxids.find(shortid);\n+        if (idit != shorttxids.end()) {\n+            if (!have_txn[idit->second]) {\n+                txn_available[idit->second] = extra_txn[i].second;\n+                have_txn[idit->second]  = true;\n+                mempool_count++;\n+                extra_count++;\n+            } else {\n+                // If we find two mempool txn that match the short id, just request it.\n+                // This should be rare enough that the extra bandwidth doesn't matter,\n+                // but eating a round-trip due to FillBlock failure would be annoying\n+                // Note that we dont want duplication between extra_txn and mempool to\n+                // trigger this case, so we compare witness hashes first\n+                if (txn_available[idit->second] &&\n+                        txn_available[idit->second]->GetWitnessHash() != extra_txn[i].second->GetWitnessHash()) {\n+                    txn_available[idit->second].reset();\n+                    mempool_count--;\n+                    extra_count--;\n+                }\n+            }\n+        }\n+        // Though ideally we'd continue scanning for the two-txn-match-shortid case,\n+        // the performance win of an early exit here is too good to pass up and worth\n+        // the extra risk.\n+        if (mempool_count == shorttxids.size())\n+            break;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#discussion_r96123168",
      "id" : 96123168,
      "original_commit_id" : "fac4c78028d132ee7becc1dc54a0c881ae1a0287",
      "original_position" : 51,
      "path" : "src/blockencodings.cpp",
      "position" : 51,
      "pull_request_review_id" : 16701073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/9499",
      "updated_at" : "2017-01-14T19:58:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/96123168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@luke-jr we tried that before...and would have broken consensus had it been shipped, so, yes, that is \"a lot of work\".",
      "created_at" : "2017-01-14T19:59:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272648994",
      "id" : 272648994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-14T19:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272648994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "ACK.",
      "created_at" : "2017-01-16T06:56:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/9499#issuecomment-272786714",
      "id" : 272786714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/9499",
      "updated_at" : "2017-01-16T06:56:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/272786714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=3",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   }
]
