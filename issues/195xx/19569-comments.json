[
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns I made a few changes compared to your branch:\r\n\r\n* The pair type is a bit richer, and in primitives/transaction.h (so that it's available from txrequest in #19184).\r\n* All of the txrequest data structures use it, not just `m_tx_process_time` - this feels more obviously correct.\r\n* The restriction that wtxidrelay peers can only announce using MSG_WTX invs remains - this isn't violated by txid-based orphan parent requests (which are get GETDATAs, not INVs).\r\n\r\nLet me know what you think.\r\n",
      "created_at" : "2020-07-23T01:04:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#issuecomment-662771502",
      "id" : 662771502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19569",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2Mjc3MTUwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T02:50:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662771502",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459247426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459247426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since you're using accessor methods anyway, could make it:\r\n\r\n```c++\r\nprivate:\r\n    const std::tuple<bool, uint256> data;\r\npublic:\r\n    friend bool operator<(const GenTxid& a, const GenTxid& b) { return a.data < b.data; }\r\n```",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T06:54:20Z",
      "diff_hunk" : "@@ -388,4 +390,17 @@ typedef std::shared_ptr<const CTransaction> CTransactionRef;\n static inline CTransactionRef MakeTransactionRef() { return std::make_shared<const CTransaction>(); }\n template <typename Tx> static inline CTransactionRef MakeTransactionRef(Tx&& txIn) { return std::make_shared<const CTransaction>(std::forward<Tx>(txIn)); }\n \n+/** A generic txid reference (txid or wtxid). */\n+class GenTxid\n+{\n+    const bool m_is_wtxid;\n+    const uint256 m_hash;\n+public:\n+    GenTxid(bool is_wtxid, const uint256& hash) : m_is_wtxid(is_wtxid), m_hash(hash) {}\n+    bool IsWtxid() const { return m_is_wtxid; }\n+    const uint256& GetHash() const { return m_hash; }\n+    friend bool operator==(const GenTxid& a, const GenTxid& b) { return a.m_is_wtxid == b.m_is_wtxid && a.m_hash == b.m_hash; }\n+    friend bool operator<(const GenTxid& a, const GenTxid& b) { return std::tie(a.m_is_wtxid, a.m_hash) < std::tie(b.m_is_wtxid, b.m_hash); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459247426",
      "id" : 459247426,
      "line" : 403,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI0NzQyNg==",
      "original_commit_id" : "f47310f0cf34c109f9fe6f2ea3d05470a47b5f0a",
      "original_line" : 403,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/primitives/transaction.h",
      "position" : 23,
      "pull_request_review_id" : 453873474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459247426",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459258317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459258317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not a super-strong opinion, but I'm wondering if we should call it `gtxid` or `gentxid` everywhere. txid used to mean something different before, and it still sort of does?",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T07:20:59Z",
      "diff_hunk" : "@@ -4519,24 +4522,24 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n \n         auto& tx_process_time = state.m_tx_download.m_tx_process_time;\n         while (!tx_process_time.empty() && tx_process_time.begin()->first <= current_time && state.m_tx_download.m_tx_in_flight.size() < MAX_PEER_TX_IN_FLIGHT) {\n-            const uint256 txid = tx_process_time.begin()->second;\n+            const GenTxid txid = tx_process_time.begin()->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459258317",
      "id" : 459258317,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1ODMxNw==",
      "original_commit_id" : "f47310f0cf34c109f9fe6f2ea3d05470a47b5f0a",
      "original_line" : 4525,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 453886838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459258317",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459263434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459263434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe this wouldn't work at the moment, because there's a check:\r\n```\r\n            if (State(pfrom.GetId())->m_wtxid_relay) {\r\n                if (inv.type == MSG_TX) continue;\r\n            } else {\r\n                if (inv.type == MSG_WTX) continue;\r\n            }\r\n```\r\n\r\nDoes it rely on some other pending PR? Is that what you referring to: \"Based on a commit by Anthony Towns.\"? ",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T07:32:33Z",
      "diff_hunk" : "@@ -2992,17 +2992,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for\n+                    // wtxidrelay peers.\n+                    // Eventually we should replace this with an improved\n+                    // protocol for getting all unconfirmed parents.\n+                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459263434",
      "id" : 459263434,
      "line" : 3005,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2MzQzNA==",
      "original_commit_id" : "54a09366a43bfa890651951a624240e2899632e0",
      "original_line" : 3005,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 453886838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459263434",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459264128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459264128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or maybe it's just missing a commit to remove this check, I don't know :)",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T07:34:03Z",
      "diff_hunk" : "@@ -2992,17 +2992,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for\n+                    // wtxidrelay peers.\n+                    // Eventually we should replace this with an improved\n+                    // protocol for getting all unconfirmed parents.\n+                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459264128",
      "id" : 459264128,
      "in_reply_to_id" : 459263434,
      "line" : 3005,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDEyOA==",
      "original_commit_id" : "54a09366a43bfa890651951a624240e2899632e0",
      "original_line" : 3005,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 453886838,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459264128",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459264161"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459264161"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could have a `GenTxid::ToString` which specifies whether the hash is a wtxid or a regular txid",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T07:34:09Z",
      "diff_hunk" : "@@ -4505,7 +4506,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         if (state.m_tx_download.m_check_expiry_timer <= current_time) {\n             for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n                 if (it->second <= current_time - TX_EXPIRY_INTERVAL) {\n-                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.ToString(), pto->GetId());\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.GetHash().ToString(), pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459264161",
      "id" : 459264161,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDE2MQ==",
      "original_commit_id" : "154778d1e4f053145979e9faf5178d0ece84370a",
      "original_line" : 4509,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 453873474,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459264161",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459268599"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459268599"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is in INV handling. When requesting parents of an orphan, there is no INV involved: a GETDATA is sent directly in response to receiving the TX.\n\nAm I missing something why changing this is needed?",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T07:44:02Z",
      "diff_hunk" : "@@ -2992,17 +2992,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for\n+                    // wtxidrelay peers.\n+                    // Eventually we should replace this with an improved\n+                    // protocol for getting all unconfirmed parents.\n+                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459268599",
      "id" : 459268599,
      "in_reply_to_id" : 459263434,
      "line" : 3005,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2ODU5OQ==",
      "original_commit_id" : "54a09366a43bfa890651951a624240e2899632e0",
      "original_line" : 3005,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 453899770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459268599",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459278883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459278883"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This works as-is for me both live against a mainnet wtxid relay peer, and via the modified test.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T08:04:57Z",
      "diff_hunk" : "@@ -2992,17 +2992,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for\n+                    // wtxidrelay peers.\n+                    // Eventually we should replace this with an improved\n+                    // protocol for getting all unconfirmed parents.\n+                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459278883",
      "id" : 459278883,
      "in_reply_to_id" : 459263434,
      "line" : 3005,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI3ODg4Mw==",
      "original_commit_id" : "54a09366a43bfa890651951a624240e2899632e0",
      "original_line" : 3005,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 453912588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459278883",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459318734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459318734"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You are right, I was confused by INV/GETDATA. Feel free to mark as resolved :)",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T09:18:39Z",
      "diff_hunk" : "@@ -2992,17 +2992,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for\n+                    // wtxidrelay peers.\n+                    // Eventually we should replace this with an improved\n+                    // protocol for getting all unconfirmed parents.\n+                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459318734",
      "id" : 459318734,
      "in_reply_to_id" : 459263434,
      "line" : 3005,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxODczNA==",
      "original_commit_id" : "54a09366a43bfa890651951a624240e2899632e0",
      "original_line" : 3005,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 157,
      "pull_request_review_id" : 453962076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459318734",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 154778d",
      "created_at" : "2020-07-23T09:19:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#issuecomment-662904927",
      "id" : 662904927,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19569",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjkwNDkyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T09:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662904927",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459354787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459354787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f8e8a44d suggestion for \"support... is supported\" here if you retouch\r\n```suggestion\r\n* [`BIP 339`](https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki): Announcing and fetching transactions by wtxid is supported as of **v0.21.0** ([PR 18044](https://github.com/bitcoin/bitcoin/pull/18044)).\r\n```\r\nor just \"Relaying...\"",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T10:28:33Z",
      "diff_hunk" : "@@ -42,3 +42,4 @@ BIPs that are implemented by Bitcoin Core (up-to-date up to **v0.19.0**):\n * [`BIP 173`](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki): Bech32 addresses for native Segregated Witness outputs are supported as of **v0.16.0** ([PR 11167](https://github.com/bitcoin/bitcoin/pull/11167)). Bech32 addresses are generated by default as of **v0.20.0** ([PR 16884](https://github.com/bitcoin/bitcoin/pull/16884)).\n * [`BIP 174`](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of **v0.17.0** ([PR 13557](https://github.com/bitcoin/bitcoin/pull/13557)).\n * [`BIP 176`](https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki): Bits Denomination [QT only] is supported as of **v0.16.0** ([PR 12035](https://github.com/bitcoin/bitcoin/pull/12035)).\n+* [`BIP 339`](https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki): Support for announcing and fetching transactions by wtxid is supported as of **v0.21.0** ([PR 18044](https://github.com/bitcoin/bitcoin/pull/18044)).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459354787",
      "id" : 459354787,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM1NDc4Nw==",
      "original_commit_id" : "154778d1e4f053145979e9faf5178d0ece84370a",
      "original_line" : 45,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "doc/bips.md",
      "position" : null,
      "pull_request_review_id" : 454007713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459354787",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459767301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459767301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe personal preference, but I don't think slightly easier comparators weighs up against losing meaningful names for the member variables.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T22:40:18Z",
      "diff_hunk" : "@@ -388,4 +390,17 @@ typedef std::shared_ptr<const CTransaction> CTransactionRef;\n static inline CTransactionRef MakeTransactionRef() { return std::make_shared<const CTransaction>(); }\n template <typename Tx> static inline CTransactionRef MakeTransactionRef(Tx&& txIn) { return std::make_shared<const CTransaction>(std::forward<Tx>(txIn)); }\n \n+/** A generic txid reference (txid or wtxid). */\n+class GenTxid\n+{\n+    const bool m_is_wtxid;\n+    const uint256 m_hash;\n+public:\n+    GenTxid(bool is_wtxid, const uint256& hash) : m_is_wtxid(is_wtxid), m_hash(hash) {}\n+    bool IsWtxid() const { return m_is_wtxid; }\n+    const uint256& GetHash() const { return m_hash; }\n+    friend bool operator==(const GenTxid& a, const GenTxid& b) { return a.m_is_wtxid == b.m_is_wtxid && a.m_hash == b.m_hash; }\n+    friend bool operator<(const GenTxid& a, const GenTxid& b) { return std::tie(a.m_is_wtxid, a.m_hash) < std::tie(b.m_is_wtxid, b.m_hash); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459767301",
      "id" : 459767301,
      "in_reply_to_id" : 459247426,
      "line" : 403,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2NzMwMQ==",
      "original_commit_id" : "f47310f0cf34c109f9fe6f2ea3d05470a47b5f0a",
      "original_line" : 403,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/primitives/transaction.h",
      "position" : 23,
      "pull_request_review_id" : 454542608,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459767301",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784201"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems reasonable; done. I've changed all `GenTxid` variables in net_processing to be `gtxid`.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T23:33:54Z",
      "diff_hunk" : "@@ -4519,24 +4522,24 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n \n         auto& tx_process_time = state.m_tx_download.m_tx_process_time;\n         while (!tx_process_time.empty() && tx_process_time.begin()->first <= current_time && state.m_tx_download.m_tx_in_flight.size() < MAX_PEER_TX_IN_FLIGHT) {\n-            const uint256 txid = tx_process_time.begin()->second;\n+            const GenTxid txid = tx_process_time.begin()->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784201",
      "id" : 459784201,
      "in_reply_to_id" : 459258317,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4NDIwMQ==",
      "original_commit_id" : "f47310f0cf34c109f9fe6f2ea3d05470a47b5f0a",
      "original_line" : 4525,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 454561890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784201",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T23:34:05Z",
      "diff_hunk" : "@@ -4505,7 +4506,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         if (state.m_tx_download.m_check_expiry_timer <= current_time) {\n             for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n                 if (it->second <= current_time - TX_EXPIRY_INTERVAL) {\n-                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.ToString(), pto->GetId());\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.GetHash().ToString(), pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784256",
      "id" : 459784256,
      "in_reply_to_id" : 459264161,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4NDI1Ng==",
      "original_commit_id" : "154778d1e4f053145979e9faf5178d0ece84370a",
      "original_line" : 4509,
      "original_position" : 144,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 454561955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784256",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-23T23:35:20Z",
      "diff_hunk" : "@@ -42,3 +42,4 @@ BIPs that are implemented by Bitcoin Core (up-to-date up to **v0.19.0**):\n * [`BIP 173`](https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki): Bech32 addresses for native Segregated Witness outputs are supported as of **v0.16.0** ([PR 11167](https://github.com/bitcoin/bitcoin/pull/11167)). Bech32 addresses are generated by default as of **v0.20.0** ([PR 16884](https://github.com/bitcoin/bitcoin/pull/16884)).\n * [`BIP 174`](https://github.com/bitcoin/bips/blob/master/bip-0174.mediawiki): RPCs to operate on Partially Signed Bitcoin Transactions (PSBT) are present as of **v0.17.0** ([PR 13557](https://github.com/bitcoin/bitcoin/pull/13557)).\n * [`BIP 176`](https://github.com/bitcoin/bips/blob/master/bip-0176.mediawiki): Bits Denomination [QT only] is supported as of **v0.16.0** ([PR 12035](https://github.com/bitcoin/bitcoin/pull/12035)).\n+* [`BIP 339`](https://github.com/bitcoin/bips/blob/master/bip-0339.mediawiki): Support for announcing and fetching transactions by wtxid is supported as of **v0.21.0** ([PR 18044](https://github.com/bitcoin/bitcoin/pull/18044)).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r459784642",
      "id" : 459784642,
      "in_reply_to_id" : 459354787,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4NDY0Mg==",
      "original_commit_id" : "154778d1e4f053145979e9faf5178d0ece84370a",
      "original_line" : 45,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "doc/bips.md",
      "position" : null,
      "pull_request_review_id" : 454562360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T23:35:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/459784642",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 338f80e per `git range-diff 007e15dc 154778d 338f80e` and re-code review. Re-debug build with Clang 12, ran tests and node.",
      "created_at" : "2020-07-24T08:08:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#issuecomment-663400625",
      "id" : 663400625,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19569",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MzQwMDYyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-24T08:08:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/663400625",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460046862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460046862"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this a slight behavior change ?\r\n\r\nBy erasing both wtxid/txid from `g_already_asked_for`, if we receive a wtxid from a wtixd-relay peer and at same time gets an announcement for the same tx from few txid-relay only peers, when we monitor our getdatas in `SendMessages`, we would send a spurious GETDATA for the first-processed txid-relay peer as `last_request_time` is null.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-24T13:19:33Z",
      "diff_hunk" : "@@ -2936,9 +2936,11 @@ void ProcessMessage(\n \n         TxValidationState state;\n \n-        nodestate->m_tx_download.m_tx_announced.erase(hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n-        EraseTxRequest(hash);\n+        for (auto gtxid : {GenTxid{false, txid}, GenTxid{true, wtxid}}) {\n+            nodestate->m_tx_download.m_tx_announced.erase(gtxid);\n+            nodestate->m_tx_download.m_tx_in_flight.erase(gtxid);\n+            EraseTxRequest(gtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460046862",
      "id" : 460046862,
      "line" : 2944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA0Njg2Mg==",
      "original_commit_id" : "378a8bd641fa608c0c911d9f473dbc27cc79ee8c",
      "original_line" : 2942,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 129,
      "pull_request_review_id" : 454878872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T13:38:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460046862",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460056991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460056991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Strictly interpreting the BIP, the requirement for wtxid-relay on fetching is scoped to \"announced transactions from that peer\", and orphan parents have not been announced so we don't violate wtxid-relay policy here. Concern is on future BIP implementers on how they interpret \"is required\" and severing the connection for violations. Lightweight clients broadcasting a parent + CPFP tx may know issues due to this.\r\n\r\nIn the meanwhile, I share Suhas [point](https://github.com/bitcoin/bitcoin/pull/18044#discussion_r388444497) to not commit a given handling of this behavior. Maybe we should amend the BIP to invite liberal enforcement of violations, just dropping non-complying invs/getdatas ?",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-24T13:37:50Z",
      "diff_hunk" : "@@ -2992,17 +2994,15 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                if (!State(pfrom.GetId())->m_wtxid_relay) {\n-                    for (const CTxIn& txin : tx.vin) {\n-                        // Here, we only have the txid (and not wtxid) of the\n-                        // inputs, so we only request parents from\n-                        // non-wtxid-relay peers.\n-                        // Eventually we should replace this with an improved\n-                        // protocol for getting all unconfirmed parents.\n-                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom.AddKnownTx(txin.prevout.hash);\n-                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n-                    }\n+                for (const CTxIn& txin : tx.vin) {\n+                    // Here, we only have the txid (and not wtxid) of the\n+                    // inputs, so we only request in txid mode, even for",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460056991",
      "id" : 460056991,
      "line" : 2999,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA1Njk5MQ==",
      "original_commit_id" : "b5ef3470bd7cf5a51e3e1b14380a23f652145126",
      "original_line" : 2999,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 151,
      "pull_request_review_id" : 454878872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T13:38:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460056991",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460188618"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460188618"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ariard After a tx arrives successfully, it should be AlreadyHave, and new INVs for it (of whatever type) should be ignored.",
      "commit_id" : "338f80e8fcd63b1d97f3ff0c4d3aede18b55cdc2",
      "created_at" : "2020-07-24T17:24:07Z",
      "diff_hunk" : "@@ -2936,9 +2936,11 @@ void ProcessMessage(\n \n         TxValidationState state;\n \n-        nodestate->m_tx_download.m_tx_announced.erase(hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n-        EraseTxRequest(hash);\n+        for (auto gtxid : {GenTxid{false, txid}, GenTxid{true, wtxid}}) {\n+            nodestate->m_tx_download.m_tx_announced.erase(gtxid);\n+            nodestate->m_tx_download.m_tx_in_flight.erase(gtxid);\n+            EraseTxRequest(gtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19569#discussion_r460188618",
      "id" : 460188618,
      "in_reply_to_id" : 460046862,
      "line" : 2944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4ODYxOA==",
      "original_commit_id" : "378a8bd641fa608c0c911d9f473dbc27cc79ee8c",
      "original_line" : 2942,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 129,
      "pull_request_review_id" : 455060287,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19569",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-24T17:24:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460188618",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
