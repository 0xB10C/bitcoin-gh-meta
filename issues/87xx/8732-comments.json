[
   {
      "body" : "I've consolidated the important info from the original issue here.\r\nAll from @laanwj \r\n\r\n--------\r\nTo see if I could reproduce I did this:\r\n\r\n- Create a brand-new Ubuntu Xenial (16.04) VM, from today's (2015-09-14) cloud image \r\n- Install the necessary dependencies, and build requirements from these documents:\r\n```\r\nsudo apt-get install g++-mingw-w64-i686 mingw-w64-i686-dev g++-mingw-w64-x86-64 mingw-w64-x86-64-dev curl\r\nsudo apt-get install build-essential libtool autotools-dev automake pkg-config libssl-dev libevent-dev bsdmainutils\r\n```\r\nWhile doing this I indeed saw some logging output about gcc alternatives: I wonder which one was selected by default. Apparently the -win32 variant, not the POSIX one.\r\n\r\n- Follow the instructions for building for windows 64-bit:\r\n```\r\n    cd depends\r\n    make HOST=x86_64-w64-mingw32 -j4\r\n    cd ..\r\n    ./autogen.sh\r\n    ./configure --prefix=`pwd`/depends/x86_64-w64-mingw32\r\n    make\r\n```\r\n- It fails with the following error, the same error that you get:\r\n```\r\n/usr/lib/gcc/x86_64-w64-mingw32/5.3-win32/include/c++/bits/unique_ptr.h:49:28: note: declared here\r\n   template<typename> class auto_ptr;\r\n                            ^\r\nhttpserver.cpp:69:10: error: Ã¢ÂÂmutexÃ¢ÂÂ in namespace Ã¢ÂÂstdÃ¢ÂÂ does not name a type\r\n     std::mutex cs;\r\n          ^\r\nhttpserver.cpp:70:10: error: Ã¢ÂÂcondition_variableÃ¢ÂÂ in namespace Ã¢ÂÂstdÃ¢ÂÂ does not name a type\r\n     std::condition_variable cond;\r\n```\r\n- I changed the alternatives to -posix under  `sudo update-alternatives --config ...` as suggested in this patch.\r\n- Cleaned and re-built bitcoin (but not the dependencies - maybe I should), and this time it passed.\r\n- Status (Windows 10):\r\n```\r\nbitcoin-test.exe: crashes on start\r\nbitcoin-qt.exe: crashes on start\r\nbitcoind.exe: seems to work, but throws bad_cast on exit\r\nbitcoin-cli.exe: seems to work, but cannot connect to server?\r\nbitcoin-tx.exe: seems to work\r\n```\r\n- Going to clean and re-build the dependencies, as well as bitcoin entirely *with the -posix compiler*.\r\n\r\n- This didn't change anything, still same status as above.\r\n\r\n-----\r\nOK I've done some research. In principle, `std::mutex` is supported in the -win32 compiler variant (which we've always used, and are using in Trusty). No POSIX emulation layer is needed for c++11 threads. However the problem with `<mutex>` and friends on newer Ubuntu's mingw-w64 seems to be the following:\r\n\r\n- Firstly, there is a `/usr/lib/gcc/x86_64-w64-mingw32/5.3-win32/include/c++/mutex`. However the definition of the actual class is guarded by `_GLIBCXX_HAS_GTHREADS`.\r\n- However it requires building glibcxx with a certain library (not to be confused with GLIB's \"libgthread\"):\r\n    - `_GLIBCXX_HAS_GTHREADS` is supposed to be defined in `/usr/lib/gcc/x86_64-w64-mingw32/5.3-win32/include/c++/x86_64-w64-mingw32/bits/c++config.h` when this has been done\r\n\r\nThis is an Ubuntu-specific problem: the \"gthreads\" (GCC threads) library is not linked into libcxx.\r\n\r\nOn Trusty this is not an issue as gthreads is provided:\r\n- `/usr/include/c++/4.8/x86_64-w64-mingw32/bits/c++config.h` defines `_GLIBCXX_HAS_GTHREADS`.\r\n\r\nThere is a https://github.com/meganz/mingw-std-threads which some people use to work around this problem. But in principle I think Ubuntu should solve this upstream.\r\n\r\n-----\r\nI have verified that after reverting the C++11 threads changes (https://github.com/laanwj/bitcoin/tree/2016_09_windows_hell), it builds normally with the default -win32 compiler. ~~`bitcoin-qt` then works, without having to disable hardening.~~\r\nFalse positive: I was building without wallet, with the wallet it still crashes. What a shit.\r\n\r\nHowever:\r\n- bitcoin-test.exe: crashes on start\r\n- bitcoin-qt.exe: crashes on start\r\n- bitcoind.exe: seems to work\r\n- bitcoin-cli.exe: seems to work, but cannot connect to server?\r\n- bitcoin-tx.exe: seems to work\r\n\r\n> The issue with bitcoin-cli looks like https://sourceforge.net/p/levent/bugs/363/ which is linked to mingw (but not its POSIX mode specifically)\r\n\r\nThis issue doesn't go away either, unfortunately.\r\n\r\n----\r\nLooks like `-fstack-protector-all` is the specific hardening flag that exposes problems. Apparently it affects use of BerkeleyDB and boost::test. The tests pass (at least in wine) without `--stack-protector-all`. It also makes Bitcoin-Qt with wallet start again. \r\n\r\nSo apparently there are three, at most tangentially related issues regarding Windows:\r\n\r\n- The `std::mutex` `std::condition_variable` etc problem on Ubuntu 15.10+. Can apparently be solved by enabling POSIX compatibility, or by using something like https://github.com/meganz/mingw-std-threads.\r\n\r\n- `-fstack-protector-all` issue (`-fstack-protector` doesn't have this problem, neither do the other hardening flags like nxcompat) - causes the tests to crash at startup (before even getting to our code in BasicTestingSetup!), as well as bitcoin-qt to crash at startup *if the wallet is enabled*.\r\n\r\n- libevent 'zu' header issue - causes bitcoin-cli and bitcoind to be unable to connect over RPC (which as mentioned by @sstone, looks like https://sourceforge.net/p/levent/bugs/363/) (fixed in #8730)\r\n\r\nI wonder when each of these issues started. My only recommendation for now is: **use an Ubuntu Trusty VM for windows cross-compilation**\r\n",
      "created_at" : "2016-10-08T09:10:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/8732#issuecomment-252413423",
      "id" : 252413423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8732",
      "updated_at" : "2016-10-08T09:10:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/252413423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=3",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
