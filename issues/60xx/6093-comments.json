[
   {
      "body" : "Good catch. I already fixed this once before, people really shouldn't be touching this 'magic' code. Maybe add a comment referring to the issue.",
      "created_at" : "2015-05-01T12:15:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98120925",
      "id" : 98120925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T12:15:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98120925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "This will likely bring back issue #3136 (solved by #5877). You should imbue *some* locale on WIN32, I'm not sure which one, but indeed `C` is wrong.\r\nMaybe the result of `std::locale(\"\")`? what does boost lazily initialize it to?",
      "created_at" : "2015-05-01T12:21:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98122033",
      "id" : 98122033,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T12:28:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98122033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Right. This is not the right approach.\r\nWas trying to go down the rabbit hole of win/unicode handling...\r\nCan't find a solution. It seems that it could also be a compiler wchar issue.\r\nIt looks like that the default locale is `C`?\r\n\r\nI could also guess that it might be connected to https://github.com/bitcoin/bitcoin/blob/master/src/util.cpp#L672 `SHGetSpecialFolderPathA`. The A stands for ANSI. There is also a SHGetSpecialFolderPathW equivalent which supports WCHAR.",
      "created_at" : "2015-05-01T13:03:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98128744",
      "id" : 98128744,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98128744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "In windows the file system locale depends on the user locale. I think it only works if boost uses the same locale as windows. But I'm not sure anymore how this was determined. I got it to work once, hence it worked in 0.10...\r\n(using the W* functions is out of the question unless you use them *everywhere* and that'd involve a lot of platform specific code as well as widechar to UTF-8 conversion)\r\n",
      "created_at" : "2015-05-01T13:48:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98138377",
      "id" : 98138377,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:48:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98138377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@jonasschnelli: using the \"C\" locale to imbue `boost::filesystem::path` indeed triggers the failure on Windows in this context.\r\n\r\nThere is more than one problem tackled by `SetupEnvironment()`:\r\n\r\n1. On POSIX systems, messed up environment settings can cause a failure ([Python test](https://gist.github.com/dexX7/ab3f7411a9040e96d55c)).\r\n2. During the deinitialization, an internal facet pointer of `boost::path` is deleted, and if `boost::path` was not initialized by the main thread, it causes failures such as #3136 (and related).\r\n\r\nThe current situation:\r\n\r\n1. As default, the \"C\" locale is used.\r\n2. On POSIX systems, the environment locale is used (via `std::locale(\"\")`).\r\n3. On POSIX systems, to detect bad environment settings, an exception thrown by `std::locale(\"\")` is caught.\r\n4. On POSIX systems, and if there are bad environment settings, the \"C\" locale is used as fallback.\r\n5. As workaround, to explicitly force the initialization of the internal facet pointer by the main thread, `boost::filesystem::path::imbue()` is called.\r\n6. Bad initialization of `boost::filesystem::boost::path` can result in exceptions, which are currently not caught.\r\n7. On Windows systems, the \"C\" locale appearingly does not cover the whole character set, which can result in (6), as shown by #6078.\r\n\r\nIn practise, the current 0.10.1 can result in a failure on Russian (and other) Windows, and earlier versions are affected by the deinitialization issue, resulting in faulty Boost test executions, as well as other failures during the shutdown, such as the crash reported in the context of rebuilding the block database.",
      "created_at" : "2015-05-01T13:54:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98139231",
      "id" : 98139231,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T13:54:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98139231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "Arguably the new problem is worse, as it prevents people from running the client at all with some characters in their data directories, instead of a rare shutdown race. What about:\r\n```c++\r\n    std::locale loc(\"C\");\r\n    // On most POSIX systems (e.g. Linux, but not BSD) the environment's locale\r\n    // may be invalid, in which case the \"C\" locale is used as fallback.\r\n    try {\r\n        loc = std::locale(\"\"); // Raises a runtime error if current locale is invalid\r\n    } catch (const std::runtime_error&) {\r\n#if !defined(WIN32) && !defined(MAC_OSX) && !defined(__FreeBSD__) && !defined(__OpenBSD__)\r\n        setenv(\"LC_ALL\", \"C\", 1);\r\n#endif\r\n    }\r\n    // The path locale is lazy initialized and to avoid deinitialization errors \r\n    // in multithreading environments, it is set explicitly by the main thread.\r\n    boost::filesystem::path::imbue(loc);\r\n```\r\nThis would imbue the system locale on all platforms and should avoid the race condition, as well as the data directory problems. Needs to be tested though..\r\n",
      "created_at" : "2015-05-01T15:47:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98162584",
      "id" : 98162584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T15:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98162584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "@laanwj i tried you proposed code and it does not fix the problem. Maybe it would be worth to revert #5877 and find a proper solution.\r\n\r\nWhat really surprises me: At least since 0.9.2 (didn't try further down), bitcoind and Bitcoin-Qt does not run with a datadir-path containing special Chinese or other Asian chars (Windows only).",
      "created_at" : "2015-05-01T16:33:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98173470",
      "id" : 98173470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6093",
      "updated_at" : "2015-05-01T16:33:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/98173470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   }
]
