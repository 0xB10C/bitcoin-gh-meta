[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\n\r\nsrc/wallet/walletdb.cpp:616:58: error: passing result of std::move() as a const reference argument; no move will actually happen [performance-move-const-arg,-warnings-as-errors]\r\n                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-08T10:47:12Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data = pwallet->m_address_book[DecodeDestination(strAddress)];\n+            if (strKey.compare(\"used\") == 0) {\n+                data.SetUsed(true);\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725",
      "id" : 1129250725,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585DTv-l",
      "original_commit_id" : "2a44c4e0c7a20a1e1964ecb25fe148759fbb0e2f",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1330392187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-08T10:47:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129950744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725\r\n\r\nThanks, fixed now",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-08T19:49:38Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data = pwallet->m_address_book[DecodeDestination(strAddress)];\n+            if (strKey.compare(\"used\") == 0) {\n+                data.SetUsed(true);\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129950744",
      "id" : 1129950744,
      "in_reply_to_id" : 1129250725,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585DWa4Y",
      "original_commit_id" : "2a44c4e0c7a20a1e1964ecb25fe148759fbb0e2f",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1331334304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-08T20:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137453458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I strongly dislike using the empty string to indicate deletion. I think it would be better to have a separate `RemoveReceiveRequest`.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T17:00:23Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137453458",
      "id" : 1137453458,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585DzCmS",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 26,
      "pull_request_review_id" : 1341984808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T17:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not convinced that this needs to be a map. Receive requests are only created by the GUI, and the GUI only creates them for a newly retrieved address, so it shouldn't be possible to have multiple receive requests.\r\n\r\nAdditionally, receive requests are identified by an int which is being (un)stringified. This could just be an int to avoid that constant conversion in the GUI.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T17:03:42Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690",
      "id" : 1137458690,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII585DzD4C",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 6,
      "pull_request_review_id" : 1341984808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T17:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274\r\n\r\n> I strongly dislike using the empty string to indicate deletion. I think it would be better to have a separate `RemoveReceiveRequest`.\r\n\r\nYou are right. This is shitty and I will add a separate method to avoid continuing this pattern.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T19:23:29Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274",
      "id" : 1137647274,
      "in_reply_to_id" : 1137453458,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585Dzx6q",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 26,
      "pull_request_review_id" : 1342243492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T19:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137679417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690\r\n\r\n> I'm not convinced that this needs to be a map. Receive requests are only created by the GUI, and the GUI only creates them for a newly retrieved address, so it shouldn't be possible to have multiple receive requests.\r\n> \r\n> Additionally, receive requests are identified by an int which is being (un)stringified. This could just be an int to avoid that constant conversion in the GUI.\r\n\r\nYou could definitely be right about these things, but I need to look into GUI code more to have an opinion. This PR avoids changing any GUI code, and keeps the behavior of `interfaces::Wallet` methods the same as before from the perspective of the GUI.\r\n\r\nIf the definitions or behavior of `interfaces::Wallet` methods should change as you say, I think it would make sense to implement these changes as a separate PR, because making those changes here would not really simplify much (would basically replace `string` with `int` and `find()` with `has_value()`), and would require understanding GUI code to review, unlike the current changes.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T19:35:22Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137679417",
      "id" : 1137679417,
      "in_reply_to_id" : 1137458690,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII585Dz5w5",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 6,
      "pull_request_review_id" : 1342293430,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T19:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142438454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: [#27224 (comment)](https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690)\r\n\r\nInstead of extending the PR to modify GUI code, I've kept changes here internal to the wallet and added a note in `setAddressReceiveRequest` about the wallet/gui interface and say how it could be improved in the future.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-20T17:02:16Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142438454",
      "id" : 1142438454,
      "in_reply_to_id" : 1137458690,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EGDo2",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1349037350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-20T17:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142496680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> re: [#27224 (comment)](https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274)\r\n\r\nThis is done now",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-20T17:52:56Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142496680",
      "id" : 1142496680,
      "in_reply_to_id" : 1137453458,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EGR2o",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1349037350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-20T17:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This line was really confusing for me at first. Perhaps something like this could make it more clear?\r\n\r\n```suggestion\r\n    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value{};\r\n```\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-27T11:48:07Z",
      "diff_hunk" : "@@ -808,6 +810,22 @@ bool BerkeleyBatch::HasKey(DataStream&& key)\n     return ret == 0;\n }\n \n+bool BerkeleyBatch::ErasePrefix(Span<std::byte> prefix)\n+{\n+    if (!TxnBegin()) return false;\n+    auto cursor = std::make_unique<BerkeleyCursor>(m_database, this);\n+    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825",
      "id" : 1149193825,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ef05h",
      "original_commit_id" : "fe367f2e4e5fb95546fa26491d43346e0bc11adb",
      "original_line" : 817,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1358939669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-27T11:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149661885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825\r\n\r\nThanks, switched to brace initialization like you suggested in many places now. Should be clearer and safer\r\n\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-27T18:43:41Z",
      "diff_hunk" : "@@ -808,6 +810,22 @@ bool BerkeleyBatch::HasKey(DataStream&& key)\n     return ret == 0;\n }\n \n+bool BerkeleyBatch::ErasePrefix(Span<std::byte> prefix)\n+{\n+    if (!TxnBegin()) return false;\n+    auto cursor = std::make_unique<BerkeleyCursor>(m_database, this);\n+    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149661885",
      "id" : 1149661885,
      "in_reply_to_id" : 1149193825,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EhnK9",
      "original_commit_id" : "fe367f2e4e5fb95546fa26491d43346e0bc11adb",
      "original_line" : 817,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1359680913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-27T19:02:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150232826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps there's some nuance that I'm missing, but it seems strange to have this be `Span<std::byte>` when the rest of the methods take `DataStream&&`. I changed the `ErasePrefix` method to instead take `DataStream&&` as an argument and was able to compile and pass the unit and functional tests. Seems like it would be preferable to match the other methods unless you have a reason to prefer `Span<std::byte>`?",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T08:37:40Z",
      "diff_hunk" : "@@ -205,6 +206,7 @@ class BerkeleyBatch : public DatabaseBatch\n     bool WriteKey(DataStream&& key, DataStream&& value, bool overwrite = true) override;\n     bool EraseKey(DataStream&& key) override;\n     bool HasKey(DataStream&& key) override;\n+    bool ErasePrefix(Span<std::byte> prefix) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150232826",
      "id" : 1150232826,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585Ejyj6",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : 17,
      "pull_request_review_id" : 1360512338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T08:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150238393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "as part of changing `ErasePrefix` to accept a `DataStream&&`, I also changed this line:\r\n\r\n```suggestion\r\n    return m_batch->ErasePrefix(DataStream(prefix));\r\n```\r\n\r\nto make this an `rvalue`. there is likely a cleaner way to do this, if you end up going with `DataStream`",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T08:41:52Z",
      "diff_hunk" : "@@ -1082,16 +1087,28 @@ void MaybeCompactWalletDB(WalletContext& context)\n     fOneThread = false;\n }\n \n-bool WalletBatch::WriteDestData(const std::string &address, const std::string &key, const std::string &value)\n+bool WalletBatch::WriteAddressPreviouslySpent(const CTxDestination& dest, bool previously_spent)\n+{\n+    auto key{std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), std::string(\"used\")))};\n+    return previously_spent ? WriteIC(key, std::string(\"1\")) : EraseIC(key);\n+}\n+\n+bool WalletBatch::WriteAddressReceiveRequest(const CTxDestination& dest, const std::string& id, const std::string& receive_request)\n {\n-    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)), value);\n+    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)), receive_request);\n }\n \n-bool WalletBatch::EraseDestData(const std::string &address, const std::string &key)\n+bool WalletBatch::EraseAddressReceiveRequest(const CTxDestination& dest, const std::string& id)\n {\n-    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)));\n+    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)));\n }\n \n+bool WalletBatch::EraseAddressData(const CTxDestination& dest)\n+{\n+    DataStream prefix;\n+    prefix << DBKeys::DESTDATA << EncodeDestination(dest);\n+    return m_batch->ErasePrefix(prefix);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150238393",
      "id" : 1150238393,
      "line" : 1110,
      "node_id" : "PRRC_kwDOABII585Ejz65",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 1110,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 42,
      "pull_request_review_id" : 1360512338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150513279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: could use structured bindings.\r\n```c++\r\nfor (const auto& [dest, entry] : m_address_book) {\r\n     for (const auto& [id, request] : entry.receive_requests) {\r\n         values.emplace_back(request);\r\n     }\r\n}\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:19:18Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n+    m_address_book[dest].previously_spent = true;\n+    return batch.WriteAddressPreviouslySpent(dest, true);\n }\n \n bool CWallet::IsAddressUsed(const CTxDestination& dest) const\n {\n-    const std::string key{\"used\"};\n-    std::map<CTxDestination, CAddressBookData>::const_iterator i = m_address_book.find(dest);\n-    if(i != m_address_book.end())\n-    {\n-        CAddressBookData::StringMap::const_iterator j = i->second.destdata.find(key);\n-        if(j != i->second.destdata.end())\n-        {\n-            return true;\n-        }\n-    }\n+    if (auto* data{util::FindKey(m_address_book, dest)}) return data->previously_spent;\n     return false;\n }\n \n std::vector<std::string> CWallet::GetAddressReceiveRequests() const\n {\n-    const std::string prefix{\"rr\"};\n     std::vector<std::string> values;\n-    for (const auto& address : m_address_book) {\n-        for (const auto& data : address.second.destdata) {\n-            if (!data.first.compare(0, prefix.size(), prefix)) {\n-                values.emplace_back(data.second);\n-            }\n+    for (const auto& dest : m_address_book) {\n+        for (const auto& request : dest.second.receive_requests) {\n+            values.emplace_back(request.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150513279",
      "id" : 1150513279,
      "line" : 2843,
      "node_id" : "PRRC_kwDOABII585Ek3B_",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2843,
      "original_position" : 67,
      "original_start_line" : 2841,
      "path" : "src/wallet/wallet.cpp",
      "position" : 67,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2841,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150523650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No longer the case.\r\nSame for the comment that is above this one.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:23:29Z",
      "diff_hunk" : "@@ -2439,11 +2439,7 @@ bool CWallet::DelAddressBook(const CTxDestination& address)\n             return false;\n         }\n         // Delete destdata tuples associated with address",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150523650",
      "id" : 1150523650,
      "line" : 2441,
      "node_id" : "PRRC_kwDOABII585Ek5kC",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2441,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 3,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150535358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not really for this PR, but.. the `used` arg is never false.\r\n\r\n`SetAddressUsed` is only called from `SetSpentKeyState` which is only called from `AddToWallet`, which provides `used=true`.\r\n\r\nWhich.. means that if the address is not reverted to a \"not used\" state if the tx gets abandoned/discarded.\r\n\r\nCould also work on it on a follow-up. Probably after #26836 so changes don't end up conflicting that much.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:32:56Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150535358",
      "id" : 1150535358,
      "line" : 2818,
      "node_id" : "PRRC_kwDOABII585Ek8a-",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2818,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 15,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150538791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This method was removed from the cpp but not from the header.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:35:30Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150538791",
      "id" : 1150538791,
      "line" : 2840,
      "node_id" : "PRRC_kwDOABII585Ek9Qn",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2840,
      "original_position" : 35,
      "original_start_line" : 2838,
      "path" : "src/wallet/wallet.cpp",
      "position" : 35,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791/reactions"
      },
      "side" : "LEFT",
      "start_line" : 2838,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be good to keep the encapsulation and don't access `m_address_book` from outside of the wallet class (otherwise we are reverting #25337 and, future, #26836). ",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:37:28Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data{pwallet->m_address_book[DecodeDestination(strAddress)]};\n+            if (strKey.compare(\"used\") == 0) {\n+                data.previously_spent = true;\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.receive_requests[strKey.substr(2)] = std::move(strValue);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159",
      "id" : 1150541159,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585Ek91n",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : 612,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 612,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150567795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this also fixes abdef47f206dec114300b2d852f5c297b03179e3 (from #26644)",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:55:35Z",
      "diff_hunk" : "@@ -656,12 +656,14 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database, BerkeleyBatch* batch)\n {\n     if (!database.m_db.get()) {\n         throw std::runtime_error(STR_INTERNAL_BUG(\"BerkeleyDatabase does not exist\"));\n     }\n-    int ret = database.m_db->cursor(nullptr, &m_cursor, 0);\n+    // Transaction argument to cursor is only needed when using the cursor to\n+    // write to the database. Read-only cursors do not need a txn pointer.\n+    int ret = database.m_db->cursor(batch ? batch->txn() : nullptr, &m_cursor, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150567795",
      "id" : 1150567795,
      "line" : 666,
      "node_id" : "PRRC_kwDOABII585ElEVz",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 666,
      "original_position" : 13,
      "original_start_line" : 664,
      "path" : "src/wallet/bdb.cpp",
      "position" : 13,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 664,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150572914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could\r\n```c++\r\nBOOST_CHECK_EQUAL(wallet->LoadWallet(), DBErrors::::LOAD_OK);\r\n```\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:59:21Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150572914",
      "id" : 1150572914,
      "line" : 450,
      "node_id" : "PRRC_kwDOABII585ElFly",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 450,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 36,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150579720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above, would be good to not access `m_address_book` directly from outside of the wallet class.\r\nThe map [] operator usage in a random place of the sources could easily screw things up.\r\n\r\nCould change it to\r\n```c++\r\nBOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:04:35Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150579720",
      "id" : 1150579720,
      "line" : 459,
      "node_id" : "PRRC_kwDOABII585ElHQI",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 459,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 45,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:14:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150583313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\nBOOST_CHECK(wallet->IsAddressUsed(PKHash()));\r\nBOOST_CHECK(wallet->IsAddressUsed(ScriptHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:07:18Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150583313",
      "id" : 1150583313,
      "line" : 471,
      "node_id" : "PRRC_kwDOABII585ElIIR",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 471,
      "original_position" : 57,
      "original_start_line" : 470,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 57,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 470,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150586523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\nBOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\nBOOST_CHECK(!wallet->IsAddressUsed(ScriptHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:09:39Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);\n+            auto requests = wallet->GetAddressReceiveRequests();\n+            auto erequests = {\"val_rr11\", \"val_rr20\"};\n+            BOOST_CHECK_EQUAL_COLLECTIONS(requests.begin(), requests.end(), std::begin(erequests), std::end(erequests));\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), false));\n+            BOOST_CHECK(batch.EraseAddressData(ScriptHash()));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(!wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150586523",
      "id" : 1150586523,
      "line" : 481,
      "node_id" : "PRRC_kwDOABII585ElI6b",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 481,
      "original_position" : 67,
      "original_start_line" : 480,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 67,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 480,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
