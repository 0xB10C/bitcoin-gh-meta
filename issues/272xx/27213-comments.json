[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ghost](https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1461538006), [0xB10C](https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1465197246), [brunoerg](https://github.com/bitcoin/bitcoin/pull/27213#pullrequestreview-1351139049) |\n| Approach ACK | [vasild](https://github.com/bitcoin/bitcoin/pull/27213#pullrequestreview-1465241616) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27534](https://github.com/bitcoin/bitcoin/pull/27534) (rpc: add 'getnetmsgstats', new rpc to view network message statistics by satsie)\n* [#27509](https://github.com/bitcoin/bitcoin/pull/27509) (Relay own transactions only via short-lived Tor or I2P connections by vasild)\n* [#27425](https://github.com/bitcoin/bitcoin/pull/27425) (test: move remaining rand code from util/setup_common to util/random by jonatack)\n* [#26114](https://github.com/bitcoin/bitcoin/pull/26114) (net: Make AddrFetch connections to fixed seeds by mzumsande)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-03-06T19:46:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1456856496",
      "id" : 1456856496,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585W1d2w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1456856496/reactions"
      },
      "updated_at" : "2023-06-07T11:36:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1456856496",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "We have 3 open questions that we are interested in hearing feedback from reviewers. We have considered many potential interactions and have laid out a couple specific ones along with tradeoffs of different approaches.\r\n\r\n### IBD \r\nThe first is regarding the interactions between this patch & IBD. Peers on privacy network might be slower than clearnet peers (eg. Tor or I2P). Our current proposal does not have any special case logic for disabling the network prioritization during IBD. \r\n\r\nThis could mean that our overall IBD speed is reduced by not having the fastest peers possible. The network peers could also be intermittently disconnected for stalling & get the node into a loop where it, for example, disconnects a Tor peer, connects to an IPV4 peer, re-adds a Tor peer and then keeps repeating. Finally, there could be interactions with the slow peers causing delays in the response time of the faster peers based on the specifics of our IBD logic. One solution is to just disable the network-specific outbound logic during IBD.\r\n\r\nOn the other hand, a node can get slow peers by random chance anyways. Whether randomly connecting to altnet peers or because a clearnet peer just happens to be slow. If they are slow, but not slow enough to be evicted due to the stalling limit, that will already have a significant impact on the IBD rate. The issues and potential solutions with improving IBD can be seen as tangential to this proposal, and we could favor not adding custom workarounds that serve as a bandaid to mask the root cause. Enabling alternative networks during IBD is already known to slow down the sync dramatically, and we can just add a warning in the documentation to help users become more aware. \r\n\r\n### Peers protected from eviction \r\nThis patch adds eviction protection for special network peers, but it only gets triggered when we have an extra outbound-full-relay peer (aka 9). This occurs when we detect a stale tip or because we added another special network peer. In these situations weâd want to ensure that we have at least one non-protected peer that can be disconnected so the node can return to the steady state of 8 full-relay outbound peers. \r\n\r\nCurrently, we protect 4 peers via `m_chain_sync.m_protect`, which are the first peers that send us headers corresponding to our best chain. This means 4 peers could be protected with this logic, and 3 more peers being protected by their network. If we added support for two more alternative networks, a user activating all networks could run into a problem where they have 9 protected peers in these circumstances, and unable to return to the steady state of 8 full-relay outbound peers. \r\n\r\nSince it would require adding support for at least one more network to run into this issue, we have not addressed it in this patch. There are multiple viable mitigation strategies: One option is to reduce the number of peers we protect with the headers logic (via `m_protect`). Another is to limit the network-specific logic to 2 random networks or such. \r\n\r\n### Network peer protection \r\nA potential concern of this patch is that the logic that protects network peers from eviction could be âover-protectiveâ. For example, keeping a Tor connection only because it is the only Tor connection, not because itâs providing us meaningful data.\r\n\r\nAny concerns around this are completely bounded by the fact that the protection logic is limited to when we have an _extra_ peer, either through stale tip detection or through the new temporary connections for network specific peers. \r\n\r\nHowever, if there is still concern, @ajtowns had an interesting idea to increase our likelihood of adding a 2nd peer from alternate networks. We could update the stale tip logic to choose the network of the extra outbound differently. Right now, the network odds reflect the proportions represented in `AddrMan`. Instead, we could amend the logic to select based on the proportion of networks we are connected to. This would increase our likelihood of connecting to the network, because, for example, youâre more likely to have â I2P peers than â of your addrman be I2P addresses. \r\n\r\nIncreasing the chances of connecting to a privacy network in that context has two benefits: \r\nIt serves the original intention of the stale top logic to be a last-ditch effort against a perceived eclipse attack. Overtaking multiple networks increases the cost of attack, so this is theoretically a more useful attempt than clearnet.\r\nFor this proposed patch, it would mean the node is more likely to add another peer from the alternate network, so the node is more able to replace a âbadâ network peer with hopefully a better one. This would be effective since the stale tip logic tends to run a couple times a day. \r\n\r\nThis could be treated as a separate chunk of work to be evaluated in a follow-up, or it could be incorporated into this PR if reviewers believe it could help mitigate concerns about edge case possibilities.  ",
      "created_at" : "2023-03-06T19:53:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1456867760",
      "id" : 1456867760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585W1gmw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1456867760/reactions"
      },
      "updated_at" : "2023-06-05T19:52:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1456867760",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\nThis was somewhere on my TODO, thanks for picking it up!\r\n\r\n> The automatic connections to alternate networks is done defensively, by first filling all outbound slots with random addresses (as in the status quo) and then adding additional peers from reachable networks the node is currently not connected to. This approach ensures that outbound slots are not left unfilled while attempting to connect to a network that may be unavailable due to a technical issue or misconfiguration that bitcoind cannot detect.\r\n\r\nHmm, this is maybe ok. Another approach would be to try to open to e.g. Tor while still having < 8 outbound connections. To counter the issue of staying with < 8 connections and not being able to open to Tor because e.g. the Tor proxy is broken, then we could give up after a few attempts and then fall back to the old way of filling with random (aka IPv4 ;-)) addresses. If we overshoot the 8 connections (like described above), then for some time we will have more, until eviction kicks in. How much time is that exactly? If that is short then it would be sub-optimal to open a IPv4 connection and drop it shortly after in cases where Tor connectivity is working smoothly. If it is long then we have practically increased the limit of 8 which will cause more traffic.\r\n\r\n> In the above, the clearnet networks IPv4 and IPv6 are counted as one network because diversification between these doesn't make sense and is impossible in some network environments.\r\n\r\nWhy it doesn't make sense? I think it is an extra effort to obtain IPv4 addresses if one has IPv6 addresses and the other way around. Why impossible in some network environments? After all you know if you are going to attempt to connect to `5.6.7.8` or `2030:c0fe:...`.\r\n\r\n> Manual connections are also taken into account: If a user already establishes manual connections to a trusted peer from a network, there is no longer a need to make extra efforts\r\n\r\n+1\r\n\r\n> IBD\r\n\r\nI think there is no need to add special logic during IBD (e.g. disable this PR during IBD). Clearnet peers can also be slow and non-clearnet peers may be fast-enough. IBD should be able to handle slow/fast peers already without special hand-holding.\r\n\r\n> Peers protected from eviction\r\n\r\nI think we don't need to worry about this now because even if we treat IPv4 and IPv6 as separate networks and all 4 from `m_protected` are from one network (e.g. IPv4), then we have 4 more slots for IPv6, Tor, I2P, CJDNS. If we implement more networks, maybe by that time we will have increased the default 8 or I would suggest to then start disconnecting from `m_protected`.\r\n\r\n> Network peer protection\r\n> A potential concern of this patch is that the logic that protects network peers from eviction could be âover-protectiveâ. For example, keeping a Tor connection only because it is the only Tor connection, not because itâs providing us meaningful data.\r\n\r\nI don't see it as \"over-protective\". Can we not have some metric of whether a peer is \"providing us a meaningful data\"? I am ok to deal with this in a followup.\r\n\r\n----\r\n\r\nTaking a step back, the root problem here is that addrman has many IPv4 addresses and few I2P ones (for example). If it would have equal number of addresses from each network, then this problem would not exist because then picking up a random one would have a 1/5 chance of selecting any network (thus there would not be any bias towards IPv4). Would it be simpler and solve the problem equally well if we only change addrman internally to return an address from any given network with a 1/5 chance? Then no need to change the eviction logic or the `ThreadOpenConnections` logic. And no need to _guarantee_ explicitly in the code that at least one connection exists to each network. It will happen by itself most of the time.",
      "created_at" : "2023-03-07T11:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1458015010",
      "id" : 1458015010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585W54si",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1458015010/reactions"
      },
      "updated_at" : "2023-03-07T11:36:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1458015010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think that scenario would already be problematic ... and then we wouldn't have a peer to evict.\r\n\r\n\"... then start disconnecting from `m_protected`\"\r\n\r\n> the math\r\n\r\nI think it goes like this: (with 5 networks) the chance of not selecting IPv4 for the first peer is `4/5`, for the first and second peer is `(4/5)^2`. The chance of not selecting IPv4 in all `8` choices is `p=(4/5)^8`. So, the chance of not selecting IPv4 or not selecting IPv6 is `2*p`. The chance of not selecting IPv4, or IPv6 or Tor or I2P or CJDNS is `5*p`. In other words, the chance of not being connected to at least one network is `5*p`, and thus the chance of being connected to all networks is `1-5*p`, or `16%` (`60%` for 4 nets, `88%` for 3 nets, `99%` for 2 nets and `100%` for 1 net).\r\n\r\nI think this is enough to ditch the idea of random-chance `Select()`. Also, maybe it would not be so much more simpler than this PR.\r\n\r\n_offtopic:_\r\n\r\n> One interesting idea for possible follow-ups would be optional logic that ties certain behavior to networks (e.g. broadcasting wallet transactions only to peers from anonymity networks).\r\n\r\nYes, please! :) To take this one step further, it would be even better to create a temporary connection(s) to Tor/I2P, broadcast our transaction(s) and close the connection(s) (with I2P transient address). This way, if we broadcast another tx after e.g. 1 hour the recipient will not be able to conclude that both transactions come from the same origin.\r\n\r\n> In order for that to work, it would be good to have stronger guarantee that we are actually connected to these networks.\r\n\r\nWould not be needed with temporary tx-broadcast connections.",
      "created_at" : "2023-03-08T09:29:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1459853005",
      "id" : 1459853005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XA5bN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1459853005/reactions"
      },
      "updated_at" : "2023-03-08T09:29:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1459853005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it goes like this: (...)\r\n> \r\n> I think this is enough to ditch the idea of random-chance `Select()`. Also, maybe it would not be so much more simpler than this PR.\r\n\r\nI agree with that conclusion, but I think you can't just add the probabilities like that. I think the correct formula is \r\n$$p={k! S(n,k) \\over k^n}$$\r\nwhere k is the number of networks, $n=8$ the number of outbounds and $S(n,k)$ the Stirling number of the second kind, see  [here](https://stats.stackexchange.com/questions/30483/probability-of-selecting-each-item-at-least-once-when-sampling-with-replacement) for an explanation - the resulting `32.256%` for all 5 networks agrees very well with my simulation results.\r\n(sorry, this is getting offtopic, and I'll stop now - will address your other open comments soon, unless amiti is first) ",
      "created_at" : "2023-03-08T23:43:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1461041818",
      "id" : 1461041818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XFbqa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461041818/reactions"
      },
      "updated_at" : "2023-03-09T01:48:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461041818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK ",
      "created_at" : "2023-03-09T08:17:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1461538006",
      "id" : 1461538006,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XHUzW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461538006/reactions"
      },
      "updated_at" : "2023-03-09T08:17:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461538006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/94559964?v=4",
         "events_url" : "https://api.github.com/users/1440000bytes/events{/privacy}",
         "followers_url" : "https://api.github.com/users/1440000bytes/followers",
         "following_url" : "https://api.github.com/users/1440000bytes/following{/other_user}",
         "gists_url" : "https://api.github.com/users/1440000bytes/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/1440000bytes",
         "id" : 94559964,
         "login" : "1440000bytes",
         "node_id" : "U_kgDOBaLe3A",
         "organizations_url" : "https://api.github.com/users/1440000bytes/orgs",
         "received_events_url" : "https://api.github.com/users/1440000bytes/received_events",
         "repos_url" : "https://api.github.com/users/1440000bytes/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/1440000bytes/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/1440000bytes/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/1440000bytes"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK: I think, having network diversity in outbound connections is helpful and improves partition resistance.\r\n\r\n>> In the above, the clearnet networks IPv4 and IPv6 are counted as one network because diversification between these doesn't make sense and is impossible in some network environments.\r\n>\r\n> Why it doesn't make sense? I think it is an extra effort to obtain IPv4 addresses if one has IPv6 addresses and the other way around. Why impossible in some network environments? After all you know if you are going to attempt to connect to 5.6.7.8 or 2030:c0fe:....\r\n\r\nI also not sure if I agree with counting IPv4 and IPv6 as one network and I think this could need a bit more reasoning. Is it because they are both clearnet? Is it a workaround to don't have 8 protected peers if all networks are enabled (which we'd also face when adding another network like yggdrasil as you mentioned)?\r\n\r\nI had the feeling that protecting only one IPv4 or IPv6 could, for example, reduce the number of inbound connections IPv6-only nodes get. However, I'm not sure if that's really the case (I need to think about this more).",
      "created_at" : "2023-03-12T13:17:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1465197246",
      "id" : 1465197246,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XVSK-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1465197246/reactions"
      },
      "updated_at" : "2023-03-12T13:17:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1465197246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Hmm, this is maybe ok. Another approach would be to try to open to e.g. Tor while still having < 8 outbound connections. To counter the issue of staying with < 8 connections and not being able to open to Tor because e.g. the Tor proxy is broken, then we could give up after a few attempts and then fall back to the old way of filling with random (aka IPv4 ;-)) addresses. If we overshoot the 8 connections (like described above), then for some time we will have more, until eviction kicks in. How much time is that exactly? If that is short then it would be sub-optimal to open a IPv4 connection and drop it shortly after in cases where Tor connectivity is working smoothly. If it is long then we have practically increased the limit of 8 which will cause more traffic.\r\n\r\n\r\nWe thought about this, of course, because it's the most straightforward approach. However, don't like it as much as the approach here for several reasons:\r\n- it requires introducing an arbitrary waiting time, during which we might have less outbound connections, especially if this would happen for multiple networks at the same time.\r\n- having too few outbound connections is a a potential security risk for the node and slows down important processes such as IBD, the only downsides of having an extra outbound connection is to have a bit of extra traffic, plus temporarily requiring more inbound capacity from the network.\r\n- churning through a few short-lived extra connections has several unrelated benefits, we do it voluntarily anyway (feeler connections), so I'd think it's no big deal.\r\n- the conditions which precluded us from connecting to a network might correct over time (maybe we had a lot of bad addresses in our addrman in the beginning; maybe some technical problem). Just trying a couple of times right after startup, and then giving up wouldn't be ideal in this scenario. \r\n\r\nI guess it boils down to that in general, I think temporarily having more outbound connections than our target is preferable to temporarily having less connections.",
      "created_at" : "2023-03-13T19:57:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1466870416",
      "id" : 1466870416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XbqqQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466870416/reactions"
      },
      "updated_at" : "2023-03-13T19:57:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466870416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Why it doesn't make sense? I think it is an extra effort to obtain IPv4 addresses if one has IPv6 addresses and the other way around. Why impossible in some network environments? After all you know if you are going to attempt to connect to 5.6.7.8 or 2030:c0fe:....\r\n> \r\n> I also not sure if I agree with counting IPv4 and IPv6 as one network and I think this could need a bit more reasoning. Is it because they are both clearnet? Is it a workaround to don't have 8 protected peers if all networks are enabled (which we'd also face when adding another network like yggdrasil as you mentioned)?\r\n\r\nI think our reasoning was:\r\n1) They are both clearnet, so it's a bit unclear to me if there is much of a benefit in diversification here. Though maybe there is an extra effort for a potential eclipse attacker to cover both IPv4 and IPv6?\r\n2) IPv4-only network setups exist, I've experienced it more than once that I would be within a network of some organization and could only connect to IPv4 peers, but bitcoind wasn't able to detect that so I'd see regular attempts to make connection to IPv6 peers which all failed immediately.\r\n\r\nSo basically, we saw no clear upsides, and some downsides, and that's why we decided to add it.\r\nBut I'm not insistent on this if people think that there is enough benefit in having connections to both IPv4 and IPv6 peers - it would also make the code cleaner if we didn't have to apply this exception in multiple places.\r\n\r\nIt had nothing to do with the number of 8 protected peers. I'm sure we could find other solutions around that edge case problem, e.g. adding logic to just not try an extra outbound in the first place when we could get into a position where we don't have an unprotected peer to evict, or softening the protection during eviction as vasild suggested.",
      "created_at" : "2023-03-13T19:59:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1466872077",
      "id" : 1466872077,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XbrEN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466872077/reactions"
      },
      "updated_at" : "2023-03-13T20:00:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1466872077",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure it has any influence on this pr, but did you consider doing something similar for block-relay-only peers?\r\n\r\nSomething like: connect to one generic block-relay-only peer, plus an additional block-relay-only peer for every network we support? I think that should only improve things, including during IBD. It wouldn't do anything to improve tx propagation of course, so wouldn't make this PR redundant.",
      "created_at" : "2023-03-15T05:27:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1469360153",
      "id" : 1469360153,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585XlKgZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1469360153/reactions"
      },
      "updated_at" : "2023-03-15T05:27:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1469360153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "thank you everyone for the thoughtful feedback! some questions & responses -\r\n\r\n### RE: logic to initially overshoot number of connections\r\n@vasild \r\n> If we overshoot the 8 connections (like described above), then for some time we will have more, until eviction kicks in. How much time is that exactly? If that is short then it would be sub-optimal to open a IPv4 connection and drop it shortly after in cases where Tor connectivity is working smoothly. If it is long then we have practically increased the limit of 8 which will cause more traffic.\r\n\r\nSince we already have short-lived connections through feelers, rotating extra block relay only connections, and stale tip detection, can you clarify the disadvantage of adding another? Especially since we wouldnât expect this new mechanism to occur frequently, does it seem acceptable or intrinsically different somehow? \r\n\r\n### RE: ipv4 vs ipv6\r\n@vasild: Are you suggesting that treating them as separate networks increases the cost of attack? Does the delta in energy required from the attacker feel meaningful? \r\n\r\n@0xB10C\r\n> I had the feeling that protecting only one IPv4 or IPv6 could, for example, reduce the number of inbound connections IPv6-only nodes get. However, Iâm not sure if thatâs really the case (I need to think about this more).\r\n\r\nHm interesting. \r\nOur current baseline is that we have no protections based on network. \r\nBy introducing network protections, we would expect the number of inbounds for IPV4 and IPV6 to drop compared to the current conditions. \r\nItâs likely that conflating the two networks would impact the distribution between them, but would that be problematic? \r\n\r\n### Future improvements\r\nAgreed these are orthogonal to the current proposal, but are very interesting ideas worth further exploration! \r\n\t- temporary tx broadcast connections\r\n\t- block-relay-only connections per network ",
      "created_at" : "2023-03-19T20:29:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1475388292",
      "id" : 1475388292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585X8KOE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1475388292/reactions"
      },
      "updated_at" : "2023-03-19T20:30:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1475388292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Something like: connect to one generic block-relay-only peer, plus an additional block-relay-only peer for every network we support? I think that should only improve things, including during IBD. It wouldn't do anything to improve tx propagation of course, so wouldn't make this PR redundant.\r\n\r\nAlso, should we have (at least) one anchor per network instead of only two \"generic\" ones? ",
      "created_at" : "2023-03-21T20:40:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1478551323",
      "id" : 1478551323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585YIOcb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1478551323/reactions"
      },
      "updated_at" : "2023-03-21T20:49:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1478551323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "added a commit that increases fuzz coverage for select by network\r\n\r\n@brunoerg \r\n> Also, should we have (at least) one anchor per network instead of only two \"generic\" ones?\r\n\r\nyeah, def think it's worth considering in relation to increasing block-relay-peers. @mzumsande & I have started brainstorming & plan to open an issue once we formulate some initial ideas. in the meanwhile, feel free to reach out directly if you're interested in discussing further :) ",
      "created_at" : "2023-03-24T00:00:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1482065109",
      "id" : 1482065109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585YVoTV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1482065109/reactions"
      },
      "updated_at" : "2023-03-24T00:00:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1482065109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > If we overshoot the 8 connections (like described above), then for some time we will have more, until eviction kicks in. How much time is that exactly? If that is short then it would be sub-optimal to open a IPv4 connection and drop it shortly after in cases where Tor connectivity is working smoothly. If it is long then we have practically increased the limit of 8 which will cause more traffic.\r\n> \r\n> Since we already have short-lived connections through feelers, rotating extra block relay only connections, and stale tip detection, can you clarify the disadvantage of adding another? Especially since we wouldnât expect this new mechanism to occur frequently, does it seem acceptable or intrinsically different somehow?\r\n\r\nYou did not answer my question \"How much time is that exactly?\" but your reply seems to imply an answer \"short\", correct me if I misunderstand. The disadvantage of doing that is \"it would be sub-optimal to open a IPv4 connection and drop it shortly after in cases where Tor connectivity is working smoothly\".\r\n\r\n> @vasild: Are you suggesting that treating them as separate networks increases the cost of attack?\r\n\r\nYes.\r\n\r\n> Does the delta in energy required from the attacker feel meaningful?\r\n\r\nThat question is a bit vague. I guess \"yes\" for some values of \"meaningful\".",
      "created_at" : "2023-04-07T09:10:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1500100974",
      "id" : 1500100974,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585Zablu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500100974/reactions"
      },
      "updated_at" : "2023-04-07T09:10:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1500100974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "this PR is ready for review! \r\n\r\ndid a couple of clean-up steps: \r\n* removed the fuzz commit since coverage is now handled in #27549 \r\n* rebased on master\r\n* updated the OP to reflect current status ",
      "created_at" : "2023-05-24T20:16:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1561872278",
      "id" : 1561872278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dGEeW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561872278/reactions"
      },
      "updated_at" : "2023-05-24T20:16:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1561872278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://cirrus-ci.com/task/4751246913961984?logs=ci#L2724:\r\n```bash\r\ntest/denialofservice_tests.cpp(134): Entering test case \"stale_tip_peer_management\"\r\ntest/denialofservice_tests.cpp(212): error: in \"denialofservice_tests/stale_tip_peer_management\": check vNodes[i]->fDisconnect == false has failed\r\ntest/denialofservice_tests.cpp(214): error: in \"denialofservice_tests/stale_tip_peer_management\": check vNodes[max_outbound_full_relay - 2]->fDisconnect == true has failed\r\ntest/denialofservice_tests.cpp(134): Leaving test case \"stale_tip_peer_management\"; testing time: 7571us\r\n```",
      "created_at" : "2023-05-25T09:26:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1562580491",
      "id" : 1562580491,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dIxYL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562580491/reactions"
      },
      "updated_at" : "2023-05-25T09:26:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1562580491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> https://cirrus-ci.com/task/4751246913961984?logs=ci#L2724:\r\n> \r\n> ```shell\r\n> test/denialofservice_tests.cpp(134): Entering test case \"stale_tip_peer_management\"\r\n> test/denialofservice_tests.cpp(212): error: in \"denialofservice_tests/stale_tip_peer_management\": check vNodes[i]->fDisconnect == false has failed\r\n> test/denialofservice_tests.cpp(214): error: in \"denialofservice_tests/stale_tip_peer_management\": check vNodes[max_outbound_full_relay - 2]->fDisconnect == true has failed\r\n> test/denialofservice_tests.cpp(134): Leaving test case \"stale_tip_peer_management\"; testing time: 7571us\r\n> ```\r\n\r\nAh, I think the problem with the test is that `AddRandomOutboundPeer` creates random IPv4 addresses, and sometimes these aren't routable (e.g. protected ranges), so that they are not assigned to `NET_IPV4` but `NET_UNROUTABLE`, which then makes the test fail. This happens intermittently. @amitiuttarwar I haven't looked into solutions yet, but may just try another IPv4 address if this is the case?",
      "created_at" : "2023-05-25T15:34:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1563115012",
      "id" : 1563115012,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dKz4E",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563115012/reactions"
      },
      "updated_at" : "2023-05-25T15:34:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563115012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ah, I think the problem with the test is that AddRandomOutboundPeer creates random IPv4 addresses, and sometimes these aren't routable (e.g. protected ranges), so that they are not assigned to NET_IPV4 but NET_UNROUTABLE, which then makes the test fail. This happens intermittently. @amitiuttarwar I haven't looked into solutions yet, but may just try another IPv4 address if this is the case?\r\n\r\nNot sure, I ran the test several times (debugging) and could get the error but didn't get a `NET_UNROUTABLE` address. \r\n\r\n",
      "created_at" : "2023-05-25T19:39:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1563416721",
      "id" : 1563416721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dL9iR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563416721/reactions"
      },
      "updated_at" : "2023-05-25T19:39:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1563416721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Ah, I think the problem with the test is that `AddRandomOutboundPeer` creates random IPv4 addresses, and sometimes these aren't routable (e.g. protected ranges), so that they are not assigned to `NET_IPV4` but `NET_UNROUTABLE`, which then makes the test fail.\r\n\r\ngreat find @mzumsande ! I was able to reproduce & observe this behavior, so I added a loop in `AddRandomOutboundPeer` to try again if the selected address is not routable. hopefully this works, I ran the current version >1000 times and didn't see any failures locally. \r\n\r\n@brunoerg - how did you observe if the addrs are routable? note that in the failure situation it's not the onion peer that causes the issue, its a IPv4 peer from the initial setup ",
      "created_at" : "2023-05-27T01:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1565134780",
      "id" : 1565134780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dSg-8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565134780/reactions"
      },
      "updated_at" : "2023-05-27T01:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1565134780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1208033507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208033507"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Instead of pushing the node to `vNodes` and removing it if it's not routable, I think you could do something like:\r\n```cpp\r\nstatic void AddRandomOutboundPeer(NodeId& id, std::vector<CNode*>& vNodes, PeerManager& peerLogic, ConnmanTestMsg& connman, ConnectionType connType, bool onion_peer = false)\r\n{\r\n    CAddress addr;\r\n\r\n    if (onion_peer) {\r\n        auto tor_addr{g_insecure_rand_ctx.randbytes(ADDR_TORV3_SIZE)};\r\n        BOOST_REQUIRE(addr.SetSpecial(OnionToString(tor_addr)));\r\n    }\r\n\r\n    while (!addr.IsRoutable()) {\r\n        addr = CAddress(ip(g_insecure_rand_ctx.randbits(32)), NODE_NONE);\r\n    }\r\n\r\n    vNodes.emplace_back(new CNode{id++,\r\n            /*sock=*/nullptr,\r\n            addr,\r\n            /*nKeyedNetGroupIn=*/0,\r\n            /*nLocalHostNonceIn=*/0,\r\n            CAddress(),\r\n            /*addrNameIn=*/\"\",\r\n            connType,\r\n            /*inbound_onion=*/false});\r\n    CNode &node = *vNodes.back();\r\n\r\n    node.SetCommonVersion(PROTOCOL_VERSION);\r\n    peerLogic.InitializeNode(node, ServiceFlags(NODE_NETWORK | NODE_WITNESS));\r\n    node.fSuccessfullyConnected = true;\r\n    connman.AddTestNode(node);\r\n}\r\n```\r\n\r\n1. You can check if the `addr` is routable directly, no need to do it in `CNode`.\r\n2. Check `onion_peer` before trying to create a routable addr.",
      "commit_id" : "399e3719427ed858a658cc9d7a3f2e6ee6e7ec04",
      "created_at" : "2023-05-27T15:18:09Z",
      "diff_hunk" : "@@ -106,25 +106,41 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n     peerman.FinalizeNode(dummyNode1);\n }\n \n-static void AddRandomOutboundPeer(NodeId& id, std::vector<CNode*>& vNodes, PeerManager& peerLogic, ConnmanTestMsg& connman, ConnectionType connType)\n+static void AddRandomOutboundPeer(NodeId& id, std::vector<CNode*>& vNodes, PeerManager& peerLogic, ConnmanTestMsg& connman, ConnectionType connType, bool onion_peer = false)\n {\n-    CAddress addr(ip(g_insecure_rand_ctx.randbits(32)), NODE_NONE);\n-    vNodes.emplace_back(new CNode{id++,\n-                                  /*sock=*/nullptr,\n-                                  addr,\n-                                  /*nKeyedNetGroupIn=*/0,\n-                                  /*nLocalHostNonceIn=*/0,\n-                                  CAddress(),\n-                                  /*addrNameIn=*/\"\",\n-                                  connType,\n-                                  /*inbound_onion=*/false});\n-    CNode &node = *vNodes.back();\n-    node.SetCommonVersion(PROTOCOL_VERSION);\n-\n-    peerLogic.InitializeNode(node, ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n-    node.fSuccessfullyConnected = true;\n-\n-    connman.AddTestNode(node);\n+    auto routable = false;\n+\n+    while (!routable) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1208033507",
      "id" : 1208033507,
      "line" : 113,
      "node_id" : "PRRC_kwDOABII585IASDj",
      "original_commit_id" : "399e3719427ed858a658cc9d7a3f2e6ee6e7ec04",
      "original_line" : 113,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : 26,
      "pull_request_review_id" : 1447428655,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208033507/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-27T15:18:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208033507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1208070951"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208070951"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "great feedback! that's much cleaner. incorporated in the latest push ",
      "commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "created_at" : "2023-05-27T17:20:42Z",
      "diff_hunk" : "@@ -106,25 +106,41 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n     peerman.FinalizeNode(dummyNode1);\n }\n \n-static void AddRandomOutboundPeer(NodeId& id, std::vector<CNode*>& vNodes, PeerManager& peerLogic, ConnmanTestMsg& connman, ConnectionType connType)\n+static void AddRandomOutboundPeer(NodeId& id, std::vector<CNode*>& vNodes, PeerManager& peerLogic, ConnmanTestMsg& connman, ConnectionType connType, bool onion_peer = false)\n {\n-    CAddress addr(ip(g_insecure_rand_ctx.randbits(32)), NODE_NONE);\n-    vNodes.emplace_back(new CNode{id++,\n-                                  /*sock=*/nullptr,\n-                                  addr,\n-                                  /*nKeyedNetGroupIn=*/0,\n-                                  /*nLocalHostNonceIn=*/0,\n-                                  CAddress(),\n-                                  /*addrNameIn=*/\"\",\n-                                  connType,\n-                                  /*inbound_onion=*/false});\n-    CNode &node = *vNodes.back();\n-    node.SetCommonVersion(PROTOCOL_VERSION);\n-\n-    peerLogic.InitializeNode(node, ServiceFlags(NODE_NETWORK | NODE_WITNESS));\n-    node.fSuccessfullyConnected = true;\n-\n-    connman.AddTestNode(node);\n+    auto routable = false;\n+\n+    while (!routable) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1208070951",
      "id" : 1208070951,
      "in_reply_to_id" : 1208033507,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IAbMn",
      "original_commit_id" : "399e3719427ed858a658cc9d7a3f2e6ee6e7ec04",
      "original_line" : 113,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1447487518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208070951/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-27T17:20:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1208070951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1209501764"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209501764"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We want to protect a peer if it's the only one for its network. However, we can run a node supporting just one network. In this case, I suppose that calling `GetFullOutboundAndManualCount` might be unnecessary, we would iterating the whole `m_nodes` with no need.\r\n\r\nIn this case, I think we could have a function like `SupportsMultipleNetworks` to check whether we support more than one network, e.g.:\r\n\r\n```cpp\r\nbool CConnman::SupportsMultipleNetworks() const\r\n{\r\n    int count = 0;\r\n    for (int n = 0; n < NET_MAX; n++) {\r\n        enum Network net = (enum Network)n;\r\n        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\r\n        if (IsReachable(net)) {\r\n            if (net == NET_IPV4) n++;\r\n            count++;\r\n        }\r\n    }\r\n    return count > 0;\r\n}\r\n```\r\n\r\nif so, we can call `GetFullOutboundAndManualCount`:\r\n```cpp\r\nif (m_connman.SupportsMultipleNetworks() && m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;\r\n```",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-05-29T18:27:59Z",
      "diff_hunk" : "@@ -5155,6 +5157,12 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             if (state == nullptr) return; // shouldn't be possible, but just in case\n             // Don't evict our protected peers\n             if (state->m_chain_sync.m_protect) return;\n+            // Protect a peer if it's the only one for its network, counting IPv4 and\n+            // IPv6 as one network.\n+            // Both outbound-full-relay and manual connections are counted for this,\n+            // but not block-relay-only connections because the goal\n+            // is to have at least one tx-relaying connection to each reachable network.\n+            if (m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1209501764",
      "id" : 1209501764,
      "line" : 5165,
      "node_id" : "PRRC_kwDOABII585IF4hE",
      "original_commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "original_line" : 5165,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 1449778687,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209501764/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T14:44:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209501764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Just a suggestion, but I think we could cover `GetFullOutboundAndManualCount` in fuzz.\r\n\r\n```diff\r\ndiff --git a/src/test/fuzz/connman.cpp b/src/test/fuzz/connman.cpp\r\nindex f81658b83..f5867f8b4 100644\r\n--- a/src/test/fuzz/connman.cpp\r\n+++ b/src/test/fuzz/connman.cpp\r\n@@ -128,4 +128,6 @@ FUZZ_TARGET_INIT(connman, initialize_connman)\r\n     (void)connman.GetTotalBytesSent();\r\n     (void)connman.GetTryNewOutboundPeer();\r\n     (void)connman.GetUseAddrmanOutgoing();\r\n+    const Network net{fuzzed_data_provider.PickValueInArray({Network::NET_IPV4, Network::NET_IPV6, Network::NET_INTERNAL, Network::NET_ONION})};\r\n+    (void)connman.GetFullOutboundAndManualCount(net);\r\n }\r\n```",
      "created_at" : "2023-05-29T19:19:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1567445222",
      "id" : 1567445222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585dbVDm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567445222/reactions"
      },
      "updated_at" : "2023-05-29T19:19:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1567445222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1209611483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209611483"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In `377e81e2e409470d00e69247d0d9e980773ab73e`, I suppose this verification could be avoided. In `Select`, \r\n`new_only` is false by default and `preferred_net` is optional and it will only have a value when `MaybePickPreferredNetwork`returns true. So, if `preferred_net` doesn't have any value, I suppose that `addrman.Select(false, preferred_net)` and `addrman.Select()` will have the same effect.\r\n\r\n```diff\r\n@@ -1901,15 +1915,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\r\n                     std::tie(addr, addr_last_try) = addrman.Select(true);\r\n                 }\r\n             } else {\r\n-                // Not a feeler\r\n-                if (preferred_net.has_value()) {\r\n-                    // pick an extra outbound peer from a preferred network.\r\n-                    // The eviction logic in net_processing makes sure that\r\n-                    //  a peer from another network will be evicted.\r\n-                    std::tie(addr, addr_last_try) = addrman.Select(false, preferred_net);\r\n-                } else {\r\n-                    std::tie(addr, addr_last_try) = addrman.Select();\r\n-                }\r\n+                std::tie(addr, addr_last_try) = addrman.Select(false, preferred_net);\r\n```",
      "commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "created_at" : "2023-05-30T00:51:44Z",
      "diff_hunk" : "@@ -1871,7 +1902,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 }\n             } else {\n                 // Not a feeler\n-                std::tie(addr, addr_last_try) = addrman.Select();\n+                if (preferred_net.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1209611483",
      "id" : 1209611483,
      "line" : 1905,
      "node_id" : "PRRC_kwDOABII585IGTTb",
      "original_commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "original_line" : 1905,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 83,
      "pull_request_review_id" : 1449933790,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209611483/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-30T00:51:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1209611483",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1218526503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218526503"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nice simplification! incorporated in latest push",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-05T19:53:50Z",
      "diff_hunk" : "@@ -1871,7 +1902,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 }\n             } else {\n                 // Not a feeler\n-                std::tie(addr, addr_last_try) = addrman.Select();\n+                if (preferred_net.has_value()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1218526503",
      "id" : 1218526503,
      "in_reply_to_id" : 1209611483,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585IoT0n",
      "original_commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "original_line" : 1905,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1463292868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218526503/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218526503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1218543773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218543773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah, I see what you're saying - that we can avoid iterating through all peers when we are only running on one network. \r\n\r\nI've implemented a version of your suggestion in https://github.com/amitiuttarwar/bitcoin/commit/1805698096ae29e8dd6ecd1be9348a04f612602c. I changed the function implementation and also invoked from the additional call site in `MaybePickPreferredNetwork`. It seems viable.\r\n\r\nI haven't pushed it here yet because I'm still trying to figure out a slightly cleaner solution. I noticed that we are introducing a lot of functions to `CConnman` that iterate through the networks to check similar-but-slightly-different attributes. `GetReachableEmptyNetworks` already exists, this PR introduces `MaybePickPreferredNetwork`, and now we may also add this function, `SupportsMultipleNetworks`. given that `CConnman` is already quite large & frequently imported, I'm trying to see if there's a way we could consolidate these similar functions together. will report back later this week :) ",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-05T20:10:21Z",
      "diff_hunk" : "@@ -5155,6 +5157,12 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             if (state == nullptr) return; // shouldn't be possible, but just in case\n             // Don't evict our protected peers\n             if (state->m_chain_sync.m_protect) return;\n+            // Protect a peer if it's the only one for its network, counting IPv4 and\n+            // IPv6 as one network.\n+            // Both outbound-full-relay and manual connections are counted for this,\n+            // but not block-relay-only connections because the goal\n+            // is to have at least one tx-relaying connection to each reachable network.\n+            if (m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1218543773",
      "id" : 1218543773,
      "in_reply_to_id" : 1209501764,
      "line" : 5165,
      "node_id" : "PRRC_kwDOABII585IoYCd",
      "original_commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "original_line" : 5165,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 1463320586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218543773/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-05T20:10:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1218543773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks for the review @brunoerg ! latest push incorporated fuzz test & `ThreadOpenConnections` simplification. I'm still working on the other feedback (as explained above). \r\n\r\none question about your suggested patch in the fuzz test: \r\n`const Network net{fuzzed_data_provider.PickValueInArray({Network::NET_IPV4, Network::NET_IPV6, Network::NET_INTERNAL, Network::NET_ONION})};`\r\nis there a reason to select from the subset of networks? in the patch I pushed up, I also added the other ones. I saw that  `ConsumeNetAddr` used the same subset, but I am guessing that's because of other challenges in creating network addresses. just wanted to check to see if there's something I'm missing.\r\n\r\n### IPv4 & IPv6 treatment\r\nContext refresher: the open question is whether IPv4 & IPv6 should be bundled together as âclearnetâ or treated as two separate networks. The current proposal opts for the former.\r\n\r\nAfter chatting this through with @mzumsande, we are still leaning towards bundling into a single clearnet. Here is our understanding & rationale. We are curious to hear more feedback from reviewers, and are open to being persuaded that the alternative approach is beneficial through concrete examples.\r\n* We do not see clear value in treating them separately: from our research, it seems that most cloud providers allow users to expose IPv4 or IPv6 addresses with trivial setup. If users are running a node on a different setup, eg. local, they can also use a VPN to expose the opposite. The amount of effort required to obtain the opposite address generally seems minimal, which means diversifying would not meaningfully increase the cost of attack for a malicious entity.\r\n* The potential downside is clear: by default, bitcoind considers both IPv4 & IPv6 to be reachable. However, both Martin & I have experienced running nodes within a network setup such that only connection attempts to IPv4 nodes were successful. A node in this environment running current master will still have failed IPv6 connection attempts. But the problem (aka frequency of failed attempts) would increase in severity if we added this patch with logic that treated IPv4 & IPv6 separately.\r\n* If we wanted to treat these two networks separately and not worsen the rate of failed connections, we would have to add additional logic to prevent infinite periodic attempts (eg. to IPv6 nodes in the previous example). This additional complexity is viable, but does not feel justified given not having a clear value add of separating the two networks.\r\n* Just to clarify, having too many peers be protected from eviction is not a current concern regardless of the approach selected here.\r\n\r\n@vasild, @0xB10C - thoughts?",
      "created_at" : "2023-06-05T20:23:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1577424366",
      "id" : 1577424366,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585eBZXu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577424366/reactions"
      },
      "updated_at" : "2023-06-05T20:23:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1577424366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I am slowly coming back to this PR...\r\n\r\n> we are still leaning towards bundling into a single clearnet ... - thoughts?\r\n\r\nOk :)\r\n\r\n",
      "created_at" : "2023-06-06T11:43:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1578579892",
      "id" : 1578579892,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585eFze0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1578579892/reactions"
      },
      "updated_at" : "2023-06-06T11:43:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1578579892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1219678326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1219678326"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`GetFullOutboundAndManualCount()` will iterate on all nodes, and is called from `ForEachNode()` which iterates on all nodes. This makes it `O(number of nodes ^ 2)`. This will also do a recursive lock on `m_nodes_mutex` and there is an ongoing effort to eradicate recursive locks from the code base.\r\n\r\nSo, what about collecting the stats (a network->count map) just once, before the `ForEachNode()` call?",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-06T13:41:05Z",
      "diff_hunk" : "@@ -5155,6 +5157,12 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             if (state == nullptr) return; // shouldn't be possible, but just in case\n             // Don't evict our protected peers\n             if (state->m_chain_sync.m_protect) return;\n+            // Protect a peer if it's the only one for its network, counting IPv4 and\n+            // IPv6 as one network.\n+            // Both outbound-full-relay and manual connections are counted for this,\n+            // but not block-relay-only connections because the goal\n+            // is to have at least one tx-relaying connection to each reachable network.\n+            if (m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1219678326",
      "id" : 1219678326,
      "line" : 5165,
      "node_id" : "PRRC_kwDOABII585IstB2",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 5165,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1219678326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1219678326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221338648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221338648"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This test seems correct but is a bit obscure as it juggles with `vNodes[max_outbound_full_relay - 2]` and `vNodes.back()`. Here it does not check the value of `vNodes[max_outbound_full_relay - 1]->fDisconnect` (it is supposed to be `true`, left unmodified from the previous test).\r\n\r\nMaybe it would help a bit if:\r\n* before the newly added test snippet set `vNodes[max_outbound_full_relay - 1]->fDisconnect` to `false`, so that all of them are `false` then the new test starts.\r\n* `back()` is not used and `[max_outbound_full_relay + 1]` is used instead (and `[max_outbound_full_relay + 2]` at the end).",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-07T10:23:35Z",
      "diff_hunk" : "@@ -197,6 +207,27 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n     BOOST_CHECK(vNodes[max_outbound_full_relay-1]->fDisconnect == true);\n     BOOST_CHECK(vNodes.back()->fDisconnect == false);\n \n+    // Add an onion peer, that will be protected because it is the only one for\n+    // its network, so another peer gets disconnected instead.\n+    SetMockTime(time_init);\n+    AddRandomOutboundPeer(id, vNodes, *peerLogic, *connman, ConnectionType::OUTBOUND_FULL_RELAY, /*onion_peer=*/true);\n+    SetMockTime(time_later);\n+    peerLogic->CheckForStaleTipAndEvictPeers();\n+\n+    for (int i = 0; i < max_outbound_full_relay - 2; ++i) {\n+        BOOST_CHECK(vNodes[i]->fDisconnect == false);\n+    }\n+    BOOST_CHECK(vNodes[max_outbound_full_relay - 2]->fDisconnect == true);\n+    BOOST_CHECK(vNodes.back()->fDisconnect == false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221338648",
      "id" : 1221338648,
      "line" : 221,
      "node_id" : "PRRC_kwDOABII585IzCYY",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 221,
      "original_position" : 37,
      "original_start_line" : 220,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : 37,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221338648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 220,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221338648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221348635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221348635"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The return value and the optional output argument are redundant. Better to return `std::optional` and take no arguments:\r\n\r\n```cpp\r\nstd::optional<Network> MaybePickPreferredNetwork()\r\n```\r\n(would have to be called outside of `else if (...` which I find clearer).\r\n\r\nOr drop the optional:\r\n\r\n```cpp\r\nbool MaybePickPreferredNetwork(Network& network);\r\n```",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-07T10:28:13Z",
      "diff_hunk" : "@@ -1010,6 +1018,19 @@ class CConnman\n      */\n     std::vector<CAddress> GetCurrentBlockRelayOnlyConns() const;\n \n+    /**\n+     * Search for a \"preferred\" network, a reachable network to which we currently\n+     * don't have any outbound connections (outbound-full-relay or manual, counting IPv4\n+     * and IPv6 as one network).\n+     * There needs to be at least one address in AddrMan for a preferred network to\n+     * be picked.\n+     *\n+     * @param[out]    network        Preferred network, if found.\n+     *\n+     * @return           bool        Whether a preferred network was found.\n+     */\n+    bool MaybePickPreferredNetwork(std::optional<Network>& network);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221348635",
      "id" : 1221348635,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII585IzE0b",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1032,
      "original_position" : 37,
      "original_start_line" : 1028,
      "path" : "src/net.h",
      "position" : 37,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221348635/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1028,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221348635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221384118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221384118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`GetFullOutboundAndManualCount(net)` is called for each network and each call iterates all nodes, collecting stats just for the given network, ignoring the others. It can collect all the stats with one iteration (network->count map) and be called just once, before this loop (vs for each netowork).",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-07T10:55:15Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)\n+{\n+    std::vector<Network> preferred_networks;\n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\n+        if (IsReachable(net) && GetFullOutboundAndManualCount(net) == 0 && addrman.Size(net) != 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221384118",
      "id" : 1221384118,
      "line" : 1636,
      "node_id" : "PRRC_kwDOABII585IzNe2",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1636,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 29,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221384118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221384118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221406171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221406171"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There is no need to collect more than one element in `preferred_networks`, the previous loop can be stopped as soon as a match is found and the shuffling can be done on the order in which networks are iterated (untested):\r\n\r\n```cpp\r\nstd::optional<Network> CConnman::MaybePickPreferredNetwork()\r\n{\r\n    std::array<Network, 5> nets{NET_IPV4, NET_IPV6, NET_ONION, NET_I2P, NET_CJDNS};\r\n    Shuffle(nets.begin(), nets.end(), FastRandomContext());\r\n    auto peers_per_net = GetFullOutboundAndManualCounts();\r\n    for (const auto net : nets) {\r\n        if (IsReachable(net) && peers_per_net[net] == 0 && addrman.Size(net) != 0) {\r\n            return net;\r\n        }\r\n    }\r\n    return std::nullopt;\r\n}\r\n```",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-07T11:16:04Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)\n+{\n+    std::vector<Network> preferred_networks;\n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\n+        if (IsReachable(net) && GetFullOutboundAndManualCount(net) == 0 && addrman.Size(net) != 0) {\n+            preferred_networks.push_back(net);\n+        }\n+    }\n+    if (preferred_networks.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221406171",
      "id" : 1221406171,
      "line" : 1640,
      "node_id" : "PRRC_kwDOABII585IzS3b",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1640,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 33,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221406171/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221406171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221421939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221421939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The way this is implemented would give clearnet 2x chance of being returned over another network with 0 peers. Is this the intention?\r\n\r\nFor example: let all of IPv4, IPv6 and Tor be reachable and there are 0 peers to each of those networks. Clearnet (IPv4 or IPv6) will be returned in 67% of the cases and Tor in 33%. Should that not be clearnet 50%, Tor 50%?",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-07T11:30:44Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1221421939",
      "id" : 1221421939,
      "line" : 1630,
      "node_id" : "PRRC_kwDOABII585IzWtz",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1630,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 23,
      "pull_request_review_id" : 1465241616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221421939/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-07T11:36:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1221421939",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> * The potential downside is clear: by default, bitcoind considers both IPv4 & IPv6 to be reachable. However, both Martin & I have experienced running nodes within a network setup such that only connection attempts to IPv4 nodes were successful. A node in this environment running current master will still have failed IPv6 connection attempts. But the problem (aka frequency of failed attempts) would increase in severity if we added this patch with logic that treated IPv4 & IPv6 separately.\r\n\r\nI'm not convinced this is a problem in the first place -- failed connection attempts on networks that don't exist don't seem to impose any significant costs?\r\n\r\nIt seems simpler to me to just treat each network as if it's meaningfully distinct, and try to remain connected to each one if possible. I'm not sure trying to be more clever about that (eg: we want one of ipv4 or ipv6 because those connections are fast; we want new networks like cjdns because otherwise they might be really hard to bootstrap because few outbound connections are made; we want i2p because it's harder to eclipse than tor; etc) actually has much benefit?\r\n\r\nIf we are worried about failed connections for some reason, we could lower the frequency from 1 minute to perhaps 5 minutes. I think the worst case scenario there is when you have all 8 outbounds via one network (ipv4 eg), want to make a connection to another network (eg cjdns), but have all 3 remaining networks (ipv6, tor, i2p) marked as reachable but not actually functioning. Then you've got a 75% chance of `MaybePickPreferredNetwork` wasting your time, and having to wait another interval. That seems to have about a 4x multiplier in the worst case, so you'd only be making the extra net outbound connection perhaps every 20 minutes, instead of every 5 minutes. But for a long-lived node, that's probably not too bad even so. And in the ordinary case where you only perhaps have ipv6 as reachable but not working, it's only a 2x multiplier.",
      "created_at" : "2023-06-08T02:47:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1581806840",
      "id" : 1581806840,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585eSHT4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1581806840/reactions"
      },
      "updated_at" : "2023-06-08T02:47:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1581806840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222386277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222386277"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah, the reason for this function signature was to enable calling from within the `else if(...)` conditional. pulling it out would mean having to run `MaybePickPreferredNetwork` every time `ThreadOpenConnections` runs, which seems unnecessary?",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-08T02:53:13Z",
      "diff_hunk" : "@@ -1010,6 +1018,19 @@ class CConnman\n      */\n     std::vector<CAddress> GetCurrentBlockRelayOnlyConns() const;\n \n+    /**\n+     * Search for a \"preferred\" network, a reachable network to which we currently\n+     * don't have any outbound connections (outbound-full-relay or manual, counting IPv4\n+     * and IPv6 as one network).\n+     * There needs to be at least one address in AddrMan for a preferred network to\n+     * be picked.\n+     *\n+     * @param[out]    network        Preferred network, if found.\n+     *\n+     * @return           bool        Whether a preferred network was found.\n+     */\n+    bool MaybePickPreferredNetwork(std::optional<Network>& network);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222386277",
      "id" : 1222386277,
      "in_reply_to_id" : 1221348635,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII585I3CJl",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1032,
      "original_position" : 37,
      "original_start_line" : 1028,
      "path" : "src/net.h",
      "position" : 37,
      "pull_request_review_id" : 1468900045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222386277/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1028,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-08T02:53:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222386277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222388434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222388434"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the requirement here is only \"try each network with reasonable probability\" -- you want to be connected to all of the networks, so which one comes first doesn't matter very much.\r\n\r\nIf you don't have ipv4 or ipv6 connections but are going through this codepath, then that means you have all your outbounds connected via privacy networks, but haven't chosen to `-onlynet=tor` or similar. So biassing towards clearnet probably makes sense anyway: clearnet connections probably have higher bandwidth/lower latency so will give you blocks/txs quicker, reducing the load on the privacy networks.",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-08T02:55:30Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222388434",
      "id" : 1222388434,
      "in_reply_to_id" : 1221421939,
      "line" : 1630,
      "node_id" : "PRRC_kwDOABII585I3CrS",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1630,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 23,
      "pull_request_review_id" : 1468903183,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222388434/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-08T02:55:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222388434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222985986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222985986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yes, that would be unnecessary",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-08T12:42:52Z",
      "diff_hunk" : "@@ -1010,6 +1018,19 @@ class CConnman\n      */\n     std::vector<CAddress> GetCurrentBlockRelayOnlyConns() const;\n \n+    /**\n+     * Search for a \"preferred\" network, a reachable network to which we currently\n+     * don't have any outbound connections (outbound-full-relay or manual, counting IPv4\n+     * and IPv6 as one network).\n+     * There needs to be at least one address in AddrMan for a preferred network to\n+     * be picked.\n+     *\n+     * @param[out]    network        Preferred network, if found.\n+     *\n+     * @return           bool        Whether a preferred network was found.\n+     */\n+    bool MaybePickPreferredNetwork(std::optional<Network>& network);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1222985986",
      "id" : 1222985986,
      "in_reply_to_id" : 1221348635,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII585I5UkC",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1032,
      "original_position" : 37,
      "original_start_line" : 1028,
      "path" : "src/net.h",
      "position" : 37,
      "pull_request_review_id" : 1469829293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222985986/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1028,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-08T12:42:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1222985986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "On treating IPv4 and IPv6 as one network - I am ok either way. I see the merit in amiti's considerations above, but also on @ajtowns's. One more thing to consider - for an attacker it is not too difficult to get IPv6 connectivity but that is also the case for Tor. I mean it is not too difficult to get Tor connectivity either, but that is still _some_ extra effort.",
      "created_at" : "2023-06-08T12:59:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#issuecomment-1582537371",
      "id" : 1582537371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27213",
      "node_id" : "IC_kwDOABII585eU5qb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1582537371/reactions"
      },
      "updated_at" : "2023-06-08T12:59:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1582537371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1223007090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223007090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, I am just checking because elsewhere the intention is to treat clearnet as one network and this code does not do that. I do not have a strong opinion either way.",
      "commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "created_at" : "2023-06-08T12:59:48Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1223007090",
      "id" : 1223007090,
      "in_reply_to_id" : 1221421939,
      "line" : 1630,
      "node_id" : "PRRC_kwDOABII585I5Zty",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1630,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 23,
      "pull_request_review_id" : 1469865038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223007090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-08T12:59:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223007090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1223373778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223373778"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "okay, going to resolve this thread. but lmk if you have any other suggestions, it's definitely a bit odd.. ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-08T17:50:20Z",
      "diff_hunk" : "@@ -1010,6 +1018,19 @@ class CConnman\n      */\n     std::vector<CAddress> GetCurrentBlockRelayOnlyConns() const;\n \n+    /**\n+     * Search for a \"preferred\" network, a reachable network to which we currently\n+     * don't have any outbound connections (outbound-full-relay or manual, counting IPv4\n+     * and IPv6 as one network).\n+     * There needs to be at least one address in AddrMan for a preferred network to\n+     * be picked.\n+     *\n+     * @param[out]    network        Preferred network, if found.\n+     *\n+     * @return           bool        Whether a preferred network was found.\n+     */\n+    bool MaybePickPreferredNetwork(std::optional<Network>& network);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1223373778",
      "id" : 1223373778,
      "in_reply_to_id" : 1221348635,
      "line" : 1040,
      "node_id" : "PRRC_kwDOABII585I6zPS",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1040,
      "original_position" : 37,
      "original_start_line" : 1028,
      "path" : "src/net.h",
      "position" : 45,
      "pull_request_review_id" : 1470491780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223373778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1036,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-08T17:50:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1223373778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913119"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "latest push collects stats as a `CConnman` member, so we don't have to worry about iterating through all nodes",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T19:55:02Z",
      "diff_hunk" : "@@ -5155,6 +5157,12 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             if (state == nullptr) return; // shouldn't be possible, but just in case\n             // Don't evict our protected peers\n             if (state->m_chain_sync.m_protect) return;\n+            // Protect a peer if it's the only one for its network, counting IPv4 and\n+            // IPv6 as one network.\n+            // Both outbound-full-relay and manual connections are counted for this,\n+            // but not block-relay-only connections because the goal\n+            // is to have at least one tx-relaying connection to each reachable network.\n+            if (m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913119",
      "id" : 1225913119,
      "in_reply_to_id" : 1219678326,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEfMf",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 5165,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1473810726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T19:55:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913181"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "updated to incorporate your suggestions, thanks!",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T19:55:42Z",
      "diff_hunk" : "@@ -197,6 +207,27 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n     BOOST_CHECK(vNodes[max_outbound_full_relay-1]->fDisconnect == true);\n     BOOST_CHECK(vNodes.back()->fDisconnect == false);\n \n+    // Add an onion peer, that will be protected because it is the only one for\n+    // its network, so another peer gets disconnected instead.\n+    SetMockTime(time_init);\n+    AddRandomOutboundPeer(id, vNodes, *peerLogic, *connman, ConnectionType::OUTBOUND_FULL_RELAY, /*onion_peer=*/true);\n+    SetMockTime(time_later);\n+    peerLogic->CheckForStaleTipAndEvictPeers();\n+\n+    for (int i = 0; i < max_outbound_full_relay - 2; ++i) {\n+        BOOST_CHECK(vNodes[i]->fDisconnect == false);\n+    }\n+    BOOST_CHECK(vNodes[max_outbound_full_relay - 2]->fDisconnect == true);\n+    BOOST_CHECK(vNodes.back()->fDisconnect == false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913181",
      "id" : 1225913181,
      "in_reply_to_id" : 1221338648,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEfNd",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 221,
      "original_position" : 37,
      "original_start_line" : 220,
      "path" : "src/test/denialofservice_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1473810796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913181/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-11T19:55:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913245"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "moved to member to prevent iterating through all nodes",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T19:56:15Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)\n+{\n+    std::vector<Network> preferred_networks;\n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\n+        if (IsReachable(net) && GetFullOutboundAndManualCount(net) == 0 && addrman.Size(net) != 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913245",
      "id" : 1225913245,
      "in_reply_to_id" : 1221384118,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEfOd",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1636,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1473810877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913245/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T19:56:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913270"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done, thanks!",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T19:56:23Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)\n+{\n+    std::vector<Network> preferred_networks;\n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\n+        if (IsReachable(net) && GetFullOutboundAndManualCount(net) == 0 && addrman.Size(net) != 0) {\n+            preferred_networks.push_back(net);\n+        }\n+    }\n+    if (preferred_networks.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913270",
      "id" : 1225913270,
      "in_reply_to_id" : 1221406171,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEfO2",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1640,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1473810893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913270/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T19:56:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913626"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913626"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "we have now removed any clearnet bundling, so this quirk is no longer relevant ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T19:57:11Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225913626",
      "id" : 1225913626,
      "in_reply_to_id" : 1221421939,
      "line" : 1621,
      "node_id" : "PRRC_kwDOABII585JEfUa",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1621,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 39,
      "pull_request_review_id" : 1473811292,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913626/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T19:57:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225913626",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225914692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225914692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "question: I noticed you used array in your implementation but we were using vector. is there a strong reason for that? ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T20:01:11Z",
      "diff_hunk" : "@@ -1608,6 +1608,43 @@ std::unordered_set<Network> CConnman::GetReachableEmptyNetworks() const\n     return networks;\n }\n \n+int CConnman::GetFullOutboundAndManualCount(Network net) const\n+{\n+    LOCK(m_nodes_mutex);\n+    int outbound_peers{0};\n+    std::optional<Network> net_alt;\n+    // Treat clearnet (IPv4 and IPv6) as one network\n+    if (net == Network::NET_IPV4) net_alt = Network::NET_IPV6;\n+    if (net == Network::NET_IPV6) net_alt = Network::NET_IPV4;\n+    for (const auto& pnode : m_nodes) {\n+        if (pnode->fSuccessfullyConnected && !pnode->fDisconnect && (pnode->IsFullOutboundConn() || pnode->IsManualConn())) {\n+            auto net_peer{pnode->addr.GetNetwork()};\n+            if (net == net_peer || (net_alt.has_value() && net_alt == net_peer)) {\n+                ++outbound_peers;\n+            }\n+        }\n+    }\n+    return outbound_peers;\n+}\n+\n+bool CConnman::MaybePickPreferredNetwork(std::optional<Network>& network)\n+{\n+    std::vector<Network> preferred_networks;\n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        if (net == NET_UNROUTABLE || net == NET_INTERNAL) continue;\n+        if (IsReachable(net) && GetFullOutboundAndManualCount(net) == 0 && addrman.Size(net) != 0) {\n+            preferred_networks.push_back(net);\n+        }\n+    }\n+    if (preferred_networks.size() > 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225914692",
      "id" : 1225914692,
      "in_reply_to_id" : 1221406171,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEflE",
      "original_commit_id" : "df76eb535bbd215da17cee8e0f480af9e94e9e70",
      "original_line" : 1640,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1473812674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225914692/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T20:01:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225914692",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225915157"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225915157"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "updated to have a small connman member to keep track of counts. now we don't iterate through all peers anymore :) ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-11T20:04:29Z",
      "diff_hunk" : "@@ -5155,6 +5157,12 @@ void PeerManagerImpl::EvictExtraOutboundPeers(std::chrono::seconds now)\n             if (state == nullptr) return; // shouldn't be possible, but just in case\n             // Don't evict our protected peers\n             if (state->m_chain_sync.m_protect) return;\n+            // Protect a peer if it's the only one for its network, counting IPv4 and\n+            // IPv6 as one network.\n+            // Both outbound-full-relay and manual connections are counted for this,\n+            // but not block-relay-only connections because the goal\n+            // is to have at least one tx-relaying connection to each reachable network.\n+            if (m_connman.GetFullOutboundAndManualCount(pnode->addr.GetNetwork()) <= 1) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1225915157",
      "id" : 1225915157,
      "in_reply_to_id" : 1209501764,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JEfsV",
      "original_commit_id" : "377e81e2e409470d00e69247d0d9e980773ab73e",
      "original_line" : 5165,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1473813096,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225915157/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-11T20:04:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1225915157",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1226781222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226781222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: This belongs in the first commit, not the second.",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-12T14:37:49Z",
      "diff_hunk" : "@@ -29,7 +29,10 @@ struct ConnmanTestMsg : public CConnman {\n     {\n         LOCK(m_nodes_mutex);\n         m_nodes.push_back(&node);\n+\n+        if (node.IsManualOrFullOutboundConn()) { m_network_conn_counts[node.ConnectedThroughNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1226781222",
      "id" : 1226781222,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII585JHzIm",
      "original_commit_id" : "a5e431daf0af08c4e5e177a9208b87398c9d8669",
      "original_line" : 33,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/net.h",
      "position" : 5,
      "pull_request_review_id" : 1475101835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226781222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T15:28:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226781222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1226797402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226797402"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is the use of `ConnectedThroughNetwork()` instead of `addr.GetNetwork()` on purpose?\r\nThe name and the extra logic for inbound onions suggest that it's tailored towards inbound connections, and there is the subtle difference that it calls `addr.GetNetClass()` instead of `addr.GetNetwork()`, which means a different behavior for linked IPV4 addresses.\r\n\r\nI think that in general it would be good to have more consistency between these two functions, which is out of scope for this PR.\r\nBut we should have consistency in what function is called here (the net_processing call to `MultipleManualOrFullOutboundConns` uses  `GetNetwork()`)",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-12T14:48:14Z",
      "diff_hunk" : "@@ -575,6 +575,8 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[pnode->ConnectedThroughNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1226797402",
      "id" : 1226797402,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JH3Fa",
      "original_commit_id" : "d1142f031c7a19a28ad8fdacd6fde110992228c8",
      "original_line" : 578,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1475101835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226797402/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-12T15:28:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1226797402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1230127530"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230127530"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "thanks, fixed ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-14T20:25:45Z",
      "diff_hunk" : "@@ -29,7 +29,10 @@ struct ConnmanTestMsg : public CConnman {\n     {\n         LOCK(m_nodes_mutex);\n         m_nodes.push_back(&node);\n+\n+        if (node.IsManualOrFullOutboundConn()) { m_network_conn_counts[node.ConnectedThroughNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1230127530",
      "id" : 1230127530,
      "in_reply_to_id" : 1226781222,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII585JUkGq",
      "original_commit_id" : "a5e431daf0af08c4e5e177a9208b87398c9d8669",
      "original_line" : 33,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/test/util/net.h",
      "position" : 5,
      "pull_request_review_id" : 1480240247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230127530/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T20:25:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230127530",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1230129705"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230129705"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "good catch! I didn't realize that difference between `GetNetClass()` and `GetNetwork()`. updated this site to use `GetNetwork()` in the latest push.  ",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-14T20:27:21Z",
      "diff_hunk" : "@@ -575,6 +575,8 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[pnode->ConnectedThroughNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1230129705",
      "id" : 1230129705,
      "in_reply_to_id" : 1226797402,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585JUkop",
      "original_commit_id" : "d1142f031c7a19a28ad8fdacd6fde110992228c8",
      "original_line" : 578,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1480242839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230129705/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-14T20:27:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1230129705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239822678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239822678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "style: remove the braces or put the statement on a new line. From `doc/developer-notes.md`:\r\n\r\n>  - If an `if` only has a single-statement `then`-clause, it can appear\r\n    on the same line as the `if`, without braces.\r\n\r\n(same when decrementing)",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-23T13:30:10Z",
      "diff_hunk" : "@@ -575,6 +578,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    // update connection count by network\n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[addrConnect.GetNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239822678",
      "id" : 1239822678,
      "line" : 582,
      "node_id" : "PRRC_kwDOABII585J5jFW",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 582,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 15,
      "pull_request_review_id" : 1495153995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239822678/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-23T13:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239822678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239824684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239824684"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might as well use `++` instead `+= 1`:\r\n\r\n```cpp\r\n++m_network_conn_counts[addrConnect.GetNetwork()]\r\n```\r\n\r\n(same when decrementing)",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-23T13:31:56Z",
      "diff_hunk" : "@@ -575,6 +578,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    // update connection count by network\n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[addrConnect.GetNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239824684",
      "id" : 1239824684,
      "line" : 582,
      "node_id" : "PRRC_kwDOABII585J5jks",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 582,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 15,
      "pull_request_review_id" : 1495153995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239824684/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-23T13:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239824684",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239828132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239828132"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is unnecessary, you can just drop it. The first time `operator[]` is used for a given key a default-initialized value is inserted for that key, which in our case is `0`.",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-23T13:35:16Z",
      "diff_hunk" : "@@ -2360,6 +2404,11 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n         semAddnode = std::make_unique<CSemaphore>(nMaxAddnode);\n     }\n \n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        m_network_conn_counts[net] = 0;\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239828132",
      "id" : 1239828132,
      "line" : 2411,
      "node_id" : "PRRC_kwDOABII585J5kak",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 2411,
      "original_position" : 110,
      "original_start_line" : 2407,
      "path" : "src/net.cpp",
      "position" : 110,
      "pull_request_review_id" : 1495153995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239828132/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2407,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-23T13:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239828132",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239840312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239840312"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This map can be accessed from multiple threads and has to be protected by a mutex. It is too dangerous to assume that it will never be modified. [operator[]](https://en.cppreference.com/w/cpp/container/map/operator_at) which is used later in the code is not `const`. For example, it is not guaranteed that it will not cause some internal reorg of the structure.\r\n\r\n`std::unordered_map` suits better here because we don't need an order and its access and insertion complexity is `O(1)`.\r\n\r\nIf you really like using unprotected structure of atomics, then maybe `std::array` would be ok (but have to index using `Network` which smells bad). Another option - would it be possible to make this map or array `const`?",
      "commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "created_at" : "2023-06-23T13:46:22Z",
      "diff_hunk" : "@@ -1023,6 +1052,9 @@ class CConnman\n     std::chrono::seconds nMaxOutboundCycleStartTime GUARDED_BY(m_total_bytes_sent_mutex) {0};\n     uint64_t nMaxOutboundLimit GUARDED_BY(m_total_bytes_sent_mutex);\n \n+    // Stores number of full-tx connections (outbound and manual) per network\n+    std::map<Network, std::atomic<unsigned int>> m_network_conn_counts;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1239840312",
      "id" : 1239840312,
      "line" : 1056,
      "node_id" : "PRRC_kwDOABII585J5nY4",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 1056,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 55,
      "pull_request_review_id" : 1495153995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239840312/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-23T13:51:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1239840312",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241000169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241000169"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "my latest thinking was to change this data struct to an array, add explicit numeric values to the `Network` enum (for index values) & then protect the array with `m_nodes_mutex` to keep the values consistent between the relevant data structures tracking node data. what do you think of this approach? \r\n\r\n(I had coded it up, but then managed to spill liquid on my laptop which fried it as I was trying to push the changes. still working to get my current setup back to functional to make the changes ð¬)\r\n\r\n> Another option - would it be possible to make this map or array const?\r\n\r\nnot sure I follow. what would it mean for the array to be const? isn't the point to update the values? ð",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-25T02:02:00Z",
      "diff_hunk" : "@@ -1023,6 +1052,9 @@ class CConnman\n     std::chrono::seconds nMaxOutboundCycleStartTime GUARDED_BY(m_total_bytes_sent_mutex) {0};\n     uint64_t nMaxOutboundLimit GUARDED_BY(m_total_bytes_sent_mutex);\n \n+    // Stores number of full-tx connections (outbound and manual) per network\n+    std::map<Network, std::atomic<unsigned int>> m_network_conn_counts;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241000169",
      "id" : 1241000169,
      "in_reply_to_id" : 1239840312,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J-Cjp",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 1056,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 1496861352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241000169/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-25T02:02:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241000169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259654"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "updated ",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-25T18:24:52Z",
      "diff_hunk" : "@@ -575,6 +578,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    // update connection count by network\n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[addrConnect.GetNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259654",
      "id" : 1241259654,
      "in_reply_to_id" : 1239822678,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J_B6G",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 582,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1497159831,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-25T18:24:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259892"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-25T18:26:23Z",
      "diff_hunk" : "@@ -575,6 +578,9 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n                              });\n     pnode->AddRef();\n \n+    // update connection count by network\n+    if (pnode->IsManualOrFullOutboundConn()) { m_network_conn_counts[addrConnect.GetNetwork()] += 1; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259892",
      "id" : 1241259892,
      "in_reply_to_id" : 1239824684,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J_B90",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 582,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1497160172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259892/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-25T18:26:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259991"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "changed to array, so this is no longer relevant ",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-25T18:27:08Z",
      "diff_hunk" : "@@ -2360,6 +2404,11 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n         semAddnode = std::make_unique<CSemaphore>(nMaxAddnode);\n     }\n \n+    for (int n = 0; n < NET_MAX; n++) {\n+        enum Network net = (enum Network)n;\n+        m_network_conn_counts[net] = 0;\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241259991",
      "id" : 1241259991,
      "in_reply_to_id" : 1239828132,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585J_B_X",
      "original_commit_id" : "f653a45f4f72dedb53955b89b0290b33cc23cf6d",
      "original_line" : 2411,
      "original_position" : 110,
      "original_start_line" : 2407,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 1497160267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259991/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-06-25T18:27:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241259991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241361033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361033"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "here and in `test/util/net.h` - this is still using `ConnectedThroughNetwork` (see previous comment).",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-26T01:14:17Z",
      "diff_hunk" : "@@ -1135,6 +1135,9 @@ void CConnman::DisconnectNodes()\n                 // close socket and cleanup\n                 pnode->CloseSocketDisconnect();\n \n+                // update connection count by network\n+                if (pnode->IsManualOrFullOutboundConn()) m_network_conn_counts[pnode->ConnectedThroughNetwork()]--;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241361033",
      "id" : 1241361033,
      "line" : 1142,
      "node_id" : "PRRC_kwDOABII585J_aqJ",
      "original_commit_id" : "c11659b8647552da349e65e6a51af5f1e00b4288",
      "original_line" : 1139,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 15,
      "pull_request_review_id" : 1497287640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361033/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-26T01:20:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241361274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: unrelated whitespace change",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-26T01:14:53Z",
      "diff_hunk" : "@@ -1023,6 +1038,7 @@ class CConnman\n     std::chrono::seconds nMaxOutboundCycleStartTime GUARDED_BY(m_total_bytes_sent_mutex) {0};\n     uint64_t nMaxOutboundLimit GUARDED_BY(m_total_bytes_sent_mutex);\n \n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241361274",
      "id" : 1241361274,
      "line" : 1055,
      "node_id" : "PRRC_kwDOABII585J_at6",
      "original_commit_id" : "c11659b8647552da349e65e6a51af5f1e00b4288",
      "original_line" : 1041,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 54,
      "pull_request_review_id" : 1497287640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-26T01:20:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241361274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241362625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241362625"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `addrConnect` can't be used here, because it can be empty if `pszDest` is set (that's why the CI fails too). You could use `pnode->addr` instead, which is set from either `addrConnect` or `pszDest` in `ConnectNode()`!",
      "commit_id" : "564bf851cccd34e859f23b6e6b00debebba9a3c2",
      "created_at" : "2023-06-26T01:19:01Z",
      "diff_hunk" : "@@ -2035,6 +2038,9 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n     {\n         LOCK(m_nodes_mutex);\n         m_nodes.push_back(pnode);\n+\n+        // update connection count by network\n+        if (pnode->IsManualOrFullOutboundConn()) m_network_conn_counts[addrConnect.GetNetwork()]++;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27213#discussion_r1241362625",
      "id" : 1241362625,
      "line" : 2089,
      "node_id" : "PRRC_kwDOABII585J_bDB",
      "original_commit_id" : "c11659b8647552da349e65e6a51af5f1e00b4288",
      "original_line" : 2043,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 113,
      "pull_request_review_id" : 1497287640,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27213",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241362625/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-06-26T01:20:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1241362625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
