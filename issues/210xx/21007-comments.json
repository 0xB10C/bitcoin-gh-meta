[
   {
      "author_association" : "MEMBER",
      "body" : "> This can be useful when the process launching bitcoind wants to guarantee that either the RPC server is running, or that initialization failed, before continuing. The exit code indicates the initialization result.\r\n\r\nWhy such behavior couldn't be the default?",
      "created_at" : "2021-01-25T22:29:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767155783",
      "id" : 767155783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NTc4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767155783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564088898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564088898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/`ALLOW_ANY`/`ALLOW_BOOL`/ in both lines?",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-01-25T22:32:46Z",
      "diff_hunk" : "@@ -577,7 +577,8 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-server\", \"Accept command line and JSON-RPC commands\", ArgsManager::ALLOW_ANY, OptionsCategory::RPC);\n \n #if HAVE_DECL_DAEMON\n-    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemonwait\", \"Wait for initialization to be finished before exiting. This implies -daemon (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564088898",
      "id" : 564088898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA4ODg5OA==",
      "original_commit_id" : "f88aa35dfe4d824ae2ded5c9229bf5763c459e5e",
      "original_line" : 581,
      "original_position" : 6,
      "original_start_line" : 580,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 575864170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564088898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why such behavior couldn't be the default?\r\n\r\nI didn't do that to avoid that discussion for now :slightly_smiling_face: . It could always be made default at some point in the future if that's what people want.",
      "created_at" : "2021-01-25T22:33:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767157237",
      "id" : 767157237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NzIzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:33:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767157237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-01-25T22:34:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767157806",
      "id" : 767157806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NzgwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767157806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20383 (Avoid signed integer overflow and invalid integer negation when loading malformed mempool.dat files by practicalswift)\n* #19471 (util: Make default arg values more specific by hebasto)\n* #19160 (multiprocess: Add basic spawn and IPC support by ryanofsky)\n* #10102 ([experimental] Multiprocess bitcoin by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-26T02:08:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767235287",
      "id" : 767235287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzIzNTI4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-12T14:08:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767235287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564296569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564296569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea!\r\nI'm also surprised there are no DEFAULT_XXX constants here.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-01-26T07:28:09Z",
      "diff_hunk" : "@@ -577,7 +577,8 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-server\", \"Accept command line and JSON-RPC commands\", ArgsManager::ALLOW_ANY, OptionsCategory::RPC);\n \n #if HAVE_DECL_DAEMON\n-    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemonwait\", \"Wait for initialization to be finished before exiting. This implies -daemon (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564296569",
      "id" : 564296569,
      "in_reply_to_id" : 564088898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDI5NjU2OQ==",
      "original_commit_id" : "f88aa35dfe4d824ae2ded5c9229bf5763c459e5e",
      "original_line" : 581,
      "original_position" : 6,
      "original_start_line" : 580,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 576079338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564296569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-01-26T09:37:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767421905",
      "id" : 767421905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzQyMTkwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T09:37:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767421905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-01-26T18:57:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767756333",
      "id" : 767756333,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Nzc1NjMzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T18:57:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767756333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing! FWIW what I use to force a failure in `AppInitMain` is\r\n```\r\nsrc/bitcoind -regtest -daemonwait -pid=/invalid/path\r\n```\r\n(pid is, by definition, only written in the daemon process)\r\nBut that works too :smile: ",
      "created_at" : "2021-01-27T13:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768302433",
      "id" : 768302433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMwMjQzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T13:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768302433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> (pid is, by definition, only written in the daemon process)\r\n\r\nNot sure if this is true in the master branch.\r\n",
      "created_at" : "2021-01-27T14:01:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768305065",
      "id" : 768305065,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMwNTA2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768305065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not sure if this is true in the master branch.\r\n\r\nI am sure of this. I did not change this at all, and besides, it would be a bug otherwise. After all, what use is the temporary parent process' PID.",
      "created_at" : "2021-01-27T14:11:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768311235",
      "id" : 768311235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxMTIzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:11:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768311235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> ... it would be a bug otherwise.\r\n\r\n```\r\nsrc/bitcoind -daemon=0\r\n```\r\ncreates `bitcoind.pid`",
      "created_at" : "2021-01-27T14:17:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768315306",
      "id" : 768315306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxNTMwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768315306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> creates bitcoind.pid\r\n\r\nThat's not my point. My point is that it creates the PID file *after* daemonizing (when daemon is enabled). Sure, it also creates the PID file otherwise, that's okay. The only thing I was trying to say is that the option can be used for testing `-daemonwait` because it fails after daemonizing, nothing more.",
      "created_at" : "2021-01-27T14:24:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768319284",
      "id" : 768319284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxOTI4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768319284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing @jonatack ,\r\n\r\n> (this particular case does not log anything to the debug log)\r\n\r\nThat it doesn't log anything is peculiar ! (but unrelated to this PR, I guess, the same problem would happen with `-daemon`, it would just mysteriously exit in the background).\r\n\r\n> Ctrl-C works with a second or two of delay; it seems to not take effect until the wait is released but I'm not sure.\r\n\r\nIt does respond to it? That's interesting. I thought the child process wouldn't get the SIGINT signal at all (hence my remaining TODO). That it doesn't react immediately is normal, It can't interrupt during verification of a block, for example. it's the same when interrupting a non-daemon startup.",
      "created_at" : "2021-01-27T18:13:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768474737",
      "id" : 768474737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODQ3NDczNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T18:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768474737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested with testnet, which is much slower than signet for me (95 sec vs 3)\r\n```\r\n$ time ./src/bitcoind -testnet -daemonwait=1 && ./src/bitcoin-cli -testnet stop\r\nBitcoin Core starting\r\n\r\nreal\t1m35.265s\r\nuser\t0m0.137s\r\nsys\t0m0.015s\r\nBitcoin Core stopping\r\n$\r\n```\r\n\r\nCtrl-C right after launching interrupts successfully after the same time period elapses \r\n```\r\n$ time ./src/bitcoind -testnet -daemonwait=1\r\nBitcoin Core starting\r\n^C\r\nreal\t1m39.239s\r\nuser\t0m0.130s\r\nsys\t0m0.022s\r\n$\r\n```\r\n",
      "created_at" : "2021-01-27T20:23:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768553517",
      "id" : 768553517,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODU1MzUxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T20:23:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768553517",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've looked into this a bit.\r\n\r\nIt looks like that until the parent process exits, the child process is still attached to the terminal (or at least, shell session), so it still gets the `SIGINT` from Ctrl-C directly. Even though it did `dup2` `stdin/stdout/stderr` to `/dev/null` already.\r\n\r\nSo there appears to be no need to do explicit signal propagation. That's neat. I'll remove that TODO and open this for review.",
      "created_at" : "2021-01-28T12:01:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-769007341",
      "id" : 769007341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTAwNzM0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-28T12:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769007341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568983015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568983015"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, it's always a bit frustrating to see that within a C++ ctor it's impossible to directly signal to the caller that the construction failed (I had to think about this article: https://250bpm.com/blog:4/). Since we can't do anything immediately anyways if there was a failure, I guess the pipe{2} return value checks could simply be dropped?",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-02T22:44:16Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568983015",
      "id" : 568983015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk4MzAxNQ==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568983015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568985945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568985945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could simply call the `Close()` method here to deduplicate? (Only drawback: it unnecessarily sets m_fd to -1 before destroying the object.)",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-02T22:50:21Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;\n+    }\n+#else\n+    if (pipe(m_fds) != 0) {\n+        return;\n+    }\n+#endif\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    if (m_fd != -1) close(m_fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568985945",
      "id" : 568985945,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk4NTk0NQ==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568985945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990330"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Return value constants for TokenWrite and TokenRead. */\r\n```",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-02T22:59:43Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <stdint.h>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return valus constants for TokenWrite and TokenRead. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990330",
      "id" : 568990330,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5MDMzMA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Write token to file descriptor.\r\n```",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-02T23:01:06Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <stdint.h>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return valus constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Read token from file descriptor.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990947",
      "id" : 568990947,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5MDk0Nw==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568997766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568997766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, feel free to ignore: maybe avoid implicit casting from bool to uint8_t and use literal 1 (or some character literal) as success token instead? I think as it is this could be potentially confusing for readers (also the counterpart `TokenRead` call below). As a drawback though, `-daemonwait` code gets longer: `daemon_ep.TokenWrite(fRet ? 1 : 0)`.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-02T23:17:20Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568997766",
      "id" : 568997766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5Nzc2Ng==",
      "original_commit_id" : "7482634cd455c6d25287e52795c2ac78cb1d44b0",
      "original_line" : 199,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568997766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569717901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569717901"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~Agree, it's probably better to pass some constant.~~\r\n~~Or even just fRet as-is? It's an integer after all.~~\r\nNever mind, i was already doing that, just turned this into a value.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-03T20:14:41Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569717901",
      "id" : 569717901,
      "in_reply_to_id" : 568997766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcxNzkwMQ==",
      "original_commit_id" : "7482634cd455c6d25287e52795c2ac78cb1d44b0",
      "original_line" : 199,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 582762626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569717901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569721308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569721308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was first thinking of using the rust trick: to have a private constructor, and a static public factory function on the class that returns a `std::optional<Pipe>`. But it would complicate some things. E.g. currently this type is not movable at all, it felt like overkill to implement that just for initialization, but maybe it's worth it if we can make it a standard idiom.\r\n\r\nHaving to check `complete()` as a mandatory step feels slightly ugly too, after all.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-03T20:20:25Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569721308",
      "id" : 569721308,
      "in_reply_to_id" : 568983015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyMTMwOA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 582766865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569721308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569724510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569724510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, why not. It seemed like so little code that it wouldn't really be worth deduplicating. I agree the redundant set to `-1` doesn't matter, this is not a performance critical function.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-03T20:26:05Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;\n+    }\n+#else\n+    if (pipe(m_fds) != 0) {\n+        return;\n+    }\n+#endif\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    if (m_fd != -1) close(m_fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569724510",
      "id" : 569724510,
      "in_reply_to_id" : 568985945,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyNDUxMA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 582771069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-16T19:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569724510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed @theStack's comments:\r\n- Added `TokenPipe::create()` that returns an optional (and make `TokenPipe` movable, and its constructor private), instead of the awkward incomplete construction.\r\n- Call `Close()` in destructor instead of duplicating code.\r\n- Consistently pass int to `TokenWrite`.\r\n- Fixed typos in comments.",
      "created_at" : "2021-02-16T19:06:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-780054109",
      "id" : 780054109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDA1NDEwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T19:09:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780054109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The error-check after TokenPipe creation is missing here, e.g. `if (!pipe) return false;`",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-17T23:05:37Z",
      "diff_hunk" : "@@ -24,25 +27,17 @@ std::mutex g_shutdown_mutex;\n std::condition_variable g_shutdown_cv;\n #else\n /** On UNIX-like operating systems use the self-pipe trick.\n- * Index 0 will be the read end of the pipe, index 1 the write end.\n  */\n-static int g_shutdown_pipe[2] = {-1, -1};\n+static TokenPipeEnd g_shutdown_r;\n+static TokenPipeEnd g_shutdown_w;\n #endif\n \n bool InitShutdownState()\n {\n #ifndef WIN32\n-#if HAVE_O_CLOEXEC\n-    // If we can, make sure that the file descriptors are closed on exec()\n-    // to prevent interference.\n-    if (pipe2(g_shutdown_pipe, O_CLOEXEC) != 0) {\n-        return false;\n-    }\n-#else\n-    if (pipe(g_shutdown_pipe) != 0) {\n-        return false;\n-    }\n-#endif\n+    std::optional<TokenPipe> pipe = TokenPipe::create();\n+    g_shutdown_r = pipe->ReadEnd();\n+    g_shutdown_w = pipe->WriteEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007134",
      "id" : 578007134,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAwNzEzNA==",
      "original_commit_id" : "581f48d818e17bebe75e24c9d72029e4a0f2e8af",
      "original_line" : 40,
      "original_position" : 37,
      "original_start_line" : 38,
      "path" : "src/shutdown.cpp",
      "position" : 37,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : 38,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-17T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007441"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        return -1; // pipe or pipe2 failed.\r\n```",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-17T23:06:19Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umblical = TokenPipe::create();\n+    if (!umblical) {\n+        return -1; // pipe or pip2 failed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007441",
      "id" : 578007441,
      "line" : 49,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAwNzQ0MQ==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 49,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 29,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-17T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578013255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578013255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n                        if (token == 1) { // fRet == 1, Success\r\n```\r\n(probably the token variable could be eliminated by calling `TokenRead` directly in the if condition.)",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-17T23:19:26Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(1);\n+                        daemon_ep.Close();\n+                    }\n+                    break;\n+                case -1: // Error happened.\n+                    return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+                default: { // Parent: wait and exit.\n+                        int token = daemon_ep.TokenRead();\n+                        if (token == true) { // fRet == true, Success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578013255",
      "id" : 578013255,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxMzI1NQ==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 207,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 132,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-17T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578013255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578014248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578014248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typos:\r\n```suggestion\r\n    // that the parent process can quit, and whether it was successful/unsuccessful.\r\n```",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-17T23:21:57Z",
      "diff_hunk" : "@@ -59,6 +133,14 @@ static bool AppInit(int argc, char* argv[])\n         return true;\n     }\n \n+#if HAVE_DECL_FORK\n+    // Communication with parent after daemonizing. This is used for signalling in the following ways:\n+    // - a boolean token is sent when the initialization process (all the Init* functions) have finished to indicate\n+    // that the parent process can quit, and whether it was succesful/unsuccesful.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578014248",
      "id" : 578014248,
      "line" : 139,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxNDI0OA==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 139,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 95,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-17T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578014248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578017192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578017192"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't know the word before (nice name for a parent-child-pipe ð), but according to the dictionary the spelling is slightly different:\r\n```suggestion\r\n        endpoint = umbilical->ReadEnd();\r\n```",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-17T23:29:08Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umblical = TokenPipe::create();\n+    if (!umblical) {\n+        return -1; // pipe or pip2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umblical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578017192",
      "id" : 578017192,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxNzE5Mg==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 58,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 38,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-17T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578017192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578235280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578235280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, will re-add an assertion.\r\nAll the error handling in `shutdown` consists of assertions but skipping it is a bad idea.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-18T08:52:18Z",
      "diff_hunk" : "@@ -24,25 +27,17 @@ std::mutex g_shutdown_mutex;\n std::condition_variable g_shutdown_cv;\n #else\n /** On UNIX-like operating systems use the self-pipe trick.\n- * Index 0 will be the read end of the pipe, index 1 the write end.\n  */\n-static int g_shutdown_pipe[2] = {-1, -1};\n+static TokenPipeEnd g_shutdown_r;\n+static TokenPipeEnd g_shutdown_w;\n #endif\n \n bool InitShutdownState()\n {\n #ifndef WIN32\n-#if HAVE_O_CLOEXEC\n-    // If we can, make sure that the file descriptors are closed on exec()\n-    // to prevent interference.\n-    if (pipe2(g_shutdown_pipe, O_CLOEXEC) != 0) {\n-        return false;\n-    }\n-#else\n-    if (pipe(g_shutdown_pipe) != 0) {\n-        return false;\n-    }\n-#endif\n+    std::optional<TokenPipe> pipe = TokenPipe::create();\n+    g_shutdown_r = pipe->ReadEnd();\n+    g_shutdown_w = pipe->WriteEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578235280",
      "id" : 578235280,
      "in_reply_to_id" : 578007134,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIzNTI4MA==",
      "original_commit_id" : "581f48d818e17bebe75e24c9d72029e4a0f2e8af",
      "original_line" : 40,
      "original_position" : 37,
      "original_start_line" : 38,
      "path" : "src/shutdown.cpp",
      "position" : 37,
      "pull_request_review_id" : 592976710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : 38,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-18T08:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578235280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578236272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578236272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I prefer having a variable here. Having a read as a side effect of an if() clause is kind of meh.\r\nWill change the `true`.",
      "commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "created_at" : "2021-02-18T08:53:52Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(1);\n+                        daemon_ep.Close();\n+                    }\n+                    break;\n+                case -1: // Error happened.\n+                    return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+                default: { // Parent: wait and exit.\n+                        int token = daemon_ep.TokenRead();\n+                        if (token == true) { // fRet == true, Success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578236272",
      "id" : 578236272,
      "in_reply_to_id" : 578013255,
      "line" : 207,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIzNjI3Mg==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 207,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 132,
      "pull_request_review_id" : 592978037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-18T08:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578236272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
