[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566343912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566343912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems pretty difficult to read. I think just locking cs_main at the top of the function, or asserting that it's held and making the callers lock cs_main fine would be more readable:\r\n\r\n```suggestion\r\n    LOCK(::cs_main);\r\n    return m_snapshot_chainstate && m_active_chainstate == m_snapshot_chainstate.get();\r\n```",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T19:14:14Z",
      "diff_hunk" : "@@ -5189,13 +5190,14 @@ CChainState& ChainstateManager::InitializeChainstate(CTxMemPool& mempool, const\n \n CChainState& ChainstateManager::ActiveChainstate() const\n {\n+    LOCK(::cs_main);\n     assert(m_active_chainstate);\n     return *m_active_chainstate;\n }\n \n bool ChainstateManager::IsSnapshotActive() const\n {\n-    return m_snapshot_chainstate && m_active_chainstate == m_snapshot_chainstate.get();\n+    return m_snapshot_chainstate && WITH_LOCK(::cs_main, return m_active_chainstate) == m_snapshot_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566343912",
      "id" : 566343912,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM0MzkxMg==",
      "original_commit_id" : "5b8118e0fd2a90ea650b10e1fdff1666cc711ae8",
      "original_line" : 5200,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578658925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566343912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566344838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566344838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't find these `// for m_active_chainstate access` comments very useful. This function is _only_ accessing `m_active_chainstate` so it's pretty obvious what the lock is for.",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T19:15:47Z",
      "diff_hunk" : "@@ -5143,6 +5143,7 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\n }\n \n Optional<uint256> ChainstateManager::SnapshotBlockhash() const {\n+    LOCK(::cs_main);  // for m_active_chainstate access",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566344838",
      "id" : 566344838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM0NDgzOA==",
      "original_commit_id" : "f92dc6557a153b390a1ae1d0808ff7ed5d02c66e",
      "original_line" : 5146,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578658925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566344838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566346742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566346742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, I think it's fine to hold this lock for the entirety of this function (in fact, the other ChainstateManager data members should be guarded by the same mutex).",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T19:18:49Z",
      "diff_hunk" : "@@ -5226,7 +5228,10 @@ void ChainstateManager::Reset()\n {\n     m_ibd_chainstate.reset();\n     m_snapshot_chainstate.reset();\n-    m_active_chainstate = nullptr;\n+    {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566346742",
      "id" : 566346742,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM0Njc0Mg==",
      "original_commit_id" : "f92dc6557a153b390a1ae1d0808ff7ed5d02c66e",
      "original_line" : 5232,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578658925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566346742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397476"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done!",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T20:49:20Z",
      "diff_hunk" : "@@ -5189,13 +5190,14 @@ CChainState& ChainstateManager::InitializeChainstate(CTxMemPool& mempool, const\n \n CChainState& ChainstateManager::ActiveChainstate() const\n {\n+    LOCK(::cs_main);\n     assert(m_active_chainstate);\n     return *m_active_chainstate;\n }\n \n bool ChainstateManager::IsSnapshotActive() const\n {\n-    return m_snapshot_chainstate && m_active_chainstate == m_snapshot_chainstate.get();\n+    return m_snapshot_chainstate && WITH_LOCK(::cs_main, return m_active_chainstate) == m_snapshot_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397476",
      "id" : 566397476,
      "in_reply_to_id" : 566343912,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM5NzQ3Ng==",
      "original_commit_id" : "5b8118e0fd2a90ea650b10e1fdff1666cc711ae8",
      "original_line" : 5200,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578728273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:49:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397561"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Removed!",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T20:49:29Z",
      "diff_hunk" : "@@ -5143,6 +5143,7 @@ double GuessVerificationProgress(const ChainTxData& data, const CBlockIndex *pin\n }\n \n Optional<uint256> ChainstateManager::SnapshotBlockhash() const {\n+    LOCK(::cs_main);  // for m_active_chainstate access",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397561",
      "id" : 566397561,
      "in_reply_to_id" : 566344838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM5NzU2MQ==",
      "original_commit_id" : "f92dc6557a153b390a1ae1d0808ff7ed5d02c66e",
      "original_line" : 5146,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578728405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:49:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done! Not 100% sure about the other members, we could do those in the future.",
      "commit_id" : "e6eb8d2bbbd32e5741c1dc1ef4c9cec7aac16b34",
      "created_at" : "2021-01-28T20:50:09Z",
      "diff_hunk" : "@@ -5226,7 +5228,10 @@ void ChainstateManager::Reset()\n {\n     m_ibd_chainstate.reset();\n     m_snapshot_chainstate.reset();\n-    m_active_chainstate = nullptr;\n+    {\n+        LOCK(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21025#discussion_r566397926",
      "id" : 566397926,
      "in_reply_to_id" : 566346742,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjM5NzkyNg==",
      "original_commit_id" : "f92dc6557a153b390a1ae1d0808ff7ed5d02c66e",
      "original_line" : 5232,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 578728862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-28T20:50:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566397926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
