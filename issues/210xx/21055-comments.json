[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21146 ([WIP] validation/coins: limit MemPoolAccept access to coins cache by glozow)\n* #21142 (fuzz: Add tx_pool fuzz target by MarcoFalke)\n* #21090 (Default to NODE_WITNESS in nLocalServices by dhruv)\n* #21062 (refactor: return MempoolAcceptResult from ATMP by glozow)\n* #21009 (Remove RewindBlockIndex logic by dhruv)\n* #21003 (test: Move MakeNoLogFileContext to libtest_util, and use it in bench by MarcoFalke)\n* #20750 ([Bundle 2/n] Prune g_chainman usage in mempool-related validation functions by dongcarl)\n* #20331 (allow -loadblock blocks to be unsorted by LarryRuane)\n* #19573 (Replace unused BIP 9 logic with draft BIP 8 by luke-jr)\n* #19438 (Introduce deploymentstatus by ajtowns)\n* #19259 (fuzz: Add fuzzing harness for LoadMempool(...) and DumpMempool(...) by practicalswift)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-01T23:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-771238834",
      "id" : 771238834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTIzODgzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T06:53:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771238834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568938343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568938343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Move LoadBlockIndexDB to CChainState\" (fa730f7a871c49072e2e899cefbc8275e5f67057)\r\n\r\nIt seems chainman variable wasn't really needed here, just the chainman.m_blockman member, so this might make more sense as a BlockManager method instead of CChainState method",
      "commit_id" : "f5ee2f37742da70d1731508e647dccd9b6035a7c",
      "created_at" : "2021-02-02T21:19:39Z",
      "diff_hunk" : "@@ -4112,11 +4112,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568938343",
      "id" : 568938343,
      "line" : 4121,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODkzODM0Mw==",
      "original_commit_id" : "fa730f7a871c49072e2e899cefbc8275e5f67057",
      "original_line" : 4115,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 568,
      "pull_request_review_id" : 581783245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-02T21:52:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568938343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568955284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568955284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Pass in spendheight to CTxMemPool::check\" (a765747415aebd432d5feffb6cb609be62e2592b)\r\n\r\nI think it would be nice to delete the BlockManager::GetSpendHeight method entirely instead of adding new calls to it. It's basically a one-line function returning height of active_coins_tip + 1, and it would seem more straightforward to pass active_coins_tip and active_coins_tip height together as arguments to the mempool check method (assuming the check method can't access the height directly) instead of the tip and an offset height.",
      "commit_id" : "f5ee2f37742da70d1731508e647dccd9b6035a7c",
      "created_at" : "2021-02-02T21:50:34Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568955284",
      "id" : 568955284,
      "line" : 3208,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk1NTI4NA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3208,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 29,
      "pull_request_review_id" : 581783245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-02T21:52:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568955284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572031775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572031775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This global was introduced by d23f6c6. At that commit, the global`VersionBitsTipState`'s unique caller`BIP9SoftForkDesc` didn't require `cs_main` locking. \r\n\r\nThose methods were refactored by 3862e47, where the new `BIP9SoftForkDescPushBack` did require the lock. I think since then this lock has been useless and could have been substituted by an annotation.\r\n\r\nSo not a concern to get rid of them.",
      "commit_id" : "f5ee2f37742da70d1731508e647dccd9b6035a7c",
      "created_at" : "2021-02-08T13:06:43Z",
      "diff_hunk" : "@@ -4973,24 +4973,6 @@ CBlockFileInfo* GetBlockFileInfo(size_t n)\n     return &vinfoBlockFile.at(n);\n }\n \n-ThresholdState VersionBitsTipState(const Consensus::Params& params, Consensus::DeploymentPos pos)\n-{\n-    LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572031775",
      "id" : 572031775,
      "line" : 4976,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjAzMTc3NQ==",
      "original_commit_id" : "a756ecb7bcf3ddc2ff86d2005b6556668f47f988",
      "original_line" : 4978,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 722,
      "pull_request_review_id" : 585478190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-08T13:30:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572031775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572046550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572046550"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't an assert be added here and before the following invocations ? The `CCoinsViewCache` pointer is used throughout `CTxMemPool::check.",
      "commit_id" : "f5ee2f37742da70d1731508e647dccd9b6035a7c",
      "created_at" : "2021-02-08T13:29:57Z",
      "diff_hunk" : "@@ -2243,7 +2243,9 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(&::ChainstateActive().CoinsTip());\n+    CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+    CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+    m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572046550",
      "id" : 572046550,
      "line" : 2248,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjA0NjU1MA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 2248,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 585478190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-08T13:30:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572046550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-11T14:04:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-777481629",
      "id" : 777481629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzQ4MTYyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T14:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777481629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
