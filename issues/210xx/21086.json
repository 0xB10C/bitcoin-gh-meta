{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "I think that I may have found a bug in ResetBlockFailureFlags.\r\nThe bug happens when there are two chains (say two blocks with blockheight 200) and a block before that fork will be invalidated (say blockheight 100).\r\nIf you then use ResetBlockFailureFlags to remove the failure flags from one of the two blocks at block height 200.\r\nResetBlockFailureFlags will remove the flags of all descendants and ancestors of the block 200 on one of the chains.\r\nBut for the block number 200 on the other chain and the following blocks the flags will not be removed.\r\nThe BLOCK_FAILED_CHILD flags remain for these blocks. But the BLOCK_FAILED_VALID flag of block 100 will be removed.\r\nThis can then produce a problem in CheckBlockIndex on line\r\n\r\nassert((pindex->nStatus & BLOCK_FAILED_MASK) == 0); // The failed mask cannot be set for blocks without invalid parents.\r\n\r\nMy fix searches for a BLOCK_FAILED_VALID flag and remembers the block index. It will then call ResetBlockFailureFlags for this block index again to remove the flags all all descendants.\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21086/comments",
   "created_at" : "2021-02-05T12:59:52Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21086/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/21086",
   "id" : 802145167,
   "labels" : [
      {
         "color" : "6060aa",
         "default" : false,
         "description" : null,
         "id" : 118379652,
         "name" : "Validation",
         "node_id" : "MDU6TGFiZWwxMTgzNzk2NTI=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Validation"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21086/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NTY4MzM3NjY3",
   "number" : 21086,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/21086.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21086",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/21086.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21086"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "ResetBlockFailureFlags did not remove the invalidity flag in other chain",
   "updated_at" : "2021-02-05T13:07:40Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21086",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/39898519?v=4",
      "events_url" : "https://api.github.com/users/WillyTheCat/events{/privacy}",
      "followers_url" : "https://api.github.com/users/WillyTheCat/followers",
      "following_url" : "https://api.github.com/users/WillyTheCat/following{/other_user}",
      "gists_url" : "https://api.github.com/users/WillyTheCat/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/WillyTheCat",
      "id" : 39898519,
      "login" : "WillyTheCat",
      "node_id" : "MDQ6VXNlcjM5ODk4NTE5",
      "organizations_url" : "https://api.github.com/users/WillyTheCat/orgs",
      "received_events_url" : "https://api.github.com/users/WillyTheCat/received_events",
      "repos_url" : "https://api.github.com/users/WillyTheCat/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/WillyTheCat/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/WillyTheCat/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/WillyTheCat"
   }
}
