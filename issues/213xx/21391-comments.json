[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21425 (refactor: Pass PeerManagerImpl members only once by MarcoFalke)\n* #21401 (Refactor versionbits deployments to avoid potential uninitialized variables by achow101)\n* #21393 (BIP 341: Add Speedy Trial activation parameters by achow101)\n* #21392 (Implement BIP 8 based Speedy Trial activation by achow101)\n* #21378 (Convert taproot to flag day activation by ajtowns)\n* #21245 (rpc: Add level 3 verbosity to getblock RPC call. by fyquah)\n* #21061 ([p2p] Introduce node rebroadcast module by amitiuttarwar)\n* #19521 (Coinstats Index by fjahr)\n* #19438 (Introduce deploymentstatus by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-09T04:25:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-793367260",
      "id" : 793367260,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzM2NzI2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-18T02:20:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793367260",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed a041676d3905002758a9c1827b410ea87d3329cf -> 6b89f537bad5fc3761ef3ada4cc5c9ac213c0ae6\r\n- Fixed assert linter complaint by using `CHECK_NONFATAL` instead of `assert`",
      "created_at" : "2021-03-09T17:40:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-794215591",
      "id" : 794215591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NDIxNTU5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T17:40:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/794215591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nðµï¸ @sipa @fjahr have been requested to review this pull request as specified in the REVIEWERS file.",
      "created_at" : "2021-03-15T16:49:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-799573816",
      "id" : 799573816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5OTU3MzgxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-15T16:49:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/799573816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(Needs rebase)",
      "created_at" : "2021-03-15T18:27:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-799649514",
      "id" : 799649514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5OTY0OTUxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-15T18:27:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/799649514",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 6b89f537bad5fc3761ef3ada4cc5c9ac213c0ae6 -> b57dc39eae25294071959b1eec42bd7dd5563357\r\n- Rebased over master\r\n- Prepended fixes to last bundle\r\n\r\n-----\r\n\r\nNote to reviewers:\r\n- I've made some changes in 5de3e3609ab591d88281558182efdec39b065541 that requires some attention, mostly I had to make decisions about default values of `getNumBlocks`, `isInitialBlockDownload`, `getUnspentOutput`, and `checkFinalTx` when our context doesn't contain a chainman\r\n- The commits before b7ed70dba191881d79fe71a746a2a826f40de884 should address the following posthumous reviews:\r\n  - From jnewbery:\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#issuecomment-796738048\r\n      - I didn't fix this one, but I added a `TODO` comment so that we don't lost track of it\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592291225\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592296942\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592299738\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592301704\r\n  - From MarcoFalke:\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r593096212\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r593097032\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r593097867\r\n    - https://github.com/bitcoin/bitcoin/pull/21270#discussion_r593100570\r\n\r\nI have also went through all my changes in the last bundle and ensured that we didn't miss any potential UB-introductions.\r\n\r\nA few explanations:\r\n\r\n1. https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592293190\r\nUnfortunately GetUTXOStats is fuzzed by constructing a `CCoinsView*` as an input, so this signature needs to remain.\r\n\r\n2. https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592299232\r\n100% agree that it's unnecessary, but going to leave it be for now since it'll be removed in the end if that's okay with folks.\r\n\r\n3. https://github.com/bitcoin/bitcoin/pull/21270#discussion_r592357247\r\nRight, it would most likely be better to take a local `const CChainstate&` once in places where we're already taking `cs_main`, let's do this in a followup!\r\n",
      "created_at" : "2021-03-17T21:24:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-801453063",
      "id" : 801453063,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTQ1MzA2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T21:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801453063",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Thanks for addressing review comments from the last bundle!",
      "created_at" : "2021-03-17T22:47:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-801491237",
      "id" : 801491237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTQ5MTIzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-17T22:47:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801491237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596598280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596598280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Can this be const?",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T07:05:43Z",
      "diff_hunk" : "@@ -146,6 +146,7 @@ class BlockAssembler\n     int64_t nLockTimeCutoff;\n     const CChainParams& chainparams;\n     const CTxMemPool& m_mempool;\n+    CChainState& m_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596598280",
      "id" : 596598280,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjU5ODI4MA==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 149,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : 4,
      "pull_request_review_id" : 615035498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596598280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "does it make sense to run a node without a chainman? It might make more sense to use Assert, like it is already done in `waitForNotificationsIfTipChanged`.\r\n\r\nMaybe the assert can even be wrapped into a private member:\r\n\r\n```\r\nprivate:\r\n ChainstateManager& chainman() { return *Assert(m_node.chainman); }",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T07:13:06Z",
      "diff_hunk" : "@@ -621,8 +651,13 @@ class ChainImpl : public Chain\n     }\n     bool isReadyToBroadcast() override { return !::fImporting && !::fReindex && !isInitialBlockDownload(); }\n     bool isInitialBlockDownload() override {\n-        assert(std::addressof(::ChainstateActive()) == std::addressof(m_node.chainman->ActiveChainstate()));\n-        return m_node.chainman->ActiveChainstate().IsInitialBlockDownload();\n+        const CChainState* active_chainstate;\n+        if (m_node.chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601383",
      "id" : 596601383,
      "line" : 655,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjYwMTM4Mw==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 655,
      "original_position" : 149,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 149,
      "pull_request_review_id" : 615035498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601776"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601776"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to assert before cs_main, because cs_main \"belongs\" to the chainman",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T07:13:56Z",
      "diff_hunk" : "@@ -39,6 +39,7 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n \n     { // cs_main scope\n     LOCK(cs_main);\n+    assert(node.chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601776",
      "id" : 596601776,
      "line" : 41,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjYwMTc3Ng==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 41,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : 4,
      "pull_request_review_id" : 615035498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601776",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to assert before cs_main, because cs_main \"belongs\" to the chainman",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T07:14:11Z",
      "diff_hunk" : "@@ -12,6 +12,7 @@ void FindCoins(const NodeContext& node, std::map<COutPoint, Coin>& coins)\n {\n     assert(node.mempool);\n     LOCK2(cs_main, node.mempool->cs);\n+    assert(node.chainman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601876",
      "id" : 596601876,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjYwMTg3Ng==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/coin.cpp",
      "position" : 4,
      "pull_request_review_id" : 615035498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596601876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-18T09:37:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-801774683",
      "id" : 801774683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwMTc3NDY4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-18T09:37:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/801774683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597026552"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597026552"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just remove this section marker.",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:12:56Z",
      "diff_hunk" : "@@ -474,21 +474,81 @@ class PeerManagerImpl final : public PeerManager\n     /** Offset into vExtraTxnForCompact to insert the next tx */\n     size_t vExtraTxnForCompactIt GUARDED_BY(g_cs_orphans) = 0;\n \n+    /** Check whether the last unknown block a peer advertised is not yet known. */\n     void ProcessBlockAvailability(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    /** Update tracking information about which blocks a peer is assumed to have. */\n     void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     bool CanDirectFetch(const Consensus::Params &consensusParams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    //////////////////////////////////////////////////////////////////////////////\n+    //\n+    // blockchain -> download logic notification\n+    //",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597026552",
      "id" : 597026552,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAyNjU1Mg==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 486,
      "original_position" : 13,
      "original_start_line" : 483,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597026552",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597027186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597027186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps make this a doxygen comment (ie start with `/**`)",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:13:24Z",
      "diff_hunk" : "@@ -474,21 +474,81 @@ class PeerManagerImpl final : public PeerManager\n     /** Offset into vExtraTxnForCompact to insert the next tx */\n     size_t vExtraTxnForCompactIt GUARDED_BY(g_cs_orphans) = 0;\n \n+    /** Check whether the last unknown block a peer advertised is not yet known. */\n     void ProcessBlockAvailability(NodeId nodeid) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    /** Update tracking information about which blocks a peer is assumed to have. */\n     void UpdateBlockAvailability(NodeId nodeid, const uint256 &hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     bool CanDirectFetch(const Consensus::Params &consensusParams) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+\n+    //////////////////////////////////////////////////////////////////////////////\n+    //\n+    // blockchain -> download logic notification\n+    //\n+\n+    // To prevent fingerprinting attacks, only send blocks/headers outside of the\n+    // active chain if they are no more than a month older (both in time, and in\n+    // best equivalent proof of work) than the best header chain we know about and\n+    // we fully-validated them at some point.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597027186",
      "id" : 597027186,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAyNzE4Ng==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 491,
      "original_position" : 18,
      "original_start_line" : 488,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597027186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597027762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597027762"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove this extra blank line? :grimacing: ",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:13:52Z",
      "diff_hunk" : "@@ -1185,15 +1243,6 @@ bool PeerManagerImpl::MaybePunishNodeForTx(NodeId nodeid, const TxValidationStat\n }\n \n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597027762",
      "id" : 597027762,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAyNzc2Mg==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 1245,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597027762",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597029360"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597029360"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it'd be just as clear (and a smaller diff) to invert the conditional here:\r\n\r\n```suggestion\r\n        if (!m_context->chainman) return 0;\r\n        // Logic that uses chainman ...\r\n```",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:15:09Z",
      "diff_hunk" : "@@ -182,38 +182,51 @@ class NodeImpl : public Node\n     }\n     int getNumBlocks() override\n     {\n-        LOCK(::cs_main);\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        return m_context->chainman->ActiveChain().Height();\n+        if (m_context->chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597029360",
      "id" : 597029360,
      "line" : 185,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAyOTM2MA==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 185,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 7,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597029360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597029921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597029921"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same here. You don't need this local variable if you exit early when `chainman` doesn't exist.",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:15:35Z",
      "diff_hunk" : "@@ -182,38 +182,51 @@ class NodeImpl : public Node\n     }\n     int getNumBlocks() override\n     {\n-        LOCK(::cs_main);\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        return m_context->chainman->ActiveChain().Height();\n+        if (m_context->chainman) {\n+            LOCK(::cs_main);\n+            assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n+            return m_context->chainman->ActiveChain().Height();\n+        }\n+        return 0;\n     }\n     uint256 getBestBlockHash() override\n     {\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        const CBlockIndex* tip = WITH_LOCK(::cs_main, return m_context->chainman->ActiveChain().Tip());\n+        const CBlockIndex* tip;\n+        if (m_context->chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597029921",
      "id" : 597029921,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAyOTkyMQ==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 195,
      "original_position" : 19,
      "original_start_line" : 194,
      "path" : "src/node/interfaces.cpp",
      "position" : 19,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : 194,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597029921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597035062"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597035062"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason not to just do this? The function is obviously const since it just does a lookup and returns a pointer.",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:19:32Z",
      "diff_hunk" : "@@ -457,6 +457,7 @@ class BlockManager\n         const CChainParams& chainparams,\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    // TODO: Change this to a const function",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597035062",
      "id" : 597035062,
      "line" : 460,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAzNTA2Mg==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 460,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597035062",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597038927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597038927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe join these lines?",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:22:34Z",
      "diff_hunk" : "@@ -398,7 +399,8 @@ static RPCHelpMan getdifficulty()\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n     LOCK(cs_main);\n-    return GetDifficulty(::ChainActive().Tip());\n+    CChain& active_chain = EnsureChainman(request.context).ActiveChain();\n+    return GetDifficulty(active_chain.Tip());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597038927",
      "id" : 597038927,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzAzODkyNw==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 403,
      "original_position" : 32,
      "original_start_line" : 402,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597038927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597040349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597040349"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const CChain& active_chain = EnsureChainman(request.context).ActiveChain();\r\n```\r\n\r\n(same goes for other `CChain&`s)",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:23:43Z",
      "diff_hunk" : "@@ -763,12 +765,13 @@ static RPCHelpMan getblockhash()\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n     LOCK(cs_main);\n+    CChain& active_chain = EnsureChainman(request.context).ActiveChain();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597040349",
      "id" : 597040349,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzA0MDM0OQ==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 768,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597040349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597067215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597067215"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It would be nice to avoid so many repeated locks and releases of cs_main. In this function we take it at least 5 times:\r\n\r\n- in `EnsureChainman()`\r\n- in `ActiveChainstate()`\r\n- in `ForceFlushStateToDisk()`\r\n- in `WITH_LOCK(::cs_main, return &active_chainstate.CoinsDB());`\r\n- in `WITH_LOCK(::cs_main, return std::ref(active_chainstate.m_blockman));`\r\n\r\nthis gets rid of one unnecessary lock/release:\r\n\r\n```\r\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\r\nindex aa1164ae29..941b2bf780 100644\r\n--- a/src/rpc/blockchain.cpp\r\n+++ b/src/rpc/blockchain.cpp\r\n@@ -1080,10 +1080,15 @@ static RPCHelpMan gettxoutsetinfo()\r\n \r\n     const CoinStatsHashType hash_type{request.params[0].isNull() ? CoinStatsHashType::HASH_SERIALIZED : ParseHashType(request.params[0].get_str())};\r\n \r\n-    CCoinsView* coins_view = WITH_LOCK(::cs_main, return &active_chainstate.CoinsDB());\r\n-    BlockManager& blockman = WITH_LOCK(::cs_main, return std::ref(active_chainstate.m_blockman));\r\n+    CCoinsView* coins_view;\r\n+    BlockManager* blockman;\r\n+    {\r\n+        LOCK(::cs_main);\r\n+        coins_view = &active_chainstate.CoinsDB();\r\n+        blockman = &active_chainstate.m_blockman;\r\n+    }\r\n     NodeContext& node = EnsureNodeContext(request.context);\r\n-    if (GetUTXOStats(coins_view, blockman, stats, hash_type, node.rpc_interruption_point)) {\r\n+    if (GetUTXOStats(coins_view, *blockman, stats, hash_type, node.rpc_interruption_point)) {\r\n         ret.pushKV(\"height\", (int64_t)stats.nHeight);\r\n         ret.pushKV(\"bestblock\", stats.hashBlock.GetHex());\r\n         ret.pushKV(\"transactions\", (int64_t)stats.nTransactions);\r\n```",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:54:40Z",
      "diff_hunk" : "@@ -1069,13 +1075,15 @@ static RPCHelpMan gettxoutsetinfo()\n     UniValue ret(UniValue::VOBJ);\n \n     CCoinsStats stats;\n-    ::ChainstateActive().ForceFlushStateToDisk();\n+    CChainState& active_chainstate = EnsureChainman(request.context).ActiveChainstate();\n+    active_chainstate.ForceFlushStateToDisk();\n \n     const CoinStatsHashType hash_type{request.params[0].isNull() ? CoinStatsHashType::HASH_SERIALIZED : ParseHashType(request.params[0].get_str())};\n \n-    CCoinsView* coins_view = WITH_LOCK(::cs_main, return &::ChainstateActive().CoinsDB());\n+    CCoinsView* coins_view = WITH_LOCK(::cs_main, return &active_chainstate.CoinsDB());\n+    BlockManager& blockman = WITH_LOCK(::cs_main, return std::ref(active_chainstate.m_blockman));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597067215",
      "id" : 597067215,
      "line" : 1083,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzA2NzIxNQ==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 1083,
      "original_position" : 125,
      "original_start_line" : 1083,
      "path" : "src/rpc/blockchain.cpp",
      "position" : 124,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : 1082,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597067215",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597069682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597069682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you declare this further up and use it instead of `(int)chainman.ActiveChain().Height())` for `\"blocks\"`?",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T16:57:27Z",
      "diff_hunk" : "@@ -1358,14 +1369,15 @@ RPCHelpMan getblockchaininfo()\n     }\n \n     const Consensus::Params& consensusParams = Params().GetConsensus();\n+    int active_tip_nheight = tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597069682",
      "id" : 597069682,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzA2OTY4Mg==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 1372,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597069682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597096912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597096912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think just `height` here probably suffices:\r\n\r\n```suggestion\r\n    const int height = tip->nHeight;\r\n```",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T17:31:58Z",
      "diff_hunk" : "@@ -1358,14 +1369,15 @@ RPCHelpMan getblockchaininfo()\n     }\n \n     const Consensus::Params& consensusParams = Params().GetConsensus();\n+    int active_tip_nheight = tip->nHeight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597096912",
      "id" : 597096912,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzA5NjkxMg==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 1372,
      "original_position" : 232,
      "original_start_line" : null,
      "path" : "src/rpc/blockchain.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597096912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597103258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597103258"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    CBlockIndex* pb = active_chain.Tip();\r\n```\r\n\r\n(could also make this const if you update line 65 to make `pb0` const too)",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T17:40:08Z",
      "diff_hunk" : "@@ -44,11 +44,12 @@\n  * or from the last difficulty change if 'lookup' is nonpositive.\n  * If 'height' is nonnegative, compute the estimate at the time when a given block was found.\n  */\n-static UniValue GetNetworkHashPS(int lookup, int height) {\n-    CBlockIndex *pb = ::ChainActive().Tip();\n+static UniValue GetNetworkHashPS(int lookup, int height, CChain& active_chain) {\n+    CBlockIndex *pb = active_chain.Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597103258",
      "id" : 597103258,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzEwMzI1OA==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 48,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/rpc/mining.cpp",
      "position" : null,
      "pull_request_review_id" : 615597960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597103258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597163828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597163828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/interfaces: Meaningful locking and avoid potential UB\" (5de3e3609ab591d88281558182efdec39b065541)\r\n\r\nIt seems like this method and the two IBD methods are the only places that are changing locks or adding \"meaningful locking\". Since locking changes can have unexpected pitfalls I think it'd be good to split the locking parts of this commit into a separate commit. Also would be good to expand the commit message to say what's motivating the lock changes. I'm assuming it's to satisfy some lock annotations later?",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T19:07:16Z",
      "diff_hunk" : "@@ -182,38 +182,51 @@ class NodeImpl : public Node\n     }\n     int getNumBlocks() override\n     {\n-        LOCK(::cs_main);\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        return m_context->chainman->ActiveChain().Height();\n+        if (m_context->chainman) {\n+            LOCK(::cs_main);\n+            assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n+            return m_context->chainman->ActiveChain().Height();\n+        }\n+        return 0;\n     }\n     uint256 getBestBlockHash() override\n     {\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        const CBlockIndex* tip = WITH_LOCK(::cs_main, return m_context->chainman->ActiveChain().Tip());\n+        const CBlockIndex* tip;\n+        if (m_context->chainman) {\n+            LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597163828",
      "id" : 597163828,
      "line" : 196,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzE2MzgyOA==",
      "original_commit_id" : "5de3e3609ab591d88281558182efdec39b065541",
      "original_line" : 196,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/node/interfaces.cpp",
      "position" : 20,
      "pull_request_review_id" : 615771075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597163828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597167838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597167838"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"node/interfaces: Meaningful locking and avoid potential UB\" (5de3e3609ab591d88281558182efdec39b065541)\r\n\r\n> Same here. You don't need this local variable if you exit early when `chainman` doesn't exist.\r\n\r\nI think John's suggestions are good, but Marco's suggestion to use an accessor that asserts https://github.com/bitcoin/bitcoin/pull/21391#discussion_r596601383 would be even better. That way we don't need to waste brain cells thinking about what values to return if chainman is null. Like if getBestBlockHash returns the genesis block hash in that case should getNumBlocks return 1 instead of 0 to be consistent? Easier to take everything down and assert.\r\n",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-18T19:13:42Z",
      "diff_hunk" : "@@ -182,38 +182,51 @@ class NodeImpl : public Node\n     }\n     int getNumBlocks() override\n     {\n-        LOCK(::cs_main);\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        return m_context->chainman->ActiveChain().Height();\n+        if (m_context->chainman) {\n+            LOCK(::cs_main);\n+            assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n+            return m_context->chainman->ActiveChain().Height();\n+        }\n+        return 0;\n     }\n     uint256 getBestBlockHash() override\n     {\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        const CBlockIndex* tip = WITH_LOCK(::cs_main, return m_context->chainman->ActiveChain().Tip());\n+        const CBlockIndex* tip;\n+        if (m_context->chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597167838",
      "id" : 597167838,
      "in_reply_to_id" : 597029921,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzE2NzgzOA==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 195,
      "original_position" : 19,
      "original_start_line" : 194,
      "path" : "src/node/interfaces.cpp",
      "position" : 19,
      "pull_request_review_id" : 615771075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : 194,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597167838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597546794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597546794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems reasonable to me!\r\n\r\nIn general, I like the concept of making all components optional, since it enforces decoupling. However, it's hard to imagine what a bitcoind without chainman would look like.",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-19T10:02:04Z",
      "diff_hunk" : "@@ -182,38 +182,51 @@ class NodeImpl : public Node\n     }\n     int getNumBlocks() override\n     {\n-        LOCK(::cs_main);\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        return m_context->chainman->ActiveChain().Height();\n+        if (m_context->chainman) {\n+            LOCK(::cs_main);\n+            assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n+            return m_context->chainman->ActiveChain().Height();\n+        }\n+        return 0;\n     }\n     uint256 getBestBlockHash() override\n     {\n-        assert(std::addressof(::ChainActive()) == std::addressof(m_context->chainman->ActiveChain()));\n-        const CBlockIndex* tip = WITH_LOCK(::cs_main, return m_context->chainman->ActiveChain().Tip());\n+        const CBlockIndex* tip;\n+        if (m_context->chainman) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r597546794",
      "id" : 597546794,
      "in_reply_to_id" : 597029921,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NzU0Njc5NA==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 195,
      "original_position" : 19,
      "original_start_line" : 194,
      "path" : "src/node/interfaces.cpp",
      "position" : 19,
      "pull_request_review_id" : 616236077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : 194,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/597546794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r600690395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600690395"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Unfortunately not... We pass `m_chainstate` to `TestBlockValidity` in `BlockAssembler::CreateNewBlock`, and `TestBlockValidity` requires its `CChainState` param to be non-const",
      "commit_id" : "877c8a01fc1137e0c8187b0b6990a99658077152",
      "created_at" : "2021-03-24T17:10:50Z",
      "diff_hunk" : "@@ -146,6 +146,7 @@ class BlockAssembler\n     int64_t nLockTimeCutoff;\n     const CChainParams& chainparams;\n     const CTxMemPool& m_mempool;\n+    CChainState& m_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#discussion_r600690395",
      "id" : 600690395,
      "in_reply_to_id" : 596598280,
      "line" : 149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDY5MDM5NQ==",
      "original_commit_id" : "b57dc39eae25294071959b1eec42bd7dd5563357",
      "original_line" : 149,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : 4,
      "pull_request_review_id" : 620000104,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21391",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-24T17:54:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600690395",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed b57dc39eae25294071959b1eec42bd7dd5563357 -> 877c8a01fc1137e0c8187b0b6990a99658077152\r\n- Addressed some review suggestions\r\n- Note: this is not yet rebased",
      "created_at" : "2021-03-24T17:58:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-806039178",
      "id" : 806039178,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjAzOTE3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T17:58:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806039178",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 877c8a01fc1137e0c8187b0b6990a99658077152 -> b7833034a554b571b3d3e3e55a0639421770dfb9\r\n- Rebased on top of #21525\r\n- Addressed all reviews",
      "created_at" : "2021-03-24T20:30:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-806166717",
      "id" : 806166717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjE2NjcxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T20:30:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806166717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed b7833034a554b571b3d3e3e55a0639421770dfb9 -> 677b836c4847315bf24a9d222bbb2eb23a2b9a2c\r\n- Use `CHECK_NONFATAL` instead of assert",
      "created_at" : "2021-03-24T20:39:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21391#issuecomment-806171889",
      "id" : 806171889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21391",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjE3MTg4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T20:39:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806171889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   }
]
