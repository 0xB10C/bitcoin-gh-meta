[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585212906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585212906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Passing a copy of the entire cache seems overkill here, and especially without std::move's you're going to be making copies in every step in the call graph.\r\n\r\nThe language purist version would be `std::optional<std::reference_wrapper<const DescriptorCache>>` to achieve something like an optional reference to a const cache. But just `const DescriptorCache*` works just as well...",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-02T03:03:06Z",
      "diff_hunk" : "@@ -410,7 +411,7 @@ class BIP32PubkeyProvider final : public PubkeyProvider\n         }\n         return true;\n     }\n-    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv) const override\n+    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv, std::optional<DescriptorCache> cache) const override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585212906",
      "id" : 585212906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIxMjkwNg==",
      "original_commit_id" : "c096de409861f2c90cb08540e11e872882b576c1",
      "original_line" : 414,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : null,
      "pull_request_review_id" : 601364737,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-10T17:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585212906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585213867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585213867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Argh, I meant to click comment, not approve...",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-02T03:06:07Z",
      "diff_hunk" : "@@ -410,7 +411,7 @@ class BIP32PubkeyProvider final : public PubkeyProvider\n         }\n         return true;\n     }\n-    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv) const override\n+    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv, std::optional<DescriptorCache> cache) const override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585213867",
      "id" : 585213867,
      "in_reply_to_id" : 585212906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIxMzg2Nw==",
      "original_commit_id" : "c096de409861f2c90cb08540e11e872882b576c1",
      "original_line" : 414,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : null,
      "pull_request_review_id" : 601365839,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-10T17:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585213867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21365 (Basic Taproot signing support for descriptor wallets by sipa)\n* #21331 (rpc: replace wallet raw pointers with references (#18592 rebased) by fanquake)\n* #21238 (A few descriptor improvements to prepare for Taproot support by sipa)\n* #20096 (wallet: Remove WalletDatabase refcounting and enforce only one Batch access the database at a time by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-02T10:11:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#issuecomment-788791440",
      "id" : 788791440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21329",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODc5MTQ0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-06T08:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788791440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585792052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585792052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-02T18:06:11Z",
      "diff_hunk" : "@@ -410,7 +411,7 @@ class BIP32PubkeyProvider final : public PubkeyProvider\n         }\n         return true;\n     }\n-    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv) const override\n+    bool ToNormalizedString(const SigningProvider& arg, std::string& out, bool priv, std::optional<DescriptorCache> cache) const override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r585792052",
      "id" : 585792052,
      "in_reply_to_id" : 585212906,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTc5MjA1Mg==",
      "original_commit_id" : "c096de409861f2c90cb08540e11e872882b576c1",
      "original_line" : 414,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : null,
      "pull_request_review_id" : 602114637,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-10T17:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585792052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Started reviewing this",
      "created_at" : "2021-03-09T07:55:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#issuecomment-793505411",
      "id" : 793505411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21329",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzUwNTQxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-09T07:55:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793505411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-10T07:33:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#issuecomment-795023638",
      "id" : 795023638,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21329",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NTAyMzYzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-10T07:33:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/795023638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r591236020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591236020"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think it would be nice to simply this function by extracting the code for splitting KeyPath. We can introduce a member function like:\r\n```cpp\r\nstd::pair<KeyPath, KeyPath> KeyPath::split_unhardened() const;\r\n```\r\nor \r\n```cpp\r\nKeyPath KeyPath::split_unhardened();\r\n```",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-10T08:58:48Z",
      "diff_hunk" : "@@ -432,29 +432,39 @@ class BIP32PubkeyProvider final : public PubkeyProvider\n             out = ToString();\n             return true;\n         }\n-        // Derive the xpub at the last hardened step\n-        CExtKey xprv;\n-        if (!GetExtKey(arg, xprv)) return false;\n+        // Get the path to the last hardened stup\n         KeyOriginInfo origin;\n         int k = 0;\n         for (; k <= i; ++k) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r591236020",
      "id" : 591236020,
      "line" : 438,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MTIzNjAyMA==",
      "original_commit_id" : "0ab914a06b26158be5bf3e09eb5988ab0a4a0915",
      "original_line" : 438,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 126,
      "pull_request_review_id" : 607157872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T17:31:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/591236020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r592135979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592135979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why not pass it as const reference? It can help to remove some of the checks and we can always relax the requirements and make it optional later if needed.",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-11T07:55:57Z",
      "diff_hunk" : "@@ -110,7 +110,7 @@ struct Descriptor {\n     virtual bool ToPrivateString(const SigningProvider& provider, std::string& out) const = 0;\n \n     /** Convert the descriptor to a normalized string. Normalized descriptors have the xpub at the last hardened step. This fails if the provided provider does not have the private keys to derive that xpub. */\n-    virtual bool ToNormalizedString(const SigningProvider& provider, std::string& out, bool priv) const = 0;\n+    virtual bool ToNormalizedString(const SigningProvider& provider, std::string& out, bool priv, const DescriptorCache* cache = nullptr) const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r592135979",
      "id" : 592135979,
      "line" : 113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjEzNTk3OQ==",
      "original_commit_id" : "690160aac9e8054cdc303086f02bb373ff481bd9",
      "original_line" : 113,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/descriptor.h",
      "position" : 40,
      "pull_request_review_id" : 607157872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T17:31:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592135979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593929906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593929906"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I can't see how this ever evaluates to `true` since we exit early if the cache exists.",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T16:57:08Z",
      "diff_hunk" : "@@ -2291,3 +2291,43 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n+{\n+    LOCK(cs_desc_man);\n+    if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n+        return;\n+    }\n+\n+    // Skip if we have the last hardened xpub cache\n+    if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKeys().size() > 0) {\n+        return;\n+    }\n+\n+    // Expand the descriptor\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+    FlatSigningProvider out_keys;\n+    std::vector<CScript> scripts_temp;\n+    DescriptorCache temp_cache;\n+    if (!m_wallet_descriptor.descriptor->Expand(0, provider, scripts_temp, out_keys, &temp_cache)){\n+        throw std::runtime_error(\"Unable to expand descriptor\");\n+    }\n+\n+    // Cache the last hardened xpubs\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (const auto& lh_xpub_pair : temp_cache.GetCachedLastHardenedExtPubKeys()) {\n+        CExtPubKey xpub;\n+        if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKey(lh_xpub_pair.first, xpub)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593929906",
      "id" : 593929906,
      "line" : 2319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkyOTkwNg==",
      "original_commit_id" : "8c5d41f40c65b4c9fc691d4f4b070c551d112995",
      "original_line" : 2322,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 61,
      "pull_request_review_id" : 607157872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T17:31:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593929906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593933030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593933030"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why do we need a temp cache? ",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T17:20:07Z",
      "diff_hunk" : "@@ -2291,3 +2291,43 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n+{\n+    LOCK(cs_desc_man);\n+    if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n+        return;\n+    }\n+\n+    // Skip if we have the last hardened xpub cache\n+    if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKeys().size() > 0) {\n+        return;\n+    }\n+\n+    // Expand the descriptor\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+    FlatSigningProvider out_keys;\n+    std::vector<CScript> scripts_temp;\n+    DescriptorCache temp_cache;\n+    if (!m_wallet_descriptor.descriptor->Expand(0, provider, scripts_temp, out_keys, &temp_cache)){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593933030",
      "id" : 593933030,
      "line" : 2310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkzMzAzMA==",
      "original_commit_id" : "8c5d41f40c65b4c9fc691d4f4b070c551d112995",
      "original_line" : 2313,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 51,
      "pull_request_review_id" : 607157872,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T17:31:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593933030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593938969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593938969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not every caller of this will necessarily have a cache to pass.",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T18:07:33Z",
      "diff_hunk" : "@@ -110,7 +110,7 @@ struct Descriptor {\n     virtual bool ToPrivateString(const SigningProvider& provider, std::string& out) const = 0;\n \n     /** Convert the descriptor to a normalized string. Normalized descriptors have the xpub at the last hardened step. This fails if the provided provider does not have the private keys to derive that xpub. */\n-    virtual bool ToNormalizedString(const SigningProvider& provider, std::string& out, bool priv) const = 0;\n+    virtual bool ToNormalizedString(const SigningProvider& provider, std::string& out, bool priv, const DescriptorCache* cache = nullptr) const = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593938969",
      "id" : 593938969,
      "in_reply_to_id" : 592135979,
      "line" : 113,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkzODk2OQ==",
      "original_commit_id" : "690160aac9e8054cdc303086f02bb373ff481bd9",
      "original_line" : 113,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/descriptor.h",
      "position" : 40,
      "pull_request_review_id" : 611722652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T18:07:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593938969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't follow.\r\n\r\nThis is checking to see if elements in the temp cache are in the stored cache;",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T18:10:47Z",
      "diff_hunk" : "@@ -2291,3 +2291,43 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n+{\n+    LOCK(cs_desc_man);\n+    if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n+        return;\n+    }\n+\n+    // Skip if we have the last hardened xpub cache\n+    if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKeys().size() > 0) {\n+        return;\n+    }\n+\n+    // Expand the descriptor\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+    FlatSigningProvider out_keys;\n+    std::vector<CScript> scripts_temp;\n+    DescriptorCache temp_cache;\n+    if (!m_wallet_descriptor.descriptor->Expand(0, provider, scripts_temp, out_keys, &temp_cache)){\n+        throw std::runtime_error(\"Unable to expand descriptor\");\n+    }\n+\n+    // Cache the last hardened xpubs\n+    WalletBatch batch(m_storage.GetDatabase());\n+    uint256 id = GetID();\n+    for (const auto& lh_xpub_pair : temp_cache.GetCachedLastHardenedExtPubKeys()) {\n+        CExtPubKey xpub;\n+        if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKey(lh_xpub_pair.first, xpub)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939354",
      "id" : 593939354,
      "in_reply_to_id" : 593929906,
      "line" : 2319,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkzOTM1NA==",
      "original_commit_id" : "8c5d41f40c65b4c9fc691d4f4b070c551d112995",
      "original_line" : 2322,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 61,
      "pull_request_review_id" : 611722935,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T18:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To avoid modifying the wallet state if something goes wrong during expansion. It is possible that the cache could be modified, but something else causes expansion to fail.",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T18:12:13Z",
      "diff_hunk" : "@@ -2291,3 +2291,43 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out, bool priv)\n \n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, priv);\n }\n+\n+void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n+{\n+    LOCK(cs_desc_man);\n+    if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n+        return;\n+    }\n+\n+    // Skip if we have the last hardened xpub cache\n+    if (m_wallet_descriptor.cache.GetCachedLastHardenedExtPubKeys().size() > 0) {\n+        return;\n+    }\n+\n+    // Expand the descriptor\n+    FlatSigningProvider provider;\n+    provider.keys = GetKeys();\n+    FlatSigningProvider out_keys;\n+    std::vector<CScript> scripts_temp;\n+    DescriptorCache temp_cache;\n+    if (!m_wallet_descriptor.descriptor->Expand(0, provider, scripts_temp, out_keys, &temp_cache)){",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939497",
      "id" : 593939497,
      "in_reply_to_id" : 593933030,
      "line" : 2310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkzOTQ5Nw==",
      "original_commit_id" : "8c5d41f40c65b4c9fc691d4f4b070c551d112995",
      "original_line" : 2313,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : 51,
      "pull_request_review_id" : 611723061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T18:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that's really necessary since we only do the split in this one spot.",
      "commit_id" : "1cb501721ecbd2e3a86f16f4ed9db4cf8ac6ba3f",
      "created_at" : "2021-03-14T18:14:27Z",
      "diff_hunk" : "@@ -432,29 +432,39 @@ class BIP32PubkeyProvider final : public PubkeyProvider\n             out = ToString();\n             return true;\n         }\n-        // Derive the xpub at the last hardened step\n-        CExtKey xprv;\n-        if (!GetExtKey(arg, xprv)) return false;\n+        // Get the path to the last hardened stup\n         KeyOriginInfo origin;\n         int k = 0;\n         for (; k <= i; ++k) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21329#discussion_r593939739",
      "id" : 593939739,
      "in_reply_to_id" : 591236020,
      "line" : 438,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MzkzOTczOQ==",
      "original_commit_id" : "0ab914a06b26158be5bf3e09eb5988ab0a4a0915",
      "original_line" : 438,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 126,
      "pull_request_review_id" : 611723254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21329",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-14T18:14:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593939739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   }
]
