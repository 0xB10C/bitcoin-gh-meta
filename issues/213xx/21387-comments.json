[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-03-08T11:20:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#issuecomment-792687216",
      "id" : 792687216,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21387",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MjY4NzIxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-08T11:20:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/792687216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589351441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589351441"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note to reviewers: this old code was inconsistent with the events it requested depending on which function was used - it requested \"in\" or \"out\" (`POLLIN | POLLOUT`) when using `poll()` but only \"out\" when using `select()` (did not pass `fdset` as 2'nd arg to `select()`).\r\n\r\nThis is now replaced by `Sock::Wait(..., requested Sock::RECV | Sock::SEND)` which, if ends up calling `select()`, will ask it for both \"in\" and \"out\".\r\n\r\nI think this is ok.",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T11:23:56Z",
      "diff_hunk" : "@@ -642,46 +642,34 @@ bool ConnectSocketDirectly(const CService &addrConnect, const SOCKET& hSocket, i\n             // Connection didn't actually fail, but is being established\n             // asynchronously. Thus, use async I/O api (select/poll)\n             // synchronously to check for successful connection with a timeout.\n-#ifdef USE_POLL\n-            struct pollfd pollfd = {};\n-            pollfd.fd = hSocket;\n-            pollfd.events = POLLIN | POLLOUT;\n-            int nRet = poll(&pollfd, 1, nTimeout);\n-#else\n-            struct timeval timeout = MillisToTimeval(nTimeout);\n-            fd_set fdset;\n-            FD_ZERO(&fdset);\n-            FD_SET(hSocket, &fdset);\n-            int nRet = select(hSocket + 1, nullptr, &fdset, nullptr, &timeout);\n-#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589351441",
      "id" : 589351441,
      "line" : 656,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM1MTQ0MQ==",
      "original_commit_id" : "d59cb9b3d335d122fc2865e5e0334e32ef92b3e7",
      "original_line" : 656,
      "original_position" : 48,
      "original_start_line" : 645,
      "path" : "src/netbase.cpp",
      "position" : 48,
      "pull_request_review_id" : 606194599,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "LEFT",
      "start_line" : 645,
      "start_side" : "LEFT",
      "updated_at" : "2021-03-08T12:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589351441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589358838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589358838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit in the first commit: Wouldn't it be better to change `private` to `protected`? This would allow other tests to mock `m_socket` without having to enumerate all \"friend\" test classes here",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T11:37:43Z",
      "diff_hunk" : "@@ -155,6 +155,8 @@ class Sock\n      * Contained socket. `INVALID_SOCKET` designates the object is empty.\n      */\n     SOCKET m_socket;\n+\n+    friend class FuzzedSock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589358838",
      "id" : 589358838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM1ODgzOA==",
      "original_commit_id" : "ed7af727d36734874234d30a8f02cdb8506cef55",
      "original_line" : 159,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/util/sock.h",
      "position" : null,
      "pull_request_review_id" : 606203859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-08T12:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589358838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589360815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589360815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it might be good to split the non-fuzz \"refactors\" out into their own pull",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T11:41:33Z",
      "diff_hunk" : "@@ -642,46 +642,34 @@ bool ConnectSocketDirectly(const CService &addrConnect, const SOCKET& hSocket, i\n             // Connection didn't actually fail, but is being established\n             // asynchronously. Thus, use async I/O api (select/poll)\n             // synchronously to check for successful connection with a timeout.\n-#ifdef USE_POLL\n-            struct pollfd pollfd = {};\n-            pollfd.fd = hSocket;\n-            pollfd.events = POLLIN | POLLOUT;\n-            int nRet = poll(&pollfd, 1, nTimeout);\n-#else\n-            struct timeval timeout = MillisToTimeval(nTimeout);\n-            fd_set fdset;\n-            FD_ZERO(&fdset);\n-            FD_SET(hSocket, &fdset);\n-            int nRet = select(hSocket + 1, nullptr, &fdset, nullptr, &timeout);\n-#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589360815",
      "id" : 589360815,
      "in_reply_to_id" : 589351441,
      "line" : 656,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM2MDgxNQ==",
      "original_commit_id" : "d59cb9b3d335d122fc2865e5e0334e32ef92b3e7",
      "original_line" : 656,
      "original_position" : 48,
      "original_start_line" : 645,
      "path" : "src/netbase.cpp",
      "position" : 48,
      "pull_request_review_id" : 606203859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "LEFT",
      "start_line" : 645,
      "start_side" : "LEFT",
      "updated_at" : "2021-03-08T12:41:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589360815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589393703"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393703"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Lets see which are the non-fuzz refactors:\r\n\r\n```\r\n[7] i2p: add fuzz tests on the I2P Session public interface\r\n[6] i2p: use pointers to Sock to accommodate mocking\r\n[5] net: change ConnectSocketDirectly() to take a Sock argument\r\n[4] net: add connect() and getsockopt() wrappers to Sock\r\n[3] fuzz: avoid FuzzedSock::Recv() repeated errors with EAGAIN\r\n[2] fuzz: extend FuzzedSock::Recv() to support MSG_PEEK\r\n[1] fuzz: implement unimplemented FuzzedSock methods\r\n```\r\n\r\n`1-3` are obviously fuzz. `4` touches `FuzzedSocket`. `7` adds fuzz tests. So only `5` and `6` remain. `5` depends on the previous commits. `6` is non-fuzz, does not depend on the previous commits and can be extracted, but `7` depends on it.\r\nSo a split can be:\r\nPR-A: 6\r\nPR-B: 1-5, 7\r\n\r\nI think it is not worth to split, given that 6 is a small mechanical change.\r\n",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T12:43:30Z",
      "diff_hunk" : "@@ -642,46 +642,34 @@ bool ConnectSocketDirectly(const CService &addrConnect, const SOCKET& hSocket, i\n             // Connection didn't actually fail, but is being established\n             // asynchronously. Thus, use async I/O api (select/poll)\n             // synchronously to check for successful connection with a timeout.\n-#ifdef USE_POLL\n-            struct pollfd pollfd = {};\n-            pollfd.fd = hSocket;\n-            pollfd.events = POLLIN | POLLOUT;\n-            int nRet = poll(&pollfd, 1, nTimeout);\n-#else\n-            struct timeval timeout = MillisToTimeval(nTimeout);\n-            fd_set fdset;\n-            FD_ZERO(&fdset);\n-            FD_SET(hSocket, &fdset);\n-            int nRet = select(hSocket + 1, nullptr, &fdset, nullptr, &timeout);\n-#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589393703",
      "id" : 589393703,
      "in_reply_to_id" : 589351441,
      "line" : 656,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM5MzcwMw==",
      "original_commit_id" : "d59cb9b3d335d122fc2865e5e0334e32ef92b3e7",
      "original_line" : 656,
      "original_position" : 48,
      "original_start_line" : 645,
      "path" : "src/netbase.cpp",
      "position" : 48,
      "pull_request_review_id" : 606250305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "LEFT",
      "start_line" : 645,
      "start_side" : "LEFT",
      "updated_at" : "2021-03-08T12:43:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393703",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589393794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done.",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T12:43:43Z",
      "diff_hunk" : "@@ -155,6 +155,8 @@ class Sock\n      * Contained socket. `INVALID_SOCKET` designates the object is empty.\n      */\n     SOCKET m_socket;\n+\n+    friend class FuzzedSock;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589393794",
      "id" : 589393794,
      "in_reply_to_id" : 589358838,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM5Mzc5NA==",
      "original_commit_id" : "ed7af727d36734874234d30a8f02cdb8506cef55",
      "original_line" : 159,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/util/sock.h",
      "position" : null,
      "pull_request_review_id" : 606250441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-08T12:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589393794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589398727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589398727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Either this should be `mutable` or the `const` qualifier should be removed from `Sock::Recv()` (and `Sock::Send()` for consistency). I don't have a strong opinion. I chose `mutable` because it is a smaller change and did not require modifying existing code.",
      "commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "created_at" : "2021-03-08T12:52:19Z",
      "diff_hunk" : "@@ -534,36 +534,37 @@ class FuzzedSock : public Sock\n {\n     FuzzedDataProvider& m_fuzzed_data_provider;\n \n+    /**\n+     * Data to return when `MSG_PEEK` is used as a `Recv()` flag.\n+     * If `MSG_PEEK` is used, then our `Recv()` returns some random data as usual, but on the next\n+     * `Recv()` call we must return the same data, thus we remember it here.\n+     */\n+    mutable std::optional<uint8_t> m_peek_data;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21387#discussion_r589398727",
      "id" : 589398727,
      "line" : 542,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4OTM5ODcyNw==",
      "original_commit_id" : "a6c20d2b88ea92fd31a3bef393da2ab1d9003157",
      "original_line" : 542,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/test/fuzz/util.h",
      "position" : 9,
      "pull_request_review_id" : 606256672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21387",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-08T12:52:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/589398727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   }
]
