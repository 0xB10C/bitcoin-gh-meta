[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17648](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17648.html) (doc: rename wallet-tool references to bitcoin-wallet by hel-o)\n* [#17579](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17579.html) ([refactor] Merge getreceivedby tally into GetReceived function by andrewtoth)\n* [#17564](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17564.html) (rpc: Use mempool from node context instead of global by MarcoFalke)\n* [#17484](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17484.html) (wallet: add cached m_is_ibd to remove Chain::isInitialBlockDownload by ariard)\n* [#17443](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17443.html) (Use Median Time Past to check finality of wallet transactions by ariard)\n* [#17261](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17261.html) (Make ScriptPubKeyMan an actual interface and the wallet to have multiple by achow101)\n* [#16963](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16963.html) (wallet: Fix unique_ptr usage in boost::signals2 by promag)\n* [#16224](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16224.html) (gui: Bilingual GUI error messages by hebasto)\n* [#15606](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15606.html) ([experimental] UTXO snapshots by jamesob)\n* [#14707](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14707.html) ([RPC] Include coinbase transactions in receivedby RPCs by andrewtoth)\n* [#9381](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/9381.html) (Remove CWalletTx merging logic from AddToWallet by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-07-20T06:53:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-513442866",
      "id" : 513442866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzQ0Mjg2Ng==",
      "updated_at" : "2019-12-02T22:45:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513442866",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Great work! I'd suggest changing the PR title to something like \"Reverse cs_main, cs_wallet lock order and reduce cs_main locking\" to motivate it better and describe the change.\r\n\r\nThe current title \"Remove Chain::Lock interface\" and starting sentence \"Follow-up in the set of Chain interface refactoring\" make this sound mostly like a refactoring. But this is more of a locking change, and a change to make the wallet more asynchronous and event driven than a refactoring change.",
      "created_at" : "2019-07-20T11:17:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-513459089",
      "id" : 513459089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzQ1OTA4OQ==",
      "updated_at" : "2019-07-20T11:20:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513459089",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nExcellent work!",
      "created_at" : "2019-07-22T11:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-513745160",
      "id" : 513745160,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzc0NTE2MA==",
      "updated_at" : "2019-07-22T11:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513745160",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. This might help IBD, because `cs_main` had to be acquired due to the lock order requirement. If it doesn't help IBD, the change will hopefully still speed up the `msghand` thread because the wallets take the main lock less.",
      "created_at" : "2019-07-22T20:43:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-513946565",
      "id" : 513946565,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzk0NjU2NQ==",
      "updated_at" : "2019-07-22T20:43:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513946565",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Big concept ACK! Thanks @ariard ",
      "created_at" : "2019-07-22T21:32:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-513963292",
      "id" : 513963292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMzk2MzI5Mg==",
      "updated_at" : "2019-07-22T21:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/513963292",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-07-24T18:15:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-514742145",
      "id" : 514742145,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDc0MjE0NQ==",
      "updated_at" : "2019-07-24T18:15:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514742145",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, mother of god, not locking `cs_main`!",
      "created_at" : "2019-07-25T02:58:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-514875510",
      "id" : 514875510,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDg3NTUxMA==",
      "updated_at" : "2019-07-25T02:58:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514875510",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r342719832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342719832"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Instead of adding an `interfaces::Chain::checkFinalTx` method, it might be better to call [`IsFinalTx`](https://github.com/bitcoin/bitcoin/blob/50591f6ec61b802cf4193cdbefcc85ad75716e8d/src/consensus/tx_verify.cpp#L17-L28) directly with the wallet's height and time, avoiding going through [`CheckFinalTx`](https://github.com/bitcoin/bitcoin/blob/50591f6ec61b802cf4193cdbefcc85ad75716e8d/src/validation.cpp#L189-L219).\r\n\r\nThis could perform better since it wouldn't require locking cs_main, and could make wallet calls return more internally consistent information when the wallet is catching up to the chain.",
      "commit_id" : "24f40fc1afa9d25e5032ba4f8d1c0161e81dce3f",
      "created_at" : "2019-11-05T18:18:14Z",
      "diff_hunk" : "@@ -2274,13 +2252,13 @@ bool CWalletTx::InMempool() const\n     return fInMempool;\n }\n \n-bool CWalletTx::IsTrusted(interfaces::Chain::Lock& locked_chain) const\n+bool CWalletTx::IsTrusted() const\n {\n     // Quick answer in most cases\n-    if (!locked_chain.checkFinalTx(*tx)) {\n+    if (!pwallet->chain().checkFinalTx(*tx)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r342719832",
      "id" : 342719832,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MjcxOTgzMg==",
      "original_commit_id" : "a052c3748b6551137c4477a87293f231e707578d",
      "original_position" : 452,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 311940772,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426",
      "updated_at" : "2019-12-03T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/342719832",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Finally rebased after merge of #15931, PR should be ready for review. \r\n\r\nApart of 3efe38d which use the new `m_last_block_processed_height` to avoid querying the chainstate and introduce some modifications, other commits are pretty straight-forward. It's just taking `cs_main` inside the `Chain` implementation instead of using `Chain::lock`. Lock order is reversed only in last commit f057aed to avoid any deadlock issue.\r\n\r\nIf you still feel PR is hard to review, I can subsplit easily in another PR.",
      "created_at" : "2019-11-11T19:33:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-552582365",
      "id" : 552582365,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjU4MjM2NQ==",
      "updated_at" : "2019-11-11T19:33:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552582365",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach ACK. Code changes here are very simple after #15931.\r\n\r\nAll the changes before the last commit f057aedf80d8bd6083c2227e42d4887be4c2933b seem straightforward and don't change behavior other than locking `cs_main` in new places recursively, so all the new locks are no-ops.\r\n\r\nOnly the last commit f057aedf80d8bd6083c2227e42d4887be4c2933b is the big scary change that removes `cs_main` locks all over the wallet, leaving us to hope that remaining locking is sufficient and that stretches of wallet code that used to run under `cs_main` aren't making assumptions about the tip not changing and other wallet threads not running.\r\n\r\n---\r\n\r\nI'll review this PR more closely this week. It might be nice to simplify the PR description now that #15931 is merged. I think the description just basically needs to say that `interfaces::Chain::Lock` is a wrapper around around `cs_main`, and that this PR changes wallet code to not lock and unlock `cs_main` directly anymore, and not keep `cs_main` locked while it locks `cs_wallet` and does other work. Instead, after this PR, wallet code only locks `cs_main` indirectly and intermittently when it needs to look up bits of chain information, and never holds onto `cs_main` while it does other work.",
      "created_at" : "2019-11-11T20:41:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-552606573",
      "id" : 552606573,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjYwNjU3Mw==",
      "updated_at" : "2019-11-11T20:41:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552606573",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Restating my concept ACK. I plan to review this fully soon.\r\n\r\nThanks for rebasing this so quickly",
      "created_at" : "2019-11-11T21:01:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-552613910",
      "id" : 552613910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjYxMzkxMA==",
      "updated_at" : "2019-11-11T21:01:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552613910",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Only the last commit f057aed is the big scary change that removes cs_main locks all over the wallet, leaving us to hope that remaining locking is sufficient and that stretches of wallet code that used to run under cs_main aren't making assumptions about the tip not changing and other wallet threads not running.\r\n\r\nMost of the code making assumptions about the tip is confined in the rescan logic, so I think this one should get the focus, you can grep for all methods fetching tip like `getHeight`, `getBlockHeight` `getX` and check no decision is made on return value of 2 different calls of them. Concerning other wallet threads, it should be cover by wallet lock in itself.",
      "created_at" : "2019-11-11T22:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-552637188",
      "id" : 552637188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1MjYzNzE4OA==",
      "updated_at" : "2019-11-11T22:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/552637188",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2019-11-22T19:56:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-557672181",
      "id" : 557672181,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1NzY3MjE4MQ==",
      "updated_at" : "2019-11-22T19:56:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557672181",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r352868751"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352868751"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why use chain height instead of wallet height here and other places? Anywhere the wallet is locked and the chain isn't locked it would seem safer to use the wallet height.",
      "commit_id" : "24f40fc1afa9d25e5032ba4f8d1c0161e81dce3f",
      "created_at" : "2019-12-02T21:31:03Z",
      "diff_hunk" : "@@ -565,7 +565,7 @@ UniValue importwallet(const JSONRPCRequest& request)\n         if (!file.is_open()) {\n             throw JSONRPCError(RPC_INVALID_PARAMETER, \"Cannot open wallet dump file\");\n         }\n-        Optional<int> tip_height = locked_chain->getHeight();\n+        Optional<int> tip_height = pwallet->chain().getHeight();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r352868751",
      "id" : 352868751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1Mjg2ODc1MQ==",
      "original_commit_id" : "be2651fd8931b6317bd68e652f58755413abf906",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 72,
      "pull_request_review_id" : 325756305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426",
      "updated_at" : "2019-12-03T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/352868751",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353369610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353369610"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I can switch for the one in `CreateTransaction`, all left are tied to the rescan logic which doesn't call `BlockConnected` and so doesn't update `m_last_block_processed` accurately. I can rework a bit the rescan logic to make it work on m_last_block_processed_height but I felt it was a bit of scope and an increased burden for reviewers.\r\n\r\nAs you know I plan to rework the rescan logic after this PR. At term it would remove all `getHeight` callsites`.",
      "commit_id" : "24f40fc1afa9d25e5032ba4f8d1c0161e81dce3f",
      "created_at" : "2019-12-03T19:13:01Z",
      "diff_hunk" : "@@ -565,7 +565,7 @@ UniValue importwallet(const JSONRPCRequest& request)\n         if (!file.is_open()) {\n             throw JSONRPCError(RPC_INVALID_PARAMETER, \"Cannot open wallet dump file\");\n         }\n-        Optional<int> tip_height = locked_chain->getHeight();\n+        Optional<int> tip_height = pwallet->chain().getHeight();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353369610",
      "id" : 353369610,
      "in_reply_to_id" : 352868751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MzM2OTYxMA==",
      "original_commit_id" : "be2651fd8931b6317bd68e652f58755413abf906",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 72,
      "pull_request_review_id" : 326383097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426",
      "updated_at" : "2019-12-03T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353369610",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353376692"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353376692"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, chain height seems fine for rescan logic, and is what I'd expect there. I think the other places should use wallet height if there isn't an explicit reason not to.",
      "commit_id" : "24f40fc1afa9d25e5032ba4f8d1c0161e81dce3f",
      "created_at" : "2019-12-03T19:27:13Z",
      "diff_hunk" : "@@ -565,7 +565,7 @@ UniValue importwallet(const JSONRPCRequest& request)\n         if (!file.is_open()) {\n             throw JSONRPCError(RPC_INVALID_PARAMETER, \"Cannot open wallet dump file\");\n         }\n-        Optional<int> tip_height = locked_chain->getHeight();\n+        Optional<int> tip_height = pwallet->chain().getHeight();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353376692",
      "id" : 353376692,
      "in_reply_to_id" : 352868751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MzM3NjY5Mg==",
      "original_commit_id" : "be2651fd8931b6317bd68e652f58755413abf906",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 72,
      "pull_request_review_id" : 326391993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426",
      "updated_at" : "2019-12-03T19:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353376692",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353391359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353391359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Corrected on 24f40fc, there was only one occurrence in `CreateTransaction`. All others are tied to rescan logic, including ones in `rpcdump`/`rpcwallet`.",
      "commit_id" : "24f40fc1afa9d25e5032ba4f8d1c0161e81dce3f",
      "created_at" : "2019-12-03T19:57:05Z",
      "diff_hunk" : "@@ -565,7 +565,7 @@ UniValue importwallet(const JSONRPCRequest& request)\n         if (!file.is_open()) {\n             throw JSONRPCError(RPC_INVALID_PARAMETER, \"Cannot open wallet dump file\");\n         }\n-        Optional<int> tip_height = locked_chain->getHeight();\n+        Optional<int> tip_height = pwallet->chain().getHeight();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#discussion_r353391359",
      "id" : 353391359,
      "in_reply_to_id" : 352868751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM1MzM5MTM1OQ==",
      "original_commit_id" : "be2651fd8931b6317bd68e652f58755413abf906",
      "original_position" : 5,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 72,
      "pull_request_review_id" : 326409878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/16426",
      "updated_at" : "2019-12-03T19:57:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/353391359",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-12-04T11:29:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/16426#issuecomment-561604205",
      "id" : 561604205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/16426",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU2MTYwNDIwNQ==",
      "updated_at" : "2019-12-04T11:29:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/561604205",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
