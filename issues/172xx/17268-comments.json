[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-10-26T21:28:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-546641071",
      "id" : 546641071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NjY0MTA3MQ==",
      "updated_at" : "2019-10-26T21:28:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/546641071",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased :+1: ",
      "created_at" : "2019-10-26T21:30:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-546641159",
      "id" : 546641159,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NjY0MTE1OQ==",
      "updated_at" : "2019-10-26T21:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/546641159",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17566](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17566.html) (Switch to weight units for all feerates computation by darosior)\n* [#17564](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17564.html) (rpc: Use mempool from node context instead of global by MarcoFalke)\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n* [#16490](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16490.html) (rpc: Report reason for replaceable txpool transactions by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-10-26T22:43:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-546645680",
      "id" : 546645680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NjY0NTY4MA==",
      "updated_at" : "2019-11-23T00:22:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/546645680",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17268#discussion_r339356314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17268"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339356314"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This can be replaced by a std::remove_if and a std::erase idiom, which will be of similar behavior (remove_if keeps order stable) and same complexity. Much easier to read and less chance of bugs.",
      "commit_id" : "128748d44aaf37f80f14ff3a680a337d17637903",
      "created_at" : "2019-10-27T18:17:17Z",
      "diff_hunk" : "@@ -173,17 +173,18 @@ std::unique_ptr<CBlockTemplate> BlockAssembler::CreateNewBlock(const CScript& sc\n     return std::move(pblocktemplate);\n }\n \n-void BlockAssembler::onlyUnconfirmed(CTxMemPool::setEntries& testSet)\n+void BlockAssembler::onlyUnconfirmed(CTxMemPool::vecEntries& testSet)\n {\n-    for (CTxMemPool::setEntries::iterator iit = testSet.begin(); iit != testSet.end(); ) {\n-        // Only test txs not already in the block\n-        if (inBlock.count(*iit)) {\n-            testSet.erase(iit++);\n-        }\n-        else {\n-            iit++;\n-        }\n+    size_t max_element = testSet.size(), i = 0;\n+    while (i < max_element) {\n+        bool not_in_block = !inBlock.count(testSet[i]);\n+        // if !not_in_block, set testSet[i] to testSet[max_element-1]\n+        max_element -= !not_in_block;\n+        testSet[i] = testSet[!not_in_block*max_element + not_in_block*i];\n+        i += not_in_block;\n     }\n+    // drop erased elements\n+    testSet.resize(max_element);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#discussion_r339356314",
      "id" : 339356314,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTM1NjMxNA==",
      "original_commit_id" : "7f7f7a2fbbc98314f628189a8bbbc73048a4e21b",
      "original_position" : 24,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 307587120,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17268",
      "updated_at" : "2019-10-27T18:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339356314",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17268#discussion_r339356418"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17268"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339356418"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "std::binary_search on a std::set takes `O(N log N)` because std::advance on the iterators is `O(N)`.\r\n\r\nTo fix this, allow passing in a predicate that knows how to query alreadyAdded efficient. Other options would be to make alreadyAdded a sorted vector or make it a hashtable always. But that's a bigger change than the predicate, which doesn't change any data types.",
      "commit_id" : "128748d44aaf37f80f14ff3a680a337d17637903",
      "created_at" : "2019-10-27T18:19:57Z",
      "diff_hunk" : "@@ -230,16 +231,21 @@ void BlockAssembler::AddToBlock(CTxMemPool::txiter iter)\n     }\n }\n \n-int BlockAssembler::UpdatePackagesForAdded(const CTxMemPool::setEntries& alreadyAdded,\n+template<typename SortedIterable>\n+int BlockAssembler::UpdatePackagesForAdded(const SortedIterable& alreadyAdded,\n         indexed_modified_transaction_set &mapModifiedTx)\n {\n     int nDescendantsUpdated = 0;\n+    CTxMemPool::vecEntries descendants;\n     for (CTxMemPool::txiter it : alreadyAdded) {\n-        CTxMemPool::setEntries descendants;\n-        mempool.CalculateDescendants(it, descendants);\n+        descendants.clear();\n+        // can't use external epoch to loop because we want to update\n+        // all descendants\n+        // No need to add self (it) because we would filter it from the loop\n+        mempool.CalculateDescendantsVec(it, descendants);\n         // Insert all descendants (not yet in block) into the modified set\n         for (CTxMemPool::txiter desc : descendants) {\n-            if (alreadyAdded.count(desc))\n+            if (std::binary_search(alreadyAdded.cbegin(), alreadyAdded.cend(), desc, CTxMemPool::CompareIteratorByHash()))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#discussion_r339356418",
      "id" : 339356418,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTM1NjQxOA==",
      "original_commit_id" : "7f7f7a2fbbc98314f628189a8bbbc73048a4e21b",
      "original_position" : 59,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 307587120,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17268",
      "updated_at" : "2019-10-27T18:22:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339356418",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added some changes as per suggestion from @TheBlueMatt, which should make reviewing the final state easier.\r\n\r\nThe epochs are no longer stored on the stack (instead we reference them via the mempool itself) and we use a scoped stack guard in order to ensure that only one part of the code is using epochs at a time. This prevents a called function from creating an epoch guard (via assertion). While there is occasionally use for a multiple outstanding epochs, none are implemented currently. If it comes up in the future it can be special cased.",
      "created_at" : "2019-10-28T19:51:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547117050",
      "id" : 547117050,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzExNzA1MA==",
      "updated_at" : "2019-10-28T19:51:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547117050",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I just opened up #17292, which adds a motivating benchmark for the Epoch Mempool.\r\n\r\n`./src/bench/bench_bitcoin --filter=ComplexMemPool --scaling=5`\r\n\r\nBefore:\r\n```\r\n# Benchmark, evals, iterations, total, min, max, median\r\nComplexMemPool, 5, 5, 6.62715, 0.264409, 0.265441, 0.2654\r\n```\r\nAfter:\r\n```\r\n# Benchmark, evals, iterations, total, min, max, median\r\nComplexMemPool, 5, 5, 3.07116, 0.122246, 0.12351, 0.122783\r\n```\r\n\r\nThis shows a **> 2x speedup** on this difficult benchmark (~2.15x across total, min, max, median).\r\n\r\n\r\nNote: For scientific purity, I created it \"single shot blind\". That is, I did not modify the test at all after running it on the new branch (I had to run it on master to fix bugs / adjust the expected iters for a second parameter, and then adjust the internal params to get it to be about a second).",
      "created_at" : "2019-10-28T23:23:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547188487",
      "id" : 547188487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzE4ODQ4Nw==",
      "updated_at" : "2019-10-28T23:23:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547188487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I ran the test against master, changing the parameter on number transactions. For this test, the 2x improvement seems to hold. They both seem to be quadratic fundamentally, but that may be a reflection of the test setup and not the actual upper bound.\r\n\r\n![image](https://user-images.githubusercontent.com/886523/67787134-46cfb300-fa2d-11e9-8bff-ea5dcfa0b1ec.png)\r\n\r\n![image](https://user-images.githubusercontent.com/886523/67787818-7337ff00-fa2e-11e9-97f8-d97bb329dc76.png)\r\n\r\n",
      "created_at" : "2019-10-29T16:29:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547511193",
      "id" : 547511193,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzUxMTE5Mw==",
      "updated_at" : "2019-10-29T16:29:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547511193",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems like a moderately important area for optimization.  One thing that might be worth keeping in mind:  It would probably be useful to support a \"fast but imprecise\" accounting method for the first block template after a new block.  This is really easy to do with the current code (just skip updating the costs while inserting transactions), not sure if your work would change that.\r\n\r\n[Aside, usually when talking about improving asymptotic complexity people ignore constant factors. You might want to use different language when describing this work to avoid confusing people.]\r\n\r\nIn theory, I think the common case where confirmation includes an entire disjoint subgraph at once it should be possible to make that linear time (by basically noticing that the entire subgraph is removed, so any cost updates can be skipped).  Interestingly: for attack resistance the worst case (permitted by policy) is what matters... but for revenue reasons the average case is more important.\r\n\r\nI'm not sure if there are greater wins though from speedups or from latency hiding hacks. e.g. if one keeps a small redundant highest fee only mempool perhaps without CPFP dependency tracking at all, and uses it while the real stuff is updating in the background... then it probably doesn't matter that much if the main mempool is taking tens of seconds.",
      "created_at" : "2019-10-29T21:24:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547635956",
      "id" : 547635956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzYzNTk1Ng==",
      "updated_at" : "2019-10-29T21:24:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547635956",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @gmaxwell.\r\n\r\nI think the \"fast but imprecise\" accounting method is not affected at all by this change, but someone who has implemented that should verify.\r\n\r\nI've also used the terminology correctly RE: asymptotes. Imagine a set of O(N) transactions which each have 1 output, and a single transaction which spends all outputs. Assembling the ancestors (e.g., in CalculateMemPoolAncestors) will iterate over O(N) inputs and make O(N log N) comparisons in set entries. In the new code I've written, you do O(N) work as it's O(1) (rather than O(log N)) to query if we've already included it.\r\n\r\nNow, you're correct to note that in the benchmark I gave, it's only a constant factor. This is the purpose of the benchmark; a \"believable\" transaction workload. As noted above, the O(N^2) work manifests as a result of the structure of that test specifically -- you have N transactions you're inserting into the mempool, and you need to percolate the updated package info up the tree every insert. Thus, you end up making N*N traversals. Thus, short of some sort of magic metadata data structure, any implementation's improvements will manifest lower-bounded by W(N^2).\r\n\r\nI can generate some micro benchmarks which show that Epoch Mempool beats out the status quo in asymptotes. I figured it's less interesting than showing it's better in the domain of believable workloads, because while it's easy to see that these algorithms win in the asymptotes, it's less clear that they win on realistic workloads.\r\n\r\nAlso, some of the \"composed\" algorithms have two parts -- one half is improved by this PR, and the other half isn't -- yet. For example in addUnchecked, we have two components: 1 builds setParentTransactions and the other calls UpdateParent on everything in setParentTransactions. Normally, building setParentTransactions is O(N log N), but with this update it becomes O(N). However, the *internals* of UpdateParent are  an ordered set, so we gain back the log N factor. However future work can update those data structures to make UpdateParent O(1).\r\n\r\nTo your point about making subtree detaching O(N), this work actually already does that moslty. removeRecursive was previously O(N log N), with this PR it is now basically O(N) (we skip the metadata updating in removeRecursive's call to RemoveStaged with updateDescendants = false, but removeUnchecked removes n items from a std::set so it regains a log(n) factor, but it's a pretty conceptually easy follow up PR to make txlinksMap a std::unordered_set).\r\n\r\nI haven't pushed the changes I was working on w.r.t. changing the std::sets to std::unordered_sets because while conceptually simple, they have a lot more edge case in if it will be better or worse (esp when it comes to memory). So the epoch's seemed like a better one as there's really no downside.",
      "created_at" : "2019-10-30T02:19:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547709857",
      "id" : 547709857,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NzcwOTg1Nw==",
      "updated_at" : "2019-10-30T02:19:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547709857",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-10-30T16:18:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-547989183",
      "id" : 547989183,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0Nzk4OTE4Mw==",
      "updated_at" : "2019-10-30T16:18:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547989183",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah! Point on asympotics accepted. You might also want to make a benchmark that shows that case! I agree that a 'toy' case isn't a useful _benchmark_, but if you believe your algo is nlogn in some case it's a useful _testing_ point to actually demonstrate that (e.g. and confirm that there isn't a hidden O(N) in an underlying datastructure that breaks your performance).",
      "created_at" : "2019-10-31T19:34:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-548534894",
      "id" : 548534894,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0ODUzNDg5NA==",
      "updated_at" : "2019-10-31T19:35:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548534894",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-11-04T13:55:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-549363978",
      "id" : 549363978,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0OTM2Mzk3OA==",
      "updated_at" : "2019-11-04T13:55:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549363978",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I tried rebasing -- i have no idea how to clear this appveyor cache? @MarcoFalke @sipsorcery may be related to recent changes?",
      "created_at" : "2019-11-24T08:21:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-557867619",
      "id" : 557867619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzg2NzYxOQ==",
      "updated_at" : "2019-11-24T08:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557867619",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin the appveyor cache doesn't need to be cleared (only time that's required are when the vcpkg or Qt dependencies change).\r\n\r\nThe appveyor job failure here is due to a compilation error:\r\n\r\n````\r\nC:\\projects\\bitcoin\\src\\httpserver.cpp(373,5): error C3861: 'evthread_use_windows_threads': identifier not found [C:\\projects\\bitcoin\\build_msvc\\libbitcoin_server\\libbitcoin_server.vcxproj]\r\n````\r\n\r\nI'll try a local Windows build of this PR to see if I can spot anything.",
      "created_at" : "2019-11-24T09:27:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-557871726",
      "id" : 557871726,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzg3MTcyNg==",
      "updated_at" : "2019-11-24T09:27:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557871726",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@JeremyRubin I pulled this PR on top of master and msbuild was good. My only guess is that something has gone wrong when you rebased.",
      "created_at" : "2019-11-24T10:05:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-557874120",
      "id" : 557874120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzg3NDEyMA==",
      "updated_at" : "2019-11-24T10:05:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557874120",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Appveyor failure was before rebasing though\n\nOn Sun, Nov 24, 2019, 2:05 AM Aaron Clauson <notifications@github.com>\nwrote:\n\n> @JeremyRubin <https://github.com/JeremyRubin> I pulled this PR on top of\n> master and msbuild was good. My only guess is that something has gone wrong\n> when you rebased.\n>\n> â\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/17268?email_source=notifications&email_token=AAGYN67EFBUZTHPU2GI55NLQVJGVPA5CNFSM4JFO5JWKYY3PNVWWK3TUL52HS4DFVREXG43VMVBW63LNMVXHJKTDN5WW2ZLOORPWSZGOEFAHXSA#issuecomment-557874120>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAGYN64PFRDQSLHJR7MJNYTQVJGVPANCNFSM4JFO5JWA>\n> .\n>\n",
      "created_at" : "2019-11-24T12:07:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17268#issuecomment-557882458",
      "id" : 557882458,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17268",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU1Nzg4MjQ1OA==",
      "updated_at" : "2019-11-24T12:07:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/557882458",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   }
]
