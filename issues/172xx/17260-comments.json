[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339254720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339254720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Split up CWallet and LegacyScriptPubKeyMan and classes\" (194227b1173b0dd9a51d24e245ddaa601d36a109)\r\n\r\nWould be better not to reference `m_wallet` here. `m_wallet` is a temporary alias so any references added now will have to be removed later, causing unnecessary churn. Would suggest reverting the commit back to your previous af8780a65a530c48a0abc7f3ef6915f33d30943f push, and just adding the linter fixes in 626eed831918ac4f492b94ad0131f65d67fd1785 ",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-25T22:04:40Z",
      "diff_hunk" : "@@ -421,47 +418,47 @@ bool CWallet::AddKeyPubKeyWithDB(WalletBatch& batch, const CKey& secret, const C\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n-    UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);\n     return true;\n }\n \n-bool CWallet::LoadCScript(const CScript& redeemScript)\n+bool LegacyScriptPubKeyMan::LoadCScript(const CScript& redeemScript)\n {\n     /* A sanity check was added in pull #3843 to avoid adding redeemScripts\n      * that never can be redeemed. However, old wallets may still contain\n      * these. Do not add them to the wallet and warn. */\n     if (redeemScript.size() > MAX_SCRIPT_ELEMENT_SIZE)\n     {\n         std::string strAddr = EncodeDestination(ScriptHash(redeemScript));\n-        WalletLogPrintf(\"%s: Warning: This wallet contains a redeemScript of size %i which exceeds maximum size %i thus can never be redeemed. Do not use address %s.\\n\", __func__, redeemScript.size(), MAX_SCRIPT_ELEMENT_SIZE, strAddr);\n+        m_wallet.WalletLogPrintf(\"%s: Warning: This wallet contains a redeemScript of size %i which exceeds maximum size %i thus can never be redeemed. Do not use address %s.\\n\", __func__, redeemScript.size(), MAX_SCRIPT_ELEMENT_SIZE, strAddr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339254720",
      "id" : 339254720,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTI1NDcyMA==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 184,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 307472747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339254720",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339255102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339255102"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Refactor: Split up CWallet and LegacyScriptPubKeyMan and classes\" (194227b1173b0dd9a51d24e245ddaa601d36a109)\r\n\r\nExtra lock here seems not ideal. This commit is not supposed to change behavior in any way. Other places in this commit I just added AssertLockHelds where needed to avoid clang lock warnings, but here I'm not even seeing that is necessary.",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-25T22:06:18Z",
      "diff_hunk" : "@@ -337,37 +343,38 @@ BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n     BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n }\n \n-// Test some watch-only wallet methods by the procedure of loading (LoadWatchOnly),\n+// Test some watch-only LegacyScriptPubKeyMan methods by the procedure of loading (LoadWatchOnly),\n // checking (HaveWatchOnly), getting (GetWatchPubKey) and removing (RemoveWatchOnly) a\n // given PubKey, resp. its corresponding P2PK Script. Results of the the impact on\n // the address -> PubKey map is dependent on whether the PubKey is a point on the curve\n-static void TestWatchOnlyPubKey(CWallet& wallet, const CPubKey& add_pubkey)\n+static void TestWatchOnlyPubKey(LegacyScriptPubKeyMan* spk_man, const CPubKey& add_pubkey)\n {\n     CScript p2pk = GetScriptForRawPubKey(add_pubkey);\n     CKeyID add_address = add_pubkey.GetID();\n     CPubKey found_pubkey;\n-    LOCK(wallet.cs_wallet);\n+    LOCK2(spk_man->cs_wallet, spk_man->cs_KeyStore);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339255102",
      "id" : 339255102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTI1NTEwMg==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 69,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 307472747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339255102",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339259163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339259163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It was failing the tests without it.",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-25T22:25:23Z",
      "diff_hunk" : "@@ -337,37 +343,38 @@ BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n     BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n }\n \n-// Test some watch-only wallet methods by the procedure of loading (LoadWatchOnly),\n+// Test some watch-only LegacyScriptPubKeyMan methods by the procedure of loading (LoadWatchOnly),\n // checking (HaveWatchOnly), getting (GetWatchPubKey) and removing (RemoveWatchOnly) a\n // given PubKey, resp. its corresponding P2PK Script. Results of the the impact on\n // the address -> PubKey map is dependent on whether the PubKey is a point on the curve\n-static void TestWatchOnlyPubKey(CWallet& wallet, const CPubKey& add_pubkey)\n+static void TestWatchOnlyPubKey(LegacyScriptPubKeyMan* spk_man, const CPubKey& add_pubkey)\n {\n     CScript p2pk = GetScriptForRawPubKey(add_pubkey);\n     CKeyID add_address = add_pubkey.GetID();\n     CPubKey found_pubkey;\n-    LOCK(wallet.cs_wallet);\n+    LOCK2(spk_man->cs_wallet, spk_man->cs_KeyStore);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339259163",
      "id" : 339259163,
      "in_reply_to_id" : 339255102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTI1OTE2Mw==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 69,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 307478347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339259163",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17246](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17246.html) (wallet: avoid knapsack when there's no change by Sjors)\n* [#17237](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17237.html) (wallet: LearnRelatedScripts only if KeepDestination by promag)\n* [#17219](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17219.html) (wallet: allow transaction without change if keypool is empty by Sjors)\n* [#17211](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17211.html) (Allow fundrawtransaction and walletcreatefundedpsbt to take external inputs by achow101)\n* [#16946](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16946.html) (wallet: include a checksum of encrypted private keys by achow101)\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n* [#16546](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16546.html) ([WIP] External signer support - Wallet Box edition by Sjors)\n* [#16528](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16528.html) ([WIP] Native Descriptor Wallets (take 2) by achow101)\n* [#16440](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16440.html) (BIP-322: Generic signed message format by kallewoof)\n* [#16037](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16037.html) (rpc: Enable wallet import on pruned nodes by promag)\n* [#15931](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15931.html) (Remove GetDepthInMainChain dependency on locked chain interface by ariard)\n* [#15761](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15761.html) (Replace -upgradewallet startup option with upgradewallet RPC by achow101)\n* [#15294](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15294.html) ([moveonly] wallet: Extract RipeMd160 by Empact)\n* [#14942](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14942.html) (wallet: Make scan / abort status private to CWallet by Empact)\n* [#14707](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14707.html) ([RPC] Include coinbase transactions in receivedby RPCs by andrewtoth)\n* [#14384](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14384.html) (Fire TransactionRemovedFromMempool callbacks from mempool by l2a5b1)\n* [#14144](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14144.html) (Refactoring: Clarify code using encrypted_batch in CWallet by domob1812)\n* [#10785](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10785.html) (Serialization improvements by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-10-25T22:45:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#issuecomment-546536564",
      "id" : 546536564,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17260",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NjUzNjU2NA==",
      "updated_at" : "2019-10-25T22:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/546536564",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339265025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339265025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted and squashed linter changes.",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-25T22:56:22Z",
      "diff_hunk" : "@@ -421,47 +418,47 @@ bool CWallet::AddKeyPubKeyWithDB(WalletBatch& batch, const CKey& secret, const C\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n-    UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);\n     return true;\n }\n \n-bool CWallet::LoadCScript(const CScript& redeemScript)\n+bool LegacyScriptPubKeyMan::LoadCScript(const CScript& redeemScript)\n {\n     /* A sanity check was added in pull #3843 to avoid adding redeemScripts\n      * that never can be redeemed. However, old wallets may still contain\n      * these. Do not add them to the wallet and warn. */\n     if (redeemScript.size() > MAX_SCRIPT_ELEMENT_SIZE)\n     {\n         std::string strAddr = EncodeDestination(ScriptHash(redeemScript));\n-        WalletLogPrintf(\"%s: Warning: This wallet contains a redeemScript of size %i which exceeds maximum size %i thus can never be redeemed. Do not use address %s.\\n\", __func__, redeemScript.size(), MAX_SCRIPT_ELEMENT_SIZE, strAddr);\n+        m_wallet.WalletLogPrintf(\"%s: Warning: This wallet contains a redeemScript of size %i which exceeds maximum size %i thus can never be redeemed. Do not use address %s.\\n\", __func__, redeemScript.size(), MAX_SCRIPT_ELEMENT_SIZE, strAddr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339265025",
      "id" : 339265025,
      "in_reply_to_id" : 339254720,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTI2NTAyNQ==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 184,
      "path" : "src/wallet/scriptpubkeyman.cpp",
      "position" : null,
      "pull_request_review_id" : 307485535,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339265025",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The code at 1c49a20cb10f2d48cf23bb364d586a9c1e86d5ec matches the first three commits in #17261 modulo the linter changes and extra lock discussed above. I in turn [verified](https://github.com/bitcoin/bitcoin/pull/17261#issuecomment-546582908) that #17261 matches what I previously reviewed.\r\n\r\nI'll review this PR on its own merits later.",
      "created_at" : "2019-10-26T08:44:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#issuecomment-546583678",
      "id" : 546583678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/17260",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU0NjU4MzY3OA==",
      "updated_at" : "2019-10-26T08:44:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/546583678",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339300716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339300716"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> It was failing the tests without it.\r\n\r\nSo this is definitely a bug. There canât be any changes in behavior in this PR. All it is supposed do is add wrapper functions and variable aliases. If any side effects are present from this, it means something has gone wrong.\r\n\r\nAny case I reproduced the problem and found it was limited to tests and caused by me pulling in some test-only LOCK changes that didn't belong here in a bad rebase. This PR can be fixed by just updating the tip from 1c49a20cb10f2d48cf23bb364d586a9c1e86d5ec to f201ba59ffd2e071a36a688b80d2cff9a9c44bb2 ([compare](https://github.com/bitcoin/bitcoin/compare/1c49a20cb10f2d48cf23bb364d586a9c1e86d5ec..f201ba59ffd2e071a36a688b80d2cff9a9c44bb2)) from my updated [`pr/keyman`](https://github.com/ryanofsky/bitcoin/commits/pr/keyman) branch. Getting rid of the unintended test locking changes also makes this PR slightly smaller.\r\n\r\n(You can also reset #17261 to the updated [`pr/keyman`](https://github.com/ryanofsky/bitcoin/commits/pr/keyman) branch with no loss since I pulled in your updated SigningProvider commit there.)",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-26T13:45:33Z",
      "diff_hunk" : "@@ -337,37 +343,38 @@ BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n     BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n }\n \n-// Test some watch-only wallet methods by the procedure of loading (LoadWatchOnly),\n+// Test some watch-only LegacyScriptPubKeyMan methods by the procedure of loading (LoadWatchOnly),\n // checking (HaveWatchOnly), getting (GetWatchPubKey) and removing (RemoveWatchOnly) a\n // given PubKey, resp. its corresponding P2PK Script. Results of the the impact on\n // the address -> PubKey map is dependent on whether the PubKey is a point on the curve\n-static void TestWatchOnlyPubKey(CWallet& wallet, const CPubKey& add_pubkey)\n+static void TestWatchOnlyPubKey(LegacyScriptPubKeyMan* spk_man, const CPubKey& add_pubkey)\n {\n     CScript p2pk = GetScriptForRawPubKey(add_pubkey);\n     CKeyID add_address = add_pubkey.GetID();\n     CPubKey found_pubkey;\n-    LOCK(wallet.cs_wallet);\n+    LOCK2(spk_man->cs_wallet, spk_man->cs_KeyStore);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339300716",
      "id" : 339300716,
      "in_reply_to_id" : 339255102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTMwMDcxNg==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 69,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 307526785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339300716",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339306257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339306257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-26T16:25:19Z",
      "diff_hunk" : "@@ -337,37 +343,38 @@ BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n     BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n }\n \n-// Test some watch-only wallet methods by the procedure of loading (LoadWatchOnly),\n+// Test some watch-only LegacyScriptPubKeyMan methods by the procedure of loading (LoadWatchOnly),\n // checking (HaveWatchOnly), getting (GetWatchPubKey) and removing (RemoveWatchOnly) a\n // given PubKey, resp. its corresponding P2PK Script. Results of the the impact on\n // the address -> PubKey map is dependent on whether the PubKey is a point on the curve\n-static void TestWatchOnlyPubKey(CWallet& wallet, const CPubKey& add_pubkey)\n+static void TestWatchOnlyPubKey(LegacyScriptPubKeyMan* spk_man, const CPubKey& add_pubkey)\n {\n     CScript p2pk = GetScriptForRawPubKey(add_pubkey);\n     CKeyID add_address = add_pubkey.GetID();\n     CPubKey found_pubkey;\n-    LOCK(wallet.cs_wallet);\n+    LOCK2(spk_man->cs_wallet, spk_man->cs_KeyStore);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339306257",
      "id" : 339306257,
      "in_reply_to_id" : 339255102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTMwNjI1Nw==",
      "original_commit_id" : "194227b1173b0dd9a51d24e245ddaa601d36a109",
      "original_position" : 69,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 307533150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T16:25:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339306257",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339308211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339308211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FWIW: I'm no longer in favor of splitting this out. For example this RPC method relies on `ImportPrivKeys` which is no longer a method on `CWallet`, but on`LegacyScriptPubKeyMan` (and not of its parent class `ScriptPubKeyMan`). This is in contrast to methods like `setwalletflag` that still call `CWallet` methods.",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-26T17:20:03Z",
      "diff_hunk" : "@@ -138,6 +138,11 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n     }\n \n+    LegacyScriptPubKeyMan* spk_man = pwallet->GetLegacyScriptPubKeyMan();\n+    if (!spk_man) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339308211",
      "id" : 339308211,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTMwODIxMQ==",
      "original_commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "original_position" : 20,
      "path" : "src/wallet/rpcdump.cpp",
      "position" : 20,
      "pull_request_review_id" : 307531781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T17:22:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339308211",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339308494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339308494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's a bit weird to have a definition in a cpp file. On a local branch I was able to move this to `scriptpubkeyman.h` in the second commit, courtesy of circular includes.",
      "commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "created_at" : "2019-10-26T17:27:23Z",
      "diff_hunk" : "@@ -238,17 +236,7 @@ std::string COutput::ToString() const\n     return strprintf(\"COutput(%s, %d, %d) [%s]\", tx->GetHash().ToString(), i, nDepth, FormatMoney(tx->tx->vout[i].nValue));\n }\n \n-std::vector<CKeyID> GetAffectedKeys(const CScript& spk, const SigningProvider& provider)\n-{\n-    std::vector<CScript> dummy;\n-    FlatSigningProvider out;\n-    InferDescriptor(spk, provider)->Expand(0, DUMMY_SIGNING_PROVIDER, dummy, out);\n-    std::vector<CKeyID> ret;\n-    for (const auto& entry : out.pubkeys) {\n-        ret.push_back(entry.first);\n-    }\n-    return ret;\n-}\n+std::vector<CKeyID> GetAffectedKeys(const CScript& spk, const SigningProvider& provider);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/17260#discussion_r339308494",
      "id" : 339308494,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMzOTMwODQ5NA==",
      "original_commit_id" : "f201ba59ffd2e071a36a688b80d2cff9a9c44bb2",
      "original_position" : 37,
      "path" : "src/wallet/wallet.cpp",
      "position" : 37,
      "pull_request_review_id" : 307535902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/17260",
      "updated_at" : "2019-10-26T17:27:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/339308494",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
