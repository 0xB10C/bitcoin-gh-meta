[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21186 (net/net processing: Move addr data into net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-22T03:17:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-783026889",
      "id" : 783026889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzAyNjg4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-03T18:16:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783026889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-02-25T08:18:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-785710010",
      "id" : 785710010,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NTcxMDAxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-25T08:18:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/785710010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Will update now that #20197 (on which this is based) and #20685 adding I2P support are both merged.",
      "created_at" : "2021-03-30T16:14:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-810393262",
      "id" : 810393262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDM5MzI2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-30T16:14:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810393262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK, will review more closely soon.",
      "created_at" : "2021-04-29T23:26:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-829668926",
      "id" : 829668926,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyOTY2ODkyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-29T23:26:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829668926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625210280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625210280"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Before this PR we would have protected 25% onions. With this PR up to commit 517976187 (inclusive) we would protect 12.5% onions and with the full PR - just 8.3%. What about:\r\n\r\n```suggestion\r\n        const size_t protect_size_per_network{total_protect_size / networks};\r\n```",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-03T16:33:42Z",
      "diff_hunk" : "@@ -896,36 +902,64 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& vEvict\n {\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // To favorise the diversity of our peer connections, reserve up to (half + 2) of\n-    // these protected spots for onion and localhost peers, if any, even if they're not\n-    // longest uptime overall. This helps protect tor peers, which tend to be otherwise\n-    // disadvantaged under our eviction criteria.\n+    // To favorise the diversity of our peer connections, reserve up to half of\n+    // these protected spots for onion, localhost and I2P peers, even if they're\n+    // not longest uptime overall. This helps protect these higher-latency peers\n+    // that tend to be otherwise disadvantaged under our eviction criteria.\n     const size_t initial_size = vEvictionCandidates.size();\n-    size_t total_protect_size = initial_size / 2;\n-    const size_t onion_protect_size = total_protect_size / 2;\n+    const size_t total_protect_size{initial_size / 2};\n \n-    if (onion_protect_size) {\n-        // Pick out up to 1/4 peers connected via our onion service, sorted by longest uptime.\n-        EraseLastKElements(vEvictionCandidates, CompareOnionTimeConnected, onion_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_onion; });\n+    // Count number of nodes connected via localhost, I2P, and onion.\n+    // Higher positions in the array recover unused slots left by lower ones.\n+    std::array<size_t, 3> network_counts{{}};\n+    for (const NodeEvictionCandidate& node : vEvictionCandidates) {\n+        if (node.m_is_local) {\n+            ++network_counts[0];\n+        } else if (node.m_is_i2p) {\n+            ++network_counts[1];\n+        } else if (node.m_is_onion) {\n+            ++network_counts[2];\n+        }\n     }\n \n-    const size_t localhost_min_protect_size{2};\n-    if (onion_protect_size >= localhost_min_protect_size) {\n-        // Allocate any remaining slots of the 1/4, or minimum 2 additional slots,\n-        // to localhost peers, sorted by longest uptime, as manually configured\n-        // hidden services not using `-bind=addr[:port]=onion` will not be detected\n-        // as inbound onion connections.\n-        const size_t remaining_tor_slots{onion_protect_size - (initial_size - vEvictionCandidates.size())};\n-        const size_t localhost_protect_size{std::max(remaining_tor_slots, localhost_min_protect_size)};\n-        EraseLastKElements(vEvictionCandidates, CompareLocalHostTimeConnected, localhost_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_local; });\n-    }\n+    // Find the number of networks from which we have disadvantaged candidates.\n+    const auto networks = std::count_if(network_counts.begin(), network_counts.end(), [](auto n) { return n; });\n+\n+    if (networks) {\n+        // Obtain the minimum number of peers per network to potentially protect.\n+        // The base ratio is 1/2 (for the case of peers from only 1 network).\n+        const size_t protect_size_per_network{total_protect_size / (2 * networks)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625210280",
      "id" : 625210280,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTIxMDI4MA==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 931,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 650516145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625210280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625212333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625212333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "These are used as booleans. I would suggest something like:\r\n\r\n```cpp\r\nstruct {\r\n    bool local{false};\r\n    bool i2p{false};\r\n    bool onion{false};\r\n} networks;\r\n...\r\nif (node.m_is_local) {\r\n    networks.local = true;\r\n}\r\n\r\n// if (networks) becomes:\r\nif (networks.local || networks.i2p || networks.onion)\r\n```",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-03T16:37:09Z",
      "diff_hunk" : "@@ -896,36 +902,64 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& vEvict\n {\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // To favorise the diversity of our peer connections, reserve up to (half + 2) of\n-    // these protected spots for onion and localhost peers, if any, even if they're not\n-    // longest uptime overall. This helps protect tor peers, which tend to be otherwise\n-    // disadvantaged under our eviction criteria.\n+    // To favorise the diversity of our peer connections, reserve up to half of\n+    // these protected spots for onion, localhost and I2P peers, even if they're\n+    // not longest uptime overall. This helps protect these higher-latency peers\n+    // that tend to be otherwise disadvantaged under our eviction criteria.\n     const size_t initial_size = vEvictionCandidates.size();\n-    size_t total_protect_size = initial_size / 2;\n-    const size_t onion_protect_size = total_protect_size / 2;\n+    const size_t total_protect_size{initial_size / 2};\n \n-    if (onion_protect_size) {\n-        // Pick out up to 1/4 peers connected via our onion service, sorted by longest uptime.\n-        EraseLastKElements(vEvictionCandidates, CompareOnionTimeConnected, onion_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_onion; });\n+    // Count number of nodes connected via localhost, I2P, and onion.\n+    // Higher positions in the array recover unused slots left by lower ones.\n+    std::array<size_t, 3> network_counts{{}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625212333",
      "id" : 625212333,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTIxMjMzMw==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 914,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 650516145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625212333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625223765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625223765"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Passing multiple booleans like `is_onion`, `is_i2p`, etc is a bit un-flexible and leaves the possibility for contradictions like having both flags set to true. Fuzzing could do that and I expect that there may be (or may be added) some legit assert somewhere in the code to ensure that nonsensical values like `is_onion==true` and `is_i2p==true` are not passed (resulting in an assertion failure during fuzzing).\r\n\r\nWhat about passing `enum Network` instead?",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-03T16:55:49Z",
      "diff_hunk" : "@@ -1022,7 +1055,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->nKeyedNetGroup,\n                                                node->m_prefer_evict, node->addr.IsLocal(),\n-                                               node->m_inbound_onion};\n+                                               node->m_inbound_onion, node->addr.IsI2P()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r625223765",
      "id" : 625223765,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNTIyMzc2NQ==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 1058,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 650516145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/625223765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626485716"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626485716"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Those are initial (not necessarily final) percentages iff onion, i2p and localhost peers are all present in the eviction candidates. For instance, if no i2p or localhost peers are among the candidats, then the full 25% is made available to onions. And if localhost or i2p peers are present, any initially reserved slots that they don't use are made available for onions. (See the commit messages for a more detailed description). I'm not against adjusting the ratios though.",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-05T11:32:02Z",
      "diff_hunk" : "@@ -896,36 +902,64 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& vEvict\n {\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // To favorise the diversity of our peer connections, reserve up to (half + 2) of\n-    // these protected spots for onion and localhost peers, if any, even if they're not\n-    // longest uptime overall. This helps protect tor peers, which tend to be otherwise\n-    // disadvantaged under our eviction criteria.\n+    // To favorise the diversity of our peer connections, reserve up to half of\n+    // these protected spots for onion, localhost and I2P peers, even if they're\n+    // not longest uptime overall. This helps protect these higher-latency peers\n+    // that tend to be otherwise disadvantaged under our eviction criteria.\n     const size_t initial_size = vEvictionCandidates.size();\n-    size_t total_protect_size = initial_size / 2;\n-    const size_t onion_protect_size = total_protect_size / 2;\n+    const size_t total_protect_size{initial_size / 2};\n \n-    if (onion_protect_size) {\n-        // Pick out up to 1/4 peers connected via our onion service, sorted by longest uptime.\n-        EraseLastKElements(vEvictionCandidates, CompareOnionTimeConnected, onion_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_onion; });\n+    // Count number of nodes connected via localhost, I2P, and onion.\n+    // Higher positions in the array recover unused slots left by lower ones.\n+    std::array<size_t, 3> network_counts{{}};\n+    for (const NodeEvictionCandidate& node : vEvictionCandidates) {\n+        if (node.m_is_local) {\n+            ++network_counts[0];\n+        } else if (node.m_is_i2p) {\n+            ++network_counts[1];\n+        } else if (node.m_is_onion) {\n+            ++network_counts[2];\n+        }\n     }\n \n-    const size_t localhost_min_protect_size{2};\n-    if (onion_protect_size >= localhost_min_protect_size) {\n-        // Allocate any remaining slots of the 1/4, or minimum 2 additional slots,\n-        // to localhost peers, sorted by longest uptime, as manually configured\n-        // hidden services not using `-bind=addr[:port]=onion` will not be detected\n-        // as inbound onion connections.\n-        const size_t remaining_tor_slots{onion_protect_size - (initial_size - vEvictionCandidates.size())};\n-        const size_t localhost_protect_size{std::max(remaining_tor_slots, localhost_min_protect_size)};\n-        EraseLastKElements(vEvictionCandidates, CompareLocalHostTimeConnected, localhost_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_local; });\n-    }\n+    // Find the number of networks from which we have disadvantaged candidates.\n+    const auto networks = std::count_if(network_counts.begin(), network_counts.end(), [](auto n) { return n; });\n+\n+    if (networks) {\n+        // Obtain the minimum number of peers per network to potentially protect.\n+        // The base ratio is 1/2 (for the case of peers from only 1 network).\n+        const size_t protect_size_per_network{total_protect_size / (2 * networks)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626485716",
      "id" : 626485716,
      "in_reply_to_id" : 625210280,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjQ4NTcxNg==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 931,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 652197438,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626485716",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626495780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626495780"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's used to determine the number of networks from which we have disadvantaged candidates (indeed that could be done with bools also, replacing count_if with a sum of each boolean) but I anticipate possibly also using the actual counts to determine the distribution size or order of the protected slots.",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-05T11:49:35Z",
      "diff_hunk" : "@@ -896,36 +902,64 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& vEvict\n {\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // To favorise the diversity of our peer connections, reserve up to (half + 2) of\n-    // these protected spots for onion and localhost peers, if any, even if they're not\n-    // longest uptime overall. This helps protect tor peers, which tend to be otherwise\n-    // disadvantaged under our eviction criteria.\n+    // To favorise the diversity of our peer connections, reserve up to half of\n+    // these protected spots for onion, localhost and I2P peers, even if they're\n+    // not longest uptime overall. This helps protect these higher-latency peers\n+    // that tend to be otherwise disadvantaged under our eviction criteria.\n     const size_t initial_size = vEvictionCandidates.size();\n-    size_t total_protect_size = initial_size / 2;\n-    const size_t onion_protect_size = total_protect_size / 2;\n+    const size_t total_protect_size{initial_size / 2};\n \n-    if (onion_protect_size) {\n-        // Pick out up to 1/4 peers connected via our onion service, sorted by longest uptime.\n-        EraseLastKElements(vEvictionCandidates, CompareOnionTimeConnected, onion_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_onion; });\n+    // Count number of nodes connected via localhost, I2P, and onion.\n+    // Higher positions in the array recover unused slots left by lower ones.\n+    std::array<size_t, 3> network_counts{{}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626495780",
      "id" : 626495780,
      "in_reply_to_id" : 625212333,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjQ5NTc4MA==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 914,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 652210679,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626495780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626585912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626585912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> What about passing `enum Network` instead?\r\n\r\nGood idea, looks like we can do that easily and it will include future network additions:\r\n\r\n```diff\r\n-                                               node->m_inbound_onion, node->addr.IsI2P()};\r\n+                                               node->ConnectedThroughNetwork()};\r\n```\r\n",
      "commit_id" : "6d7d87f21dc7f1af61f4b54b659bc0fda4659cb7",
      "created_at" : "2021-05-05T13:52:44Z",
      "diff_hunk" : "@@ -1022,7 +1055,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->nKeyedNetGroup,\n                                                node->m_prefer_evict, node->addr.IsLocal(),\n-                                               node->m_inbound_onion};\n+                                               node->m_inbound_onion, node->addr.IsI2P()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626585912",
      "id" : 626585912,
      "in_reply_to_id" : 625223765,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjU4NTkxMg==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 1058,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 652333421,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T20:57:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626585912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626601146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626601146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Requires a lot of changes but probably still worth it. Will look at replacing `m_is_local` as well, maybe giving it a `Network` value of `NET_UNROUTABLE` for the eviction logic. ",
      "commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "created_at" : "2021-05-05T14:09:58Z",
      "diff_hunk" : "@@ -1022,7 +1055,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->nKeyedNetGroup,\n                                                node->m_prefer_evict, node->addr.IsLocal(),\n-                                               node->m_inbound_onion};\n+                                               node->m_inbound_onion, node->addr.IsI2P()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r626601146",
      "id" : 626601146,
      "in_reply_to_id" : 625223765,
      "line" : 1058,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjYwMTE0Ng==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 1058,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 116,
      "pull_request_review_id" : 652354309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T14:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626601146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r627764474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627764474"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Passing `enum Network`, instead of multiple booleans, indeed allowed rewriting this to be better abstracted and generalizable. WIP, for now the initial rewrite is in an additional commit.",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-06T21:05:47Z",
      "diff_hunk" : "@@ -1022,7 +1055,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->nKeyedNetGroup,\n                                                node->m_prefer_evict, node->addr.IsLocal(),\n-                                               node->m_inbound_onion};\n+                                               node->m_inbound_onion, node->addr.IsI2P()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r627764474",
      "id" : 627764474,
      "in_reply_to_id" : 625223765,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzc2NDQ3NA==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 1058,
      "original_position" : 116,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 653895708,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T15:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627764474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-05-10T15:04:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-836811768",
      "id" : 836811768,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNjgxMTc2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-10T15:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/836811768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Current status is almost-out-of-WIP after a rewrite and several iterations, just need to finish the latest iteration and reorganize it a bit.",
      "created_at" : "2021-05-10T15:13:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-836821732",
      "id" : 836821732,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNjgyMTczMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-10T15:13:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/836821732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Approach ACK [4890e2f](https://github.com/bitcoin/bitcoin/commit/4890e2f2fdefaa18b0e96bcaf3691fb3f0213572)\r\n> \r\n> Some squashing is warranted.\r\n\r\nThanks! Indeed. Re-arranging.",
      "created_at" : "2021-05-17T12:22:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#issuecomment-842280881",
      "id" : 842280881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0MjI4MDg4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-17T12:22:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842280881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r633484515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633484515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I played around with a more generous version that would protect more than 1/4 in the case of eviction candidates from multiple disadvantaged networks.  Didn't keep it for now, but memoizing the commit: e5c27dd.",
      "commit_id" : "4890e2f2fdefaa18b0e96bcaf3691fb3f0213572",
      "created_at" : "2021-05-17T12:26:00Z",
      "diff_hunk" : "@@ -896,36 +902,64 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& vEvict\n {\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // To favorise the diversity of our peer connections, reserve up to (half + 2) of\n-    // these protected spots for onion and localhost peers, if any, even if they're not\n-    // longest uptime overall. This helps protect tor peers, which tend to be otherwise\n-    // disadvantaged under our eviction criteria.\n+    // To favorise the diversity of our peer connections, reserve up to half of\n+    // these protected spots for onion, localhost and I2P peers, even if they're\n+    // not longest uptime overall. This helps protect these higher-latency peers\n+    // that tend to be otherwise disadvantaged under our eviction criteria.\n     const size_t initial_size = vEvictionCandidates.size();\n-    size_t total_protect_size = initial_size / 2;\n-    const size_t onion_protect_size = total_protect_size / 2;\n+    const size_t total_protect_size{initial_size / 2};\n \n-    if (onion_protect_size) {\n-        // Pick out up to 1/4 peers connected via our onion service, sorted by longest uptime.\n-        EraseLastKElements(vEvictionCandidates, CompareOnionTimeConnected, onion_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_onion; });\n+    // Count number of nodes connected via localhost, I2P, and onion.\n+    // Higher positions in the array recover unused slots left by lower ones.\n+    std::array<size_t, 3> network_counts{{}};\n+    for (const NodeEvictionCandidate& node : vEvictionCandidates) {\n+        if (node.m_is_local) {\n+            ++network_counts[0];\n+        } else if (node.m_is_i2p) {\n+            ++network_counts[1];\n+        } else if (node.m_is_onion) {\n+            ++network_counts[2];\n+        }\n     }\n \n-    const size_t localhost_min_protect_size{2};\n-    if (onion_protect_size >= localhost_min_protect_size) {\n-        // Allocate any remaining slots of the 1/4, or minimum 2 additional slots,\n-        // to localhost peers, sorted by longest uptime, as manually configured\n-        // hidden services not using `-bind=addr[:port]=onion` will not be detected\n-        // as inbound onion connections.\n-        const size_t remaining_tor_slots{onion_protect_size - (initial_size - vEvictionCandidates.size())};\n-        const size_t localhost_protect_size{std::max(remaining_tor_slots, localhost_min_protect_size)};\n-        EraseLastKElements(vEvictionCandidates, CompareLocalHostTimeConnected, localhost_protect_size,\n-                           [](const NodeEvictionCandidate& n) { return n.m_is_local; });\n-    }\n+    // Find the number of networks from which we have disadvantaged candidates.\n+    const auto networks = std::count_if(network_counts.begin(), network_counts.end(), [](auto n) { return n; });\n+\n+    if (networks) {\n+        // Obtain the minimum number of peers per network to potentially protect.\n+        // The base ratio is 1/2 (for the case of peers from only 1 network).\n+        const size_t protect_size_per_network{total_protect_size / (2 * networks)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21261#discussion_r633484515",
      "id" : 633484515,
      "in_reply_to_id" : 625210280,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzQ4NDUxNQ==",
      "original_commit_id" : "831b3294d92b23f85617e77ea3f90082de73ce3a",
      "original_line" : 931,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 660903857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T12:26:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633484515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
